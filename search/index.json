[{"content":"æ„Ÿè§‰æ—¶é—´è¿‡å¾—ç‰¹åˆ«å¿«ï¼Œè½¬çœ¼é—´2025å¹´å°±è¦ç»“æŸäº†ï¼Œå›æƒ³ä¸Šæ¬¡å†™2024å¹´ä»¿ä½›è¿˜åœ¨æ˜¨æ—¥ã€‚å›é¡¾è¿™ä¸€å¹´ï¼Œç»å†äº†è®¸å¤šäº‹æƒ…ï¼Œæ²¡æ³•ç®€å•è¯´æ˜¯å¥½æ˜¯åï¼Œæ— è®ºå¦‚ä½•ï¼Œè¿™äº›ç»å†éƒ½è®©æˆ‘æˆé•¿äº†è®¸å¤šã€‚è¿˜æ˜¯è€è§„çŸ©ä»ç”Ÿæ´»å’Œå·¥ä½œä¸¤ä¸ªæ–¹é¢æ¥æ€»ç»“å§ã€‚\nç”Ÿæ´» ä»Šå¹´å‡ºå»ç©äº†ä¸¤æ¬¡ï¼Œè€Œä¸”éƒ½æ˜¯å¿ƒå¿ƒå¿µå¿µäº†å¥½ä¹…çš„åœ°æ–¹ã€‚å¹´åˆäº†å¹¿å·+é¦™æ¸¯ã€‚ä¸»è¦æ˜¯æƒ³å»é¦™æ¸¯ï¼Œè¿™ä¸ªè®¡åˆ’åœ¨2019å¹´å°±æœ‰äº†ï¼Œä½†æ˜¯å› ä¸ºä¼—æ‰€å‘¨çŸ¥çš„åŸå› ï¼Œä¸€ç›´æ²¡å»æˆã€‚å»é¦™æ¸¯ä¸»è¦çš„ç›®çš„ä¸æ˜¯å»é¦™æ¸¯ç©ï¼Œä¸»è¦æ˜¯ä¸ºäº†å»å¼€æ¸¯å¡ã€‚å¼€æ¸¯å¡çš„ç›®çš„ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯ä¸ºäº†é€ƒç¦»å¤§Aï¼Œå½“æ´‹éŸ­èœğŸ¤£ã€‚2019å¹´å°±äº†è§£åˆ°äº†æ¸¯è‚¡æ‰“æ–°ç›¸å…³çš„ä¸œè¥¿ï¼Œå½“æ—¶å°±å¼€äº†æ¸¯è‚¡è´¦å·ï¼Œä½†æ˜¯æ²¡æœ‰å¤–é¢çš„é“¶è¡Œå¡ï¼Œæ²¡æ³•æŠŠé’±è½¬å‡ºå»ï¼Œåªèƒ½æ”¾å¼ƒäº†ã€‚2025å¹´åˆï¼Œé›ªç‹åœ¨æ¸¯è‚¡ä¸Šå¸‚ï¼Œå½±å“éå¸¸å¤§ï¼Œæˆ‘å½“æ—¶åˆæƒ³èµ·äº†æ¸¯è‚¡è¿™ä»¶äº‹ï¼Œäºæ˜¯å»é¦™æ¸¯å¼€æ¸¯å¡è¿™ä»¶äº‹åˆè¢«æä¸Šäº†æ—¥ç¨‹ã€‚\näºæ˜¯é©¬ä¸Šå°±åŠäº†æ¸¯æ¾³é€šè¡Œè¯ï¼Œç„¶åè®¢äº†æœºç¥¨é…’åº—ï¼Œå°±å‡ºå‘äº†ã€‚å¥½åœ¨ä¸€åˆ‡é¡ºåˆ©ï¼Œé¡ºåˆ©å¼€äº†æ¸¯å¡ã€‚èµ¶ä¸Šäº†æ²ªä¸Šé˜¿å§¨å’Œéœ¸ç‹èŒ¶å§¬æ‰“æ–°ï¼ŒåŸºæœ¬æŠŠè¿™æ¬¡æ—…è¡Œçš„è´¹ç”¨éƒ½èµšå›æ¥äº†ã€‚è¯´åˆ°é¦™æ¸¯ï¼Œä¹‹å‰çœ‹å¾ˆå¤šäººè¯´é¦™æ¸¯æ’å¤–ï¼Œè¯´æ™®é€šè¯ä¼šè¢«çœ‹ä¸èµ·ä»€ä¹ˆçš„ã€‚ä»æˆ‘è¿™æ¬¡çš„ç»å†æ¥çœ‹ï¼Œæ²¡æœ‰é‡åˆ°è¿™ç§æƒ…å†µï¼Œåè€Œè§‰å¾—é¦™æ¸¯äººè¿˜æ˜¯æŒºå‹å¥½çš„ï¼Œå…¨ç¨‹ç”¨æ™®é€šè¯äº¤æµä¹Ÿæ²¡æœ‰ä»»ä½•é—®é¢˜ã€‚åŒ…æ‹¬é—®è·¯ä»€ä¹ˆçš„ï¼Œé¦™æ¸¯äººéƒ½å¾ˆçƒ­å¿ƒçš„å¸®å¿™æŒ‡è·¯ã€‚\nè¿˜æœ‰å°±æ˜¯ï¼Œèµ°åœ¨é¦™æ¸¯çš„è¡—å¤´ï¼Œçœ‹åˆ°äº†å¾ˆå¤šç†Ÿæ‚‰è€Œåˆé™Œç”Ÿçš„åœºæ™¯ï¼Œç†Ÿæ‚‰æ˜¯å› ä¸ºä»¥å‰ä»ç”µå½±ä¸­çœ‹åˆ°çš„åœºæ™¯æ­¤æ—¶å°±åœ¨æˆ‘çš„çœ¼å‰ï¼Œé™Œç”Ÿæ˜¯å› ä¸ºè¿™äº›åœºæ™¯æˆ‘çš„ç¡®æ˜¯ç¬¬ä¸€æ¬¡äº²çœ¼è§åˆ°ã€‚æ„Ÿè§‰æŒºå¥‡å¦™çš„ã€‚\nç»´æ¸¯çš„é£å¹äº†ä¸‰åå¹´æ‰æ‹‚è¿‡æˆ‘çš„èº«æ—ã€‚\nå› ä¸ºæ—¶é—´æœ‰é™ï¼Œåªåœ¨é¦™æ¸¯ç©äº†ä¸€å¤©ï¼Œå½“å¤©å°±åŒ†åŒ†å›åˆ°æ·±åœ³ç„¶åèµ¶å›ä¸Šæµ·äº†ã€‚ä¸‹æ¬¡æœ‰æœºä¼šä¸€å®šè¦å¤šå¾…å‡ å¤©ï¼Œå¥½å¥½æ„Ÿå—ä¸€ä¸‹é¦™æ¸¯çš„é­…åŠ›ã€‚\nè¿™æ¬¡å»é¦™æ¸¯ï¼Œæƒ³ç€é¡ºè·¯ï¼Œæ‰€ä»¥ä¹Ÿå»äº†å¹¿å·ã€‚å…¶å®æ˜¯å…ˆå»çš„å¹¿å·ï¼Œç„¶åä»å¹¿å·å»çš„é¦™æ¸¯ã€‚ä¹‹å‰å¯¹å¹¿å·çš„å°è±¡ä¸»è¦æ˜¯ç¾é£Ÿï¼Œå»äº†ä¹‹åå‘ç°å¹¿å·å…¶å®ä¹Ÿæ˜¯ä¸€ä¸ªæŒºæœ‰æ„æ€çš„åŸå¸‚ã€‚æ—¢æœ‰ä¼ ç»Ÿçš„å²­å—æ–‡åŒ–ï¼Œåˆæœ‰ç°ä»£åŒ–çš„éƒ½å¸‚é£è²Œã€‚ç™½äº‘å±±ã€å¹¿å·å¡”ã€ä¸Šä¸‹ä¹æ­¥è¡Œè¡—è¿™äº›åœ°æ–¹éƒ½ç»™æˆ‘ç•™ä¸‹äº†æ·±åˆ»çš„å°è±¡ã€‚å°è±¡å¾ˆæ·±çš„å…¶å®æ˜¯å¹¿å·çš„åŸä¸­æ‘ï¼Œåœ¨é‚£é‡Œå¯ä»¥çœ‹åˆ°å¹¿å·æœ€çœŸå®çš„ä¸€é¢ã€‚åŸä¸­æ‘é‡Œäººä»¬çš„ç”Ÿæ´»çŠ¶æ€å’ŒåŸå¸‚çš„ç¹åå½¢æˆäº†é²œæ˜çš„å¯¹æ¯”ã€‚ä¸€é¢æ˜¯é«˜æ¥¼å¤§å¦ï¼Œä¸€é¢ä¸è§å¤©æ—¥çš„ç‹­çª„å··é“ã€‚æ„Ÿè§‰æŒºéœ‡æ’¼çš„ã€‚\nå¹¿å·åœ°æ ‡â€”â€”å¹¿å·å¡” ç™½äº‘å±±è¿œçœº å¹´åº•çš„ä¸€æ¬¡æ—…è¡Œå»äº†æµ·å—ã€‚è¿™æ¬¡æ˜¯éª‘è‡ªè¡Œè½¦ç¯æµ·å—å²›ã€‚å…¶å®æ—©åœ¨å»å¹´å¼€å§‹éª‘è½¦æ—¶ï¼Œå°±æœ‰è¿™ä¸ªæƒ³æ³•äº†ï¼Œä½†æ˜¯ä¸€ç›´æ²¡æœ‰ä»˜è¯¸è¡ŒåŠ¨ã€‚è¿™æ¬¡åšè¿™ä¸ªå†³å®šä¹Ÿæ˜¯æŒºçªç„¶çš„ã€‚å¿«åˆ°å¹´åº•äº†ï¼Œçœ‹äº†ä¸€ä¸‹è‡ªå·±è¿˜æœ‰å¥½å¤šè°ƒä¼‘å‡æ²¡æœ‰ç”¨å®Œï¼Œäºæ˜¯å°±å†³å®šåˆ©ç”¨è¿™äº›å‡æœŸå»æµ·å—éª‘è¡Œã€‚ä»å†³å®šåˆ°å‡ºå‘ï¼Œå‰åä¹Ÿå°±ä¸€å‘¨å¤šçš„æ—¶é—´ã€‚å†³å®šäº†ä¹‹åå°±æ˜¯åšéª‘è¡Œè·¯ä¹¦ï¼Œè®¢æœºç¥¨é…’åº—ï¼Œå‡†å¤‡è£…å¤‡ç­‰ç­‰ã€‚è™½ç„¶æ—¶é—´ç´§å¼ ï¼Œä½†æ˜¯ä¸€åˆ‡éƒ½å¾ˆé¡ºåˆ©ã€‚æœ€ç»ˆé¡ºåˆ©å®Œæˆäº†ç¯æµ·å—å²›çš„éª‘è¡Œã€‚è·¨å¹´ä¹Ÿæ˜¯åœ¨æµ·å—åº¦è¿‡çš„ã€‚æ‰€ä»¥è¿™ç¯‡æ–‡ç« ä¹Ÿè¢«æ‹–åˆ°äº†ç°åœ¨æ‰å†™å®Œã€‚\nåŸæœ¬æ‰“ç®—ä¸€ä¸ªäººå»éª‘è¡Œçš„ï¼Œåæ¥åœ¨å°çº¢ä¹¦ä¸Šå‘äº†ä¸ªå¸–å­ï¼Œç»“æœæœ‰å‡ ä¸ªå°ä¼™ä¼´ä¹Ÿæƒ³å»ï¼Œäºæ˜¯å°±ç»„é˜Ÿéª‘è¡Œäº†ã€‚å…¨ç¨‹å·®ä¸å¤š1000å…¬é‡Œï¼Œåˆ†7å¤©å®Œæˆã€‚ä¸€è·¯ä¸Šé£æ™¯éå¸¸ç¾ä¸½ï¼Œå°¤å…¶æ˜¯æ²¿æµ·çš„è·¯æ®µï¼Œæ™¯è‰²éå¸¸ä¼˜ç¾ï¼Œä¹‹å‰åœ¨ç»å¸¸ä¼šå› ä¸ºå·¥ä½œå‹åŠ›å¤§è€Œæ„Ÿåˆ°ç„¦è™‘å’Œå¤±çœ ï¼Œè¿™æ¬¡éª‘è¡Œè®©æˆ‘å½»åº•æ”¾æ¾äº†ä¸‹æ¥ã€‚\nå»ä¹‹å‰è¿˜åœ¨æ‹…å¿ƒè‡ªå·±æ˜¯å¦èƒ½å¤ŸåšæŒä¸‹æ¥ï¼Œæ¯•ç«Ÿ1000å…¬é‡Œä¸æ˜¯ä¸€ä¸ªå°æ•°ç›®ï¼Œè€Œä¸”åœ°åŠ¿èµ·ä¼æ¯”ä¸Šæµ·å¤§å¾ˆå¤šã€‚ä½†æ˜¯éª‘è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œå‘ç°è‡ªå·±çš„ä½“åŠ›å’Œè€åŠ›éƒ½æ¯”æƒ³è±¡ä¸­è¦å¥½å¾ˆå¤šã€‚æ¯å¤©éª‘è¡Œå¤§çº¦150å…¬é‡Œï¼Œè™½ç„¶å¾ˆç´¯ï¼Œä½†æ˜¯æ¯æ¬¡åˆ°è¾¾ç›®çš„åœ°æ—¶ï¼Œçœ‹åˆ°ç¾ä¸½çš„é£æ™¯å’Œæ„Ÿå—åˆ°æˆå°±æ„Ÿï¼Œæ‰€æœ‰çš„ç–²æƒ«éƒ½çƒŸæ¶ˆäº‘æ•£äº†ã€‚ä»ç¬¬ä¸‰å¤©å¼€å§‹å±è‚¡å¼€å§‹ç–¼äº†ï¼Œè¿˜æ˜¯è¿˜æ˜¯åšæŒä¸‹æ¥äº†ã€‚æœ€åä¸€å¤©å¿«å›åˆ°æµ·å£æ—¶ï¼Œå±…ç„¶æœ‰ç‚¹ä¸æƒ³ç»“æŸäº†ï¼Œæ„Ÿè§‰è¿˜å¯ä»¥ç»§ç»­éª‘ä¸‹å»ã€‚\nç¾¤é‡Œæœ‰å‡ ä¸ªå°ä¼™ä¼´ï¼Œåœ¨éª‘è¡Œç»“æŸæˆ–è€…è¦å¼€å§‹æµ·å—æ—¶ï¼Œéƒ½æƒ…ä¸è‡ªç¦çš„æµä¸‹äº†çœ¼æ³ªã€‚å¯èƒ½æ˜¯ç»å†äº†è¿™ä¹ˆå¤šå¤©çš„è‰°è¾›å’ŒæŒ‘æˆ˜ï¼Œç»ˆäºå®Œæˆäº†è¿™ä¸ªç›®æ ‡ï¼Œå†…å¿ƒçš„æ¿€åŠ¨å’Œæ„ŸåŠ¨è®©ä»–ä»¬å¿ä¸ä½æµä¸‹äº†çœ¼æ³ªã€‚\nå·¥ä½œ è¯´åˆ°å·¥ä½œæ–¹é¢ï¼Œå…¶å®2025å¹´å¯¹æˆ‘æ¥è¯´å…¶å®ä¸­æ¯”è¾ƒå¤±è´¥çš„ä¸€å¹´ã€‚å¹´åˆçš„æ—¶å€™ï¼Œä¿¡å¿ƒæ»¡æ»¡ï¼Œè§‰å¾—è‡ªå·±å¸¦é˜Ÿåšçš„é¡¹ç›®ä¸€å®šä¼šæˆåŠŸã€‚è‡ªå·±ä¹Ÿæ˜¯å……æ»¡å¹²åŠ²ï¼Œæƒ³ç€è¦æŠŠé¡¹ç›®åšå¥½ï¼ŒæŠŠå›¢é˜Ÿå¸¦å¥½ï¼Œä¸çŸ¥ç–²æƒ«çš„åŠ ç­ã€‚å½“å¹´ä¸­ä¸Šçº¿åï¼Œå•†ä¸šåŒ–çš„æ•ˆæœå¹¶ä¸ç†æƒ³ï¼Œæ¯”é¢„æœŸçš„å·®å¾ˆå¤šã€‚ä½†æ˜¯ä»æŠ€æœ¯è§’åº¦çœ‹ï¼Œé¡¹ç›®ä¸ç®—å¤±è´¥ï¼Œæ¯•ç«Ÿä¸Šçº¿äº†ï¼Œç³»ç»Ÿä¹Ÿç¨³å®šè¿è¡Œäº†ï¼Œæ’‘ä½äº†é¦–å‘çš„æµé‡ï¼Œæ²¡æœ‰å› ä¸ºæŠ€æœ¯é—®é¢˜ï¼Œæ‹–ç´¯æ•´ä¸ªé¡¹ç›®ã€‚åªæ˜¯å•†ä¸šåŒ–æ•ˆæœä¸ä½³ï¼Œè®©æˆ‘æ„Ÿåˆ°å¾ˆå¤±è½ã€‚\nå¿«åˆ°å¹´åº•æ—¶ï¼Œè‡ªå·±çš„ä¸€ä¸ªå¤±è¯¯ï¼Œå¯¼è‡´äº†ä¸€æ¬¡çº¿ä¸Šäº‹æ•…ã€‚å¥½åœ¨è¿˜èƒ½æŒ½æ•‘ï¼Œæ²¡æœ‰å¯¼è‡´äº‹æ€å½»åº•å¤±æ§ã€‚ä½†æ˜¯è¿™ä»¶äº‹å¯¹æˆ‘æ‰“å‡»å¾ˆå¤§ã€‚æ„Ÿè§‰è‡ªå·±èƒ½åŠ›ä¸è¶³ï¼Œæ²¡èƒ½æŠŠäº‹æƒ…åšå¥½ã€‚\nå…¶å®åœ¨10æœˆä»½ï¼Œæˆ‘å°±å·²ç»æœ‰ç‚¹æƒ³ç¦»å¼€ç°åœ¨çš„å²—ä½äº†ã€‚ä¸»è¦æ˜¯è§‰å¾—è‡ªå·±åœ¨è¿™ä¸ªå²—ä½ä¸Šå·²ç»æ²¡æœ‰å¤ªå¤šæˆé•¿ç©ºé—´äº†ï¼Œè€Œä¸”å·¥ä½œå†…å®¹ä¹Ÿæ¯”è¾ƒå•ä¸€ï¼Œæ„Ÿè§‰è‡ªå·±åœ¨åŸåœ°è¸æ­¥ã€‚è‡ªå·±ä¹Ÿå»é¢è¯•äº†ä¸€äº›å…¶ä»–çš„å²—ä½ï¼Œæƒ³çœ‹çœ‹å¤–é¢çš„æœºä¼šã€‚æœ‰ä¸€å®¶å›½å†…çŸ¥åäº’è”ç½‘å…¬å¸ï¼Œ3é¢éƒ½è¯•é€šè¿‡äº†ï¼Œæœ€åæ²¡æœ‰å‘offerï¼Œåæ¥çœ‹åˆ°è¿™å®¶å…¬å¸çš„è£å‘˜æ¶ˆæ¯ï¼Œå¤§æ¦‚ä¹Ÿèƒ½çŒœåˆ°ï¼Œå¯èƒ½æ˜¯å› ä¸ºå…¬å¸ä¸šåŠ¡è°ƒæ•´çš„åŸå› ï¼Œæ²¡æœ‰ç»™æˆ‘å‘offerã€‚æ„Ÿè§‰æŒºé—æ†¾çš„ã€‚\nå¼€æºç¤¾åŒº ä»Šå¹´å› ä¸ºå·¥ä½œçš„åŸå› ï¼Œç›¸æ¯”å»å¹´ï¼Œå‚ä¸å¼€æºç¤¾åŒºçš„æ—¶é—´å°‘äº†å¾ˆå¤šã€‚ä¸»è¦æ˜¯å› ä¸ºå·¥ä½œæ¯”è¾ƒå¿™ï¼Œæ²¡æ³•æŠ½å‡ºå¤ªå¤šæ—¶é—´æ¥å‚ä¸ç¤¾åŒºçš„æ´»åŠ¨ã€‚è™½ç„¶æ—¶é—´å°‘äº†ï¼Œä½†æ˜¯è¿˜æ˜¯æœ‰å‚ä¸ä¸€äº›é¡¹ç›®çš„ç»´æŠ¤å’Œå¼€å‘å·¥ä½œã€‚ä¹Ÿæœ‰å‚åŠ ä¸€äº›çº¿ä¸Šçš„æŠ€æœ¯åˆ†äº«ä¼šï¼Œå­¦ä¹ äº†ä¸€äº›æ–°çš„æŠ€æœ¯çŸ¥è¯†ã€‚\nå¸Œæœ›2026å¹´èƒ½æœ‰æ›´å¤šçš„æ—¶é—´å’Œç²¾åŠ›æ¥å‚ä¸å¼€æºç¤¾åŒºçš„æ´»åŠ¨ï¼Œä¸ºç¤¾åŒºçš„å‘å±•è´¡çŒ®è‡ªå·±çš„ä¸€ä»½åŠ›é‡ã€‚\nother è¿™é‡Œä¹Ÿæ˜¯æƒ³åˆ°ä»€ä¹ˆå°±å†™ä»€ä¹ˆå§ã€‚\nä»Šå¹´æœ¬æ¥æƒ³å¤šè¯»ä¸€äº›ä¹¦çš„ï¼Œç»“æœä¹Ÿæ²¡è¯»å‡ æœ¬ã€‚ä½†æ˜¯ä¹Ÿæ˜¯å› ä¸ºå„ç§åŸå› ï¼Œæ²¡èƒ½åšæŒä¸‹æ¥ã€‚æ˜å¹´ç»§ç»­åŠªåŠ›å§ã€‚ä½†æ˜¯ä»Šå¹´æˆ‘å‘ç°äº†ä¸€æœ¬æŒºå¥½çš„ä¹¦ï¼Œå«ã€Šå…«æ¬¡å±æœºã€‹ï¼Œæ¸©é“å†›è€å¸ˆæ˜¯çœŸæ•¢è¯´ã€‚2026å¹´ä¸€å®šè¦è¯»å®Œè¿™æœ¬ä¹¦ã€‚\nä»Šå¹´éª‘è½¦çš„æ¬¡æ•°ä¹Ÿæ¯”å»å¹´å°‘äº†å¾ˆå¤šï¼Œæ—¶é—´å°‘äº†æ˜¯ä¸€éƒ¨åˆ†åŸå› ï¼Œéª‘è¡Œçš„çƒ­åº¦ä¸‹é™ä¹Ÿæœ‰éƒ¨åˆ†åŸå› ï¼Œç¾¤é‡Œæ˜æ˜¾ä¸å¦‚2024å¹´æ´»è·ƒäº†ã€‚å¸Œæœ›æ˜å¹´èƒ½é‡æ–°æ‰¾å›éª‘è¡Œçš„çƒ­æƒ…å§ã€‚\nä»Šå¹´å†™æ–‡ç« çš„æ¬¡æ•°ä¹Ÿæ¯”å»å¹´å¤šäº†ä¸€äº›ï¼Œä»Šå¹´çš„å­¦ä¹ é‡ç‚¹ä¸»è¦åœ¨C++å’Œå¼‚æ­¥IOç›¸å…³çš„å†…å®¹ä¸Šã€‚å¸Œæœ›æ˜å¹´èƒ½ç»§ç»­åšæŒå†™æ–‡ç« ï¼Œåˆ†äº«è‡ªå·±çš„å­¦ä¹ å¿ƒå¾—ã€‚äº‰å–èƒ½æ—©æ—¥å®Œæˆè‡ªå·±çš„C++åç¨‹+å¼‚æ­¥IOçš„åŸºç¡€åº“ã€‚\nå¿«åˆ°å¹´åº•çš„æ—¶å€™ï¼Œå¼€å§‹å¯¹SLGæ¸¸æˆæ„Ÿå…´è¶£äº†ã€‚åˆæƒ³èµ·äº†è‡ªå·±é«˜ä¸­çš„æ—¶å€™ï¼Œè‡ªå·±æƒ³åšçš„é‚£æ¬¾æ¸¸æˆã€‚é‚£æ—¶å€™è¿˜æ˜¯MMORPGç››è¡Œçš„å¹´ä»£ï¼Œè‡ªå·±æ˜¯æŒ‰ç…§MMOæ¥è®¾æƒ³çš„æ¸¸æˆã€‚ä½†æ˜¯ç°åœ¨çœ‹æ¥ï¼ŒMMOå·²ç»ä¸å¤ªé€‚åˆç°åœ¨çš„å¸‚åœºäº†ï¼ŒSLGå¯èƒ½æ›´é€‚åˆä¸€äº›ã€‚æ„Ÿè§‰è‡ªå·±è®¾æƒ³çš„è¿™æ¬¾æ¸¸æˆï¼Œæ›´é€‚åˆSLGã€‚\næ‰€ä»¥ä»Šå¹´å°†ä¼šé¢ä¸´ä¸€ä¸ªé€‰æ‹©ï¼Œæ˜¯ç»§ç»­åšæ¸¸æˆè¿˜æ˜¯æ¢æ–¹å‘å»åšå…¶ä»–çš„ä¸œè¥¿ã€‚è¿™ä¸ªé—®é¢˜ï¼Œåœ¨3é¢çš„æ—¶å€™ï¼Œé¢è¯•å®˜ä¹Ÿé—®è¿‡æˆ‘ï¼Œä¸ºä»€ä¹ˆåšäº†è¿™ä¹ˆå¤šå¹´æ¸¸æˆï¼Œç°åœ¨è¦æ¢æ–¹å‘å»åšå…¶ä»–çš„ä¸œè¥¿ã€‚æˆ‘å½“æ—¶çš„å›ç­”æ˜¯ï¼Œè‡ªå·±å¯¹æ¸¸æˆå¼€å‘è¿˜æ˜¯å¾ˆæœ‰çƒ­æƒ…çš„ï¼Œåªæ˜¯ç°åœ¨çš„å²—ä½å·²ç»æ²¡æœ‰å¤ªå¤šæˆé•¿ç©ºé—´äº†ï¼Œæ‰€ä»¥æƒ³æ¢ä¸ªæ–¹å‘ï¼Œå»å­¦ä¹ ä¸€äº›æ–°çš„æŠ€æœ¯å’ŒçŸ¥è¯†ã€‚åé¢è¿™ä½å‰è¾ˆä¹Ÿå¯¹æˆ‘è¯´ï¼Œè¿™å¯èƒ½æ˜¯æˆ‘èŒä¸šç”Ÿæ¶¯ä¸­çš„ä¸€ä¸ªè½¬æŠ˜ç‚¹ï¼Œé€‰æ‹©å¾ˆé‡è¦ï¼Œè¿™æ¬¡æ¢æ–¹å‘å¯èƒ½ä¼šå½±å“æˆ‘æœªæ¥çš„å‘å±•ã€‚\nä»Šå¹´å¹´åˆå®¶é‡Œç»™ä»‹ç»äº†ä¸€ä¸ªå¥³å­©ï¼Œä¸€å¼€å§‹èŠå¾—è¿˜ä¸é”™ï¼Œä½†æ˜¯å› ä¸ºä¸¤äººåœ¨ä¸åŒçš„åŸå¸‚ï¼Œè§é¢çš„æœºä¼šæ¯”è¾ƒå°‘ï¼Œåæ¥æ…¢æ…¢å°±æ²¡ä»€ä¹ˆè”ç³»äº†ã€‚å›½åº†æœŸé—´åˆä»‹ç»äº†ä¸€ä¸ªï¼Œç»“æœè¿˜æ˜¯å› ä¸ºè·ç¦»é—®é¢˜ï¼Œæ²¡èƒ½ç»§ç»­å‘å±•ä¸‹å»ã€‚æ„Ÿè§‰ç°åœ¨æ‰¾å¯¹è±¡çœŸçš„æ˜¯è¶Šæ¥è¶Šéš¾äº†ã€‚å¸Œæœ›æ˜å¹´èƒ½æœ‰å¥½è¿æ°”å§ã€‚\n2026 2026å¹´çœŸçš„åº”è¯¥è¦åšå‡ºä¸€äº›é€‰æ‹©äº†ï¼Œç°åœ¨å›é¦–æ¥çœ‹ï¼Œå‰ä¸¤å¹´çš„é€‰æ‹©æ˜¯æ²¡æœ‰è¾¾åˆ°é¢„æœŸçš„ï¼Œå¸Œæœ›2026å¹´èƒ½æœ‰ä¸€ä¸ªå¥½çš„è½¬æŠ˜ç‚¹å§ã€‚\nGood luck next year\n","date":"2026-01-10T11:26:39+08:00","image":"https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/e2bf0cda73c16e51758a974234f597848dd510fe.jpg","permalink":"https://lqxhub.github.io/posts/3ccaa6e6/","title":"æˆ‘çš„2025 - QX's blog"},{"content":"å¥½ä¹…æ²¡æœ‰å†™ä¸œè¥¿äº†ï¼Œæœ€è¿‘æœ‰ç‚¹æ—¶é—´äº†ï¼Œå°±ç»§ç»­å†™å†™Redisæºç å­¦ä¹ ç³»åˆ—æ–‡ç« å§ã€‚åœ¨ä»Šå¹´5æœˆï¼Œrediså‘å¸ƒäº†8.0æ­£å¼ç‰ˆï¼Œ8.0è¿™ä¸ªç‰ˆæœ¬åšäº†å¾ˆå¤šä¼˜åŒ–ï¼Œå…¶ä¸­éå¸¸é‡è¦çš„ä¸€ä¸ªåŠŸèƒ½å°±æ˜¯ä¼˜åŒ–äº†å¤šçº¿ç¨‹æ¨¡å—ã€‚\næ—©åœ¨ 6.0 ç‰ˆæœ¬ï¼Œrediså°±æ”¯æŒäº† IO å¤šçº¿ç¨‹ï¼Œä¹‹å‰ä¹Ÿå†™è¿‡ä¸€ç¯‡æ–‡ç« ä»‹ç» redis IO å¤šçº¿ç¨‹çš„å®ç°åŸç†ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥çœ‹ä¸€ä¸‹ï¼šRedis 6.0ç½‘ç»œã€‚åœ¨ 6.0 ç‰ˆæœ¬ä¸­ã€‚å¤šçº¿ç¨‹åªç”¨æ¥å¤„ç†ç½‘ç»œ IO æ“ä½œï¼Œå…¶ä»–çš„æ“ä½œè¿˜æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­å®Œæˆçš„ã€‚åœ¨ 8.0 ç‰ˆæœ¬ä¸­ï¼Œå¤šçº¿ç¨‹ä¹Ÿæ˜¯åªç”¨æ¥å¤„ç†ç½‘ç»œ IO æ“ä½œï¼Œå…·ä½“æ‰§è¡Œå‘½ä»¤è¿˜æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­ï¼Œä½†æ˜¯åšäº†å¾ˆå¤šä¼˜åŒ–ã€‚\nå…ˆæ¥çœ‹ä¸€ä¸‹ 6.0 ç‰ˆæœ¬å¤šçº¿ç¨‹å­˜åœ¨çš„é—®é¢˜ï¼š\næ¯”è¾ƒå½±å“æ€§èƒ½çš„ä¸€ä¸ªé—®é¢˜å°±æ˜¯ï¼Œæ‰€æœ‰ IO çº¿ç¨‹åœ¨è¯»å–æ•°æ®æ—¶ï¼Œmain çº¿ç¨‹éœ€è¦ç­‰å¾…æ‰€æœ‰ IO çº¿ç¨‹è¯»å–å®Œæ•°æ®ä¹‹åï¼Œæ‰èƒ½ç»§ç»­å¤„ç†å‘½ä»¤ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœæœ‰ä¸€ä¸ª IO çº¿ç¨‹è¯»å–æ•°æ®æ¯”è¾ƒæ…¢ï¼Œé‚£ä¹ˆ main çº¿ç¨‹å°±ä¼šè¢«é˜»å¡ï¼Œç­‰å¾…è¿™ä¸ªæ…¢çš„ IO çº¿ç¨‹è¯»å–å®Œæ•°æ®ä¹‹åï¼Œæ‰èƒ½ç»§ç»­å¤„ç†å‘½ä»¤ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œmain çº¿ç¨‹åªèƒ½å¹²ç­‰å¾…ï¼Œè¿™ä¸ªæ…¢çš„ IO çº¿ç¨‹ä¼šæ‹–ç´¯æ•´ä¸ªç³»ç»Ÿçš„æ€§èƒ½ã€‚\nç†æƒ³æƒ…å†µä¸‹ï¼Œåº”è¯¥æ˜¯æ¯ä¸ªIOçº¿ç¨‹è¯»å–å®Œæ•°æ®ä¹‹åï¼Œå°±å¯ä»¥ç«‹å³é€šçŸ¥ main çº¿ç¨‹ï¼Œmain çº¿ç¨‹å¯ä»¥ç«‹å³å¤„ç†è¿™äº›å·²ç»è¯»å–å®Œæ•°æ®çš„å‘½ä»¤ï¼Œè€Œä¸éœ€è¦ç­‰å¾…å…¶ä»– IO çº¿ç¨‹è¯»å–å®Œæ•°æ®ä¹‹åï¼Œæ‰èƒ½ç»§ç»­å¤„ç†å‘½ä»¤ã€‚\nåœ¨ 8.0 ç‰ˆæœ¬ä¸­ï¼Œredisè§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼Œå®ç°äº†æ¯ä¸ª IO çº¿ç¨‹è¯»å–å®Œæ•°æ®ä¹‹åï¼Œå°±å¯ä»¥ç«‹å³é€šçŸ¥ main çº¿ç¨‹ï¼Œmain çº¿ç¨‹å¯ä»¥ç«‹å³å¤„ç†è¿™äº›å·²ç»è¯»å–å®Œæ•°æ®çš„å‘½ä»¤ï¼Œè€Œä¸éœ€è¦ç­‰å¾…å…¶ä»– IO çº¿ç¨‹è¯»å–å®Œæ•°æ®ä¹‹åï¼Œæ‰èƒ½ç»§ç»­å¤„ç†å‘½ä»¤ã€‚\nGithub PR è¿™æ˜¯ redis 8.0 ç‰ˆæœ¬å¤šçº¿ç¨‹ä¼˜åŒ–çš„ PRï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥çœ‹ä¸€ä¸‹ã€‚\nè¿™æ˜¯ä½œè€…åœ¨ PR ä¸­ç”»çš„ç¤ºæ„å›¾ã€‚\nå›é¦–çœ‹ä¹‹å‰å†™çš„é‚£ç¯‡æ–‡ç« ï¼Œå½“æ—¶å­¦ç–æ‰æµ…ï¼Œæ–‡ç« æ•´ä½“é€»è¾‘ä¸å¤Ÿæ¸…æ™°ï¼Œä¸€äº›åœ°æ–¹æ²¡æœ‰è®²æ¸…æ¥šï¼Œå¯èƒ½é˜…è¯»èµ·æ¥ä¸æ˜¯å¾ˆè¿è´¯ï¼Œä½†æ˜¯åº”è¯¥æ²¡æœ‰å¤§çš„é”™è¯¯ã€‚ç°åœ¨é‡æ–°å­¦ä¹ äº† 8.0 ç‰ˆæœ¬çš„ç½‘ç»œå®ç°ä¹‹åï¼Œé‡æ–°æ¢³ç†äº†ä¸€ä¸‹æ€è·¯ï¼Œå†™ä¸‹è¿™ç¯‡æ–‡ç« ï¼Œå¸Œæœ›èƒ½æŠŠ redis 8.0 ç‰ˆæœ¬çš„ç½‘ç»œå®ç°è®²æ¸…æ¥šã€‚\næœ¬ç¯‡æ–‡ç« ä½¿ç”¨çš„ä»£ç æ˜¯ redis 8.2.3 ä¸åŒçš„ç‰ˆæœ¬å¯èƒ½ä¼šæœ‰ä¸€äº›å·®å¼‚ã€‚\næœ¬ç¯‡æ–‡ä¸­ï¼Œä¸»è¦ä» ç½‘ç»œåˆå§‹åŒ– ï¼Œ æ–°é“¾æ¥å¤„ç† ï¼Œ IOçº¿ç¨‹é€»è¾‘ ï¼Œ ä¸»çº¿ç¨‹é€»è¾‘ ï¼Œ æ•°æ®è¯»å†™ äº”ä¸ªæ–¹é¢æ¥ä»‹ç» redis 8.0 ç‰ˆæœ¬çš„ç½‘ç»œå®ç°ã€‚\nåœ¨å¼€å§‹å‰ï¼Œéœ€è¦å…ˆäº†è§£ redis ä¸­å‡ ä¸ªé‡è¦çš„æ•°æ®ç»“æ„ï¼š\naeEventLoopï¼šäº‹ä»¶å¾ªç¯ç»“æ„ä½“ï¼Œè´Ÿè´£ç®¡ç†æ‰€æœ‰çš„ç½‘ç»œäº‹ä»¶ã€‚\n1typedef struct aeEventLoop { 2 int maxfd; /* fd çš„æœ€å¤§å€¼ */ 3 int setsize; /* è¿½è¸ªçš„æœ€å¤§fdæ•°é‡ */ 4 long long timeEventNextId; 5 int nevents; /* å½“å‰æ³¨å†Œçš„äº‹ä»¶æ•°é‡ */ 6 aeFileEvent *events; /* å·²æ³¨å†Œçš„äº‹ä»¶(å…¶å®æ˜¯æ•°ç»„) */ 7 aeFiredEvent *fired; /* è§¦å‘çš„äº‹ä»¶ */ 8 aeTimeEvent *timeEventHead; /* å®šæ—¶äº‹ä»¶é“¾è¡¨å¤´ */ 9 int stop; /* åœæ­¢æ ‡å¿— */ 10 void *apidata; /* ä¸åŒå¹³å°çš„äº‹ä»¶è½®è®­å™¨æŒ‡é’ˆ(linuxä½¿ç”¨epoll) */ 11 aeBeforeSleepProc *beforesleep; /* äº‹ä»¶å¾ªç¯ç¡çœ å‰çš„å›è°ƒå‡½æ•° */ 12 aeBeforeSleepProc *aftersleep; /* äº‹ä»¶å¾ªç¯ç¡çœ åçš„å›è°ƒå‡½æ•° */ 13 int flags; /* äº‹ä»¶å¾ªç¯æ ‡å¿— */ 14 void *privdata[2]; /* ç§æœ‰æ•°æ®æŒ‡é’ˆ */ 15} aeEventLoop; é€šè¿‡ aeCreateEventLoop å‡½æ•°åˆ›å»ºï¼š\né¦–å…ˆä¼šåœ¨ æœåŠ¡å¯åŠ¨æ—¶ï¼Œåœ¨ä¸»çº¿çº¿ç¨‹åˆ›å»ºä¸€ä¸ª aeEventLoopï¼Œæ”¾åˆ° server.el ä¸­ï¼Œå¦‚æœå¯ç”¨äº†å¤šçº¿ç¨‹ï¼Œè¿˜ä¼šä¸ºæ¯ä¸ª IO çº¿ç¨‹åˆ›å»ºä¸€ä¸ª aeEventLoopï¼Œæ”¾åˆ° server.io_threads[i]-\u0026gt;el ä¸­ã€‚\nconnectionï¼šè¿æ¥ç»“æ„ä½“ï¼Œè¡¨ç¤ºä¸€ä¸ªç½‘ç»œè¿æ¥ã€‚\n1struct connection { 2 ConnectionType *type; /* è¿æ¥ç±»å‹,æœ¬æ¬¡åªå…³æ³¨ socketç±»å‹ */ 3 ConnectionState state; /* è¿æ¥çŠ¶æ€ */ 4 int last_errno; /* æœ€è¿‘ä¸€æ¬¡é”™è¯¯ç  */ 5 int fd; /* å½“å‰è¿æ¥çš„æ–‡ä»¶æè¿°ç¬¦ (fd) */ 6 short int flags; /* è¿æ¥æ ‡å¿— */ 7 short int refs; /* è¿æ¥å¼•ç”¨è®¡æ•° */ 8 unsigned short int iovcnt; /* å½“å‰ iovec æ•°é‡ */ 9 void *private_data; /* ç§æœ‰æ•°æ®æŒ‡é’ˆ */ 10 struct aeEventLoop *el; /* å…³è”çš„äº‹ä»¶å¾ªç¯ */ 11 ConnectionCallbackFunc conn_handler; /* è¿æ¥å¤„ç†å›è°ƒå‡½æ•° */ 12 ConnectionCallbackFunc write_handler; /* å†™å¤„ç†å›è°ƒå‡½æ•° */ 13 ConnectionCallbackFunc read_handler; /* è¯»å¤„ç†å›è°ƒå‡½æ•° */ 14}; ConnectionType ç»“æ„ä½“å®šä¹‰äº†è¿æ¥çš„å„ç§æ“ä½œå‡½æ•°æŒ‡é’ˆï¼Œä¸åŒç±»å‹çš„è¿æ¥(æ¯”å¦‚ TCP è¿æ¥ã€TLS è¿æ¥ç­‰)ä¼šæœ‰ä¸åŒçš„å®ç°ã€‚æœ¬æ¬¡åªå…³æ³¨ socket ç±»å‹çš„è¿æ¥ã€‚è¿™é‡Œå› ä¸º ConnectionType ç»“æ„ä½“æ¯”è¾ƒå¤§ï¼Œå…ˆè´´å‡ºæ¥ï¼Œä¸å±•å¼€è®²è§£ï¼Œåé¢ç”¨åˆ°çš„åœ°æ–¹ä¼šæŒ‡å‡ºå’Œè§£é‡Šã€‚\n1typedef struct ConnectionType { 2 /* connection type */ 3 const char *(*get_type)(struct connection *conn); 4 5 /* connection type initialize \u0026amp; finalize \u0026amp; configure */ 6 void (*init)(void); /* auto-call during register */ 7 void (*cleanup)(void); 8 int (*configure)(void *priv, int reconfigure); 9 10 /* ae \u0026amp; accept \u0026amp; listen \u0026amp; error \u0026amp; address handler */ 11 void (*ae_handler)(struct aeEventLoop *el, int fd, void *clientData, int mask); 12 aeFileProc *accept_handler; 13 int (*addr)(connection *conn, char *ip, size_t ip_len, int *port, int remote); 14 int (*is_local)(connection *conn); 15 int (*listen)(connListener *listener); 16 17 /* create/shutdown/close connection */ 18 connection* (*conn_create)(struct aeEventLoop *el); 19 connection* (*conn_create_accepted)(struct aeEventLoop *el, int fd, void *priv); 20 void (*shutdown)(struct connection *conn); 21 void (*close)(struct connection *conn); 22 23 /* connect \u0026amp; accept */ 24 int (*connect)(struct connection *conn, const char *addr, int port, const char *source_addr, ConnectionCallbackFunc connect_handler); 25 int (*blocking_connect)(struct connection *conn, const char *addr, int port, long long timeout); 26 int (*accept)(struct connection *conn, ConnectionCallbackFunc accept_handler); 27 28 /* IO */ 29 int (*write)(struct connection *conn, const void *data, size_t data_len); 30 int (*writev)(struct connection *conn, const struct iovec *iov, int iovcnt); 31 int (*read)(struct connection *conn, void *buf, size_t buf_len); 32 int (*set_write_handler)(struct connection *conn, ConnectionCallbackFunc handler, int barrier); 33 int (*set_read_handler)(struct connection *conn, ConnectionCallbackFunc handler); 34 const char *(*get_last_error)(struct connection *conn); 35 ssize_t (*sync_write)(struct connection *conn, char *ptr, ssize_t size, long long timeout); 36 ssize_t (*sync_read)(struct connection *conn, char *ptr, ssize_t size, long long timeout); 37 ssize_t (*sync_readline)(struct connection *conn, char *ptr, ssize_t size, long long timeout); 38 39 /* event loop */ 40 void (*unbind_event_loop)(struct connection *conn); 41 int (*rebind_event_loop)(struct connection *conn, aeEventLoop *el); 42 43 /* pending data */ 44 int (*has_pending_data)(struct aeEventLoop *el); 45 int (*process_pending_data)(struct aeEventLoop *el); 46 47 /* TLS specified methods */ 48 sds (*get_peer_cert)(struct connection *conn); 49} ConnectionType; æ¯ä¸ªè¿æ¥éƒ½ä¼šå¯¹åº”ä¸€ä¸ª connection ç»“æ„ä½“ï¼Œè¡¨ç¤ºè¿™ä¸ªè¿æ¥çš„å„ç§ä¿¡æ¯ï¼Œæ¯”å¦‚æ–‡ä»¶æè¿°ç¬¦ã€è¿æ¥çŠ¶æ€ã€è¯»å†™å¤„ç†å‡½æ•°ç­‰ã€‚åœ¨ redis ä¸­ï¼Œæ‰€æœ‰çš„ç½‘ç»œè¿æ¥éƒ½æ˜¯é€šè¿‡ connection ç»“æ„ä½“æ¥ç®¡ç†çš„ã€‚\neventNotifierï¼šäº‹ä»¶é€šçŸ¥å™¨ç»“æ„ä½“ï¼Œè´Ÿè´£åœ¨ IO çº¿ç¨‹å’Œä¸»çº¿ç¨‹ä¹‹é—´ä¼ é€’äº‹ä»¶é€šçŸ¥ã€‚\n1typedef struct eventNotifier { 2#ifdef HAVE_EVENT_FD 3 int efd; 4#else 5 int pipefd[2]; 6#endif 7} eventNotifier; æ ¹æ®ä¸åŒçš„å¹³å°ï¼Œä½¿ç”¨ä¸åŒçš„æ–¹å¼å®ç°äº‹ä»¶é€šçŸ¥ã€‚åœ¨ linux å¹³å°ä¸Šï¼Œä½¿ç”¨ eventfd æ¥å®ç°äº‹ä»¶é€šçŸ¥ï¼›åœ¨å…¶ä»–å¹³å°ä¸Šï¼Œä½¿ç”¨ç®¡é“(pipe)æ¥å®ç°äº‹ä»¶é€šçŸ¥ã€‚è¿™ä¸ªç»“æ„ä½“ä¸»è¦ç”¨äº IO çº¿ç¨‹å’Œä¸»çº¿ç¨‹ä¹‹é—´çš„é€šä¿¡ã€‚\nä¸‹é¢å¼€å§‹ä¸€ç‚¹ç‚¹åˆ†ææºç ã€‚\nç½‘ç»œåˆå§‹åŒ– è¿™æ˜¯ä¸€ä¸ªå¤§æ¦‚çš„ç½‘ç»œåˆå§‹åŒ–æµç¨‹å›¾ï¼Œä¸»è¦åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š\nåˆ›å»ºä¸»äº‹ä»¶å¾ªç¯ï¼š åœ¨ main å‡½æ•°ä¸­ï¼Œè°ƒç”¨ initServer å‡½æ•°åˆå§‹åŒ– redis æœåŠ¡å™¨ï¼Œä¸»è¦æ˜¯ä¸º redisServer è¿™ä¸ªç»“æ„ä½“åˆå§‹åŒ–å„ç§å‚æ•°ã€‚å…¶ä¸­å’Œç½‘ç»œç›¸å…³çš„æ˜¯\n1server.el = aeCreateEventLoop(server.maxclients+CONFIG_FDSET_INCR); è¿™è¡Œä»£ç åˆ›å»ºäº†ä¸»äº‹ä»¶å¾ªç¯ aeEventLoopï¼Œå¹¶å°†å…¶èµ‹å€¼ç»™ server.elã€‚\nmain å‡½æ•°ç»§ç»­æ‰§è¡Œï¼Œè°ƒç”¨ initListeners å‡½æ•°åˆå§‹åŒ–ç›‘å¬å¥—æ¥å­—ï¼Œä¸»è¦æ˜¯åˆ›å»ºç›‘å¬å¥—æ¥å­—ï¼Œå¹¶å°†å…¶æ³¨å†Œåˆ°ä¸»äº‹ä»¶å¾ªç¯ä¸­ã€‚\n1void initListeners(void) { 2 int conn_index; 3 connListener *listener; 4 //å¦‚æœé…ç½®äº†ç«¯å£ï¼Œå°±åˆ›å»º socket ç›‘å¬å™¨ 5 if (server.port != 0) { 6 conn_index = connectionIndexByType(CONN_TYPE_SOCKET); 7 if (conn_index \u0026lt; 0) 8 serverPanic(\u0026#34;Failed finding connection listener of %s\u0026#34;, CONN_TYPE_SOCKET); 9 listener = \u0026amp;server.listeners[conn_index]; 10 listener-\u0026gt;bindaddr = server.bindaddr; 11 listener-\u0026gt;bindaddr_count = server.bindaddr_count; 12 listener-\u0026gt;port = server.port; 13 listener-\u0026gt;ct = connectionByType(CONN_TYPE_SOCKET); 14 } 15 16 //çœç•¥unixdomainå’Œtlsç›‘å¬å™¨çš„ç›¸å…³é€»è¾‘ 17 ...... 18 19 /* create all the configured listener, and add handler to start to accept */ 20 int listen_fds = 0; 21 for (int j = 0; j \u0026lt; CONN_TYPE_MAX; j++) { 22 listener = \u0026amp;server.listeners[j]; 23 if (listener-\u0026gt;ct == NULL) 24 continue; 25 26 // åˆ›å»ºç›‘å¬socket 27 if (connListen(listener) == C_ERR) { 28 serverLog(LL_WARNING, \u0026#34;Failed listening on port %u (%s), aborting.\u0026#34;, listener-\u0026gt;port, listener-\u0026gt;ct-\u0026gt;get_type(NULL)); 29 exit(1); 30 } 31 // ä¸ºç›‘å¬socketåˆ›å»ºacceptå¤„ç†å™¨ï¼Œå¹¶æ³¨å†Œåˆ°server.elä¸­ 32 if (createSocketAcceptHandler(listener, connAcceptHandler(listener-\u0026gt;ct)) != C_OK) 33 serverPanic(\u0026#34;Unrecoverable error creating %s listener accept handler.\u0026#34;, listener-\u0026gt;ct-\u0026gt;get_type(NULL)); 34 35 listen_fds += listener-\u0026gt;count; 36 } 37 38 if (listen_fds == 0) { 39 serverLog(LL_WARNING, \u0026#34;Configured to not listen anywhere, exiting.\u0026#34;); 40 exit(1); 41 } 42} createSocketAcceptHandler å‡½æ•°æœ€ç»ˆä¼šæŠŠ connSocketAcceptHandler æ³¨å†Œåˆ°ä¸»äº‹ä»¶å¾ªç¯ server.el ä¸­ï¼Œå½“æœ‰æ–°çš„è¿æ¥åˆ°æ¥æ—¶ï¼Œä¸»äº‹ä»¶å¾ªç¯ä¼šè°ƒç”¨è¿™ä¸ªå¤„ç†å™¨æ¥å¤„ç†æ–°è¿æ¥ã€‚\nconnListen å‡½æ•°\n1static inline int connListen(connListener *listener) { 2 return listener-\u0026gt;ct-\u0026gt;listen(listener); 3} è°ƒç”¨ ConnectionType ç»“æ„ä½“ä¸­çš„ listen å‡½æ•°æŒ‡é’ˆ(æŒ‡å‘ connSocketListen)ï¼Œåˆ›å»ºç›‘å¬ socketï¼Œå¹¶ç»‘å®šåˆ°æŒ‡å®šçš„åœ°å€å’Œç«¯å£ã€‚\ncreateSocketAcceptHandler å‡½æ•°\n1int createSocketAcceptHandler(connListener *sfd, aeFileProc *accept_handler) { 2 int j; 3 4 for (j = 0; j \u0026lt; sfd-\u0026gt;count; j++) { 5 if (aeCreateFileEvent(server.el, sfd-\u0026gt;fd[j], AE_READABLE, accept_handler,sfd) == AE_ERR) { 6 /* Rollback */ 7 for (j = j-1; j \u0026gt;= 0; j--) aeDeleteFileEvent(server.el, sfd-\u0026gt;fd[j], AE_READABLE); 8 return C_ERR; 9 } 10 } 11 return C_OK; 12} è¿™ä¸ªå‡½æ•°ä¸ºæ¯ä¸ªç›‘å¬ socket åˆ›å»ºä¸€ä¸ª accept å¤„ç†å™¨ï¼Œå¹¶å°†å…¶æ³¨å†Œåˆ°ä¸»äº‹ä»¶å¾ªç¯ server.el ä¸­ã€‚å½“æœ‰æ–°çš„è¿æ¥åˆ°æ¥æ—¶ï¼Œä¸»äº‹ä»¶å¾ªç¯ä¼šè°ƒç”¨è¿™ä¸ª accept å¤„ç†å™¨æ¥å¤„ç†æ–°è¿æ¥ã€‚\nmain å‡½æ•°ç»§ç»­æ‰§è¡Œï¼Œè°ƒç”¨ InitServerLast å‡½æ•°å®Œæˆ å¤šçº¿ç¨‹ç›¸å…³çš„åˆå§‹åŒ–\n1void InitServerLast(void) { 2 bioInit(); 3 initThreadedIO(); 4 set_jemalloc_bg_thread(server.jemalloc_bg_thread); 5 server.initial_memory_usage = zmalloc_used_memory(); 6} initThreadedIO å‡½æ•°\n1void initThreadedIO(void) { 2 //å¦‚æœæ²¡æœ‰å¯ç”¨å¤šçº¿ç¨‹ï¼Œç›´æ¥è¿”å› 3 if (server.io_threads_num \u0026lt;= 1) return; 4 5 //æŠŠIOçº¿ç¨‹æ ‡è®°ä¸ºæ¿€æ´»çŠ¶æ€ 6 server.io_threads_active = 1; 7 8 ........ 9 10 //ä¸ºæ¯ä¸ªIOçº¿ç¨‹åˆ›å»ºäº‹ä»¶å¾ªç¯å’Œç›¸å…³æ•°æ®ç»“æ„ 11 for (int i = 1; i \u0026lt; server.io_threads_num; i++) { 12 IOThread *t = \u0026amp;IOThreads[i]; 13 t-\u0026gt;id = i; 14 t-\u0026gt;el = aeCreateEventLoop(server.maxclients+CONFIG_FDSET_INCR); 15 ............. 16 //åˆ›å»ºé€šçŸ¥å™¨ï¼Œç”¨äºIOçº¿ç¨‹é€šçŸ¥ä¸»çº¿ç¨‹æœ‰æ–°æ•°æ®å¯è¯» 17 t-\u0026gt;pending_clients_notifier = createEventNotifier(); 18 //ä¸ºIOçº¿ç¨‹åˆ›å»ºå¤„ç†å‡½æ•°ï¼Œå½“ä¸»çº¿ç¨‹éœ€è¦è°ƒç”¨IOçº¿ç¨‹æ¥å¤„ç†æ—¶ï¼Œå¯ä»¥é€šè¿‡è§¦å‘è¿™ä¸ªé€šçŸ¥å™¨ï¼Œ 19 //è°ƒç”¨handleClientsFromMainThreadå‡½æ•°å¤„ç† 20 if (aeCreateFileEvent(t-\u0026gt;el, getReadEventFd(t-\u0026gt;pending_clients_notifier), 21 AE_READABLE, handleClientsFromMainThread, t) != AE_OK) 22 {.................} 23 24 ............ 25 26 //åˆ›å»ºIOçº¿ç¨‹ 27 if (pthread_create(\u0026amp;t-\u0026gt;tid, NULL, IOThreadMain, (void*)t) != 0) { 28 serverLog(LL_WARNING, \u0026#34;Fatal: Can\u0026#39;t initialize IO thread.\u0026#34;); 29 exit(1); 30 } 31 32 //ä¸ºä¸»çº¿ç¨‹åˆ›å»ºç›¸å…³æ•°æ®ç»“æ„ï¼Œç”¨äºæ¥æ”¶IOçº¿ç¨‹çš„é€šçŸ¥,åé¢ä¼šè¯¦ç»†ä»‹ç» 33 mainThreadPendingClientsToIOThreads[i] = listCreate(); 34 mainThreadPendingClients[i] = listCreate(); 35 mainThreadProcessingClients[i] = listCreate(); 36 pthread_mutex_init(\u0026amp;mainThreadPendingClientsMutexes[i], attr); 37 //åˆ›å»ºé€šçŸ¥å™¨ï¼Œç”¨äºIOçº¿ç¨‹é€šçŸ¥ä¸»çº¿ç¨‹æœ‰æ–°æ•°æ®å¯è¯» 38 mainThreadPendingClientsNotifiers[i] = createEventNotifier(); 39 //ä¸ºä¸»çº¿ç¨‹åˆ›å»ºå¤„ç†å‡½æ•°ï¼Œå½“IOçº¿ç¨‹è¯»å–å®Œæ•°æ®åï¼Œå¯ä»¥é€šè¿‡è§¦å‘è¿™ä¸ªé€šçŸ¥å™¨ï¼Œ 40 //è°ƒç”¨handleClientsFromIOThreadå‡½æ•°å¤„ç† 41 if (aeCreateFileEvent(server.el, getReadEventFd(mainThreadPendingClientsNotifiers[i]), 42 AE_READABLE, handleClientsFromIOThread, t) != AE_OK) 43 { 44 exit(1); 45 } 46 if (attr) zfree(attr); 47 } 48} åˆ°è¿™é‡Œï¼Œç½‘ç»œåˆå§‹åŒ–çš„å·¥ä½œå°±å®Œæˆäº†ï¼Œä¸»äº‹ä»¶å¾ªç¯åˆ›å»ºå¥½äº†ï¼Œç›‘å¬ socket åˆ›å»ºå¥½äº†ï¼Œå¹¶æ³¨å†Œåˆ°äº†ä¸»äº‹ä»¶å¾ªç¯ä¸­ï¼ŒIO çº¿ç¨‹ä¹Ÿåˆ›å»ºå¥½äº†ï¼Œå¹¶ä¸ºæ¯ä¸ª IO çº¿ç¨‹åˆ›å»ºäº†äº‹ä»¶å¾ªç¯å’Œç›¸å…³æ•°æ®ç»“æ„ã€‚\næ–°è¿æ¥å¤„ç† å…ˆæ¥çœ‹ä¸€ä¸‹æ–°è¿æ¥çš„å¤„ç†æµç¨‹å›¾ï¼š\nå½“æœ‰æ–°çš„è¿æ¥åˆ°æ¥æ—¶ï¼Œä¼šåœ¨ä¸»çº¿çº¿ç¨‹çš„äº‹ä»¶å¾ªç¯ä¸­è§¦å‘ç›‘å¬ socket çš„å¯è¯»äº‹ä»¶ï¼Œç„¶åå†æŠŠè¿™ä¸ªè¿æ¥åˆ†é…åˆ°æŸä¸ª IO çº¿ç¨‹ä¸­å»å¤„ç†ã€‚\næœ€ç»ˆä¼šé€šè¿‡ ConnectionType ç»“æ„ä½“ä¸­çš„ accept å‡½æ•°æŒ‡é’ˆ(æŒ‡å‘ connSocketAccept)æ¥å¤„ç†æ–°è¿æ¥ã€‚ connSocketAccept å‡½æ•°\n1static int connSocketAccept(connection *conn, ConnectionCallbackFunc accept_handler) { 2 ............... 3 if (!callHandler(conn, accept_handler)) ret = C_ERR; 4 ............... 5 return ret; 6} accept_handler æŒ‡å‘ connSocketAcceptHandler å‡½æ•°\n1static void connSocketAcceptHandler(aeEventLoop *el, int fd, void *privdata, int mask) { 2 int cport, cfd; 3 int max = server.max_new_conns_per_cycle;//æ¯æ¬¡å¾ªç¯æœ€å¤šæ¥å—çš„è¿æ¥æ•° 4 ............... 5 6 while(max--) { 7 cfd = anetTcpAccept(server.neterr, fd, cip, sizeof(cip), \u0026amp;cport); 8 ............... 9 acceptCommonHandler(connCreateAcceptedSocket(el,cfd,NULL), 0, cip); 10 } 11} åœ¨è¿™ä¸ªå‡½æ•°ä¸­ï¼Œä¼šå¾ªç¯æ¥å—æ–°çš„è¿æ¥ï¼Œå¹¶ä¸ºæ¯ä¸ªæ–°è¿æ¥åˆ›å»ºä¸€ä¸ª connection ç»“æ„ä½“ï¼Œç„¶åè°ƒç”¨ acceptCommonHandler å‡½æ•°å¤„ç†æ–°è¿æ¥ã€‚\nacceptCommonHandler å‡½æ•° å°±ä¸å±•å¼€åˆ†æäº†ï¼Œä¸»è¦æ˜¯å¯¹æ–°è¿æ¥è¿›è¡Œä¸€äº›åˆå§‹åŒ–æ“ä½œï¼Œæœ€ç»ˆæ˜¯é€šè¿‡ accept æˆ–è€… accept4 å‡½æ•°åˆ›å»ºæ–°çš„ socket è¿æ¥ã€‚\nacceptCommonHandler å‡½æ•°ä¼šå®Œæˆ connection ç»“æ„ä½“çš„åˆå§‹åŒ–å·¥ä½œï¼ŒåŒ…æ‹¬ä¸ºè¿™ä¸ªè¿æ¥åˆ›å»ºä¸€ä¸ª client ç»“æ„ä½“ï¼Œå¹¶å°†è¿™ä¸ªè¿æ¥åˆ†é…åˆ°æŸä¸ª IO çº¿ç¨‹ä¸­å»å¤„ç†ã€‚\n1void acceptCommonHandler(connection *conn, int flags, char *ip) { 2 //æ£€æŸ¥æœ€å¤§è¿æ¥æ•° 3 if (listLength(server.clients) + getClusterConnectionsCount() 4 \u0026gt;= server.maxclients) 5 { 6 char *err; 7 if (server.cluster_enabled) 8 err = \u0026#34;-ERR max number of clients + cluster \u0026#34; 9 \u0026#34;connections reached\\r\\n\u0026#34;; 10 else 11 err = \u0026#34;-ERR max number of clients reached\\r\\n\u0026#34;; 12 // è¿”å›å®¢æˆ·ç«¯é”™è¯¯ä¿¡æ¯ 13 if (connWrite(conn,err,strlen(err)) == -1) { 14 /* Nothing to do, Just to avoid the warning... */ 15 } 16 server.stat_rejected_conn++; 17 connClose(conn);//å…³é—­è¿æ¥ 18 return; 19 } 20 21 //ä¸ºè¿æ¥åˆ›å»º client ç»“æ„ä½“ 22 if ((c = createClient(conn)) == NULL) { 23 ......... 24 return; 25 } 26 27 //æœ€ç»ˆä¼šè°ƒç”¨ clientAcceptHandler å‡½æ•°å¤„ç†æ–°è¿æ¥ 28 if (connAccept(conn, clientAcceptHandler) == C_ERR) { 29 if (connGetState(conn) == CONN_STATE_ERROR) 30 serverLog(LL_WARNING, 31 \u0026#34;Error accepting a client connection: %s (addr=%s laddr=%s)\u0026#34;, 32 connGetLastError(conn), getClientPeerId(c), getClientSockname(c)); 33 freeClient(connGetPrivateData(conn)); 34 return; 35 } 36} createClient å‡½æ•°ä¸ºè¿™ä¸ªè¿æ¥åˆ›å»ºä¸€ä¸ª client ç»“æ„ä½“ï¼Œå¹¶å°†å…¶åˆå§‹åŒ–ã€‚æ¯”è¾ƒé‡è¦çš„ä¸€ç‚¹æ˜¯æŠŠ readQueryFromClient å‡½æ•°è®¾ç½®ä¸ºè¿™ä¸ªè¿æ¥çš„è¯»å¤„ç†å‡½æ•°ã€‚åç»­å½“è¿™ä¸ªè¿æ¥æœ‰æ•°æ®å¯è¯»æ—¶ï¼Œå°±ä¼šè°ƒç”¨è¿™ä¸ªå‡½æ•°æ¥è¯»å–æ•°æ®ã€‚\nconnAccpet å‡½æ•° ä¼šä½¿ç”¨ conn-\u0026gt;type-\u0026gt;accept å‡½æ•°æŒ‡é’ˆ(æŒ‡å‘ connSocketAccept)æ¥å¤„ç†æ–°è¿æ¥ï¼Œæœ€ç»ˆä¼šè°ƒç”¨åˆ° clientAcceptHandler å‡½æ•°ã€‚\nclientAcceptHandler ä¼šåšä¸€äº›æ£€æŸ¥ï¼Œæœ€ç»ˆè°ƒç”¨ assignClientToIOThread å‡½æ•°æŠŠè¿™ä¸ªè¿æ¥åˆ†é…åˆ°æŸä¸ª IO çº¿ç¨‹ä¸­å»å¤„ç†ã€‚\n1void assignClientToIOThread(client *c) { 2 serverAssert(c-\u0026gt;tid == IOTHREAD_MAIN_THREAD_ID); 3 // æ‰¾åˆ°å½“å‰è¿æ¥æ•°æœ€å°‘çš„ IO çº¿ç¨‹ 4 int min_id = 0; 5 int min = INT_MAX; 6 for (int i = 1; i \u0026lt; server.io_threads_num; i++) { 7 if (server.io_threads_clients_num[i] \u0026lt; min) { 8 min = server.io_threads_clients_num[i]; 9 min_id = i; 10 } 11 } 12 13 // æŠŠè¿æ¥åˆ†é…åˆ°è¿™ä¸ª IO çº¿ç¨‹ä¸­å» 14 server.io_threads_clients_num[c-\u0026gt;tid]--; 15 c-\u0026gt;tid = min_id;//æŠŠclientä¸­tid,ä¹Ÿå°±æ˜¯æ‰€å±IOçº¿ç¨‹idè®¾ç½®ä¸ºå½“å‰IOçº¿ç¨‹id 16 c-\u0026gt;running_tid = min_id;//æŠŠclientä¸­running_tidä¹Ÿè®¾ç½®ä¸ºå½“å‰IOçº¿ç¨‹id 17 server.io_threads_clients_num[min_id]++; 18 .......... 19 //socketç±»å‹çš„è¿æ¥ä¸­,è¿™é‡Œä¸ä¼šè°ƒç”¨unbind_event_loopå‡½æ•° 20 connUnbindEventLoop(c-\u0026gt;conn); 21 c-\u0026gt;io_flags \u0026amp;= ~(CLIENT_IO_READ_ENABLED | CLIENT_IO_WRITE_ENABLED); 22 listAddNodeTail(mainThreadPendingClientsToIOThreads[c-\u0026gt;tid], c); 23} åˆ°è¿™é‡Œï¼Œæ–°è¿æ¥å¤„ç†çš„å·¥ä½œå°±å®Œæˆäº†ï¼Œè¿æ¥å·²ç»åˆ†é…åˆ°æŸä¸ª IO çº¿ç¨‹ä¸­å»å¤„ç†äº†ï¼Œæ¥ä¸‹æ¥å°±çœ‹ IO çº¿ç¨‹æ˜¯å¦‚ä½•å¤„ç†è¿™äº›è¿æ¥çš„ã€‚\nIOçº¿ç¨‹é€»è¾‘ åœ¨è®² IO çº¿ç¨‹é€»è¾‘å‰ï¼Œéœ€è¦å…ˆäº†è§£å‡ ä¸ªé‡è¦çš„æ•°æ®ç»“æ„ï¼š\né¦–å…ˆæ˜¯ IOThread ç»“æ„ä½“ï¼Œè¡¨ç¤ºä¸€ä¸ª IO çº¿ç¨‹ã€‚\n1typedef struct __attribute__((aligned(CACHE_LINE_SIZE))) { 2 uint8_t id; // å½“å‰ IO çº¿ç¨‹çš„ ID 3 pthread_t tid; // æ“ä½œç³»ç»Ÿçº¿ç¨‹ ID 4 redisAtomic int paused; // å½“å‰ IO çº¿ç¨‹æ˜¯å¦æš‚åœ 5 redisAtomic int running; // å½“å‰ IO çº¿ç¨‹æ˜¯å¦åœ¨è¿è¡Œ 6 aeEventLoop *el; // å½“å‰çº¿ç¨‹çš„äº‹ä»¶å¾ªç¯,åœ¨ initThreadedIO ä¸­åˆ›å»ºï¼Œåº•å±‚ä½¿ç”¨ epoll å®ç° 7 list *pending_clients; // ç­‰å¾…å¤„ç†çš„å®¢æˆ·ç«¯list 8 list *processing_clients; // æ­£åœ¨å¤„ç†çš„å®¢æˆ·ç«¯list 9 eventNotifier *pending_clients_notifier; // é€šçŸ¥å™¨ï¼Œç”¨äºé€šçŸ¥ä¸»çº¿ç¨‹æœ‰äº‹ä»¶éœ€è¦å¤„ç† 10 pthread_mutex_t pending_clients_mutex; // äº’æ–¥é”ï¼Œä¿æŠ¤ pending_clients åˆ—è¡¨ 11 list *pending_clients_to_main_thread; // ä¸»çº¿ç¨‹åˆ†é…ç»™ IO çº¿ç¨‹çš„å®¢æˆ·ç«¯list 12 list *clients; // å½“å‰ IO çº¿ç¨‹ç®¡ç†çš„å®¢æˆ·ç«¯list 13} IOThread; è¿™ä¸ªç»“æ„ä½“åœ¨ initThreadedIO å‡½æ•°ä¸­åˆ›å»ºï¼Œä¸ºæ¯ä¸ª IO çº¿ç¨‹åˆ›å»ºä¸€ä¸ª IOThread ç»“æ„ä½“ï¼Œå¹¶åˆå§‹åŒ–ç›¸å…³æ•°æ®ç»“æ„ã€‚el æ˜¯ IO çº¿ç¨‹çš„äº‹ä»¶å¾ªç¯ï¼Œå’Œ server.el ä½œç”¨ç±»ä¼¼ï¼Œåªä¸è¿‡æ˜¯æ¯ä¸ª IO çº¿ç¨‹è‡ªå·±çš„äº‹ä»¶å¾ªç¯ï¼Œåœ¨linuxå¹³å°ä¸Šï¼Œåº•å±‚ä½¿ç”¨ epoll å®ç°ã€‚\nä¸‹é¢æ˜¯ä¸€äº›å…¨å±€å˜é‡ï¼Œä¸»è¦ç”¨äºä¸»çº¿ç¨‹å’Œ IO çº¿ç¨‹ä¹‹é—´çš„é€šä¿¡ã€‚\n1// IO çº¿ç¨‹æ•°ç»„ 2static IOThread IOThreads[IO_THREADS_MAX_NUM]; 3 4// ä¸»çº¿ç¨‹å’Œ IO çº¿ç¨‹ä¹‹é—´çš„é€šä¿¡æ•°æ®ç»“æ„ 5 6// listé“¾è¡¨çš„æ•°ç»„ï¼Œä¸»çº¿ç¨‹å¤„ç†å®Œæˆåè¦äº¤å›ç»™ç›¸åº” IO çº¿ç¨‹ç»§ç»­å¤„ç†çš„å®¢æˆ·ç«¯æ”¾åˆ°è¿™é‡Œ 7static list *mainThreadPendingClientsToIOThreads[IO_THREADS_MAX_NUM]; 8 9// ä¸»çº¿ç¨‹ä» mainThreadPendingClients æŠŠå¾…å¤„ç†çš„å®¢æˆ·ç«¯æ¬åˆ°è¿™ä¸ªåˆ—è¡¨ï¼Œ 10// è¡¨ç¤ºå½“å‰æ­£åœ¨ä¸»çº¿ç¨‹ä¸Šä¸‹æ–‡ä¸­é€ä¸€å¤„ç†çš„å®¢æˆ·ç«¯ï¼ˆé¿å…åœ¨å¤„ç†è¿‡ç¨‹ä¸­è¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹ï¼‰ 11static list *mainThreadProcessingClients[IO_THREADS_MAX_NUM]; 12 13// ä¸»çº¿ç¨‹ä» IO çº¿ç¨‹æ¥æ”¶å¾…å¤„ç†çš„å®¢æˆ·ç«¯æ”¾åˆ°è¿™é‡Œï¼Œå½“éœ€è¦é€šçŸ¥ä¸»çº¿ç¨‹æœ‰æ¥è‡ªæŸä¸ª IO çº¿ç¨‹çš„æ–°å®¢æˆ·ç«¯å¯å¤„ç†æ—¶ï¼Œ 14// IO çº¿ç¨‹ä½¿ç”¨å¯¹åº”çš„ notifier å”¤é†’ä¸»çº¿ç¨‹ï¼› 15static list *mainThreadPendingClients[IO_THREADS_MAX_NUM]; 16 17// ä¿æŠ¤ mainThreadPendingClients åˆ—è¡¨çš„äº’æ–¥é”æ•°ç»„ 18static pthread_mutex_t mainThreadPendingClientsMutexes[IO_THREADS_MAX_NUM]; 19 20// ç”¨äºé€šçŸ¥ä¸»çº¿ç¨‹æœ‰æ–°å®¢æˆ·ç«¯å¯å¤„ç†çš„é€šçŸ¥å™¨æ•°ç»„ 21static eventNotifier* mainThreadPendingClientsNotifiers[IO_THREADS_MAX_NUM]; çœ‹ä¸€ä¸‹å¤§æ¦‚çš„ IO çº¿ç¨‹é€»è¾‘æµç¨‹å›¾ï¼š\nè¿™é‡Œçš„ el å°±æ˜¯ IO çº¿ç¨‹è‡ªå·±çš„äº‹ä»¶å¾ªç¯ï¼Œåœ¨ initThreadedIO å‡½æ•°ä¸­åˆ›å»ºå¥½äº†ã€‚pending_clients åˆ—è¡¨ç”¨äºå­˜æ”¾ä¸»çº¿ç¨‹åˆ†é…ç»™ IO çº¿ç¨‹çš„å¾…å¤„ç†å®¢æˆ·ç«¯ï¼Œprocessing_clients åˆ—è¡¨ç”¨äºå­˜æ”¾å½“å‰æ­£åœ¨å¤„ç†çš„å®¢æˆ·ç«¯ï¼Œclients åˆ—è¡¨ç”¨äºå­˜æ”¾å½“å‰ IO çº¿ç¨‹ç®¡ç†çš„æ‰€æœ‰å®¢æˆ·ç«¯ã€‚\nåœ¨ initThreadedIO å‡½æ•°ä¸­ï¼Œè¿™äº›æ•°æ®ç»“æ„ä¹Ÿéƒ½åˆ›å»ºå¥½äº†ã€‚åŒæ—¶ä¹Ÿä¸ºæ¯ä¸ª IO çº¿ç¨‹åˆ›å»º elï¼Œå½“ el ä¸­æœ‰äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œä¼šè°ƒç”¨ handleClientsFromMainThread å‡½æ•°æ¥å¤„ç†ã€‚\næœ€ç»ˆä¼šè°ƒç”¨åˆ° processClientsFromMainThread å‡½æ•°æ¥å¤„ç†\n1int processClientsFromMainThread(IOThread *t) { 2 pthread_mutex_lock(\u0026amp;t-\u0026gt;pending_clients_mutex); 3 // æŠŠä¸»çº¿ç¨‹åˆ†é…ç»™ IO çº¿ç¨‹çš„å¾…å¤„ç†å®¢æˆ·ç«¯æ¬åˆ° IO çº¿ç¨‹è‡ªå·±çš„å¾…å¤„ç†åˆ—è¡¨ä¸­ 4 listJoin(t-\u0026gt;processing_clients, t-\u0026gt;pending_clients); 5 pthread_mutex_unlock(\u0026amp;t-\u0026gt;pending_clients_mutex); 6 size_t processed = listLength(t-\u0026gt;processing_clients); 7 if (processed == 0) return 0; 8 9 listIter li; 10 listNode *ln; 11 listRewind(t-\u0026gt;processing_clients, \u0026amp;li); 12 // éå†æ‰€æœ‰å¾…å¤„ç†å®¢æˆ·ç«¯ 13 while((ln = listNext(\u0026amp;li))) { 14 client *c = listNodeValue(ln); 15 .............. 16 listUnlinkNode(t-\u0026gt;processing_clients, ln); 17 listLinkNodeTail(t-\u0026gt;clients, ln); 18 c-\u0026gt;io_thread_client_list_node = listLast(t-\u0026gt;clients); 19 // å¦‚æœè¿æ¥æ²¡æœ‰ç»‘å®šäº‹ä»¶å¾ªç¯(ç¬¬ä¸€æ¬¡)ï¼Œå°±ç»‘å®šåˆ°å½“å‰ IO çº¿ç¨‹çš„äº‹ä»¶å¾ªç¯ä¸­, 20 // å¹¶è®¾ç½®è¯»å¤„ç†å‡½æ•°ä¸º readQueryFromClient 21 if (!connHasEventLoop(c-\u0026gt;conn)) { 22 connRebindEventLoop(c-\u0026gt;conn, t-\u0026gt;el); 23 serverAssert(!connHasReadHandler(c-\u0026gt;conn)); 24 connSetReadHandler(c-\u0026gt;conn, readQueryFromClient); 25 } 26 27 // å¦‚æœè¿æ¥æœ‰æœªå¤„ç†çš„å›å¤æ•°æ®ï¼Œå°±å…ˆå†™æ•°æ®ç»™å®¢æˆ·ç«¯ 28 if (clientHasPendingReplies(c)) { 29 writeToClient(c, 0); 30 if (!(c-\u0026gt;io_flags \u0026amp; CLIENT_IO_CLOSE_ASAP) \u0026amp;\u0026amp; clientHasPendingReplies(c)) { 31 connSetWriteHandler(c-\u0026gt;conn, sendReplyToClient); 32 } 33 } 34 } 35 serverAssert(listLength(t-\u0026gt;processing_clients) == 0); 36 return processed; 37} åœ¨è¿™ä¸ªå‡½æ•°ä¸­ï¼ŒIO çº¿ç¨‹ä¼šå¤„ç†ä¸»çº¿ç¨‹åˆ†é…ç»™å®ƒçš„å¾…å¤„ç†å®¢æˆ·ç«¯ã€‚ä¸»è¦åšäº†ä»¥ä¸‹å‡ ä»¶äº‹ï¼š\næŠŠä¸»çº¿ç¨‹åˆ†é…ç»™ IO çº¿ç¨‹çš„å¾…å¤„ç†å®¢æˆ·ç«¯æ¬åˆ° IO çº¿ç¨‹è‡ªå·±çš„å¾…å¤„ç†åˆ—è¡¨ä¸­ã€‚ éå†æ‰€æœ‰å¾…å¤„ç†å®¢æˆ·ç«¯ï¼Œå¦‚æœè¿æ¥æ²¡æœ‰ç»‘å®šäº‹ä»¶å¾ªç¯(ç¬¬ä¸€æ¬¡)ï¼Œå°±ç»‘å®šåˆ°å½“å‰ IO çº¿ç¨‹çš„äº‹ä»¶å¾ªç¯ä¸­ï¼Œå¹¶è®¾ç½®è¯»å¤„ç†å‡½æ•°ä¸º readQueryFromClientã€‚ å¦‚æœè¿æ¥æœ‰æœªå¤„ç†çš„å›å¤æ•°æ®ï¼Œå°±å…ˆå†™æ•°æ®ç»™å®¢æˆ·ç«¯ã€‚ æœ€åæŠŠå®¢æˆ·ç«¯ä»å¾…å¤„ç†åˆ—è¡¨ä¸­ç§»é™¤ï¼ŒåŠ å…¥åˆ° IO çº¿ç¨‹ç®¡ç†çš„å®¢æˆ·ç«¯åˆ—è¡¨ä¸­ã€‚ IOThreadBeforeSleep å‡½æ•° åœ¨ IO çº¿ç¨‹äº‹ä»¶å¾ªç¯ç¡çœ å‰è°ƒç”¨ï¼Œä¸»è¦æ˜¯å¤„ç†ä¸€äº›å¾…å¤„ç†çš„å®¢æˆ·ç«¯ã€‚\n1void IOThreadBeforeSleep(struct aeEventLoop *el) { 2 IOThread *t = el-\u0026gt;privdata[0]; 3 //socketç±»å‹çš„è¿æ¥ä¸­,è¿™é‡Œä¸ä¼šè°ƒç”¨processPendingDataå‡½æ•° 4 connTypeProcessPendingData(el); 5 6 // æ£€æŸ¥å½“å‰æ˜¯å¦æœ‰å¾…å¤„ç†çš„æ•°æ®,å¦‚æœæœ‰ï¼Œå°±ä¸è®©äº‹ä»¶å¾ªç¯ç¡çœ  7 int dont_sleep = connTypeHasPendingData(el); 8 9 // è°ƒç”¨ processClientsFromMainThread å¤„ç†ä¸»çº¿ç¨‹åˆ†é…ç»™ IO çº¿ç¨‹çš„å¾…å¤„ç†å®¢æˆ·ç«¯ 10 if (processClientsFromMainThread(t) \u0026gt; 0) { 11 dont_sleep = 1; 12 } 13 if (!dont_sleep) { 14 atomicSetWithSync(t-\u0026gt;running, 0);//æ ‡è®°å½“å‰ IO çº¿ç¨‹ä¸åœ¨è¿è¡ŒçŠ¶æ€ 15 // å†æ¬¡è°ƒç”¨ processClientsFromMainThread å¤„ç†ä¸»çº¿ç¨‹åˆ†é…ç»™ IO çº¿ç¨‹çš„å¾…å¤„ç†å®¢æˆ·ç«¯ 16 processClientsFromMainThread(t); 17 } 18 aeSetDontWait(t-\u0026gt;el, dont_sleep); 19 20 /* Check if i am being paused, pause myself and resume. */ 21 handlePauseAndResume(t); 22 // åœ¨sleepä¹‹å‰ï¼Œé€šçŸ¥ä¸»çº¿ç¨‹å¤„ç†ä» IO çº¿ç¨‹è¯»å–å®Œæ•°æ®çš„å®¢æˆ·ç«¯ 23 sendPendingClientsToMainThreadIfNeeded(t, 0); 24} åœ¨è¿™ä¸ªå‡½æ•°ä¸­ï¼ŒIO çº¿ç¨‹ä¼šå¤„ç†ä¸€äº›å¾…å¤„ç†çš„å®¢æˆ·ç«¯ï¼Œä¸»è¦åšäº†ä»¥ä¸‹å‡ ä»¶äº‹ï¼š\næ£€æŸ¥å½“å‰æ˜¯å¦æœ‰å¾…å¤„ç†çš„æ•°æ®,å¦‚æœæœ‰ï¼Œå°±ä¸è®©äº‹ä»¶å¾ªç¯ç¡çœ ã€‚ è°ƒç”¨ processClientsFromMainThread å¤„ç†ä¸»çº¿ç¨‹åˆ†é…ç»™ IO çº¿ç¨‹çš„å¾…å¤„ç†å®¢æˆ·ç«¯ã€‚ å¦‚æœæ²¡æœ‰å¾…å¤„ç†çš„æ•°æ®ï¼Œå°±æ ‡è®°å½“å‰ IO çº¿ç¨‹ä¸åœ¨è¿è¡ŒçŠ¶æ€ã€‚ å†æ¬¡è°ƒç”¨ processClientsFromMainThread å¤„ç†ä¸»çº¿ç¨‹åˆ†é…ç»™ IO çº¿ç¨‹çš„å¾…å¤„ç†å®¢æˆ·ç«¯ã€‚ åœ¨ sleep ä¹‹å‰ï¼Œé€šçŸ¥ä¸»çº¿ç¨‹å¤„ç†ä» IO çº¿ç¨‹è¯»å–å®Œæ•°æ®çš„å®¢æˆ·ç«¯ã€‚ IOThreadAfterSleep å‡½æ•° åœ¨ IO çº¿ç¨‹äº‹ä»¶å¾ªç¯ç¡çœ åè°ƒç”¨ï¼Œä¸»è¦æ˜¯æ ‡è®°å½“å‰ IO çº¿ç¨‹åœ¨è¿è¡ŒçŠ¶æ€ã€‚\n1void IOThreadAfterSleep(struct aeEventLoop *el) { 2 IOThread *t = el-\u0026gt;privdata[0]; 3 atomicSetWithSync(t-\u0026gt;running, 1);//æ ‡è®°å½“å‰ IO çº¿ç¨‹åœ¨è¿è¡ŒçŠ¶æ€ 4} æ•´ä¸ª IO çº¿ç¨‹é€»è¾‘ä¸»è¦å°±æ˜¯é€šè¿‡äº‹ä»¶å¾ªç¯æ¥å¤„ç†ä¸»çº¿ç¨‹åˆ†é…ç»™å®ƒçš„å¾…å¤„ç†å®¢æˆ·ç«¯ï¼Œå¹¶åœ¨ sleep å‰é€šçŸ¥ä¸»çº¿ç¨‹å¤„ç†ä» IO çº¿ç¨‹è¯»å–å®Œæ•°æ®çš„å®¢æˆ·ç«¯ã€‚\nä¸»çº¿ç¨‹é€»è¾‘ å…ˆæ¥çœ‹ä¸€ä¸‹ä¸»çº¿ç¨‹é€»è¾‘çš„å¤§æ¦‚æµç¨‹å›¾ï¼š\nç›¸æ¯”ä¹‹ä¸‹ï¼Œä¸»çº¿ç¨‹åšçš„å·¥ä½œæ›´å¤šä¸€äº›ï¼Œè¿™é‡Œåªä»‹ç»å‘½ä»¤å¤„ç†çš„ç›¸å…³é€»è¾‘ï¼Œå…¶ä»–çš„é€»è¾‘å°±ä¸å±•å¼€åˆ†æäº†ã€‚\nä¸»çº¿ç¨‹çš„äº‹ä»¶å¾ªç¯æ˜¯ server.elï¼Œåœ¨ initServer å‡½æ•°ä¸­åˆ›å»ºå¥½äº†ã€‚å½“ server.el ä¸­æœ‰äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œä¼šè°ƒç”¨ handleClientsFromIOThread å‡½æ•°æ¥å¤„ç†ï¼Œç„¶åè°ƒç”¨ processClientsFromIOThread å‡½æ•°æ¥å¤„ç†ä» IO çº¿ç¨‹è¯»å–å®Œæ•°æ®çš„å®¢æˆ·ç«¯ã€‚\n1int processClientsFromIOThread(IOThread *t) { 2 /* Get the list of clients to process. */ 3 pthread_mutex_lock(\u0026amp;mainThreadPendingClientsMutexes[t-\u0026gt;id]); 4 // æŠŠä» IO çº¿ç¨‹è¯»å–å®Œæ•°æ®çš„å®¢æˆ·ç«¯æ¬åˆ°ä¸»çº¿ç¨‹è‡ªå·±çš„å¾…å¤„ç†åˆ—è¡¨ä¸­ 5 listJoin(mainThreadProcessingClients[t-\u0026gt;id], mainThreadPendingClients[t-\u0026gt;id]); 6 pthread_mutex_unlock(\u0026amp;mainThreadPendingClientsMutexes[t-\u0026gt;id]); 7 size_t processed = listLength(mainThreadProcessingClients[t-\u0026gt;id]); 8 if (processed == 0) return 0; 9 10 int prefetch_clients = 0; 11 resetCommandsBatch(); 12 13 listNode *node = NULL; 14 while (listLength(mainThreadProcessingClients[t-\u0026gt;id])) { 15 // å¦‚æœæ²¡æœ‰é¢„å–çš„å®¢æˆ·ç«¯ï¼Œå°±é¢„å–ä¸€æ‰¹å®¢æˆ·ç«¯ 16 if (prefetch_clients \u0026lt;= 0) prefetch_clients = prefetchIOThreadCommands(t); 17 // æ¯å¤„ç†å®Œä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œå°±å‡å°‘é¢„å–çš„å®¢æˆ·ç«¯æ•°é‡ 18 if (--prefetch_clients \u0026lt;= 0) resetCommandsBatch(); 19 20 // å–å‡ºä¸€ä¸ªå®¢æˆ·ç«¯è¿›è¡Œå¤„ç† 21 if (node) zfree(node); 22 node = listFirst(mainThreadProcessingClients[t-\u0026gt;id]); 23 listUnlinkNode(mainThreadProcessingClients[t-\u0026gt;id], node); 24 client *c = listNodeValue(node); 25 ................ 26 // æŠŠclientçš„running_tidè®¾ç½®ä¸ºä¸»çº¿ç¨‹id 27 c-\u0026gt;running_tid = IOTHREAD_MAIN_THREAD_ID; 28 if (c-\u0026gt;read_error) handleClientReadError(c); 29 30 // å¦‚æœå®¢æˆ·ç«¯è¢«æ ‡è®°ä¸ºå…³é—­ï¼Œå°±é‡Šæ”¾å®¢æˆ·ç«¯ 31 if (c-\u0026gt;io_flags \u0026amp; CLIENT_IO_CLOSE_ASAP) { 32 freeClient(c); 33 continue; 34 } 35 36 // å¤„ç†å®šæ—¶ä»»åŠ¡ 37 if (c-\u0026gt;last_cron_check_time + 1000 \u0026lt;= server.mstime || 38 c-\u0026gt;io_flags \u0026amp; CLIENT_IO_PENDING_CRON) 39 { 40 c-\u0026gt;last_cron_check_time = server.mstime; 41 if (clientsCronRunClient(c)) continue; 42 } else { 43 // æ›´æ–°å®¢æˆ·ç«¯å†…å­˜ä½¿ç”¨æƒ…å†µ 44 updateClientMemUsageAndBucket(c); 45 } 46 47 if (!c-\u0026gt;read_error \u0026amp;\u0026amp; c-\u0026gt;io_flags \u0026amp; CLIENT_IO_PENDING_COMMAND) { 48 c-\u0026gt;flags |= CLIENT_PENDING_COMMAND; 49 // å¤„ç†æŒ‚èµ·çš„å‘½ä»¤å’Œè¯»å–ç¼“å†²åŒº 50 if (processPendingCommandAndInputBuffer(c) == C_ERR) { 51 // å¦‚æœå¤„ç†å‘½ä»¤å¤±è´¥,è·³è¿‡è¯¥å®¢æˆ·ç«¯ 52 continue; 53 } 54 } 55 // å¦‚æœå®¢æˆ·ç«¯æœ‰æœªå¤„ç†çš„å›å¤æ•°æ®ï¼Œå°±æŠŠå®¢æˆ·ç«¯æ”¾åˆ°å¾…å†™é˜Ÿåˆ—ä¸­ 56 if (!(c-\u0026gt;flags \u0026amp; CLIENT_PENDING_WRITE) \u0026amp;\u0026amp; clientHasPendingReplies(c)) 57 putClientInPendingWriteQueue(c); 58 59 // å¦‚æœå®¢æˆ·ç«¯å¿…é¡»åœ¨ä¸»çº¿ç¨‹å¤„ç†ï¼Œå°±æŠŠå®¢æˆ·ç«¯ä¿ç•™åœ¨ä¸»çº¿ç¨‹ä¸­ 60 /*CLIENT_CLOSE_ASAP | CLIENT_MASTER | CLIENT_SLAVE | 61 CLIENT_PUBSUB | CLIENT_MONITOR | CLIENT_BLOCKED | 62 CLIENT_UNBLOCKED | CLIENT_TRACKING | CLIENT_LUA_DEBUG | 63 CLIENT_LUA_DEBUG_SYNC)*/ 64 // è¿™äº›ç±»å‹çš„å®¢æˆ·ç«¯å¿…é¡»åœ¨ä¸»çº¿ç¨‹å¤„ç† 65 if (isClientMustHandledByMainThread(c)) { 66 keepClientInMainThread(c); 67 continue; 68 } 69 70 // æŠŠclientä»ä¸»çº¿ç¨‹å¾…å¤„ç†åˆ—è¡¨ä¸­ç§»é™¤(æœ‰äº›clientå¯èƒ½æ²¡æœ‰å›å¤æ•°æ®éœ€è¦å†™) 71 if (c-\u0026gt;flags \u0026amp; CLIENT_PENDING_WRITE) { 72 c-\u0026gt;flags \u0026amp;= ~CLIENT_PENDING_WRITE; 73 listUnlinkNode(server.clients_pending_write, \u0026amp;c-\u0026gt;clients_pending_write_node); 74 } 75 //åˆ°è¿™,ä¸»çº¿ç¨‹å¯¹è¿™ä¸ªclientçš„å¤„ç†å°±å®Œæˆäº†,æŠŠclientå‘é€å›å¯¹åº”çš„IOçº¿ç¨‹ç»§ç»­å¤„ç† 76 c-\u0026gt;running_tid = c-\u0026gt;tid; 77 listLinkNodeHead(mainThreadPendingClientsToIOThreads[c-\u0026gt;tid], node); 78 node = NULL; 79 80 // ä¸»çº¿ç¨‹å¤„ç†äº†ä¸€å®šæ•°é‡çš„å®¢æˆ·ç«¯ï¼Œå°±æŠŠè¿™äº›å®¢æˆ·ç«¯å‘é€å›å¯¹åº”çš„ IO çº¿ç¨‹ç»§ç»­å¤„ç† 81 sendPendingClientsToIOThreadIfNeeded(t, 1); 82 } 83 if (node) zfree(node); 84 85 // å¤„ç†å®Œæ‰€æœ‰å®¢æˆ·ç«¯åï¼Œå†æŠŠå‰©ä½™çš„å®¢æˆ·ç«¯å‘é€å›å¯¹åº”çš„ IO çº¿ç¨‹ç»§ç»­å¤„ç† 86 sendPendingClientsToIOThreadIfNeeded(t, 0); 87 88 return processed; 89} processPendingCommandAndInputBuffer å‡½æ•° ä¸»è¦æ˜¯å¤„ç†å®¢æˆ·ç«¯çš„æŒ‚èµ·å‘½ä»¤å’Œè¯»å–ç¼“å†²åŒºã€‚\n1int processPendingCommandAndInputBuffer(client *c) { 2 // å¦‚æœå½“å‰clientçš„æ•°æ®å·²ç»å‡†å¤‡å¥½ï¼Œå¯ä»¥å¤„ç†æŒ‚èµ·çš„å‘½ä»¤ 3 if (c-\u0026gt;flags \u0026amp; CLIENT_PENDING_COMMAND) { 4 c-\u0026gt;flags \u0026amp;= ~CLIENT_PENDING_COMMAND; 5 if (processCommandAndResetClient(c) == C_ERR) { 6 return C_ERR; 7 } 8 } 9 10 // ç»§ç»­ä»ç½‘ç»œä¸­è¯»å–æ•°æ®,è§£æ resp åè®® 11 if (c-\u0026gt;querybuf \u0026amp;\u0026amp; sdslen(c-\u0026gt;querybuf) \u0026gt; 0) { 12 return processInputBuffer(c); 13 } 14 return C_OK; 15} processCommandAndResetClient å‡½æ•° ä¸»è¦æ˜¯å¤„ç†å®¢æˆ·ç«¯çš„å‘½ä»¤ã€‚æœ€åä¼šè°ƒç”¨ processCommand å‡½æ•°æ¥å¤„ç†è¿™ä¸ª client çš„å‘½ä»¤ã€‚æœ€ç»ˆä¼šè°ƒç”¨åˆ° client çš„ proc å‡½æ•°æ¥æ‰§è¡Œå…·ä½“çš„å‘½ä»¤å¤„ç†å‡½æ•°ã€‚\nåœ¨è¿™ä¸ªå‡½æ•°ä¸­ï¼Œä¸»çº¿ç¨‹ä¼šå¤„ç†ä» IO çº¿ç¨‹è¯»å–å®Œæ•°æ®çš„å®¢æˆ·ç«¯ã€‚ä¸»è¦åšäº†ä»¥ä¸‹å‡ ä»¶äº‹ï¼š\næŠŠä» IO çº¿ç¨‹è¯»å–å®Œæ•°æ®çš„å®¢æˆ·ç«¯æ¬åˆ°ä¸»çº¿ç¨‹è‡ªå·±çš„å¾…å¤„ç†åˆ—è¡¨ä¸­ã€‚ éå†æ‰€æœ‰å¾…å¤„ç†å®¢æˆ·ç«¯ï¼Œå¤„ç†æ¯ä¸ªå®¢æˆ·ç«¯çš„å‘½ä»¤ã€‚ å¦‚æœå®¢æˆ·ç«¯è¢«æ ‡è®°ä¸ºå…³é—­ï¼Œå°±é‡Šæ”¾å®¢æˆ·ç«¯ã€‚ å¤„ç†å®šæ—¶ä»»åŠ¡ã€‚ å¤„ç†æŒ‚èµ·çš„å‘½ä»¤å’Œè¯»å–ç¼“å†²åŒºã€‚ å¦‚æœå®¢æˆ·ç«¯æœ‰æœªå¤„ç†çš„å›å¤æ•°æ®ï¼Œå°±æŠŠå®¢æˆ·ç«¯æ”¾åˆ°å¾…å†™é˜Ÿåˆ—ä¸­ã€‚ å¦‚æœå®¢æˆ·ç«¯å¿…é¡»åœ¨ä¸»çº¿ç¨‹å¤„ç†ï¼Œå°±æŠŠå®¢æˆ·ç«¯ä¿ç•™åœ¨ä¸»çº¿ç¨‹ä¸­ã€‚ æŠŠå®¢æˆ·ç«¯å‘é€å›å¯¹åº”çš„ IO çº¿ç¨‹ç»§ç»­å¤„ç†ã€‚ åˆ°è¿™é‡Œï¼Œä¸»çº¿ç¨‹é€»è¾‘çš„å·¥ä½œå°±å®Œæˆäº†ï¼Œä¸»çº¿ç¨‹å·²ç»å¤„ç†å®Œä» IO çº¿ç¨‹è¯»å–å®Œæ•°æ®çš„å®¢æˆ·ç«¯ï¼Œå¹¶æŠŠè¿™äº›å®¢æˆ·ç«¯å‘é€å›å¯¹åº”çš„ IO çº¿ç¨‹ç»§ç»­å¤„ç†äº†ã€‚\næ•°æ®è¯»å†™ æ•°æ®è¯»å– å…ˆæ¥çœ‹ä¸€ä¸‹æ•°æ®è¯»å–çš„å¤§æ¦‚æµç¨‹å›¾ï¼š\nè¿æ¥ (conn) è¢«åˆ†é…åˆ° IO çº¿ç¨‹åï¼Œæœ€ç»ˆä¼šæŠŠ conn æ”¾åˆ° IOçº¿ç¨‹çš„ el ä¸­ç®¡ç†ï¼Œå¹¶è®¾ç½®è¯»å¤„ç†å‡½æ•°ä¸º readQueryFromClientã€‚\nå½“æœ‰æ•°æ®å¯è¯»æ—¶ï¼ŒIO çº¿ç¨‹çš„äº‹ä»¶å¾ªç¯ä¼šè°ƒç”¨ readQueryFromClient å‡½æ•°æ¥è¯»å–æ•°æ®ã€‚\n1void readQueryFromClient(connection *conn) { 2 client *c = connGetPrivateData(conn); 3 .................. 4 // æœ€ç»ˆä¼šè°ƒç”¨åˆ°ä¸‹é¢çš„ä»£ç  ä» ç½‘ç»œä¸­è¯»å–æ•°æ® 5 nread = connRead(c-\u0026gt;conn, c-\u0026gt;querybuf+qblen, readlen); 6 if (nread == -1) { 7 if (connGetState(conn) == CONN_STATE_CONNECTED) { 8 goto done; 9 } else { 10 c-\u0026gt;read_error = CLIENT_READ_CONN_DISCONNECTED; 11 freeClientAsync(c); 12 goto done; 13 } 14 } else if (nread == 0) { 15 c-\u0026gt;read_error = CLIENT_READ_CONN_CLOSED; 16 freeClientAsync(c); 17 goto done; 18 } 19 20 .................... 21 // è¯»å–åˆ°æ•°æ®åï¼Œå¼€å§‹è§£æ resp åè®®,æœ€ç»ˆä¼šè°ƒç”¨ enqueuePendingClientsToMainThread å‡½æ•° 22 // æŠŠå½“å‰ client æ”¾åˆ°ä¸»çº¿ç¨‹å¾…å¤„ç†åˆ—è¡¨ä¸­ 23 if (processInputBuffer(c) == C_ERR) 24 c = NULL; 25 26 ................... 27} åœ¨è¿™ä¸ªå‡½æ•°ä¸­ï¼ŒIO çº¿ç¨‹ä¼šä»ç½‘ç»œä¸­è¯»å–æ•°æ®ï¼Œå¹¶æŠŠæ•°æ®æ”¾åˆ°å®¢æˆ·ç«¯çš„ querybuf ä¸­ã€‚ç„¶åè°ƒç”¨ processInputBuffer å‡½æ•°æ¥è§£æ resp åè®®ã€‚æœ€ç»ˆä¼šè°ƒç”¨ enqueuePendingClientsToMainThread å‡½æ•°ï¼Œç„¶åè°ƒç”¨ sendPendingClientsToMainThreadIfNeeded å‡½æ•°é€šçŸ¥ä¸»çº¿ç¨‹æœ‰æ–°å®¢æˆ·ç«¯å¯å¤„ç†ã€‚\n1static inline void sendPendingClientsToMainThreadIfNeeded(IOThread *t, int check_size) { 2 size_t len = listLength(t-\u0026gt;pending_clients_to_main_thread); 3 if (len == 0 || (check_size \u0026amp;\u0026amp; len \u0026lt; IO_THREAD_MAX_PENDING_CLIENTS)) return; 4 5 int running = 0, pending = 0; 6 pthread_mutex_lock(\u0026amp;mainThreadPendingClientsMutexes[t-\u0026gt;id]); 7 pending = listLength(mainThreadPendingClients[t-\u0026gt;id]); 8 // æŠŠå¾…å¤„ç†çš„å®¢æˆ·ç«¯æ¬åˆ°ä¸»çº¿ç¨‹çš„å¾…å¤„ç† list ä¸­ 9 listJoin(mainThreadPendingClients[t-\u0026gt;id], t-\u0026gt;pending_clients_to_main_thread); 10 pthread_mutex_unlock(\u0026amp;mainThreadPendingClientsMutexes[t-\u0026gt;id]); 11 if (!pending) atomicGetWithSync(server.running, running); 12 13 // å¦‚æœä¸»çº¿ç¨‹æ²¡æœ‰åœ¨è¿è¡Œï¼Œå¹¶ä¸”æ²¡æœ‰å¾…å¤„ç†çš„å®¢æˆ·ç«¯ï¼Œå°±è§¦å‘é€šçŸ¥å™¨ï¼Œå”¤é†’ä¸»çº¿ç¨‹å¤„ç† 14 if (!running \u0026amp;\u0026amp; !pending) { 15 triggerEventNotifier(mainThreadPendingClientsNotifiers[t-\u0026gt;id]); 16 } 17} åˆ°è¿™ï¼Œæ•°æ®è¯»å–çš„å·¥ä½œå°±å®Œæˆäº†ï¼ŒIO çº¿ç¨‹å·²ç»ä»ç½‘ç»œä¸­è¯»å–æ•°æ®ï¼Œå¹¶æŠŠå®¢æˆ·ç«¯å‘é€åˆ°ä¸»çº¿ç¨‹è¿›è¡Œå¤„ç†äº†ã€‚\næ•°æ®å†™å…¥ æ•°æ®å†™å…¥çš„å¤§æ¦‚æµç¨‹å›¾ï¼š\nIO çº¿ç¨‹çš„ el æ”¶åˆ°ä¸»çº¿ç¨‹å‘æ¥çš„é€šçŸ¥ (ä½¿ç”¨ pending_clients_notifier) ï¼Œä¼šè°ƒç”¨ handleClientsFromMainThread ç„¶åä¼šè°ƒç”¨ processClientsFromMainThread å‡½æ•°æ¥å¤„ç†ä¸»çº¿ç¨‹åˆ†é…ç»™å®ƒçš„å¾…å¤„ç†å®¢æˆ·ç«¯ã€‚\nè¿™ä¸ªå‡½æ•°åœ¨ IO çº¿ç¨‹é€»è¾‘é‚£é‡Œå·²ç»åˆ†æè¿‡äº†ï¼Œå°±ä¸å®Œå…¨å±•å¼€äº†\n1int processClientsFromMainThread(IOThread *t) { 2 pthread_mutex_lock(\u0026amp;t-\u0026gt;pending_clients_mutex); 3 // æŠŠä¸»çº¿ç¨‹åˆ†é…ç»™ IO çº¿ç¨‹çš„å¾…å¤„ç†å®¢æˆ·ç«¯æ¬åˆ° IO çº¿ç¨‹è‡ªå·±çš„å¾…å¤„ç†åˆ—è¡¨ä¸­ 4 listJoin(t-\u0026gt;processing_clients, t-\u0026gt;pending_clients); 5 pthread_mutex_unlock(\u0026amp;t-\u0026gt;pending_clients_mutex); 6 size_t processed = listLength(t-\u0026gt;processing_clients); 7 if (processed == 0) return 0; 8 while((ln = listNext(\u0026amp;li))) { 9 client *c = listNodeValue(ln); 10 .............. 11 // æŠŠå®¢æˆ·ç«¯ä»å¾…å¤„ç†åˆ—è¡¨ä¸­ç§»é™¤ï¼ŒåŠ å…¥åˆ° IO çº¿ç¨‹ç®¡ç†çš„å®¢æˆ·ç«¯åˆ—è¡¨ä¸­ 12 listUnlinkNode(t-\u0026gt;processing_clients, ln); 13 listLinkNodeTail(t-\u0026gt;clients, ln); 14 c-\u0026gt;io_thread_client_list_node = listLast(t-\u0026gt;clients); 15 // å¦‚æœå®¢æˆ·ç«¯è¢«æ ‡è®°ä¸ºå…³é—­ï¼Œå°±æŠŠå®¢æˆ·ç«¯å‘é€å›ä¸»çº¿ç¨‹å¤„ç† 16 if (c-\u0026gt;io_flags \u0026amp; CLIENT_IO_CLOSE_ASAP) { 17 enqueuePendingClientsToMainThread(c, 1); 18 continue; 19 } 20 21 // å¦‚æœæœ‰éœ€è¦å†™å…¥çš„æ•°æ®ï¼Œå°±å†™æ•°æ®ç»™å®¢æˆ·ç«¯ 22 if (clientHasPendingReplies(c)) { 23 //writeToClientå‡½æ•°è´Ÿè´£æŠŠå›å¤æ•°æ®å†™å…¥åˆ°ç½‘ç»œä¸­ 24 writeToClient(c, 0); 25 } 26 } 27 28 return processed; 29} é™¤äº† el ä¸­çš„ fileProc å¤„ç†å‡½æ•°å¤–ï¼Œè¿˜ä¼šåœ¨ IOThreadBeforeSleep å‡½æ•°ä¸­è°ƒç”¨ processClientsFromMainThread æ¥å¤„ç†\nå› ä¸ºä¸»çº¿ç¨‹å¯èƒ½ä¼šåœ¨ IO çº¿ç¨‹å¤„ç†äº‹ä»¶æœŸé—´ä¼ é€’å®¢æˆ·ç«¯è€Œä¸å‘å‡ºé€šçŸ¥ï¼Œæ‰€ä»¥åœ¨ IO çº¿ç¨‹è¿›å…¥ç¡çœ ä¹‹å‰å†è°ƒç”¨ä¸€æ¬¡ processClientsFromMainThread ç¡®ä¿ä¸ä¼šé—æ¼ä»»ä½•å¾…å¤„ç†çš„å®¢æˆ·ç«¯ã€‚\næ€»ç»“ æ´‹æ´‹æ´’æ´’å†™äº†è¿™ä¹ˆå¤šï¼Œåº”è¯¥æ˜¯èƒ½æŠŠ redis å¤šçº¿ç¨‹ IO æ¨¡å‹çš„å¤§æ¦‚çš„æ¡†æ¶ç†æ¸…æ¥šäº†ã€‚\nç›¸æ¯”ä¹‹å‰çš„ç‰ˆæœ¬(6.0ç‰ˆæœ¬)ï¼Œè¿™æ¬¡æ›´æ–°ä¸»è¦æ˜¯æŠŠç½‘ç»œ IO æ“ä½œå®Œå…¨æ”¾åˆ°äº† IO çº¿ç¨‹ä¸­å»å¤„ç†ã€‚å¹¶ä¸”ä¸»çº¿ç¨‹ä¸ä¼šç­‰å¾…æ‰€æœ‰ IO çº¿ç¨‹å¤„ç†å®Œæ•°æ®åå†ç»§ç»­å¤„ç†ï¼Œè€Œæ˜¯é€šè¿‡é€šçŸ¥å™¨çš„æ–¹å¼ï¼Œè®©ä¸»çº¿ç¨‹å’Œ IO çº¿ç¨‹å¹¶è¡Œå¤„ç†æ•°æ®ï¼Œä»è€Œæé«˜äº†æ•´ä½“çš„ååé‡ã€‚è¿™å¯¹äº IO å¯†é›†å‹çš„åº”ç”¨åœºæ™¯æ¥è¯´ï¼Œæå‡è¿˜æ˜¯æ¯”è¾ƒæ˜æ˜¾çš„ã€‚\nè¿™å…¶ä¸­ï¼Œéå¸¸å·§å¦™çš„ä½¿ç”¨äº†äº‹ä»¶é€šçŸ¥å™¨(eventNotifier)æ¥å®ç°ä¸»çº¿ç¨‹å’Œ IO çº¿ç¨‹ä¹‹é—´çš„é€šä¿¡ï¼Œä»è€Œé¿å…äº†å¤æ‚çš„é”æœºåˆ¶ï¼Œæé«˜äº†å¹¶å‘æ€§èƒ½ã€‚\nå¦‚æœ C è¯­è¨€ä¸­æœ‰æ›´é«˜çº§çš„å¹¶å‘ç¼–ç¨‹æ¨¡å‹(æ¯”å¦‚ Golang çš„åç¨‹å’Œé€šé“)ï¼Œå®ç°èµ·æ¥ä¼šæ›´åŠ ç®€æ´å’Œæ¸…æ™°ã€‚ä½¿ç”¨ C è¯­è¨€å®ç°å¤šçº¿ç¨‹ IO æ¨¡å‹ï¼Œä»£ç ä¼šæ¯”è¾ƒå¤æ‚ï¼Œéœ€è¦æ‰‹åŠ¨ç®¡ç†çº¿ç¨‹å’ŒåŒæ­¥æœºåˆ¶ã€‚å°¤å…¶æ˜¯å¤§é‡ä½¿ç”¨äº†å‡½æ•°æŒ‡é’ˆç­‰å¾…å›è°ƒå‡½æ•°ï¼Œç¬¬ä¸€æ¬¡é˜…è¯»æºç æ—¶ï¼Œç†è§£èµ·æ¥ä¼šæ¯”è¾ƒåƒåŠ›ã€‚ä¸è¿‡é€šè¿‡è¿™æ¬¡åˆ†æï¼Œè¿˜æ˜¯å¯¹ redis çš„å¤šçº¿ç¨‹ IO æ¨¡å‹æœ‰äº†æ›´æ·±å…¥çš„ç†è§£ã€‚\nè¿™æ¬¡åªæ˜¯ç®€å•çš„å­¦ä¹ äº†ä¸€ä¸‹å¤§æ¦‚çš„æ¡†æ¶ï¼Œå…¶ä¸­çš„ä¸€äº›ç»†èŠ‚å’Œä¼˜åŒ–æ‰‹æ®µæ²¡æœ‰å±•å¼€åˆ†æï¼Œæ¯”å¦‚å‘½ä»¤é¢„å–æœºåˆ¶ã€IO çº¿ç¨‹çš„æš‚åœå’Œæ¢å¤æœºåˆ¶ç­‰ï¼Œåç»­æœ‰æ—¶é—´å†æ·±å…¥ç ”ç©¶ä¸€ä¸‹ã€‚\n","date":"2025-11-15T10:10:02+08:00","image":"https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/b6829b1bf489add61640750d4fd21727b3b441b3.webp","permalink":"https://lqxhub.github.io/posts/94b79760/","title":"Redis8.0 æºç  ç½‘ç»œæ¨¡å—ï¼Œå¤šçº¿ç¨‹æ¨¡å—"},{"content":"å‰æ®µæ—¶é—´ï¼Œä½¿ç”¨C++åç¨‹+liburingå®ç°äº†ä¸€ä¸ªç®€å•çš„ echo serverï¼Œæ–‡ç« åœ°å€ã€‚\néƒ½è¯´ä½¿ç”¨ uring å¯ä»¥è·å¾—æ›´å¥½çš„æ€§èƒ½ï¼Œä½†æ˜¯ç©¶ç«Ÿèƒ½æå‡å¤šå°‘å‘¢ï¼Ÿæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥å¯¹æ¯”ä¸€ä¸‹ liburing å’Œ epoll çš„æ€§èƒ½ã€‚\næµ‹è¯•æ–¹å¼ åœ¨åŸæ¥çš„ echo server åŸºç¡€ä¸Šæ”¹åŠ¨äº†ä¸€ä¸‹ï¼ŒæŠŠ echo server æ”¹æˆäº†ä¸€ä¸ªç®€å•çš„ HTTP serverï¼Œè¿”å›ä¸€ä¸ªå›ºå®šçš„ HTML å†…å®¹ã€‚\nç„¶åä½¿ç”¨ go-stress-testing è¿™ä¸ªå·¥å…·è¿›è¡Œå‹åŠ›æµ‹è¯•ã€‚\næµ‹è¯•å·¥å…·åœ¨windows 10 ä¸Šã€‚HTTP æœåŠ¡è¿è¡Œè¿™ä¸ªwindows 10 çš„ VMè™šæ‹Ÿæœºä¸Šã€‚ç³»ç»Ÿæ˜¯ debian13ï¼Œlinuxå†…æ ¸æ˜¯ 6.12.41-amd64\nç¼–è¯‘å™¨ä½¿ç”¨ clang-18 ç¼–è¯‘å‚æ•° -O2 stdlib=libc++ -std=c++23 è¿›è¡Œç¼–è¯‘ã€‚\nuring æœåŠ¡å’Œ epoll æœåŠ¡éƒ½æ˜¯å•çº¿ç¨‹æ¨¡å‹ï¼Œå•çº¿ç¨‹å¤„ç†æ‰€æœ‰è¿æ¥ã€‚\næµ‹è¯•ä»£ç  è¿™é‡Œå°±ä¸è´´æ‰€æœ‰ä»£ç äº†ï¼Œä¸»è¦è´´ä¸€ä¸‹å…³é”®éƒ¨åˆ†ã€‚\nuring ç‰ˆæœ¬ 1Task\u0026lt;false\u0026gt; IoUring::startSession(int fd, uint64_t connId) { 2 std::string buffer; 3 buffer.resize(1024); 4 bool closed = false; 5 while (!closed) { 6 auto aRead = AwaitableRead(this, fd, buffer); 7 while (true) { 8 int res = co_await aRead; 9 if (res \u0026lt;= 0) { // è¿æ¥å…³é—­æˆ–è€…è¯»å–é”™è¯¯ 10 closed = true; 11 break; 12 } 13 if (res == 1) { // è¯»å®Œäº† 14 break; 15 } 16 } 17 if (closed) { 18 break; 19 } 20 21 // std::cout \u0026lt;\u0026lt; \u0026#34;Received data: \u0026#34;; 22 23 std::string response; 24 std::string body = 25 \u0026#34;\u0026lt;!DOCTYPE html\u0026gt;\u0026lt;html\u0026gt;\u0026lt;head\u0026gt;\u0026lt;title\u0026gt;Test Page\u0026lt;/title\u0026gt;\u0026lt;/head\u0026gt;\u0026lt;body\u0026gt;\u0026#34; 26 \u0026#34;\u0026lt;p\u0026gt;Hello, this is a test HTML content for HTTP response.\u0026lt;/p\u0026gt;\u0026#34; 27 \u0026#34;\u0026lt;/body\u0026gt;\u0026lt;/html\u0026gt;\u0026#34;; 28 response.reserve(128 + body.size()); // å‡å°‘æ‹·è´ 29 30 response += \u0026#34;HTTP/1.1 200 OK\\r\\n\u0026#34; 31 \u0026#34;Content-Length: \u0026#34; + 32 std::to_string(body.size()) + 33 \u0026#34;\\r\\n\u0026#34; 34 \u0026#34;Content-Type: text/html; charset=UTF-8\\r\\n\u0026#34; 35 \u0026#34;Connection: close\\r\\n\u0026#34; 36 \u0026#34;Date: Mon, 21 Oct 2024 13:24:24 GMT\\r\\n\\r\\n\u0026#34;; 37 response += body; 38 39 auto aWrite = AwaitableWrite(this, fd, std::move(std::string(response))); 40 while (true) { 41 int res = co_await aWrite; 42 if (res \u0026lt; 0) { // å†™å‡ºé”™äº† 43 closed = true; 44 break; 45 } 46 if (res == 0) { // å†™å®Œäº† 47 break; 48 } 49 } 50 } 51 close(fd); 52 co_return; 53} åœ¨åŸæ¥çš„ echo server åŸºç¡€ä¸Šï¼Œæ”¹æˆäº† HTTP serverã€‚ç„¶åä½¿ç”¨åç¨‹å¤„ç†æ¯ä¸ªè¿æ¥ã€‚\nepoll ç‰ˆæœ¬ 1void Epoll::run() 2{ 3 std::cout \u0026lt;\u0026lt; \u0026#34;Epoll::run\u0026#34; \u0026lt;\u0026lt; std::endl; 4 epoll_event events[EVENT_SIZE]; 5 while (true) 6 { 7 int nfds = epoll_wait(ePollFd_, events, EVENT_SIZE, -1); 8 if (nfds \u0026lt; 0) 9 { 10 std::cerr \u0026lt;\u0026lt; \u0026#34;epoll_wait failed nfds:\u0026#34; \u0026lt;\u0026lt; nfds \u0026lt;\u0026lt; \u0026#34;errno:\u0026#34; \u0026lt;\u0026lt; errno \u0026lt;\u0026lt; std::endl; 11 break; 12 } 13 if (errno == EINTR) 14 { 15 // ç³»ç»Ÿè°ƒç”¨è¢«ä¸­æ–­ï¼Œç»§ç»­é‡è¯• 16 continue; 17 } 18 for (int i = 0; i \u0026lt; nfds; ++i) 19 { 20 if (events[i].events \u0026amp; EPOLLERR || events[i].events \u0026amp; EPOLLHUP) 21 { 22 std::cout \u0026lt;\u0026lt; \u0026#34;epoll_wait failed errno:\u0026#34; \u0026lt;\u0026lt; errno \u0026lt;\u0026lt; std::endl; 23 delFd(events[i].data.fd); 24 close(events[i].data.fd); 25 continue; 26 } 27 if (events[i].events \u0026amp; EPOLLIN) 28 { 29 if (events[i].data.fd == listenFd_) 30 { 31 sockaddr_in cliAddr{}; 32 socklen_t length = sizeof(cliAddr); 33 int clientFd = accept4(listenFd_, reinterpret_cast\u0026lt;sockaddr*\u0026gt;(\u0026amp;cliAddr), \u0026amp;length, 34 0); 35 if (clientFd \u0026lt; 0) 36 { 37 std::cerr \u0026lt;\u0026lt; \u0026#34;accept failed fd:\u0026#34; \u0026lt;\u0026lt; clientFd \u0026lt;\u0026lt; \u0026#34;errno:\u0026#34; \u0026lt;\u0026lt; errno \u0026lt;\u0026lt; std::endl; 38 continue; 39 } 40 std::cout \u0026lt;\u0026lt; \u0026#34;new client fd\u0026#34; \u0026lt;\u0026lt; clientFd \u0026lt;\u0026lt; std::endl; 41 addRead(clientFd); 42 } 43 else 44 { 45 char buff[1024]; 46 int n = ::read(events[i].data.fd, buff, sizeof(buff)); 47 if (n \u0026lt;= 0) 48 { 49 std::cout \u0026lt;\u0026lt; \u0026#34;close fd:\u0026#34; \u0026lt;\u0026lt; events[i].data.fd \u0026lt;\u0026lt; std::endl; 50 delFd(events[i].data.fd); 51 close(events[i].data.fd); 52 continue; 53 } 54 std::string response; 55 response.reserve(128 + image.size()); // å‡å°‘æ‹·è´ 56 response += \u0026#34;HTTP/1.1 200 OK\\r\\n\u0026#34; 57 \u0026#34;Content-Length: \u0026#34; + std::to_string(image.size()) + \u0026#34;\\r\\n\u0026#34; 58 \u0026#34;Content-Type: image/jpeg\\r\\n\u0026#34; 59 \u0026#34;Connection: close\\r\\n\u0026#34; 60 \u0026#34;Date: Mon, 21 Oct 2024 13:24:24 GMT\\r\\n\\r\\n\u0026#34;; 61 response += image; 62 write(events[i].data.fd, response.data(), response.size()); 63 } 64 } 65 } 66 } 67} epoll ç‰ˆæœ¬æ²¡æœ‰ä½¿ç”¨åç¨‹ï¼Œç›´æ¥åœ¨äº‹ä»¶å¾ªç¯ä¸­å¤„ç†æ‰€æœ‰è¿æ¥ã€‚ä¸¤ä¸ªHTTP server å¤„ç†é€»è¾‘æ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯è¯»å–è¯·æ±‚ï¼Œç„¶åè¿”å›ä¸€ä¸ªå›ºå®šçš„ HTML å†…å®¹ã€‚\næµ‹è¯•ç»“æœ æœ¬æ¬¡æµ‹è¯• io_uringä½¿ç”¨ ä¸­æ–­æ¨¡å¼\nä¸­æ–­æ¨¡å¼ä¹Ÿæ˜¯ io_uring çš„é»˜è®¤æ¨¡å¼ï¼Œå…³äº io_uring çš„ä¸¤ç§æ¨¡å¼ï¼Œä¸­æ–­æ¨¡å¼ è½®è¯¢æ¨¡å¼ å’Œ å†…æ ¸è½®è¯¢æ¨¡å¼ çš„åŒºåˆ«ï¼Œ å…ˆæŒ–ä¸ªå‘ï¼Œåç»­å†å†™ä¸€ç¯‡æ–‡ç« è¿›è¡Œä»‹ç»ã€‚\nè¿™ä¸ªHTTP server è¿”å›ä¸€ä¸ªç®€å•çš„ HTML å†…å®¹ï¼š\n1\u0026lt;!DOCTYPE html\u0026gt;\u0026lt;html\u0026gt;\u0026lt;head\u0026gt;\u0026lt;title\u0026gt;Test Page\u0026lt;/title\u0026gt;\u0026lt;/head\u0026gt;\u0026lt;body\u0026gt; 2 \u0026lt;p\u0026gt;Hello, this is a test HTML content for HTTP response.\u0026lt;/p\u0026gt; 3\u0026lt;/body\u0026gt;\u0026lt;/html\u0026gt; ä½¿ç”¨ go-stress-testing è¿›è¡Œå‹åŠ›æµ‹è¯•ï¼Œæµ‹è¯•å‘½ä»¤å¦‚ä¸‹ï¼š\nå¼€å¯ 100 ä¸ªå¹¶å‘è¿æ¥ï¼Œæ¯ä¸ªè¿æ¥å‘é€ 100 æ¬¡è¯·æ±‚ã€‚\n1go-stress-testing-win.exe -u \u0026#34;http://192.168.1.19:8088\u0026#34; -c 100 -n 100 uring ç‰ˆæœ¬æµ‹è¯•ç»“æœ\nå¯ä»¥çœ‹åˆ° QPS è¾¾åˆ°äº† 4800+ï¼Œå¹³å‡å“åº”æ—¶é—´ 20msã€‚\nepoll ç‰ˆæœ¬æµ‹è¯•ç»“æœ\nå¯ä»¥çœ‹åˆ° QPS åªæœ‰ 4000+ï¼Œå¹³å‡å“åº”æ—¶é—´ 23msã€‚\nuring ç‰ˆæœ¬çš„æ€§èƒ½æ¯” epoll ç‰ˆæœ¬æå‡äº† 20% å·¦å³ã€‚\næµ‹è¯•2 ä¸Šé¢çš„æµ‹è¯•ä¸­ï¼ŒHTMLè¿”å›äº†ä¸€ä¸ªç®€å•çš„ç½‘é¡µï¼Œç°åœ¨æ”¹æˆè¿”å›ä¸€ä¸ª148KB çš„å›¾ç‰‡ï¼Œä¸ºäº†é˜²æ­¢ç½‘ç»œæˆä¸ºç“¶é¢ˆï¼Œè¿™æ¬¡å¹¶å‘æ•°æ”¹æˆ 50ï¼Œè¿æ¥æ•°æ”¹æˆ 50ã€‚\nåœ¨è¿›ç¨‹å¯åŠ¨çš„æ—¶å€™ï¼ŒæŠŠå›¾ç‰‡è¯»åˆ°å†…å­˜ä¸­ï¼Œé¿å…æ¯æ¬¡éƒ½è¯»ç£ç›˜ï¼Œç„¶åæ¯æ¬¡è¯·æ±‚éƒ½è¿”å›è¿™ä¸ªå›¾ç‰‡ã€‚\nè¿™ä¸ªæ”¹åŠ¨æ¯”è¾ƒå°ï¼Œåªä¸€ä¸‹ response çš„å†…å®¹ï¼š\n1 response.reserve(128 + image.size()); // å‡å°‘æ‹·è´ 2 3 response += \u0026#34;HTTP/1.1 200 OK\\r\\n\u0026#34; 4 \u0026#34;Content-Length: \u0026#34; + 5 std::to_string(image.size()) + 6 \u0026#34;\\r\\n\u0026#34; 7 \u0026#34;Content-Type: image/jpeg\\r\\n\u0026#34; 8 \u0026#34;Connection: close\\r\\n\u0026#34; 9 \u0026#34;Date: Mon, 21 Oct 2024 13:24:24 GMT\\r\\n\\r\\n\u0026#34;; 10 response += image; ä½¿ç”¨ go-stress-testing è¿›è¡Œå‹åŠ›æµ‹è¯•ï¼Œæµ‹è¯•å‘½ä»¤å¦‚ä¸‹ï¼š\n1go-stress-testing-win.exe -u \u0026#34;http://192.168.1.19:8088\u0026#34; -c 50 -n 50 å¼€å¯ 50 ä¸ªå¹¶å‘è¿æ¥ï¼Œæ¯ä¸ªè¿æ¥å‘é€ 50 æ¬¡è¯·æ±‚ã€‚\nuring ç‰ˆæœ¬æµ‹è¯•ç»“æœ\nå¯ä»¥çœ‹åˆ° QPS è¾¾åˆ°äº† 1300+ï¼Œå¹³å‡å“åº”æ—¶é—´ 37msã€‚\nepoll ç‰ˆæœ¬æµ‹è¯•ç»“æœ\nå¯ä»¥çœ‹åˆ° QPS åªæœ‰ 520+ï¼Œå¹³å‡å“åº”æ—¶é—´ 93msã€‚\nå¯ä»¥çœ‹åˆ°ï¼Œuring ç‰ˆæœ¬çš„æ€§èƒ½æ˜¯ epoll ç‰ˆæœ¬çš„ 2.5 å€å·¦å³ã€‚è¿™ä¸ªæå‡è¿˜æ˜¯éå¸¸æ˜æ˜¾çš„ã€‚\næ€»ç»“ é€šè¿‡ä¸Šé¢çš„æµ‹è¯•ï¼Œå¯ä»¥çœ‹åˆ° liburing ç›¸æ¯” epoll åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œä¸ç®¡æ˜¯ QPS è¿˜æ˜¯ å“åº”è€—æ—¶ï¼Œæ€§èƒ½æå‡è¿˜æ˜¯æ¯”è¾ƒæ˜æ˜¾çš„ã€‚\nå…·ä½“æ¥è¯´ï¼Œuring ç‰ˆæœ¬åœ¨å¤„ç†å°æ–‡ä»¶æ—¶çš„ QPS æ¯” epoll ç‰ˆæœ¬é«˜å‡º 20% å·¦å³ï¼Œè€Œåœ¨å¤„ç†å¤§æ–‡ä»¶æ—¶çš„ QPS åˆ™é«˜å‡º 2.5 å€å·¦å³ã€‚è¿™äº›æµ‹è¯•ç»“æœè¡¨æ˜ï¼Œliburing åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹å…·æœ‰æ›´å¥½çš„æ€§èƒ½è¡¨ç°ï¼Œå°¤å…¶æ˜¯åœ¨è¯»å–å’Œå†™å…¥å¤§çš„æ•°æ®æ—¶ï¼Œä¼˜åŠ¿æ›´åŠ æ˜æ˜¾ã€‚è¿™è¿˜æ˜¯æå‰ä»æ–‡ä»¶ä¸­è¯»å–åˆ°å†…å­˜ä¸­ï¼Œé¿å…äº†ç£ç›˜ I/O çš„å½±å“ã€‚å¦‚æœæ˜¯æ¯æ¬¡éƒ½ä»ç£ç›˜è¯»å–ï¼Œä½¿ç”¨ liburing å¼‚æ­¥è¯»å–å’Œæ™®é€šçš„ read å‡½æ•°è¯»å–å¯¹æ¯”ï¼Œæ€§èƒ½å·®è·å¯èƒ½ä¼šæ›´å¤§ã€‚ è¿™ä¹Ÿæ˜¯å› ä¸º liburing èƒ½å¤Ÿæ›´é«˜æ•ˆåœ°åˆ©ç”¨å†…æ ¸çš„å¼‚æ­¥ I/O èƒ½åŠ›ï¼Œå‡å°‘äº†ç³»ç»Ÿè°ƒç”¨çš„å¼€é”€ï¼Œä»è€Œæå‡äº†æ•´ä½“çš„ååé‡å’Œå“åº”é€Ÿåº¦ã€‚\n","date":"2025-09-13T19:04:48+08:00","image":"https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/1ca5f47363ab61f726ef725e58827790e00be3f7.jpg","permalink":"https://lqxhub.github.io/posts/6da4ad2d/","title":"ä½¿ç”¨C++åç¨‹+liburingçš„HTTP server å’Œ epoll çš„ HTTP server æ€§èƒ½å¯¹æ¯”"},{"content":"å…ˆèŠä¸€ä¸‹ä»€ä¹ˆæ˜¯SSHéš§é“è½¬å‘å§ï¼Œéš§é“è½¬å‘ä¹Ÿè¢«ç§°ä½œæ˜¯SSH ç«¯å£è½¬å‘ï¼Œæ˜¯ä¸€ç§é€šè¿‡SSHåè®®å°†æœ¬åœ°ç«¯å£è½¬å‘åˆ°è¿œç¨‹ä¸»æœºçš„æŠ€æœ¯ã€‚å®ƒå¯ä»¥å®ç°å®‰å…¨çš„ç½‘ç»œè¿æ¥ï¼Œå¸¸ç”¨äºç©¿è¶Šé˜²ç«å¢™æˆ–è®¿é—®å†…ç½‘æœåŠ¡ã€‚\nSSHéš§é“è½¬å‘çš„å·¥ä½œåŸç†æ˜¯ï¼Œåœ¨SSHè¿æ¥å»ºç«‹åï¼Œé€šè¿‡SSHåè®®å°†æœ¬åœ°ç«¯å£çš„æµé‡åŠ å¯†åè½¬å‘åˆ°è¿œç¨‹ä¸»æœºçš„æŒ‡å®šç«¯å£ã€‚è¿™æ ·ï¼Œç”¨æˆ·å°±å¯ä»¥é€šè¿‡æœ¬åœ°ç«¯å£è®¿é—®è¿œç¨‹ä¸»æœºçš„æœåŠ¡ï¼Œè€Œä¸å¿…ç›´æ¥æš´éœ²è¿œç¨‹ä¸»æœºçš„ç«¯å£ã€‚æœ€å¸¸è§çš„åº”ç”¨åœºæ™¯æ˜¯åœ¨æœ¬åœ°è¿æ¥äº‘æœåŠ¡çš„æ•°æ®åº“ï¼Œæˆ–è€…è®¿é—®å…¬å¸å†…ç½‘çš„èµ„æºã€‚ä¸€èˆ¬äº‘MySQLæ•°æ®åº“éƒ½æ˜¯ä¸å¼€æ”¾å…¬ç½‘çš„ï¼Œåªèƒ½åœ¨å†…ç½‘ä¸­è®¿é—®ï¼Œä¸ºäº†åœ¨å…¬ç½‘èƒ½è®¿é—®è¿™äº›èµ„æºï¼Œå°±éœ€è¦ä½¿ç”¨SSHéš§é“è½¬å‘ã€‚\nåœ¨ Navicat ä¸­è¿æ¥MySQL æ•°æ®åº“æ—¶ï¼Œå¯ä»¥é€šè¿‡SSHéš§é“è½¬å‘æ¥è¿æ¥æ²¡æœ‰å…¬ç½‘IPçš„æ•°æ®åº“ï¼Œè¿æ¥é…ç½®å¦‚ä¸‹å›¾\nä¸ºä»€ä¹ˆè¦ç”¨goå®ç°ä¸€ä¸ªSSH éš§é“è½¬å‘ä»£ç†å‘¢ï¼Ÿä¸»è¦æ˜¯æˆ‘ä»¬å…¬å¸çš„å¾ˆå¤šrediså®ä¾‹éƒ½åœ¨äº‘ä¸Šï¼Œæ— æ³•ç›´æ¥åœ¨å…¬ç½‘ä¸­è®¿é—®ã€‚é€šè¿‡SSHéš§é“è½¬å‘ï¼Œå¯ä»¥å®ç°åœ¨å…¬ç½‘ä¸­è®¿é—®è¿™äº›äº‘ä¸Šçš„rediså®ä¾‹ã€‚ä¸ºä»€ä¹ˆä¸ç”¨ç°æˆçš„å·¥å…·å‘¢ï¼Ÿ\né¦–å…ˆ redis-cli å·¥å…·ä¸æ”¯æŒSSHéš§é“è½¬å‘ï¼Œè¦è§£å†³é—®é¢˜ï¼Œæœ‰ä¸¤ç§é€‰æ‹©\né€‰æ‹©ä¸€äº›GUIçš„rediså®¢æˆ·ç«¯å·¥å…·ï¼Œä½†æ˜¯è¿™äº›å·¥å…·å¾€å¾€éœ€è¦é¢å¤–çš„é…ç½®ï¼Œä½¿ç”¨èµ·æ¥ä¸å¤Ÿæ–¹ä¾¿ã€‚æ‰€ä»¥è€ƒè™‘è‡ªå·±å†™ä¸€ä¸ªç®€å•çš„å‘½ä»¤è¡Œå·¥å…·æ¥å®ç°è¿™ä¸ªåŠŸèƒ½ã€‚ ç›´æ¥ä½¿ç”¨SSHå‘½ä»¤è¿›è¡Œç«¯å£è½¬å‘ï¼Œç„¶åå†ä½¿ç”¨redis-cliè¿æ¥æœ¬åœ°ç«¯å£ã€‚è¿™ç§æ–¹å¼æ¯”è¾ƒç®€å•ï¼Œä½†éœ€è¦æ‰‹åŠ¨ç®¡ç†SSHè¿æ¥ ä½¿ç”¨è¿™ä¸¤ä¸ªæ–¹æ¡ˆè¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œè¦å¯¹æ‰€æœ‰äººå…¬å¼€SSHæœºå™¨çš„è´¦å·å¯†ç ï¼Œå­˜åœ¨å®‰å…¨éšæ‚£ã€‚\næ‰€ä»¥è‡ªå·±å®ç°ä¸€ä¸ªç®€å•çš„ æ”¯æŒ SSH éš§é“è½¬å‘çš„ redis-cli å·¥å…·æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ï¼Œæ­£å¥½å¯ä»¥å€Ÿè¿™ä¸ªæœºä¼šå­¦ä¹ ä¸€ä¸‹ç›¸å…³çš„æŠ€æœ¯ã€‚è¿™ä¸ªå·¥å…·è¦æœ‰ä»¥ä¸‹åŠŸèƒ½ï¼š\næ”¯æŒé€šè¿‡SSHéš§é“è¿æ¥åˆ°è¿œç¨‹Rediså®ä¾‹ å¯¹ä½¿ç”¨è€…é€æ˜SSHè¿æ¥çš„å»ºç«‹å’Œæ–­å¼€ æ”¯æŒé…ç½®æ–‡ä»¶ï¼Œæˆ–è€…ç›´æ¥æŠŠSSHç›¸å…³çš„ä¿¡æ¯ç¼–è¯‘åœ¨ä»£ç ä¸­ å¤§æ¦‚çš„åŸç†å¦‚å›¾ï¼š\ntun redis-cli æ˜¯è¦é€šè¿‡SSHéš§é“è¿æ¥åˆ°è¿œç¨‹Rediså®ä¾‹çš„å·¥å…·ã€‚ SSH server æ˜¯æˆ‘ä»¬ç”¨æ¥å»ºç«‹SSHè¿æ¥çš„ä¸­é—´æœåŠ¡å™¨ã€‚ redis server æ˜¯æˆ‘ä»¬è¦è®¿é—®çš„è¿œç¨‹Rediså®ä¾‹ã€‚\ntun redis-cli é€šè¿‡ SSH å…ˆè¿æ¥åˆ° å…·æœ‰å…¬ç½‘IPçš„ SSH server ä¸Šï¼Œç„¶åå†é€šè¿‡ SSH éš§é“è¿æ¥åˆ° redis serverã€‚\nä¸‹é¢å¼€å§‹æ’¸ä»£ç ï¼Œå®ç°è¿™ä¸ªå·¥å…·\nSSH éš§é“è½¬å‘ å…ˆæ¥å®ç°æœ€æ ¸å¿ƒçš„åŠŸèƒ½ï¼ŒSSH éš§é“è½¬å‘ã€‚æˆ‘ä»¬éœ€è¦ä½¿ç”¨ Go çš„ golang.org/x/crypto/ssh åŒ…æ¥å®ç° SSH è¿æ¥å’Œç«¯å£è½¬å‘ã€‚\n1package main 2 3import ( 4\t\u0026#34;errors\u0026#34; 5\t\u0026#34;fmt\u0026#34; 6\t\u0026#34;golang.org/x/crypto/ssh\u0026#34; 7\t\u0026#34;os\u0026#34; 8) 9 10type SSHConfig struct { 11\tSSHHost string //SSHæœåŠ¡å™¨åœ°å€ 12\tSSHUser string //SSHç”¨æˆ·å 13\tSSHPassword string //SSHå¯†ç  14\tSSHKey string //ç§˜é’¥æ–‡ä»¶è·¯å¾„ 15} 16 17func GetSSHClient(config *SSHConfig) (*ssh.Client, error) { 18\tif config.SSHHost == \u0026#34;\u0026#34; { 19\treturn nil, errors.New(\u0026#34;SSHHost must be provided\u0026#34;) 20\t} 21\tif config.SSHUser == \u0026#34;\u0026#34; { 22\treturn nil, errors.New(\u0026#34;SSHUser must be provided\u0026#34;) 23\t} 24\tif config.SSHKey == \u0026#34;\u0026#34; \u0026amp;\u0026amp; config.SSHPassword == \u0026#34;\u0026#34; { 25\treturn nil, errors.New(\u0026#34;SSHKey or SSHPassword must be provided\u0026#34;) 26\t} 27 28\tsshConfig := \u0026amp;ssh.ClientConfig{ 29\tUser: config.SSHUser, 30\tHostKeyCallback: ssh.InsecureIgnoreHostKey(), 31\t} 32 33\tif config.SSHPassword != \u0026#34;\u0026#34; { 34\tsshConfig.Auth = []ssh.AuthMethod{ssh.Password(config.SSHPassword)} 35\t} else { 36\tif config.SSHKey != \u0026#34;\u0026#34; { 37\tkeyContent, err := os.ReadFile(config.SSHKey) 38\tif err != nil { 39\treturn nil, fmt.Errorf(\u0026#34;failed to read SSH key file:%s: error:%w\u0026#34;, config.SSHKey, err) 40\t} 41\tsigner, err := ssh.ParsePrivateKey(keyContent) 42\tif err != nil { 43\treturn nil, fmt.Errorf(\u0026#34;failed to parse SSH key: %w\u0026#34;, err) 44\t} 45\tsshConfig.Auth = append(sshConfig.Auth, ssh.PublicKeys(signer)) 46\t} 47\t} 48 49\tsshConfig.HostKeyCallback = ssh.InsecureIgnoreHostKey() 50 51\tclient, err := ssh.Dial(\u0026#34;tcp\u0026#34;, config.SSHHost, sshConfig) 52\tif err != nil { 53\treturn nil, err 54\t} 55\treturn client, nil 56} ä¸Šé¢çš„ä»£ç å®šä¹‰äº†ä¸€ä¸ª SSHConfig ç»“æ„ä½“æ¥å­˜å‚¨ SSH è¿æ¥çš„é…ç½®ä¿¡æ¯ï¼ŒåŒ…æ‹¬ SSH æœåŠ¡å™¨åœ°å€ã€ç”¨æˆ·åã€å¯†ç å’Œç§˜é’¥æ–‡ä»¶è·¯å¾„ã€‚GetSSHClient å‡½æ•°æ ¹æ®è¿™äº›é…ç½®ä¿¡æ¯åˆ›å»ºå¹¶è¿”å›ä¸€ä¸ª SSH å®¢æˆ·ç«¯ã€‚\nsshæœ‰å¤šç§èº«ä»½éªŒè¯æ–¹å¼ï¼ŒåŒ…æ‹¬å¯†ç éªŒè¯å’Œå…¬é’¥éªŒè¯ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œæˆ‘ä»¬æ”¯æŒè¿™ä¸¤ç§æ–¹å¼ã€‚ç”¨æˆ·å¯ä»¥é€šè¿‡è®¾ç½® SSHPassword æˆ– SSHKey å­—æ®µæ¥é€‰æ‹©èº«ä»½éªŒè¯æ–¹å¼ã€‚å¦‚æœåŒæ—¶è®¾ç½®äº†è¿™ä¸¤ä¸ªå­—æ®µï¼Œç¨‹åºå°†ä¼˜å…ˆä½¿ç”¨å¯†ç éªŒè¯ã€‚\nç°åœ¨å·²ç»åˆ›å»ºå¥½äº†ä¸€ä¸ªSSHçš„å®¢æˆ·ç«¯ï¼Œå¯ä»¥ç”¨æ¥è¿›è¡Œåç»­çš„æ“ä½œï¼Œå»ºç«‹ redis è¿æ¥ã€‚\n1type RedisClient struct { 2\tconn net.Conn 3\twriteBuff *bytes.Buffer 4\tread *bufio.Reader 5\toutPut *bytes.Buffer 6} 7 8// GetRedisClient åˆ›å»ºä¸€ä¸ª RedisClient å®ä¾‹ 9// address æ˜¯ Redis æœåŠ¡å™¨çš„åœ°å€, IP:port æ ¼å¼ 10func GetRedisClient(sshClient *ssh.Client, address string) (*RedisClient, error) { 11\tif sshClient == nil { 12\treturn nil, errors.New(\u0026#34;SSH client is nil\u0026#34;) 13\t} 14\tremoteConn, err := sshClient.Dial(\u0026#34;tcp\u0026#34;, address) 15\tif err != nil { 16\treturn nil, fmt.Errorf(\u0026#34;failed to connect to Redis server at %s: %w\u0026#34;, address, err) 17\t} 18\tredisCli := \u0026amp;RedisClient{ 19\tconn: remoteConn, 20\twriteBuff: bytes.NewBuffer(make([]byte, 0, 1024)), 21\tread: bufio.NewReaderSize(remoteConn, 4096), 22\toutPut: bytes.NewBuffer(make([]byte, 0, 4096)), 23\t} 24\treturn redisCli, nil 25} é€šè¿‡SSHå®¢æˆ·ç«¯çš„ Dial æ–¹æ³•ï¼Œå¯ä»¥è¿æ¥åˆ°å†…ç½‘çš„ Redis æœåŠ¡å™¨ã€‚GetRedisClient å‡½æ•°æ¥å—ä¸€ä¸ª SSH å®¢æˆ·ç«¯å’Œ Redis æœåŠ¡å™¨åœ°å€ï¼Œè¿”å›ä¸€ä¸ª RedisClient å®ä¾‹ã€‚RedisClient ç»“æ„ä½“å°è£…äº†ä¸ Redis æœåŠ¡å™¨çš„è¿æ¥ï¼Œå¹¶æä¾›äº†è¯»å†™æ“ä½œçš„ç¼“å†²åŒºã€‚\nåˆ°è¿™ï¼ŒåŸºæœ¬å®ç°äº† SSH éš§é“è½¬å‘çš„åŠŸèƒ½ï¼Œå¯ä»¥è®¿é—®å†…ç½‘çš„redisæœåŠ¡äº†ã€‚ä½†æ˜¯è¿˜ç¼ºå°‘redisåè®®è§£æåŠŸèƒ½ã€‚\nredis åè®®è§£æ redis åè®®ç®€ç§° RESPï¼Œæ˜¯ Redis ä½¿ç”¨çš„é€šä¿¡åè®®ã€‚RESP åè®®ç®€å•é«˜æ•ˆï¼Œæ˜“äºè§£æã€‚ RESPåè®®ç°åœ¨æœ‰ RESP2 å’Œ RESP3 ä¸¤ä¸ªç‰ˆæœ¬ã€‚ç°åœ¨å¸¸ç”¨çš„è¿˜æ˜¯ RESP2ã€‚\nRESP2 åè®®æœ‰äº”ç§æ•°æ®ç±»å‹ï¼š\nç®€å•å­—ç¬¦ä¸²ï¼šä»¥ + å¼€å¤´ï¼Œç›´åˆ° \\r\\n ç»“æŸã€‚ é”™è¯¯ï¼šä»¥ - å¼€å¤´ï¼Œç›´åˆ° \\r\\n ç»“æŸã€‚ æ•´æ•°ï¼šä»¥ : å¼€å¤´ï¼Œç›´åˆ° \\r\\n ç»“æŸã€‚ æ•°ç»„ï¼šä»¥ * å¼€å¤´ï¼Œåæ¥æ•°ç»„é•¿åº¦ï¼Œç›´åˆ° \\r\\n ç»“æŸã€‚æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ª RESP ç±»å‹ã€‚ äºŒè¿›åˆ¶å®‰å…¨å­—ç¬¦ä¸²ï¼šä»¥ $ å¼€å¤´ï¼Œåæ¥å­—ç¬¦ä¸²é•¿åº¦ï¼Œç›´åˆ° \\r\\n ç»“æŸã€‚ ä¸‹é¢å°±è‡ªå·±å®ç°ä¸€ä¸ªç®€å•çš„ RESP åè®®è§£æå™¨ã€‚\n1func (r *RedisClient) Read() error { 2\tb, err := r.read.ReadBytes(\u0026#39;\\n\u0026#39;) 3\tif err != nil { 4\treturn fmt.Errorf(\u0026#34;failed to read from Redis connection: %w\u0026#34;, err) 5\t} 6\tif len(b) \u0026lt;= 2 || b[len(b)-2] != \u0026#39;\\r\u0026#39; || b[len(b)-1] != \u0026#39;\\n\u0026#39; { 7\treturn errors.New(\u0026#34;invalid Redis response format\u0026#34;) 8\t} 9\tbf := b[0] 10\tb = b[1 : len(b)-2] // Remove the trailing \\r\\n 11\tswitch bf { 12\tcase \u0026#39;+\u0026#39;: 13\t// Simple string reply 14\tr.outPut.Write(b) 15\tcase \u0026#39;-\u0026#39;: 16\t// Error reply 17\tr.outPut.WriteString(\u0026#34;(error) ERR \u0026#34;) 18\tr.outPut.Write(b) 19\tcase \u0026#39;:\u0026#39;: 20\t// Integer reply 21\tr.outPut.WriteString(\u0026#34;(integer) \u0026#34;) 22\tr.outPut.Write(b) 23\tcase \u0026#39;$\u0026#39;: 24\tl, err := strconv.Atoi(string(b)) 25\tif err != nil { 26\treturn fmt.Errorf(\u0026#34;failed to parse bulk string length: %w\u0026#34;, err) 27\t} 28\tif l == -1 { 29\tr.outPut.WriteString(\u0026#34;(nil)\u0026#34;) 30\treturn nil 31\t} 32\trl := l + 2 // +2 for \\r\\n 33\tbulkData := make([]byte, rl) 34\trl = 0 35\tfor rl \u0026lt; l { 36\tn, err := r.read.Read(bulkData[rl:]) 37\tif err != nil { 38\treturn fmt.Errorf(\u0026#34;failed to read bulk string data: %w\u0026#34;, err) 39\t} 40\trl += n 41\tif rl \u0026gt;= l { 42\tbreak 43\t} 44\t} 45\tr.outPut.Write(bulkData[:l]) // Write only the bulk string data 46 47\tcase \u0026#39;*\u0026#39;: 48\tl, err := strconv.Atoi(string(b)) 49\tif err != nil { 50\treturn fmt.Errorf(\u0026#34;failed to parse array length: %w\u0026#34;, err) 51\t} 52\tif l == -1 { 53\tr.outPut.WriteString(\u0026#34;(nil)\u0026#34;) 54\treturn nil 55\t} 56\tr.outPut.WriteString(\u0026#34;(array)\\n\u0026#34;) 57\tif l == 0 { 58\tr.outPut.WriteString(\u0026#34;[]\u0026#34;) 59\treturn nil 60\t} 61\tfor i := 0; i \u0026lt; l; i++ { 62\tif err = r.Read(); err != nil { 63\treturn err 64\t} 65\tif i \u0026lt; l-1 { 66\tr.outPut.WriteByte(\u0026#39;\\n\u0026#39;) 67\t} 68\t} 69\tdefault: 70\treturn fmt.Errorf(\u0026#34;unknown Redis response type: %c\u0026#34;, bf) 71\t} 72\treturn nil 73} 74 75//æŠŠç”¨æˆ·è¾“å…¥çš„å‘½ä»¤å†™å…¥ Redis 76func (r *RedisClient) Write(str string) error { 77\tsplit := strings.Split(str, \u0026#34; \u0026#34;) 78\tr.writeBuff.Reset() 79\tfor i, s := range split { 80\tr.writeBuff.WriteString(s) 81\tif i \u0026lt; len(split)-1 { 82\tr.writeBuff.WriteByte(\u0026#39; \u0026#39;) 83\t} 84\t} 85\tr.writeBuff.WriteString(\u0026#34;\\r\\n\u0026#34;) 86 87\t_, err := r.conn.Write(r.writeBuff.Bytes()) 88\treturn err 89} 90 91//è¾“å‡º Redis å“åº”ç»“æœ 92func (r *RedisClient) Print() { 93\tfmt.Printf(\u0026#34;%s\\n\u0026#34;, r.outPut.String()) 94\tr.outPut.Reset() 95} æŠŠredisåè®®çš„è§£æåŠŸèƒ½é›†æˆåˆ° RedisClient ç»“æ„ä½“ä¸­ã€‚Read æ–¹æ³•è¯»å–å¹¶è§£æ Redis æœåŠ¡å™¨çš„å“åº”ï¼ŒWrite æ–¹æ³•å°†ç”¨æˆ·è¾“å…¥çš„å‘½ä»¤å‘é€åˆ° Redis æœåŠ¡å™¨ï¼ŒPrint æ–¹æ³•è¾“å‡ºè§£æåçš„ç»“æœã€‚åœ¨è§£ææ•°æ®æ—¶ï¼ŒæŠŠéœ€è¦å®ç°çš„å†…å®¹åŒæ­¥å†™å…¥åˆ° outPut ä¸­ã€‚\nå‘½ä»¤è¡Œçš„è¾“å…¥æ•°æ®å› ç›®å‰ä¸ä¼šæ¶‰åŠåˆ°å¤æ‚çš„å‘½ä»¤ï¼Œä¸€èˆ¬å°±æ˜¯æŸ¥è¯¢æŒ‡å®škeyçš„å†…å®¹ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥ç”¨ RESP çš„ inline å‘½ä»¤æ ¼å¼ï¼Œæ¯”å¦‚ SET key valueï¼ŒGET keyï¼ŒHGETALL key ç­‰ç­‰ã€‚\næ•´åˆ åŸºæœ¬åŠŸèƒ½æ¨¡å—å®Œæˆåï¼Œå°±å¯ä»¥æŠŠè¿™äº›åŠŸèƒ½ç»„åˆèµ·æ¥ï¼Œç„¶åæµ‹è¯•äº†\n1package main 2 3import ( 4\t\u0026#34;bufio\u0026#34; 5\t\u0026#34;flag\u0026#34; 6\t\u0026#34;fmt\u0026#34; 7\t\u0026#34;io\u0026#34; 8\t\u0026#34;os\u0026#34; 9\t\u0026#34;strings\u0026#34; 10) 11 12var sshHost = flag.String(\u0026#34;sshHost\u0026#34;, \u0026#34;\u0026#34;, \u0026#34;SSH server address\u0026#34;) 13var sshUser = flag.String(\u0026#34;sshUser\u0026#34;, \u0026#34;\u0026#34;, \u0026#34;SSH username\u0026#34;) 14var sshPassword = flag.String(\u0026#34;sshPassword\u0026#34;, \u0026#34;\u0026#34;, \u0026#34;SSH password\u0026#34;) 15var sshKey = flag.String(\u0026#34;sshKey\u0026#34;, \u0026#34;\u0026#34;, \u0026#34;Path to SSH private key file path\u0026#34;) 16 17var redisHost = flag.String(\u0026#34;h\u0026#34;, \u0026#34;127.0.0.1\u0026#34;, \u0026#34;Redis server address\u0026#34;) 18var redisPort = flag.Int(\u0026#34;p\u0026#34;, 6379, \u0026#34;Redis server port\u0026#34;) 19 20func main() { 21\tflag.Parse() 22\tif *redisHost == \u0026#34;\u0026#34; || *redisPort == 0 { 23\tfmt.Println(\u0026#34;Redis server address and port must be provided\u0026#34;) 24\tos.Exit(1) 25\t} 26\tsshConfig := GetSSHConfig() 27 28\tsshClient, err := GetSSHClient(sshConfig) 29\tif err != nil { 30\tfmt.Printf(\u0026#34;Failed to create SSH client: %v\\n\u0026#34;, err) 31\tos.Exit(1) 32\t} 33\tfmt.Printf(\u0026#34;Connecting to SSH server at %s\\r\u0026#34;, *sshHost) 34\tdefer sshClient.Close() 35 36\tredisClient, err := GetRedisClient(sshClient, fmt.Sprintf(\u0026#34;%s:%d\u0026#34;, *redisHost, *redisPort)) 37\tif err != nil { 38\tfmt.Printf(\u0026#34;Failed to connect to Redis server: %v\\n\u0026#34;, err) 39\tos.Exit(1) 40\t} 41\tdefer redisClient.Close() 42 43\tfmt.Printf(\u0026#34;Connected to Redis server at %s:%d via SSH\\r\u0026#34;, *redisHost, *redisPort) 44 45\tfmt.Printf(\u0026#34;input \u0026#39;exit\u0026#39; or \u0026#39;quit\u0026#39; to exiting process!!!\\n\u0026#34;) 46 47\t//ä»æ ‡å‡†è¾“å…¥è¯»å–æ•°æ® 48\treader := bufio.NewReader(os.Stdin) 49\tfor { 50\tline, err := reader.ReadString(\u0026#39;\\n\u0026#39;) 51\tif err != nil { 52\tif err == io.EOF { 53\tfmt.Println(\u0026#34;Exiting...\u0026#34;) 54\tbreak 55\t} 56\t_, _ = fmt.Fprintf(os.Stderr, \u0026#34;è¯»å–é”™è¯¯: %v\\n\u0026#34;, err) 57\t} 58\tline = strings.TrimSpace(line) 59\tif line == \u0026#34;\u0026#34; { 60\tcontinue // Skip empty lines 61\t} 62\tif line == \u0026#34;exit\u0026#34; || line == \u0026#34;quit\u0026#34; { 63\tfmt.Println(\u0026#34;Exiting...\u0026#34;) 64\tbreak 65\t} 66\t//å¤„ç†è¾“å…¥çš„å‘½ä»¤ 67\tif err = redisClient.Write(line); err != nil { 68\t_, _ = fmt.Fprintf(os.Stderr, \u0026#34;å†™å…¥é”™è¯¯: %v\\n\u0026#34;, err) 69\tcontinue 70\t} 71\tredisClient.outPut.Reset() 72\tif err = redisClient.Read(); err != nil { 73\t_, _ = fmt.Fprintf(os.Stderr, \u0026#34;è¯»å–é”™è¯¯: %v\\n\u0026#34;, err) 74\tcontinue 75\t} 76 77\tredisClient.Print() 78\t} 79} 80 81func GetSSHConfig() *SSHConfig { 82\tsshConfig := \u0026amp;SSHConfig{ 83\tSSHHost: *sshHost, 84\tSSHUser: *sshUser, 85\tSSHPassword: *sshPassword, 86\tSSHKey: *sshKey, 87\t} 88\treturn sshConfig 89} é€šè¿‡å‘½ä»¤è¡Œè·å–ç›¸å…³çš„å‚æ•°ï¼Œå¾ªç¯è¯»å–ç”¨æˆ·è¾“å…¥çš„å‘½ä»¤å¹¶å¤„ç†ï¼Œæœ€ç»ˆå°†redisè¿”å›çš„æ•°æ®è¾“å‡ºåˆ°æ ‡å‡†è¾“å‡ºã€‚\nåˆ°è¿™ï¼Œä¸€ä¸ªç®€å•çš„ SSH éš§é“è½¬å‘çš„ redis-cli å·¥å…·å°±å®Œæˆäº†ã€‚\næœ€åé™„ä¸Š go.mod æ–‡ä»¶çš„å†…å®¹ï¼š\n1module tun_redis_cli 2 3go 1.23.1 4 5require ( 6\tgolang.org/x/crypto v0.41.0 // indirect 7\tgolang.org/x/sys v0.35.0 // indirect 8) ","date":"2025-09-07T15:48:48+08:00","image":"https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/a44968f29f6744f2fe0b1d4b640fd6e70776356e.jpg","permalink":"https://lqxhub.github.io/posts/61c8dafe/","title":"ç”¨goå®ç°ä¸€ä¸ªæ”¯æŒSSHéš§é“è½¬å‘ (SSH port forwarding) çš„ redis-cli å·¥å…·"},{"content":"å‰ä¸¤å¤©å†™äº†ä¸€ç¯‡ C++åç¨‹ + io_uring çš„ æ–‡ç«  ï¼Œé‡Œé¢ä»‹ç»äº†å¦‚ä½•åœ¨ C++ ä¸­ç»“åˆä½¿ç”¨åç¨‹å’Œ io_uring æ¥å®ç°å¼‚æ­¥ I/O æ“ä½œã€‚å†™å®Œè‡ªå·±åœ¨å®¡é˜…æ—¶ï¼Œå›æƒ³èµ·æ¥è‡ªå·±åˆšæ¥è§¦ linux ç½‘ç»œç¼–ç¨‹æ—¶èµ°è¿‡çš„ä¸€äº›å¼¯è·¯ï¼Œä¸€äº›é”™è¯¯çš„ç†è§£ã€‚æ‰€æœ‰å°±æƒ³ç€å†™ä¸€ç¯‡ I/O çš„æ–‡ç« æ€»ç»“ä¸€ä¸‹ã€‚ æ‰€ä»¥ä»Šå¤©æˆ‘ä»¬å°±æ¥èŠèŠå¸¸è§çš„IOç±»å‹ï¼ŒåŒæ­¥ I/O ï¼Œå¼‚æ­¥ I/O ï¼Œé˜»å¡ I/O ï¼Œéé˜»å¡ I/O è¿˜æœ‰ IO å¤šè·¯å¤ç”¨ã€‚\nä¸€å¼€å§‹æˆ‘é”™è¯¯çš„è®¤ä¸ºï¼Œéé˜»å¡ I/O å°±æ˜¯å¼‚æ­¥ I/O ï¼Œé˜»å¡ I/O å°±æ˜¯åŒæ­¥ I/O ã€‚åæ¥æ‰å‘ç°ï¼ŒåŸæ¥å¹¶ä¸æ˜¯è¿™æ ·çš„ã€‚IO çš„åˆ†ç±»æœ‰ä¸¤ä¸ªç»´åº¦ï¼Œä¸€ä¸ªæ˜¯æŒ‰è°ƒç”¨æ–¹å¼åˆ†ä¸ºï¼šåŒæ­¥ å’Œ å¼‚æ­¥ï¼›å¦ä¸€ä¸ªæ˜¯æŒ‰ç­‰å¾…æ–¹å¼åˆ†ä¸ºï¼šé˜»å¡ å’Œ éé˜»å¡ã€‚\nç®€å•è¯´ é˜»å¡/éé˜»å¡ æ˜¯æŒ‡ å‡½æ•°è°ƒç”¨æ—¶çš„è¿”å›è¡Œä¸º ï¼Œè€Œ åŒæ­¥/å¼‚æ­¥ æ˜¯æŒ‡ I/Oçš„å®Œæˆé€šçŸ¥ ã€‚ è€Œ I/Oå¤šè·¯å¤ç”¨ åˆ™æ˜¯ä¸€ç§ç‰¹æ®Šçš„æŠ€æœ¯ï¼Œæ˜¯æå‡æ•ˆç‡çš„ä¸€ç§æœºåˆ¶ï¼Œå®ƒå…è®¸å•ä¸ªçº¿ç¨‹åŒæ—¶ç®¡ç†å¤šä¸ª I/O æ“ä½œã€‚é€šè¿‡ä½¿ç”¨ selectã€poll æˆ– epoll ç­‰ç³»ç»Ÿè°ƒç”¨ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥åœ¨å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ä¸Šç­‰å¾…äº‹ä»¶çš„å‘ç”Ÿï¼Œä»è€Œå®ç°é«˜æ•ˆçš„ I/O å¤„ç†ã€‚I/Oå¤šè·¯å¤ç”¨é€šå¸¸ä¸éé˜»å¡ I/O ç»“åˆä½¿ç”¨ï¼Œä»¥æé«˜æ€§èƒ½å’Œå“åº”èƒ½åŠ›ã€‚\næ¨¡å‹ åº”ç”¨è¡Œä¸º ç­‰å¾…ä½ç½® ä¼˜ç¼ºç‚¹ åŒæ­¥ I/O ç­‰å¾…å®Œæˆ åº”ç”¨è‡ªå·±é˜»å¡ ç®€å•ï¼Œä½†æ•ˆç‡ä½ å¼‚æ­¥ I/O å‘èµ·è¯·æ±‚ç«‹åˆ»è¿”å›ï¼Œå®Œæˆåé€šçŸ¥ å†…æ ¸å¼‚æ­¥å®Œæˆ æœ€ç†æƒ³ï¼Œä½†å®ç°å¤æ‚ é˜»å¡ I/O è°ƒç”¨é˜»å¡ç›´åˆ°æ•°æ®å°±ç»ª åº”ç”¨é˜»å¡ ç¼–ç¨‹ç®€å•ï¼Œä½†æµªè´¹ç­‰å¾…æ—¶é—´ éé˜»å¡ I/O æ•°æ®æ²¡å¥½ç«‹å³è¿”å›ï¼Œéœ€è¦è½®è¯¢ åº”ç”¨å±‚è½®è¯¢ é¿å…é˜»å¡ï¼Œä½†æ•ˆç‡å·® I/O å¤šè·¯å¤ç”¨ ç»Ÿä¸€ç­‰å¾…å¤šä¸ª I/O å°±ç»ª å†…æ ¸ç­‰å¾…ï¼Œåº”ç”¨ä¸€æ¬¡é†’æ¥å¤„ç† é«˜æ•ˆï¼Œå¸¸ç”¨äºé«˜å¹¶å‘æœåŠ¡å™¨ ä¸‹é¢ç”¨ C ä¸ºæ¯ç§ I/O ç±»å‹å†™ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œæ¥å¸®åŠ©ç†è§£ã€‚\nåœ¨linuxä¸­ï¼Œä¸€åˆ‡éƒ½æ˜¯æ–‡ä»¶ï¼ŒåŒ…æ‹¬ç½‘ç»œè¿æ¥å’Œè®¾å¤‡ã€‚é€šè¿‡æ–‡ä»¶æè¿°ç¬¦ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥ä»¥ç»Ÿä¸€çš„æ–¹å¼è¿›è¡ŒI/Oæ“ä½œï¼Œæ‰€ä»¥æœ‰äº›ä¾‹å­ä¸­ï¼Œä½¿ç”¨ openã€read å’Œ close ç­‰ç³»ç»Ÿè°ƒç”¨æ¥è¿›è¡Œæ–‡ä»¶çš„è¯»å–æ“ä½œã€‚å¯¹äºç½‘ç»œ I/Oï¼Œåº”ç”¨ç¨‹åºå¯ä»¥ä½¿ç”¨ç›¸åŒçš„æ¥å£æ¥è¿›è¡Œæ•°æ®çš„å‘é€å’Œæ¥æ”¶ã€‚\né˜»å¡I/O 1#include \u0026lt;stdio.h\u0026gt; 2#include \u0026lt;stdlib.h\u0026gt; 3#include \u0026lt;unistd.h\u0026gt; 4#include \u0026lt;fcntl.h\u0026gt; 5 6int main() { 7 char buffer[1024]; 8 int fd = open(\u0026#34;file.txt\u0026#34;, O_RDONLY); 9 if (fd == -1) { 10 perror(\u0026#34;open\u0026#34;); 11 return 1; 12 } 13 ssize_t bytesRead = read(fd, buffer, sizeof(buffer)); 14 if (bytesRead == -1) { 15 perror(\u0026#34;read\u0026#34;); 16 close(fd); 17 return 1; 18 } 19 printf(\u0026#34;Read %zd bytes: %.*s\\n\u0026#34;, bytesRead, (int)bytesRead, buffer); 20 close(fd); 21 return 0; 22} read å‡½æ•° æ“ä½œé»˜è®¤çš„ æ–‡ä»¶æè¿°ç¬¦ (fd) æ˜¯é˜»å¡çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœæ²¡æœ‰æ•°æ®å¯è¯»ï¼Œå®ƒä¼šä¸€ç›´ç­‰å¾…ï¼Œç›´åˆ°æœ‰æ•°æ®å¯è¯»ä¸ºæ­¢ã€‚è¿™ç§æ–¹å¼åœ¨æŸäº›æƒ…å†µä¸‹æ˜¯åˆé€‚çš„ï¼Œä½†åœ¨é«˜å¹¶å‘çš„ç½‘ç»œåº”ç”¨ä¸­ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ€§èƒ½ç“¶é¢ˆã€‚ ä¼˜åŠ¿å°±æ˜¯è¿™ç§é˜»å¡æ–¹å¼ç¼–ç¨‹ç®€å•ï¼Œå®¹æ˜“ç†è§£ã€‚\néé˜»å¡I/O 1#include \u0026lt;stdio.h\u0026gt; 2#include \u0026lt;unistd.h\u0026gt; 3#include \u0026lt;fcntl.h\u0026gt; 4#include \u0026lt;errno.h\u0026gt; 5#include \u0026lt;string.h\u0026gt; 6 7int main() { 8 char buf[100]; 9 int flags = fcntl(STDIN_FILENO, F_GETFL, 0); 10 fcntl(STDIN_FILENO, F_SETFL, flags | O_NONBLOCK); // è®¾ç½®éé˜»å¡ 11 12 printf(\u0026#34;éé˜»å¡è¾“å…¥ï¼ˆæ²¡æœ‰è¾“å…¥æ—¶ç«‹å³è¿”å›ï¼‰ï¼š\\n\u0026#34;); 13 while (1) { 14 ssize_t n = read(STDIN_FILENO, buf, sizeof(buf)-1); 15 if (n \u0026gt; 0) { 16 buf[n] = \u0026#39;\\0\u0026#39;; 17 printf(\u0026#34;ä½ è¾“å…¥äº†ï¼š%s\\n\u0026#34;, buf); 18 break; 19 } else if (n \u0026lt; 0 \u0026amp;\u0026amp; errno == EAGAIN) { 20 printf(\u0026#34;æš‚æ—¶æ²¡æœ‰è¾“å…¥ï¼Œå¹²ç‚¹åˆ«çš„äº‹...\\n\u0026#34;); 21 sleep(1); 22 } else { 23 break; 24 } 25 } 26 return 0; 27} è¿™æ¬¡ä½¿ç”¨ æ ‡å‡†è¾“å…¥ï¼ˆSTDIN_FILENOï¼‰è¿›è¡Œéé˜»å¡è¯»å–ã€‚\nä½¿ç”¨ fcntl å‡½æ•°è®¾ç½®æ–‡ä»¶æè¿°ç¬¦çš„æ ‡å¿—ä½ä¸ºéé˜»å¡ã€‚ åç»­ä½¿ç”¨ read å‡½æ•°æ“ä½œ è¿™ä¸ªæ–‡ä»¶æè¿°ç¬¦æ—¶ï¼Œå°±ä¼šå˜æˆ éé˜»å¡I/O äº†ã€‚ åœ¨æ²¡æœ‰æ•°æ®å¯è¯»æ—¶ä¼šç«‹å³è¿”å›ï¼Œè€Œä¸æ˜¯é˜»å¡ç­‰å¾…ã€‚ä½¿ç”¨éé˜»å¡I/O ç¼–ç¨‹æ—¶ï¼Œéœ€è¦åˆ¤æ–­ errno çš„å€¼æ¥åˆ¤æ–­å½“å‰ fd çš„çŠ¶æ€ã€‚\nå¸¸è§çš„é”™è¯¯ç æœ‰ï¼š\nEAGAINï¼šè¡¨ç¤ºå½“å‰æ²¡æœ‰æ•°æ®å¯è¯»ï¼Œéé˜»å¡I/Oæ¨¡å¼ä¸‹ä¼šç«‹å³è¿”å›ã€‚ EINTRï¼šè¡¨ç¤ºç³»ç»Ÿè°ƒç”¨è¢«ä¿¡å·ä¸­æ–­ï¼Œå¯èƒ½éœ€è¦é‡è¯•ã€‚ EINVALï¼šè¡¨ç¤ºæ— æ•ˆçš„æ–‡ä»¶æè¿°ç¬¦æˆ–å‚æ•°ã€‚ ENETDOWNï¼šè¡¨ç¤ºç½‘ç»œå…³é—­ã€‚ EIOï¼šè¡¨ç¤º I/O é”™è¯¯ã€‚ ETIMEDOUTï¼šè¡¨ç¤ºæ“ä½œè¶…æ—¶ã€‚ åœ¨ç½‘ç»œç¼–ç¨‹ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ accept4 å‡½æ•°æ¥åˆ›å»ºéé˜»å¡çš„ socketã€‚\nå‡½æ•°å®šä¹‰\n1int accept4(int sockfd, struct sockaddr *addr,socklen_t *addrlen, int flags); sockfdï¼šç›‘å¬socket fdï¼ˆå¿…é¡»æ˜¯ listen çŠ¶æ€ï¼‰ã€‚ addrï¼šè¿”å›å¯¹ç«¯åœ°å€ï¼ˆå®¢æˆ·ç«¯ IP + ç«¯å£ï¼‰ã€‚å¦‚æœä¸å…³å¿ƒï¼Œå¯ä»¥ä¼  NULLã€‚ addrlenï¼šè¾“å…¥è¾“å‡ºå‚æ•°ï¼Œä¼ å…¥æ—¶ä¸º addr çš„å¤§å°ï¼Œè¿”å›æ—¶è¡¨ç¤ºå®é™…é•¿åº¦ã€‚ flagsï¼šé¢å¤–é€‰é¡¹ï¼Œå¯ä»¥æ˜¯ä»¥ä¸‹çš„ æŒ‰ä½æˆ–ï¼š SOCK_NONBLOCK è®¾ç½®æ–° socket ä¸ºéé˜»å¡æ¨¡å¼ã€‚ SOCK_CLOEXEC è®¾ç½® FD_CLOEXECï¼ˆæ‰§è¡Œ exec æ—¶è‡ªåŠ¨å…³é—­ fdï¼‰ã€‚ è°ƒç”¨æ–¹å¼\n1struct sockaddr_in cliaddr; 2socklen_t clilen = sizeof(cliaddr); 3int fd = accept4(listenfd,(struct sockaddr*)\u0026amp;cliaddr,\u0026amp;clilen, SOCK_NONBLOCK | SOCK_CLOEXEC); ä½¿ç”¨éé˜»å¡I/O å¯ä»¥é¿å…åº”ç”¨ç¨‹åºåœ¨ç­‰å¾… I/O æ“ä½œå®Œæˆæ—¶è¢«é˜»å¡ï¼Œä»è€Œæé«˜æ•´ä½“çš„å“åº”èƒ½åŠ›å’Œå¹¶å‘å¤„ç†èƒ½åŠ›ã€‚\nä¸€èˆ¬æ¥è¯´ï¼Œéé˜»å¡I/O é€‚ç”¨äºå¯¹å“åº”æ—¶é—´è¦æ±‚è¾ƒé«˜çš„åœºæ™¯ï¼Œæ¯”å¦‚ç½‘ç»œæœåŠ¡ã€å®æ—¶æ•°æ®å¤„ç†ç­‰ã€‚è€Œé˜»å¡I/O åˆ™æ›´é€‚åˆå¯¹æ€§èƒ½è¦æ±‚ä¸é«˜çš„åœºæ™¯ï¼Œæ¯”å¦‚ç®€å•çš„æ–‡ä»¶è¯»å–ç­‰ã€‚\néé˜»å¡I/O éœ€è¦æ­é… å¤šè·¯å¤ç”¨æŠ€æœ¯ä¸€èµ·ä½¿ç”¨ï¼Œæ‰èƒ½å‘æŒ¥å‡ºæ›´å¥½çš„æ€§èƒ½ã€‚é€šè¿‡ä½¿ç”¨ selectã€poll æˆ– epoll ç­‰ç³»ç»Ÿè°ƒç”¨ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥åœ¨å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ä¸Šç­‰å¾…äº‹ä»¶çš„å‘ç”Ÿï¼Œä»è€Œå®ç°é«˜æ•ˆçš„ I/O å¤„ç†ï¼Œå…³äºå¤šè·¯å¤ç”¨ï¼Œåé¢ä¼šä»‹ç»\nåŒæ­¥ I/O åœ¨ POSIX è¯­ä¹‰é‡Œï¼Œé˜»å¡ I/O æœ¬è´¨å°±æ˜¯åŒæ­¥ I/Oã€‚è¿˜æœ‰ä¸Šé¢æåˆ°çš„éé˜»å¡ I/Oï¼Œè™½ç„¶å®ƒçš„è¿”å›è¡Œä¸ºæ˜¯éé˜»å¡çš„ï¼Œä½†åœ¨æ•°æ®å‡†å¤‡å¥½ä¹‹å‰ï¼Œåº”ç”¨ç¨‹åºä»ç„¶éœ€è¦ä¸»åŠ¨å»æŸ¥è¯¢çŠ¶æ€ï¼Œè¿™ç§è¡Œä¸ºåœ¨æŸç§ç¨‹åº¦ä¸Šä¹Ÿå¯ä»¥è§†ä¸ºä¸€ç§åŒæ­¥ã€‚\næ‰€ä»¥å°±ä¸å†é‡å¤è¿™äº›å†…å®¹äº†ã€‚\nå¼‚æ­¥ I/O æ‰€è°“çš„ å¼‚æ­¥ I/O ï¼Œæ˜¯æŒ‡åº”ç”¨ç¨‹åºå‘èµ· I/O è¯·æ±‚åï¼Œä¸éœ€è¦ç­‰å¾…æ“ä½œå®Œæˆï¼Œè€Œæ˜¯å¯ä»¥ç»§ç»­æ‰§è¡Œå…¶ä»–ä»»åŠ¡ã€‚å½“ I/O æ“ä½œå®Œæˆåï¼Œå†…æ ¸ä¼šé€šè¿‡æŸç§æœºåˆ¶ï¼ˆå¦‚ä¿¡å·ã€å›è°ƒå‡½æ•°æˆ–äº‹ä»¶é€šçŸ¥ï¼‰æ¥é€šçŸ¥åº”ç”¨ç¨‹åºã€‚\nåœ¨ Linux 5.1 ç‰ˆæœ¬ä¸­ï¼Œå¼•å…¥äº†æ–°çš„å¼‚æ­¥ I/O æ¥å£ï¼ˆio_uringï¼‰ï¼Œå®ƒæä¾›äº†ä¸€ç§æ›´é«˜æ•ˆçš„æ–¹å¼æ¥è¿›è¡Œå¼‚æ­¥ I/O æ“ä½œã€‚é€šè¿‡ io_uringï¼Œåº”ç”¨ç¨‹åºå¯ä»¥å°† I/O è¯·æ±‚æäº¤åˆ°å†…æ ¸ï¼Œå¹¶åœ¨è¯·æ±‚å®Œæˆæ—¶è·å¾—é€šçŸ¥ï¼Œä»è€Œå®ç°çœŸæ­£çš„å¼‚æ­¥ I/Oã€‚\nä¸¾ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œæˆ‘å»éº¦å½“åŠ³ç‚¹é¤ã€‚\nåŒæ­¥ I/Oï¼š æˆ‘èµ°åˆ°æŸœå°å‰ï¼Œå‘Šè¯‰æœåŠ¡å‘˜æˆ‘è¦ç‚¹ä»€ä¹ˆï¼Œç„¶åç«™åœ¨é‚£é‡Œç­‰ç€ï¼Œç›´åˆ°å°å§å§æŠŠæˆ‘çš„é¤ç»™æˆ‘ä¸ºæ­¢ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­æˆ‘åªèƒ½åœ¨æŸœå°å‰ç­‰å¾…ï¼Œæˆ‘ä¸èƒ½åšå…¶ä»–äº‹æƒ…ï¼Œåªèƒ½ç­‰å¾…ã€‚\nå¼‚æ­¥ I/Oï¼š æˆ‘èµ°åˆ°æŸœå°å‰ï¼Œå‘Šè¯‰æœåŠ¡å‘˜æˆ‘è¦ç‚¹ä»€ä¹ˆï¼Œç„¶åå°±å»æ‰¾åœ°æ–¹åç€ç©æ‰‹æœºäº†ï¼Œç”šè‡³å¯ä»¥å»ä¸Šä¸ªå•æ‰€ã€‚å½“é¤ç‚¹å‡†å¤‡å¥½åï¼Œå°å§å§ä¼šé€šè¿‡æŸç§æ–¹å¼é€šçŸ¥æˆ‘å–é¤ï¼Œæ¯”å¦‚å–Šä¸€å£°XXXå·é¤å¥½äº†ã€‚\nå›åˆ°ç¨‹åºä¸­ï¼ŒåŒæ­¥ I/O åº”ç”¨ç¨‹åºå‘èµ· I/O è¯·æ±‚åï¼Œå¿…é¡»ç­‰å¾…å†…æ ¸å®Œæˆæ“ä½œæ‰èƒ½ç»§ç»­æ‰§è¡Œåç»­ä»£ç ã€‚è€Œå¼‚æ­¥ I/O åˆ™å…è®¸åº”ç”¨ç¨‹åºåœ¨å‘èµ·è¯·æ±‚åç«‹å³è¿”å›ï¼Œç»§ç»­æ‰§è¡Œå…¶ä»–ä»»åŠ¡ï¼Œå†…æ ¸ä¼šåœ¨æ“ä½œå®Œæˆåé€šè¿‡å›è°ƒæˆ–ä¿¡å·çš„æ–¹å¼é€šçŸ¥åº”ç”¨ç¨‹åºã€‚\nå¼‚æ­¥ I/O çš„ä»£ç æ¯”è¾ƒå¤šï¼Œå°±ä¸åœ¨è¿™é‡Œå±•ç¤ºäº†ï¼Œå¯ä»¥å» io_uring å’Œ C++åç¨‹+io_uring æŸ¥çœ‹ç›¸å…³å†…å®¹ã€‚\nå¤šè·¯å¤ç”¨ ä¹ä¸€å¬è¿™ä¸ªåå­—è¿˜æŒºé«˜å¤§ä¸Šçš„ï¼Œå…¶å®å®ƒçš„æ ¸å¿ƒæ€æƒ³å°±æ˜¯è®©ä¸€ä¸ªçº¿ç¨‹åŒæ—¶ç®¡ç†å¤šä¸ª I/O æ“ä½œï¼Œä»è€Œæé«˜æ•ˆç‡ã€‚æœ€æ—©çš„ç½‘ç»œç¼–ç¨‹ä¸­ï¼Œé€šå¸¸æ˜¯ä¸ºæ¯ä¸ªè¿æ¥åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œè¿™æ ·è™½ç„¶ç®€å•ï¼Œä½†åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ä¼šå¯¼è‡´çº¿ç¨‹æ•°é‡æ¿€å¢ï¼Œç³»ç»Ÿèµ„æºè€—å°½ã€‚æ‰€æœ‰æœ‰äº† C10K è¿æ¥çš„é—®é¢˜ã€‚\nå¾ˆå¤šç¨‹åºå°±æ˜¯ä½¿ç”¨è¿™ç§æ¯ä¸ªçº¿ç¨‹å¤„ç†ä¸€ä¸ªè¿æ¥çš„æ–¹å¼ï¼Œåƒæ˜¯ Apache HTTP Serverï¼ŒMySQL ç¤¾åŒºç‰ˆï¼ˆå¬è¯´ä»˜è´¹ç‰ˆä½¿ç”¨äº†å¤šè·¯å¤ç”¨ï¼‰ç­‰ã€‚\nä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå‡ºç°äº† I/O å¤šè·¯å¤ç”¨æŠ€æœ¯ã€‚å®ƒå…è®¸ä¸€ä¸ªçº¿ç¨‹åŒæ—¶ç›‘è§†å¤šä¸ª I/O æµï¼Œå¹¶åœ¨å…¶ä¸­ä»»ä½•ä¸€ä¸ªæµå‡†å¤‡å¥½æ—¶è¿›è¡Œå¤„ç†ã€‚å¸¸è§çš„ I/O å¤šè·¯å¤ç”¨æœºåˆ¶æœ‰ selectã€pollã€ epoll å’Œ kqueueã€‚\nselect select æ˜¯ æœ€å¸¸è§çš„ä¸€ç§ å¤šè·¯å¤ç”¨æŠ€æœ¯ï¼Œå‡ ä¹æ‰€æœ‰çš„æ“ä½œç³»ç»Ÿéƒ½æ”¯æŒã€‚\n1#include \u0026lt;stdio.h\u0026gt; 2#include \u0026lt;unistd.h\u0026gt; 3#include \u0026lt;sys/select.h\u0026gt; 4#include \u0026lt;string.h\u0026gt; 5 6int main() { 7 char buf[100]; 8 fd_set rfds; 9 10 printf(\u0026#34;å¤šè·¯å¤ç”¨ç­‰å¾…è¾“å…¥ (5ç§’è¶…æ—¶)ï¼š\\n\u0026#34;); 11 FD_ZERO(\u0026amp;rfds); 12 FD_SET(STDIN_FILENO, \u0026amp;rfds); 13 14 struct timeval tv = {5, 0}; // 5ç§’è¶…æ—¶ 15 int ret = select(STDIN_FILENO+1, \u0026amp;rfds, NULL, NULL, \u0026amp;tv); 16 if (ret \u0026gt; 0 \u0026amp;\u0026amp; FD_ISSET(STDIN_FILENO, \u0026amp;rfds)) { 17 ssize_t n = read(STDIN_FILENO, buf, sizeof(buf)-1); 18 buf[n] = \u0026#39;\\0\u0026#39;; 19 printf(\u0026#34;ä½ è¾“å…¥äº†ï¼š%s\\n\u0026#34;, buf); 20 } else if (ret == 0) { 21 printf(\u0026#34;5ç§’å†…æ²¡æœ‰è¾“å…¥ï¼Œè¶…æ—¶ï¼\\n\u0026#34;); 22 } else { 23 perror(\u0026#34;select å‡ºé”™\u0026#34;); 24 } 25 return 0; 26} select ä¹Ÿæœ‰ä¸è¶³ä¹‹å¤„ï¼Œæ¯”å¦‚ï¼š\næ€§èƒ½é—®é¢˜ï¼šselect åœ¨æ¯æ¬¡è°ƒç”¨æ—¶éƒ½éœ€è¦æŠŠè¢«ç›‘æ§çš„fdsé›†åˆä»ç”¨æˆ·æ€ç©ºé—´æ‹·è´åˆ°å†…æ ¸æ€ç©ºé—´ï¼Œè¿™åœ¨æ–‡ä»¶æè¿°ç¬¦æ•°é‡è¾ƒå¤šæ—¶ä¼šå¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚ æ–‡ä»¶æè¿°ç¬¦æ•°é‡é™åˆ¶ï¼šselect å¯¹æ–‡ä»¶æè¿°ç¬¦çš„æ•°é‡æœ‰é™åˆ¶ï¼ˆé€šå¸¸æ˜¯ 1024ï¼‰ï¼Œè¿™åœ¨å¤§é‡è¿æ¥çš„åœºæ™¯ä¸‹å¯èƒ½æˆä¸ºç“¶é¢ˆã€‚ è¿”å›çš„æ–‡ä»¶æè¿°ç¬¦é›†åˆéœ€è¦éå†ï¼šselect è¿”å›åï¼Œåº”ç”¨ç¨‹åºéœ€è¦éå†æ•´ä¸ªæ–‡ä»¶æè¿°ç¬¦é›†åˆæ¥æ£€æŸ¥å“ªäº›æ–‡ä»¶æè¿°ç¬¦å‡†å¤‡å¥½äº†ï¼Œè¿™åœ¨æ–‡ä»¶æè¿°ç¬¦æ•°é‡è¾ƒå¤šæ—¶æ•ˆç‡è¾ƒä½ã€‚ poll åæ¥ä¸ºäº†è§£å†³ select çš„ä¸€äº›ä¸è¶³ä¹‹å¤„ï¼Œå‡ºç°äº† pollã€‚poll çš„ä½¿ç”¨æ–¹å¼ä¸ select ç±»ä¼¼ï¼Œä½†å®ƒä¸å†ä½¿ç”¨å›ºå®šå¤§å°çš„æ–‡ä»¶æè¿°ç¬¦é›†åˆï¼Œè€Œæ˜¯ä½¿ç”¨ä¸€ä¸ªæ•°ç»„æ¥è¡¨ç¤ºæ‰€æœ‰å¾…ç›‘è§†çš„æ–‡ä»¶æè¿°ç¬¦ã€‚è¿™ä½¿å¾— poll å¯ä»¥æ”¯æŒæ›´å¤šçš„æ–‡ä»¶æè¿°ç¬¦ã€‚ä½†æ˜¯ï¼Œpoll ä»ç„¶éœ€è¦åœ¨æ¯æ¬¡è°ƒç”¨æ—¶éå†æ•´ä¸ªæ•°ç»„ï¼Œæ€§èƒ½ä¸Šä»ç„¶ä¸å¤Ÿç†æƒ³ã€‚\nepoll epoll æ˜¯ Linux 2.6 å¼€å§‹æ”¯æŒçš„ä¸€ç§å¤šè·¯å¤ç”¨æŠ€æœ¯ï¼Œå®ƒå…‹æœäº† select å’Œ poll çš„ä¸€äº›ç¼ºç‚¹ã€‚epoll ä½¿ç”¨äº‹ä»¶é€šçŸ¥æœºåˆ¶ï¼Œå¯ä»¥åœ¨æ–‡ä»¶æè¿°ç¬¦çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ç«‹å³é€šçŸ¥åº”ç”¨ç¨‹åºï¼Œè€Œä¸éœ€è¦è½®è¯¢ã€‚è¿™ä½¿å¾— epoll åœ¨å¤„ç†å¤§é‡å¹¶å‘è¿æ¥æ—¶å…·æœ‰æ›´å¥½çš„æ€§èƒ½ã€‚\nç¼ºç‚¹å°±æ˜¯å¸¦æ¥äº†æ›´é«˜çš„å¤æ‚æ€§ï¼Œä½¿ç”¨èµ·æ¥ç›¸å¯¹è¾ƒä¸ºå¤æ‚ã€‚\nepoll server å’Œ epoll æƒŠç¾¤é—®é¢˜ è¿™ä¸¤ç¯‡æ–‡ç« è¯¦ç»†ä»‹ç»äº† epoll çš„ä½¿ç”¨å’Œæ³¨æ„äº‹é¡¹ã€‚\nkqueue kqueue æ˜¯ BSD ç³»ç»Ÿç‰¹æœ‰çš„ä¸€ç§å¤šè·¯å¤ç”¨æŠ€æœ¯ï¼Œå®ƒä¸ epoll ç±»ä¼¼ï¼Œä½¿ç”¨äº‹ä»¶é€šçŸ¥æœºåˆ¶æ¥æé«˜æ€§èƒ½ã€‚kqueue å¯ä»¥ç›‘è§†æ–‡ä»¶æè¿°ç¬¦ã€ä¿¡å·ã€å®šæ—¶å™¨ç­‰å¤šç§äº‹ä»¶ï¼Œå¹¶åœ¨äº‹ä»¶å‘ç”Ÿæ—¶é€šçŸ¥åº”ç”¨ç¨‹åºã€‚\nkqueue æ˜¯ BSD ç³»ç»Ÿç‰¹æœ‰çš„æŠ€æœ¯ï¼Œæ— æ³•åœ¨ Linux ä¸Šä½¿ç”¨ã€‚æˆ‘å¹³æ—¶ä¸»è¦åœ¨ Linux ä¸Šè¿›è¡Œå¼€å‘ï¼Œæ‰€ä»¥å°±ä¸åœ¨è¿™é‡Œè´´ä»£ç äº†ã€‚æƒ³è¦äº†è§£å¯ä»¥å»çœ‹ redis çš„æºç ï¼Œé‡Œé¢æœ‰ä½¿ç”¨ kqueue çš„ä¾‹å­ã€‚\nredis kqueue æºç \næˆ‘ä¹‹å‰ä¸º kiwi æ•°æ®åº“å†™è¿‡ä¸€å¥—è·¨å¹³å°çš„ç½‘ç»œåº“ï¼Œé‡Œé¢ä¹Ÿæœ‰ kqueue çš„å®ç°ã€‚ kqueue\nä¸åŒå¤šè·¯å¤ç”¨åŒºåˆ« ç‰¹æ€§ select poll epoll kqueue fd ä¸Šé™ 1024 (FD_SETSIZE) æ— å›ºå®šä¸Šé™ æ— å›ºå®šä¸Šé™ æ— å›ºå®šä¸Šé™ fd é›†åˆç®¡ç† ä½å›¾ï¼Œæ¯æ¬¡é‡ç½® æ•°ç»„ï¼Œæ¯æ¬¡é‡ç½® å†…æ ¸ç»´æŠ¤çº¢é»‘æ ‘ å†…æ ¸ç»´æŠ¤ è¿”å›ç»“æœ éå†æ‰€æœ‰ fd éå†æ‰€æœ‰ fd ç›´æ¥è¿”å›æ´»è·ƒ fd ç›´æ¥è¿”å›æ´»è·ƒ fd æ—¶é—´å¤æ‚åº¦ O(n) O(n) O(æ´»è·ƒ fd) O(æ´»è·ƒ fd) è§¦å‘æ–¹å¼ æ°´å¹³è§¦å‘ æ°´å¹³è§¦å‘ æ°´å¹³ + è¾¹ç¼˜è§¦å‘ æ°´å¹³ + è¾¹ç¼˜è§¦å‘ epollï¼Œkqueue æ¯” selectï¼Œpoll æ›´åŠ é«˜æ•ˆçš„åŸå› ã€‚\näº‹ä»¶é©±åŠ¨æœºåˆ¶ï¼šepoll å’Œ kqueue éƒ½æ˜¯åŸºäºäº‹ä»¶é©±åŠ¨çš„æ¨¡å‹ï¼Œå†…æ ¸ä¼šåœ¨äº‹ä»¶å‘ç”Ÿæ—¶é€šçŸ¥åº”ç”¨ç¨‹åºï¼Œè€Œä¸”åªå…³æ³¨é‚£äº›å·²ç»å°±ç»ªçš„fdå³å¯ï¼Œè€Œä¸æ˜¯åƒ select å’Œ poll æ¯æ¬¡éƒ½éœ€è¦éå†æ‰€æœ‰ fd é¿å…é¢‘ç¹çš„æ•°æ®æ‹·è´ï¼šæ¯æ¬¡è°ƒç”¨ select æˆ– poll æ—¶ï¼Œéƒ½éœ€è¦å°†æ•´ä¸ª fd é›†åˆä»ç”¨æˆ·æ€å¤åˆ¶åˆ°å†…æ ¸æ€ï¼Œè°ƒç”¨ç»“æŸåå†å°†ç»“æœä»å†…æ ¸æ€å¤åˆ¶å›ç”¨æˆ·æ€ã€‚è¿™ç§é¢‘ç¹çš„æ•°æ®æ‹·è´åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ä¼šå¸¦æ¥è¾ƒå¤§çš„æ€§èƒ½å¼€é”€ã€‚epoll å’Œ kqueue ä½¿ç”¨äº†å†…å­˜æ˜ å°„ï¼Œå†…æ ¸æ€å’Œç”¨æˆ·æ€å¯ä»¥è®¿é—®åŒä¸€å—ç‰©ç†å†…å­˜ï¼Œé¿å…äº†è¿™ç§é¢‘ç¹çš„æ•°æ®æ‹·è´ï¼Œæå‡äº†æ€§èƒ½ã€‚ æ”¯æŒå¤§è§„æ¨¡å¹¶å‘ï¼šepoll å’Œ kqueue éƒ½å¯ä»¥æ”¯æŒå¤§é‡çš„å¹¶å‘è¿æ¥ï¼Œè€Œ select å’Œ poll åœ¨æ–‡ä»¶æè¿°ç¬¦æ•°é‡è¾ƒå¤šæ—¶ä¼šå‡ºç°æ€§èƒ½ç“¶é¢ˆã€‚ æ›´çµæ´»çš„è§¦å‘æ–¹å¼ï¼šepoll å’Œ kqueue æ”¯æŒæ°´å¹³è§¦å‘å’Œè¾¹ç¼˜è§¦å‘ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥æ ¹æ®éœ€è¦é€‰æ‹©åˆé€‚çš„è§¦å‘æ–¹å¼ï¼Œä»è€Œæé«˜æ€§èƒ½ã€‚ å†æ¥èŠä¸€ä¸‹ æ°´å¹³è§¦å‘ï¼ˆLTï¼‰ å’Œ è¾¹ç¼˜è§¦å‘ï¼ˆETï¼‰ çš„åŒºåˆ«ã€‚\næ°´å¹³è§¦å‘ï¼ˆLTï¼‰ï¼šå½“æ–‡ä»¶æè¿°ç¬¦çš„çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå†…æ ¸ä¼šé€šçŸ¥åº”ç”¨ç¨‹åºã€‚åº”ç”¨ç¨‹åºéœ€è¦åœ¨æ¯æ¬¡è°ƒç”¨æ—¶æ£€æŸ¥æ–‡ä»¶æè¿°ç¬¦çš„çŠ¶æ€ï¼Œå¦‚æœçŠ¶æ€ä»ç„¶å°±ç»ªï¼Œåˆ™ä¼šé‡å¤æ¥æ”¶é€šçŸ¥ã€‚è¿™ç§æ–¹å¼ç®€å•æ˜“ç”¨ï¼Œä½†åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹å¯èƒ½å¯¼è‡´å¤§é‡é‡å¤é€šçŸ¥ï¼Œæµªè´¹ CPU èµ„æºã€‚\nè¾¹ç¼˜è§¦å‘ï¼ˆETï¼‰ï¼šåªæœ‰å½“æ–‡ä»¶æè¿°ç¬¦çš„çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå†…æ ¸æ‰ä¼šé€šçŸ¥åº”ç”¨ç¨‹åºã€‚åº”ç”¨ç¨‹åºåœ¨æ¥æ”¶åˆ°é€šçŸ¥åï¼Œéœ€è¦ç«‹å³è¯»å–æ‰€æœ‰å¯ç”¨æ•°æ®ï¼Œç›´åˆ°è¿”å› EAGAIN é”™è¯¯ã€‚è¿™ç§æ–¹å¼å¯ä»¥å‡å°‘é‡å¤é€šçŸ¥ï¼Œæé«˜æ€§èƒ½ï¼Œä½†å®ç°èµ·æ¥ç›¸å¯¹å¤æ‚ã€‚\næ€»ç»“ ä»¥ä¸Šå°±æ˜¯å¯¹é˜»å¡ I/Oã€éé˜»å¡ I/Oã€åŒæ­¥ I/Oã€å¼‚æ­¥ I/O å’Œå¤šè·¯å¤ç”¨ç­‰æ¦‚å¿µçš„ä»‹ç»ã€‚é€šè¿‡å¯¹æ¯”ä¸åŒ I/O æ¨¡å‹çš„ä¼˜ç¼ºç‚¹å’Œé€‚ç”¨åœºæ™¯ï¼Œå¯ä»¥åœ¨å®é™…å¼€å‘ä¸­é€‰æ‹©åˆé€‚çš„ I/O æ¨¡å‹ï¼Œä»¥æé«˜åº”ç”¨ç¨‹åºçš„æ€§èƒ½å’Œå“åº”èƒ½åŠ›ã€‚\næ²¡æœ‰ä¸‡èƒ½çš„è§£å†³æ–¹æ¡ˆï¼Œåªæœ‰æœ€åˆé€‚çš„é€‰æ‹©ï¼Œç›®å‰æˆ‘äº†è§£åˆ°çš„ï¼Œå®Œå…¨ç”¨å¼‚æ­¥ I/O çš„æœåŠ¡ç«¯è¿˜æ˜¯æ¯”è¾ƒå°‘ï¼Œæ¯”è¾ƒå¸¸ç”¨çš„è¿˜æ˜¯ éé˜»å¡ I/O+å¤šè·¯å¤ç”¨æŠ€æœ¯ã€‚\nä»¥ä¸Šéƒ½æ˜¯ç”¨ C/C++ ç¼–ç¨‹æ—¶ï¼Œè‡ªå·±æ‰‹å†™çš„I/Oæ“ä½œç¤ºä¾‹ã€‚å› ä¸º C++ STL æ²¡æœ‰æä¾›ç½‘ç»œåº“ï¼ŒIOåº“ï¼Œæ‰€ä»¥éœ€è¦æ‰‹åŠ¨å®ç°è¿™äº›åŠŸèƒ½ã€‚\nå¦‚æœæ˜¯ä½¿ç”¨ golang è¿™äº›æ–°çš„è¯­è¨€ï¼Œå¾ˆå¤šI/Oæ“ä½œéƒ½è¢«å°è£…å¥½äº†ï¼Œç›´æ¥è°ƒç”¨å°±è¡Œäº†ã€‚æ ¹æœ¬ä¸ç”¨å…³å¿ƒåº•å±‚çš„å®ç°ç»†èŠ‚ã€‚\nä½†æ˜¯è¿™äº›åº•å±‚çš„çŸ¥è¯†å¤šäº†è§£ä¸€ç‚¹è¿˜æ˜¯æœ‰ç”¨å¤„çš„ã€‚\n","date":"2025-08-24T15:09:50+08:00","image":"https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/6d6b0bc8be14ed7f83dc3fc00e09b7e1490f76d1.jpg","permalink":"https://lqxhub.github.io/posts/fad3c120/","title":"ä¸€æ–‡è®²æ¸…æ¥šæ‰€æœ‰IOï¼ŒåŒæ­¥IOï¼Œå¼‚æ­¥IOï¼Œé˜»å¡IOï¼Œéé˜»å¡IOï¼ŒIOå¤šè·¯å¤ç”¨ï¼Œç½‘ç»œç¼–ç¨‹"},{"content":"å‰ä¸¤å¤©åˆšå†™äº†ä¸€ç¯‡æ–‡ç« ï¼Œæ€æ ·åœ¨C++ä¸­ä½¿ç”¨åç¨‹ ä¼ é€é—¨ã€‚é‚£ä¸ªåªæ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œä»Šå¤©æˆ‘ä»¬æ¥èŠèŠå¦‚ä½•å°†åç¨‹ä¸ io_uring ç»“åˆèµ·æ¥ä½¿ç”¨ï¼Œå®ç°çœŸæ­£çš„å¼‚æ­¥ I/O æ“ä½œã€‚ æˆ‘ä¸ªäººè§‰å¾—ï¼ŒC++åç¨‹æœ€å¥½çš„ä½¿ç”¨åœºæ™¯å°±æ˜¯é…åˆå¼‚æ­¥ I/Oã€‚\nä»¥å‰ä¹Ÿå†™è¿‡ä¸€ç¯‡å…³äº io_uring çš„æ–‡ç«  ä¼ é€é—¨ï¼Œé‡Œé¢ä»‹ç»äº† io_uring çš„åŸºæœ¬æ¦‚å¿µå’Œä½¿ç”¨æ–¹æ³•ã€‚ä»Šå¤©æˆ‘ä»¬å°±åŸºäºé‚£ä¸ªä¾‹å­ï¼Œæ¥å®ç°ä¸€ä¸ªç®€å•çš„ echo æœåŠ¡å™¨ï¼Œä½¿ç”¨åç¨‹æ¥å¤„ç†å®¢æˆ·ç«¯çš„è¿æ¥å’Œæ•°æ®æ”¶å‘ã€‚\nç®€å•ç”»ä¸€ä¸ªå›¾ï¼Œæ¯ä¸€ä¸ª Awaitable éƒ½æ˜¯ä¸€ä¸ªåç¨‹ï¼Œåœ¨ä¸€ä¸ªè¿›ç¨‹ä¸­ï¼Œæ¯ä¸€ä¸ªè¿æ¥éƒ½æœ‰ä¸¤ä¸ªåç¨‹ï¼ˆä¸€ä¸ªç”¨äºè¯»ï¼Œä¸€ä¸ªç”¨äºå†™ï¼‰ã€‚è¿˜æœ‰ä¸€ä¸ªç‰¹æ®Šçš„åç¨‹ AwaitableAccept ç”¨æ¥å¤„ç†æ¥å—è¿æ¥çš„æ“ä½œã€‚ åŒä¸€æ—¶åˆ»ï¼Œæœ€å¤šåªèƒ½æœ‰ä¸€ä¸ªåç¨‹åœ¨æ‰§è¡Œã€‚å…¶ä»–çš„åç¨‹ä¼šè¢«æŒ‚èµ·ï¼Œç­‰å¾…å½“å‰åç¨‹å®Œæˆåå†æ¢å¤æ‰§è¡Œã€‚\nå› ä¸ºåç¨‹å¯ä»¥è®©æˆ‘ä»¬ä»¥åŒæ­¥çš„æ–¹å¼ç¼–å†™å¼‚æ­¥ä»£ç ï¼Œé¿å…ä¼ ç»Ÿçš„â€œå›è°ƒå‡½æ•°åœ°ç‹±â€ï¼Œä»è€Œæé«˜ä»£ç çš„å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚è€Œ io_uring åˆ™æ˜¯ Linux æä¾›çš„ä¸€ç§é«˜æ€§èƒ½å¼‚æ­¥ I/O æ¥å£ï¼Œå¯ä»¥ä¸åç¨‹ç»“åˆä½¿ç”¨ï¼Œè¿›ä¸€æ­¥æå‡æ€§èƒ½ã€‚\nå› ä¸ºä»£ç é‡æœ‰ç‚¹å¤§ï¼Œå°±ä¸å…¨è´´åœ¨è¿™é‡Œäº†ï¼Œå·²ç»ä¸Šä¼ åˆ°GitHubä¸Šï¼Œå¯ä»¥å»è¿™é‡ŒæŸ¥çœ‹ ä¼ é€é—¨ã€‚\nä¸åºŸè¯äº†ï¼Œç›´æ¥ä¸Šä»£ç \ncoroutine handle 1#ifndef TASK_H 2#define TASK_H 3 4#include \u0026lt;coroutine\u0026gt; 5#include \u0026lt;exception\u0026gt; 6#include \u0026lt;functional\u0026gt; 7 8template \u0026lt;bool initialSuspend\u0026gt; struct Task { 9 struct promise_type { 10 std::coroutine_handle\u0026lt;\u0026gt; handle; 11 std::function\u0026lt;void()\u0026gt; onDone; // åç¨‹ç»“æŸæ—¶è°ƒç”¨çš„æ¸…ç†å›è°ƒ 12 13 auto get_return_object() { return Task{*this}; } 14 15 auto initial_suspend() { 16 if constexpr (initialSuspend) { 17 return std::suspend_always{}; 18 } else { 19 return std::suspend_never{}; 20 } 21 } 22 23 auto final_suspend() noexcept { 24 struct Awaiter { 25 bool await_ready() noexcept { return false; } 26 27 void await_suspend(std::coroutine_handle\u0026lt;promise_type\u0026gt; h) noexcept { 28 if (h.promise().onDone) { 29 h.promise().onDone(); 30 } 31 } 32 33 void await_resume() noexcept {} 34 }; 35 return Awaiter{}; 36 } 37 38 void unhandled_exception() { std::terminate(); } 39 40 void return_void() {} 41 42 promise_type() = default; 43 ~promise_type() = default; 44 }; 45 46 explicit Task(promise_type \u0026amp;promise) 47 : handle_(std::coroutine_handle\u0026lt;promise_type\u0026gt;::from_promise(promise)) {} 48 49 Task(Task \u0026amp;\u0026amp;other) noexcept : handle_(other.handle_) { 50 other.handle_ = nullptr; 51 } 52 53 Task \u0026amp;operator=(Task \u0026amp;\u0026amp;other) noexcept { 54 if (this != \u0026amp;other) { 55 if (handle_ \u0026amp;\u0026amp; !handle_.done()) 56 handle_.destroy(); 57 handle_ = other.handle_; 58 other.handle_ = nullptr; 59 } 60 return *this; 61 } 62 63 Task(const Task \u0026amp;) = delete; 64 Task \u0026amp;operator=(const Task \u0026amp;) = delete; 65 66 ~Task() { 67 if (handle_ \u0026amp;\u0026amp; !handle_.done()) 68 handle_.destroy(); 69 } 70 71 void resume() { handle_.resume(); } 72 73 void setOnDone(std::function\u0026lt;void()\u0026gt; onDone) { 74 handle_.promise().onDone = std::move(onDone); 75 } 76 77private: 78 std::coroutine_handle\u0026lt;promise_type\u0026gt; handle_; 79}; 80 81#endif // TASK_H ç®€å•è¯´ä¸€ä¸‹å‡ ä¸ªå…³é”®ç‚¹ï¼š\nä½¿ç”¨æ¨¡æ¿å˜é‡ï¼Œæ¥æ§åˆ¶åç¨‹çš„åˆå§‹æŒ‚èµ·çŠ¶æ€ã€‚\nåœ¨åç¨‹ç»“æŸæ—¶ï¼Œå¯ä»¥é€šè¿‡ onDone å›è°ƒæ¥æ‰§è¡Œæ¸…ç†æ“ä½œã€‚ åœ¨åç¨‹ç»“æŸæ—¶ï¼Œå¯ä»¥è°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œå®Œæˆä¸€äº›è‡ªå®šä¹‰æ“ä½œï¼Œåé¢ä¼šç”¨åˆ°ã€‚\nåç¨‹ç»“æŸæ—¶ä¼šè‡ªåŠ¨è°ƒç”¨ final_suspendï¼Œå¯ä»¥åœ¨è¿™é‡Œè¿›è¡Œä¸€äº›æ”¶å°¾å·¥ä½œã€‚ final_suspendä¸­å®šä¹‰äº†ä¸€ä¸ª Awaiterï¼Œç”¨äºåœ¨åç¨‹ç»“æŸæ—¶æ‰§è¡Œæ¸…ç†æ“ä½œã€‚å½“åç¨‹ç»“æŸæ—¶ï¼ŒAwaiter ä¼šè¢«å”¤é†’ï¼Œä»è€Œè°ƒç”¨ onDone å›è°ƒã€‚å½“ onDone æ‰§è¡Œå®Œæˆåï¼Œåç¨‹çš„èµ„æºä¼šè¢«é‡Šæ”¾ã€‚\nio_uring wrapper 1class IoUring { 2public: 3 explicit IoUring(int port) : port_(port) {} 4 5 IoUring(const IoUring \u0026amp;) = delete; 6 IoUring \u0026amp;operator=(const IoUring \u0026amp;) = delete; 7 IoUring(IoUring \u0026amp;\u0026amp;) = delete; 8 IoUring \u0026amp;operator=(IoUring \u0026amp;\u0026amp;) = delete; 9 10 ~IoUring() = default; 11 12 void Stop() { running_.store(false); } 13 14 io_uring \u0026amp;Uring() { return ring_; } 15 16 std::expected\u0026lt;bool, std::string\u0026gt; Init();//åˆå§‹åŒ–io_uringå’Œç½‘ç»œ 17 void run();//è¿è¡Œio_uringäº‹ä»¶å¾ªç¯ 18 Task\u0026lt;true\u0026gt; acceptServer();//æ¥å—å®¢æˆ·ç«¯è¿æ¥ 19 20 Task\u0026lt;false\u0026gt; startSession(int fd, uint64_t connId);//å¤„ç†å®¢æˆ·ç«¯ä¼šè¯ 21 22private: 23 std::expected\u0026lt;bool, std::string\u0026gt; createListenSocket();//åˆ›å»ºç›‘å¬socket 24 25 static int set_nonblocking(int fd) {//è®¾ç½®socketä¸ºéé˜»å¡IO 26 return fcntl(fd, F_SETFL, fcntl(fd, F_GETFL, 0) | O_NONBLOCK); 27 } 28 29 uint64_t getConnId() { return ++connId; } 30 31 io_uring ring_{}; 32 uint16_t port_; 33 int listenFd_ = -1; 34 const int entries_ = 256; // Default number of entries 35 std::atomic\u0026lt;bool\u0026gt; running_ = true; 36 37 uint64_t connId = 0; // Connection ID for tracking connections 38 39 std::unordered_map\u0026lt;uint64_t, Task\u0026lt;false\u0026gt;\u0026gt; sessions_; 40}; ä»¥ä¸Šå°±æ˜¯å¯¹ io_uring çš„ä¸€ä¸ªç®€å•å°è£…ï¼Œä¸‹é¢æŒ‘å‡ ä¸ªå…³é”®çš„å‡½æ•°æ¥èŠä¸€ä¸‹\nIoUring::run 1void IoUring::run() { 2 while (running_.load()) { 3 io_uring_cqe *cqe = nullptr; 4 int ret = io_uring_wait_cqe(\u0026amp;ring_, \u0026amp;cqe); 5 if (ret \u0026lt; 0) { 6 if (ret == -EINTR) 7 continue; 8 break; 9 } 10 // user_data ä¿å­˜ç€ Op æŒ‡é’ˆ 11 auto *op = reinterpret_cast\u0026lt;AwaitableBaseOp *\u0026gt;(cqe-\u0026gt;user_data); 12 if (!op) { 13 io_uring_cqe_seen(\u0026amp;ring_, cqe); 14 continue; 15 } 16 op-\u0026gt;SetRes(cqe-\u0026gt;res);//è®¾ç½®æ“ä½œç»“æœ 17 io_uring_cqe_seen(\u0026amp;ring_, cqe); 18 19 op-\u0026gt;resume();//æ¢å¤åç¨‹æ‰§è¡Œ 20 } 21} å¾ªç¯éå† io_uring çš„å®Œæˆé˜Ÿåˆ—ï¼Œå¤„ç†æ¯ä¸ªå®Œæˆçš„æ“ä½œã€‚\nAwaitableBaseOp æ˜¯æ‰€æœ‰å¯ç­‰å¾…æ“ä½œçš„åŸºç±»ï¼Œè´Ÿè´£ç®¡ç†åç¨‹çš„çŠ¶æ€å’Œç”Ÿå‘½å‘¨æœŸï¼Œåé¢ä¼šç”¨åˆ°ã€‚\nop-\u0026gt;SetRes(cqe-\u0026gt;res); æŠŠio_uringçš„ç»“æœä¼ é€’ç»™æ“ä½œå¯¹è±¡ã€‚\nåœ¨ op-\u0026gt;resume() è¢«è°ƒç”¨æ—¶ï¼Œåç¨‹ä¼šç»§ç»­æ‰§è¡Œï¼Œç›´è‡³ä¸‹ä¸€ä¸ªæŒ‚èµ·ç‚¹ã€‚\nIoUring::startSession 1Task\u0026lt;false\u0026gt; IoUring::startSession(int fd, uint64_t connId) { 2 std::string buffer; 3 buffer.resize(1024); 4 while (true) { 5 auto res = co_await AwaitableRead(this, fd, buffer); 6 if (res \u0026lt;= 0) { 7 break; 8 } 9 std::cout \u0026lt;\u0026lt; \u0026#34;Received data: \u0026#34;; 10 std::cout.write(buffer.data(), res); 11 std::cout \u0026lt;\u0026lt; std::endl; 12 res = co_await AwaitableWrite(this, fd, std::move(std::string(buffer))); 13 if (res \u0026lt;= 0) { 14 break; 15 } 16 } 17 close(fd); 18 co_return; 19} å¯åŠ¨ä¸€ä¸ªå®¢æˆ·ç«¯ä¼šè¯ï¼Œå¤„ç†æ•°æ®çš„è¯»å–å’Œå†™å…¥ã€‚\nä½¿ç”¨ co_await å…³é”®å­—æ¥ç­‰å¾…å¼‚æ­¥æ“ä½œçš„å®Œæˆã€‚\nco_await AwaitableRead è¿™é‡Œä¼šæŠŠå½“å‰åç¨‹æŒ‚èµ·ï¼Œç„¶åå½“è¯»å–æ“ä½œå®Œæˆæ—¶ï¼Œåç¨‹ä¼šè¢«å”¤é†’ï¼Œå¹¶ä¸”å¯ä»¥è·å–åˆ°è¯»å–çš„ç»“æœã€‚\nco_await AwaitableWrite è¿™é‡ŒåŒæ ·ä¼šæŠŠå½“å‰åç¨‹æŒ‚èµ·ï¼Œç­‰å¾…å†™å…¥æ“ä½œå®Œæˆã€‚\nIoUring::acceptServer 1Task\u0026lt;true\u0026gt; IoUring::acceptServer() { 2 while (true) { 3 auto clientFd = co_await AwaitableAccept(this, listenFd_); 4 std::cout \u0026lt;\u0026lt; clientFd \u0026lt;\u0026lt; std::endl; 5 if (clientFd \u0026lt; 0) 6 break; 7 8 set_nonblocking(clientFd); 9 auto connId = getConnId(); 10 auto t = startSession(clientFd, connId);//å¯åŠ¨ä¸€ä¸ªå®¢æˆ·ç«¯ä¼šè¯ï¼Œå¤„ç†æ•°æ®çš„è¯»å–å’Œå†™å…¥ã€‚ 11 t.setOnDone([connId, this]() { sessions_.erase(connId); }); 12 sessions_.emplace(connId, std::move(t)); 13 } 14 close(listenFd_); 15 co_return; 16} å¼€å§‹ä¸€ä¸ªæœåŠ¡å™¨ç«¯çš„ä¼šè¯ï¼Œæ¥å—å®¢æˆ·ç«¯è¿æ¥ã€‚\nco_await AwaitableAccept è¿™é‡Œä¼šæŠŠå½“å‰åç¨‹æŒ‚èµ·ï¼Œå½“æœ‰å®¢æˆ·ç«¯è¿æ¥æ—¶ï¼Œåç¨‹ä¼šè¢«å”¤é†’ï¼Œå¹¶ä¸”å¯ä»¥è·å–åˆ°æ¥å—çš„ç»“æœã€‚\nauto t = startSession(clientFd, connId); è¿™é‡Œä¼šå¯åŠ¨ä¸€ä¸ªåç¨‹ï¼Œå¤„ç†æ•°æ®çš„è¯»å–å’Œå†™å…¥ã€‚ è¿™é‡Œæœ‰ä¸ªå…³é”®ç‚¹ï¼ŒstartSession ä¼šè¿”å›ä¸€ä¸ªåç¨‹çš„å¥æŸ„ï¼Œä¸€å®šè¦å¦¥å–„ä¿ç®¡è¿™ä¸ªå¥æŸ„ï¼Œå¦‚æœæ²¡æœ‰ä¿å­˜ï¼Œå½“ while å¾ªç¯ç»“æŸæ—¶ï¼Œåç¨‹ä¼šè¢«é”€æ¯ï¼Œå¯¼è‡´å¼‚å¸¸ã€‚ æ‰€ä»¥è¦æŠŠåç¨‹çš„å¥æŸ„ä¿å­˜åœ¨ sessions_ è¿™ä¸ª map ä¸­ï¼Œä»¥ä¾¿åç»­ç®¡ç†ã€‚\nt.setOnDone([connId, this]() { sessions_.erase(connId); }); åœ¨è¿™é‡Œï¼Œé€šè¿‡è®¾ç½®å›è°ƒå‡½æ•°ï¼Œè®¾ç½®äº†åç¨‹å®Œæˆåçš„æ¸…ç†å·¥ä½œã€‚\nAwaitableBaseOp 1class AwaitableBaseOp { 2public: 3 explicit AwaitableBaseOp(std::coroutine_handle\u0026lt;\u0026gt; h) : coro_(h) {} 4 5 virtual ~AwaitableBaseOp() = default; 6 7 void resume() { 8 if (coro_ \u0026amp;\u0026amp; !coro_.done()) { 9 coro_.resume(); 10 } 11 } 12 13 void SetRes(int res) { res_ = res; } 14 15 int GetRes() const { return res_; } 16 17protected: 18 std::coroutine_handle\u0026lt;\u0026gt; coro_; 19 int res_ = 0; 20}; å®šä¹‰äº†åç¨‹çš„åŸºæœ¬æ“ä½œï¼ŒåŒ…æ‹¬æ¢å¤åç¨‹å’Œè®¾ç½®ç»“æœã€‚è¿™ä¸ªç±»çš„å®ä¾‹çš„æŒ‡é’ˆä¼šè¢«ä¼ é€’ç»™ io_uring_sqe çš„ user_data ä¸­ã€‚ å½“ io_uring çš„å¼‚æ­¥æ“ä½œå®Œæˆæ—¶ï¼Œio_uring é€šè¿‡å¾—åˆ° io_uring_cqe AwaitableBaseOp çš„æŒ‡é’ˆï¼Œè°ƒç”¨ SetRes æ¥è®¾ç½®ç»“æœï¼Œç„¶åè°ƒç”¨ resume æ¥æ¢å¤åç¨‹ã€‚\nAwaitable éœ€è¦åˆ° accept read write çš„æ“ä½œéƒ½å¯ä»¥å°è£…æˆä¸€ä¸ª Awaitable ç±»ï¼Œæ–¹ä¾¿ç®¡ç†åç¨‹çš„çŠ¶æ€å’Œç”Ÿå‘½å‘¨æœŸã€‚\naccept 1class AwaitableAccept { 2 IoUring *uring_ = nullptr; 3 sockaddr_storage addr_{}; 4 socklen_t addrlen_{}; 5 int serverFd_ = 0; 6 7 AwaitableBaseOp *op = nullptr; 8 9public: 10 //çœç•¥éƒ¨åˆ†ä»£ç  11 12 ~AwaitableAccept() = default; 13 14 bool await_ready() const noexcept { return false; } 15 16 void await_suspend(std::coroutine_handle\u0026lt;\u0026gt; h) { 17 op = new AwaitableBaseOp(h); 18 19 io_uring_sqe *sqe = io_uring_get_sqe(\u0026amp;uring_-\u0026gt;Uring()); 20 io_uring_prep_accept(sqe, serverFd_, reinterpret_cast\u0026lt;sockaddr *\u0026gt;(\u0026amp;addr_), 21 \u0026amp;addrlen_, 0); 22 io_uring_sqe_set_data(sqe, op); 23 io_uring_submit(\u0026amp;uring_-\u0026gt;Uring()); 24 } 25 26 int await_resume() const noexcept { 27 int res = op-\u0026gt;GetRes(); 28 delete op; 29 return res; 30 } 31}; è¿™æ˜¯ AwaitableAccept ç±»çš„å®ç°ï¼Œå°è£…äº†å¯¹ io_uring çš„ accept æ“ä½œã€‚é€šè¿‡ä½¿ç”¨åç¨‹ï¼Œå¯ä»¥æ–¹ä¾¿åœ°ç®¡ç†å¼‚æ­¥ I/O æ“ä½œçš„çŠ¶æ€å’Œç”Ÿå‘½å‘¨æœŸã€‚\nawait_suspend å‡½æ•°ä¼šåœ¨åç¨‹æŒ‚èµ·æ—¶ï¼ˆco_await æ“ä½œï¼‰è¢«è°ƒç”¨ï¼Œè´Ÿè´£å°†åç¨‹çš„å¥æŸ„ä¸ io_uring çš„è¯·æ±‚å…³è”èµ·æ¥ã€‚ åœ¨å‡½æ•°å†…éƒ¨ï¼Œåˆ›å»ºä¸€ä¸ª AwaitableBaseOp å¯¹è±¡ï¼Œå¹¶å°†åç¨‹çš„å¥æŸ„ä¼ é€’ç»™å®ƒã€‚ç„¶åï¼Œå‡†å¤‡ä¸€ä¸ª io_uring çš„æäº¤è¯·æ±‚ï¼Œå¹¶å°† AwaitableBaseOp å¯¹è±¡çš„æŒ‡é’ˆè®¾ç½®ä¸ºè¯·æ±‚çš„ç”¨æˆ·æ•°æ®ã€‚æœ€åï¼Œæäº¤è¯·æ±‚åˆ° io_uringã€‚\nawait_resume å‡½æ•°ä¼šåœ¨åç¨‹æ¢å¤æ—¶ï¼ˆè°ƒç”¨ resumeï¼‰è¢«è°ƒç”¨ï¼Œè´Ÿè´£è·å–å¼‚æ­¥æ“ä½œçš„ç»“æœå¹¶æ¸…ç†èµ„æºã€‚ è¿™é‡Œ return æœ€åè¿”å›ç»“æœã€‚è¿™é‡Œ return çš„å€¼ä¼šè¢« co_await è¡¨è¾¾å¼çš„è°ƒç”¨è€…è·å–åˆ°ã€‚\nread 1class AwaitableRead { 2 IoUring *uring_ = nullptr; 3 int fd_ = 0; 4 std::string \u0026amp;buffer_; 5 6 AwaitableBaseOp *op_ = nullptr; 7 8public: 9 //çœç•¥éƒ¨åˆ†ä»£ç  10 void await_suspend(std::coroutine_handle\u0026lt;\u0026gt; h) { 11 op_ = new AwaitableBaseOp(h); 12 13 io_uring_sqe *sqe = io_uring_get_sqe(\u0026amp;uring_-\u0026gt;Uring()); 14 io_uring_prep_recv(sqe, fd_, buffer_.data(), buffer_.size(), 0); 15 io_uring_sqe_set_data(sqe, op_); 16 io_uring_submit(\u0026amp;uring_-\u0026gt;Uring()); 17 } 18 //çœç•¥éƒ¨åˆ†ä»£ç  19}; AwaitableRead ç±»çš„å®ç°ï¼Œå°è£…äº†å¯¹ io_uring çš„è¯»å–æ“ä½œã€‚\nä¸­é—´çœç•¥äº†ä¸€äº›ä»£ç ç»†èŠ‚ï¼Œä½†æ•´ä½“æ€è·¯å°±æ˜¯é€šè¿‡ AwaitableRead ç±»æ¥ç®€åŒ–å¼‚æ­¥è¯»å–æ“ä½œçš„å®ç°ã€‚\nawait_suspend å‡½æ•°å†…éƒ¨ï¼Œå°†åç¨‹çš„å¥æŸ„ä¸ io_uring çš„è¯·æ±‚å…³è”èµ·æ¥ã€‚ç„¶åï¼Œå‡†å¤‡ä¸€ä¸ª io_uring çš„æäº¤è¯·æ±‚ï¼Œå¹¶å°† AwaitableBaseOp å¯¹è±¡çš„æŒ‡é’ˆè®¾ç½®ä¸ºè¯·æ±‚çš„ç”¨æˆ·æ•°æ®ã€‚æœ€åï¼Œæäº¤è¯·æ±‚åˆ° io_uringã€‚\nawait_resume å‡½æ•°ä¼šåœ¨åç¨‹æ¢å¤æ—¶è¢«è°ƒç”¨ï¼Œè´Ÿè´£è·å–å¼‚æ­¥æ“ä½œçš„ç»“æœå¹¶æ¸…ç†èµ„æºã€‚è¿™é‡Œ return æœ€åè¿”å›ç»“æœã€‚è¿™é‡Œ return çš„å€¼ä¼šè¢« co_await è¡¨è¾¾å¼çš„è°ƒç”¨è€…è·å–åˆ°ã€‚\nwrite 1class AwaitableWrite { 2 IoUring *uring_ = nullptr; 3 int fd_ = 0; 4 std::string buffer_; 5 AwaitableBaseOp *op_ = nullptr; 6 7public: 8 //çœç•¥éƒ¨åˆ†ä»£ç  9 10 void await_suspend(std::coroutine_handle\u0026lt;\u0026gt; h) { 11 op_ = new AwaitableBaseOp(h); 12 13 io_uring_sqe *sqe = io_uring_get_sqe(\u0026amp;uring_-\u0026gt;Uring()); 14 io_uring_prep_write(sqe, fd_, buffer_.data(), buffer_.size(), 0); 15 io_uring_sqe_set_data(sqe, op_); 16 io_uring_submit(\u0026amp;uring_-\u0026gt;Uring()); 17 } 18 //çœç•¥éƒ¨åˆ†ä»£ç  19}; AwaitableWrite ç±»çš„å®ç°ï¼Œå°è£…äº†å¯¹ io_uring çš„å†™å…¥æ“ä½œã€‚åŸºæœ¬å’Œ AwaitableRead ç±»ç±»ä¼¼ï¼Œé€šè¿‡åç¨‹çš„æ–¹å¼ç®€åŒ–äº†å¼‚æ­¥å†™å…¥çš„æµç¨‹ã€‚await_suspend å‡½æ•°è´Ÿè´£å°†åç¨‹çš„å¥æŸ„ä¸ io_uring çš„è¯·æ±‚å…³è”èµ·æ¥ï¼Œå¹¶æäº¤å†™å…¥è¯·æ±‚ã€‚await_resume å‡½æ•°åˆ™è´Ÿè´£è·å–å†™å…¥æ“ä½œçš„ç»“æœå¹¶æ¸…ç†èµ„æºã€‚\nrun 1int main() { 2 IoUring ioUring(8088); 3 if (auto ret = ioUring.Init(); !ret) { 4 std::cout \u0026lt;\u0026lt; \u0026#34;uring init fail\u0026#34; \u0026lt;\u0026lt; ret.error() \u0026lt;\u0026lt; std::endl; 5 return -1; 6 } 7 auto t = ioUring.acceptServer(); 8 std::cout \u0026lt;\u0026lt; \u0026#34;Server started on port 8088.\u0026#34; \u0026lt;\u0026lt; std::endl; 9 t.resume(); 10 ioUring.run(); 11 return 0; 12} è¿è¡Œè¿™ä¸ªç¨‹åº\nåˆ›å»ºä¸€ä¸ª IoUring å¯¹è±¡ï¼Œç›‘å¬8088ç«¯å£ã€‚ è°ƒç”¨ IoUring::Init åˆå§‹åŒ– io_uringã€‚ è°ƒç”¨ IoUring::acceptServer å¼€å§‹æ¥å—è¿æ¥ã€‚ è°ƒç”¨ IoUring::run è¿›å…¥äº‹ä»¶å¾ªç¯ã€‚ åˆ°è¿™ï¼Œæ•´ä¸ªåç¨‹ä¸ io_uring çš„ç»“åˆå°±å®Œæˆäº†ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ C++ ä¸­ä¼˜é›…åœ°å¤„ç†å¼‚æ­¥ I/O æ“ä½œï¼Œå……åˆ†åˆ©ç”¨åç¨‹çš„ä¼˜åŠ¿ï¼Œæé«˜ä»£ç çš„å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚ å¯èƒ½ä¼šæœ‰äººé—®ï¼Œæ€ä¹ˆæ²¡çœ‹åˆ°æœ‰å…³çº¿ç¨‹ std::thread çš„ä»£ç ï¼Ÿå› ä¸ºè¿™ä¸ªä¾‹å­æ˜¯å•çº¿ç¨‹å†…ä½¿ç”¨åç¨‹çš„ï¼Œæ‰€æœ‰çš„æ“ä½œéƒ½æ˜¯åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­å®Œæˆçš„ã€‚æ‰€è°“çš„å¼‚æ­¥æ˜¯é€šè¿‡åç¨‹çš„æŒ‚èµ·å’Œæ¢å¤æ¥å®ç°çš„ï¼Œè€Œä¸æ˜¯é€šè¿‡å¤šçº¿ç¨‹å¹¶å‘æ‰§è¡Œã€‚é€šè¿‡å¼‚æ­¥ I/O è¯»å†™æ—¶ï¼Œä¸ä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œå½“è¯»å†™å®Œæˆåï¼Œé€šçŸ¥å½“å‰çº¿ç¨‹ï¼Œæ¥å®ç°çš„å¼‚æ­¥ã€‚\né‚£è¿™æ ·è®¾è®¡çš„å¥½å¤„æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿé¦–å…ˆï¼Œå®ƒé¿å…äº†å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­çš„è®¸å¤šå¤æ‚æ€§ï¼Œæ¯”å¦‚çº¿ç¨‹å®‰å…¨ã€é”ç«äº‰ç­‰é—®é¢˜ã€‚å…¶æ¬¡ï¼Œåç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢æ¯”çº¿ç¨‹è½»é‡å¾—å¤šï¼Œæ€§èƒ½å¼€é”€æ›´å°ã€‚æœ€åï¼Œåç¨‹å¯ä»¥è®©å¼‚æ­¥ä»£ç çœ‹èµ·æ¥åƒåŒæ­¥ä»£ç ï¼Œæå¤§åœ°æé«˜äº†å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚\nå¦‚æœè¦ä½¿ç”¨å¤šçº¿ç¨‹æ¥å……åˆ†åˆ©ç”¨å¤šæ ¸ CPU çš„æ€§èƒ½ï¼Œå¯ä»¥åœ¨æ¯ä¸ªçº¿ç¨‹ä¸­åˆ›å»ºä¸€ä¸ª IoUring å¯¹è±¡ï¼Œå¹¶ä½¿ç”¨åç¨‹æ¥å¤„ç†æ¯ä¸ªçº¿ç¨‹ä¸­çš„å¼‚æ­¥ I/O æ“ä½œã€‚è¿™æ ·å¯ä»¥åœ¨ä¿æŒä»£ç ç®€æ´çš„åŒæ—¶ï¼Œå……åˆ†åˆ©ç”¨å¤šæ ¸ CPU çš„ä¼˜åŠ¿ã€‚\n","date":"2025-08-23T17:04:05+08:00","image":"https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/cc0fd96def7c84c2e2b5d6a00915b3b8175116cf.jpg","permalink":"https://lqxhub.github.io/posts/d26369fd/","title":"linuxä¸­io_uringå’ŒC++åç¨‹çš„ç»“åˆï¼Œå®ç°çœŸæ­£çš„å¼‚æ­¥I/Oã€‚ç®€å•çš„TCP echo server"},{"content":"å·®ä¸å¤šæœ‰åŠå¹´æ²¡æœ‰å†™ä¸œè¥¿äº†ï¼Œä¸»è¦æ˜¯è¿™æ®µæ—¶é—´å¤ªå¿™äº†ï¼Œä¸€ç›´æ²¡ç©ºï¼Œè¿™ä¸¤å‘¨å¼€å§‹æœ‰äº†ä¸€ç‚¹ç©ºé—²æ—¶é—´ï¼Œé‡æ–°æ¡èµ·äº†C++åç¨‹ç›¸å…³çš„çŸ¥è¯†ï¼Œåˆå­¦äº†ä¸€ä¸‹ï¼Œå†™ç¯‡æ–‡ç« ï¼Œåšç‚¹ç¬”è®°ã€‚ å»å¹´å°±äº†è§£äº†ä¸€ç‚¹C++åç¨‹ç›¸å…³çš„çŸ¥è¯†ï¼Œä½†æ˜¯å½“æ—¶åªæ˜¯æµ…æ˜¾çš„äº†è§£äº†ä¸€ä¸‹ï¼Œå¾ˆå¤šä¸œè¥¿æ²¡æœ‰å¼„æ¸…æ¥šï¼Œè¿™æ¬¡æ•´ç†äº†ä¸€äº›æ¦‚å¿µï¼Œå†™äº†ä¸€äº›demoã€‚\nC++çš„åç¨‹æ˜¯C++20å¼€å§‹æ”¯æŒçš„ï¼Œåç¨‹ä¹Ÿä¸æ˜¯ä»€ä¹ˆæ–°é²œä¸œè¥¿äº†ï¼Œè¯ç”Ÿäº2009å¹´çš„golangå‡ºç”Ÿå°±å¸¦åç¨‹ã€‚ä½¿ç”¨è¿‡golangåç¨‹çš„å¯èƒ½éƒ½æ·±æœ‰ä½“ä¼šï¼Œåç¨‹åœ¨å¼‚æ­¥ç¼–ç¨‹ä¸­æä¾›äº†å¾ˆå¥½çš„æ”¯æŒï¼Œå¯ä»¥å¤§å¹…åº¦ç®€åŒ–ä»£ç é€»è¾‘ã€‚ä½†æ˜¯è¯´å®è¯ï¼ŒC++è¿™ç‰ˆæœ¬çš„åç¨‹åªæ˜¯å®ç°äº†åŸºç¡€åŠŸèƒ½ï¼Œå¯¹äºå†™å…·ä½“ä¸šåŠ¡ä»£ç æ¥è¯´ï¼Œè¿˜æ˜¯å¾ˆä¸æ–¹ä¾¿çš„ï¼Œå¤ªå¤šçš„ä¸œè¥¿éœ€è¦è‡ªå·±è§£å†³ã€‚ä¸åƒgolangçš„åç¨‹ï¼Œä¸€ä¸ª go å…³é”®å­—å°±è¡Œäº†ã€‚æ‰€ä»¥å¾ˆå¤šäººå¼€ç©ç¬‘è¯´ï¼Œè¿™ç‰ˆæœ¬çš„åç¨‹æ˜¯ç»™åº“ä½œè€…çš„ï¼Œä¸æ˜¯ç»™æ™®é€šå¼€å‘è€…çš„ã€‚è¿™æ ·ä¹Ÿæœ‰å¥½å¤„ï¼Œç»™äº†ä½¿ç”¨è€…æ›´å¤šçš„çµæ´»æ€§å’Œæ§åˆ¶æƒã€‚\nåœ¨å­¦ä¹ ä¹‹å‰ï¼Œå…ˆæ˜ç¡®ä¸€ä¸ªçŸ¥è¯†ç‚¹ï¼ŒC++20çš„åç¨‹ï¼Œå¦‚æœæ²¡æœ‰è‡ªå·±å®ç°å¤šçº¿ç¨‹çš„è°ƒåº¦é€»è¾‘ï¼Œéƒ½æ˜¯åœ¨å•çº¿ç¨‹ä¸­æ‰§è¡Œçš„ã€‚åªæ˜¯ å¹¶å‘ ä¸æ˜¯ å¹¶è¡Œ ã€‚golangçš„åç¨‹èƒ½åšåˆ°å¹¶è¡Œï¼Œæ˜¯å› ä¸ºgoçš„runtimeå®ç°äº†å¤šçº¿ç¨‹çš„è°ƒåº¦é€»è¾‘ï¼Œè€ŒC++20çš„åç¨‹åªæ˜¯æä¾›äº†åç¨‹çš„è¯­æ³•å’ŒåŸºæœ¬çš„çŠ¶æ€æœºæ”¯æŒï¼Œå¹¶æ²¡æœ‰æä¾›å¤šçº¿ç¨‹çš„è°ƒåº¦é€»è¾‘ã€‚C++çš„åç¨‹ï¼Œæ˜¯é€šè¿‡å‡½æ•°çš„çŠ¶æ€åˆ‡æ¢ï¼ˆæŠŠæš‚æ—¶ä¸éœ€è¦ä½¿ç”¨CPUçš„å‡½æ•°æš‚åœï¼Œç­‰åˆ°åˆé€‚çš„æ—¶æœºå†æ¢å¤æ‰§è¡Œï¼‰æé«˜äº†CPUçš„åˆ©ç”¨æ•ˆç‡ï¼Œçœ‹ä¸Šå»åƒæ˜¯å¼‚æ­¥æ‰§è¡Œäº†ã€‚\nC++åç¨‹çš„å®ç°æ–¹å¼ï¼Œåé¢ä¼šæµ…æ˜¾ä»‹ç»ä¸€ä¸‹ã€‚å› ä¸ºå¤ªæ·±å…¥çš„æˆ‘ä¹Ÿäº†è§£ä¸å¤šã€‚ç›®å‰äº†è§£åˆ°çš„ï¼ŒC++çš„åç¨‹æ˜¯åŸºäºçŠ¶æ€æœºçš„å®ç°çš„ï¼Œç¼–è¯‘å™¨åœ¨ç¼–è¯‘åç¨‹æ—¶ï¼Œä¼šå°†åç¨‹è½¬æ¢ä¸ºçŠ¶æ€æœºçš„å½¢å¼ï¼Œä»è€Œå®ç°åç¨‹çš„è°ƒåº¦å’Œåˆ‡æ¢ã€‚\nè¯´åˆ°åç¨‹ï¼Œé¦–å…ˆè¦äº†è§£çš„æ˜¯åç¨‹çš„ä¸¤ç§åŸºæœ¬ç±»å‹ï¼šæœ‰æ ˆåç¨‹å’Œæ— æ ˆåç¨‹ã€‚\næœ‰æ ˆåç¨‹å’Œæ— æ ˆåç¨‹ æœ‰æ ˆåç¨‹ï¼š åç¨‹åœ¨æ‰§è¡Œæ—¶ä¼šä½¿ç”¨è‡ªå·±çš„æ ˆç©ºé—´ï¼Œåç¨‹çš„è°ƒç”¨å’Œè¿”å›éƒ½æ˜¯é€šè¿‡æ ˆæ¥å®ç°çš„ã€‚è¿™ç§æ–¹å¼çš„ä¼˜ç‚¹æ˜¯å®ç°ç®€å•ï¼Œæ€§èƒ½è¾ƒå¥½ï¼Œä½†ç¼ºç‚¹æ˜¯æ ˆç©ºé—´æœ‰é™ï¼Œå®¹æ˜“å¯¼è‡´æ ˆæº¢å‡ºã€‚goè¯­è¨€çš„åç¨‹å°±æ˜¯æœ‰æ ˆåç¨‹çš„ä¸€ä¸ªå…¸å‹ä¾‹å­ã€‚\næ— æ ˆåç¨‹ï¼š åç¨‹åœ¨æ‰§è¡Œæ—¶ä¸ä½¿ç”¨è‡ªå·±çš„æ ˆç©ºé—´ï¼Œè€Œæ˜¯å°†æ‰€æœ‰çš„çŠ¶æ€ä¿¡æ¯ä¿å­˜åœ¨å †ä¸Šã€‚è¿™ç§æ–¹å¼çš„ä¼˜ç‚¹æ˜¯å¯ä»¥æ”¯æŒæ›´å¤§çš„åç¨‹æ ˆï¼Œä½†ç¼ºç‚¹æ˜¯å®ç°å¤æ‚ã€‚C#çš„åç¨‹å°±æ˜¯æ— æ ˆåç¨‹çš„ä¸€ä¸ªå…¸å‹ä¾‹å­ã€‚\næ—¢ç„¶æ˜¯èŠC++çš„åç¨‹ï¼ˆæ²¡æœ‰ç‰¹æ®Šè¯´æ˜ï¼Œä¸‹æ–‡ä¸­æ‰€æåˆ°çš„C++åç¨‹éƒ½æ˜¯æŒ‡C++20çš„åŸç”Ÿåç¨‹ï¼‰ï¼Œé‚£å…³æ³¨ç‚¹å°±è¦æ”¾åœ¨C++çš„åç¨‹å®ç°ä¸Šï¼ŒC++çš„åç¨‹é‡‡ç”¨çš„å°±æ˜¯æ— æ ˆåç¨‹ï¼Œå½“ç„¶ä¹Ÿæœ‰ä¸€äº›ç¬¬ä¸‰æ–¹åç¨‹åº“æ˜¯æœ‰æ ˆåç¨‹ï¼Œè¿™ä¸ªä¸åœ¨æœ¬æ¬¡è®¨è®ºèŒƒå›´ã€‚C++çš„åç¨‹æ˜¯åŸºäºçŠ¶æ€æœºçš„å®ç°çš„ï¼Œç¼–è¯‘å™¨åœ¨ç¼–è¯‘åç¨‹æ—¶ï¼Œä¼šå°†åç¨‹è½¬æ¢ä¸ºçŠ¶æ€æœºçš„å½¢å¼ï¼Œä»è€Œå®ç°åç¨‹çš„è°ƒåº¦å’Œåˆ‡æ¢ã€‚\nè¯´çš„é€šä¿—ä¸€ç‚¹ï¼Œå°±æ˜¯ç¼–è¯‘å™¨åœ¨ç¼–è¯‘ä»£ç æ—¶ï¼ŒæŠŠåç¨‹å‡½æ•°ç¼–è¯‘æˆä¸€ä¸ªç‰¹æ®Šçš„å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æœ‰å¾ˆå¤šçŠ¶æ€ï¼Œå¯ä»¥è¢«æŒ‚èµ·ï¼ˆè®©å‡ºCPUèµ„æºï¼Œä¹Ÿå«æš‚åœæ‰§è¡Œï¼‰ï¼Œæ¢å¤æ‰§è¡Œç­‰ç­‰ã€‚è¿™æ ·çš„å‡½æ•°ä¹Ÿå«åšå¯é‡å…¥å‡½æ•°ã€‚åç¨‹çš„çŠ¶æ€ä¿¡æ¯ï¼ˆå¦‚å±€éƒ¨å˜é‡ã€è¿”å›åœ°å€ç­‰ï¼‰ä¿å­˜åœ¨å †ä¸Šï¼Œè€Œä¸æ˜¯æ ˆä¸Šã€‚\nç”»ä¸€ä¸‹åç¨‹çš„çŠ¶æ€æœºå›¾ï¼Œå¯èƒ½ä¼šæ›´æ¸…æ™°ä¸€äº›ï¼š\nä»è¿™ä¸ªå›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œåç¨‹å‡½æ•°å¯ä»¥è¢«æŒ‚èµ·ï¼ˆæš‚åœæ‰§è¡Œï¼‰å’Œæ¢å¤æ‰§è¡Œï¼Œåç¨‹å‡½æ•°å¯ä»¥åœ¨å¤šä¸ªçŠ¶æ€ä¹‹é—´åˆ‡æ¢ï¼Œè¿™äº›çŠ¶æ€åŒ…æ‹¬æŒ‚èµ·ã€æ¢å¤å’Œå®Œæˆç­‰ã€‚è¿™æ ·çš„è®¾è®¡ä½¿å¾—åç¨‹èƒ½å¤Ÿåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­çµæ´»åœ°è®©å‡ºæ§åˆ¶æƒã€‚\nè‡³äºåç¨‹å‡½æ•°æ˜¯æ€æ ·è¢«æŒ‚èµ·å’Œæ¢å¤çš„ï¼Œä¸»è¦æ˜¯é€šè¿‡ç¼–è¯‘å™¨ç”Ÿæˆçš„çŠ¶æ€æœºæ¥å®ç°çš„ã€‚å½“åç¨‹å‡½æ•°è¢«æŒ‚èµ·æ—¶ï¼Œç¼–è¯‘å™¨ä¼šä¿å­˜å½“å‰çš„æ‰§è¡ŒçŠ¶æ€ï¼ˆå¦‚å±€éƒ¨å˜é‡ã€è¿”å›åœ°å€ç­‰ï¼‰ï¼Œå¹¶å°†æ§åˆ¶æƒäº¤å›ç»™è°ƒç”¨è€…ã€‚å½“åç¨‹å‡½æ•°è¢«æ¢å¤æ—¶ï¼Œç¼–è¯‘å™¨ä¼šæ¢å¤ä¹‹å‰ä¿å­˜çš„æ‰§è¡ŒçŠ¶æ€ï¼Œä»è€Œå®ç°åç¨‹çš„ç»§ç»­æ‰§è¡Œã€‚\nä¸‹é¢å°†ä¸€ç‚¹ç‚¹æ¥åˆ†æåç¨‹å‡½æ•°çš„æ§åˆ¶ã€‚\nC++åç¨‹å‡½æ•° C++åç¨‹å‡½æ•°çš„å®ç°ä¸»è¦ä¾èµ–äºç¼–è¯‘å™¨çš„æ”¯æŒã€‚åœ¨ç¼–å†™åç¨‹å‡½æ•°æ—¶ï¼Œå¼€å‘è€…åªéœ€ä½¿ç”¨ co_awaitã€co_yield å’Œ co_return ç­‰å…³é”®å­—æ¥å®šä¹‰åç¨‹çš„è¡Œä¸ºã€‚ç¼–è¯‘å™¨ä¼šæ ¹æ®è¿™äº›å…³é”®å­—ç”Ÿæˆç›¸åº”çš„çŠ¶æ€æœºä»£ç ï¼Œä»è€Œå®ç°åç¨‹çš„æŒ‚èµ·å’Œæ¢å¤ã€‚\nå…·ä½“æ¥è¯´ï¼Œå½“åç¨‹å‡½æ•°è¢«è°ƒç”¨æ—¶ï¼Œç¼–è¯‘å™¨ä¼šåˆ›å»ºä¸€ä¸ªçŠ¶æ€æœºå¯¹è±¡æ¥ç®¡ç†åç¨‹çš„çŠ¶æ€ã€‚è¿™ä¸ªçŠ¶æ€æœºå¯¹è±¡ä¼šä¿å­˜åç¨‹çš„å±€éƒ¨å˜é‡ã€è¿”å›åœ°å€ç­‰ä¿¡æ¯ã€‚å½“åç¨‹å‡½æ•°æ‰§è¡Œåˆ° co_await æˆ– co_yield æ—¶ï¼Œç¼–è¯‘å™¨ä¼šå°†å½“å‰çš„æ‰§è¡ŒçŠ¶æ€ä¿å­˜åˆ°çŠ¶æ€æœºå¯¹è±¡ä¸­ï¼Œå¹¶å°†æ§åˆ¶æƒäº¤å›ç»™è°ƒç”¨è€…ã€‚å½“åç¨‹å‡½æ•°è¢«æ¢å¤æ—¶ï¼Œç¼–è¯‘å™¨ä¼šä»çŠ¶æ€æœºå¯¹è±¡ä¸­æ¢å¤ä¹‹å‰ä¿å­˜çš„æ‰§è¡ŒçŠ¶æ€ï¼Œä»è€Œå®ç°åç¨‹çš„ç»§ç»­æ‰§è¡Œã€‚\néœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒC++åç¨‹å‡½æ•°çš„è¿”å›ç±»å‹å¹¶ä¸æ˜¯æ™®é€šçš„è¿”å›å€¼ï¼Œè€Œæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„åç¨‹å¥æŸ„ï¼ˆcoroutine handleï¼‰ã€‚è¿™ä¸ªå¥æŸ„å¯ä»¥ç”¨æ¥ç®¡ç†åç¨‹çš„ç”Ÿå‘½å‘¨æœŸï¼Œä¾‹å¦‚å¯åŠ¨ã€æŒ‚èµ·å’Œæ¢å¤ç­‰æ“ä½œã€‚\nçœ‹åˆ°è¿™äº›å¯èƒ½ä¼šä¸€å¤´é›¾æ°´ï¼Œåˆ«ç€æ€¥ï¼Œè®©æˆ‘ä»¬ä¸€ç‚¹ç‚¹æ¥ã€‚\nåç¨‹å‡½æ•°å’Œæ™®é€šå‡½æ•°çš„åŒºåˆ« æœ€æ˜æ˜¾çš„åŒºåˆ«æ˜¯åç¨‹å‡½æ•°å¯ä»¥è¢«æŒ‚èµ·å’Œæ¢å¤ã€‚ä½†æ˜¯æœ‰æ²¡æœ‰æƒ³è¿‡ï¼Œç¼–è¯‘å™¨åœ¨ç¼–è¯‘ä»£ç çš„æ—¶å€™ï¼Œæ˜¯æ€æ ·è¯†åˆ«ä¸€ä¸ªå‡½æ•°æ˜¯æ™®é€šå‡½æ•°è¿˜æ˜¯åç¨‹å‡½æ•°å‘¢ï¼Ÿ è¿™ä¸»è¦æ˜¯é€šè¿‡åç¨‹å‡½æ•°çš„è¿”å›ç±»å‹æ¥åˆ¤æ–­çš„ã€‚åç¨‹å‡½æ•°çš„è¿”å›ç±»å‹æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„åç¨‹å¥æŸ„coroutine handleï¼Œè€Œä¸æ˜¯æ™®é€šçš„è¿”å›å€¼ã€‚è¿™ä¸ªåç¨‹å¥æŸ„å¯ä»¥ç”¨æ¥ç®¡ç†åç¨‹çš„ç”Ÿå‘½å‘¨æœŸã€‚\næ‰€ä»¥å½“ç¼–è¯‘å™¨çœ‹åˆ°ä¸€ä¸ªå‡½æ•°çš„è¿”å›ç±»å‹æ˜¯coroutine handleæ—¶ï¼Œå°±ä¼šå°†å…¶è¯†åˆ«ä¸ºåç¨‹å‡½æ•°ã€‚\nä¸‹é¢æ¥çœ‹ä¸€ä¸‹ä»€ä¹ˆæ˜¯åç¨‹å¥æŸ„ coroutine handle\nåç¨‹å¥æŸ„æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„å¯¹è±¡ï¼Œç”¨äºç®¡ç†åç¨‹çš„ç”Ÿå‘½å‘¨æœŸã€‚å®ƒå¯ä»¥ç”¨æ¥å¯åŠ¨ã€æŒ‚èµ·å’Œæ¢å¤åç¨‹ã€‚åç¨‹å¥æŸ„çš„å®ç°ä¾èµ–äºç¼–è¯‘å™¨ç”Ÿæˆçš„çŠ¶æ€æœºä»£ç ã€‚\nè¯´åˆ° coroutine_handle å°±ä¸å¾—ä¸æåç¨‹çš„ promiseã€‚promise ç±»å‹æ˜¯åç¨‹çš„æ ¸å¿ƒï¼Œå®ƒè´Ÿè´£ç®¡ç†åç¨‹çš„çŠ¶æ€å’Œç”Ÿå‘½å‘¨æœŸã€‚æ¯ä¸ªåç¨‹éƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„ promise å¯¹è±¡ï¼Œç”¨äºä¿å­˜åç¨‹çš„çŠ¶æ€ä¿¡æ¯ã€‚\nåœ¨ C++20 ä¸­ï¼Œåç¨‹å¥æŸ„çš„ç±»å‹æ˜¯ std::coroutine_handleã€‚è¿™ä¸ªç±»å‹æ˜¯ä¸€ä¸ªæ¨¡æ¿ç±»ï¼Œæ¥å—ä¸€ä¸ª promise ç±»å‹ä½œä¸ºæ¨¡æ¿å‚æ•°ã€‚promise ç±»å‹æ˜¯åç¨‹çš„çŠ¶æ€æœºå¯¹è±¡ï¼Œè´Ÿè´£ç®¡ç†åç¨‹çš„çŠ¶æ€ã€‚\npromise ä¸æ˜¯ä¸€ä¸ªå…·ä½“çš„ç±»å‹ï¼Œé€šå¸¸éœ€è¦å®ç°ä»¥ä¸‹å‡ ä¸ªæ–¹æ³•çš„ç»“æ„ä½“å°±æ˜¯ promiseç±»å‹ï¼š\nget_return_object()ï¼šè¿”å›åç¨‹çš„å¥æŸ„ initial_suspend()ï¼šåç¨‹å¼€å§‹æ—¶æ˜¯å¦æŒ‚èµ· final_suspend()ï¼šåç¨‹ç»“æŸæ—¶æ˜¯å¦æŒ‚èµ· yield_value()ï¼šåç¨‹ä¸­ä½¿ç”¨ co_yield è¿”å›å€¼æ—¶çš„å¤„ç† return_void()ï¼šåç¨‹è¿”å›æ—¶æ˜¯å¦è¿”å›å€¼ unhandled_exception()ï¼šå¤„ç†æœªæ•è·çš„å¼‚å¸¸ é€šè¿‡è¿™äº›æ–¹æ³•ï¼Œåç¨‹çš„ promise ç±»å‹å¯ä»¥ä¸åç¨‹å¥æŸ„è¿›è¡Œäº¤äº’ï¼Œä»è€Œå®ç°åç¨‹çš„æŒ‚èµ·å’Œæ¢å¤ã€‚\nä¹Ÿå°±æ˜¯è¯´ï¼Œåªè¦ä¸€ä¸ªå‡½æ•°çš„è¿”å›å€¼æ˜¯ coroutine_handle ç±»å‹ï¼Œç¼–è¯‘å™¨å°±ä¼šå°†å…¶è¯†åˆ«ä¸ºåç¨‹å‡½æ•°ï¼Œåç¨‹å‡½æ•°èƒ½å®ç°æŒ‚èµ·å’Œæ¢å¤çš„åŠŸèƒ½ï¼Œä¸»è¦æ˜¯é€šè¿‡ promise å¯¹è±¡æ¥ç®¡ç†åç¨‹çš„çŠ¶æ€å’Œç”Ÿå‘½å‘¨æœŸã€‚\nåç¨‹å…³é”®å­— åœ¨C++20ä¸­ï¼Œåç¨‹å‡½æ•°ä½¿ç”¨äº†ä¸‰ä¸ªä¸ªå…³é”®å­—æ¥æ§åˆ¶åç¨‹è¡Œä¸º\nco_awaitï¼šç”¨äºæŒ‚èµ·åç¨‹å¹¶ç­‰å¾…ä¸€ä¸ªå¼‚æ­¥æ“ä½œçš„å®Œæˆã€‚ co_yieldï¼šç”¨äºè¿”å›ä¸€ä¸ªå€¼å¹¶æŒ‚èµ·åç¨‹çš„æ‰§è¡Œã€‚ co_returnï¼šç”¨äºè¿”å›åç¨‹çš„æœ€ç»ˆç»“æœã€‚ é€šè¿‡è¿™äº›å…³é”®å­—ï¼Œå¼€å‘è€…å¯ä»¥æ–¹ä¾¿åœ°å®šä¹‰åç¨‹çš„è¡Œä¸ºï¼Œä»è€Œå®ç°å¼‚æ­¥ç¼–ç¨‹çš„éœ€æ±‚ã€‚\nco_await å’Œ co_yield å…³é”®å­—å¯ä»¥ç”¨äºå®ç°åç¨‹çš„æŒ‚èµ·å’Œæ¢å¤ï¼Œè€Œ co_return å…³é”®å­—åˆ™ç”¨äºè¿”å›åç¨‹çš„æœ€ç»ˆç»“æœã€‚\nå…¶ä¸­ co_await æ˜¯ç”¨äºæŒ‚èµ·åç¨‹å¹¶ç­‰å¾…ä¸€ä¸ªå¼‚æ­¥æ“ä½œçš„å®Œæˆçš„å…³é”®å­—ã€‚\nè¯´åˆ° co_awaitï¼Œæˆ‘ä»¬å°±ä¸å¾—ä¸æä¸€ä¸‹å¯ç­‰å¾…å¯¹è±¡awaitableã€‚è¿™ä¸ªå¯¹è±¡å’Œ promise æœ‰ç‚¹ç±»ä¼¼ï¼Œä¸æ˜¯ä¸€ä¸ªå…·ä½“çš„ç±»å‹ï¼Œè€Œæ˜¯ä¸€ä¸ªæ¥å£ã€‚è¿™ä¸ªå¯¹è±¡éœ€è¦å®ç°ä»¥ä¸‹ä¸‰ä¸ªæ–¹æ³•ï¼š\nawait_ready()ï¼šç”¨äºæ£€æŸ¥å¼‚æ­¥æ“ä½œæ˜¯å¦å·²ç»å®Œæˆã€‚ await_suspend()ï¼šç”¨äºæŒ‚èµ·åç¨‹å¹¶ç­‰å¾…å¼‚æ­¥æ“ä½œçš„å®Œæˆã€‚ await_resume()ï¼šç”¨äºæ¢å¤åç¨‹å¹¶è¿”å›å¼‚æ­¥æ“ä½œçš„ç»“æœã€‚ ä¸‹é¢ä¸€ä¸ªä¸ªæ¥ä»‹ç»ä¸€ä¸‹è¿™ä¸‰ä¸ªæ–¹æ³•çš„å…·ä½“å®ç°ã€‚\n1bool await_ready() const noexcept; è¿™ä¸ªå‡½æ•°ç”¨äºæ£€æŸ¥å¼‚æ­¥æ“ä½œæ˜¯å¦å·²ç»å®Œæˆã€‚å¦‚æœå¼‚æ­¥æ“ä½œå·²ç»å®Œæˆï¼Œåˆ™è¿”å› trueï¼Œå¦åˆ™è¿”å› falseã€‚å¦‚æœè¿”å› trueï¼Œåˆ™åç¨‹ä¼šç«‹å³æ¢å¤æ‰§è¡Œï¼Œè€Œä¸ä¼šæŒ‚èµ·ã€‚\nè¿™ä¸ªå‡½æ•°ä¸€èˆ¬ä¼šåœ¨åç¨‹çš„ await è¡¨è¾¾å¼ä¸­è¢«è°ƒç”¨ã€‚å¦‚æœè¿”å› falseï¼Œåˆ™åç¨‹ä¼šè¢«æŒ‚èµ·ï¼Œç­‰å¾…å¼‚æ­¥æ“ä½œçš„å®Œæˆã€‚\n1void await_suspend(std::coroutine_handle\u0026lt;result::promise_type\u0026gt; coro) è¿™ä¸ªå‡½æ•°ç”¨äºæŒ‚èµ·åç¨‹å¹¶ç­‰å¾…å¼‚æ­¥æ“ä½œçš„å®Œæˆã€‚å®ƒæ¥å—ä¸€ä¸ªåç¨‹å¥æŸ„ä½œä¸ºå‚æ•°ï¼Œè¿™ä¸ªå¥æŸ„æŒ‡å‘å½“å‰åç¨‹çš„ promise å¯¹è±¡ã€‚ å½“å¼‚æ­¥æ“ä½œå®Œæˆæ—¶ï¼Œåç¨‹ä¼šè¢«æ¢å¤æ‰§è¡Œã€‚\n1void await_resume() è¿™ä¸ªå‡½æ•°ç”¨äºæ¢å¤åç¨‹å¹¶è¿”å›å¼‚æ­¥æ“ä½œçš„ç»“æœã€‚å®ƒä¸€èˆ¬ä¼šåœ¨åç¨‹çš„ await è¡¨è¾¾å¼ä¸­è¢«è°ƒç”¨ï¼Œç”¨äºè·å–å¼‚æ­¥æ“ä½œçš„ç»“æœã€‚\nå‡½æ•°çš„è¿”å›å€¼ç±»å‹å¯ä»¥æ˜¯ä»»æ„ç±»å‹ï¼Œé€šå¸¸æ˜¯å¼‚æ­¥æ“ä½œçš„ç»“æœç±»å‹ã€‚å¦‚æœå¼‚æ­¥æ“ä½œæ²¡æœ‰ç»“æœï¼Œåˆ™å¯ä»¥è¿”å› voidã€‚\nè¿™é‡Œè¿˜æœ‰ä¸¤ä¸ªç‰¹æ®Šçš„ awaitï¼Œ std::suspend_always å’Œ std::suspend_never\nstd::suspend_alwaysï¼šè¡¨ç¤ºåç¨‹åœ¨æ¯æ¬¡æŒ‚èµ·æ—¶éƒ½ä¼šç­‰å¾…ï¼Œç›´åˆ°æ˜¾å¼è°ƒç”¨ resume() æ¢å¤åç¨‹ã€‚ std::suspend_neverï¼šè¡¨ç¤ºåç¨‹åœ¨æŒ‚èµ·æ—¶ä¸ä¼šç­‰å¾…ï¼Œç›´æ¥è¿”å›æ§åˆ¶æƒç»™è°ƒç”¨è€…ã€‚ ç›´æ¥å»çœ‹ä¸€ä¸‹è¿™ä¸¤ä¸ªç±»å‹çš„å®ç°å°±æ˜ç™½äº†ï¼Œä¸‹é¢æ˜¯åœ¨ llvm-18 çš„ libc++ ä¸­çš„å®ç°ï¼š\n1struct suspend_never { 2 _LIBCPP_HIDE_FROM_ABI constexpr bool await_ready() const noexcept { return true; } 3 _LIBCPP_HIDE_FROM_ABI constexpr void await_suspend(coroutine_handle\u0026lt;\u0026gt;) const noexcept {} 4 _LIBCPP_HIDE_FROM_ABI constexpr void await_resume() const noexcept {} 5}; 6 7struct suspend_always { 8 _LIBCPP_HIDE_FROM_ABI constexpr bool await_ready() const noexcept { return false; } 9 _LIBCPP_HIDE_FROM_ABI constexpr void await_suspend(coroutine_handle\u0026lt;\u0026gt;) const noexcept {} 10 _LIBCPP_HIDE_FROM_ABI constexpr void await_resume() const noexcept {} 11}; åç¨‹æ³¨æ„äº‹é¡¹ åç¨‹çš„ç”Ÿå‘½å‘¨æœŸï¼šåç¨‹çš„ç”Ÿå‘½å‘¨æœŸç”±åç¨‹å¥æŸ„ coroutine_handle ç®¡ç†ã€‚åç¨‹å¥æŸ„å¯ä»¥ç”¨æ¥å¯åŠ¨ã€æŒ‚èµ·å’Œæ¢å¤åç¨‹ã€‚å¼€å‘è€…éœ€è¦æ³¨æ„åç¨‹çš„ç”Ÿå‘½å‘¨æœŸï¼Œä»¥é¿å…æ‚¬ç©ºæŒ‡é’ˆå’Œèµ„æºæ³„éœ²ç­‰é—®é¢˜ã€‚ åç¨‹å¥æŸ„ä¸€å®šè¦å¦¥å–„å¤„ç†ï¼Œä¸€ä¸ªåç¨‹å¥æŸ„åªèƒ½è°ƒç”¨ä¸€æ¬¡ destroy() æ–¹æ³•ã€‚è€Œä¸”åœ¨åç¨‹ç»“æŸåï¼Œåç¨‹å¥æŸ„ä¼šè¢«é”€æ¯ï¼Œå› æ­¤å¼€å‘è€…éœ€è¦ç¡®ä¿åœ¨åç¨‹ç»“æŸå‰å®Œæˆå¯¹åç¨‹å¥æŸ„çš„æ‰€æœ‰æ“ä½œã€‚å¦‚æœæ²¡æœ‰è°ƒç”¨ destroy() æ–¹æ³•ï¼Œåç¨‹çš„èµ„æºå¯èƒ½æ— æ³•è¢«é‡Šæ”¾ï¼Œä»è€Œå¯¼è‡´å†…å­˜æ³„æ¼ã€‚å¦‚æœå¤šæ¬¡è°ƒç”¨ destroy() æ–¹æ³•æˆ–è€…åœ¨è°ƒç”¨destroy()å†æ¬¡è°ƒç”¨resume()ï¼Œå¯èƒ½ä¼šå¯¼è‡´æœªå®šä¹‰è¡Œä¸ºã€‚\nå¼‚å¸¸å¤„ç†ï¼šåç¨‹ä¸­çš„å¼‚å¸¸å¤„ç†ä¸æ™®é€šå‡½æ•°æœ‰æ‰€ä¸åŒã€‚åç¨‹å¯ä»¥é€šè¿‡ promise å¯¹è±¡çš„ unhandled_exception() æ–¹æ³•æ¥å¤„ç†æœªæ•è·çš„å¼‚å¸¸ã€‚å¼€å‘è€…éœ€è¦åœ¨ promise ç±»å‹ä¸­å®ç°è¿™ä¸ªæ–¹æ³•ï¼Œä»¥ç¡®ä¿åç¨‹ä¸­çš„å¼‚å¸¸èƒ½å¤Ÿè¢«æ­£ç¡®å¤„ç†ã€‚\nåç¨‹ä¾‹å­ è¯´äº†è¿™ä¹ˆå¤šï¼Œé€šè¿‡è¿™äº›æ–‡å­—å¯èƒ½è¿˜æ˜¯éš¾ä»¥ç†è§£ï¼Œä¸‹é¢é€šè¿‡ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¥å¸®åŠ©ç†è§£åç¨‹çš„ä½¿ç”¨ã€‚\næˆ‘æ„Ÿè§‰çœŸæ­£é€‚åˆåç¨‹çš„åœºæ™¯æ˜¯éœ€è¦ç­‰å¾…æŸä¸ªæ“ä½œå®Œæˆåå†ç»§ç»­æ‰§è¡Œåç»­é€»è¾‘çš„æƒ…å†µï¼Œæ¯”å¦‚ç½‘ç»œè¯·æ±‚ã€æ–‡ä»¶è¯»å†™ç­‰ã€‚æœ€å¥½çš„æ­æ¡£å°±æ˜¯å¼‚æ­¥IOçš„åœºæ™¯ã€‚ä½†æ˜¯ç›´æ¥æ‹¿ iouring è¿™ç§é«˜æ€§èƒ½çš„å¼‚æ­¥IOåº“æ¥åšåç¨‹çš„è°ƒåº¦ï¼Œå¯èƒ½ä¼šæ¯”è¾ƒå¤æ‚ï¼Œå¢åŠ ç†è§£æˆæœ¬ã€‚\næ‰€ä»¥å°±å…ˆæ‹¿ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¥è¯´æ˜åç¨‹çš„ä½¿ç”¨ã€‚è¿™ä¸ªä¾‹å­æ˜¯ä¸€ä¸ªç®€å•çš„åç¨‹å‡½æ•°ï¼Œå®ƒä¼šæ‰“å°ä¸€äº›æ•°å­—ã€‚\n1#include \u0026lt;coroutine\u0026gt; 2#include \u0026lt;iostream\u0026gt; 3#include \u0026lt;optional\u0026gt; 4 5template \u0026lt;typename T\u0026gt; 6struct Task { 7 struct promise_type { 8 std::optional\u0026lt;T\u0026gt; current_value; 9 10 auto get_return_object() { 11 return Task{std::coroutine_handle\u0026lt;promise_type\u0026gt;::from_promise(*this)}; 12 } 13 14 auto initial_suspend() { return std::suspend_always{}; } 15 auto final_suspend() noexcept { return std::suspend_always{}; } 16 17 void unhandled_exception() { std::terminate(); } 18 void return_void() {} 19 20 auto yield_value(T value) { 21 current_value = value; 22 return std::suspend_always{}; // æŒ‚èµ·ï¼Œç­‰å¾… next() æ¢å¤ 23 } 24 }; 25 26 std::optional\u0026lt;T\u0026gt; next() { 27 if (!handle_ || handle_.done()) return std::nullopt; 28 handle_.resume(); 29 if (handle_.done()) return std::nullopt; 30 return std::move(handle_.promise().current_value); 31 } 32 33 Task(std::coroutine_handle\u0026lt;promise_type\u0026gt; h) : handle_(h) {} 34 Task(Task\u0026amp;\u0026amp; other) noexcept : handle_(other.handle_) { other.handle_ = nullptr; } 35 Task\u0026amp; operator=(Task\u0026amp;\u0026amp; other) noexcept { 36 if (this != \u0026amp;other) { 37 if (handle_) handle_.destroy(); 38 handle_ = other.handle_; 39 other.handle_ = nullptr; 40 } 41 return *this; 42 } 43 44 ~Task() { if (handle_) handle_.destroy(); } 45 46 std::coroutine_handle\u0026lt;promise_type\u0026gt; handle_; 47}; 48 49struct Awaiter { 50 bool await_ready() const noexcept { return false; } 51 52 void await_suspend(std::coroutine_handle\u0026lt;\u0026gt; h) { 53 std::cout \u0026lt;\u0026lt; \u0026#34;Awaiter suspend \u0026#34; \u0026lt;\u0026lt; input \u0026lt;\u0026lt; std::endl; 54 // è¿™é‡Œå¿…é¡»æ¢å¤åç¨‹ 55 h.resume(); 56 } 57 58 int await_resume() noexcept { 59 std::cout \u0026lt;\u0026lt; \u0026#34;Awaiter resume \u0026#34; \u0026lt;\u0026lt; input \u0026lt;\u0026lt; std::endl; 60 return input * 10; 61 } 62 63 int input = 0; 64}; 65 66Task\u0026lt;int\u0026gt; AsyncFunction(int n) { 67 for (int i = 0; i \u0026lt; n; ++i) { 68 auto ret = co_await Awaiter{i + 1}; 69 co_yield ret; 70 } 71 co_return; 72} 73 74int main() { 75 auto t = AsyncFunction(5); 76 while (auto v = t.next()) { 77 std::cout \u0026lt;\u0026lt; \u0026#34;Received: \u0026#34; \u0026lt;\u0026lt; *v \u0026lt;\u0026lt; std::endl; 78 } 79 return 0; 80} ç¨‹åºè¾“å‡ºå¦‚ä¸‹ï¼š\n1Awaiter suspend 1 2Awaiter resume 1 3Received: 10 4Awaiter suspend 2 5Awaiter resume 2 6Received: 20 7Awaiter suspend 3 8Awaiter resume 3 9Received: 30 10Awaiter suspend 4 11Awaiter resume 4 12Received: 40 13Awaiter suspend 5 14Awaiter resume 5 15Received: 50 é€šè¿‡æ‰“å°çš„ä¿¡æ¯å¯ä»¥çœ‹åˆ°ï¼Œåç¨‹å‡½æ•° AsyncFunction åœ¨æ¯æ¬¡è¿­ä»£æ—¶éƒ½ä¼šæŒ‚èµ·ï¼Œå¹¶é€šè¿‡ co_yield è¿”å›ä¸€ä¸ªå€¼ã€‚æ¯æ¬¡è°ƒç”¨ next() æ–¹æ³•æ—¶ï¼Œåç¨‹ä¼šæ¢å¤æ‰§è¡Œï¼Œç›´åˆ°ä¸‹ä¸€ä¸ª co_yield æˆ–åç¨‹ç»“æŸã€‚\nè¿™é‡Œæ˜¯ä¸ºäº†å±•ç¤º co_yield çš„ç”¨æ³•ã€‚æ‰ä¼šåœ¨åç¨‹ä¸­ä½¿ç”¨ co_yield æ¥è¿”å›å€¼ã€‚è¿™æ ·å†™æœ‰ç‚¹ç”»è›‡æ·»è¶³äº†ï¼Œå¦‚æœä¸éœ€è¦è¿”å›å€¼ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ co_await æ¥ç­‰å¾…å¼‚æ­¥æ“ä½œçš„å®Œæˆã€‚è¿™æ ·å¯ä»¥ç®€åŒ–ä»£ç ï¼Œæ›´ç¬¦åˆåç¨‹çš„ä½¿ç”¨åœºæ™¯ã€‚\nä¸‹é¢è®©æˆ‘ä»¬æ¥ç®€åŒ–ä¸€ä¸‹è¿™æ®µä»£ç \n1#include \u0026lt;coroutine\u0026gt; 2#include \u0026lt;iostream\u0026gt; 3#include \u0026lt;thread\u0026gt; 4 5struct Task 6{ 7 struct promise_type 8 { 9 auto get_return_object() 10 { 11 return Task{std::coroutine_handle\u0026lt;promise_type\u0026gt;::from_promise(*this)}; 12 } 13 14 auto initial_suspend() { return std::suspend_always{}; } 15 auto final_suspend() noexcept { return std::suspend_always{}; } 16 17 void unhandled_exception() { std::terminate(); } 18 19 void return_void() 20 { 21 } 22 }; 23 24 Task(std::coroutine_handle\u0026lt;promise_type\u0026gt; h) : handle_(h) 25 { 26 } 27 28 Task(Task\u0026amp;\u0026amp; other) noexcept : handle_(other.handle_) { other.handle_ = nullptr; } 29 30 Task\u0026amp; operator=(Task\u0026amp;\u0026amp; other) noexcept 31 { 32 if (this != \u0026amp;other) 33 { 34 if (handle_) handle_.destroy(); 35 handle_ = other.handle_; 36 other.handle_ = nullptr; 37 } 38 return *this; 39 } 40 41 ~Task() { if (handle_) handle_.destroy(); } 42 43 std::coroutine_handle\u0026lt;promise_type\u0026gt; handle_; 44}; 45 46struct Awaiter 47{ 48 bool await_ready() const noexcept { return false; } 49 50 void await_suspend(std::coroutine_handle\u0026lt;\u0026gt; h) 51 { 52 std::cout \u0026lt;\u0026lt; \u0026#34;Awaiter suspend \u0026#34; \u0026lt;\u0026lt; input \u0026lt;\u0026lt; std::endl; 53 std::thread t([h]() 54 { 55 //æŠŠåç¨‹æŒ‚èµ·ä¸€æ®µæ—¶é—´ï¼Œæ¨¡æ‹Ÿå¼‚æ­¥æ“ä½œ 56 std::this_thread::sleep_for(std::chrono::seconds(1)); 57 h.resume(); 58 }); 59 t.detach(); // åˆ†ç¦»çº¿ç¨‹ï¼Œé¿å…é˜»å¡ 60 } 61 62 int await_resume() noexcept 63 { 64 //åç¨‹æ¢å¤æ—¶æ‰§è¡Œçš„æ“ä½œ 65 std::cout \u0026lt;\u0026lt; \u0026#34;Awaiter resume \u0026#34; \u0026lt;\u0026lt; input \u0026lt;\u0026lt; std::endl; 66 return input * 10; 67 } 68 69 int input = 0; 70}; 71 72Task AsyncFunction(int n) 73{ 74 for (int i = 0; i \u0026lt; n; ++i) 75 { 76 auto ret = co_await Awaiter{i + 1}; 77 std::cout \u0026lt;\u0026lt; \u0026#34;Awaiter returned \u0026#34; \u0026lt;\u0026lt; ret \u0026lt;\u0026lt; std::endl; 78 std::cout \u0026lt;\u0026lt; \u0026#34;------------------------\u0026#34; \u0026lt;\u0026lt; std::endl; 79 } 80 co_return; 81} 82 83int main() 84{ 85 auto t = AsyncFunction(5); 86 t.handle_.resume();//æ‰‹åŠ¨å”¤é†’åç¨‹ 87 while (!t.handle_.done()) 88 { 89 } 90 return 0; 91} ä¸Šé¢å°±æ˜¯å»æ‰ co_yield åç®€åŒ–çš„ä»£ç ã€‚\nç¨‹åºæ‰§è¡Œçš„è¾“å‡ºå¦‚ä¸‹ï¼š\n1Awaiter suspend 1 2Awaiter resume 1 3Awaiter returned 10 4------------------------ 5Awaiter suspend 2 6Awaiter resume 2 7Awaiter returned 20 8------------------------ 9Awaiter suspend 3 10Awaiter resume 3 11Awaiter returned 30 12------------------------ 13Awaiter suspend 4 14Awaiter resume 4 15Awaiter returned 40 16------------------------ 17Awaiter suspend 5 18Awaiter resume 5 19Awaiter returned 50 20------------------------ åœ¨ main å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬æ‰‹åŠ¨å”¤é†’åç¨‹ï¼Œå¹¶é€šè¿‡å¾ªç¯ç­‰å¾…åç¨‹å®Œæˆã€‚\n1while (!t.handle_.done()) 2{ 3} è¿™é‡Œé€šè¿‡ while å¾ªç¯ä¸æ–­åœ°æ£€æŸ¥åç¨‹æ˜¯å¦å®Œæˆã€‚ä¸ºä»€ä¹ˆéœ€è¦è¿™æ ·åšï¼Œæ˜¯å› ä¸ºå¦‚æœæ²¡æœ‰æ£€æŸ¥ï¼Œè€Œæ˜¯åœ¨åç¨‹æŒ‚èµ·æ—¶ç›´æ¥è¿”å›ï¼Œä¼šå¯¼è‡´ç¨‹åºç›´æ¥é€€å‡ºã€‚\nè¿™ä¹Ÿæ˜¯åç¨‹ å¼‚æ­¥ çš„ä½“ç°ã€‚æ™®é€šå‡½æ•°åªè¦è°ƒç”¨äº†ï¼Œå°±ä¼šä¸€ç›´æ‰§è¡Œï¼Œç›´åˆ°æ•´ä¸ªå‡½æ•°éƒ½æ‰§è¡Œå®Œæˆæ‰ä¼šé€€å‡ºï¼Œç„¶åç”±å‡½æ•°è°ƒç”¨è€…ç»§ç»­æ‰§è¡Œã€‚ åç¨‹å‡½æ•°ä¼šåœ¨è°ƒç”¨ co_await æ—¶æŒ‚èµ·ï¼Œè®©å‡ºCPUèµ„æºï¼Œç”±åç¨‹å‡½æ•°çš„è°ƒç”¨è€…ï¼ˆè¿™é‡Œå°±æ˜¯mainå‡½æ•°ï¼‰ç»§ç»­æ‰§è¡Œã€‚ç­‰åˆ°å¼‚æ­¥æ“ä½œå®Œæˆï¼ˆä¹Ÿå°±æ˜¯æ‰§è¡Œäº† resumeï¼‰åå†æ¢å¤æ‰§è¡Œã€‚\næˆ‘ä»¬åœ¨ await_suspend ä¸­åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„çº¿ç¨‹æ¥æ¨¡æ‹Ÿå¼‚æ­¥æ“ä½œã€‚åœ¨è¿™ä¸ªçº¿ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ std::this_thread::sleep_for æ¥è®©å½“å‰çº¿ç¨‹æš‚å®š1ç§’ï¼Œæ¨¡æ‹Ÿå¼‚æ­¥æ“ä½œçš„å»¶è¿Ÿã€‚\né€šè¿‡è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨åç¨‹ä¸­ä½¿ç”¨ co_await æ¥ç­‰å¾…å¼‚æ­¥æ“ä½œçš„å®Œæˆï¼Œè€Œä¸éœ€è¦ä½¿ç”¨ co_yield æ¥è¿”å›å€¼ã€‚è¿™ä½¿å¾—ä»£ç æ›´åŠ ç®€æ´ï¼Œä¹Ÿæ›´ç¬¦åˆåç¨‹çš„ä½¿ç”¨åœºæ™¯ã€‚\nå·®ä¸å¤šèƒ½æƒ³åˆ°çš„å°±æ˜¯è¿™äº›äº†ï¼Œå½“ç„¶è¿™åªæ˜¯C++åç¨‹ä¸­çš„ä¹ç‰›ä¸€æ¯›ï¼Œæƒ³è¦æ›´æ·±å…¥äº†è§£åç¨‹çš„ä½¿ç”¨ï¼Œè¿˜è¦é€šè¿‡æ›´å¤šçš„ä¾‹å­æ¥å®è·µã€‚\nä¸‹æœŸå°†ä½¿ç”¨ io_uring + åç¨‹æ¥å®ç°çœŸæ­£çš„å¼‚æ­¥IOæ“ä½œã€‚å‘æŒ¥å‡ºåç¨‹çš„ä¼˜åŠ¿ã€‚\nåç¨‹+io_uringçš„æ–‡ç« æ¥äº† ä¼ é€é—¨\n","date":"2025-08-17T20:19:20+08:00","image":"https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/6271dad17bae0c4a3d2fd061106001be135c745e.jpg","permalink":"https://lqxhub.github.io/posts/541b707d/","title":"C++20åç¨‹ï¼Œå…¥é—¨ï¼ŒåŸºç¡€ï¼Œå¼‚æ­¥ - QX's blog"},{"content":"ä¸Šä¸€ç¯‡æ–‡ç« ã€ŠC++å˜é‡ç”Ÿå‘½å‘¨æœŸã€‹ä¸­æåˆ°äº†C++ä¸­å˜é‡çš„ç”Ÿå‘½å‘¨æœŸä¸ä½œç”¨åŸŸæ˜¯æœ‰å·®åˆ«çš„ï¼Œå…¶ä¸­æåˆ°äº† å·¦å€¼ å’Œ å³å€¼ è¿™ä¸¤ä¸ªæ¦‚å¿µï¼Œå¼•ç”³å‡ºæ¥äº† å·¦å€¼å¼•ç”¨ å’Œ å³å€¼å¼•ç”¨ è¿™ä¸¤ä¸ªä¸œè¥¿ï¼Œä¸Šæ¬¡å› ä¸ºç¯‡å¹…é—®é¢˜ï¼Œåªæ˜¯ç®€å•è¯´äº†ä¸€ä¸‹å·¦å€¼å’Œå³å€¼çš„ä¸€äº›åŒºåˆ«ï¼Œç”Ÿå‘½å‘¨æœŸå’Œç®€å•ç”¨æ³•ï¼Œæ²¡æœ‰è¯¦ç»†å±•å¼€ã€‚è¿™æ¬¡è®¨è®ºä¸€ä¸‹å³å€¼å¼•ç”¨çš„ä¸€äº›å¸¸è§é—®é¢˜å’Œä½¿ç”¨ã€‚\nmove åœ¨C++11ä¸­ï¼ŒåŠ å…¥äº† std::move å‡½æ•°ï¼Œå®ç°äº†ç§»åŠ¨è¯­ä¹‰ï¼Œæœ‰äº† moveå‡½æ•°åï¼Œå¯ä»¥å®ç°é«˜æ•ˆçš„èµ„æºè½¬ç§»ï¼Œä¸å¿…åƒä¼ ç»Ÿçš„å¤åˆ¶é‚£æ · â€˜ç¬¨é‡â€™ã€‚\nmoveä¾‹å­ å…ˆæ¥ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¥çœ‹ä¸€ä¸‹ move å‡½æ•°çš„é­…åŠ›\n1#include \u0026lt;iostream\u0026gt; 2#include \u0026lt;utility\u0026gt; 3#include \u0026lt;vector\u0026gt; 4 5class MyClass { 6public: 7 MyClass(int value) : value_(value) { 8 std::cout \u0026lt;\u0026lt; \u0026#34;Constructing MyClass with value \u0026#34; \u0026lt;\u0026lt; value_ \u0026lt;\u0026lt; std::endl; 9 } 10 11 MyClass(const MyClass\u0026amp; other) : value_(other.value_) { 12 std::cout \u0026lt;\u0026lt; \u0026#34;Copy constructing MyClass with value \u0026#34; \u0026lt;\u0026lt; value_ \u0026lt;\u0026lt; std::endl; 13 } 14 15 MyClass(MyClass\u0026amp;\u0026amp; other) noexcept : value_(other.value_) { 16 other.value_ = 0; 17 std::cout \u0026lt;\u0026lt; \u0026#34;Move constructing MyClass with value \u0026#34; \u0026lt;\u0026lt; value_ \u0026lt;\u0026lt; std::endl; 18 } 19 20 MyClass\u0026amp; operator=(const MyClass\u0026amp; other) { 21 if (this != \u0026amp;other) { 22 value_ = other.value_; 23 std::cout \u0026lt;\u0026lt; \u0026#34;Copy assigning MyClass with value \u0026#34; \u0026lt;\u0026lt; value_ \u0026lt;\u0026lt; std::endl; 24 } 25 return *this; 26 } 27 28 MyClass\u0026amp; operator=(MyClass\u0026amp;\u0026amp; other) noexcept { 29 if (this != \u0026amp;other) { 30 value_ = other.value_; 31 other.value_ = 0; 32 std::cout \u0026lt;\u0026lt; \u0026#34;Move assigning MyClass with value \u0026#34; \u0026lt;\u0026lt; value_ \u0026lt;\u0026lt; std::endl; 33 } 34 return *this; 35 } 36 37 int getValue() const { 38 return value_; 39 } 40 41private: 42 int value_; 43}; 44 45int main() { 46 MyClass a(10); 47 MyClass b = std::move(a); 48 MyClass c = b; 49 50 std::cout\u0026lt;\u0026lt;\u0026#34;----------------------------\u0026#34;\u0026lt;\u0026lt;std::endl; 51 52 std::cout \u0026lt;\u0026lt; \u0026#34;Value of a after move: \u0026#34; \u0026lt;\u0026lt; a.getValue() \u0026lt;\u0026lt; std::endl; 53 std::cout \u0026lt;\u0026lt; \u0026#34;Value of b after move: \u0026#34; \u0026lt;\u0026lt; b.getValue() \u0026lt;\u0026lt; std::endl; 54 55 std::cout\u0026lt;\u0026lt;\u0026#34;----------------------------\u0026#34;\u0026lt;\u0026lt;std::endl; 56 std::vector\u0026lt;MyClass\u0026gt; vec; 57 vec.push_back(MyClass(20)); 58 std::cout\u0026lt;\u0026lt;\u0026#34;----------------------------\u0026#34;\u0026lt;\u0026lt;std::endl; 59 vec.push_back(std::move(b)); 60 61 return 0; 62} è¿™æ®µä»£ç æ‰§è¡Œçš„ç»“æœ\n1Constructing MyClass with value 10 2Move constructing MyClass with value 10 3Copy constructing MyClass with value 10 4---------------------------- 5Value of a after move: 0 6Value of b after move: 10 7---------------------------- 8Constructing MyClass with value 20 9Move constructing MyClass with value 20 10---------------------------- 11Move constructing MyClass with value 10 12Move constructing MyClass with value 20 é€šè¿‡ä»£ç æ‰§è¡Œçš„ç»“æœå¯ä»¥çœ‹åˆ°ï¼Œ\nåœ¨ä»£ç  MyClass a(10); ä¸­ï¼Œåˆå§‹åŒ–å˜é‡ a è°ƒç”¨äº†æ„é€ å‡½æ•°ã€‚\nåœ¨ä»£ç  MyClass b = std::move(a); ä¸­ï¼Œåˆå§‹åŒ–å˜é‡ b è°ƒç”¨äº†ç§»åŠ¨æ„é€ å‡½æ•°ã€‚\nåœ¨ä»£ç  MyClass c = b; ä¸­ï¼Œåˆå§‹åŒ–å˜é‡ c è°ƒç”¨äº†æ‹·è´æ„é€ å‡½æ•°ã€‚\nåœ¨ä»£ç  vec.push_back(MyClass(20)); ä¸­ï¼Œå¯¹åº”çš„ä¸¤è¡Œè¾“å‡º\n1Constructing MyClass with value 20 2Move constructing MyClass with value 20 MyClass(20) æ„é€ ä¸€ä¸ªä¸´æ—¶å¯¹è±¡ è°ƒç”¨ç§»åŠ¨æ„é€ å‡½æ•°ï¼Œè¿™ä¸ªä¸´æ—¶å¯¹è±¡ä¼ å…¥åˆ° vec ä¸­ åœ¨ä»£ç  vec.push_back(std::move(b));ä¸­ï¼Œå¯¹åº”çš„ä¸€è¡Œè¾“å‡º\n1Move constructing MyClass with value 10 å› ä¸ºæ˜¯ä½¿ç”¨çš„ std::move å‡½æ•°ï¼Œæ‰€ä»¥ç›´æ¥é€šè¿‡ç§»åŠ¨æ„é€ å‡½æ•°æŠŠå€¼æ”¾åˆ° vec ä¸­\næœ€åä¸€è¡Œ Move constructing MyClass with value 20 è¾“å‡ºæ˜¯å› ä¸ºåœ¨ vec.push_back(std::move(b));æ—¶ï¼Œvec å‘ç”Ÿäº†æ‰©å®¹ï¼ŒMyClass(20) è¿™ä¸ªå¯¹è±¡å‘ç”Ÿäº†ä¸€æ¬¡ç§»åŠ¨ã€‚\nçœ‹åˆ°è¿™é‡Œï¼Œå¤§æ¦‚èƒ½å¯¹ move å‡½æ•°æœ‰å¤§æ¦‚çš„äº†è§£äº†ã€‚å¯èƒ½ä¹Ÿä¼šäº§ç”Ÿä¸€ä¸ªç–‘é—®ï¼Œä¸ºä»€ä¹ˆè¦ä½¿ç”¨move å‡½æ•°å‘¢ï¼Ÿ\né¦–å…ˆæˆ‘ä»¬è¦æ˜ç¡®ä¸€ä¸ªç‚¹ï¼Œåœ¨C++ä¸­ï¼Œå˜é‡çš„èµ‹å€¼é»˜è®¤éƒ½æ˜¯æ‹·è´è¡Œä¸ºã€‚æ‰€è°“çš„å¼•ç”¨ä¼ é€’å‚æ•°ï¼Œä¸è¿‡æ˜¯ç¼–è¯‘å™¨å®ç°çš„ä¸€ç§æŒ‡é’ˆï¼Œæœ¬è´¨æ˜¯å¯¹å†…å­˜åœ°å€çš„ä¸€æ¬¡æ‹·è´ã€‚\næ‹·è´ä¼šå¸¦æ¥ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿå…¶ä¸­ä¸€ä¸ªé—®é¢˜å°±æ˜¯ï¼Œåœ¨ä¼ é€’å¤§çš„å¯¹è±¡æ—¶ï¼Œéœ€è¦æŠŠå¯¹è±¡çš„æˆå‘˜å˜é‡éƒ½å¤åˆ¶ä¸€æ¬¡ã€‚ä¸Šé¢ä¾‹å­ä¸­çš„ MyClass ä¸­åªæœ‰ä¸€ä¸ª int value_ ç±»å‹çš„æˆå‘˜å˜é‡å¼€é”€æ¯”è¾ƒå°ï¼Œå¦‚æœæˆå‘˜å˜é‡å¾ˆå¤šï¼Œè€Œä¸”ç±»å‹å¤æ‚ï¼Œé‚£æ¯æ¬¡ä¼ é€’å˜é‡éƒ½å¤åˆ¶ä¸€æ¬¡ï¼Œè¿™ä¸ªå¼€é”€å°±ä¸èƒ½å¿½è§†äº†ã€‚\nmoveåˆ†æ å›åˆ° move å‡½æ•°ï¼Œç§»åŠ¨è¯­ä¹‰å…è®¸å°†èµ„æºçš„ æ‰€æœ‰æƒ ä»ä¸€ä¸ªå¯¹è±¡è½¬ç§»åˆ°å¦ä¸€ä¸ªå¯¹è±¡ï¼Œè€Œæ— éœ€æ·±æ‹·è´ã€‚\nçœ‹åˆ°è¿™é‡Œï¼Œæ˜¯å¦å¥½å¥‡ move å‡½æ•°ä¸ºä»€ä¹ˆæœ‰å¦‚æ­¤é­”åŠ›ï¼Œæ˜¯æ€æ ·å®ç°çš„å‘¢\nä¸‹é¢å°±æ˜¯ move å‡½æ•°çš„å¸¸è§å®ç°æ–¹å¼\n1template\u0026lt;typename T\u0026gt; 2typename std::remove_reference\u0026lt;T\u0026gt;::type\u0026amp;\u0026amp; move(T\u0026amp;\u0026amp; t) { 3 return static_cast\u0026lt;typename std::remove_reference\u0026lt;T\u0026gt;::type\u0026amp;\u0026amp;\u0026gt;(t); 4} çœ‹ç€æŒºå¤æ‚çš„ï¼Œå¯ä»¥å°†è¿™æ®µä»£ç ç®€åŒ–ä¸€ä¸‹ï¼Œç®€åŒ–åå¤§æ¦‚å°±æ˜¯è¿™ä¸ªæ ·å­\n1template \u0026lt;typename T\u0026gt; 2T \u0026amp;\u0026amp;move(T \u0026amp;t) { 3 return static_cast\u0026lt;T \u0026amp;\u0026amp;\u0026gt;(t); 4} è¿™æ ·çœ‹ä¸‹æ¥ï¼Œmove å‡½æ•°å…¶å®å°±åšäº†ä¸€ä»¶äº‹ æ¥å—ä¸€ä¸ªé€šç”¨å¼•ç”¨(T\u0026amp;\u0026amp;)ï¼Œç„¶åé€šè¿‡ static_cast å°†å…¶è½¬æ¢ä¸ºå³å€¼å¼•ç”¨\nmove çš„æœ¬æ„æ˜¯æå‰è®©ä¸€ä¸ªå¯¹è±¡â€œå°†äº¡â€ï¼Œç„¶åæŠŠæ§åˆ¶æƒâ€œç§»äº¤â€ç»™å³å€¼å¼•ç”¨ï¼Œæ‰€ä»¥æ‰å«moveï¼Œä¹Ÿå°±æ˜¯â€œç§»åŠ¨è¯­ä¹‰â€ã€‚ä½†æ˜¯ï¼ŒC++å¹¶ä¸èƒ½çœŸæ­£è®©ä¸€ä¸ªå¯¹è±¡æå‰â€œäº¡â€ï¼Œæ‰€ä»¥è¿™é‡Œçš„â€œç§»åŠ¨â€ä»…ä»…æ˜¯â€œè¯­ä¹‰â€ä¸Šçš„ï¼Œå¹¶ä¸æ˜¯å®é™…çš„ã€‚åªæ˜¯å‘Šè¯‰ç¼–è¯‘å™¨ï¼Œè¿™ä¸ªå¯¹è±¡æˆ‘ä¸éœ€è¦äº†ï¼Œå¯ä»¥ç»‘å®šåˆ°å³å€¼å¼•ç”¨ä¸Šäº†ã€‚\næœ‰ä¸ªç‚¹éœ€è¦æ³¨æ„ä¸€ä¸‹ï¼Œç§»åŠ¨æ„é€ å‡½æ•°éœ€è¦åŠ ä¸Š noexcept è™½ç„¶ä¸åŠ ä¹Ÿèƒ½æ­£å¸¸æ‰§è¡Œï¼Œä½†æ˜¯åœ¨ä½¿ç”¨å®¹å™¨ç­‰ STL åº“æ—¶ï¼Œå¦‚æœå¯¹è±¡çš„ ç§»åŠ¨æ„é€ å‡½æ•°æ²¡æœ‰ å£°æ˜ä¸º noexcept å¯èƒ½ä¼šå¯¼è‡´ä¸ä¼šä½¿ç”¨ç§»åŠ¨æ„é€ ï¼Œè€Œæ˜¯ä½¿ç”¨æ‹·è´æ„é€ ã€‚\nå†è®¨è®ºä¸€ä¸‹ä¸Šæ–‡ä¸­æåˆ°çš„ æ‰€æœ‰æƒï¼Œè¿™ä¸ªæ¦‚å¿µæˆ‘æœ€æ—©æ˜¯ä» rust ä¸­äº†è§£åˆ°çš„ï¼Œåæ¥åœ¨C++ä¸­ï¼Œä½¿ç”¨ std::unique_ptr æ™ºèƒ½æŒ‡é’ˆçš„æ—¶å€™ï¼Œé€æ¸å¯¹æ‰€æœ‰æƒè¿™ä¸ªæ¦‚å¿µæœ‰äº†ä¸€äº›ç†è§£ã€‚\nä¹¦æ¥ä¸Šé¢çš„ä¾‹å­\n1void func1(std::unique_ptr\u0026lt;MyClass\u0026gt; ptr) 2{ 3} 4 5void func2(std::unique_ptr\u0026lt;MyClass\u0026gt;\u0026amp; ptr) 6{ 7} 8 9int main() { 10 std::unique_ptr\u0026lt;MyClass\u0026gt; ptr1 = std::make_unique\u0026lt;MyClass\u0026gt;(30); 11 auto ptr2 = ptr1; //ç¼–è¯‘æŠ¥é”™ 12 func1(ptr1); //ç¼–è¯‘æŠ¥é”™ 13 14 auto ptr3 = std::move(ptr1); 15 func2(ptr3); 16 func1(std::move(ptr2)); 17} ptr1 è¿™ä¸ªæ™ºèƒ½æŒ‡é’ˆæ‹¥æœ‰è¯¥å¯¹è±¡çš„æ‰€æœ‰æƒï¼Œå¦‚æœå°è¯•å°†è¿™ä¸ªæŒ‡é’ˆå¤åˆ¶ç»™ ptr2 è¿™ä¸ªæŒ‡é’ˆé‚£ä¹ˆç¼–è¯‘å™¨ä¼šæŠ¥é”™ï¼Œå› ä¸º std::unique_ptr ç±»å‹çš„æŒ‡é’ˆåªå…è®¸ä¸€ä¸ªæŒ‡é’ˆå¯¹è±¡æŒæœ‰ MyClass è¿™ä¸ªå¯¹è±¡çš„æ‰€æœ‰æƒã€‚å¤åˆ¶è¡Œä¸ºæ˜¯å°†æ‰€æœ‰æƒå…±äº«ï¼Œæ‰€ä»¥ä¼šæç¤ºé”™è¯¯ã€‚\nèƒ½åšåˆ°åªèƒ½æ˜¯å°†æ‰€æœ‰æƒè½¬ç§»ï¼Œä¹Ÿå°±æ˜¯ ptr1 æŒ‡é’ˆæ”¾å¼ƒæ‰€æœ‰æƒï¼Œå°†æ‰€æœ‰æƒäº¤ç»™ ptr3 è¿™ä¸ªæŒ‡é’ˆã€‚åŒæ ·çš„ï¼Œåœ¨ä½œä¸ºå‡½æ•°çš„å‚æ•°ä¼ é€’æ—¶ï¼Œä¹Ÿæ˜¯åŒæ ·çš„é“ç†ï¼Œä½œä¸º func1 å‡½æ•°çš„å‚æ•°æ—¶ï¼Œåªèƒ½ä½¿ç”¨ moveï¼Œå°†æ‰€æœ‰æƒè½¬ç§»ã€‚\nè¿˜æœ‰ä¸€ç§æ–¹å¼ï¼Œå€Ÿï¼Œåœ¨å‡½æ•° func2 ä¸­ï¼Œå¯ä»¥ä½¿ç”¨å¼•ç”¨çš„æ–¹å¼ï¼Œå°†æ‰€æœ‰æƒæš‚æ—¶ â€˜å€Ÿâ€™ ç»™ func2 ä¸­çš„å˜é‡ä½¿ç”¨ï¼Œä½†æ˜¯æ‰€æœ‰æƒè¿˜åœ¨åŸæ¥çš„æ‰€æœ‰è€…é‚£é‡Œã€‚\nmoveå‡½æ•°çš„ä¼˜å…ˆçº§ å¦‚æœä¸€ä¸ª class å®ç°äº† ç§»åŠ¨æ„é€ å‡½æ•°ï¼Œåœ¨èµ‹å€¼æ—¶ï¼Œæ˜¯å¦ä¸€å®šä¼šä½¿ç”¨ move å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ä¸ä¸€å®šï¼Œæ˜¯å¦ä¼˜å…ˆä½¿ç”¨ç§»åŠ¨æ„é€ å‡½æ•°å–å†³äºå…·ä½“çš„æƒ…å¢ƒã€‚\nå…ˆæ¥çœ‹ä¸€ä¸‹ æ‹·è´æ„é€ å‡½æ•° å’Œ ç§»åŠ¨æ„é€ å‡½æ•° çš„ç­¾å\n1MyClass(const MyClass\u0026amp; other);//æ‹·è´æ„é€  2MyClass(MyClass\u0026amp;\u0026amp; other) noexcept;//ç§»åŠ¨æ„é€  å¯ä»¥çœ‹åˆ°ï¼Œç§»åŠ¨æ„é€ å‡½æ•°çš„å‚æ•°ç±»å‹æ˜¯ å³å€¼å¼•ç”¨ã€‚\nä¹Ÿå°±æ˜¯è¯´ï¼Œä¼˜å…ˆçº§è§„åˆ™æ˜¯è¿™æ ·çš„\nå¦‚æœå®å‚æ˜¯ å·¦å€¼ï¼Œç¼–è¯‘å™¨ä¼šè°ƒç”¨æ‹·è´æ„é€ å‡½æ•° å¦‚æœå®å‚æ˜¯ å³å€¼ï¼Œå¹¶ä¸”å­˜åœ¨ç§»åŠ¨æ„é€ å‡½æ•°ï¼Œç¼–è¯‘å™¨ä¼šä¼˜å…ˆè°ƒç”¨ç§»åŠ¨æ„é€ å‡½æ•° ä½†è¿™é‡Œçš„å…³é”®æ˜¯ï¼šå¤åˆ¶ è¿™ä¸ªè¡Œä¸ºæ˜¯å¦æ¶‰åŠå³å€¼ã€‚å¦‚æœä»£ç æ²¡æœ‰æ˜¾å¼åœ°å°†å¯¹è±¡æ ‡è®°ä¸ºå³å€¼ï¼ˆæ¯”å¦‚ä½¿ç”¨ std::moveï¼‰ï¼Œå³ä½¿æœ‰ç§»åŠ¨æ„é€ å‡½æ•°ï¼Œä¹Ÿä¸ä¼šè¢«è°ƒç”¨ã€‚\nä½¿ç”¨moveæ³¨æ„äº‹é¡¹ ç§»åŠ¨åå¯¹è±¡çš„çŠ¶æ€ï¼šè°ƒç”¨ std::move åï¼Œæºå¯¹è±¡å¹¶æ²¡æœ‰è¢«é”€æ¯ï¼Œä½†å®ƒå¤„äºä¸€ä¸ªâ€œæœ‰æ•ˆä½†æœªæŒ‡å®šâ€çš„çŠ¶æ€ï¼ˆvalid but unspecified stateï¼‰ã€‚æ¯”å¦‚å¯¹äº std::stringï¼Œå®ƒå¯èƒ½å˜ä¸ºç©ºå­—ç¬¦ä¸²ï¼Œä½†å…·ä½“å–å†³äºç±»çš„å®ç°ã€‚\nä¸ä¿è¯ç§»åŠ¨ï¼šstd::move åªæ˜¯è¯·æ±‚ç§»åŠ¨ï¼Œèƒ½å¦çœŸæ­£ç§»åŠ¨å–å†³äºç›®æ ‡ç±»å‹æ˜¯å¦å®ç°äº†ç§»åŠ¨æ„é€ å‡½æ•°æˆ–ç§»åŠ¨èµ‹å€¼è¿ç®—ç¬¦ã€‚å¦‚æœæ²¡æœ‰ï¼Œç¼–è¯‘å™¨ä¼šå›é€€åˆ°æ‹·è´ã€‚\nä¸è¦æ»¥ç”¨ï¼šåªæœ‰å½“ä½ ç¡®å®šæŸä¸ªå¯¹è±¡ä¸å†éœ€è¦æ—¶ï¼Œæ‰åº”è¯¥ä½¿ç”¨ std::moveã€‚\nforward è¯´å®Œäº† std::move é‚£å°±ä¸å¾—ä¸æ std::forward äº†ã€‚forwardä¹Ÿå« å®Œç¾è½¬å‘\nå’Œ move ä¸åŒçš„åœ°æ–¹ï¼Œforward å¸¸ç”¨åœ¨æ¨¡æ¿ç¼–ç¨‹ä¸­ï¼Œä»¥ç¡®ä¿å‚æ•°èƒ½å¤ŸæŒ‰ç…§åŸå§‹å€¼ç±»åˆ«ï¼ˆå·¦å€¼æˆ–å³å€¼ï¼‰ä¼ é€’ç»™ä¸‹ä¸€ä¸ªå‡½æ•°ï¼Œè€Œä¸ä¼šä¸¢å¤±å…¶å±æ€§ã€‚åœ¨æ¨¡æ¿ç¼–ç¨‹ä¸­ï¼Œä¸€èˆ¬éƒ½æ˜¯å¸Œæœ›å°†å‚æ•°ä¼ é€’ç»™å¦ä¸€ä¸ªå‡½æ•°æ—¶ï¼Œä¿ç•™å‚æ•°çš„åŸå§‹å€¼ç±»å‹ã€‚ ä½†æ˜¯ std::move æ€»æ˜¯å°†å¯¹è±¡æ— æ¡ä»¶è½¬æ¢ä¸ºå³å€¼ï¼Œè€Œ std::forward åˆ™æ ¹æ®å‚æ•°çš„åŸå§‹ç±»å‹æœ‰æ¡ä»¶åœ°è¿›è¡Œè½¬å‘ã€‚\nå¦‚æœä¼ å…¥çš„æ˜¯ å·¦å€¼ï¼Œåˆ™ä»¥å·¦å€¼çš„å½¢å¼è½¬å‘ã€‚ å¦‚æœä¼ å…¥çš„æ˜¯ å³å€¼ï¼Œåˆ™ä»¥å³å€¼çš„å½¢å¼è½¬å‘ã€‚ forwardä¾‹å­ é€šè¿‡ä¸€ä¸ªç®€å•çš„ä¾‹å­çœ‹ä¸€ä¸‹ï¼š\n1#include \u0026lt;iostream\u0026gt; 2 3void process(int\u0026amp; x) { std::cout \u0026lt;\u0026lt; \u0026#34;Lvalue: \u0026#34; \u0026lt;\u0026lt; x \u0026lt;\u0026lt; \u0026#34;\\n\u0026#34;; } 4void process(int\u0026amp;\u0026amp; x) { std::cout \u0026lt;\u0026lt; \u0026#34;Rvalue: \u0026#34; \u0026lt;\u0026lt; x \u0026lt;\u0026lt; \u0026#34;\\n\u0026#34;; } 5 6template\u0026lt;typename T\u0026gt; 7void forwarder(T\u0026amp;\u0026amp; arg) { 8 process(arg); // ç›´æ¥ä¼ é€’ arg 9} 10 11int main() { 12 int a = 42; 13 forwarder(a); // ä¼ å…¥å·¦å€¼ 14 forwarder(100); // ä¼ å…¥å³å€¼ 15 return 0; 16} æ‰§è¡Œç»“æœ:\n1Lvalue: 42 2Lvalue: 100 a æ˜¯å·¦å€¼ï¼Œè½¬å‘ä¸ºå·¦å€¼ï¼Œè°ƒç”¨ process(int\u0026amp;) 100 æ˜¯å³å€¼ï¼Œè½¬å‘ä¸ºå³å€¼ï¼Œè°ƒç”¨ process(int\u0026amp;\u0026amp;) process å‡½æ•°æœ‰ä¸¤ä¸ªé‡è½½ï¼Œåˆ†åˆ«æ˜¯ å·¦å€¼å¼•ç”¨ å’Œ å³å€¼å¼•ç”¨ï¼Œforwarder å‡½æ•°å¯ä»¥æ ¹æ®ä¸åŒçš„ç±»å‹è°ƒç”¨ä¸åŒçš„ processï¼Œä¹Ÿå°±å®ç°äº† è½¬å‘\nå®ç°åŸç† std::forward çš„å®ç°ä¾èµ–äº å¼•ç”¨æŠ˜å å’Œç±»å‹æ¨å¯¼ï¼Œä¸‹é¢æ˜¯ forward å‡½æ•°å®ç°\n1template\u0026lt;typename T\u0026gt; 2T\u0026amp;\u0026amp; forward(typename std::remove_reference\u0026lt;T\u0026gt;::type\u0026amp; arg) noexcept { 3 return static_cast\u0026lt;T\u0026amp;\u0026amp;\u0026gt;(arg); 4} 5 6template\u0026lt;typename T\u0026gt; 7T\u0026amp;\u0026amp; forward(typename std::remove_reference\u0026lt;T\u0026gt;::type\u0026amp;\u0026amp; arg) noexcept { 8 return static_cast\u0026lt;T\u0026amp;\u0026amp;\u0026gt;(arg); 9} ä¼ å…¥å·¦å€¼æ—¶ï¼ŒT æ¨å¯¼ä¸º Type\u0026amp;ï¼ŒT\u0026amp;\u0026amp; æŠ˜å ä¸ºå·¦å€¼å¼•ç”¨ ä¼ å…¥å³å€¼æ—¶ï¼ŒT æ¨å¯¼ä¸º Typeï¼ŒT\u0026amp;\u0026amp; ä¿æŒä¸ºå³å€¼å¼•ç”¨ std::forward ä¸ std::move ç›¸æ¯”ï¼Œå®ƒæ›´ æ™ºèƒ½ï¼Œé€‚ç”¨äºéœ€è¦åŠ¨æ€é€‚é…å‚æ•°ç±»å‹çš„åœºæ™¯ã€‚ä¸€èˆ¬ç”¨åœ¨æ¨¡æ¿ç¼–ç¨‹ä¸­ï¼Œç¡®ä¿å‚æ•°åœ¨ä¼ é€’è¿‡ç¨‹ä¸­ä¿ç•™åŸå§‹çš„ å·¦å€¼ / å³å€¼å±æ€§ï¼Œé¿å…ä¸å¿…è¦çš„æ‹·è´ã€‚\nRVO RVOï¼ˆReturn Value Optimizationï¼Œè¿”å›å€¼ä¼˜åŒ–ï¼Œæ˜¯C++ç¼–è¯‘å™¨çš„ä¸€ç§ä¼˜åŒ–æŠ€æœ¯ï¼Œç”¨äºå‡å°‘å‡½æ•°è¿”å›å¤§å¯¹è±¡æ—¶çš„æ‹·è´å¼€é”€ã€‚åœ¨æ²¡æœ‰ RVO çš„æƒ…å†µä¸‹ï¼Œå‡½æ•°è¿”å›ä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œä¼šè°ƒç”¨æ‹·è´æ„é€ å‡½æ•°æˆ–ç§»åŠ¨æ„é€ å‡½æ•°æ¥æ„é€ è¿”å›å€¼å¯¹è±¡ã€‚RVO çš„ç›®æ ‡æ˜¯ç›´æ¥åœ¨è°ƒç”¨è€…çš„å†…å­˜ç©ºé—´ä¸­æ„é€ è¿”å›å¯¹è±¡ï¼Œä»è€Œé¿å…é¢å¤–çš„æ‹·è´æˆ–ç§»åŠ¨ã€‚\nRVO æœ‰ä¸¤ç§å½¢å¼\nNRVOï¼ˆNamed Return Value Optimizationï¼‰ï¼šé’ˆå¯¹å‘½åçš„å±€éƒ¨å˜é‡ URVOï¼ˆUnnamed Return Value Optimizationï¼‰ï¼šé’ˆå¯¹ä¸´æ—¶å¯¹è±¡ï¼ˆæœªå‘½åçš„å¯¹è±¡ï¼‰ RVOä¾‹å­ 1#include \u0026lt;iostream\u0026gt; 2 3struct MyClass { 4 MyClass() { std::cout \u0026lt;\u0026lt; \u0026#34;Constructor\\n\u0026#34;; } 5 MyClass(const MyClass\u0026amp;) { std::cout \u0026lt;\u0026lt; \u0026#34;Copy constructor\\n\u0026#34;; } 6 MyClass(MyClass\u0026amp;\u0026amp;) noexcept { std::cout \u0026lt;\u0026lt; \u0026#34;Move constructor\\n\u0026#34;; } 7 ~MyClass() { std::cout \u0026lt;\u0026lt; \u0026#34;Destructor\\n\u0026#34;; } 8}; 9 10MyClass create() { 11 MyClass obj; 12 return obj; // è¿”å›å±€éƒ¨å¯¹è±¡ 13} 14 15int main() { 16 MyClass a = create(); 17 return 0; 18} ç°åœ¨çš„ç¼–è¯‘å™¨é»˜è®¤éƒ½ä¼šå¼€å¯ RVO ä¼˜åŒ–ï¼Œæ‰€ä»¥éœ€è¦æ‰‹åŠ¨ç¦ç”¨ï¼Œåœ¨clangä¸­ï¼Œå¯ä»¥åœ¨å‘½ä»¤è¡Œä¸­æ·»åŠ  -fno-elide-constructors æ¥ç¦ç”¨ã€‚\nä½¿ç”¨ clang++ -fno-elide-constructors -o main main.cpp å‘½ä»¤æ¥ç¼–è¯‘ï¼Œç„¶åæ‰§è¡Œ mainï¼Œè¾“å‡ºå¦‚ä¸‹\n1Constructor 2Move constructor 3Destructor 4Destructor å¯ä»¥çœ‹åˆ°åœ¨ return obj æ—¶ï¼Œå› ä¸ºæ²¡æœ‰ä½¿ç”¨ RVO ä¼˜åŒ–ï¼Œæ‰€ä»¥å¤åˆ¶äº†ä¸€æ¬¡å¯¹è±¡ï¼Œä½†æ˜¯å› ä¸ºæœ‰ç§»åŠ¨æ„é€ å‡½æ•°ï¼Œæ‰€ä»¥ä½¿ç”¨äº† move ä¼˜åŒ–ã€‚\nä¸‹é¢å¼€å¯ RVO ä¼˜åŒ–çœ‹ä¸€ä¸‹\nä½¿ç”¨ clang++ -o main main.cpp å‘½ä»¤ç¼–è¯‘ï¼Œç„¶åæ‰§è¡Œ main è¾“å‡ºå¦‚ä¸‹\n1Constructor 2Destructor å¯ä»¥çœ‹åˆ°åªè°ƒç”¨äº†æ„é€ å‡½æ•°ã€‚\nå·¥ä½œåŸç† åœ¨çº¿æ±‡ç¼– ä½¿ç”¨è¿™ä¸ªå·¥å…·ï¼Œå¯ä»¥çœ‹åˆ°å…·ä½“çš„æ±‡ç¼–ä»£ç \nä¸‹é¢æ˜¯æ˜¯è®©GPTåŠ äº†æ³¨é‡Šçš„æ±‡ç¼–ä»£ç \n1create(): ; create() å‡½æ•°å®šä¹‰å¼€å§‹ 2 push rbp ; ä¿å­˜å½“å‰æ ˆå¸§åŸºå€æŒ‡é’ˆ 3 mov rbp, rsp ; å»ºç«‹æ–°çš„æ ˆå¸§ï¼Œå°†æ ˆæŒ‡é’ˆå€¼èµ‹ç»™åŸºå€æŒ‡é’ˆ 4 sub rsp, 16 ; åˆ†é…16å­—èŠ‚çš„æ ˆç©ºé—´ç”¨äºå±€éƒ¨å˜é‡ 5 mov QWORD PTR [rbp-8], rdi ; ä¿å­˜ç¬¬ä¸€ä¸ªå‚æ•°(rdi)åˆ°æ ˆä¸Š[rbp-8]ä½ç½®ï¼Œè¿™æ˜¯å¯¹è±¡æŒ‡é’ˆ 6 mov rax, QWORD PTR [rbp-8] ; å°†å¯¹è±¡æŒ‡é’ˆåŠ è½½åˆ°raxå¯„å­˜å™¨ 7 mov rdi, rax ; å°†å¯¹è±¡æŒ‡é’ˆä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°(rdi)ä¼ é€’ç»™æ„é€ å‡½æ•° 8 call MyClass::MyClass() [complete object constructor] ; è°ƒç”¨MyClassçš„æ„é€ å‡½æ•°åˆå§‹åŒ–å¯¹è±¡ 9 mov rax, QWORD PTR [rbp-8] ; å°†å¯¹è±¡æŒ‡é’ˆé‡æ–°åŠ è½½åˆ°raxä½œä¸ºå‡½æ•°è¿”å›å€¼ 10 leave ; æ¢å¤æ ˆå¸§ï¼ˆç›¸å½“äºmov rsp, rbp; pop rbpï¼‰ 11 ret ; ä»å‡½æ•°è¿”å›ï¼Œè¿”å›å€¼åœ¨raxä¸­ 12 13main: ; mainå‡½æ•°å®šä¹‰å¼€å§‹ 14 push rbp ; ä¿å­˜å½“å‰æ ˆå¸§åŸºå€æŒ‡é’ˆ 15 mov rbp, rsp ; å»ºç«‹æ–°çš„æ ˆå¸§ 16 push rbx ; ä¿å­˜rbxå¯„å­˜å™¨çš„å€¼(è°ƒç”¨è€…ä¿å­˜çš„å¯„å­˜å™¨) 17 sub rsp, 24 ; åˆ†é…24å­—èŠ‚çš„æ ˆç©ºé—´ 18 lea rax, [rbp-17] ; å°†æ ˆä¸Šåœ°å€[rbp-17]åŠ è½½åˆ°raxï¼Œè¿™æ˜¯ä¸ºMyClasså¯¹è±¡åˆ†é…çš„ç©ºé—´ 19 mov rdi, rax ; å°†å¯¹è±¡åœ°å€ä½œä¸ºå‚æ•°ä¼ é€’ç»™createå‡½æ•° 20 call create() ; è°ƒç”¨createå‡½æ•°ï¼Œåˆå§‹åŒ–å¯¹è±¡ 21 mov ebx, 0 ; å°†è¿”å›å€¼0å­˜å‚¨åˆ°ebxå¯„å­˜å™¨ 22 lea rax, [rbp-17] ; é‡æ–°åŠ è½½å¯¹è±¡åœ°å€åˆ°rax 23 mov rdi, rax ; å°†å¯¹è±¡åœ°å€ä½œä¸ºå‚æ•°ä¼ é€’ç»™ææ„å‡½æ•° 24 call MyClass::~MyClass() [complete object destructor] ; è°ƒç”¨MyClassçš„ææ„å‡½æ•°æ¸…ç†å¯¹è±¡ 25 mov eax, ebx ; å°†è¿”å›å€¼(0)ä»ebxç§»åŠ¨åˆ°eaxä½œä¸ºmainå‡½æ•°çš„è¿”å›å€¼ 26 mov rbx, QWORD PTR [rbp-8] ; æ¢å¤ä¹‹å‰ä¿å­˜çš„rbxå€¼ 27 leave ; æ¢å¤æ ˆå¸§ 28 ret ; ä»mainå‡½æ•°è¿”å›ï¼Œè¿”å›å€¼åœ¨eaxä¸­ å¯ä»¥çœ‹åˆ°å¼€å¯ ROV ä¼˜åŒ–åï¼Œç¡®å®æ˜¯å…ˆåœ¨ main å‡½æ•°çš„æ ˆç©ºé—´ å…ˆåˆå§‹åŒ– MyClass çš„å¯¹è±¡ï¼Œæ‰€ä»¥å¯ä»¥é¿å…åœ¨ return æ—¶æ‹·è´ã€‚\nRVO çš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šç¼–è¯‘å™¨åœ¨ç”Ÿæˆä»£ç æ—¶ï¼Œè¯†åˆ«å‡ºå‡½æ•°è¿”å›çš„å¯¹è±¡å¯ä»¥ç›´æ¥åœ¨è°ƒç”¨è€…çš„ç›®æ ‡ä½ç½®æ„é€ ï¼Œè€Œä¸æ˜¯å…ˆåœ¨å‡½æ•°æ ˆä¸Šæ„é€ ç„¶åæ‹·è´æˆ–ç§»åŠ¨åˆ°è°ƒç”¨è€…ã€‚\nåœ¨ C++17 ä¹‹å‰ï¼ŒRVO æ˜¯ä¸€ç§ç¼–è¯‘å™¨å¯é€‰çš„ä¼˜åŒ–ï¼Œç¨‹åºå‘˜ä¸èƒ½å®Œå…¨ä¾èµ–å®ƒã€‚ä» C++17 å¼€å§‹ï¼Œæ ‡å‡†å¯¹æŸäº›æƒ…å†µä¸‹çš„è¿”å›å€¼ä¼˜åŒ–åšäº†å¼ºåˆ¶è¦æ±‚ï¼Œç§°ä¸º Mandatory Copy Elisionï¼ˆå¼ºåˆ¶æ‹·è´æ¶ˆé™¤ï¼‰ã€‚è¿™æ„å‘³ç€åœ¨ç‰¹å®šåœºæ™¯ä¸‹ï¼Œå³ä½¿ç¦ç”¨ä¼˜åŒ–ï¼Œç¼–è¯‘å™¨ä¹Ÿå¿…é¡»æ¶ˆé™¤æ‹·è´æˆ–ç§»åŠ¨ã€‚\nRVO å’Œ std::move çš„å…³ç³» ä¸€èˆ¬æ¥è¯´ï¼Œä½¿ç”¨äº† move åå°±ä¸ä¼šå†ä½¿ç”¨ RVO äº†\n1MyClass create() { 2 MyClass obj; 3 return std::move(obj); // æ˜¾å¼ç§»åŠ¨ 4} æ”¹ä¸€ä¸‹ä¸Šé¢çš„ä¾‹å­ï¼Œå¼€å¯ ROVä¼˜åŒ–çœ‹ä¸€ä¸‹\nclang++ -O3 -o main main.cpp ç¼–è¯‘ æ‰§è¡Œ main\nè¾“å‡ºï¼š\n1Constructor 2Move constructor 3Destructor 4Destructor æ‰€ä»¥ï¼Œåœ¨ç¼–å†™ç°ä»£C++ä»£ç æ—¶ï¼Œåœ¨ return å±€éƒ¨å˜é‡æ—¶æ²¡æœ‰å¿…è¦ä½¿ç”¨ std::move,ä½¿ç”¨äº†å¤§æ¦‚ç‡ä¼šå½±å“ç¼–è¯‘å™¨ä¼˜åŒ–ï¼Œåè€Œä¼šé€‚å¾—å…¶åï¼Œæ€§èƒ½æ›´å·®äº†ã€‚\næ‰€ä»¥ç›¸ä¿¡ç¼–è¯‘å™¨ï¼Œå¾ˆå¤šæƒ…å†µä¸‹ï¼Œç¼–è¯‘å™¨ä¼šæ¯”äººæ›´ â€˜èªæ˜â€™ã€‚\næ€»ç»“ std::move ä¸ä¼šæ”¹å˜å¯¹è±¡çš„å†…å®¹(ä¸ä¼šç§»åŠ¨)ï¼Œåªæ˜¯æ¬ºéª—äº†ç¼–è¯‘å™¨ std::move åªæ˜¯è¯·æ±‚ç§»åŠ¨ï¼Œèƒ½å¦çœŸæ­£ç§»åŠ¨å–å†³äºç›®æ ‡ç±»å‹æ˜¯å¦å®ç°äº†ç§»åŠ¨æ„é€ å‡½æ•°æˆ–ç§»åŠ¨èµ‹å€¼è¿ç®—ç¬¦ã€‚å¦‚æœæ²¡æœ‰ï¼Œç¼–è¯‘å™¨ä¼šå›é€€åˆ°æ‹·è´ å·¦å€¼ï¼šè°ƒç”¨æ‹·è´æ„é€ å‡½æ•°ï¼Œå³å€¼: å¦‚æœæœ‰ç§»åŠ¨æ„é€ å‡½æ•°ï¼Œä¼˜å…ˆè°ƒç”¨ç§»åŠ¨æ„é€ å‡½æ•°ï¼›å¦åˆ™å›é€€åˆ°æ‹·è´æ„é€ å‡½æ•° std::forward æœ‰æ¡ä»¶åœ°è½¬å‘å‚æ•°ï¼Œä¿ç•™å…¶åŸå§‹å€¼ç±»åˆ«ï¼ˆå·¦å€¼æˆ–å³å€¼ï¼‰ å‡½æ•°è¿”å›ä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œé™¤ééœ€è¦æ˜¾ç¤ºè°ƒç”¨ç§»åŠ¨æˆ–è€…æ‹·è´æ„é€ ï¼Œå¦åˆ™ä¸è¦ä½¿ç”¨ std::moveï¼Œè€Œæ˜¯ä½¿ç”¨ç¼–è¯‘å™¨çš„ RVO ä¼˜åŒ– ","date":"2025-03-16T19:50:55+08:00","image":"https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/7320b79a5cd9f9ac9e07752081db9612e98ca223.jpg","permalink":"https://lqxhub.github.io/posts/14155cf4/","title":"C++ä¸­çš„ç§»åŠ¨è¯­ä¹‰ä¸å®Œç¾è½¬å‘ï¼ŒC++ä¸­çš„å³å€¼å¼•ç”¨ã€std::moveå’Œstd::forwardçš„ä½¿ç”¨æ–¹æ³•åŠå…¶å®ç°åŸç†ï¼Œç»“åˆå®ä¾‹è®²è§£RVO"},{"content":"åœ¨C++11åŠä»¥åçš„ç‰ˆæœ¬ä¸­ï¼Œå¯ä»¥å°†å˜é‡ç®€å•çš„åˆ†ä¸ºå·¦å€¼ï¼Œå³å€¼ã€‚å…¶ä¸­å³å€¼åˆå¯ä»¥åˆ†ä¸ºçº¯å³å€¼å’Œå°†äº¡å€¼ã€‚ ä¸åŒç±»å‹çš„å˜é‡çš„ç”Ÿå‘½å‘¨æœŸä¸ä½œç”¨åŸŸä¹Ÿæ˜¯æœ‰å·®åˆ«çš„ï¼Œè¿™æ¬¡å°±æ¥æµ…è°ˆä¸€ä¸‹C++ä¸­å˜é‡çš„ç”Ÿå‘½å‘¨æœŸã€‚\näº‹æƒ…çš„èµ·å› æ˜¯æœ€è¿‘åœ¨ä¿®ä¸€ä¸ªC++çš„bugæ—¶ï¼Œå‘ç°æ˜¯å› ä¸ºå˜é‡çš„ç”Ÿå‘½å‘¨æœŸé—®é¢˜å¯¼è‡´çš„ï¼Œæ‰€ä»¥å°±æ¥æ€»ç»“ä¸€ä¸‹ã€‚\næäº¤çš„PR\nä»£ç ä½ç½®\nbugåˆ†æ æœ‰bugçš„ä»£ç å¦‚ä¸‹ï¼š\n1HashesMetaValue tmf_meta_value2(DataType::kHashes, std::string(str, sizeof(int32_t))); 1using HashesMetaValue = BaseMetaValue; 2 3class BaseMetaValue : public InternalValue { 4 public: 5 explicit BaseMetaValue(DataType type, const Slice\u0026amp; user_value) : InternalValue(type, user_value) {} 6 ................... 7}; å¯ä»¥çœ‹åˆ°ï¼ŒBaseMetaValueçš„æ„é€ å‡½æ•°æ¥å—çš„æ˜¯const Slice\u0026amp;ç±»å‹çš„å‚æ•°ï¼Œ è€Œstd::string(str, sizeof(int32_t))æ˜¯ä¸€ä¸ªä¸´æ—¶å˜é‡ï¼Œæ˜¯ä¸€ä¸ªå³å€¼(å°†äº¡å€¼)ï¼Œ æ‰€ä»¥è¿™ä¸ªä¸´æ—¶å˜é‡çš„ç”Ÿå‘½å‘¨æœŸåªåœ¨è¿™ä¸€è¡Œä»£ç ä¸­ï¼Œå½“è¿™ä¸€è¡Œä»£ç æ‰§è¡Œå®Œåï¼Œè¿™ä¸ªä¸´æ—¶å˜é‡å°±ä¼šè¢«é”€æ¯ï¼Œ æ‰€ä»¥tmf_meta_value2çš„user_valueå°±æ˜¯ä¸€ä¸ªæ‚¬ç©ºæŒ‡é’ˆï¼Œæ‰€ä»¥åœ¨åé¢çš„ä»£ç ä¸­å°±ä¼šå‡ºç°é—®é¢˜ã€‚\nSlice æ˜¯ä¸€ä¸ªç±»ä¼¼äºstd::string_viewçš„ç±»ï¼ŒSliceä¸æ‹¥æœ‰æ•°æ®ï¼Œåªæ˜¯ä¸€ä¸ªæŒ‡å‘æ•°æ®çš„æŒ‡é’ˆã€‚æ‰€ä»¥å¿…é¡»ç”±è°ƒç”¨è€…ä¿è¯æ•°æ®çš„ç”Ÿå‘½å‘¨æœŸã€‚\nè§£å†³æ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼Œå°†BaseMetaValueçš„æ„é€ å‡½æ•°æ”¹ä¸ºæ¥å—std::stringç±»å‹çš„å‚æ•°å³å¯ã€‚\n1auto key = std::string(str, sizeof(int32_t)); 2HashesMetaValue tmf_meta_value1(DataType::kHashes, key); è¿™æ ·keyå°±æ˜¯ä¸€ä¸ªå·¦å€¼ï¼Œç”Ÿå‘½å‘¨æœŸä¼šæŒç»­åˆ°tmf_meta_value1çš„ç”Ÿå‘½å‘¨æœŸç»“æŸã€‚æ‰€ä»¥å°±ä¸ä¼šå‡ºç°æ‚¬ç©ºæŒ‡é’ˆçš„é—®é¢˜äº†ã€‚\nC++ä¸­æ²¡æœ‰ä¸¥æ ¼é™åˆ¶å˜é‡çš„ç”Ÿå‘½å‘¨æœŸï¼Œæˆ‘æ²¡æœ‰ç³»ç»Ÿçš„å­¦ä¹ è¿‡rustï¼Œä½†æ˜¯äº†è§£è¿‡rustçš„ä¸€äº›æ¦‚å¿µï¼Œrustä¸­æœ‰ä¸¥æ ¼çš„ç”Ÿå‘½å‘¨æœŸæ£€æŸ¥ï¼Œè¿™æ ·å°±å¯ä»¥é¿å…å¾ˆå¤šæ‚¬ç©ºæŒ‡é’ˆçš„é—®é¢˜ï¼Œ ä¸Šè¿°çš„bugåœ¨rustä¸­æ˜¯ä¸ä¼šå‡ºç°çš„ã€‚å› ä¸ºrustä¸­æœ‰ä¸¥æ ¼çš„å˜é‡æ‰€æœ‰æƒçš„ï¼Œç”Ÿå‘½å‘¨æœŸæ£€æŸ¥ã€‚ æ‰€æœ‰æƒ è¿™ä¸ªæ¦‚å¿µåœ¨rustä¸­æ˜¯éå¸¸é‡è¦ï¼Œæˆ‘è§‰å¾—è¿™ä¸ªæ¦‚å¿µåœ¨C++ä¸­ä¹Ÿæ˜¯å¾ˆé‡è¦çš„ï¼Œ æƒ³è¦å†™å‡ºé«˜è´¨é‡çš„ä»£ç ï¼Œå°±éœ€è¦äº†è§£è¿™æ‰€æœ‰æƒè¿™ä¸ªæ¦‚å¿µã€‚\nå·¦å€¼ã€å³å€¼ å·¦å€¼ æœ€ç®€å•çš„ä¸€ä¸ªä¾‹å­å°±æ˜¯å˜é‡ï¼Œå˜é‡æ˜¯ä¸€ä¸ªå·¦å€¼ï¼Œå®ƒæœ‰ä¸€ä¸ªå†…å­˜åœ°å€ï¼Œå¯ä»¥å–åœ°å€ï¼Œå¯ä»¥ä¿®æ”¹ã€‚\n1int a = 10; // a æ˜¯å·¦å€¼ 2int* p = \u0026amp;a; // å¯ä»¥å– a çš„åœ°å€ 3a = 20; // a å¯ä»¥è¢«èµ‹å€¼ å³å€¼ å³å€¼æ˜¯æŒ‡ä¸èƒ½å–åœ°å€çš„ä¸´æ—¶å¯¹è±¡æˆ–å€¼ï¼Œé€šå¸¸æ˜¯çŸ­æš‚å­˜åœ¨çš„ï¼ˆephemeralï¼‰ï¼Œæ— æ³•å‡ºç°åœ¨èµ‹å€¼è¯­å¥çš„å·¦ä¾§ã€‚\n1int b = 5 + 3; // 5 + 3 æ˜¯å³å€¼ï¼ˆçº¯å³å€¼ï¼‰ å…¶ä¸­å³å€¼åˆå¯ä»¥åˆ†ä¸ºçº¯å³å€¼å’Œå°†äº¡å€¼ã€‚\nçº¯å³å€¼ ç‰¹æ€§ï¼šæ²¡æœ‰èº«ä»½ï¼Œæ— æ³•å–åœ°å€ï¼Œæ— æ³•è¢«èµ‹å€¼\nå¸¸è§çš„ å­—é¢é‡ã€ä¸´æ—¶å¯¹è±¡ã€å‡½æ•°è¿”å›å€¼\n142; // å­—é¢é‡æ˜¯çº¯å³å€¼ 25 + 3; // è®¡ç®—ç»“æœæ˜¯çº¯å³å€¼ 3std::string(\u0026#34;hello\u0026#34;); // æ„é€ å‡½æ•°è¿”å›çš„ä¸´æ—¶å¯¹è±¡æ˜¯çº¯å³å€¼ å°†äº¡å€¼ å°†äº¡å€¼æ˜¯â€œå³å°†æ¶ˆäº¡çš„å€¼â€ï¼Œé€šå¸¸æ˜¯é€šè¿‡å³å€¼å¼•ç”¨ç»‘å®šåˆ°çš„ä¸´æ—¶å¯¹è±¡ï¼Œæˆ–è€…è¢«æ˜¾å¼ç§»åŠ¨ï¼ˆmoveï¼‰çš„å¯¹è±¡ã€‚\nç‰¹æ€§ï¼šæœ‰èº«ä»½ï¼ˆå¯ä»¥å–åœ°å€ï¼‰ï¼Œä½†ç”Ÿå‘½å‘¨æœŸå³å°†ç»“æŸ\né€šå¸¸å‡ºç°åœ¨ä½¿ç”¨ std::move æˆ–å‡½æ•°è¿”å›å³å€¼å¼•ç”¨çš„åœºæ™¯\n1#include \u0026lt;utility\u0026gt; 2int\u0026amp;\u0026amp; getRvalue() { return 42; } 3int main() { 4 int a = 10; 5 int\u0026amp;\u0026amp; r1 = std::move(a); // std::move(a) æ˜¯å°†äº¡å€¼ 6 int\u0026amp;\u0026amp; r2 = getRvalue(); // getRvalue() è¿”å›çš„ä¸´æ—¶å¯¹è±¡æ˜¯å°†äº¡å€¼ 7} å˜é‡çš„ç”Ÿå‘½å‘¨æœŸ å·¦å€¼ å·¦å€¼çš„ç”Ÿå‘½å‘¨æœŸç”±å­˜å‚¨æœŸå†³å®šï¼Œé€šå¸¸æ˜¯æŒä¹…çš„ï¼Œå¯ä»¥æ§åˆ¶ã€‚æ¯”å¦‚å±€éƒ¨å˜é‡ï¼Œç¦»å¼€ä½œç”¨åŸŸåä¼šè¢«é”€æ¯ã€‚ åŠ¨æ€åˆ†é…çš„å†…å­˜ä¹Ÿæ˜¯å·¦å€¼ï¼Œéœ€è¦æ‰‹åŠ¨é‡Šæ”¾ã€‚\n1void example() { 2 int a = 10; // å·¦å€¼ aï¼Œè‡ªåŠ¨å­˜å‚¨æœŸï¼Œç¦»å¼€ä½œç”¨åŸŸé”€æ¯ 3 static int b = 20; // å·¦å€¼ bï¼Œé™æ€å­˜å‚¨æœŸï¼Œç¨‹åºç»“æŸé”€æ¯ 4 int* p = new int(30); // å·¦å€¼ *pï¼ŒåŠ¨æ€å­˜å‚¨æœŸï¼Œç›´åˆ° delete 5 delete p; 6} a çš„ç”Ÿå‘½å‘¨æœŸä»å®šä¹‰åˆ°å‡½æ•°ç»“æŸã€‚ b çš„ç”Ÿå‘½å‘¨æœŸè´¯ç©¿æ•´ä¸ªç¨‹åºã€‚ p çš„ç”Ÿå‘½å‘¨æœŸä» new åˆ° deleteã€‚ å³å€¼ çº¯å³å€¼ï¼šç”Ÿå‘½å‘¨æœŸçŸ­æš‚ï¼Œè¡¨è¾¾å¼ç»“æŸåé”€æ¯ï¼Œä¸€æ—¦è¡¨è¾¾å¼æ±‚å€¼å®Œæˆï¼Œçº¯å³å€¼è¦ä¹ˆè¢«é”€æ¯ï¼Œè¦ä¹ˆè¢«ç”¨äºåˆå§‹åŒ–å…¶ä»–å¯¹è±¡ 1int main() { 2 5 + 3; // çº¯å³å€¼ï¼Œè¡¨è¾¾å¼ç»“æŸåé”€æ¯ 3 std::string s = std::string(\u0026#34;hello\u0026#34;); // ä¸´æ—¶å¯¹è±¡æ˜¯çº¯å³å€¼ï¼Œæ„é€  s åé”€æ¯ 4 const int\u0026amp; ref = 42; // çº¯å³å€¼ 42 çš„ç”Ÿå‘½å‘¨æœŸå»¶é•¿åˆ° ref çš„ä½œç”¨åŸŸç»“æŸ 5} å°†äº¡å€¼ï¼šç”Ÿå‘½å‘¨æœŸå–å†³äºåº•å±‚å¯¹è±¡ï¼Œé€šå¸¸æ˜¯çŸ­æš‚çš„ï¼Œæˆ–è€…å¯ä»¥è¢«è½¬ç§»ï¼Œå¯ä»¥é€šè¿‡å³å€¼å¼•ç”¨ç»‘å®šå»¶é•¿ç”Ÿå‘½å‘¨æœŸ 1std::string\u0026amp;\u0026amp; rvalue = std::move(str); // str æ˜¯å°†äº¡å€¼ï¼Œé€šè¿‡ std::move è½¬ä¸ºå³å€¼å¼•ç”¨ï¼Œå»¶é•¿ç”Ÿå‘½å‘¨æœŸ å£°æ˜å‘¨æœŸçš„å»¶é•¿ ç»‘å®šåˆ°å¸¸é‡å·¦å€¼å¼•ç”¨ const \u0026amp; å½“çº¯å³å€¼ç»‘å®šåˆ° const T\u0026amp; æ—¶ï¼Œä¸´æ—¶å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸå»¶é•¿åˆ°å¼•ç”¨çš„ä½œç”¨åŸŸç»“æŸã€‚ 1const std::string\u0026amp; str = std::string(\u0026#34;temp\u0026#34;); // str æœ‰æ•ˆç›´åˆ°ä½œç”¨åŸŸç»“æŸ ç»‘å®šåˆ°å³å€¼å¼•ç”¨\u0026amp;\u0026amp; å½“å³å€¼ï¼ˆçº¯å³å€¼æˆ–å°†äº¡å€¼ï¼‰ç»‘å®šåˆ° T\u0026amp;\u0026amp; æ—¶ï¼Œä¸´æ—¶å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸå»¶é•¿åˆ°å³å€¼å¼•ç”¨çš„ä½œç”¨åŸŸç»“æŸã€‚ 1std::string\u0026amp;\u0026amp; str = std::string(\u0026#34;temp\u0026#34;); // str æœ‰æ•ˆç›´åˆ°ä½œç”¨åŸŸç»“æŸ å€¼ç±»åˆ« ç”Ÿå‘½å‘¨æœŸç‰¹ç‚¹ æ˜¯å¦å¯å»¶é•¿ç”Ÿå‘½å‘¨æœŸ ç¤ºä¾‹åœºæ™¯ å·¦å€¼ (lvalue) ç”±å­˜å‚¨æœŸå†³å®šï¼ŒæŒä¹…ä¸”å¯æ§ ä¸éœ€è¦å»¶é•¿ï¼Œæœ¬èº«æŒä¹… å±€éƒ¨å˜é‡ã€å…¨å±€å˜é‡ çº¯å³å€¼ (prvalue) ä¸´æ—¶ï¼Œè¡¨è¾¾å¼ç»“æŸåé”€æ¯ å¯é€šè¿‡ const \u0026amp; å»¶é•¿ å­—é¢é‡ã€ä¸´æ—¶å¯¹è±¡ å°†äº¡å€¼ (xvalue) å–å†³äºåº•å±‚å¯¹è±¡ï¼Œé€šå¸¸çŸ­æš‚æˆ–å¯è½¬ç§» å¯é€šè¿‡ \u0026amp;\u0026amp; ç»‘å®šå»¶é•¿ std::moveã€å‡½æ•°è¿”å›å³å€¼å¼•ç”¨ å·¦å€¼å¼•ç”¨ã€å³å€¼å¼•ç”¨ å•çº¯çš„å·¦å€¼å’Œå³å€¼å…¶å®è¿˜æ˜¯å¥½ç†è§£çš„ï¼Œä½†æ˜¯ç»“åˆC++ä¸­çš„å¼•ç”¨ï¼Œå°±ä¼šæœ‰ä¸€äº›ç‰¹æ®Šçš„æƒ…å†µï¼Œæ¯”å¦‚å³å€¼å¼•ç”¨ç»‘å®šåˆ°å·¦å€¼ï¼Œ å³å€¼å¼•ç”¨ç»‘å®šåˆ°å³å€¼ç­‰ç­‰ï¼Œè¿™äº›æƒ…å†µå°±éœ€è¦æˆ‘ä»¬å»äº†è§£C++ä¸­çš„å¼•ç”¨çš„ç‰¹æ€§ã€‚\nå·¦å€¼å¼•ç”¨ å…ˆæ¥çœ‹ä¸€ä¸‹æœ€ç®€å•çš„å·¦å€¼å¼•ç”¨ï¼Œæˆ‘çš„ç†è§£ï¼Œå·¦å€¼å¼•ç”¨å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªåˆ«åï¼Œå®ƒæ˜¯ä¸€ä¸ªå·¦å€¼ï¼Œå¯ä»¥å–åœ°å€ï¼Œå¯ä»¥ä¿®æ”¹ï¼Œå¯ä»¥çœ‹åšæ˜¯ä¸€ç§ç®€åŒ–çš„æŒ‡é’ˆã€‚\n1int a = 42; 2int\u0026amp; ref = a; // å·¦å€¼å¼•ç”¨ï¼Œç»‘å®šåˆ°å·¦å€¼ 3ref = 100; // ä¿®æ”¹refå®é™…ä¸Šå°±æ˜¯ä¿®æ”¹a å·¦å€¼å¼•ç”¨ä¸­ï¼Œè¿˜æœ‰ä¸€ä¸ªç‰¹æ®Šçš„æƒ…å†µï¼Œå°±æ˜¯ const å·¦å€¼å¼•ç”¨ï¼Œå®ƒå¯ä»¥ç»‘å®šåˆ°å³å€¼ï¼Œä½†æ˜¯ä¸èƒ½ä¿®æ”¹ã€‚\n1const int\u0026amp; ref = 42; // const å·¦å€¼å¼•ç”¨ï¼Œç»‘å®šåˆ°å³å€¼ const ç±»å‹çš„å·¦å€¼å¼•ç”¨ï¼Œå¸¸ç”¨åœ¨å‡½æ•°çš„å‚æ•°ä¸­ï¼Œå¯ä»¥æ¥å—å·¦å€¼å’Œå³å€¼ã€‚\n1void func(const int\u0026amp; ref) { 2 // ref å¯ä»¥ç»‘å®šåˆ°å·¦å€¼æˆ–å³å€¼ 3} 4 5int main() { 6 int a = 42; 7 func(a); // a æ˜¯å·¦å€¼ 8 func(42); // 42 æ˜¯å³å€¼ 9} ä¸ºä»€ä¹ˆ const å·¦å€¼å¼•ç”¨å¯ä»¥ç»‘å®šåˆ°å³å€¼å‘¢ï¼Ÿå› ä¸ºå³å€¼æ˜¯ä¸´æ—¶çš„ï¼Œä¸ä¼šè¢«ä¿®æ”¹ï¼Œconstä¿®é¥°çš„å˜é‡æ˜¯ä¸å¯ä»¥ä¿®æ”¹çš„ï¼Œ æ‰€ä»¥å¯ä»¥ç»‘å®šåˆ°constå·¦å€¼å¼•ç”¨ã€‚\nå³å€¼å¼•ç”¨ å³å€¼å¼•ç”¨æ˜¯C++11å¼•å…¥çš„æ–°ç‰¹æ€§ï¼Œå®ƒæ˜¯ä¸€ä¸ªæ–°çš„å¼•ç”¨ç±»å‹ï¼Œç”¨äºç»‘å®šåˆ°å³å€¼ã€‚\n1int\u0026amp;\u0026amp; rref = 100; // å³å€¼å¼•ç”¨ï¼Œç»‘å®šåˆ°å³å€¼ 2int x = 101ï¼› 3rref = x; // é”™è¯¯ï¼Œå³å€¼å¼•ç”¨ä¸èƒ½ç»‘å®šåˆ°å·¦å€¼ å³å€¼å¼•ç”¨æœ‰å®¹æ˜“è¿·æƒ‘çš„åœ°æ–¹ï¼Œæ¯”å¦‚ä¸€ä¸ªå‡½æ•°çš„å‚æ•°æ˜¯å³å€¼å¼•ç”¨ï¼Œä½†æ˜¯è¿™ä¸ªå³å€¼åœ¨å‡½æ•°è°ƒç”¨æ—¶æ˜¯å·¦å€¼ã€‚\n1void func(int\u0026amp;\u0026amp; ref) { 2 // ref æ˜¯å³å€¼å¼•ç”¨, ä½†æ˜¯åœ¨å‡½æ•°è°ƒç”¨æ—¶æ˜¯å·¦å€¼ 3 ref = 100; // å¯ä»¥ä¿®æ”¹ 4} ä¸¤ç§å¼•ç”¨åœ¨å‡½æ•°è°ƒç”¨æ—¶çš„åŒºåˆ«ï¼š\n1void func1(int\u0026amp; ref) { 2 // ref æ˜¯å·¦å€¼å¼•ç”¨ 3} 4 5void func2(int\u0026amp;\u0026amp; ref) { 6 // ref æ˜¯å³å€¼å¼•ç”¨ 7} 8 9void func3(const int\u0026amp; ref) { 10 // ref æ˜¯ const å·¦å€¼å¼•ç”¨ 11} 12 13int main() { 14 int a = 100; 15 func1(a); // æ­£ç¡® a æ˜¯å·¦å€¼ 16 func1(101); // é”™è¯¯ 101 æ˜¯å³å€¼ 17 func2(102); // æ­£ç¡® 102 æ˜¯å³å€¼ 18 func2(a); // é”™è¯¯ a æ˜¯å·¦å€¼ 19 func3(a); // æ­£ç¡® a æ˜¯å·¦å€¼ 20 func3(103); // æ­£ç¡® 103 æ˜¯å³å€¼ 21} å¼•ç”¨æŠ˜å  å¼•ç”¨æŠ˜å æ˜¯C++11å¼•å…¥çš„æ–°ç‰¹æ€§ï¼Œä¹Ÿå¯ä»¥å«ä¸‡èƒ½å¼•ç”¨ï¼Œç”¨äºç®€åŒ–å¼•ç”¨çš„ä½¿ç”¨ï¼Œä¸»è¦ç”¨äºæ¨¡æ¿çš„å‚æ•°æ¨å¯¼ã€‚ ä¸»è¦ç”¨åœ¨æ¨¡æ¿çš„å‚æ•°æ¨å¯¼ä¸­ï¼Œå½“ä¸€ä¸ªæ¨¡æ¿å‚æ•°æ˜¯å¼•ç”¨æ—¶ï¼Œå¼•ç”¨æŠ˜å è§„åˆ™ä¼šå†³å®šæœ€ç»ˆçš„å¼•ç”¨ç±»å‹ã€‚\nC++11å¼•å…¥å³å€¼å¼•ç”¨ T\u0026amp;\u0026amp; åï¼Œå…è®¸ç»‘å®šåˆ°å³å€¼ï¼ŒåŒæ—¶åœ¨æ¨¡æ¿ä¸­å¯èƒ½å‡ºç°å¤æ‚çš„ç±»å‹æ¨å¯¼æƒ…å†µï¼Œä¾‹å¦‚ï¼š\nT\u0026amp; \u0026amp; T\u0026amp; \u0026amp;\u0026amp; T\u0026amp;\u0026amp; \u0026amp; T\u0026amp;\u0026amp; \u0026amp;\u0026amp; ä¸ºäº†ç®€åŒ–æ¨¡æ¿å‚æ•°æ¨å¯¼ï¼Œå¼•å…¥äº†å¼•ç”¨æŠ˜å è§„åˆ™ï¼š\nå¼•ç”¨æŠ˜å è§„åˆ™ï¼š\nT\u0026amp; \u0026amp; -\u0026gt; T\u0026amp; T\u0026amp; \u0026amp;\u0026amp; -\u0026gt; T\u0026amp; T\u0026amp;\u0026amp; \u0026amp; -\u0026gt; T\u0026amp; T\u0026amp;\u0026amp; \u0026amp;\u0026amp; -\u0026gt; T\u0026amp;\u0026amp; ç®€å•æ¥è¯´,å·¦å€¼å¼•ç”¨ \u0026amp; å…·æœ‰ä¼˜å…ˆçº§ï¼Œåªè¦ç»„åˆä¸­å‡ºç°å·¦å€¼å¼•ç”¨ï¼Œæœ€ç»ˆç»“æœå°±æ˜¯å·¦å€¼å¼•ç”¨ã€‚ å³å€¼å¼•ç”¨ \u0026amp;\u0026amp; åªæœ‰åœ¨æ²¡æœ‰å·¦å€¼å¼•ç”¨çš„æƒ…å†µä¸‹æ‰ä¼šä¿ç•™ã€‚\n1template\u0026lt;typename T\u0026gt; 2void func(T\u0026amp;\u0026amp; param) { 3 // param çš„ç±»å‹å–å†³äºä¼ å…¥çš„å€¼ç±»åˆ« 4} 5 6int main() { 7 int x = 100; 8 func(x); // T æ¨å¯¼ä¸º int\u0026amp;ï¼ŒT\u0026amp;\u0026amp; æŠ˜å ä¸º int\u0026amp; 9 func(101); // T æ¨å¯¼ä¸º intï¼ŒT\u0026amp;\u0026amp; ä¿æŒä¸º int\u0026amp;\u0026amp; 10} å½“ä¼ å…¥å·¦å€¼xæ—¶ï¼ŒTæ¨å¯¼ä¸ºint\u0026amp;ï¼ŒT\u0026amp;\u0026amp;å˜æˆint\u0026amp; \u0026amp;\u0026amp;ï¼ŒæŠ˜å ä¸ºint\u0026amp;ã€‚ å½“ä¼ å…¥å³å€¼101æ—¶ï¼ŒTæ¨å¯¼ä¸ºintï¼ŒT\u0026amp;\u0026amp;ä¿æŒä¸ºint\u0026amp;\u0026amp;ã€‚ å¼•ç”¨æŠ˜å ç”Ÿæ•ˆçš„ä¸€ä¸ªå‰ææ˜¯æ¨¡æ¿å‚æ•°è¦å‘ç”Ÿç±»å‹æ¨å¯¼ï¼Œå¦‚æœæ¨¡æ¿å‚æ•°æ˜¯æ˜ç¡®çš„ç±»å‹ï¼Œå¼•ç”¨æŠ˜å è§„åˆ™ä¸ä¼šç”Ÿæ•ˆã€‚\n1template\u0026lt;typename T\u0026gt; 2void func(std::vector\u0026lt;T\u0026gt;\u0026amp;\u0026amp; param); // æ™®é€šå³å€¼å¼•ç”¨ï¼Œåªèƒ½ç»‘å®šå³å€¼ 1template \u0026lt;typename T\u0026gt; 2class A 3{ 4public: 5 void push(T\u0026amp;\u0026amp; t) 6 { 7 data_.push_back(std::forward\u0026lt;T\u0026gt;(t)); 8 } 9 10private: 11 std::vector\u0026lt;T\u0026gt; data_; 12}; 13 14int main() { 15 A\u0026lt;int\u0026gt; a; 16 // int x = 100; 17 // a.push(x); // ç¼–è¯‘é”™è¯¯ï¼šå·¦å€¼ä¸èƒ½ç»‘å®šåˆ°å³å€¼å¼•ç”¨ 18 a.push(101); // æ­£ç¡®ï¼šå³å€¼ 19 return 0; 20} è¿™é‡Œçš„ T\u0026amp;\u0026amp; æ˜¯ä¸€ä¸ªå³å€¼å¼•ç”¨ï¼Œä½†æ˜¯åœ¨æ¨¡æ¿å‚æ•°æ¨å¯¼æ—¶ï¼Œä¼šæ ¹æ®ä¼ å…¥çš„å‚æ•°ç±»å‹æ¥å†³å®šæœ€ç»ˆçš„å¼•ç”¨ç±»å‹ã€‚ å› ä¸ºåœ¨åˆå§‹åŒ– A ç±»æ—¶ï¼ŒT çš„ç±»å‹å·²ç»ç¡®å®šäº†ï¼Œæ‰€ä»¥ T\u0026amp;\u0026amp; ä¸ä¼šå‘ç”Ÿå¼•ç”¨æŠ˜å ã€‚\næ”¹è¿›\n1template \u0026lt;typename T\u0026gt; 2class A 3{ 4public: 5 template \u0026lt;typename U\u0026gt; 6 void push(U\u0026amp;\u0026amp; u) 7 { 8 data_.push_back(std::forward\u0026lt;U\u0026gt;(u)); 9 } 10 11private: 12 std::vector\u0026lt;T\u0026gt; data_; 13}; 14int main() { 15 A\u0026lt;int\u0026gt; a; 16 int x = 100; 17 a.push(x); 18 a.push(101); 19 return 0; 20} è¿™é‡Œçš„ U\u0026amp;\u0026amp; æ˜¯ä¸€ä¸ªä¸‡èƒ½å¼•ç”¨ï¼Œå®ƒä¼šæ ¹æ®ä¼ å…¥çš„å‚æ•°ç±»å‹æ¥å†³å®šæœ€ç»ˆçš„å¼•ç”¨ç±»å‹ï¼Œæ‰€ä»¥å¯ä»¥æ­£ç¡®çš„æ¨å¯¼å‡ºå·¦å€¼å’Œå³å€¼ã€‚\næ€»ç»“ C++ä¸­çš„å˜é‡å¯ä»¥åˆ†ä¸ºå·¦å€¼å’Œå³å€¼ï¼Œå³å€¼åˆå¯ä»¥åˆ†ä¸ºçº¯å³å€¼å’Œå°†äº¡å€¼ã€‚ä¸åŒç±»å‹çš„å˜é‡çš„ç”Ÿå‘½å‘¨æœŸä¸ä½œç”¨åŸŸä¹Ÿæ˜¯æœ‰å·®åˆ«çš„ã€‚\nç®€å•è¯´æœ‰æ˜ç¡®å˜é‡åï¼Œå¯ä»¥å–åœ°å€ï¼Œå¯ä»¥ä¿®æ”¹çš„æ˜¯å·¦å€¼ï¼Œæ²¡æœ‰æ˜ç¡®å˜é‡åï¼Œä¸èƒ½å–åœ°å€ï¼Œä¸èƒ½ä¿®æ”¹çš„æ˜¯å³å€¼ã€‚\nå·¦å€¼å’Œå³å€¼é…åˆå¼•ç”¨ï¼Œå¯ä»¥æ›´å¥½çš„æ§åˆ¶å˜é‡çš„ç”Ÿå‘½å‘¨æœŸï¼ŒåŒæ—¶ä¹Ÿä¼šå¸¦æ¥ä¸€äº›ç‰¹æ®Šçš„æƒ…å†µï¼Œæ¯”å¦‚å¼•ç”¨æŠ˜å ã€‚\nå·¦å€¼å¼•ç”¨ï¼šå·¦å€¼å¼•ç”¨æ˜¯ä¸€ä¸ªåˆ«åï¼Œå®ƒæ˜¯ä¸€ä¸ªå·¦å€¼ï¼Œå¯ä»¥å–åœ°å€ï¼Œå¯ä»¥ä¿®æ”¹ã€‚ä½œä¸ºå‡½æ•°å‚æ•°æ—¶ï¼Œåªèƒ½ç»‘å®šå·¦å€¼ã€‚ const å·¦å€¼å¼•ç”¨ï¼šå¯ä»¥ç»‘å®šåˆ°å³å€¼ï¼Œä½†æ˜¯ä¸èƒ½ä¿®æ”¹ã€‚ å³å€¼å¼•ç”¨ï¼šå³å€¼å¼•ç”¨æ˜¯ä¸€ä¸ªæ–°çš„å¼•ç”¨ç±»å‹ï¼Œç”¨äºç»‘å®šåˆ°å³å€¼ã€‚ä½œä¸ºå‡½æ•°å‚æ•°æ—¶ï¼Œåªèƒ½ç»‘å®šå³å€¼ã€‚ å¼•ç”¨æŠ˜å ï¼šå¼•ç”¨æŠ˜å æ˜¯C++11å¼•å…¥çš„æ–°ç‰¹æ€§ï¼Œç”¨äºç®€åŒ–å¼•ç”¨çš„ä½¿ç”¨ï¼Œä¸»è¦ç”¨äºæ¨¡æ¿çš„å‚æ•°æ¨å¯¼ã€‚åªæœ‰åœ¨å‘ç”Ÿç±»å‹æ¨å¯¼æ—¶æ‰ä¼šç”Ÿæ•ˆã€‚ å·¦å€¼å¼•ç”¨å’Œå³å€¼å¼•ç”¨ï¼Œåº”è¯¥è¦é…åˆ std::move å’Œ std::forward ä½¿ç”¨ï¼Œè¿™æ ·å¯ä»¥æ›´å¥½çš„æ§åˆ¶å˜é‡çš„ç”Ÿå‘½å‘¨æœŸã€‚ è¿™é‡Œå…ˆæŒ–ä¸€ä¸ªå‘ï¼Œåé¢æœ‰ç©ºå†æ¥èŠè¿™éƒ¨åˆ†å†…å®¹ã€‚\n","date":"2025-03-09T18:01:29+08:00","image":"https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/0677f36b25f64ef20bd9b0ff4317dee12d1c8c4e.jpg","permalink":"https://lqxhub.github.io/posts/567e834f/","title":"C++å˜é‡ç”Ÿå‘½å‘¨æœŸï¼Œç»“å·¦å€¼å¼•ç”¨å’Œå³å€¼å¼•ç”¨ï¼Œå¼•ç”¨æŠ˜å ï¼Œè¿™æ¬¡å°±æ¥æµ…è°ˆä¸€ä¸‹C++ä¸­å˜é‡çš„ç”Ÿå‘½å‘¨æœŸ - QX's blog"},{"content":"goè‡ªå¸¦çš„é“¾è¡¨æ˜¯æ²¡æœ‰æ’åºåŠŸèƒ½çš„ï¼Œè€Œä¸”ä¹Ÿä¸æ”¯æŒæ³›å‹ã€‚ä¸æ”¯æŒæ³›å‹è¿˜å¥½è¯´ï¼Œä½¿ç”¨ interface{} å°±èƒ½è§£å†³ã€‚ä½†æ˜¯å¾ˆå¤šæ—¶å€™è¿˜æ˜¯æœ‰å¯¹ list æ’åºçš„éœ€æ±‚ã€‚ ä¹‹å‰åœ¨å…¬å¸å†…éƒ¨ï¼Œæˆ‘å†™è¿‡ä¸€ä¸ª list çš„æ’åºï¼Œå› ä¸ºlistå†…éƒ¨çš„å¾ˆå¤šæ•°æ®éƒ½æ˜¯ private çš„ï¼Œæ‰€ä»¥æ²¡æ³•ä½¿ç”¨å½’å¹¶æ’åºï¼Œåªèƒ½ä½¿ç”¨ç±»æ’å…¥æ’åºã€‚ åœ¨æ•°æ®é‡ä¸å¤§çš„æƒ…å†µä¸‹ï¼Œè¿™ç§æ’åºæ˜¯å¯ä»¥æ¥å—çš„ã€‚ä½†æ˜¯å¦‚æœæ•°æ®é‡å¾ˆå¤§ï¼Œè¿™ç§æ’åºå°±ä¼šå¾ˆæ…¢ï¼Œæ‰€ä»¥è¿™æ¬¡æˆ‘ä½¿ç”¨å½’å¹¶æ’åºæ¥å®ç°æ’åºï¼Œå¹¶ä¸”ä½¿ç”¨æ³›å‹æ¥å®ç°ã€‚\né“¾è¡¨çš„å½’å¹¶æ’åºï¼Œä¹‹å‰å†™è¿‡ä¸€æ¬¡ï¼Œè¿™æ¬¡å°±ä¸å†èµ˜è¿°äº†å½’å¹¶æ’åº\nå…³äº go çš„æ³›å‹ï¼Œä¹‹å‰ä¹Ÿå†™è¿‡ä¸€ç¯‡æ–‡ç« goæ³›å‹\nè¿™æ¬¡å†™çš„ æ”¯æŒ æ³›å‹ å’Œ æ’åº çš„ GitHub åœ°å€ï¼šlistplus\nè¿™æ¬¡ç®€å•è®²è§£ä¸€ä¸‹ go è‡ªå¸¦çš„ list çš„ä¸€äº›æºç ã€‚\nlistæºç  list æºç è¿˜æ˜¯å¾ˆç®€å•çš„ï¼Œå°±æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œå°±æŒ‘å‡ ä¸ªå‡½æ•°å­¦ä¸€ä¸‹å§\nelement 1type Element struct { 2 next, prev *Element 3 list *List 4 Value any 5} ä¸ºä»€ä¹ˆè¦å†™ Element è¿™ä¸ªç»“æ„ä½“å‘¢ï¼Œæ˜¯å› ä¸ºè¿™é‡Œé¢å­˜äº† list çš„æŒ‡é’ˆã€‚è¿™ä¸ªæŒ‡é’ˆä¸»è¦ç”¨æ¥åˆ¤æ–­è¦æ“ä½œçš„ element æ˜¯å¦å±äºè¿™ä¸ª listã€‚ ä¸€èˆ¬è‡ªå·±åœ¨å†™é“¾è¡¨çš„æ—¶å€™,å¾ˆå°‘è¿™æ ·å†™ã€‚å¤šäº†è¿™ä¸ªæŒ‡é’ˆï¼Œå¯ä»¥é¿å…å¾ˆå¤šé”™è¯¯ã€‚æ¯”å¦‚æŠŠ A é“¾è¡¨ä¸­çš„å…ƒç´ æ’å…¥åˆ° B é“¾è¡¨ä¸­ï¼Œè¿™æ ·å°±ä¼šå‡ºç°é—®é¢˜ã€‚\nå‰©ä¸‹çš„ next å’Œ prev å°±æ˜¯é“¾è¡¨çš„å‰åæŒ‡é’ˆäº†ï¼ŒValue å°±æ˜¯å­˜æ”¾æ•°æ®çš„åœ°æ–¹ã€‚ any åœ¨ go 1.18 ä¹‹åæ‰æœ‰çš„ï¼Œä¹‹å‰éƒ½æ˜¯ç”¨ interface{} æ¥ä»£æ›¿ã€‚\nlist 1type List struct { 2 root Element 3 len int 4} è¿™ä¸ªç»“æ„å°±æ˜¯é“¾è¡¨çš„ç»“æ„äº†ï¼Œroot æ˜¯ä¸€ä¸ª Element ç»“æ„ä½“ï¼Œè¿™ä¸ª Element ç»“æ„ä½“æ˜¯ä¸€ä¸ªå“¨å…µï¼Œä¸å­˜æ”¾æ•°æ®ï¼Œåªæ˜¯ç”¨æ¥æ ‡è®°é“¾è¡¨çš„å¤´å’Œå°¾ã€‚\nroot çš„ next æŒ‡å‘é“¾è¡¨çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œprev æŒ‡å‘é“¾è¡¨çš„æœ€åä¸€ä¸ªå…ƒç´ ã€‚\nlen æ˜¯é“¾è¡¨çš„é•¿åº¦ã€‚\ninsert 1func (l *List) insert(e, at *Element) *Element { 2\te.prev = at 3\te.next = at.next 4\te.prev.next = e 5\te.next.prev = e 6\te.list = l 7\tl.len++ 8\treturn e 9} PushBack å’Œ PushFront éƒ½æ˜¯è°ƒç”¨è¿™ä¸ªå‡½æ•°æ¥æ’å…¥å…ƒç´ çš„ã€‚\nè¿™ä¸ªå‡½æ•°ä¹ŸæŒºç®€å•çš„ï¼Œå°±æ˜¯æŠŠ e æ’å…¥åˆ° at åé¢ã€‚é€»è¾‘ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯è®¾ç½®ä¸€ä¸‹ e å’Œ at çš„æŒ‡é’ˆã€‚ç„¶åæŠŠæ–°æ’å…¥çš„å…ƒç´ çš„ list æŒ‡é’ˆæŒ‡å‘è¿™ä¸ªé“¾è¡¨ï¼Œæœ€åé“¾è¡¨çš„é•¿åº¦åŠ ä¸€ã€‚ æœ€å return eï¼Œè¿™ä¸ª e å°±æ˜¯æ–°æ’å…¥çš„å…ƒç´ ã€‚\nåœ¨ PushBack ä¸­ï¼Œat å°±æ˜¯ root.prevï¼Œåœ¨ PushFront ä¸­ï¼Œat å°±æ˜¯ rootã€‚\nremove 1func (l *List) remove(e *Element) { 2\te.prev.next = e.next 3\te.next.prev = e.prev 4\te.next = nil // avoid memory leaks 5\te.prev = nil // avoid memory leaks 6\te.list = nil 7\tl.len-- 8} remove å‡½æ•°å°±æ˜¯è°ƒç”¨è¿™ä¸ªå‡½æ•°æ¥åˆ é™¤å…ƒç´ çš„ã€‚é€»è¾‘ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯æŠŠ e ä»é“¾è¡¨ä¸­åˆ é™¤ã€‚åŒå‘é“¾è¡¨çš„åˆ é™¤ï¼Œå°±æ˜¯æŠŠ e çš„å‰åæŒ‡é’ˆæŒ‡å‘å¯¹æ–¹ï¼Œç„¶åæŠŠ e çš„ list æŒ‡é’ˆç½®ç©ºï¼Œæœ€åé“¾è¡¨çš„é•¿åº¦å‡ä¸€ã€‚\né“¾è¡¨ä¸­åˆ é™¤ä¸€ä¸ªå…ƒç´ ï¼Œé¦–å…ˆè¦æ‰¾åˆ°è¿™ä¸ªå…ƒç´ ï¼Œç„¶åè°ƒç”¨è¿™ä¸ªå‡½æ•°æ¥åˆ é™¤ã€‚è™½ç„¶é“¾è¡¨åˆ é™¤çš„æ—¶é—´å¤æ‚åº¦æ˜¯ O(1)ï¼Œä½†æ˜¯æ‰¾åˆ°è¿™ä¸ªå…ƒç´ çš„æ—¶é—´å¤æ‚åº¦æ˜¯ O(n)ã€‚\nmove 1func (l *List) move(e, at *Element) { 2\tif e == at { 3\treturn 4\t} 5\te.prev.next = e.next 6\te.next.prev = e.prev 7 8\te.prev = at 9\te.next = at.next 10\te.prev.next = e 11\te.next.prev = e 12} move å‡½æ•°å°±æ˜¯è°ƒç”¨è¿™ä¸ªå‡½æ•°æ¥ç§»åŠ¨å…ƒç´ çš„ã€‚é€»è¾‘ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯æŠŠ e ç§»åŠ¨åˆ° at åé¢ã€‚å…ˆæŠŠ e ä»é“¾è¡¨ä¸­ â€˜åˆ é™¤â€™ï¼Œç„¶åæŠŠ e æ’å…¥åˆ° at åé¢ã€‚ æ‰€è°“çš„åˆ é™¤å°±æ˜¯ e çš„å‰åæŒ‡é’ˆæŒ‡å‘å¯¹æ–¹ã€‚\ngo çš„ list ä¸­è¿˜æœ‰å¾ˆå¤šå‡½æ•°ï¼Œè¿™é‡Œå°±ä¸ä¸€ä¸€åˆ—ä¸¾äº†ï¼Œä½†æ˜¯å¯¹é“¾è¡¨çš„æ ¸å¿ƒæ“ä½œå°±æ˜¯è¿™å‡ ä¸ªå‡½æ•°ã€‚\nlistplus ä¸‹é¢æ˜¯æˆ‘ä¿®æ”¹åçš„ list çš„éƒ¨åˆ†ä»£ç ï¼Œæ•´ä½“é€»è¾‘æ²¡æ”¹ï¼Œå°±æ˜¯åŠ äº†æ³›å‹æ”¯æŒï¼Œç„¶åå†åŠ äº†æ’åºåŠŸèƒ½ã€‚ å°±åªåˆ—ä¸¾ä¸€ä¸‹ sort å‡½æ•°å§\n1func (l *List[T]) Sort(compare func(front, back T) bool) { 2\tif l.len \u0026lt; 2 {//å¦‚æœé“¾è¡¨é•¿åº¦æ˜¯0æˆ–è€…1ï¼Œç›´æ¥è¿”å› 3\treturn 4\t} 5\thead := l.Front() 6\ttail := l.Back() 7\ttail.next = nil 8 //å–å‡ºé“¾è¡¨çš„å¤´å’Œå°¾ï¼Œç„¶åè°ƒç”¨å½’å¹¶æ’åº 9\thead, tail = l.mergeSort(head, compare) 10\t//è¿™é‡Œæ˜¯æŠŠæ’åºåçš„é“¾è¡¨é‡æ–°è¿æ¥èµ·æ¥ 11\tl.root.next = head 12\tl.root.prev = tail 13\thead.prev = \u0026amp;l.root 14\ttail.next = \u0026amp;l.root 15} 16 17func (l *List[T]) mergeSort(head *Element[T], compare func(front, back T) bool) (*Element[T], *Element[T]) { 18\tif head == nil || head.next == nil { 19\treturn head, head 20\t} 21\tslow, fast := head, head 22\t//ä½¿ç”¨å¿«æ…¢æŒ‡é’ˆæ‰¾åˆ°é“¾è¡¨çš„ä¸­é—´èŠ‚ç‚¹ 23\tfor fast.next != nil \u0026amp;\u0026amp; fast.next.next != nil { 24\tslow = slow.next 25\tfast = fast.next.next 26\t} 27\tmid := slow.next 28\tslow.next = nil//æˆªæ–­é“¾è¡¨,å› ä¸ºä¸‹é¢çš„æ“ä½œåªä¼šç”¨ nextæŒ‡é’ˆ,æ‰€ä»¥ä¸ç”¨æˆªæ–­ prevæŒ‡é’ˆ 29 30\th1, t1 := l.mergeSort(head, compare) 31\th2, t2 := l.mergeSort(mid, compare) 32\treturn l.merge(h1, t1, h2, t2, compare) 33} 34 35func (l *List[T]) merge(h1, t1, h2, t2 *Element[T], compare func(front, back T) bool) (*Element[T], *Element[T]) { 36\t//åˆå¹¶ä¸¤ä¸ªé“¾è¡¨,ç„¶åè¿”å›åˆå¹¶åçš„å¤´å’Œå°¾ 37\t//å’Œå•å‘é“¾è¡¨çš„åˆå¹¶ä¸åŒçš„æ˜¯,è¿™é‡Œéœ€è¦ç»´æŠ¤ prevæŒ‡é’ˆ 38\tcur := \u0026amp;l.root 39\tfor h1 != nil \u0026amp;\u0026amp; h2 != nil { 40\tif compare(h1.Value, h2.Value) { 41\tcur.next = h1 42\th1.prev = cur 43\th1 = h1.next 44\t} else { 45\tcur.next = h2 46\th2.prev = cur 47\th2 = h2.next 48\t} 49\tcur = cur.next 50\t} 51\tif h1 != nil { 52\tcur.next = h1 53\th1.prev = cur 54\tcur = t1 55\t} else { 56\tcur.next = h2 57\th2.prev = cur 58\tcur = t2 59\t} 60\treturn l.root.next, cur 61} æ•´ä½“å’Œä»¥å‰å†™çš„é“¾è¡¨æ’åºå·®ä¸å¤šï¼Œä¸åŒçš„åœ°æ–¹æ˜¯è¿™æ¬¡æ˜¯åŒå‘é“¾è¡¨ï¼Œæ‰€ä»¥éœ€è¦ç»´æŠ¤ prev æŒ‡é’ˆã€‚\nä¸€å¼€å§‹æˆ‘æ˜¯æ²¡æœ‰ç»´æŠ¤ prev æŒ‡é’ˆçš„ï¼Œå®Œå…¨æŒ‰ç…§å•å‘é“¾è¡¨çš„æ€è·¯æ¥ mergeï¼Œåªæ˜¯åœ¨ merge å®Œä¸€ä¸ªé“¾è¡¨åï¼Œéœ€è¦ç»§ç»­merge å¦ä¸€ä¸ªé“¾è¡¨ï¼Œé‡æ–°ç»„ç»‡é“¾è¡¨çš„ç»“æ„ã€‚\nmergeå‡½æ•°ï¼š\n1func (l *List) merge(l1, l2 *Element, compare func(v1, v2 any) bool) *Element { 2\tcur := \u0026amp;l.root 3\tfor l1 != nil \u0026amp;\u0026amp; l2 != nil { 4\tif compare(l1.Value, l2.Value) { 5\tcur.next = l1 6\tl1.prev = cur 7\tl1 = l1.next 8\t} else { 9\tcur.next = l2 10\tl2.prev = cur 11\tl2 = l2.next 12\t} 13\tcur = cur.next 14\t} 15\tif l1 != nil { 16\tcur.next = l1 17\tl1.prev = cur 18\t} else { 19\tcur.next = l2 20\tl2.prev = cur 21\t} 22\tfor cur.next != nil { 23\tcur.next.prev = cur 24\tcur = cur.next 25\t} 26\tl.root.prev = cur 27\treturn l.root.next 28} å‰åŠéƒ¨åˆ†å’Œè¿™æ¬¡çš„ merge å‡½æ•°å·®ä¸å¤šï¼Œåé¢å¤šäº†ä¸€ä¸ªå¾ªç¯ï¼Œæ˜¯ä¸ºäº†ç»´æŠ¤ prev æŒ‡é’ˆã€‚\nåæ¥è€ƒè™‘åˆ°è¿™éƒ¨åˆ†æ˜¯å¯ä»¥ä¼˜åŒ–çš„ï¼Œæ¯æ¬¡mergeçš„æ—¶å€™ï¼Œä¼ é€’æ¯ä¸ªé“¾è¡¨çš„ head å’Œ tailï¼Œè¿™æ ·å°±ä¸ç”¨åœ¨mergeå®Œä¸€ä¸ªé“¾è¡¨åï¼Œç»§ç»­merge å¦ä¸€ä¸ªé“¾è¡¨äº†ã€‚\nè¿™æ ·å°±å¯ä»¥ç›´æ¥è¿”å› head å’Œ tailï¼Œç„¶ååœ¨ Sort å‡½æ•°ä¸­é‡æ–°è¿æ¥é“¾è¡¨ã€‚\næ•´ä½“è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œå°±æ˜¯ä¸çŸ¥çš„ä¸ºä»€ä¹ˆ go çš„ list æ²¡æœ‰æ’åºåŠŸèƒ½ï¼Œè¿™ä¸ªåŠŸèƒ½è¿˜æ˜¯å¾ˆå¸¸ç”¨çš„ã€‚æ³›å‹éƒ½å‡ºäº†è¿™ä¹ˆå¤šå¹´äº†ï¼Œgo çš„ list è¿˜æ˜¯æ²¡æœ‰æ³›å‹ã€‚\næ€§èƒ½ å½’å¹¶æ’åºçš„æ—¶é—´å¤æ‚åº¦æ˜¯ O(nlogn)ï¼Œæ¯”ä¹‹å‰å†™çš„æ’å…¥æ’åºè¦å¿«å¾ˆå¤šã€‚ä½†æ˜¯ å½’å¹¶æ’åºæ˜¯åŸºäºé€’å½’çš„ï¼Œéœ€è¦é¢å¤–çš„ç©ºé—´çš„ï¼Œç©ºé—´å¤æ‚åº¦æ˜¯ O(n)ã€‚\nåœ¨æ•°æ®é‡å¾ˆå¤§çš„æ—¶å€™ï¼Œè¿™ä¸ªç©ºé—´å¤æ‚åº¦æ˜¯å¾ˆå¤§çš„ï¼Œæ‰€ä»¥åœ¨æ•°æ®é‡å¾ˆå¤§çš„æ—¶å€™ï¼Œè¿˜æ˜¯è¦è€ƒè™‘ä¸€ä¸‹ã€‚\nåŸæ¥æƒ³å€Ÿé‰´ä¸€ä¸‹ go çš„ sort åŒ…ï¼Œä½†æ˜¯å‘ç° go çš„ sort ä¸­çš„ä¸€äº›æ€æƒ³ï¼Œæ¯”å¦‚ å½“æ•°æ®é‡å°äº 12 çš„æ—¶å€™ï¼Œä½¿ç”¨æ’å…¥æ’åºï¼Œä½†æ˜¯é“¾è¡¨çš„é•¿åº¦ç»Ÿè®¡ä¸åƒåˆ‡ç‰‡é‚£ä¹ˆæ–¹ä¾¿ï¼Œæ‰€ä»¥å°±æ²¡æœ‰å®ç°ã€‚\nè¿˜æœ‰å°±æ˜¯åœ¨é€’å½’å±‚æ•°è¾¾åˆ°ä¸€å®šå€¼çš„æ—¶å€™ï¼Œä½¿ç”¨åˆ«çš„æ’åºç®—æ³•ï¼Œé˜²æ­¢æ ˆæº¢å‡ºã€‚ä½†æ˜¯è®¡ç®—äº†ä¸€ä¸‹\n$ {log}_{2}1000000 = 19.931568569324174 $\né“¾è¡¨çš„é•¿åº¦è¾¾åˆ° 1000000 çš„æ—¶å€™ï¼Œé€’å½’å±‚æ•°ä¹Ÿå°± 20 å±‚ï¼Œè¿™ä¸ªå±‚æ•°æ˜¯å¯ä»¥æ¥å—çš„ã€‚\næ€»ç»“ è¿™æ¬¡å®ç°äº†ä¸€ä¸ªæ”¯æŒæ³›å‹å’Œæ’åºçš„é“¾è¡¨ï¼Œä¸»è¦æ˜¯ä¸ºäº†å­¦ä¹  go çš„æ³›å‹å’Œé“¾è¡¨çš„ä¸€äº›æ“ä½œã€‚é“¾è¡¨çš„æ’åºè¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œä½†æ˜¯é“¾è¡¨çš„æ’åºè¿˜æ˜¯æ¯”è¾ƒå°‘è§çš„ï¼Œä¸€èˆ¬éƒ½æ˜¯ä½¿ç”¨åˆ‡ç‰‡æ¥æ’åºã€‚ æ–‡ä¸­å¦‚æœæœ‰é”™è¯¯çš„åœ°æ–¹ï¼Œè¿˜è¯·æŒ‡æ­£ã€‚å¦‚æœå¯¹ go çš„æ³›å‹å’Œé“¾è¡¨æœ‰æ›´å¥½çš„æƒ³æ³•ï¼Œæ¬¢è¿åœ¨ GitHub ä¸Šæå‡ºã€‚\n","date":"2025-01-12T12:26:34+08:00","image":"https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/def9654de08c79035495f70fa24c7a388b4cc883.jpg","permalink":"https://lqxhub.github.io/posts/db59b241/","title":"Goæ”¯æŒæ³›å‹å’Œæ’åºçš„listï¼Œå®ç°ä¸€ä¸ªæ”¯æŒæ³›å‹å’Œæ’åºåŠŸèƒ½çš„é“¾è¡¨ã€‚é€šè¿‡å½’å¹¶æ’åºç®—æ³•ä¸ºé“¾è¡¨æ·»åŠ æ’åºåŠŸèƒ½çš„å®ç°è¿‡ç¨‹ï¼Œå¯¹æ¯”æ’å…¥æ’åºçš„å®ç°æ–¹å¼"},{"content":"æ—¶é—´çœŸçš„æ˜¯å¦‚ç™½é©¹è¿‡éš™ï¼Œä¸Šæ¬¡å†™2023å¹´çš„æ€»ç»“å·²ç»æ˜¯ä¸€å¹´å‰çš„äº‹æƒ…äº†ï¼Œä½†æ˜¯æ€»æ„Ÿè§‰å¥½åƒå°±æ˜¯å‰å‡ å¤©çš„äº‹æƒ…ï¼Œä¹Ÿåœ¨åœ¨è¿™ä¸ªæˆ¿é—´é‡Œï¼Œä¹Ÿæ˜¯è¿™å°ç”µè„‘ã€‚ä¸€åˆ‡éƒ½å¥½åƒæ²¡æœ‰å˜è¿‡ï¼Œä½†æ˜¯æ—¶é—´å´åœ¨ä¸åœçš„æµé€ã€‚ 2024è¿™ä¸€å¹´ï¼Œå’‹è¯´å‘¢ï¼Œæƒ³ä¸åˆ°ä¸€ä¸ªè¯æ¥å½¢å®¹ã€‚åŸæ¥ä¸æƒ³å†™äº†ï¼Œå¯æ˜¯ä»¥å‰ç«‹äº†ä¸ªflagï¼Œæ¯å¹´éƒ½å†™ï¼Œå°±è¿˜æ˜¯å†™ä¸€ä¸‹å§ã€‚\nè€ä¼ ç»Ÿ è¿˜æ˜¯ä» ç”Ÿæ´» ä¸ å·¥ä½œ ä¸¤æ–¹é¢æ¥å†™å§\nç”Ÿæ´» è¿™ä¸€å¹´æœ€å¤§çš„å˜åŒ–å°±æ˜¯å¼€å§‹éª‘è½¦äº†ï¼Œè™½ç„¶ä¸æ˜¯æ¯å¤©éª‘ï¼Œä½†æ˜¯ä¹Ÿç®—æ˜¯å…»æˆäº†ä¸€ä¸ªä¹ æƒ¯ã€‚é€šè¿‡éª‘è½¦ï¼Œä¸€å¹´ç˜¦äº†å·®ä¸å¤š10å…¬æ–¤ï¼Œè¿˜çœ‹åˆ°äº†ä¸€äº›ä»¥å‰æ²¡æœ‰çœ‹è¿‡çš„é£æ™¯ã€‚ä¹Ÿè®¤è¯†äº†å¾ˆå¤šæ–°çš„æœ‹å‹ï¼Œä¹Ÿæœ‰äº†ä¸€äº›æ–°çš„ç»å†ã€‚ ç°åœ¨å·²ç»å–œæ¬¢ä¸Šéª‘è½¦äº†ï¼Œæ¯å‘¨ä¸éª‘è½¦éƒ½ä¼šè§‰å¾—å°‘äº†ç‚¹ä»€ä¹ˆï¼Œéª‘è½¦åæ¸¸æˆä¹Ÿæˆ’äº†ï¼ŒåŸºæœ¬ä¸ç©äº†ï¼Œä»¥å‰å‘¨æœ«æ²¡äº‹å–œæ¬¢æ‡’åœ¨å®¶é‡Œï¼Œç°åœ¨å‘¨æœ«éƒ½ä¼šå‡ºå»éª‘è½¦ï¼Œæ„Ÿè§‰ç”Ÿæ´»å˜å¾—å……å®äº†å¾ˆå¤šã€‚\néª‘è½¦åè®¤è¯†äº†å¾ˆå¤šæ–°çš„æœ‹å‹ ä»Šå¹´è¿˜å»å¤ªæ¹–ä¸œè¥¿å±±éª‘äº†ä¸€æ¬¡ï¼Œä¹Ÿæ˜¯ç¬¬ä¸€æ¬¡å»ï¼Œæ„Ÿè§‰è¿˜æ˜¯ä¸é”™çš„ï¼Œé£æ™¯ä¹Ÿå¾ˆç¾ï¼Œä¹Ÿæ˜¯ä¸€æ¬¡å¾ˆå¥½çš„ç»å†ã€‚åŸæ¥è®¡åˆ’ä¸­ç§‹æ”¾å‡å»ç¯å¤ªæ¹–ï¼Œå› ä¸ºæ¥å°é£äº†ï¼Œå°±å–æ¶ˆäº†ï¼Œæ˜å¹´ä¸€å®šè¦å»ã€‚ ä»Šå¹´çš„éª‘è¡Œæ•°æ®ï¼Œæ˜å¹´ç»§ç»­åŠªåŠ› å»å¹´å†™æ€»ç»“æ—¶è®¡åˆ’å»ç©çš„åœ°æ–¹ï¼Œä»Šå¹´ä¸€ä¸ªæ²¡å»ï¼ŒåŸºæœ¬éƒ½æ˜¯æ—¶é—´ä¸å¤Ÿã€‚ä»Šå¹´åŸºæœ¬éƒ½æ˜¯åœ¨é™„è¿‘çš„åœ°æ–¹ï¼Œå—äº¬å»äº†å¥½å‡ æ¬¡ï¼Œæ˜¥å¤©å’ŒåŒå­¦å»çœ‹äº†ä¸€æ¬¡æ¨±èŠ±ã€‚ç¡®å®å¾ˆç¾ï¼Œä½†æ˜¯äººä¹Ÿå¾ˆå¤šã€‚ å’ŒåŒå­¦è¾¹èµ°è¾¹èŠï¼Œæ„Ÿè§‰å¾ˆå¥½ã€‚ æœ€ç¥å¥‡çš„æ˜¯ï¼Œè¿™æ¬¡å»å—äº¬ï¼Œæ‰¾åƒçš„æ—¶å€™ï¼Œåˆå»äº†å¤§å­¦æ—¶å’Œå¦ä¸€ä¸ªåŒå­¦å»è¿‡çš„ä¸€å®¶é¤å…ã€‚ç¬¬ä¸€æ¬¡å»åº”è¯¥æ˜¯2016å¹´ï¼Œé‚£æ—¶å€™æ˜¯å»å—äº¬å‚åŠ æ¯”èµ›ï¼Œå’Œä¸€ä¸ªå¤§å­¦å®¤å‹ï¼Œä¿©äººéƒ½æ˜¯ç¬¬ä¸€å»å—äº¬ã€‚ é‚£æ—¶å€™è¿˜æœ‰æ²¡æœ‰å°çº¢ä¹¦è¿™æ ·çš„è½¯ä»¶ï¼Œä¿©äººå°±ç½‘ä¸Šéšä¾¿æœï¼Œçé€›ï¼Œæ‰¾åˆ°äº†ç‹®å­æ¡¥é‚£é‡Œï¼Œçœ‹åˆ°é‚£å®¶é¤å…ï¼Œå°±è¿›å»åƒäº†ã€‚é‚£æ—¶å€™æ²¡è§‰å¾—æœ‰å¤šç¾å¥½åƒã€‚æ²¡æƒ³åˆ°è¿™ä¸¤å¹´é‚£é‡Œæˆç«‹ç½‘çº¢æ‰“å¡åœ°äº†ï¼Œäººä¹Ÿè¶…çº§å¤šã€‚ ä¹°ä¸ªé¥­éƒ½è¦æ’å¥½ä¹…ã€‚è¿™æ¬¡æˆ‘å»è·¯è¿‡é‚£å®¶é¤å…ï¼Œçœ‹ç€æ‹›ç‰Œå¾ˆçœ¼ç†Ÿï¼Œå°±æ‹ä¸‹æ¥å‘ç»™é‚£ä¸ªåŒå­¦ï¼Œé—®ä»–è¿™æ˜¯ä¸æ˜¯å’±ä¿©ä¹‹å‰å»åƒè¿‡çš„é‚£å®¶é¤å…ï¼Œä»–è¯´æ˜¯ã€‚æ„Ÿè§‰å¾ˆç¥å¥‡ï¼Œè¿™ä¹ˆå¤šå¹´äº†ï¼Œåˆæ¥åˆ°äº†è¿™é‡Œã€‚\nè¿™æ¬¡å»å—äº¬è¿˜ä¸€ä»¶æœ‰æ„æ€çš„äº‹ã€‚ä¸¤ä¸ªäººåƒå®Œé¥­å»ä¸­å±±é™µçš„è·¯ä¸Šï¼Œæˆ‘åŒå­¦æƒ³å»å•æ‰€äº†ï¼Œæˆ‘ä¸€çœ‹å¿«åˆ°æ–°è¡—å£äº†ï¼Œäºæ˜¯å°±å»å¾·åŸºå¹¿åœºé‚£å§ï¼Œåˆ«çš„åœ°æ–¹ä¹Ÿä¸å¥½æ‰¾ã€‚å¥½å®¶ä¼™ï¼Œç¬¬ä¸€æ¬¡è§è¯†åˆ°äº†å•æ‰€ä¹Ÿæˆäº†ç½‘çº¢æ‰“å¡åœ°ã€‚\nè¿˜ä¸€æ¬¡å»å—äº¬æ˜¯ä¸­ç§‹æ”¾å‡ï¼ŒåŸæ¥è®¡åˆ’å»ç¯å¤ªæ¹–ï¼Œå› ä¸ºæ¥å°é£äº†ï¼Œå°±å–æ¶ˆäº†ã€‚æ­£å¥½æœ‰ä¸ªé«˜ä¸­åŒå­¦åœ¨å—äº¬å‡ºå·®ï¼Œè¿˜ä¸€ä¸ªåŒå­¦åœ¨æ­å·ï¼Œä¹Ÿæ˜¯é—²ç€æ²¡äº‹ï¼Œäºæ˜¯ä¸‰äººç›¸çº¦åœ¨å—äº¬è§é¢ã€‚æ²¡æƒ³åˆ°å»å—äº¬ç©çš„äººå¾ˆå¤šï¼Œæƒ³å»ç©çš„åœ°æ–¹éƒ½æ²¡é¢„çº¦åˆ°ã€‚ è™½ç„¶ç©æ²¡ç©æˆï¼Œä½†æ˜¯åƒçš„è¿˜æ˜¯åƒäº†ä¸å°‘ï¼Œå—äº¬çš„ç¾é£Ÿè¿˜æ˜¯å¾ˆå¤šçš„ã€‚\n6æœˆä»½è¿˜å»äº†ä¸€æ¬¡æµå—ï¼Œè§åˆ°äº†å¦ä¸€ä¸ªå¤§å­¦åŒå­¦ï¼Œä¹Ÿæ˜¯å¾ˆä¹…æ²¡è§äº†ã€‚è¿™æ¬¡å»æµå—ä¸€å¼€å§‹æ˜¯æ‰¾ä¸€ä¸ªå°å­¦åˆä¸­çš„åŒå­¦ï¼Œè™½ç„¶è€å®¶è·ç¦»ä¸è¿œï¼Œä½†æ˜¯ä¸€å¹´åŸºæœ¬ä¹Ÿå°±è¿‡å¹´çš„æ—¶å€™èƒ½è§ä¸€æ¬¡ã€‚ è™½ç„¶æˆ‘æ˜¯å±±ä¸œäººï¼Œä½†æ˜¯æµå—æ²¡æ€ä¹ˆå»ç©è¿‡ï¼Œä»¥å‰å»åŸºæœ¬éƒ½æ˜¯æœ‰äº‹ï¼Œè¿™æ¬¡å»æµå—ï¼Œæ„Ÿè§‰è¿˜æ˜¯ä¸é”™çš„ï¼Œæµå—çš„æ³‰æ°´è¿˜æ˜¯å¾ˆæœ‰åçš„ï¼Œè¿˜æœ‰å¾ˆå¤šå¥½åƒçš„ã€‚ åæ¥åˆæƒ³èµ·äº†ï¼Œå¦ä¸€ä¸ªå¤§å­¦åŒå­¦ä¹Ÿåœ¨æµå—ï¼Œäºæ˜¯å°±åˆçº¦äº†ä¸€æ¬¡ã€‚\nè¿™æ¬¡å»æµå—ï¼Œé¡ºè·¯åˆå»çˆ¬äº†ä¸€æ¬¡æ³°å±±ã€‚å¤œçˆ¬æ³°å±±çš„æ„Ÿè§‰è¿˜æ˜¯å¾ˆä¸é”™çš„ï¼Œè™½ç„¶å¾ˆç´¯ï¼Œä½†æ˜¯çœ‹åˆ°æ—¥å‡ºçš„é‚£ä¸€åˆ»ï¼Œæ„Ÿè§‰æ‰€æœ‰çš„è¾›è‹¦éƒ½æ˜¯å€¼å¾—çš„ã€‚\nè¿™æ¬¡çˆ¬æ³°å±±ï¼Œä¹‹å‰éª‘è½¦çš„å¥½å¤„å°±ä½“ç°å‡ºæ¥äº†ï¼Œçˆ¬å±±çš„æ—¶å€™ä¸€è·¯åŸºæœ¬éƒ½æ˜¯è¶…è¶Šåˆ«äººï¼Œä¹Ÿæ²¡æœ‰æ„Ÿè§‰å¾ˆç´¯ï¼Œä¹Ÿæ²¡æœ‰æ„Ÿè§‰å¾ˆéš¾ã€‚ä»çº¢é—¨å¼€å§‹ï¼Œä¸€å£æ°”çˆ¬åˆ°ä¸­å¤©é—¨ï¼Œå–äº†ç‚¹æ°´ï¼Œä¼‘æ¯äº†ä¸€ä¸‹ï¼Œç„¶åå°±ä¸€å£æ°”çˆ¬åˆ°äº†å—å¤©é—¨ã€‚\nè¿™é€Ÿåº¦æˆ‘è‡ªå·±è¿˜æ˜¯æŒºæ»¡æ„çš„ã€‚\nè¿™ä¸€å¹´ï¼Œç”Ÿæ´»å¥½åƒä¹Ÿæ²¡æœ‰ä»€ä¹ˆå¤§çš„å˜åŒ–ï¼Œä½†æ˜¯ä¹Ÿæœ‰å¾ˆå¤šå°çš„å˜åŒ–ã€‚ä»¥å‰å‘¨æœ«åŸºæœ¬éƒ½æ˜¯åœ¨å®¶é‡Œï¼Œç°åœ¨å‘¨æœ«éƒ½ä¼šå‡ºå»éª‘è½¦ï¼Œæ„Ÿè§‰ç”Ÿæ´»å˜å¾—å……å®äº†å¾ˆå¤šã€‚åˆ«çš„å¥½åƒä¹Ÿæ²¡ä»€ä¹ˆå˜åŒ–ï¼Œè¿˜æ˜¯ä¸€ä¸ªäººåœ¨è¿™åŸå¸‚ä¸­ã€‚\nå·¥ä½œ è¿™ä¸€å¹´å·¥ä½œä¹Ÿç®—æ˜¯æ¯”è¾ƒå¿™ï¼Œäº‹æƒ…æŒºå¤šçš„ã€‚æ•´ä½“çœ‹ä¸‹æ¥ï¼Œä¹Ÿç®—æ˜¯åœ¨å·¥ä½œå’Œç”Ÿæ´»ä¸­æ‰¾åˆ°äº†ä¸€ä¸ªå¹³è¡¡ç‚¹ã€‚å·¥ä½œè¿™ä¹ˆå¤šå¹´äº†ï¼Œå¾ˆå¤šäº‹æƒ…å¤„ç†èµ·æ¥ä¹Ÿç®—æ˜¯æ¯”è¾ƒå¾—å¿ƒåº”æ‰‹ï¼Œ\nä»Šå¹´åœ¨å·¥ä½œä¸Šç®—æ˜¯æ²¡æœ‰é‡åˆ°å¤§çš„å›°éš¾ã€‚ ä»Šå¹´æœ‰å‡ æ¬¡çº¿ä¸Šæµ‹è¯•ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘è´Ÿè´£åï¼Œç¬¬ä¸€æ¬¡ç»å†çº¿ä¸Šæµ‹è¯•ã€‚æµ‹è¯•ä¸­ä¸å‡ºæ„å¤–çš„å‡ºæ„å¤–äº†ã€‚å¥½åœ¨ä¹Ÿæ²¡å‡ºå¤§çš„é—®é¢˜ï¼Œä¹Ÿç®—æ˜¯é¡ºåˆ©é€šè¿‡äº†ã€‚\nç»å†äº†åŠå¤œè¢«å«èµ·æ¥æŸ¥bugï¼Œå¥½åœ¨æœ€åå‘ç°ä¸æ˜¯é‡è¦çš„é—®é¢˜ï¼ŒæœåŠ¡æ²¡æœ‰æŒ‚æ‰ï¼Œåªéœ€è¦åé¢ä¿®å¤å°±è¡Œäº†ã€‚æ¯æ¬¡æµ‹è¯•éƒ½èƒ½å‘ç°ä¸€äº›é—®é¢˜ï¼Œä¹Ÿç®—æ˜¯ä¸€æ¬¡å¾ˆå¥½çš„ç»å†ã€‚æ—©å‘ç°é—®é¢˜æ¯”æ™šå‘ç°é—®é¢˜è¦å¥½å¾ˆå¤šã€‚\nä»Šå¹´å·¥ä½œä¸Šä¹Ÿæ²¡æœ‰ä»€ä¹ˆå¤§çš„å˜åŒ–ï¼Œè¿˜æ˜¯åœ¨åŸæ¥çš„å…¬å¸ï¼Œè¿˜æ˜¯åœ¨åŸæ¥çš„å²—ä½ã€‚å¯èƒ½æ˜¯æ—¶é—´ä¹…äº†ï¼Œå¾ˆå¤šäº‹æƒ…å¤„ç†èµ·æ¥ä¹Ÿç®—æ˜¯æ¯”è¾ƒå¾—å¿ƒåº”æ‰‹ï¼Œä¹Ÿæ²¡æœ‰ä»€ä¹ˆå¤§çš„å›°éš¾ã€‚å°±ä¸€ç¬”å¸¦è¿‡å§ã€‚\nå¼€æºç¤¾åŒº è‡ªä»æ¥è§¦äº†å¼€æºç¤¾åŒºï¼ŒåŸºæœ¬å¹³æ—¶æœ‰ç©ºå°±ä¼šå‚ä¸ä¸€ä¸‹ã€‚ä»Šå¹´ä¹Ÿæ˜¯å‚ä¸äº†ä¸€äº›å¼€æºé¡¹ç›®ï¼Œä¹Ÿæ˜¯æœ‰ä¸€äº›æ”¶è·ã€‚åœ¨ç¤¾åŒºé‡Œè®¤è¯†äº†å¾ˆå¤šæœ‹å‹ï¼Œä¹Ÿå­¦åˆ°äº†å¾ˆå¤šä¸œè¥¿ã€‚\nä»Šå¹´çš„commitæ¬¡æ•°å’Œå»å¹´ç›¸æ¯”ï¼Œä¹Ÿå·®ä¸å¤šå§\nå¥½åƒä¹Ÿæ²¡ä»€ä¹ˆå¥½è¯´çš„äº†ï¼Œå°±è¿™æ ·å§ã€‚2025ç»§ç»­å‚ä¸ã€‚\nother è¿™é‡Œå°±æƒ³åˆ°ä»€ä¹ˆå°±å†™ä»€ä¹ˆå§ã€‚\nåŸæ¥è®¡åˆ’ä»Šå¹´è¦è¯»ä¸€äº›ä¹¦ï¼Œä½†æ˜¯æœ€åä¹Ÿæ²¡è¯»å‡ æœ¬ï¼Œå¹´åˆçš„æ—¶å€™ä¸€å£æ°”çœ‹äº†å¥½å¤šï¼Œåé¢å¼€å§‹éª‘è½¦äº†ï¼Œçœ‹ä¹¦çš„æ—¶é—´å°±å°‘äº†ã€‚æ˜å¹´ç»§ç»­åŠªåŠ›å§ã€‚\nåªæœ‰ã€Šé•¿å®‰çš„è”æã€‹å’Œã€Šå¤ªç™½é‡‘æ˜Ÿæœ‰ç‚¹çƒ¦ã€‹è¿™ä¸¤æœ¬ä¹¦çœ‹å®Œäº†ï¼Œå…¶ä»–çš„éƒ½æ²¡çœ‹å®Œï¼Œæ˜å¹´ç»§ç»­è¯»ã€‚ è¯»äº†è¿™ä¸¤æœ¬ä¹¦åï¼Œè¶Šæ¥è¶Šå–œæ¬¢é©¬ä¼¯åº¸äº†ï¼Œå†™çš„ä¸œè¥¿å¾ˆæœ‰æ„æ€ã€‚å¬è¯´ã€Šé•¿å®‰çš„è”æã€‹è¦æ‹ç”µè§†å‰§äº†ï¼ŒæœŸå¾…ä¸€ä¸‹ã€‚\nä»Šå¹´æŠ€æœ¯æ–‡ç« å†™çš„æ›´å°‘äº†ï¼Œæœ‰æ—¶å€™æ²¡æ‰¾åˆ°å¥½çš„æŠ€æœ¯ç‚¹ï¼Œä¸çŸ¥é“å†™ä»€ä¹ˆã€‚æœ‰å‡ æ¬¡æƒ³å†™ redis æºç çš„è§£è¯»ï¼Œä½†æ˜¯è¿™æ–¹é¢çš„æ–‡ç« å¤ªå¤šäº†ï¼Œä¹Ÿæ²¡ä»€ä¹ˆæ–°æ„ï¼Œå°±ä¸€ç›´æ²¡å†™ã€‚\næœ€è¿‘å¤©å†·äº†ï¼ŒåŸºæœ¬ä¸æ€ä¹ˆéª‘è½¦äº†ã€‚ç©äº†ä¸€ä¸‹ èµ›åšæœ‹å…‹2077ï¼Œå¼€å§‹æ€è€ƒä¸€ä¸ªé—®é¢˜ï¼Œæœªæ¥ç§‘æŠ€æ˜¯å¦çœŸçš„èƒ½å‘å±•åˆ°æ¸¸æˆé‡Œé‚£æ ·ï¼Œäººç±»æ˜¯å¦çœŸçš„èƒ½å®ç°æ„è¯†çš„æ°¸ç”Ÿã€‚ ä¸çŸ¥é“é©¬æ–¯å…‹çš„ neuralink ä¼šä¸ä¼šå®ç°ï¼Œå¦‚æœå®ç°äº†ï¼Œäººç±»çš„æœªæ¥ä¼šæ˜¯ä»€ä¹ˆæ ·å­ã€‚èƒ½ä¸èƒ½åƒæ¸¸æˆé‡Œé‚£æ ·ï¼Œäººç±»çš„æ„è¯†å¯ä»¥æ°¸ç”Ÿï¼Œå¯ä»¥åœ¨ä¸åŒçš„æœºå™¨äººèº«ä¸Šè½¬ç§»ã€‚ å¦‚æœçœŸçš„å®ç°äº†ï¼Œä¼šä¸ä¼šç»™è¿™ä¸ªä¸–ç•Œå¸¦æ¥æ›´å¤šçš„é—®é¢˜ï¼Œäººç±»çš„æ„è¯†æ°¸ç”Ÿï¼Œä¼šä¸ä¼šå¯¼è‡´äººç±»çš„ç­äº¡ã€‚\nè€ç”Ÿå¸¸è°ˆçš„äº‹æƒ…ï¼Œä»Šå¹´è¿˜æ˜¯ä¸€ä¸ªäººï¼Œæ˜å¹´ç»§ç»­åŠªåŠ›å§ã€‚\n2025 2025å¹´ï¼Œç»§ç»­åœ¨ä¸€äº›æ–¹é¢å°è¯•çªç ´è‡ªå·±ï¼Œåƒæ˜¯ä»Šå¹´çš„éª‘è½¦ï¼Œç®—æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„å°è¯•ï¼Œè®¤è¯†äº†å¾ˆå¤šæ–°çš„æœ‹å‹ï¼Œä¹Ÿæœ‰äº†ä¸€äº›æ–°çš„ç»å†ï¼Œä¹Ÿçœ‹åˆ°äº†ä¸€äº›ä»¥å‰æ²¡æœ‰çœ‹è¿‡çš„é£æ™¯ã€‚\nè‡³äºç›®æ ‡å•¥çš„ä¹Ÿåˆ«å®šäº†ï¼Œè‡ªå·±å•¥æ‰§è¡ŒåŠ›è‡ªå·±ä¹Ÿæ¸…æ¥šï¼ŒåŠªåŠ›è¿‡å¥½æ¯ä¸€å¤©ã€‚\nGood luck next year\n","date":"2024-12-31T18:25:29+08:00","image":"https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/83e38256ec22b91652d36e1d8b6f5397a55d5dbc.jpg","permalink":"https://lqxhub.github.io/posts/0893a8b9/","title":"æˆ‘çš„2024"},{"content":"æœ€è¿‘ï¼Œæˆ‘å°†æˆ‘çš„åšå®¢ä»Hexoè¿ç§»åˆ°äº†Hugoã€‚èµ·å› æ˜¯æœ€è¿‘åœ¨æŸ¥èµ„æ–™çš„æ—¶å€™ï¼Œå‘ç°äº†ä¸€ä¸ªå¾ˆå¥½çœ‹çš„åšå®¢ï¼Œçœ‹åˆ°æ˜¯ç”¨Hugoç”Ÿæˆçš„ï¼Œäºæ˜¯å°±èŒç”Ÿäº†ä»Hexoè¿ç§»åˆ°æŠ¤å›½çš„æƒ³æ³•ã€‚ Hexoå…¶å®ä¹ŸæŒºå¥½ç”¨çš„ï¼Œå½“æ—¶æˆ‘è‡ªå»ºblogçš„æ—¶å€™ï¼Œå°±å·²ç»æœ‰Hugoäº†ï¼Œä½†æ˜¯å½“æ—¶Hugoçš„èµ„æ–™ä¸å¤šï¼Œäºæ˜¯å°±é€‰äº†äº†Hexoã€‚è¿™æ˜¯æƒ³è¦æ¢åˆ°Hugoï¼Œä¸»è¦æ˜¯çœ‹ä¸­äº† Hugoä¸­ Stack è¿™ä¸ªä¸»é¢˜ã€‚ è¿˜ä¸€ä¸ªåŸå› æ˜¯æˆ‘ä¸å–œæ¬¢Hexoä½¿ç”¨ Node.jsã€‚æˆ‘ä¸€ä¸ªå†™åç«¯çš„ï¼Œå¹³æ—¶ä¹Ÿç”¨ä¸åˆ°Nodeï¼Œè€Œä¸”å¯¹ npm çš„å‘½ä»¤ä¹Ÿä¸ç†Ÿæ‚‰ï¼Œæ€»ä¹‹ç”¨èµ·æ¥å°±å¾ˆåˆ«æ‰­ã€‚ Hugoè¿˜ä¸€ä¸ªä¼˜ç‚¹æ˜¯æ„å»ºçš„é€Ÿåº¦æ¯”Hexoå¿«å¾—å¤šï¼Œå½“ç„¶æˆ‘ç›®å‰ä½¿ç”¨Hexoè¿˜æ²¡æœ‰åœ¨æ„å»ºä¸ŠèŠ±è´¹å¤ªå¤šæ—¶é—´ã€‚å¥½äº†é—²è¯å°±è¯´åˆ°è¿™é‡ŒæŠŠï¼Œä¸‹é¢æˆ‘å°†åˆ†äº«ä¸€äº›å…³äºå¦‚ä½•å°†Hexoè¿ç§»åˆ°Hugoçš„ç»éªŒã€‚\nåœ¨å¼€å§‹ä¹‹å‰ï¼Œéœ€è¦å…ˆä¸‹è½½Hugoï¼Œå¯ä»¥å»GitHubä¸‹è½½ã€‚ä¸‹è½½çš„æ—¶å€™ï¼Œéœ€è¦æ ¹æ®è‡ªå·±çš„ç³»ç»Ÿé€‰æ‹©å¯¹åº”çš„ç‰ˆæœ¬ï¼Œä¸‹è½½çš„æ—¶å€™è®°å¾—ä¸‹è½½ extended çš„ç‰ˆæœ¬ã€‚ è¿™æ˜¯æ”¯æŒ SCSS å’Œ PostCSS çš„ç‰ˆæœ¬ã€‚ ä¸‹è½½å®Œæˆåï¼Œè§£å‹åˆ°ä¸€ä¸ªç›®å½•ï¼Œç„¶åå°†è§£å‹åçš„ç›®å½•æ·»åŠ åˆ°ç¯å¢ƒå˜é‡ä¸­ã€‚ å®‰è£…å®Œæˆåï¼Œå¯ä»¥é€šè¿‡ hugo version å‘½ä»¤æŸ¥çœ‹æ˜¯å¦å®‰è£…æˆåŠŸã€‚\næˆ‘å°†åˆ† Hugoé…ç½® å’Œ è‡ªå®šä¹‰ è¿™ä¸¤ä¸ªéƒ¨åˆ†æ¥è®²ã€‚\nHugoé…ç½® å› ä¸º Hugo ä¸­ï¼Œå¾ˆå¤šç›®å½•åœ¨ é¡¹ç›®ç›®å½• å’Œ themesï¼ˆä¸»é¢˜ï¼‰ ç›®å½•ä¸‹éƒ½æœ‰ï¼Œæ‰€ä»¥åœ¨ä»‹ç»çš„æ—¶å€™ï¼Œæ²¡æœ‰ç‰¹æ®Šè¯´æ˜éƒ½æ˜¯åœ¨ é¡¹ç›®ç›®å½• ä¸‹ã€‚\nHugoé…ç½®æ–‡ä»¶ Hugoé…ç½®æ–‡ä»¶æ”¯æŒå¤šç§æ ¼å¼ï¼Œæ¯”å¦‚ tomlã€yamlã€jsonã€‚æˆ‘é€‰æ‹©çš„æ˜¯ yaml æ ¼å¼ã€‚Hugoçš„é…ç½®æ–‡ä»¶æ˜¯ æ ¹ç›®å½•çš„config.yaml\nä¸‹é¢æ ¹æ®å±‚çº§æ¥ä»‹ç»ä¸€ä¸‹Hugoçš„é…ç½®æ–‡ä»¶\nè¿™æ˜¯æ ¹å±‚çš„é…ç½®ï¼Œä¸»è¦æ˜¯ä¸€äº›åŸºæœ¬çš„é…ç½®ï¼Œæ¯”å¦‚ç½‘ç«™çš„åŸºç¡€URLã€ç½‘ç«™çš„è¯­è¨€ã€é»˜è®¤çš„å†…å®¹è¯­è¨€ã€ä½¿ç”¨çš„ä¸»é¢˜ã€æ¯é¡µæ˜¾ç¤ºå¤šå°‘æ–‡ç« ã€ç½‘ç«™çš„æ ‡é¢˜ç­‰ã€‚\n1baseurl: https://lqxhub.github.io # ç½‘ç«™çš„åŸºç¡€URL 2languageCode: zh-cn # ç½‘ç«™çš„è¯­è¨€ 3defaultContentLanguage: \u0026#34;zh-cn\u0026#34; # é»˜è®¤çš„å†…å®¹è¯­è¨€ 4theme: hugo-theme-stack # ä½¿ç”¨çš„ä¸»é¢˜ 5paginate: 10 # æ¯é¡µæ˜¾ç¤ºå¤šå°‘æ–‡ç«  6title: \u0026#34;QX çš„ç¬”è®°\u0026#34; # ç½‘ç«™çš„æ ‡é¢˜ 7hasCJKLanguage: true # æ˜¯å¦ä½¿ç”¨CJKè¯­è¨€,ç”¨åˆ°ä¸­æ–‡çš„æ—¶å€™éœ€è¦è®¾ç½®ä¸ºtrue 8summaryLength: 200 # æ‘˜è¦çš„é•¿åº¦ 9enablePermalinks: true # å¯ç”¨æ°¸ä¹…é“¾æ¥ 10enableEmoji: true # å¼€å¯ Emoji æ”¯æŒ 11enableInlineShortcodes: true # å¼€å¯å†…è” Shortcodes æ”¯æŒ 12noTimes: false # åŒæ­¥æ–‡ä»¶çš„ä¿®æ”¹æ—¶é—´ã€‚ è¿™äº›é…ç½®æ²¡æœ‰ä»€ä¹ˆå¥½è¯´çš„ï¼Œå°±æ˜¯ä¸€äº›åŸºæœ¬çš„é…ç½®ï¼Œæ ¹æ®è‡ªå·±çš„éœ€æ±‚æ¥é…ç½®å°±å¥½ã€‚\n1permalinks: 2 post: /posts/:slug/ # æ–‡ç« çš„æ°¸ä¹…é“¾æ¥ 3 page: /:slug/ # é¡µé¢çš„æ°¸ä¹…é“¾æ¥ è¿™ä¸ªé…ç½®æ˜¯æ–‡ç« å’Œé¡µé¢çš„æ°¸ä¹…é“¾æ¥ï¼Œæ–‡ç« çš„æ°¸ä¹…é“¾æ¥æ˜¯ /posts/:slug/ï¼Œé¡µé¢çš„æ°¸ä¹…é“¾æ¥æ˜¯ /:slug/ã€‚ è¿™é‡Œçš„ :slug æ˜¯æ–‡ç« ç”Ÿæˆçš„ hash å€¼ï¼Œå› ä¸ºæˆ‘å†Hexoä¸­çš„æ–‡ç« çš„ hashå€¼ï¼Œæ‰€ä»¥è¿™é‡Œä¹Ÿä½¿ç”¨ hashå€¼ã€‚ åé¢åœ¨æ„å»ºçš„æ—¶å€™ï¼Œé¡µé¢çš„ URL æ ¼å¼æ˜¯ baseurl/posts/slugã€‚æ¯”å¦‚è¿™ç¯‡æ–‡ç« çš„ URL æ˜¯ https://lqxhub.github.io/posts/a660c9b1/ã€‚\n1params: 2 mainSections: # é¦–é¡µä»å“ªäº›éƒ¨åˆ†è·å–æ–‡ç«  3 - post 4 dateFormat: # æ—¥æœŸæ ¼å¼,å¿…é¡»æ˜¯ç¬¦åˆ Go è¯­è¨€çš„æ—¥æœŸæ ¼å¼ 5 published: Jan 02, 2006 # å‘å¸ƒæ—¥æœŸ 6 lastUpdated: Jan 02, 2006 15:04 MST # æœ€åæ›´æ–°æ—¥æœŸ 7 8 footer: # é¡µè„šçš„é…ç½® 9 enable: true # æ˜¯å¦å¯ç”¨é¡µè„š 10 since: 2021 # ç½‘ç«™åˆ›å»ºå¹´ä»½ 11 customText: \u0026#34;Â© QX\u0026#34; # é¡µè„šçš„è‡ªå®šä¹‰æ–‡æœ¬ 12 copyright: true # æ˜¯å¦æ˜¾ç¤ºç‰ˆæƒä¿¡æ¯ 13 author: true # æ˜¯å¦æ˜¾ç¤ºä½œè€…ä¿¡æ¯ 14 15 favicon: icons/favicon.ico # æµè§ˆå™¨ Tab é¡µçš„ç½‘ç«™å›¾æ ‡ 16 sidebar: # ä¾§è¾¹æ çš„é…ç½® 17 emoji: ğŸ˜‰ 18 subtitle: \u0026#34;é›„å…³æ¼«é“çœŸå¦‚é“ï¼Œè€Œä»Šè¿ˆæ­¥ä»å¤´è¶Š\u0026#34; 19 avatar: # ä½œè€…å¤´åƒ 20 enabled: true 21 local: true 22 src: img/avatar.gif 23 24 featuredImageField: image # æ–‡ç« çš„å°é¢å›¾ç‰‡ä»å“ªä¸ªå­—æ®µè·å–,è¿™é‡Œæ˜¯ä»imageå­—æ®µè·å– 25 rssFullContent: false # RSS æ˜¯å¦å¼€å¯å…¨å†…å®¹ / false åˆ™ä¸ºåªæœ‰æ‘˜è¦ 26 27 article: # æ–‡ç« çš„é…ç½® 28 headingAnchor: true # æ˜¯å¦å¼€å¯æ ‡é¢˜é”šç‚¹ 29 math: true # è¿™é‡Œå…³é—­æ˜¯å› ä¸ºæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ MathJax 30 toc: false # TOC æ–‡ç« ä¹Ÿå³è¾¹çš„å¯¼èˆª 31 readingTime: true # é˜…è¯»æ—¶é—´ 32 license: # æ–‡ç« çš„ç‰ˆæƒä¿¡æ¯ 33 enabled: true # æ˜¯å¦å¯ç”¨ç‰ˆæƒä¿¡æ¯ 34 default: \u0026#39;Licensed under CC BY-NC-SA 4.0\u0026#39; # é»˜è®¤çš„ç‰ˆæƒä¿¡æ¯ 35 36 widgets: # ç½‘é¡µä¸­å³è¾¹çš„å°éƒ¨ä»¶ 37 homepage: # é¦–é¡µçš„å°éƒ¨ä»¶ 38 - type: search # æœç´¢æ¡† 39 - type: archives # å½’æ¡£ 40 params: 41 limit: 5 # å½’æ¡£æ˜¾ç¤ºçš„æ•°é‡ 42 - type: categories # åˆ†ç±» 43 params: 44 limit: 10 # åˆ†ç±»æ˜¾ç¤ºçš„æ•°é‡ 45 - type: tag-cloud # æ ‡ç­¾äº‘ 46 params: 47 limit: 10 # æ ‡ç­¾äº‘æ˜¾ç¤ºçš„æ•°é‡ 48 page: 49 - type: \u0026#34;toc\u0026#34; # TOC æ–‡ç« ä¹Ÿå³è¾¹çš„å¯¼èˆª 50 51 colorScheme: # é¢œè‰²ä¸»é¢˜ 52 toggle: true # æ˜¯å¦æ˜¾ç¤ºåˆ‡æ¢æŒ‰é’® 53 # Available values: auto, light, dark 54 default: auto # é»˜è®¤çš„é¢œè‰²ä¸»é¢˜ è¿™é‡Œé…ç½®é¡¹æ¯”è¾ƒå¤šï¼ŒæŒ‘å‡ ä¸ªä¸å¥½ç†è§£çš„æ¥è¯´ä¸€ä¸‹ã€‚\nè¿™éƒ¨åˆ†å°±æ˜¯ footer é…ç½®å¯¹åº”å›¾ç‰‡åº”è¯¥èƒ½çœ‹æ‡‚ï¼Œè¿™é‡Œå°±ä¸å¤šè¯´äº†ã€‚\nç›¸å…³çš„é…ç½®éƒ½åœ¨å›¾ç‰‡é‡Œæ ‡æ³¨äº†\nsidebar é…ç½®æ˜¯ä¾§è¾¹æ çš„é…ç½®ï¼Œè¿™é‡Œé…ç½®äº†ä½œè€…çš„å¤´åƒã€ä½œè€…çš„åå­—ã€ä½œè€…çš„åº§å³é“­ã€ä½œè€…çš„å¤´åƒç­‰ã€‚\nwidgets é…ç½®æ˜¯ç½‘é¡µä¸­å³è¾¹çš„å°éƒ¨ä»¶ï¼Œè¿™é‡Œé…ç½®äº†é¦–é¡µçš„å°éƒ¨ä»¶ï¼ŒåŒ…æ‹¬æœç´¢æ¡†ã€å½’æ¡£ã€åˆ†ç±»ã€æ ‡ç­¾ç­‰ã€‚æœ‰ä¸æƒ³æ˜¾ç¤ºçš„ï¼Œåœ¨é…ç½®ä¸­åˆ é™¤å°±è¡Œã€‚\nä¸‹é¢æ˜¯ mene ç›¸å…³çš„é…ç½®\n1menu: 2 main: 3 - identifier: home 4 name: é¦–é¡µ 5 url: / 6 weight: -100 7 params: 8 newTab: false 9 icon: home 10 - identifier: categories 11 name: åˆ†ç±» 12 url: /categories 13 weight: 1 14 params: 15 newTab: false 16 icon: categories 17 social: 18 - identifier: email 19 name: Email 20 url: mailto:lqxlucky@qq.com 21 params: 22 newTab: true 23 icon: email 24 - identifier: github 25 name: GitHub 26 url: https://github.com/lqxhub 27 params: 28 newTab: true 29 icon: brand-github è¿™æ˜¯ç²¾ç®€åçš„ï¼Œåœ¨å›¾ç‰‡ä¸­ï¼Œsidebar ä¸‹é¢çš„æ˜¯ social çš„é…ç½®ï¼Œå†å¾€ä¸‹æ˜¯ main çš„é…ç½®ã€‚\nè¿™é‡Œè¯´ä¸€ä¸‹ main ä¸­çš„ä¸€äº›é—®é¢˜\nidentifierï¼šæ ‡è¯†ç¬¦ name èœå•çš„åå­— url èœå•çš„é“¾æ¥ weight æ˜¯æƒé‡ï¼Œæƒé‡è¶Šå°ï¼Œèœå•è¶Šé å‰ã€‚ newTab æ˜¯å¦åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€ icon èœå•çš„å›¾æ ‡ å¦‚æœä¸éœ€è¦è‡ªå®šä¹‰çš„è¯ï¼Œç›´æ¥é…ç½®å°±è¡Œäº†ï¼Œåœ¨æ„å»ºçš„æ—¶å€™ï¼Œä¼šè‡ªåŠ¨ç”Ÿæˆèœå•ã€‚ä¸€äº› icon å¯èƒ½ä¸»é¢˜ä¸­æ²¡æœ‰ï¼Œéœ€è¦è‡ªå·±æ·»åŠ ï¼Œæˆ‘å†é…ç½®æ—¶æœ‰å¥½å‡ ä¸ªæ²¡æœ‰æ‰¾åˆ°ï¼Œ æˆ‘ä½¿ç”¨ chatGPT ç”Ÿæˆäº†ä¸€äº›å›¾æ ‡\nå¦‚æœè¦è‡ªå®šä¹‰ï¼Œé‚£ä¹ˆéœ€è¦åœ¨ content ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªå’Œ è®¿é—®è¿™ä¸ªé¡µé¢çš„ URL åŒåçš„ç›®å½•ï¼Œç„¶ååœ¨æ–°å»ºçš„ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª _index.md æ–‡ä»¶ï¼Œ ç„¶ååœ¨ _index.md æ–‡ä»¶ä¸­é…ç½®\nä»¥ åˆ†ç±» ä¸ºä¾‹ï¼Œcontent/categories/_index.md çš„é…ç½®å¦‚ä¸‹ï¼š\n1--- 2title: \u0026#34;åˆ†ç±»\u0026#34; 3license: false 4--- è¿™é‡Œä¸»è¦æ˜¯æ”¹ä¸€ä¸‹ titleï¼Œåªæœ‰ ç½‘é¡µçš„æ ‡é¢˜å’Œ é…ç½®ä¸­çš„ name ç›¸åŒæ—¶ï¼Œåœ¨ç‚¹å‡»å¯¹åº”çš„èœå•åï¼Œå¯¹åº”çš„èœå•åæ‰ä¼šé«˜äº®ã€‚\nsocial éƒ½æ˜¯å¸¸è§çš„å†…å®¹ï¼Œè¿™é‡Œå°±ä¸å¤šè¯´äº†ã€‚\né¡µé¢æ¸²æŸ“ç›¸å…³çš„é…ç½®ï¼š\n1markup: 2 defaultMarkdownHandler: goldmark 3 tableOfContents: # TOC æ–‡ç« ä¹Ÿå³è¾¹çš„å¯¼èˆª 4 ordered: true # æ˜¯å¦æœ‰åº 5 startLevel: 2 # ä» 2çº§æ ‡é¢˜å¼€å§‹ 6 endLevel: 5 # åˆ° 5çº§æ ‡é¢˜ç»“æŸ 7 highlight: # ä»£ç é«˜äº®é…ç½® 8 codeFences: true # æ˜¯å¦å¯ç”¨ä»£ç å— 9 guessSyntax: true # æ˜¯å¦çŒœæµ‹è¯­æ³• 10 lineNoStart: 1 # ä»£ç å—çš„èµ·å§‹è¡Œå· 11 lineNos: true # æ˜¯å¦æ˜¾ç¤ºè¡Œå· 12 lineNumbersInTable: false # æ˜¯å¦åœ¨è¡¨æ ¼ä¸­æ˜¾ç¤ºè¡Œå· 13 noClasses: true # æ˜¯å¦ä¸ä½¿ç”¨ç±» 14 style: \u0026#34;dracula\u0026#34; # ä»£ç å—çš„æ ·å¼ 15 tabWidth: 4 # tab çš„å®½åº¦ è¿™éƒ¨åˆ†ä¹Ÿæ˜¯æ¯”è¾ƒå¥½ç†è§£çš„ï¼Œä¸»è¦æ˜¯ä»£ç é«˜äº®çš„é…ç½®ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯ dracula ä¸»é¢˜ã€‚ ä¸åŒä¸»é¢˜çš„æ•ˆæœï¼Œå¯ä»¥å»è¿™é‡ŒæŸ¥çœ‹ã€‚\né¡µé¢ä¸­çš„é…ç½® åœ¨æ¯ç¯‡æ–‡ç« çš„ front matter ä¸­ï¼Œå¯ä»¥é…ç½®ä¸€äº›æ–‡ç« çš„ä¿¡æ¯ï¼Œæ¯”å¦‚æ–‡ç« çš„æ ‡é¢˜ã€ä½œè€…ã€æ—¥æœŸã€æ ‡ç­¾ã€åˆ†ç±»ç­‰ã€‚ å¯ä»¥ä½¿ç”¨ yamlã€toml ç­‰ï¼Œæˆ‘ä½¿ç”¨çš„æ˜¯ YAML æ ¼å¼ã€‚ ä½¿ç”¨ --- æ¥åˆ†éš” æ˜¯ yaml æ ¼å¼çš„é…ç½®ï¼Œä½¿ç”¨ +++ æ¥åˆ†éš”æ˜¯ toml æ ¼å¼çš„é…ç½®ã€‚\n1+++ 2date = 2024-10-20T17:31:37+08:00 3title = \u0026#34;Linuxä¸‹ä½¿ç”¨iouringå®ç°ä¸€ä¸ªtcpæœåŠ¡\u0026#34; 4slug = \u0026#34;f0e9829c\u0026#34; 5categories = [\u0026#34;linux\u0026#34;, \u0026#34;C++\u0026#34;] 6tags = [\u0026#34;linux\u0026#34;, \u0026#34;iouring\u0026#34;, \u0026#34;tcp\u0026#34;, \u0026#34;C++\u0026#34;] 7description = \u0026#34;æ¢ç´¢ Linux io_uring å¼‚æ­¥ I/O æ¥å£ï¼Œé€šè¿‡ liburing åº“å®ç°é«˜æ•ˆ TCP æœåŠ¡ã€‚æœ¬æ–‡æ·±å…¥ io_uring çš„åŸºç¡€æ¦‚å¿µï¼ŒåŒ…æ‹¬ Submission Queue å’Œ Completion Queueï¼Œå¹¶é€šè¿‡ç¤ºä¾‹ä»£ç æ¼”ç¤ºå¦‚ä½•åˆå§‹åŒ–ã€æäº¤ I/O è¯·æ±‚å’Œå¤„ç†å®Œæˆäº‹ä»¶ã€‚äº†è§£ io_uring å¦‚ä½•æå‡ I/O å¯†é›†å‹åº”ç”¨çš„æ€§èƒ½ï¼Œä»¥åŠåœ¨å®é™…éƒ¨ç½²ä¸­éœ€è¦æ³¨æ„çš„é”™è¯¯å¤„ç†å’Œè¿æ¥ç®¡ç†ã€‚\u0026#34; 8image = \u0026#34;https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/6a84474a44a97bccecbbc9c5a3b9f7aea2571c97.jpg\u0026#34; 9+++ è¿™é‡Œç®€å•è¯´ä¸€ä¸‹\ndate æ–‡ç« çš„æ—¥æœŸï¼Œå¿…é¡»æ˜¯ GO è¯­è¨€çš„æ—¥æœŸæ ¼å¼ title æ–‡ç« çš„æ ‡é¢˜ slug æ–‡ç« çš„æ°¸ä¹…é“¾æ¥ categories æ–‡ç« çš„åˆ†ç±»ï¼Œå¯ä»¥æœ‰å¤šä¸ªï¼ŒHugoåœ¨æ„å»ºçš„æ—¶å€™ï¼Œä¼šè‡ªåŠ¨ç”Ÿæˆåˆ†ç±»çš„é¡µé¢ tags æ–‡ç« çš„æ ‡ç­¾ï¼Œå¯ä»¥æœ‰å¤šä¸ªï¼ŒHugoåœ¨æ„å»ºçš„æ—¶å€™ï¼Œä¼šè‡ªåŠ¨ç”Ÿæˆæ ‡ç­¾çš„é¡µé¢ description æ–‡ç« çš„æè¿°ï¼Œä¼šåœ¨é¦–é¡µçš„æ–‡ç« åˆ—è¡¨ä¸­æ˜¾ç¤ºï¼Œä¹Ÿæ˜¯ SEO çš„ä¸€éƒ¨åˆ† image æ–‡ç« çš„å°é¢å›¾ç‰‡ï¼Œä¼šåœ¨é¦–é¡µçš„æ–‡ç« åˆ—è¡¨ä¸­æ˜¾ç¤º åœ¨è¯´ä¸€ä¸‹ åˆ†ç±» ä¸­çš„å°é¢\nä¹Ÿå°±æ˜¯å›¾ç‰‡ä¸­æ ‡æ³¨çš„éƒ¨åˆ†ï¼Œè¿™ä¸ªæ˜¯åˆ†ç±»çš„å°é¢ï¼Œå¦‚æœä¸é…ç½®çš„è¯ï¼Œä¼šä½¿ç”¨é»˜è®¤çš„å°é¢ï¼Œå¦‚æœæƒ³è¦è‡ªå®šä¹‰çš„è¯ï¼Œå¯ä»¥åœ¨ content/categories ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªå’Œ åˆ†ç±» åŒåçš„ç›®å½•ï¼Œ æ¯”å¦‚ content/categories/linuxï¼Œç„¶ååœ¨ linux ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª _index.md æ–‡ä»¶ï¼Œç„¶ååœ¨ _index.md æ–‡ä»¶ä¸­é…ç½®\n1--- 2title: \u0026#34;linux\u0026#34; 3slug: \u0026#34;linux\u0026#34; 4image: \u0026#34;https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/Linux.jpg\u0026#34; 5weight: 10 6--- å…¶ä¸­ image å°±æ˜¯åˆ†ç±»çš„å°é¢ï¼Œweight æ˜¯æƒé‡ï¼Œæƒé‡è¶Šå°ï¼Œåˆ†ç±»è¶Šé å‰ã€‚\næœç´¢ é¡µé¢çš„é…ç½®ï¼Œåœ¨æ·»åŠ äº†æœç´¢é¡µé¢çš„æ—¶å€™ï¼Œéœ€è¦åœ¨ content/search ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª index.md æ–‡ä»¶ï¼Œç„¶ååœ¨ index.md æ–‡ä»¶ä¸­é…ç½®\n1--- 2title: \u0026#34;æœç´¢\u0026#34; 3layout: \u0026#34;search\u0026#34; 4outputs: 5 - \u0026#34;html\u0026#34; 6 - \u0026#34;json\u0026#34; 7sitemap: 8 priority: 0.1 9--- å¦‚æœæ²¡æœ‰é…ç½® outputs çš„è¯ï¼Œæœç´¢é¡µä¸­çš„æœç´¢åŠŸèƒ½æ˜¯æ— æ•ˆçš„ï¼Œè¿™é‡Œé…ç½®äº† html å’Œ jsonï¼Œè¿™æ ·å°±å¯ä»¥åœ¨æœç´¢é¡µä¸­æœç´¢æ–‡ç« äº†ã€‚\n1 2## è¿ç§»åˆ°Hugo 3 4### åˆ›å»ºHugoé¡¹ç›® 5åœ¨è¿ç§»ä¹‹å‰ï¼Œéœ€è¦å…ˆåˆ›å»ºä¸€ä¸ªHugoé¡¹ç›®ã€‚åœ¨Hexoä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ `hexo init` å‘½ä»¤æ¥åˆ›å»ºä¸€ä¸ªHexoé¡¹ç›®ã€‚è€Œåœ¨Hugoä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ `hugo new site` å‘½ä»¤æ¥åˆ›å»ºä¸€ä¸ªHugoé¡¹ç›®ã€‚ 6 7```shell 8hugo new site blog public æ˜¯æ„å»ºåç”Ÿæˆçš„ç›®å½•ï¼Œä¹Ÿå°±æ˜¯ç”Ÿæˆç½‘ç«™çš„æ ¹ç›®å½• content ç›®å½•æ˜¯å­˜æ”¾æ–‡ç« çš„ç›®å½•ï¼Œ layouts ç›®å½•æ˜¯å­˜æ”¾æ¨¡æ¿çš„ç›®å½•ï¼Œstatic ç›®å½•æ˜¯å­˜æ”¾é™æ€æ–‡ä»¶çš„ç›®å½•ï¼Œ è¿™ä¸ªç›®å½•çš„å†…å®¹åœ¨æ„å»ºæ—¶ä¼šç›´æ¥å¤åˆ¶åˆ°ç½‘ç«™çš„æ ¹ç›®å½•ä¸‹ã€‚themes ç›®å½•æ˜¯å­˜æ”¾ä¸»é¢˜çš„ç›®å½•ã€‚è¿™äº›ç›®å½•éƒ½æ˜¯Hugoåˆ›å»ºé¡¹ç›®æ—¶è‡ªåŠ¨ç”Ÿæˆçš„ã€‚ åˆ«çš„ç›®å½•åœ¨åé¢ç”¨åˆ°çš„æ—¶å€™å†ä»‹ç»ã€‚\nè¿ç§»æ–‡ç«  åœ¨Hexoä¸­ï¼Œæ–‡ç« æ˜¯å­˜æ”¾åœ¨ source/_posts ç›®å½•ä¸‹çš„ï¼Œè€Œåœ¨Hugoä¸­ï¼Œæ–‡ç« æ˜¯å­˜æ”¾åœ¨ content ç›®å½•ä¸‹çš„ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦å°†Hexoä¸­çš„æ–‡ç« è¿ç§»åˆ°Hugoä¸­ã€‚\næˆ‘çš„ä¹ æƒ¯è¿˜æ˜¯åœ¨ content ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª post ç›®å½•ï¼Œç„¶åå°†Hexoä¸­çš„æ–‡ç« è¿ç§»åˆ° post ç›®å½•ä¸‹ã€‚è¿ç§»å®Œæˆåï¼Œç›®å½•ç»“æ„å¦‚ä¸‹ï¼š\nç„¶åæŠŠHexoä¸­çš„æ–‡ç« è¿ç§»åˆ° post ç›®å½•ä¸‹ã€‚è¿™æ ·å°±å®Œæˆäº†æ–‡ç« çš„è¿ç§»ã€‚è¿™æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ hugo å‘½ä»¤æ¥æ„å»ºé¡¹ç›®ï¼Œ è¿™æ—¶å€™å¤§æ¦‚ç‡æ˜¯æ„å»ºå¤±è´¥çš„ï¼Œå› ä¸ºæˆ‘ä»¬è¿˜æ²¡æœ‰é…ç½®Hugoçš„é…ç½®æ–‡ä»¶ã€‚\né¦–å…ˆè¦è§£å†³çš„æ˜¯ front matter çš„é—®é¢˜ï¼ŒHugoä¸­çš„ date å¿…é¡»æ˜¯ Go è¯­è¨€çš„æ—¥æœŸæ ¼å¼ï¼Œè¿™é‡Œéœ€è¦æ”¹æˆ Go è¯­è¨€çš„æ—¥æœŸæ ¼å¼ã€‚ åœ¨Hugoä¸­ï¼Œæ°¸ä¹…è¿æ¥çš„æ˜¯ slugï¼Œå¦‚æœåŸæ¥æ–‡ç« ä½¿ç”¨äº†æ°¸ä¹…è¿æ¥ï¼Œéœ€è¦æ”¹ä¸€ä¸‹ã€‚\nè¿ç§»å›¾ç‰‡ æˆ‘çš„å›¾ç‰‡æ˜¯ä½¿ç”¨çš„ GitHub ä½œä¸ºå›¾åºŠï¼Œæ‰€ä»¥å›¾ç‰‡çš„é“¾æ¥æ˜¯ GitHub çš„é“¾æ¥ã€‚ä¸éœ€è¦æ”¹åŠ¨ï¼Œç›´æ¥ä½¿ç”¨å°±è¡Œã€‚\nåˆ°è¿™é‡Œï¼Œåº”è¯¥èƒ½æˆåŠŸæ„å»ºå‡ºç½‘ç«™äº†ï¼Œä¸‹é¢æ˜¯ä¸€äº›è‡ªå®šä¹‰çš„å†…å®¹ã€‚\nè‡ªå®šä¹‰Hugo æˆ‘ä½¿ç”¨çš„æ˜¯ Stack ä¸»é¢˜ï¼Œè¿™ä¸ªä¸»é¢˜æ˜¯æˆ‘åœ¨æŸ¥èµ„æ–™çš„æ—¶å€™å‘ç°çš„ï¼Œè§‰å¾—æŒºå¥½çœ‹çš„ï¼Œæ‰€ä»¥å°±é€‰æ‹©äº†è¿™ä¸ªä¸»é¢˜ã€‚ä½†æ˜¯ä¸»é¢˜å†…ä¸€äº›ä¸œè¥¿æ²¡æœ‰ï¼Œéœ€è¦è‡ªå·±æ·»åŠ ã€‚\nè¿™é‡Œå…ˆä»‹ç»ä¸€ä¸‹HugoåŠ è½½æ–‡ä»¶çš„é¡ºåºï¼ŒHugoåŠ è½½æ–‡ä»¶çš„é¡ºåºæ˜¯ themes ç›®å½•ä¸‹çš„æ–‡ä»¶ä¼˜å…ˆçº§æœ€é«˜ï¼Œç„¶åæ˜¯é¡¹ç›®ä¸­ layouts ç›®å½•ä¸‹çš„æ–‡ä»¶ï¼Œæœ€åæ˜¯ archetypes ç›®å½•ä¸‹çš„æ–‡ä»¶ã€‚\nå¦‚æœé¡¹ç›®ä¸­çš„ layouts ç›®å½•ä¸­æœ‰å’Œ themes ç›®å½•ä¸­çš„æ–‡ä»¶åŒåçš„æ–‡ä»¶ï¼Œé‚£ä¹ˆé¡¹ç›®ä¸­çš„æ–‡ä»¶ä¼šè¦†ç›– themes ç›®å½•ä¸­çš„æ–‡ä»¶ã€‚è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥è‡ªå®šä¹‰ä¸»é¢˜äº†ã€‚\nè‡ªå®šä¹‰å‹é“¾é¡µ åœ¨ layouts/shortcodes ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª friends.html æ–‡ä»¶ï¼Œç„¶ååœ¨ friends.html æ–‡ä»¶ä¸­é…ç½®\n1 2{{- $css := resources.Get \u0026#34;extended/blank.css\u0026#34; }} 3{{- if $css }} 4{{- $css := $css | resources.ToCSS | resources.Minify }} 5\u0026lt;link rel=\u0026#34;stylesheet\u0026#34; href=\u0026#34;{{ $css.RelPermalink }}\u0026#34;\u0026gt; 6{{- end }} 7 8{{- if .IsNamedParams -}} 9\u0026lt;a target=\u0026#34;_blank\u0026#34; href={{ .Get \u0026#34;url\u0026#34; }} title={{ .Get \u0026#34;name\u0026#34; }} class=\u0026#34;friendurl\u0026#34;\u0026gt; 10\u0026lt;div class=\u0026#34;frienddiv\u0026#34;\u0026gt; 11 \u0026lt;div class=\u0026#34;frienddivleft\u0026#34;\u0026gt; 12 \u0026lt;img class=\u0026#34;myfriend\u0026#34; src={{ .Get \u0026#34;logo\u0026#34; }} /\u0026gt; 13 \u0026lt;/div\u0026gt; 14 \u0026lt;div class=\u0026#34;frienddivright\u0026#34;\u0026gt; 15 \u0026lt;div class=\u0026#34;friendname\u0026#34;\u0026gt;{{- .Get \u0026#34;name\u0026#34; -}}\u0026lt;/div\u0026gt; 16 \u0026lt;div class=\u0026#34;friendinfo\u0026#34;\u0026gt;{{- .Get \u0026#34;word\u0026#34; -}}\u0026lt;/div\u0026gt; 17 \u0026lt;/div\u0026gt; 18\u0026lt;/div\u0026gt; 19\u0026lt;/a\u0026gt; 20{{- end }} è¿˜éœ€è¦åœ¨ assets/extented ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª blank.css æ–‡ä»¶ï¼Œç„¶ååœ¨ blank.css æ–‡ä»¶ä¸­è‡ªå®šä¹‰å‹é“¾é¡µé¢çš„æ ·å¼ã€‚\n1.friendurl { 2 text-decoration: none !important; 3 color: black; 4 box-shadow: none !important; 5} 6 7.myfriend { 8 width: 56px !important; 9 height: 56px !important; 10 border-radius: 50%!important; 11 padding: 2px; 12 margin-top: 20px !important; 13 margin-left: 14px !important; 14 background-color: #fff; 15} 16 17.frienddiv { 18 overflow: auto; 19 height: 100px; 20 width: 49%; 21 display: inline-block !important; 22 border-radius: 5px; 23 background: none; 24 25 -webkit-transition: all ease-out 0.3s; 26 -moz-transition: all ease-out 0.3s; 27 -o-transition: all ease-out 0.3s; 28 transition: all ease-out 0.3s; 29} 30 31.dark .frienddiv:hover { 32 background: var(--code-bg); 33} 34 35.frienddiv:hover { 36 background: var(--theme); 37 transition: transform 1s; 38 webkit-transform: scale(1.1); 39 -moz-transform: scale(1.2); 40 -ms-transform: scale(1.2); 41 -o-transform: scale(1.2); 42 transform: scale(1.1); 43} 44 45.frienddiv:hover .frienddivleft img { 46 transition: 0.9s !important; 47 -webkit-transition: 0.9s !important; 48 -moz-transition: 0.9s !important; 49 -o-transition: 0.9s !important; 50 -ms-transition: 0.9s !important; 51 transform: rotate(360deg) !important; 52 -webkit-transform: rotate(360deg) !important; 53 -moz-transform: rotate(360deg) !important; 54 -o-transform: rotate(360deg) !important; 55 -ms-transform: rotate(360deg) !important; 56} 57 58.frienddivleft { 59 width: 92px; 60 float: left; 61 margin-right: -5px; 62} 63 64.frienddivright { 65 margin-top: 18px; 66 margin-right: 18px; 67} 68 69.friendname { 70 text-overflow: ellipsis; 71 font-size: 100%; 72 margin-bottom: 5px; 73 color: var(--primary); 74} 75 76.friendinfo { 77 text-overflow: ellipsis; 78 font-size: 70%; 79 color: var(--primary); 80} 81 82@media screen and (max-width: 600px) { 83 .friendinfo { 84 display: none; 85 } 86 .frienddivleft { 87 width: 84px; 88 margin: auto; 89 } 90 .frienddivright { 91 height: 100%; 92 margin: auto; 93 display: flex; 94 align-items: center; 95 justify-content: center; 96 } 97 .friendname { 98 font-size: 18px; 99 } 100} åˆ°è¿™ï¼Œå‹é“¾é¡µé¢çš„æ¨¡æ¿å°±å®Œæˆäº†ï¼Œç„¶ååœ¨ content ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª friends/index.md æ–‡ä»¶ï¼Œç„¶ååœ¨ index.md æ–‡ä»¶ä¸­é…ç½®\n1--- 2type: friend 3hiddenFromSearch: true 4readingTime: false 5license: false 6title: å‹é“¾ 7contentEnd: false 8toc: false 9image: \u0026#34;https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/54de3f8d81a4f97fb1ac4dc06eaf3fda335a5937.webp\u0026#34; 10--- friend.md çš„å†…å®¹å¦‚ä¸‹ï¼Œå› ä¸ºç›´æ¥å†™å…¥è¿™æ®µæ–‡å­—ï¼Œä¼šè¢«è§£æï¼Œæ‰€ä»¥è¿™é‡Œå°±ä¸å†™äº†ï¼Œä½¿ç”¨å›¾ç‰‡äº†\nè¿™æ ·å‹é“¾é¡µé¢å°±å®Œæˆäº†ï¼Œåœ¨æ„å»ºçš„æ—¶å€™ï¼Œå‹é“¾é¡µé¢ä¼šè‡ªåŠ¨ç”Ÿæˆã€‚\næ·»åŠ é˜…è¯»è¿›åº¦æ¡ åœ¨é¡µé¢é¡¶éƒ¨åŠ ä¸€ä¸ªé˜…è¯»è¿›åº¦æ¡ï¼Œå³å®ç”¨åˆç¾è§‚ã€‚åœ¨ layouts/partials ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª readingbar.html æ–‡ä»¶ï¼Œç„¶ååœ¨ readingbar.html æ–‡ä»¶ä¸­é…ç½®\nåœ¨ layouts/partials/head/ ç›®å½•ä¸‹çš„ custom.html ä¸­ æ·»åŠ  è¿™æ®µä»£ç \n1{{ if strings.HasPrefix .RelPermalink \u0026#34;/posts/\u0026#34; }} 2\u0026lt;div class=\u0026#34;top-scroll-bar\u0026#34;\u0026gt;\u0026lt;/div\u0026gt; 3\u0026lt;style\u0026gt; 4 .top-scroll-bar { 5 position: fixed; 6 top: 0; 7 left: 0; 8 z-index: 9999; 9 display: none; 10 width: 0; 11 height: 3px; 12 background: #ef3982; 13 } 14\u0026lt;/style\u0026gt; 15 16\u0026lt;script\u0026gt; 17 $(document).ready(function () { 18 $(window).scroll(function(){ 19 $(\u0026#34;.top-scroll-bar\u0026#34;).attr(\u0026#34;style\u0026#34;, \u0026#34;width: \u0026#34; + ($(this).scrollTop() / ($(document).height() - $(this).height()) * 100) + \u0026#34;%; display: block;\u0026#34;); 20 }); 21 }); 22\u0026lt;/script\u0026gt; 23{{ end }} è¯´ä¸€ä¸‹è¿™ä¸ª readingbar.html æ–‡ä»¶ï¼Œçœ‹åå­—å°±çŸ¥é“ï¼Œè¿™ä¸ªæ–‡ä»¶æ˜¯ Hugo å…è®¸æˆ‘ä»¬è‡ªå®šä¹‰ ç”Ÿæˆ HTML ä¸­ head éƒ¨åˆ†çš„å†…å®¹ã€‚ Hugo åœ¨æ„å»ºçš„æ—¶å€™ï¼Œä¼šè‡ªåŠ¨åŠ è½½è¿™ä¸ªæ–‡ä»¶ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­æ·»åŠ ä¸€äº› HTML ä»£ç ï¼Œæ¯”å¦‚ CSSã€JS ç­‰ã€‚\næ·»åŠ è¿”å›é¡¶éƒ¨æŒ‰é’® åœ¨ custom.html æ–‡ä»¶ä¸­æ·»åŠ è¿™æ®µä»£ç \n1\u0026lt;div id=\u0026#34;back-top\u0026#34;\u0026gt; 2 \u0026lt;a href=\u0026#34;#top\u0026#34; title=\u0026#34;å›åˆ°é¡¶éƒ¨\u0026#34;\u0026gt;\u0026lt;/a\u0026gt; 3\u0026lt;/div\u0026gt; 4\u0026lt;style\u0026gt; 5 #back-top { 6 position: fixed; 7 bottom: 30px; 8 right: 80px; 9 } 10 #back-top a { 11 width: 54px; 12 height: 54px; 13 display: block; 14 background: #ddd url(/images/back_top.svg) no-repeat center center; 15 background-color: rgba(218, 214, 214, 0.87); 16 -webkit-border-radius: 7px; 17 -moz-border-radius: 7px; 18 border-radius: 7px; 19 -webkit-transition: 1s; 20 -moz-transition: 1s; 21 transition: 1s; 22 } 23 #back-top a:hover { 24 background-color: #e88282; 25 } 26\u0026lt;/style\u0026gt; 27 28\u0026lt;script type=\u0026#34;text/javascript\u0026#34;\u0026gt; 29 $(\u0026#34;#back-top\u0026#34;).hide(); 30 $(document).ready(function () { 31 $(window).scroll(function () { 32 if ($(this).scrollTop() \u0026gt; 100) { 33 $(\u0026#39;#back-top\u0026#39;).fadeIn(); 34 } else { 35 $(\u0026#39;#back-top\u0026#39;).fadeOut(); 36 } 37 }); 38 $(\u0026#39;#back-top a\u0026#39;).click(function () { 39 $(\u0026#39;body,html\u0026#39;).animate({ 40 scrollTop: 0 41 }, 800); 42 return false; 43 }); 44 }); 45\u0026lt;/script\u0026gt; å›¾ç‰‡ç¯ç®±æ•ˆæœ Hugo è‡ªå¸¦çš„å›¾ç‰‡æ¸²æŸ“æ˜¯æ²¡æœ‰ç¯ç®±æ•ˆæœçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è‡ªå·±æ·»åŠ ã€‚ç¯ç®±æ•ˆæœå°±æ˜¯ç‚¹å‡»å›¾ç‰‡åï¼Œå›¾ç‰‡ä¼šæ”¾å¤§æ˜¾ç¤ºã€‚\nè¿˜æ˜¯åœ¨ custom.html æ–‡ä»¶ä¸­æ·»åŠ è¿™æ®µä»£ç \n1{{if .Page.Site.Params.fancybox }} 2\u0026lt;script src=\u0026#34;https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js\u0026#34;\u0026gt;\u0026lt;/script\u0026gt; 3\u0026lt;link rel=\u0026#34;stylesheet\u0026#34; href=\u0026#34;https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css\u0026#34; /\u0026gt; 4\u0026lt;script src=\u0026#34;https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js\u0026#34;\u0026gt;\u0026lt;/script\u0026gt; 5{{ end }} ç„¶ååœ¨ layouts/_default ç›®å½•ä¸‹ æ–°å»º render-image.htmlæ–‡ä»¶ï¼Œç„¶ååœ¨ render-image.html æ–‡ä»¶ä¸­é…ç½®\n1\u0026lt;div class=\u0026#34;post-img-view\u0026#34;\u0026gt; 2 \u0026lt;a data-fancybox=\u0026#34;gallery\u0026#34; href=\u0026#34;{{ .Destination | safeURL }}\u0026#34;\u0026gt; 3 \u0026lt;img src=\u0026#34;{{ .Destination | safeURL }}\u0026#34; alt=\u0026#34;{{ .Text }}\u0026#34; {{ with .Title}} title=\u0026#34;{{ . }}\u0026#34;{{ end }} /\u0026gt; 4 \u0026lt;/a\u0026gt; 5\u0026lt;/div\u0026gt; è¿™æ®µä»£ç çš„ä½œç”¨æ˜¯æ›¿æ¢ Hugo é»˜è®¤çš„å›¾ç‰‡æ¸²æŸ“ï¼Œè¿™æ ·å°±å¯ä»¥å®ç°ç‚¹å‡»å›¾ç‰‡æ”¾å¤§æ˜¾ç¤ºçš„æ•ˆæœäº†ã€‚\nä¿®æ”¹åˆ—è¡¨æ¸²æŸ“æ ·å¼ æˆ‘ä½¿ç”¨çš„ Stack ä¸»é¢˜ï¼Œåœ¨ç»™ homepage æ·»åŠ äº† Widget åï¼Œé™¤äº†ä¸»é¡µçš„æ–‡ç« åˆ—è¡¨æ˜¾ç¤ºäº†ï¼Œ æ ‡ç­¾ã€åˆ†ç±» ä¹Ÿæ˜¾ç¤ºäº†ã€‚\nè¿™ä¸æ˜¯æˆ‘æƒ³è¦çš„ï¼Œæˆ‘åªæƒ³åœ¨ä¸»é¡µæ˜¾ç¤ºæ–‡ç« åˆ—è¡¨ï¼Œæ‰€ä»¥éœ€è¦ä¿®æ”¹ä¸€ä¸‹ layouts/_default ç›®å½•ä¸‹çš„ my_list.html æ–‡ä»¶ã€‚ ç„¶åæŠŠ Stack ä¸»é¢˜ä¸­çš„ layouts/_default/list.html æ–‡ä»¶å¤åˆ¶åˆ° é¡¹ç›®çš„layouts/_default ç›®å½•ä¸‹ï¼Œç„¶åä¿®æ”¹ my_list.html æ–‡ä»¶ä¸­çš„å†…å®¹ã€‚\næŠŠæœ€åé¢é‚£æ®µä»£ç åˆ é™¤å°±è¡Œäº†ã€‚ä¹Ÿå°±æ˜¯ä¸‹é¢è¿™æ®µä»£ç \n1{{ define \u0026#34;right-sidebar\u0026#34; }} 2{{ partial \u0026#34;sidebar/right.html\u0026#34; (dict \u0026#34;Context\u0026#34; . \u0026#34;Scope\u0026#34; \u0026#34;homepage\u0026#34;) }} 3{{ end }} ç„¶ååœ¨æƒ³ä½¿ç”¨è¿™ä¸ªæ¨¡æ¿çš„é¡µé¢ä¸­ï¼ŒæŠŠ layout æ”¹æˆ my_list å°±è¡Œäº†ã€‚\næ¯”å¦‚ content/categories/_index.md æ–‡ä»¶ä¸­çš„é…ç½®\n1--- 2title: \u0026#34;åˆ†ç±»\u0026#34; 3contentEnd: false 4license: false 5layout: my_list 6--- å…¶å®è¿™ç»™æˆ‘ä»¬æä¾›äº†ä¸€ä¸ªæ€è·¯ï¼Œå°±æ˜¯ Hugo çš„æ¨¡æ¿æ˜¯å¯ä»¥è‡ªå®šä¹‰çš„ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚æ¥ä¿®æ”¹æ¨¡æ¿ï¼Œè¿™æ ·å°±å¯ä»¥å®ç°è‡ªå·±æƒ³è¦çš„æ•ˆæœäº†ã€‚\næœç´¢å¼•æ“éªŒè¯ä¿¡æ¯ æˆ‘ä»¬è‡ªå»ºçš„åšå®¢ï¼Œéœ€è¦æäº¤åˆ°æœç´¢å¼•æ“ä¸­ï¼Œè¿™æ ·æœç´¢å¼•æ“æ‰èƒ½æ”¶å½•æˆ‘ä»¬çš„åšå®¢ã€‚è¿™æ—¶å€™å°±éœ€è¦åœ¨åšå®¢ä¸­æ·»åŠ æœç´¢å¼•æ“éªŒè¯ä¿¡æ¯ã€‚å¯ä»¥ä½¿ç”¨åœ¨ç½‘ç«™çš„ç›®å½•ä¸­æ”¾ä¸€ä¸ª html æ–‡ä»¶ï¼Œç„¶ååœ¨ html æ–‡ä»¶ä¸­æ·»åŠ éªŒè¯ä¿¡æ¯ã€‚\nä¹Ÿå¯ä»¥åœ¨æ¯ä¸ªç½‘é¡µä¸­æ·»åŠ éªŒè¯ä¿¡æ¯ï¼Œè¿™æ ·å°±ä¸éœ€è¦åœ¨ç½‘ç«™çš„ç›®å½•ä¸­æ”¾ä¸€ä¸ª html æ–‡ä»¶äº†ã€‚è¿™æ¡éªŒè¯ä¿¡æ¯æ˜¯åœ¨ head ä¸­æ·»åŠ çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨ custom.html æ–‡ä»¶ä¸­æ·»åŠ è¿™æ¡éªŒè¯ä¿¡æ¯ã€‚\n1{{ if .Site.Params.google_site_verification }} 2\u0026lt;meta name=\u0026#34;google-site-verification\u0026#34; content=\u0026#34;{{ .Site.Params.google_site_verification }}\u0026#34; /\u0026gt; 3{{ end }} 4 5{{ if .Site.Params.bing_site_verification }} 6\u0026lt;meta name=\u0026#34;msvalidate.01\u0026#34; content=\u0026#34;{{ .Site.Params.bing_site_verification }}\u0026#34; /\u0026gt; 7{{ end }} æ·»åŠ å®Œè¿™æ®µä»£ç åï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨ config.yaml æ–‡ä»¶ä¸­æ·»åŠ  google_site_verification å’Œ bing_site_verification äº†ã€‚\n1 google_site_verification: \u0026#34;XXX\u0026#34; 2 bing_site_verification: \u0026#34;XXX\u0026#34; æŠŠ XXX æ›¿æ¢æˆå¯¹åº”çš„éªŒè¯ä¿¡æ¯å°±è¡Œäº†ã€‚\nè¿™æ®µé…ç½®éœ€è¦åœ¨ params å±‚çº§ä¸‹é…ç½®ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨ head ä¸­æ·»åŠ æœç´¢å¼•æ“éªŒè¯ä¿¡æ¯äº†ã€‚\næ¿å¨˜ å°±æ˜¯å·¦ä¸‹è§’çš„é‚£ä¸ªå°å¥³å­©ï¼Œè¿™ä¸ªæ˜¯æˆ‘åœ¨ç½‘ä¸Šæ‰¾çš„ï¼Œ GitHub\næ·»åŠ æ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼Œåªéœ€è¦åœ¨ layouts/partials/head ç›®å½•ä¸‹çš„ custom.html æ–‡ä»¶ä¸­æ·»åŠ è¿™æ®µä»£ç å°±è¡Œäº†ã€‚\n1\u0026lt;script src=\u0026#34;https://fastly.jsdelivr.net/gh/stevenjoezhang/live2d-widget@latest/autoload.js\u0026#34;\u0026gt;\u0026lt;/script\u0026gt; è‡ªåŠ¨éƒ¨ç½² ä¸€èˆ¬éƒ½ä¼šä½¿ç”¨ git æ¥ç®¡ç†åšå®¢çš„æºç ï¼Œç„¶åä½¿ç”¨ GitHub Actions æ¥è‡ªåŠ¨éƒ¨ç½²åšå®¢ã€‚è¿™æ ·æˆ‘ä»¬åªéœ€è¦åœ¨ git ä»“åº“ä¸­æäº¤ä»£ç ï¼Œç„¶å GitHub Actions å°±ä¼šè‡ªåŠ¨æ„å»ºå¹¶éƒ¨ç½²åšå®¢ã€‚ åƒæˆ‘çš„åšå®¢å°±æ˜¯è¿™æ ·çš„ï¼Œæˆ‘ä½¿ç”¨ GitHub Actions æ¥è‡ªåŠ¨æ„å»ºå¹¶éƒ¨ç½²åšå®¢ã€‚å¹¶ä¸”ä½¿ç”¨ GitHubçš„ Pages åŠŸèƒ½æ¥æ‰˜ç®¡åšå®¢ã€‚\nè¿™æ—¶å€™æˆ‘ä¼šä½¿ç”¨ä¸¤ä¸ª GitHub ä»“åº“ï¼Œä¸€ä¸ªç”¨æ¥å­˜æ”¾ Hugo é¡¹ç›®çš„æºç ï¼Œä¸€ä¸ªç”¨æ¥å­˜æ”¾ Hugo é¡¹ç›®æ„å»ºåçš„é™æ€æ–‡ä»¶ã€‚\nå¹¶ä¸”æŠŠ å­˜æ”¾æºç çš„ä»“åº“è®¾ç½®ä¸º privateï¼Œå› ä¸ºGitHubçš„é™åˆ¶ï¼ŒGitHub Pages åªæ”¯æŒ public ä»“åº“ã€‚\nè¿™æ ·å°±å¯ä»¥å®ç°è‡ªåŠ¨éƒ¨ç½²äº†ï¼Œåªéœ€è¦åœ¨ git ä»“åº“ä¸­æäº¤ä»£ç ï¼Œç„¶å GitHub Actions å°±ä¼šè‡ªåŠ¨æ„å»ºå¹¶éƒ¨ç½²åšå®¢ã€‚\nåœ¨æºç çš„ä»“åº“ä¸­ï¼Œéœ€è¦æ·»åŠ ä¸€ä¸ª .github/workflows ç›®å½•ï¼Œç„¶ååœ¨ .github/workflows ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ª deploy.yml æ–‡ä»¶ï¼Œç„¶ååœ¨ deploy.yml æ–‡ä»¶ä¸­é…ç½®\n1name: Deploy 2 3env: 4 GIT_USER: lqx # GitHub ç”¨æˆ·å 5 GIT_EMAIL: lqxlucky@qq.com # GitHub é‚®ç®± 6 PAGE_REPO: git@github.com:lqxhub/lqxhub.github.io.git # å­˜æ”¾é™æ€æ–‡ä»¶çš„ä»“åº“ï¼ˆGitHub pageçš„ä»“åº“ï¼‰ 7 8on: 9 push: 10 branches: 11 - master # æºç ä»“åº“çš„åˆ†æ”¯ 12 13 workflow_dispatch: 14 15jobs: 16 build: 17 runs-on: ubuntu-latest 18 19 steps: 20 - name: checkOut # æ‹‰å–æºç  21 uses: actions/checkout@v4 22 - name: Setup Hugo # å®‰è£… Hugo 23 uses: peaceiris/actions-hugo@v3 24 with: 25 hugo-version: \u0026#39;0.136.2\u0026#39; # Hugo ç‰ˆæœ¬ 26 extended: true # æ˜¯å¦ä½¿ç”¨æ‰©å±•ç‰ˆæœ¬ 27 - name: Build the website # æ„å»ºhugoé¡µé¢ 28 run: | 29 sudo timedatectl set-timezone \u0026#34;Asia/Shanghai\u0026#34; # è®¾ç½®æ—¶åŒº 30 hugo --minify # æ„å»ºé¡µé¢ è¿™é‡Œä½¿ç”¨äº† --minify å‚æ•°ï¼Œè¿™æ ·æ„å»ºçš„é¡µé¢ä¼šæ›´å° 31 32 - name: Deploy # éƒ¨ç½² 33 env: 34 DEPLOY_SECRET: ${{ secrets.DEPLOY_SECRET }} # GitHubçš„å¯†é’¥ 35 run: | 36 mkdir -p ~/.ssh 37 echo \u0026#34;$DEPLOY_SECRET\u0026#34; \u0026gt; ~/.ssh/id_rsa 38 chmod 600 ~/.ssh/id_rsa 39 ssh-keyscan github.com \u0026gt;\u0026gt; ~/.ssh/known_hosts 40 git config --global user.name \u0026#34;${{ env.GIT_USER }}\u0026#34; 41 git config --global user.email \u0026#34;${{ env.GIT_EMAIL }}\u0026#34; 42 43 cd public # Hugo generates the site in \u0026#39;public\u0026#39; folder by default 44 git init 45 git remote add origin \u0026#34;${{ env.PAGE_REPO }}\u0026#34; 46 git add . 47 git commit -m \u0026#34;Deploy from Hugo site\u0026#34; 48 git push --force origin master è¿™é‡Œè¯´ä¸€ä¸‹ DEPLOY_SECRETï¼Œè¿™ä¸ªæ˜¯ GitHub çš„å¯†é’¥ï¼Œéœ€è¦åœ¨ æ‰˜ç®¡æºç çš„ä»“åº“(ä¹Ÿå°±æ˜¯ç§æœ‰ä»“åº“é‡Œ)ä¸­æ·»åŠ  DEPLOY_SECRETã€‚\nå¦‚å›¾ä¸­æ‰€ç¤ºï¼Œåˆ›å»ºå³å¯ã€‚\næˆ‘ä½¿ç”¨çš„è‡ªå®šä¹‰é…ç½® æˆ‘å¯¹ Stack ä¸»é¢˜è¿›è¡Œäº†ä¸€äº›ä¿®æ”¹ï¼Œéƒ½åœ¨ assets/scss ç›®å½•ä¸‹çš„ custom.scss æ–‡ä»¶ä¸­é…ç½®ã€‚\n1// assets\\scss\\custom.scss 2 3// é¡µé¢åŸºæœ¬é…è‰² 4:root { 5 // å…¨å±€é¡¶éƒ¨è¾¹è· 6 --main-top-padding: 30px; 7 // å…¨å±€å¡ç‰‡åœ†è§’ 8 --card-border-radius: 25px; 9 // æ ‡ç­¾äº‘å¡ç‰‡åœ†è§’ 10 --tag-border-radius: 8px; 11 // å¡ç‰‡é—´è· 12 --section-separation: 40px; 13 // å…¨å±€å­—ä½“å¤§å° 14 --article-font-size: 1.8rem; 15 // è¡Œå†…ä»£ç èƒŒæ™¯è‰² 16 --code-background-color: #f8f8f8; 17 // è¡Œå†…ä»£ç å‰æ™¯è‰² 18 --code-text-color: #e96900; 19 // æš—è‰²æ¨¡å¼ä¸‹æ ·å¼ 20 \u0026amp;[data-scheme=\u0026#34;dark\u0026#34;] { 21 // è¡Œå†…ä»£ç èƒŒæ™¯è‰² 22 --code-background-color: #ff6d1b17; 23 // è¡Œå†…ä»£ç å‰æ™¯è‰² 24 --code-text-color: #e96900; 25 } 26 } 27 28 //------------------------------------------------------ 29 // ä¿®å¤å¼•ç”¨å—å†…å®¹çª„é¡µé¢æ˜¾ç¤ºé—®é¢˜ 30 a { 31 word-break: break-all; 32 } 33 34 //-------------------------------------------------- 35 // æ–‡ç« å°é¢é«˜åº¦ 36 .article-list article .article-image img { 37 width: 100%; 38 height: 200px !important; 39 object-fit: cover; 40 41 @include respond(md) { 42 height: 250px !important; 43 } 44 45 @include respond(xl) { 46 height: 285px !important; 47 } 48 } 49 50 //--------------------------------------------------- 51 // æ–‡ç« å†…å®¹å›¾ç‰‡åœ†è§’é˜´å½± 52 .article-page .main-article .article-content { 53 img { 54 max-width: 96% !important; 55 height: auto !important; 56 border-radius: 8px; 57 } 58 } 59 60 //------------------------------------------------ 61 // æ–‡ç« å†…å®¹å¼•ç”¨å—æ ·å¼ 62 .article-content { 63 blockquote { 64 border-left: 6px solid #358b9a1f !important; 65 background: #3a97431f; 66 } 67 } 68 69 code { 70 word-break: break-all; 71 border-radius: var(--tag-border-radius); 72 font-family: var(--code-font-family); 73 border-radius: var(--category-border-radius); 74 } 75 76 // ä»£ç å—åŸºç¡€æ ·å¼ä¿®æ”¹ 77 .highlight { 78 border-radius: 20px; 79 \u0026amp;:hover { 80 .copyCodeButton { 81 opacity: 1; 82 } 83 } 84 85 pre { 86 margin: initial; 87 padding: 0; 88 margin: 0; 89 width: auto; 90 } 91 } 92 93 //------------------------------------------- 94 // è®¾ç½®é€‰ä¸­å­—ä½“çš„åŒºåŸŸèƒŒæ™¯é¢œè‰² 95 //ä¿®æ”¹é€‰ä¸­é¢œè‰² 96 ::selection { 97 color: #fff; 98 background: #34495e; 99 } 100 101 a { 102 text-decoration: none; 103 color: var(--accent-color); 104 105 \u0026amp;:hover { 106 color: var(--accent-color-darker); 107 } 108 109 \u0026amp;.link { 110 color: #4288b9ad; 111 font-weight: 600; 112 padding: 0 2px; 113 text-decoration: none; 114 cursor: pointer; 115 116 \u0026amp;:hover { 117 text-decoration: underline; 118 } 119 } 120 } 121//å›ºå®šä»£ç å—çš„é«˜åº¦ 122 .article-content { 123 .highlight { 124 padding: var(--card-padding); 125 pre { 126 width: auto; 127 max-height: 50em; 128 } 129 } 130 } 131 132 //------------------------------------------------- 133 //æ–‡ç« å°é¢é«˜åº¦æ›´æ”¹ 134 .article-list article .article-image img { 135 width: 100%; 136 height: 150px; 137 object-fit: cover; 138 139 @include respond(md) { 140 height: 200px; 141 } 142 143 @include respond(xl) { 144 height: 305px; 145 } 146 } 147 148 //--------------------------------------------------- 149 // å…¨å±€é¡µé¢å¸ƒå±€é—´è·è°ƒæ•´ 150 .main-container { 151 min-height: 100vh; 152 align-items: flex-start; 153 padding: 0 15px; 154 gap: var(--section-separation); 155 padding-top: var(--main-top-padding); 156 157 @include respond(md) { 158 padding: 0 37px; 159 } 160 } 161 162 //-------------------------------------------------- 163 //é¡µé¢ä¸‰æ å®½åº¦è°ƒæ•´ 164 .container { 165 margin-left: auto; 166 margin-right: auto; 167 168 .left-sidebar { 169 order: -3; 170 max-width: var(--left-sidebar-max-width); 171 } 172 173 .right-sidebar { 174 order: -1; 175 max-width: var(--right-sidebar-max-width); 176 177 /// Display right sidebar when min-width: lg 178 @include respond(lg) { 179 display: flex; 180 } 181 } 182 183 \u0026amp;.extended { 184 @include respond(md) { 185 max-width: 1024px; 186 --left-sidebar-max-width: 25%; 187 --right-sidebar-max-width: 22% !important; 188 } 189 190 @include respond(lg) { 191 max-width: 1280px; 192 --left-sidebar-max-width: 20%; 193 --right-sidebar-max-width: 30%; 194 } 195 196 @include respond(xl) { 197 max-width: 1453px; //1536px; 198 --left-sidebar-max-width: 15%; 199 --right-sidebar-max-width: 25%; 200 } 201 } 202 203 \u0026amp;.compact { 204 @include respond(md) { 205 --left-sidebar-max-width: 25%; 206 max-width: 768px; 207 } 208 209 @include respond(lg) { 210 max-width: 1024px; 211 --left-sidebar-max-width: 20%; 212 } 213 214 @include respond(xl) { 215 max-width: 1280px; 216 } 217 } 218 } 219 220 //------------------------------------------------------- 221 //å…¨å±€é¡µé¢å°å›¾ç‰‡æ ·å¼å¾®è°ƒ 222 .article-list--compact article .article-image img { 223 width: var(--image-size); 224 height: var(--image-size); 225 object-fit: cover; 226 border-radius: 17%; 227 } 228 229//---------------------------------------------------- 230// èœå•æ æ ·å¼ 231// ä¸‹æ‹‰èœå•æ”¹åœ†è§’æ ·å¼ 232.menu { 233 padding-left: 0; 234 list-style: none; 235 flex-direction: column; 236 overflow-x: hidden; 237 overflow-y: scroll; 238 flex-grow: 1; 239 font-size: 1.6rem; 240 background-color: var(--card-background); 241 242 box-shadow: var(--shadow-l2); //æ”¹ä¸ªé˜´å½± 243 display: none; 244 margin: 0; //æ”¹ä¸º0 245 border-radius: 10px; //åŠ ä¸ªåœ†è§’ 246 padding: 30px 30px; 247 248 @include respond(xl) { 249 padding: 15px 0; 250 } 251 252 \u0026amp;, 253 .menu-bottom-section { 254 gap: 30px; 255 256 @include respond(xl) { 257 gap: 25px; 258 } 259 } 260 261 \u0026amp;.show { 262 display: flex; 263 } 264 265 @include respond(md) { 266 align-items: flex-end; 267 display: flex; 268 background-color: transparent; 269 padding: 0; 270 box-shadow: none; 271 margin: 0; 272 } 273 274 li { 275 position: relative; 276 vertical-align: middle; 277 padding: 0; 278 279 @include respond(md) { 280 width: 100%; 281 } 282 283 svg { 284 stroke-width: 1.33; 285 286 width: 20px; 287 height: 20px; 288 } 289 290 a { 291 height: 100%; 292 display: inline-flex; 293 align-items: center; 294 color: var(--body-text-color); 295 gap: var(--menu-icon-separation); 296 } 297 298 span { 299 flex: 1; 300 } 301 302 \u0026amp;.current { 303 a { 304 color: var(--accent-color); 305 font-weight: bold; 306 } 307 } 308 } 309 } 310 311 // ~\\blog\\assets\\scss\\custom.scss 312 313//------------------------------------------------ 314//å°†æ»šåŠ¨æ¡ä¿®æ”¹ä¸ºåœ†è§’æ ·å¼ 315//èœå•æ»šåŠ¨æ¡ç¾åŒ– 316.menu::-webkit-scrollbar { 317 display: none; 318 } 319 320 // å…¨å±€æ»šåŠ¨æ¡ç¾åŒ– 321 html { 322 ::-webkit-scrollbar { 323 width: 20px; 324 } 325 326 ::-webkit-scrollbar-track { 327 background-color: transparent; 328 } 329 330 ::-webkit-scrollbar-thumb { 331 background-color: #d6dee1; 332 border-radius: 20px; 333 border: 6px solid transparent; 334 background-clip: content-box; 335 } 336 337 ::-webkit-scrollbar-thumb:hover { 338 background-color: #a8bbbf; 339 } 340 } 341 342//-------------------------------------------------- 343//å½’æ¡£é¡µé¢åŒæ  344/* å½’æ¡£é¡µé¢ä¸¤æ  */ 345@media (min-width: 1024px) { 346 .article-list--compact { 347 display: grid; 348 grid-template-columns: 1fr 1fr; 349 background: none; 350 box-shadow: none; 351 gap: 1rem; 352 353 article { 354 background: var(--card-background); 355 border: none; 356 box-shadow: var(--shadow-l2); 357 margin-bottom: 8px; 358 border-radius: 16px; 359 } 360 } 361 } 362 363//-------------------------------------------------- 364//é“¾æ¥ä¸‰æ  365@media (min-width: 1024px) { 366 .article-list--compact.links { 367 display: grid; 368 grid-template-columns: 1fr 1fr 1fr; //ä¸‰ä¸ª1frå³ä¸ºä¸‰æ ,ä¸¤ä¸ª1fråˆ™ä¸ºåŒæ ,ä»¥æ­¤ç±»æ¨å³å¯. 369 background: none; 370 box-shadow: none; 371 gap: 1rem; 372 373 article { 374 background: var(--card-background); 375 border: none; 376 box-shadow: var(--shadow-l2); 377 margin-bottom: 8px; 378 border-radius: var(--card-border-radius); 379 380 \u0026amp;:nth-child(odd) { 381 margin-right: 8px; 382 } 383 } 384 } 385 } 386 387 388//--------------------------------------------------------- 389//é¦–é¡µæ¬¢è¿æ¿å—æ ·å¼ 390.welcome { 391 color: var(--card-text-color-main); 392 background: var(--card-background); 393 box-shadow: var(--shadow-l2); 394 border-radius: 30px; 395 display: inline-block; 396 } 397 398 // ğŸ‘‹emojiå®ç°æ‘†åŠ¨æ•ˆæœ 399 .shake { 400 display: inline-block; 401 animation: shake 1s; 402 animation-duration: 1s; 403 animation-timing-function: ease; 404 animation-delay: 0s; 405 animation-iteration-count: 1; 406 animation-direction: normal; 407 animation-fill-mode: none; 408 animation-play-state: running; 409 animation-name: shake; 410 animation-timeline: auto; 411 animation-range-start: normal; 412 animation-range-end: normal; 413 animation-delay: 2s; 414 @keyframes shake { 415 0% { 416 transform: rotate(0); 417 } 418 25% { 419 transform: rotate(45deg) scale(1.2); 420 } 421 50% { 422 transform: rotate(0) scale(1.2); 423 } 424 75% { 425 transform: rotate(45deg) scale(1.2); 426 } 427 100% { 428 transform: rotate(0); 429 } 430 } 431 } 432 // å®ç°å­—ç¬¦è·³åŠ¨åŠ¨ç”» 433 .jump-text1 { 434 display: inline-block; 435 animation: jump 0.5s 1; 436 } 437 438 .jump-text2 { 439 display: inline-block; 440 animation: jump 0.5s 1; 441 animation-delay: 0.1s; 442 } 443 444 .jump-text3 { 445 display: inline-block; 446 animation: jump 0.5s 1; 447 animation-delay: 0.2s; 448 } 449 450 .jump-text4 { 451 display: inline-block; 452 animation: jump 0.5s 1; 453 animation-delay: 0.3s; 454 } 455 456 .jump-text5 { 457 display: inline-block; 458 animation: jump 0.5s 1; 459 animation-delay: 0.4s; 460 } 461 462 .jump-text6 { 463 display: inline-block; 464 animation: jump 0.5s 1; 465 animation-delay: 0.5s; 466 } 467 468 .jump-text7 { 469 display: inline-block; 470 animation: jump 0.5s 1; 471 animation-delay: 0.6s; 472 } 473 474 .jump-text8 { 475 display: inline-block; 476 animation: jump 0.5s 1; 477 animation-delay: 0.7s; 478 } 479 480 .jump-text9 { 481 display: inline-block; 482 animation: jump 0.5s 1; 483 animation-delay: 0.9s; 484 } 485 486 @keyframes jump { 487 0% { 488 transform: translateY(0); 489 } 490 50% { 491 transform: translateY(-20px); 492 } 493 100% { 494 transform: translateY(0); 495 } 496 } 497 498 .main-container .right-sidebar { 499 order: 2; 500 max-width: var(--right-sidebar-max-width); 501 502 /// Display right sidebar when min-width: lg 503 @include respond(lg) { 504 display: flex; 505 } 506 } 507 508 main.main { 509 order: 1; 510 min-width: 0; 511 max-width: 100%; 512 flex-grow: 1; 513 display: flex; 514 flex-direction: column; 515 gap: var(--section-separation); 516 517 @include respond(md) { 518 padding-top: var(--main-top-padding); 519 } 520 } 521 522//---------------------------------------------------------- 523 524.article-category { 525 display: flex; 526 flex-wrap: wrap; 527 gap: 10px; 528 529 a { 530 background: var(--card-background); 531 box-shadow: var(--shadow-l1); 532 border-radius: var(--category-border-radius); 533 padding: 8px 20px; 534 color: var(--card-text-color-main); 535 font-size: 1.4rem; 536 transition: box-shadow 0.3s ease; 537 538 \u0026amp;:hover { 539 box-shadow: var(--shadow-l2); 540 } 541 } 542} 543 544/* Category widget */ 545.category { 546 .category-label { 547 display: flex; 548 flex-wrap: wrap; 549 gap: 10px; 550 551 a { 552 border-left: 6px solid; 553 background: var(--card-background); 554 box-shadow: var(--shadow-l1); 555 border-radius: var(--category-border-radius); 556 padding: 12px 20px; 557 color: var(--card-text-color-main); 558 font-size: 1.5rem; 559 transition: box-shadow 0.3s ease; 560 561 \u0026amp;:hover { 562 box-shadow: var(--shadow-l2); 563 } 564 } 565 } 566 .category-count { 567 color: var(--body-text-color); 568 } 569} 570 571.article-subtitle { 572 margin-top: -5px; 573 font-size: 1.5rem; 574 575 @include respond(md) { 576 font-size: 1.6rem; 577 } 578} 579 580/*å¤´åƒæ—‹è½¬åŠ¨ç”»*/ 581.sidebar header .site-avatar .site-logo { 582 transition: transform 1.65s ease-in-out; //æ—‹è½¬æ—¶é—´ 583 584} 585 586.sidebar header .site-avatar .site-logo:hover { 587 transform: rotate(360deg); //æ—‹è½¬è§’åº¦ä¸º360åº¦ 588} 589 590/*ç¤¾äº¤èœå•å±…ä¸­*/ 591.social-menu svg { 592 gap: 15px; 593 justify-content: center; 594 width: 30px; 595 height: 25px; //ç¤¾äº¤èœå•å¤§å° 596 stroke: var(--body-text-color); 597 stroke-width: 1.33; 598} 599 600/*é¡µé¢åŠ è½½åŠ¨ç”»éƒ¨åˆ†*/ 601#loading-box .loading-left-bg, 602#loading-box .loading-right-bg { 603 position: fixed; 604 z-index: 1000; 605 width: 50%; 606 height: 100%; 607 // æˆ‘åœ¨è¿™é‡Œå°æ”¹äº†ä¸€ä¸‹é¢œè‰²ï¼Œ 608 background-color: #b1c0c7; 609 transition: all 0.5s; 610} 611 612#loading-box .loading-right-bg { 613 right: 0; 614} 615 616#loading-box\u0026gt;.spinner-box { 617 position: fixed; 618 z-index: 1001; 619 display: flex; 620 justify-content: center; 621 align-items: center; 622 width: 100%; 623 height: 100vh; 624} 625 626#loading-box .spinner-box .configure-border-1 { 627 position: absolute; 628 padding: 3px; 629 width: 115px; 630 height: 115px; 631 background: #ffab91; 632 animation: configure-clockwise 3s ease-in-out 0s infinite alternate; 633} 634 635#loading-box .spinner-box .configure-border-2 { 636 left: -115px; 637 padding: 3px; 638 width: 115px; 639 height: 115px; 640 background: rgb(63, 249, 220); 641 transform: rotate(45deg); 642 animation: configure-xclockwise 3s ease-in-out 0s infinite alternate; 643} 644 645#loading-box .spinner-box .loading-word { 646 position: absolute; 647 color: #ffffff; 648 // æˆ‘åœ¨è¿™é‡Œå°æ”¹äº†ä¸€ä¸‹æ–‡å­—å¤§å°å’Œå­—ä½“ï¼Œæ³¨æ„ï¼ 649 font-size: 1.8rem; 650 font-family: \u0026#39;Zhi Mang Xing\u0026#39;, cursive; 651} 652 653#loading-box .spinner-box .configure-core { 654 width: 100%; 655 height: 100%; 656 background-color: #37474f; 657} 658 659div.loaded div.loading-left-bg { 660 transform: translate(-100%, 0); 661} 662 663div.loaded div.loading-right-bg { 664 transform: translate(100%, 0); 665} 666 667div.loaded div.spinner-box { 668 // ä½ å¯ä»¥æŠŠè¿™ä¸ªæ³¨é‡Šæ‰ï¼Œè¿™æ ·å°±èƒ½ä¸€ç›´çœ‹é‚£ä¸ªåŠ¨ç”»çš„æ•ˆæœäº†ï¼ 669 display: none !important; 670} 671 672@keyframes configure-clockwise { 673 0% { 674 transform: rotate(0); 675 } 676 677 25% { 678 transform: rotate(90deg); 679 } 680 681 50% { 682 transform: rotate(180deg); 683 } 684 685 75% { 686 transform: rotate(270deg); 687 } 688 689 100% { 690 transform: rotate(360deg); 691 } 692} 693 694@keyframes configure-xclockwise { 695 0% { 696 transform: rotate(45deg); 697 } 698 699 25% { 700 transform: rotate(-45deg); 701 } 702 703 50% { 704 transform: rotate(-135deg); 705 } 706 707 75% { 708 transform: rotate(-225deg); 709 } 710 711 100% { 712 transform: rotate(-315deg); 713 } 714} 715 716 717/* å¤´åƒæ—‹è½¬ */ 718.home .home-profile .home-avatar img { 719 width: 5rem; 720 721 /* è®¾ç½®å¾ªç¯åŠ¨ç”» 722 [animation: 723\t(play)åŠ¨ç”»åç§° 724\t(2s)åŠ¨ç”»æ’­æ”¾æ—¶é•¿å•ä½ç§’æˆ–å¾®ç§’ 725\t(ease-out)åŠ¨ç”»æ’­æ”¾çš„é€Ÿåº¦æ›²çº¿ä¸ºä»¥ä½é€Ÿç»“æŸ 726\t(1s)ç­‰å¾…1ç§’ç„¶åå¼€å§‹åŠ¨ç”» 727\t(1)åŠ¨ç”»æ’­æ”¾æ¬¡æ•°(infiniteä¸ºå¾ªç¯æ’­æ”¾) ]*/ 728 729 /* é¼ æ ‡ç»è¿‡å¤´åƒæ—‹è½¬360åº¦ */ 730 -webkit-transition: -webkit-transform 1.0s ease-out; 731 -moz-transition: -moz-transform 1.0s ease-out; 732 transition: transform 1.0s ease-out; 733 \u0026amp;:hover { 734 /* é¼ æ ‡ç»è¿‡åœæ­¢å¤´åƒæ—‹è½¬ 735 -webkit-animation-play-state:paused; 736 animation-play-state:paused;*/ 737 738 /* é¼ æ ‡ç»è¿‡å¤´åƒæ—‹è½¬360åº¦ */ 739 -webkit-transform: rotateZ(360deg); 740 -moz-transform: rotateZ(360deg); 741 transform: rotateZ(360deg); 742 } 743} å¤§å¤šæ•°éƒ½æœ‰æ³¨é‡Šï¼Œå¯ä»¥æŒ‰éœ€å–ç”¨ã€‚\næ€»ç»“ ä»¥ä¸Šå°±æ˜¯æˆ‘åœ¨è¿ç§»åšå®¢æ—¶é‡åˆ°çš„é—®é¢˜ï¼Œå’Œä¸€äº›å¯¹åº”çš„è§£å†³åŠæ³•ï¼Œè¿˜æœ‰ä¸€äº›è‡ªå®šä¹‰é…ç½®ï¼Œå¸Œæœ›å¯¹ä½ æœ‰æ‰€å¸®åŠ©ã€‚ è§£å†³é—®é¢˜å¤§å¤šæ•°éƒ½æ˜¯åœ¨ Google ä¸Šæœç´¢ï¼Œæˆ–è€…é—® ChatGPTã€‚\nå› ä¸ºè¿™ç¯‡æ–‡ç« æ˜¯åœ¨è¿ç§»åå†™çš„ï¼Œæ‰€ä»¥æœ‰äº›é—®é¢˜å¯èƒ½ä¼šå¿˜è®°ï¼Œå¦‚æœæ–‡ä¸­æœ‰é”™è¯¯ï¼Œæ¬¢è¿ä½¿ç”¨ é‚®ç®± å’Œæˆ‘äº¤æµã€‚\n","date":"2024-10-24T19:54:58+08:00","image":"https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/c93977adeb47543e974d7abfcb000757e682158f.jpg","permalink":"https://lqxhub.github.io/posts/a660c9b1/","title":"Hexoè¿ç§»åˆ°hugoæŒ‡åŒ—|Hugoé…ç½®|è‡ªå®šä¹‰|ç¾åŒ–"},{"content":"ä»Šå¹´ä¸€ç›´æ²¡æ€ä¹ˆå†™ä¸œè¥¿ï¼Œçœ‹äº†ä¸€ä¸‹ä¸Šä¸€ç¯‡æ–‡ç« ï¼Œéƒ½è¿‡å»åŠå¹´äº†ã€‚å‰æ®µæ—¶é—´ä¸€ç›´æƒ³å†™ä¸€ç‚¹redisçš„ä¸œè¥¿ï¼Œä½†æ˜¯ä¸€ç›´æ²¡æœ‰æ—¶é—´å»ç ”è¯»æºç ï¼Œæ‰€ä»¥å°±ä¸€ç›´æ²¡æœ‰å†™ã€‚ æœ€è¿‘æœ‰æ—¶é—´ï¼Œçœ‹äº†ä¸€ç‚¹ iouring çš„ä¸œè¥¿ï¼Œå°±å†™äº†ä¸€ç¯‡æ–‡ç« ï¼Œä»‹ç»äº†ä¸€ä¸‹ iouring çš„åŸºæœ¬ä½¿ç”¨ï¼Œå®ç°äº†ä¸€ä¸ªç®€å•çš„TCP server\nå¾ˆæ—©å°±å¬è¯´è¿‡ iouring ï¼Œä½†æ˜¯ä¸€ç›´æ²¡æœ‰æ—¶é—´å­¦ä¹ ã€‚æœ€è¿‘æœ‰æ—¶é—´å°±æ‰¾äº†ä¸€äº›èµ„æ–™ï¼Œå­¦ä¹ äº†ä¸€ä¸‹ï¼Œå†™äº†ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œå®ç°äº†ä¸€ä¸ªç®€å•çš„tcpæœåŠ¡ã€‚\nè¿™ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»äº†å¦‚ä½•ä½¿ç”¨ iouring å®ç°ä¸€ä¸ªç®€å•çš„ tcp æœåŠ¡ï¼Œåªæ˜¯ä»‹ç»äº†iouringçš„åŸºæœ¬ä½¿ç”¨ï¼Œæ²¡æœ‰æ¶‰åŠåº•å±‚å®ç°ã€‚ åé¢æœ‰æ—¶é—´å†å»å­¦ä¸€ä¸‹ liburing çš„æºç ï¼Œçœ‹çœ‹åº•å±‚æ˜¯å¦‚ä½•å®ç°çš„ã€‚\nå…ˆè§£é‡Šä¸€ä¸‹ä¸¤ä¸ªåè¯ï¼šiouring å’Œ liburingã€‚ iouring æ˜¯ Linux å†…æ ¸åœ¨ 5.1 ç‰ˆæœ¬å¼•å…¥çš„ä¸€ä¸ªæ–°çš„å¼‚æ­¥I/Oæ¥å£ã€‚ liburing æ˜¯ iouring çš„ä¸€ä¸ªç”¨æˆ·æ€åº“ï¼Œå°è£…äº† iouring çš„æ¥å£ï¼Œä½¿å¾—ç”¨æˆ·å¯ä»¥æ›´æ–¹ä¾¿çš„ä½¿ç”¨ iouringã€‚\nç®€å•è¯´å°±æ˜¯ io_uring æ˜¯linuxå†…æ ¸çš„åŠŸèƒ½ï¼Œå¯¹å¤–æä¾›äº†ä¸€å¥—å¼‚æ­¥I/Oçš„æ¥å£ã€‚å› ä¸ºç›´æ¥ä½¿ç”¨ linuxå†…æ ¸çš„ io_uring æ¥å£å¤ªéº»çƒ¦äº†ï¼Œ æ‰€ä»¥åœ¨å°±å†™äº† liburing è¿™ä¸ªåº“ï¼Œå¯¹å†…æ ¸çš„ io_uring å°è£…ï¼Œæä¾›äº†ä¸€å¥—æ›´åŠ å‹å¥½çš„æ¥å£ï¼Œä½¿å¾—ç”¨æˆ·å¯ä»¥æ›´æ–¹ä¾¿çš„ä½¿ç”¨ io_uringã€‚\nä»€ä¹ˆæ˜¯iouring io_uringæ˜¯Linuxå†…æ ¸åœ¨ 5.1 ç‰ˆæœ¬å¼•å…¥çš„ä¸€ä¸ªæ–°çš„å¼‚æ­¥I/Oæ¥å£ã€‚ io_uringçš„ç›®æ ‡æ˜¯æä¾›ä¸€ä¸ªé«˜æ•ˆçš„ã€ç»Ÿä¸€çš„å¼‚æ­¥I/Oæ¥å£ï¼Œä»¥æ›¿ä»£ç°æœ‰çš„å¼‚æ­¥I/Oæ¥å£ï¼ˆå¦‚aioã€epollã€eventfdç­‰ï¼‰ã€‚ io_uringçš„è®¾è®¡ç›®æ ‡æ˜¯æä¾›ä¸€ä¸ªç®€å•çš„ã€é«˜æ•ˆçš„ã€ç»Ÿä¸€çš„å¼‚æ­¥I/Oæ¥å£ï¼Œä»¥ä¾¿åº”ç”¨ç¨‹åºå¯ä»¥æ›´å®¹æ˜“åœ°åˆ©ç”¨å¼‚æ­¥I/Oçš„ä¼˜åŠ¿ã€‚\nè™½ç„¶linuxå†…æ ¸æä¾›äº†å¾ˆå¤šå¼‚æ­¥I/Oçš„æ¥å£ï¼Œæ¯”å¦‚aioã€‚ åœ¨linuxä¸Šå¯ä»¥ä½¿ç”¨\nfcntl(sockfd, F_SETFL, fcntl(sockfd, F_GETFL, 0) | O_NONBLOCK);\næ¥è®¾ç½® socket ä¸ºéé˜»å¡æ¨¡å¼ï¼Œåç»­åœ¨è¯»å†™ socket çš„ fd æ—¶ï¼Œä½¿ç”¨ read å’Œ write å‡½æ•° å°±æ˜¯éé˜»å¡çš„äº†ã€‚\nåœ¨è°ƒç”¨ read å’Œ write å‡½æ•°æ—¶ï¼Œå¦‚æœ fd æ²¡æœ‰æ•°æ®ï¼Œæˆ–è€… fd çš„ç¼“å†²åŒºæ»¡äº†ï¼Œé‚£ä¹ˆ read å’Œ write å‡½æ•°ä¼šç«‹å³è¿”å›ï¼Œ ä¸ä¼šé˜»å¡\nä½†æ˜¯è¿™ç§æ–¹å¼æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯ read å’Œ write å‡½æ•°çš„è°ƒç”¨æ˜¯é˜»å¡çš„ï¼Œè™½ç„¶ read å’Œ write å‡½æ•°ä¼šç«‹å³è¿”å›ï¼Œä½†æ˜¯ read å’Œ write å‡½æ•°çš„è°ƒç”¨æ˜¯é˜»å¡çš„ï¼Œä¼šå ç”¨ CPU çš„èµ„æºã€‚\nå› ä¸ºä¹‹å‰çš„å¼‚æ­¥I/Oæ¥å£ä¸å¤Ÿå¥½ç”¨ï¼Œæ‰€ä»¥ io_uring å°±è¯ç”Ÿäº†ã€‚\nio_uring çš„è®¾è®¡ç›®æ ‡æ˜¯æä¾›ä¸€ä¸ªç®€å•çš„ã€é«˜æ•ˆçš„ã€ç»Ÿä¸€çš„å¼‚æ­¥I/Oæ¥å£ï¼Œä»¥ä¾¿åº”ç”¨ç¨‹åºå¯ä»¥æ›´å®¹æ˜“åœ°åˆ©ç”¨å¼‚æ­¥I/Oçš„ä¼˜åŠ¿ã€‚ ç°åœ¨çš„ io_uring æ”¯æŒ æ–‡ä»¶ I/Oã€ç½‘ç»œ I/Oã€å®šæ—¶å™¨ã€ä¿¡å· ç­‰ã€‚çœŸæ­£çš„ç»Ÿä¸€äº† I/O å¼‚æ­¥æ“ä½œã€‚\nè¯´åˆ°å¼‚æ­¥I/Oï¼Œå°±ä¸å¾—ä¸æä¸€ä¸‹ epollã€‚ epoll æ˜¯ Linux å†…æ ¸æä¾›çš„ä¸€ç§ I/O å¤šè·¯å¤ç”¨æœºåˆ¶ï¼Œå¯ä»¥åŒæ—¶ç›‘æ§å¤šä¸ª fd çš„ I/O äº‹ä»¶ã€‚ epoll åªæ˜¯è¿™ä¸ª å¤šè·¯å¤ç”¨æœºåˆ¶ï¼Œåªæ˜¯ç”¨æ¥ç›‘æ§ fd çš„ I/O äº‹ä»¶ï¼Œå½“ fd æœ‰ I/O äº‹ä»¶æ—¶ï¼ˆfd å¯ä»¥è¢«è¯»å†™æ—¶ï¼‰ï¼Œ epoll ä¼šé€šçŸ¥åº”ç”¨ç¨‹åºã€‚ çœŸæ­£çš„ I/O æ“ä½œè¿˜æ˜¯ç”± read å’Œ write å‡½æ•°æ¥å®Œæˆçš„ã€‚ æ‰€ä»¥è¯´ epoll å¹¶ä¸æ˜¯å¼‚æ­¥ I/Oï¼Œåªæ˜¯ I/O å¤šè·¯å¤ç”¨æœºåˆ¶ã€‚\nio_uringçš„åŸºç¡€æ¦‚å¿µ io_uring æœ‰ä¸¤ä¸ªé‡è¦çš„æ¦‚å¿µï¼šSubmission Queue å’Œ Completion Queueã€‚ ç®€ç§° sq å’Œ cqã€‚\nSubmission Queue æ˜¯ io_uring çš„æäº¤é˜Ÿåˆ—ï¼Œç”¨æ¥æäº¤ I/O è¯·æ±‚ã€‚\nCompletion Queue æ˜¯ io_uring çš„å®Œæˆé˜Ÿåˆ—ï¼Œç”¨æ¥å­˜æ”¾ I/O è¯·æ±‚çš„å®ŒæˆçŠ¶æ€ã€‚\nå’Œ sq å’Œ cq ç›¸å¯¹åº”çš„æ˜¯ sqe å’Œ cqeã€‚\nsqe æ˜¯ Submission Queue çš„å…ƒç´ ï¼Œç”¨æ¥æè¿°ä¸€ä¸ª I/O è¯·æ±‚ã€‚\ncqe æ˜¯ Completion Queue çš„å…ƒç´ ï¼Œç”¨æ¥æè¿°ä¸€ä¸ª I/O è¯·æ±‚çš„å®ŒæˆçŠ¶æ€ã€‚\næ”¾ä¸€å¼ iouringçš„å·¥ä½œæµç¨‹å›¾ï¼š\nio_uringä¸­éå¸¸é‡è¦çš„ä¸¤ä¸ªæ•°æ®ç»“æ„ sq å’Œ cqã€‚æ˜¯ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´ä¹‹é—´çš„é€šä¿¡æ¡¥æ¢ã€‚\nio_uring çš„å·¥ä½œæµç¨‹å¦‚ä¸‹ï¼š\nåº”ç”¨ç¨‹åºå‘ Submission Queue ä¸­æäº¤ I/O è¯·æ±‚ã€‚ io_uring å†…æ ¸æ¨¡å—ä» Submission Queue ä¸­å–å‡º I/O è¯·æ±‚ï¼Œæ‰§è¡Œ I/O æ“ä½œã€‚ io_uring å†…æ ¸æ¨¡å—å°† I/O è¯·æ±‚çš„å®ŒæˆçŠ¶æ€å†™å…¥ Completion Queueã€‚ åº”ç”¨ç¨‹åºä» Completion Queue ä¸­è¯»å– I/O è¯·æ±‚çš„å®ŒæˆçŠ¶æ€ã€‚ åº”ç”¨ç¨‹åºå¤„ç† I/O è¯·æ±‚çš„å®ŒæˆçŠ¶æ€ã€‚ å› ä¸ºè¿™æ¬¡åªæ˜¯ç®€å•çš„ä»‹ç» iouring çš„åŸºæœ¬ä½¿ç”¨ï¼Œæ‰€ä»¥å°±ä¸æ·±å…¥è®² iouring çš„åŸç†äº†ã€‚\nliburingçš„ä½¿ç”¨ liburing æ˜¯ iouring çš„ä¸€ä¸ªç”¨æˆ·æ€åº“ï¼Œå°è£…äº† iouring çš„æ¥å£ï¼Œä½¿å¾—ç”¨æˆ·å¯ä»¥æ›´æ–¹ä¾¿çš„ä½¿ç”¨ iouringã€‚\nliburingä¸­å°è£…äº†å¾ˆå¤šæ“ä½œå‡½æ•°ï¼Œè¿™æ¬¡ä¹Ÿä¸ä¼šå…¨éƒ¨ä»‹ç»ï¼Œåªä»‹ç»ä¸€äº›å¸¸ç”¨çš„å‡½æ•°ã€‚\nliburingå¸¸ç”¨çš„å‡½æ•° io_uring_queue_init åˆå§‹åŒ– io_uring å¯¹è±¡ã€‚\n1int io_uring_queue_init(unsigned entries, struct io_uring *ring,unsigned flags); æœ‰ä¸‰ä¸ªå‚æ•°ï¼š\nentriesï¼š Submission Queue å’Œ Completion Queue çš„å¤§å°ã€‚ ringï¼š io_uring å¯¹è±¡ã€‚ flagsï¼š ä¿ç•™å‚æ•°ï¼Œä¼  0 å³å¯ã€‚ io_uring_queue_exit é”€æ¯ io_uring å¯¹è±¡ã€‚\n1void io_uring_queue_exit(struct io_uring *ring); ä¼ å…¥ io_uring å¯¹è±¡å³å¯ã€‚\nio_uring_get_sqe è·å– Submission Queue çš„å…ƒç´ ã€‚\n1struct io_uring_sqe *io_uring_get_sqe(struct io_uring *ring); ä¼ å…¥ io_uring å¯¹è±¡ï¼Œè¿”å›ä¸€ä¸ª sqe å¯¹è±¡ï¼Œç”¨æ¥æè¿°ä¸€ä¸ª I/O è¯·æ±‚ã€‚\nio_uring_submit æäº¤ I/O è¯·æ±‚ã€‚\n1int io_uring_submit(struct io_uring *ring); ä¼ å…¥ io_uring å¯¹è±¡ï¼Œæäº¤ I/O è¯·æ±‚ã€‚\nio_uring_wait_cqe ç­‰å¾… I/O è¯·æ±‚çš„å®ŒæˆçŠ¶æ€ã€‚\n1int io_uring_wait_cqe(struct io_uring *ring, struct io_uring_cqe **cqe_ptr); ä¼ å…¥ io_uring å¯¹è±¡ï¼Œè¿”å› cqe å¯¹è±¡ï¼Œç”¨æ¥æè¿°ä¸€ä¸ª I/O è¯·æ±‚çš„å®ŒæˆçŠ¶æ€ã€‚\nio_uring_submit_and_wait æäº¤ I/O è¯·æ±‚ï¼Œå¹¶ç­‰å¾… I/O è¯·æ±‚çš„å®ŒæˆçŠ¶æ€ã€‚\n1int io_uring_submit_and_wait(struct io_uring *ring, unsigned wait_nr); ä¼ å…¥ io_uring å¯¹è±¡ï¼Œæäº¤ I/O è¯·æ±‚ï¼Œå¹¶ç­‰å¾… I/O è¯·æ±‚çš„å®ŒæˆçŠ¶æ€ã€‚\nå¯ä»¥çœ‹åšæ˜¯ io_uring_submit å’Œ io_uring_wait_cqe çš„ç»„åˆã€‚\nio_uring_prep_accept å‘ Submission Queue ä¸­æ·»åŠ ä¸€ä¸ª accept è¯·æ±‚ã€‚\n1void io_uring_prep_accept(struct io_uring_sqe *sqe, int fd, struct sockaddr *addr, socklen_t *addrlen, int flags); æœ‰äº”ä¸ªå‚æ•°ï¼š\nsqeï¼š Submission Queue çš„å…ƒç´ ã€‚ fdï¼š socket çš„ fdã€‚ addrï¼š sockaddr ç»“æ„ä½“ã€‚ addrlenï¼š sockaddr ç»“æ„ä½“çš„é•¿åº¦ã€‚ flagsï¼š ä¿ç•™å‚æ•°ï¼Œä¼  0 å³å¯ã€‚ io_uring_prep_recv å‘ Submission Queue ä¸­æ·»åŠ ä¸€ä¸ª recv è¯·æ±‚ï¼Œä¹Ÿå°±æ˜¯ä»fdä¸­å¼‚æ­¥è¯»å–æ•°æ®ã€‚\n1void io_uring_prep_recv(struct io_uring_sqe *sqe, int fd, void *buf, unsigned nbytes, unsigned flags); æœ‰äº”ä¸ªå‚æ•°ï¼š\nsqeï¼š Submission Queue çš„å…ƒç´ ã€‚ fdï¼š socket çš„ fdã€‚ bufï¼š æ¥æ”¶æ•°æ®çš„ç¼“å†²åŒº,ä¸€èˆ¬æ˜¯ char æ•°ç»„çš„åœ°å€ã€‚ nbytesï¼š ç¼“å†²åŒºçš„å¤§å°ã€‚ flagsï¼š ä¿ç•™å‚æ•°ï¼Œä¼  0 å³å¯ã€‚ io_uring_prep_send å‘ Submission Queue ä¸­æ·»åŠ ä¸€ä¸ª send è¯·æ±‚ï¼Œä¹Ÿå°±æ˜¯å‘fdä¸­å¼‚æ­¥å†™å…¥æ•°æ®ã€‚\n1void io_uring_prep_send(struct io_uring_sqe *sqe, int fd, const void *buf, unsigned nbytes, unsigned flags); æœ‰äº”ä¸ªå‚æ•°ï¼š\nsqeï¼š Submission Queue çš„å…ƒç´ ã€‚ fdï¼š socket çš„ fdã€‚ bufï¼š å‘é€æ•°æ®çš„ç¼“å†²åŒºï¼Œä¸€èˆ¬æ˜¯ char æŒ‡é’ˆçš„åœ°å€ã€‚ nbytesï¼š ç¼“å†²åŒºçš„å¤§å°ã€‚ flagsï¼š ä¿ç•™å‚æ•°ï¼Œä¼  0 å³å¯ã€‚ io_uring_sqe_set_data è®¾ç½® sqe çš„æ•°æ®ï¼ŒæŠŠç”¨æˆ·æ€çš„æ•°æ®å’Œå†…æ ¸ç»‘å®šã€‚\n1void io_uring_sqe_set_data(struct io_uring_sqe *sqe, void *data); ä¼ å…¥ sqe å¯¹è±¡å’Œç”¨æˆ·æ€çš„æ•°æ®ï¼ŒæŠŠç”¨æˆ·æ€çš„æ•°æ®å’Œå†…æ ¸ç»‘å®šã€‚\nio_uring_cqe_seen æ ‡è®° cqe ä¸ºå·²å¤„ç†ã€‚\n1void io_uring_cqe_seen(struct io_uring *ring, struct io_uring_cqe *cqe); ä¼ å…¥ io_uring å¯¹è±¡å’Œ cqe å¯¹è±¡ï¼Œæ ‡è®° cqe ä¸ºå·²å¤„ç†ã€‚\nå®ç°ä¸€ä¸ªç®€å•çš„tcpæœåŠ¡ io_uring åªèƒ½åœ¨ linux å†…æ ¸ 5.1 ä»¥ä¸Šç‰ˆæœ¬ä½¿ç”¨ï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨io_uringä¹‹å‰ï¼Œéœ€è¦å…ˆæ£€æŸ¥ä¸€ä¸‹å†…æ ¸ç‰ˆæœ¬ã€‚ ä¸€èˆ¬æœ€æ–°çš„ ubuntu å’Œ Debian éƒ½æ˜¯æ”¯æŒ io_uring çš„ã€‚\nä½¿ç”¨ liburing éœ€è¦å®‰è£… liburing åº“ã€‚\n1sudo apt-get install liburing-dev ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ tcp æœåŠ¡ï¼ŒåŠŸèƒ½æ˜¯æ¥æ”¶å®¢æˆ·ç«¯çš„è¿æ¥ï¼Œç„¶åå‘å®¢æˆ·ç«¯å‘é€ä¸€æ¡æ¶ˆæ¯ã€‚\n1#include \u0026lt;iostream\u0026gt; 2 3#include \u0026lt;liburing.h\u0026gt; 4#include \u0026lt;netinet/in.h\u0026gt; 5#include \u0026lt;map\u0026gt; 6 7const int QUEUE_DEPTH = 128; 8const int BUFFER_SIZE = 4096; 9 10enum ConnectionType { 11 ACCEPT, 12 READ, 13 WRITE, 14}; 15 16struct Connection { 17 int fd; 18 int type{}; 19 char readBuf[BUFFER_SIZE]{}; 20 std::string writeBuf; 21 22 explicit Connection(int _fd) { fd = _fd; } 23}; 24 25std::map\u0026lt;int, Connection *\u0026gt; connections; 26 27int createListener(sockaddr_in *addr) { 28 int listener = socket(AF_INET, SOCK_STREAM, 0); 29 if (listener \u0026lt; 0) { 30 std::cerr \u0026lt;\u0026lt; \u0026#34;socket failed errno:\u0026#34; \u0026lt;\u0026lt; errno \u0026lt;\u0026lt; std::endl; 31 return -1; 32 } 33 34 int opt = 1; 35 if (setsockopt(listener, SOL_SOCKET, SO_REUSEADDR, \u0026amp;opt, sizeof(opt)) \u0026lt; 0) { 36 std::cerr \u0026lt;\u0026lt; \u0026#34;setsockopt failed errno:\u0026#34; \u0026lt;\u0026lt; errno \u0026lt;\u0026lt; std::endl; 37 close(listener); 38 return -1; 39 } 40 41 if (bind(listener, reinterpret_cast\u0026lt;sockaddr *\u0026gt;(addr), sizeof(*addr)) \u0026lt; 0) { 42 std::cerr \u0026lt;\u0026lt; \u0026#34;bind failed errno:\u0026#34; \u0026lt;\u0026lt; errno \u0026lt;\u0026lt; std::endl; 43 close(listener); 44 return -1; 45 } 46 47 if (listen(listener, 10) \u0026lt; 0) { 48 std::cerr \u0026lt;\u0026lt; \u0026#34;listen failed errno:\u0026#34; \u0026lt;\u0026lt; errno \u0026lt;\u0026lt; std::endl; 49 return -1; 50 } 51 52 return listener; 53} 54 55void acceptConnection(io_uring *ring, Connection *conn, sockaddr *addr, socklen_t *clientLen) { 56 conn-\u0026gt;type = ACCEPT; 57 auto sqe = io_uring_get_sqe(ring); 58 io_uring_prep_accept(sqe, conn-\u0026gt;fd, addr, clientLen, 0); 59 io_uring_sqe_set_data(sqe, conn); 60} 61 62void addSocketRead(io_uring *ring, Connection *conn) { 63 conn-\u0026gt;type = READ; 64 auto sqe = io_uring_get_sqe(ring); 65 io_uring_prep_recv(sqe, conn-\u0026gt;fd, \u0026amp;conn-\u0026gt;readBuf, BUFFER_SIZE, 0); 66 io_uring_sqe_set_data(sqe, conn); 67} 68 69void addSocketWrite(io_uring *ring, Connection *conn) { 70 conn-\u0026gt;type = WRITE; 71 auto sqe = io_uring_get_sqe(ring); 72 io_uring_prep_send(sqe, conn-\u0026gt;fd, conn-\u0026gt;writeBuf.data(), conn-\u0026gt;writeBuf.size(), 0); 73 io_uring_sqe_set_data(sqe, conn); 74} 75 76Connection *newConn(io_uring *ring, int fd) { 77 auto conn = new Connection(fd); 78 connections[fd] = conn; 79 addSocketRead(ring, conn); 80 return conn; 81} 82 83int uringRun() { 84 sockaddr_in addr{}; 85 addr.sin_family = AF_INET; 86 addr.sin_port = htons(8088); 87 addr.sin_addr.s_addr = INADDR_ANY; 88 89 int listenFd = createListener(\u0026amp;addr); 90 if (listenFd \u0026lt; 0) { 91 return 1; 92 } 93 socklen_t clientLen = sizeof(addr); 94 io_uring ring{}; 95 if (io_uring_queue_init(QUEUE_DEPTH, \u0026amp;ring, 0) \u0026lt; 0) { 96 std::cerr \u0026lt;\u0026lt; \u0026#34;io_uring_queue_init failed errno:\u0026#34; \u0026lt;\u0026lt; errno \u0026lt;\u0026lt; std::endl; 97 return 1; 98 } 99 auto lConn = newConn(\u0026amp;ring, listenFd); 100 acceptConnection(\u0026amp;ring, lConn, reinterpret_cast\u0026lt;sockaddr *\u0026gt; (\u0026amp;addr), \u0026amp;clientLen); 101 if (io_uring_submit(\u0026amp;ring) \u0026lt; 0) { 102 std::cerr \u0026lt;\u0026lt; \u0026#34;io_uring_submit failed errno:\u0026#34; \u0026lt;\u0026lt; errno \u0026lt;\u0026lt; std::endl; 103 return 1; 104 } 105 106 io_uring_cqe *cqes[QUEUE_DEPTH]; 107 while (true) { 108 //ç­‰å¾…äº‹ä»¶å®Œæˆ 109 int ret = io_uring_submit_and_wait(\u0026amp;ring, 1); 110 if (ret \u0026lt; 0) { 111 std::cerr \u0026lt;\u0026lt; \u0026#34;io_uring_wait_cqe failed errno:\u0026#34; \u0026lt;\u0026lt; errno \u0026lt;\u0026lt; std::endl; 112 break; 113 } 114 115 //è·å–å®Œæˆçš„äº‹ä»¶ 116 auto num = io_uring_peek_batch_cqe(\u0026amp;ring, cqes, QUEUE_DEPTH); 117 for (int i = 0; i \u0026lt; num; ++i) { 118 auto conn = reinterpret_cast\u0026lt;Connection *\u0026gt; (cqes[i]-\u0026gt;user_data); 119 if (conn-\u0026gt;type == ACCEPT) {//æ–°è¿æ¥ 120 int clientFd = cqes[i]-\u0026gt;res; 121 auto newCLi = newConn(\u0026amp;ring, clientFd); 122 addSocketRead(\u0026amp;ring, newCLi); 123 acceptConnection(\u0026amp;ring, lConn, reinterpret_cast\u0026lt;sockaddr *\u0026gt; (\u0026amp;addr), \u0026amp;clientLen); 124 } else if (conn-\u0026gt;type == READ) { 125 int readSize = cqes[i]-\u0026gt;res; 126 if (readSize \u0026lt; 0) {//è¯»å–å¤±è´¥(æ¯”å¦‚å®¢æˆ·ç«¯æ–­å¼€è¿æ¥) 127 shutdown(conn-\u0026gt;fd, SHUT_RDWR); 128 connections.erase(conn-\u0026gt;fd); 129 delete conn; 130 } else { 131 std::cout \u0026lt;\u0026lt; \u0026#34;read:\u0026#34; \u0026lt;\u0026lt; conn-\u0026gt;readBuf \u0026lt;\u0026lt; std::endl; 132 conn-\u0026gt;writeBuf = \u0026#34;hello client\u0026#34;; 133 addSocketWrite(\u0026amp;ring, conn);//å‘å®¢æˆ·ç«¯å†™æ•°æ® 134 } 135 } else if (conn-\u0026gt;type == WRITE) { 136 addSocketRead(\u0026amp;ring, conn);// æŠŠè¿™ä¸ªè¿æ¥åŠ å…¥è¯»äº‹ä»¶ 137 } 138 io_uring_cqe_seen(\u0026amp;ring, cqes[i]);// mark the cqe as processed 139 } 140 } 141 io_uring_queue_exit(\u0026amp;ring); 142 return 0; 143} 144 145int main() { 146 uringRun(); 147 return 0; 148} ç¼–è¯‘è¿™æ®µä»£ç çš„æ—¶å€™ï¼Œéœ€è¦é“¾æ¥ liburing åº“ã€‚\n1g++ -o server server.cpp -luring createListener å‡½æ•°ç”¨æ¥åˆ›å»ºä¸€ä¸ª socket ç›‘å¬ 8088 ç«¯å£ã€‚è¿™ä¸ªå‡½æ•°æ²¡ä»€ä¹ˆç‰¹åˆ«çš„ï¼Œå°±æ˜¯åˆ›å»ºä¸€ä¸ª socketï¼Œç„¶åç»‘å®š 8088 ç«¯å£ï¼Œç„¶åç›‘å¬ã€‚\nacceptConnection å‡½æ•°ç”¨æ¥æ¥æ”¶å®¢æˆ·ç«¯çš„è¿æ¥ã€‚è¿™ä¸ªå‡½æ•°è°ƒç”¨ io_uring_prep_accept å‡½æ•°ï¼Œå‘ Submission Queue ä¸­æ·»åŠ ä¸€ä¸ª accept è¯·æ±‚ã€‚\naddSocketRead å‡½æ•°ç”¨æ¥å‘ Submission Queue ä¸­æ·»åŠ ä¸€ä¸ª recv è¯·æ±‚ï¼Œä¹Ÿå°±æ˜¯ä» fd ä¸­å¼‚æ­¥è¯»å–æ•°æ®ã€‚\naddSocketWrite å‡½æ•°ç”¨æ¥å‘ Submission Queue ä¸­æ·»åŠ ä¸€ä¸ª send è¯·æ±‚ï¼Œä¹Ÿå°±æ˜¯å‘ fd ä¸­å¼‚æ­¥å†™å…¥æ•°æ®ã€‚\nnewConn å‡½æ•°ç”¨æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„è¿æ¥ã€‚è¿™ä¸ªå‡½æ•°ä¼šè°ƒç”¨ addSocketRead å‡½æ•°ï¼Œå‘ Submission Queue ä¸­æ·»åŠ ä¸€ä¸ª recv è¯·æ±‚ã€‚\nuringRun å‡½æ•°æ˜¯ä¸»å‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°ä¼šåˆ›å»ºä¸€ä¸ª io_uring å¯¹è±¡ï¼Œç„¶åè°ƒç”¨ createListener å‡½æ•°åˆ›å»ºä¸€ä¸ªç›‘å¬ socketï¼Œç„¶åè°ƒç”¨ newConn å‡½æ•°åˆ›å»ºä¸€ä¸ªæ–°çš„è¿æ¥ã€‚\næœ‰ä¸€ä¸ªçŸ¥è¯†ç‚¹éœ€è¦æ³¨æ„ä¸€ä¸‹ï¼Œåœ¨ io_uringä¸­ï¼Œæ¯æ¬¡è·å–çš„ cqe åœ¨ä½¿ç”¨å®Œä¹‹åï¼Œéœ€è¦è°ƒç”¨ io_uring_cqe_seen å‡½æ•°ï¼Œæ ‡è®° cqe ä¸ºå·²å¤„ç†ã€‚ åŒæ—¶å¤„ç†çš„æ—¶å€™ï¼Œä¹Ÿä¼šæŠŠ è¿™ä¸ª cqe ä» Completion Queue ä¸­ç§»é™¤ï¼Œå¯¹åº”çš„ fd ä¹Ÿä¼šä» io_uring ä¸­ç§»é™¤ã€‚ æ‰€ä»¥ï¼Œä¸ºäº†ä¿è¯åç»­èƒ½ç»§ç»­æ¥æ”¶åˆ° fd çš„ I/O äº‹ä»¶ï¼Œéœ€è¦åœ¨å¤„ç†å®Œ cqe ä¹‹åï¼Œå†æ¬¡è°ƒç”¨ addSocketRead å‡½æ•°ï¼Œå‘ Submission Queue ä¸­æ·»åŠ ä¸€ä¸ª recv è¯·æ±‚ã€‚\nè¿™äº›å‡½æ•°çš„å†…å®¹éƒ½æ¯”è¾ƒç®€å•ï¼Œå°±ä¸å†è¯¦ç»†ä»‹ç»äº†ã€‚ä¸»è¦çœ‹ä¸€ä¸‹ while å¾ªç¯çš„å†…å®¹ã€‚\nint ret = io_uring_submit_and_wait(\u0026amp;ring, 1); è¿™ä¸ªå‡½æ•°ä¼šæäº¤ I/O è¯·æ±‚ï¼Œå¹¶ç­‰å¾… I/O è¯·æ±‚çš„å®ŒæˆçŠ¶æ€ã€‚è¿™ä¸ªå‡½æ•°ä¼šé˜»å¡ï¼Œç›´åˆ°æœ‰ 1ä¸ª I/O è¯·æ±‚å®Œæˆã€‚\nè¿™é‡Œå¯ä»¥ä½¿ç”¨ io_uring_submit è¿™ä¸ªå‡½æ•°åªæäº¤ I/O è¯·æ±‚ï¼Œä¸ç­‰å¾… I/O è¯·æ±‚çš„å®ŒæˆçŠ¶æ€ã€‚ä½†æ˜¯è¿™æ ·çš„è¯ï¼Œwhileå¾ªç¯ä¼šä¸€ç›´å¾ªç¯ï¼Œä¸ä¼šé˜»å¡ï¼Œå¯¹åº”çš„è¡¨ç°å°±æ˜¯ CPU å ç”¨ç‡ä¼šå¾ˆé«˜ã€‚ è¿™ç§æƒ…å†µé€‚ç”¨äº I/O è¯·æ±‚æ¯”è¾ƒå¤šçš„æƒ…å†µï¼Œæ¯”å¦‚ nginx è¿™ç§ web æœåŠ¡å™¨ã€‚\nä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä½¿ç”¨ io_uring_submit_and_wait è¿™ä¸ªå‡½æ•°å°±å¯ä»¥äº†ã€‚\nå¦‚æœ è¿”å›çš„ ret å°äº 0ï¼Œè¯´æ˜å‡ºé”™äº†ï¼Œè¿™é‡Œç®€å•çš„æ‰“å°ä¸€ä¸‹é”™è¯¯ä¿¡æ¯ï¼Œç„¶åé€€å‡ºã€‚\nauto num = io_uring_peek_batch_cqe(\u0026amp;ring, cqes, QUEUE_DEPTH); è¿™ä¸ªå‡½æ•°ä¼šè·å– Completion Queue ä¸­çš„ cqeï¼Œä¸€æ¬¡æœ€å¤šè·å– QUEUE_DEPTH ä¸ª cqeã€‚\nè¿™ä¸ªå‡½æ•°æœ‰ç‚¹ç±»ä¼¼äº epoll çš„ epoll_wait å‡½æ•°ï¼Œä¼šä¸€æ¬¡æ€§è·å–å¤šä¸ª cqeã€‚\nç„¶åéå† cqeï¼Œæ ¹æ® cqe çš„ type æ¥å¤„ç† I/O äº‹ä»¶ã€‚åœ¨ä¹‹å‰çš„submitçš„æ—¶å€™ï¼ŒæŒ‡å®šäº†æœ‰ ACCEPTã€READã€WRITE ä¸‰ç§ I/O äº‹ä»¶ã€‚\nå› ä¸ºä¹‹å‰çš„ cqe ä¸­çš„ user_data æ˜¯ Connection å¯¹è±¡çš„æŒ‡é’ˆï¼Œæ‰€ä»¥å¯ä»¥æ ¹æ® cqe çš„ user_data æ¥è·å– Connection å¯¹è±¡ï¼Œç„¶åæ ¹æ® Connection å¯¹è±¡çš„ type æ¥å¤„ç† I/O äº‹ä»¶ã€‚ æ‰€ä»¥å¯ä»¥ reinterpret_cast\u0026lt;Connection *\u0026gt; (cqes[i]-\u0026gt;user_data);å¼ºè½¬æ¥è·å– Connection å¯¹è±¡ã€‚\nå¦‚æœ type æ˜¯ ACCEPTï¼Œè¯´æ˜æ˜¯æ–°çš„è¿æ¥ï¼Œå°±è°ƒç”¨ newConn å‡½æ•°åˆ›å»ºä¸€ä¸ªæ–°çš„è¿æ¥ï¼Œç„¶åè°ƒç”¨ acceptConnection å‡½æ•°æ¥æ”¶æ–°çš„è¿æ¥ã€‚ åœ¨æ¥æ”¶æ–°çš„è¿æ¥ä¹‹åï¼Œéœ€è¦å†æ¬¡è°ƒç”¨ acceptConnection å‡½æ•°ï¼ŒæŠŠlistenerçš„socketæ”¾å›io_uringä¸­ï¼Œåé¢æ‰èƒ½ç»§ç»­å·¥ä½œã€‚\nå¦‚æœ type æ˜¯ READï¼Œè¯´æ˜æ˜¯è¯»äº‹ä»¶ï¼Œå°±è¯»å– cqe çš„ res å­—æ®µï¼Œå¦‚æœå°äº 0ï¼Œè¯´æ˜è¯»å–å¤±è´¥ï¼Œæ¯”å¦‚å®¢æˆ·ç«¯æ–­å¼€è¿æ¥ï¼Œå°±å…³é—­ fdï¼Œç„¶åä» connections ä¸­ç§»é™¤è¿™ä¸ª fdï¼Œç„¶åé‡Šæ”¾ Connection å¯¹è±¡ã€‚ å¦‚æœè¯»å–æˆåŠŸï¼Œå°±æ‰“å°è¯»å–çš„æ•°æ®ï¼Œç„¶åå‘å®¢æˆ·ç«¯å‘é€ä¸€æ¡æ¶ˆæ¯ã€‚\nå¦‚æœ type æ˜¯ WRITEï¼Œè¯´æ˜æ˜¯å†™äº‹ä»¶ï¼Œåœ¨è¿™é‡Œå°±æ˜¯å‘å®¢æˆ·ç«¯å†™æ•°æ®å®Œæˆäº†ã€‚ è°ƒç”¨ addSocketRead å‡½æ•°ï¼Œå‘ Submission Queue ä¸­æ·»åŠ ä¸€ä¸ª è¯»çš„è¯·æ±‚ï¼Œç„¶åè¿™ä¸ª fd å°±ä¼šç»§ç»­æ¥æ”¶ I/O äº‹ä»¶ã€‚\næœ€åè°ƒç”¨ io_uring_cqe_seen å‡½æ•°ï¼Œæ ‡è®° cqe ä¸ºå·²å¤„ç†ã€‚\nè¿™æ ·ä¸€ä¸ªç®€å•çš„ tcp æœåŠ¡å°±å®ç°äº†ã€‚è¿™ä¸ªæœåŠ¡åªæ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œæ²¡æ³•ç”¨åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œåªæ˜¯ç”¨æ¥å­¦ä¹  iouring çš„åŸºæœ¬ä½¿ç”¨ã€‚\nåƒæ˜¯ä¸­é—´çš„é”™è¯¯å¤„ç†ï¼Œè¿æ¥çš„è¶…æ—¶ç­‰é—®é¢˜éƒ½æ²¡æœ‰å¤„ç†ï¼Œè¿™äº›é—®é¢˜éœ€è¦æ ¹æ®å®é™…æƒ…å†µæ¥å¤„ç†ã€‚\nè¿™ä¸ªä¾‹å­ä¸­ï¼Œä¸€ä¸ª socket åŒæ—¶åªèƒ½è¯»æˆ–è€…å†™ï¼Œä¸èƒ½åŒæ—¶è¯»å†™ï¼Œè¿™ä¸ªé—®é¢˜ä¹Ÿéœ€è¦æ ¹æ®å®é™…æƒ…å†µæ¥å¤„ç†ã€‚\næ€»ç»“ è¿™ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»äº† iouring çš„åŸºæœ¬ä½¿ç”¨ï¼Œå®ç°äº†ä¸€ä¸ªç®€å•çš„ tcp æœåŠ¡ã€‚åªæ˜¯ä»‹ç»äº† iouring çš„åŸºæœ¬ä½¿ç”¨ï¼Œæ²¡æœ‰æ¶‰åŠåº•å±‚å®ç°ã€‚ åé¢æœ‰æ—¶é—´å†å»å­¦ä¸€ä¸‹ liburing çš„æºç ï¼Œçœ‹çœ‹åº•å±‚æ˜¯å¦‚ä½•å®ç°çš„ã€‚\nå…¶å® iouring æœ€ä¸»è¦çš„ä¸¤ä¸ªæ“ä½œæ˜¯æäº¤ I/O è¯·æ±‚åˆ° sq ï¼Œç„¶åç­‰å¾… I/O è¯·æ±‚çš„å®Œæˆå,ä» cq è·å–ç„¶åå¤„ç†ã€‚\nçœ‹å¾ˆå¤šäººéƒ½è¯´ iouring æ€§èƒ½å¾ˆé«˜ï¼Œå°¤å…¶æ˜¯åœ¨ I/O å¯†é›†å‹çš„åœºæ™¯ä¸‹ï¼Œæ€§èƒ½æå‡å¾ˆæ˜æ˜¾ã€‚è¿™éƒ¨åˆ†å†…å®¹è¿˜æ²¡æœ‰éªŒè¯ï¼Œåé¢æœ‰æ—¶é—´å†å»éªŒè¯ä¸€ä¸‹ã€‚\nå› ä¸ºä¹Ÿæ˜¯åˆå­¦ iouringï¼Œæ‰€ä»¥æ–‡ç« ä¸­å¯èƒ½æœ‰é”™è¯¯ï¼Œæ¬¢è¿æ‰¹è¯„æŒ‡æ­£ã€‚\nè¿½æ›´ 2024-10-23\nåœ¨æœåŠ¡ç«¯åŠ äº†ä¸€ç‚¹ä»£ç ï¼Œå†™äº†ä¸€ä¸ªç®€å•çš„ HTTP æœåŠ¡å™¨ï¼Œå¯ä»¥é€šè¿‡æµè§ˆå™¨è®¿é—®ï¼Œç„¶åæ‰¾äº†ä¸€ä¸ª HTTP å‹æµ‹å·¥å…·ï¼Œæµ‹è¯•äº†ä¸€ä¸‹æ€§èƒ½ã€‚\nHTTP æœåŠ¡å™¨è¿”å›çš„å†…å®¹ï¼š\n1conn-\u0026gt;writeBuf = \u0026#34;HTTP/1.1 200 OK\\r\\n\u0026#34; 2 \u0026#34;Content-Length: 55\\r\\n\u0026#34; 3 \u0026#34;Content-Type: text/html\\r\\n\u0026#34; 4 \u0026#34;Connection: keep-alive\\r\\n\u0026#34; 5 \u0026#34;Date: Mon, 23 Oct 2024 13:24:24 GMT\\r\\n\\r\\n\u0026#34; 6 \u0026#34;\u0026lt;!DOCTYPE html\u0026gt;\u0026lt;html\u0026gt;\u0026lt;body\u0026gt;\u0026lt;h1\u0026gt;hello\u0026lt;/h1\u0026gt;\u0026lt;/body\u0026gt;\u0026lt;/html\u0026gt;\u0026#34;; åŒæ ·çš„ï¼Œä½¿ç”¨ epoll ä¹Ÿå®ç°äº†ä¸€ä¸ª HTTP æœåŠ¡å™¨ï¼Œè¿”å›äº†åŒæ ·çš„å†…å®¹ã€‚\nå‡ è½®æµ‹è¯•ä¸‹æ¥ï¼Œå‘ç° epoll çš„æ€§èƒ½è¦æ¯” iouring é«˜ä¸€ç‚¹ã€‚è‡³äºåŸå› è¿˜åœ¨ç ”ç©¶ä¸­ã€‚\nçŒœæµ‹çš„åŸå› å¯èƒ½æ˜¯ åœ¨æ•°æ®é‡å¾ˆå°çš„æ—¶å€™ï¼Œ iouring çš„æ€§èƒ½å‘æŒ¥ä¸å‡ºæ¥ï¼Œç”šè‡³æ•ˆæœæ›´å·®äº†ã€‚ è¿˜æœ‰ä¸€ä¸ªåŸå› å¯èƒ½æ˜¯æˆ‘ä½¿ç”¨çš„æ–¹æ³•æœ‰é—®é¢˜ï¼Œè¿™ä¸ªç­‰åé¢ç»§ç»­ç ”ç©¶ã€‚\n","date":"2024-10-20T17:31:37+08:00","image":"https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/6a84474a44a97bccecbbc9c5a3b9f7aea2571c97.jpg","permalink":"https://lqxhub.github.io/posts/f0e9829c/","title":"Linuxä¸‹ä½¿ç”¨iouringå®ç°ä¸€ä¸ªtcpæœåŠ¡"},{"content":"redisåœ¨ 6.0 ç‰ˆæœ¬åŠ å…¥äº†ACLæ”¯æŒï¼Œè™½ç„¶å·²ç»å‘å¸ƒå¾ˆä¹…äº†ï¼Œä½†æ˜¯è¿™ä¸ªå‘½ä»¤å±äºä¸å¤ªå¸¸ç”¨çš„å‘½ä»¤ï¼Œå¯¼è‡´å¾ˆå¤šäººå¯¹ACLè¿˜ä¸å¤ªäº†è§£ã€‚æ¯”è¾ƒå¥½çš„æ–‡æ¡£å°±æ˜¯redis ACLçš„å®˜æ–¹æ–‡æ¡£ ï¼Œå…¶ä»–ç½‘ä¸Šæœç´¢åˆ°çš„ç›¸å…³çŸ¥è¯†å¤§å¤šæ•°ä¸å…¨é¢ï¼Œå°¤å…¶ä¸­æ–‡æ–‡æ¡£ç¼ºå¤±æ¯”è¾ƒå¤šã€‚\næˆ‘ä¹‹å‰å†™è¿‡ä¸€ç¯‡ redis ACLæºç åˆ†æçš„æ–‡ç« ã€‚ä½†æ˜¯è¿™ç¯‡æ–‡ç« åå‘æºç å­¦ä¹ ï¼Œå¯¹ACLçš„ä½¿ç”¨åŸºæœ¬æ²¡æœ‰ä»‹ç»ã€‚æ‰€ä»¥è¿™æ¬¡å°±æ¥å†™ä¸€ä¸‹ ACL çš„ä½¿ç”¨ã€‚æˆ‘ä½œä¸º pika ACL åŠŸèƒ½çš„è´¡çŒ®è€…ï¼Œpika ACL PRï¼Œè‡ªè®¤ä¸ºå¯¹ACLæœ‰ä¸€äº›äº†è§£ï¼Œå¦‚æœæ–‡ä¸­æœ‰é”™è¯¯ï¼Œè¿˜è¯·ä¸åèµæ•™ã€‚\næˆ‘ä¼šä» ACLåŠŸèƒ½çš„ä»‹ç» å’Œ ACLå‘½ä»¤çš„ä½¿ç”¨ ä¸¤æ–¹é¢æ¥å†™\nACLåŠŸèƒ½ ACLç®€å•æ¥è¯´ï¼Œå°±æ˜¯ç»™redisåŠ äº†ç”¨æˆ·çš„æ¦‚å¿µã€‚ä»¥å‰çš„redisä¸­ï¼Œæ²¡æœ‰ç”¨æˆ·è¿™ä¸ªæ¦‚å¿µï¼Œåªæœ‰ä¸€ä¸ªå¯†ç ã€‚å½“ä¸€ä¸ªè¿æ¥å®Œæˆè®¤è¯åï¼Œå¯ä»¥æ‰§è¡Œæ‰€æœ‰å‘½ä»¤ã€‚è¿™æ ·æ˜¯æœ‰é£é™©çš„ï¼Œå¦‚æœä¸€ä¸ªæ™®é€šçš„ç”¨æˆ·ï¼Œæ‰§è¡Œäº† flushall è¿™æ ·çš„å‘½ä»¤ï¼Œæ•´ä¸ªredisçš„æ•°æ®éƒ½ä¼šè¢«åˆ é™¤ã€‚å½“åŠ å…¥äº†ç”¨æˆ·è¿™ä¸ªæ¦‚å¿µä»¥åï¼Œrediså¯ä»¥é€šè¿‡ç»™ä¸åŒçš„ç”¨æˆ·åˆ’åˆ†ä¸åŒçš„æƒé™ï¼Œæ¯”å¦‚æ™®é€šç”¨æˆ·åªç»™æ•°æ®çš„è¯»å†™æƒé™ï¼Œä¸èƒ½å¯¹redisæœåŠ¡åšä»»ä½•ç®¡ç†ã€‚è¿™æ ·å°±èƒ½ä¿è¯redisæœåŠ¡çš„å®‰å…¨å’Œç¨³å®šã€‚\nå°±åƒMySQLä¸€æ ·ï¼Œæœ‰ä¸€ä¸ªé»˜è®¤çš„ root ç”¨æˆ·ï¼Œè¿™ä¸ªç”¨æˆ·æ‹¥æœ‰æœ€é«˜çš„æƒé™ã€‚ä½†æ˜¯åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œä¸ä¼šåœ¨ä¸šåŠ¡å¤„ç†çš„è¿æ¥ä¸­ä½¿ç”¨rootç”¨æˆ·ï¼Œè€Œæ˜¯åˆ›å»ºä¸€ä¸ªæ™®é€šçš„ç”¨æˆ·ã€‚é™åˆ¶è¿™ä¸ªç”¨æˆ·çš„æƒé™ï¼Œåªèƒ½æ“ä½œè‡ªå·±ä¸šåŠ¡çš„åº“ã€‚å½“redisæœ‰äº†ACLåŠŸèƒ½åï¼Œä¹Ÿå¯ä»¥å®ç°ç±»ä¼¼çš„åŠŸèƒ½äº†\nä½¿ç”¨ACL åœ¨redisä½¿ç”¨ACLä¸éœ€è¦ç‰¹æ®Šçš„é…ç½®ï¼Œåªè¦redisç‰ˆæœ¬æ”¯æŒè¿™ä¸ªåŠŸèƒ½å³å¯ã€‚redisåœ¨å¯åŠ¨çš„æ—¶å€™ï¼Œä¼šåˆå§‹åŒ–ä¸€ä¸ªé»˜è®¤ç”¨æˆ· default è¿™ä¸ªç”¨æˆ·å°±ç›¸å½“äºMySQLä¸­çš„ root ç”¨æˆ·ã€‚é»˜è®¤æ‹¥æœ‰æ‰€æœ‰æƒé™ã€‚\næ“ä½œå’Œä¿®æ”¹redisçš„ACLï¼Œå¯ä»¥ä½¿ç”¨redisä¸­ACLçš„ç›¸å…³å‘½ä»¤ï¼ˆåé¢ä¼šé€ä¸ªä»‹ç»ï¼‰ï¼Œå¯ä»¥åœ¨é…ç½®æ–‡ä»¶ä¸­é¢„å…ˆè®¾å®šï¼Œå¯åŠ¨redisçš„æ—¶å€™ä¼šè‡ªåŠ¨åŠ è½½é¢„è®¾çš„ACLè§„åˆ™ã€‚\nå¯ä»¥åœ¨redisçš„é…ç½®æ–‡ä»¶ï¼ˆé»˜è®¤æ˜¯redis.confï¼‰ä¸­è¿›è¡Œé…ç½®ã€‚\nä¾‹ï¼š\n1user default on nopass ~* \u0026amp;* +@ALL è¿™å°±æ˜¯ä¸€æ¡ACLçš„é…ç½®ã€‚\né™¤äº†åœ¨ redis.confè¿™é…ç½®ä»¥å¤–ï¼Œè¿˜å¯ä»¥åœ¨ redis.conf ä¸­æŒ‡å®šä¸€ä¸ªæ–‡ä»¶ï¼Œç„¶ååœ¨æŒ‡å®šçš„æ–‡ä»¶ä¸­é…ç½®ACLè§„åˆ™ã€‚ ACLæ–‡ä»¶åœ¨redis.confé…ç½®å¦‚ä¸‹\n1aclfile /etc/redis/users.acl é™¤äº†è¿™ä¸¤ä¸ªå¤–ï¼ŒACLå‡ ä¸ªä¸ªé…ç½®\nACL logè®°å½•çš„æ¡æ•°ï¼Œlogçš„ä½œç”¨å°±æ˜¯è®°å½•ç”¨æˆ·è¶Šæƒè¡Œä¸ºã€‚\né…ç½®ï¼š\n1acllog-max-len 128 ACL ä¸­channel çš„é»˜è®¤çŠ¶æ€ã€‚å¯ä»¥é…ç½® allchannels æˆ– resetchannelsã€‚\nallchannelsï¼š å¯ä»¥è®¿é—®æ‰€æœ‰Pub/Subé¢‘é“çš„æƒé™ resetchannelsï¼š æ’¤é”€å¯¹æ‰€æœ‰Pub/Subé¢‘é“çš„è®¿é—® é…ç½®ï¼š\n1acl-pubsub-default resetchannels ACLé…ç½®è¯­æ³• é¦–å…ˆï¼ŒACLå¯ä»¥å¯¹ å‘½ä»¤ï¼Œkeyçš„åå­—ï¼Œchannel åšé™åˆ¶ï¼Œå¤šä¸ªè§„åˆ™ä¹‹é—´ç”¨ç©ºæ ¼åˆ†å‰²ã€‚\nuser1 on \u0026gt;123 ~* \u0026amp;* +@ALL è¿™æ¡é…ç½®ä¸­ã€‚\nuser1ï¼šç”¨æˆ·å onï¼šç”¨æˆ·å¯ç”¨ï¼Œå¦‚æœè®¾ç½®ä¸º off é‚£ä¹ˆç”¨æˆ·ä¸èƒ½ä½¿ç”¨ \u0026gt;123ï¼š ç”¨æˆ·å¯†ç  ~*ï¼šä¸åšä»»ä½• keyåå­—çš„é™åˆ¶ \u0026amp;*ï¼šä¸åš pub/sub çš„é™åˆ¶ +@ALLï¼šå…è®¸æ‰§è¡Œæ‰€æœ‰å‘½ä»¤ å¯†ç  redis ACLä¸­ï¼Œä¸€ä¸ªç”¨æˆ·å¯ä»¥æœ‰å¤šä¸ªå¯†ç ï¼Œåªè¦æœ‰ä¸€ä¸ªå¯†ç è®¤è¯æˆåŠŸå°±å¯ä»¥ã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨ nopass è¿™ä¸ªå…³é”®è¯æ¥è¡¨ç¤ºè¯¥ç”¨æˆ·æ²¡æœ‰å¯†ç ã€‚\nåœ¨è®¾ç½®å¯†ç çš„æ—¶å€™ï¼Œä½¿ç”¨ \u0026gt;password æ¥è®¾ç½®å¯†ç ï¼Œä½¿ç”¨\u0026lt;password æ¥åˆ é™¤å¯¹åº”çš„å¯†ç ã€‚\nè¿˜å¯ä»¥ä½¿ç”¨ #5baa61e4c9b93f3f0682250b6cf8331b7ee68fd8 æ¥è®¾ç½®å¯†ç ï¼Œ5baa61e4c9b93f3f0682250b6cf8331b7ee68fd8 æ˜¯ password çš„ sha1 å€¼ã€‚ä¸ºäº†å¯†ç å®‰å…¨ï¼Œrediså†…éƒ¨å­˜å‚¨å¯†ç ä½¿ç”¨çš„æ˜¯å¯†ç çš„ sha1ï¼Œè¿™æ ·åœ¨é…ç½®æ–‡ä»¶å’Œè½¬å‚¨ACLè§„åˆ™çš„æ—¶å€™ï¼Œå¯ä»¥ä¿è¯å¯†ç çš„å®‰å…¨ã€‚\nåŒæ ·çš„ï¼Œå¯ä»¥ä½¿ç”¨ !5baa61e4c9b93f3f0682250b6cf8331b7ee68fd8 æ¥åˆ é™¤å¯¹åº”çš„å¯†ç ã€‚\nkeyåé™åˆ¶ redisä¸­æ¯ä¸ªkeyéƒ½æœ‰ä¸€ä¸ªåå­—ï¼Œä½¿ç”¨ ~ æ¥åškeyåå­—é™åˆ¶ï¼Œæ”¯æŒ * é€šé…ç¬¦ï¼Œè€Œä¸”æ”¯æŒkeyçš„åªè¯» R å’Œ å†™ W åŒºåˆ†ã€‚\næ¯”å¦‚ å¯¹ app1 è¿™ä¸ªkeyåªè¯» %R~app1ã€‚å¯¹æ‰€æœ‰ app2 å¼€å¤´çš„keyéƒ½æœ‰æƒé™ ~app2*\npub/subé™åˆ¶ pub/subé™åˆ¶å’Œkeyåé™åˆ¶ç±»ä¼¼ï¼Œè¦ä½¿ç”¨pub/subçš„å‰ææ˜¯å¯ä»¥ä½¿ç”¨ pub/subç›¸å…³çš„å‘½ä»¤ï¼Œè¿™éƒ¨åˆ†åœ¨å‘½ä»¤é™åˆ¶ä¸­é…ç½®ï¼Œè¿™é‡Œæ˜¯é™åˆ¶ channel çš„åå­—ã€‚\nå’Œkeyé™åˆ¶ä¸åŒçš„æ˜¯ï¼Œchannel ä½¿ç”¨ \u0026amp; ç¬¦å·\nè¿™é‡Œæœ‰ä¸¤ä¸ªå…³é”®è¯\nallchannelsï¼š å¯ä»¥è®¿é—®æ‰€æœ‰Pub/Subé¢‘é“çš„æƒé™ resetchannelsï¼š æ’¤é”€å¯¹æ‰€æœ‰Pub/Subé¢‘é“çš„è®¿é—® å‘½ä»¤é™åˆ¶ å‘½ä»¤æœ€å¥½ç†è§£äº†ï¼Œå°±æ˜¯é™åˆ¶å½“å‰ç”¨æˆ·å¯ä»¥æ‰§è¡Œå“ªäº›å‘½ä»¤ï¼Œä¸èƒ½æ‰§è¡Œå“ªäº›å‘½ä»¤ã€‚ åœ¨ACLä¸­ä½¿ç”¨ + æ¥èµ‹äºˆå‘½ä»¤çš„æƒé™ï¼Œç”¨ - æ¥æ’¤é”€å‘½ä»¤çš„æƒé™ã€‚æ¯”å¦‚ +get -set è¿™å°±è¡¨ç¤ºèµ‹äºˆ get å‘½ä»¤ï¼Œæ’¤é”€ setå‘½ä»¤ã€‚\né™¤äº†ç›´æ¥æŒ‡å®šå…·ä½“çš„å‘½ä»¤å¤–ï¼Œè¿˜å¯ä»¥å¯¹ä¸€ç±»å‘½ä»¤åšé™åˆ¶ã€‚æ¯”å¦‚ +@hash -@zsetï¼Œè¿™è¡¨ç¤ºå¯ä»¥æ‰§è¡Œæ‰€æœ‰çš„ hash ç±»çš„å‘½ä»¤ï¼Œä¸èƒ½æ‰§è¡Œæ‰€æœ‰çš„ zset ç±»çš„å‘½ä»¤ã€‚\nredis ACL è¿˜å¯ä»¥é™åˆ¶å­å‘½ä»¤ã€‚æ¯”å¦‚ CONFIG SET acllog-max-len 128 ä¸­ï¼ŒSET å°±æ˜¯ CONFIG å‘½ä»¤çš„å­å‘½ä»¤ã€‚å¦‚æœæƒ³è¦é™åˆ¶ç”¨æˆ·ä¸èƒ½ä¿®æ”¹é…ç½®ï¼Œé‚£ACLå¯ä»¥è¿™æ ·é…ç½® +config -config|setã€‚æ­¤æ—¶ç”¨æˆ·å¯ä»¥æ‰§è¡Œ config set ä»¥å¤–çš„æ‰€æœ‰ config å‘½ä»¤ã€‚\nè¿˜æœ‰ä¸€ç§ç”¨æ³•ï¼Œå…è®¸é˜»å¡å‘½ä»¤çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œä¸è¿‡è¿™ä¸ªåŠŸèƒ½è‡ªRedis 7.0èµ·å·²å¼ƒç”¨ï¼Œå°†æ¥å¯èƒ½ä¼šè¢«åˆ é™¤ã€‚æ‰€ä»¥ä¸å»ºè®®ä½¿ç”¨äº†ã€‚\nç”¨rediså®˜æ–¹æ–‡æ¡£çš„ä¾‹å­æ¥è¯´\næœ‰æ—¶ï¼Œæ’é™¤æˆ–åŒ…å«å‘½ä»¤æˆ–å­å‘½ä»¤ä½œä¸ºä¸€ä¸ªæ•´ä½“çš„èƒ½åŠ›æ˜¯ä¸å¤Ÿçš„ã€‚è®¸å¤šéƒ¨ç½²å¯èƒ½ä¸æ„¿æ„ä¸ºä»»ä½•DBæä¾›æ‰§è¡ŒSELECTçš„èƒ½åŠ›ï¼Œä½†å¯èƒ½ä»ç„¶å¸Œæœ›èƒ½å¤Ÿè¿è¡ŒSELECT 0ã€‚\næ­¤æ—¶çš„é…ç½® ACL SETUSER myuser -select +select|0ã€‚è¿™æ ·ï¼Œè¯¥ç”¨æˆ·åªèƒ½æ‰§è¡Œ select 0 è¿™ä¸€ä¸ª select å‘½ä»¤ã€‚å¦‚æœæƒ³ select 2 ç­‰ç­‰è¿›å…¥åˆ«çš„åº“æ˜¯ä¸å…è®¸çš„ã€‚\næˆ‘ä¸ªäººæ„Ÿè§‰ï¼Œè¦æ·˜æ±°è¿™ä¸ªåŠŸèƒ½çš„åŸå› ï¼Œæ˜¯åº”ç”¨é¢å¤ªå°‘äº†ï¼Œè€Œä¸”åƒä¸Šé¢çš„è¿™ä¸ªä¾‹å­ä¸­ï¼Œå¹¶æ²¡æœ‰å®Œå…¨é™åˆ¶äº†å¯¹åº“çš„ä½¿ç”¨æƒé™ã€‚å¦‚æœå…ˆåœ¨åˆ«çš„ç”¨æˆ·ä¸‹ï¼Œé€‰æ‹©äº† 1 è¿™ä¸ªåº“ï¼Œç„¶åå† auth myuser è¿™ä¸ªç”¨æˆ·ï¼Œè™½ç„¶è¿™ä¸ªç”¨æˆ·é™åˆ¶äº†ï¼Œåªèƒ½ select 0ï¼Œä½†æ˜¯æ­¤æ—¶ä¾ç„¶å¯ä»¥è®¿é—® 1 è¿™ä¸ªåº“ã€‚\nrediså‘½ä»¤çš„åˆ†ç±»ï¼š\nadminÂ ç®¡ç†redisæœåŠ¡ç›¸å…³çš„å‘½ä»¤ åŒ…å« REPLICAOF CONFIG SAVE MONITORÂ ACL SHUTDOWNç­‰ç­‰ bitmapÂ bitmapè¿™ä¸ªæ•°æ®ç±»å‹ç›¸å…³çš„å‘½ä»¤ blocking å¯èƒ½ä¼šé˜»å¡è¿æ¥ï¼Œç›´åˆ°è¢«å¦ä¸€ä¸ªå‘½ä»¤é‡Šæ”¾ connectionÂ å½±å“è¿æ¥æˆ–å…¶ä»–è¿æ¥çš„å‘½ä»¤ã€‚åŒ…å« AUTH SELECT COMMAND CLIENT ECHO PINGç­‰ç­‰ dangerousÂ æœ‰æ½œåœ¨å±é™©çš„å‘½ä»¤(ç”±äºå„ç§åŸå› ï¼Œåº”è¯¥ä»”ç»†è€ƒè™‘æ¯ä¸ªå‘½ä»¤)ã€‚åŒ…å«Â FLUSHALL MIGRATE RESTORE SORT KEYS CLIENT INFO CONFIG SAVE REPLICAOFç­‰ç­‰ geoÂ geoè¿™ä¸ªæ•°æ®ç±»å‹ç›¸å…³çš„å‘½ä»¤ hash hashè¿™ä¸ªæ•°æ®ç±»å‹ç›¸å…³çš„å‘½ä»¤ hyperloglog hyperloglog è¿™ä¸ªæ•°æ®ç±»å‹ç›¸å…³çš„å‘½ä»¤ fastÂ å¿« O(1) çš„å‘½ä»¤ï¼Œå¯ä»¥å¾ªç¯å‚æ•°çš„ä¸ªæ•°ï¼Œä½†ä¸èƒ½å¾ªç¯é”®ä¸­çš„å…ƒç´ ä¸ªæ•°ã€‚ keyspace ä»¥ä¸ç±»å‹æ— å…³çš„æ–¹å¼ä»é”®ã€æ•°æ®åº“æˆ–å®ƒä»¬çš„å…ƒæ•°æ®å†™å…¥æˆ–è¯»å–ã€‚åŒ…å« DEL RESTORE DUMP RENAME EXISTS DBSIZE KEYS EXPIRE TTL FLUSHALL å¯èƒ½ä¿®æ”¹é”®ç©ºé—´ã€é”®æˆ–å…ƒæ•°æ®çš„å‘½ä»¤ä¹Ÿå°†å…·æœ‰ write ç±»åˆ«ã€‚ä»…è¯»å–é”®ç©ºé—´ã€é”®æˆ–å…ƒæ•°æ®çš„å‘½ä»¤å°†å…·æœ‰ read ç±»åˆ«ã€‚ listÂ listè¿™ä¸ªæ•°æ®ç±»å‹ç›¸å…³çš„å‘½ä»¤ pubsub PubSub è®¢é˜…å‘å¸ƒç›¸å…³çš„å‘½ä»¤ readÂ ä»é”®(å€¼æˆ–å…ƒæ•°æ®)è¯»å–ã€‚ä¸ä¸é”®äº¤äº’çš„å‘½ä»¤æ—¢æ²¡æœ‰ read ä¹Ÿæ²¡æœ‰ write scriptingÂ luaè„šæœ¬æ‰§è¡Œç›¸å…³çš„å‘½ä»¤ setÂ set è¿™ä¸ªæ•°æ®ç»“æ„ç›¸å…³çš„å‘½ä»¤ sortedset zsetæ•°æ®ç»“æ„ç›¸å…³çš„å‘½ä»¤ slowÂ æ…¢å‘½ä»¤ï¼Œé fastçš„å‘½ä»¤ stream stream è¿™ä¸ªæ•°æ®ç±»å‹ç›¸å…³çš„å‘½ä»¤ string string è¿™ä¸ªæ•°æ®ç±»å‹ç›¸å…³çš„å‘½ä»¤ transactionÂ WATCH MULTI EXEC è¿™å‡ ä¸ªå’Œäº‹åŠ¡ç›¸å…³çš„å‘½ä»¤ writeÂ å†™å…¥é”®(å€¼æˆ–å…ƒæ•°æ®)çš„å‘½ä»¤ ACLç›¸å…³å‘½ä»¤ ä½¿ç”¨ ACL HELP å‘½ä»¤å¯ä»¥çœ‹åˆ°ACLæ‰€æœ‰çš„å‘½ä»¤\n1 1) ACL \u0026lt;subcommand\u0026gt; [\u0026lt;arg\u0026gt; [value] [opt] ...]. Subcommands are: 2 2) CAT [\u0026lt;category\u0026gt;] 3 3) List all commands that belong to \u0026lt;category\u0026gt;, or all command categories 4 4) when no category is specified. 5 5) DELUSER \u0026lt;username\u0026gt; [\u0026lt;username\u0026gt; ...] 6 6) Delete a list of users. 7 7) DRYRUN \u0026lt;username\u0026gt; \u0026lt;command\u0026gt; [\u0026lt;arg\u0026gt; ...] 8 8) Returns whether the user can execute the given command without executing the command. 9 9) GETUSER \u0026lt;username\u0026gt; 1010) Get the user\u0026#39;s details. 1111) GENPASS [\u0026lt;bits\u0026gt;] 1212) Generate a secure 256-bit user password. The optional `bits` argument can 1313) be used to specify a different size. 1414) LIST 1515) Show users details in config file format. 1616) LOAD 1717) Reload users from the ACL file. 1818) LOG [\u0026lt;count\u0026gt; | RESET] 1919) Show the ACL log entries. 2020) SAVE 2121) Save the current config to the ACL file. 2222) SETUSER \u0026lt;username\u0026gt; \u0026lt;attribute\u0026gt; [\u0026lt;attribute\u0026gt; ...] 2323) Create or modify a user with the specified attributes. 2424) USERS 2525) List all the registered usernames. 2626) WHOAMI 2727) Return the current connection username. 2828) HELP 2929) Prints this help. é‚£å°±ä¸€ä¸ªä¸ªæ¥å§\nACL CAT åˆ—å‡ºæ‰€æœ‰çš„å‘½ä»¤åˆ†ç±»ï¼Œå¦‚æœåˆ¶å®šäº†åˆ†ç±»åï¼Œå°±åˆ—å‡ºå½“å‰åˆ†ç±»ä¸­æ‰€æœ‰çš„å‘½ä»¤\nä½¿ç”¨ï¼šACL CAT\n1 1) \u0026#34;keyspace\u0026#34; 2 2) \u0026#34;read\u0026#34; 3 3) \u0026#34;write\u0026#34; 4 4) \u0026#34;set\u0026#34; 5 5) \u0026#34;sortedset\u0026#34; 6 6) \u0026#34;list\u0026#34; 7 7) \u0026#34;hash\u0026#34; 8 8) \u0026#34;string\u0026#34; 9 9) \u0026#34;bitmap\u0026#34; 1010) \u0026#34;hyperloglog\u0026#34; 1111) \u0026#34;geo\u0026#34; 1212) \u0026#34;stream\u0026#34; 1313) \u0026#34;pubsub\u0026#34; 1414) \u0026#34;admin\u0026#34; 1515) \u0026#34;fast\u0026#34; 1616) \u0026#34;slow\u0026#34; 1717) \u0026#34;blocking\u0026#34; 1818) \u0026#34;dangerous\u0026#34; 1919) \u0026#34;connection\u0026#34; 2020) \u0026#34;transaction\u0026#34; 2121) \u0026#34;scripting\u0026#34; ä½¿ç”¨ï¼šACL CAT HASHï¼Œåˆ—å‡º hash è¿™ä¸ªåˆ†ç±»ä¸‹æ‰€æœ‰çš„å‘½ä»¤ã€‚\nACL DELUSER è¿™ä¸ªæ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œå°±æ˜¯åˆ é™¤æŒ‡å®šçš„ç”¨æˆ·ã€‚ä¾‹å¦‚ï¼šACL DELUSER user1 user2\nACL DRYRUN ç”¨æ¥æµ‹è¯•æŒ‡å®šç”¨æˆ·æ˜¯å¦å¯ä»¥æ‰§è¡Œç‰¹å®šçš„å‘½ä»¤ã€‚\næ¯”å¦‚æµ‹è¯• user1 æ˜¯å¦å¯ä»¥æ‰§è¡Œ hset hkey field1 1111 å‘½ä»¤å¦‚ä¸‹\nACL DRYRUN user1 hset hkey field1 1111 å¦‚æœæœ‰æƒé™æ‰§è¡Œï¼Œä¼šè¿”å› OKï¼Œå¦åˆ™ä¼šæç¤ºå…·ä½“çš„é”™è¯¯ã€‚\nACL GETUSER å°±å¦‚å­—é¢æ„æ€ï¼Œè·å–æŒ‡å®šç”¨æˆ·çš„è¯¦ç»†ä¿¡æ¯ï¼Œä¾‹ï¼šACL GETUSER user1\nACL GENPASS ç”Ÿæˆä¸€ä¸ªéšæœºå¯†ç ï¼Œé»˜è®¤é•¿åº¦æ˜¯ 256 ä½çš„å¯†ç ï¼Œä¹Ÿå¯ä»¥æŒ‡å®šé•¿åº¦ã€‚\nACL LIST ä½¿ç”¨ ACL é…ç½®æ–‡ä»¶ä¸­çš„æ ¼å¼ï¼Œåˆ—å‡ºå½“å‰ç³»ç»Ÿä¸­æ‰€æœ‰çš„ç”¨æˆ·çš„è¯¦ç»†ä¿¡æ¯\nACL LOAD ä»é…ç½®ä¸­é‡æ–°åŠ è½½ACLçš„é…ç½®ï¼Œå¦‚æœredisçš„é…ç½®æ–‡ä»¶ä¸­ï¼Œæ²¡æœ‰é…ç½® aclfile çš„æ–‡ä»¶è·¯å¾„ï¼Œé‚£ä¹ˆè¿™ä¸ªå‘½ä»¤ä¼šæŠ¥é”™ã€‚\nACL LOG æŸ¥è¯¢æ‰€æœ‰æ²¡æœ‰é€šè¿‡æ ¡éªŒçš„è¡Œä¸ºï¼Œæ¯”å¦‚ user1 æ²¡æœ‰ hash ç±»å‹æ•°æ®æ“ä½œçš„æƒé™ï¼Œåœ¨ä½¿ç”¨ hash ç±»å‹çš„å‘½ä»¤åï¼Œä¼šè®°å½•ä¸€æ¡log\nlogè®°å½•çš„æœ€å¤§å€¼ï¼Œä» é…ç½®æ–‡ä»¶ä¸­çš„ acllog-max-len ä¸­è¯»å–ã€‚\nè¿™ä¸ªå‘½ä»¤å¯ä»¥é€šè¿‡å‚æ•°ï¼Œæ¥æŒ‡å®šä¸€æ¬¡è·å–çš„logæ•°é‡ï¼Œä¾‹ï¼šACL LOG 10 åªè·å–10æ¡\nè¿˜å¯ä»¥é‡ç½®æ‰€æœ‰logï¼Œä¾‹ï¼šACL LOG reset\nACL SAVE å’Œ ACL LOAD å‘½ä»¤ç›¸åï¼Œè¿™ä¸ªæ˜¯æŠŠå½“å‰çš„ACLè§„åˆ™ä¿å­˜åˆ°æ–‡ä»¶ä¸­ã€‚è¿™ä¸ªå‘½ä»¤ä¹Ÿéœ€è¦åœ¨é…ç½®äº† aclfile åæ‰èƒ½æ‰§è¡Œï¼Œå¦åˆ™ä¹Ÿä¼šæŠ¥é”™ã€‚\nACL SETUSER è¿™ä¸ªæ˜¯ACLä¸­æœ€å¸¸ç”¨çš„å‘½ä»¤äº†ï¼Œç”¨æ¥åˆ›å»ºå’Œè®¾ç½®ACLç”¨æˆ·å±æ€§ã€‚åˆ›å»ºå’Œä¿®æ”¹ç”¨æˆ·ï¼Œä½¿ç”¨ ACL è¯­æ³•ï¼ŒåŒé…ç½®ä¸­çš„è¯­æ³•æ˜¯ä¸€è‡´çš„ã€‚\nä¾‹ï¼šACL SETUSER user1 on \u0026gt;123 ~app1* +@all ä¼šä¿®æ”¹ user1 è¿™ä¸ªç”¨æˆ·çš„å±æ€§ï¼Œå¦‚æœä¹‹å‰æ²¡æœ‰è¿™ä¸ªç”¨æˆ·ï¼Œé‚£ä¹ˆä¼šåˆ›å»ºè¿™ä¸ªç”¨æˆ·ï¼Œå¹¶è®¾ç½®å±æ€§ã€‚\nACLè¿˜æ”¯æŒå­å±æ€§ï¼Œä¾‹ï¼šACL SETUSER user1 on \u0026gt;123 ~app1* +@all (+@read ~app2) åœ¨è¿™ä¸ªè§„åˆ™ä¸‹ï¼Œuser1 ç”¨æˆ·å¯¹ app1 å‰ç¼€çš„keyæ‹¥æœ‰è¯»å†™æƒé™ï¼Œå¯¹ app2 å‰ç¼€çš„keyåªæœ‰è¯»çš„æƒé™ã€‚\nACL USERS åªåˆ—å‡ºå½“å‰ç³»ç»Ÿæ‰€æœ‰çš„ç”¨æˆ·åï¼Œç›¸å½“äºæ˜¯ ACL LIST å‘½ä»¤çš„ç®€åŒ–ç‰ˆ\nACL WHOAMI è·å–å½“å‰ç”¨æˆ·çš„åå­—ï¼Œç±»ä¼¼Linuxç³»ç»Ÿä¸­çš„ whoami å‘½ä»¤ã€‚\nåˆ°è¿™æ•´ä¸ªACLå‘½ä»¤ä½¿ç”¨å·®ä¸å¤šå°±ä»‹ç»å®Œäº†ã€‚æ•´ä¸ªACLå°±æ˜¯å‘½ä»¤å¤šç‚¹ï¼Œä½¿ç”¨èµ·æ¥ä¹Ÿæ²¡æœ‰é‚£ä¹ˆå¤æ‚å—ã€‚\n","date":"2024-03-10T18:32:52Z","image":"https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/20210321231957647.png","permalink":"https://lqxhub.github.io/posts/1cb4847b/","title":"redis ACLä½¿ç”¨æ‰‹å†Œï¼Œredis6.0 redis ä¸­ä½¿ç”¨ACLæ‰‹å†Œ - QX's blog"},{"content":"å»å¹´å†™è¿‡ä¸¤ç¯‡redisçš„æºç åˆ†ææ–‡ç« ï¼ˆredisçš„watchå’ŒACLï¼‰ï¼Œç°åœ¨å›å¤´çœ‹ï¼Œå·²ç»è¿‡å»å¥½ä¹…äº†ã€‚è¯´èµ·é‚£ä¸¤ç¯‡æ–‡ç« ï¼Œæ”¶ç›Šè¿˜æ˜¯æŒºå¤§çš„ã€‚è¿™å‘¨æœ‰æ—¶é—´äº†ï¼Œç»§ç»­å­¦ä¹ redisçš„æºç ã€‚å…ˆæ¥çœ‹ä¸€ä¸‹redisçš„ç½‘ç»œå¤„ç†ã€‚\næœ¬æ¬¡çš„æºç åŸºäºredisçš„ 7.2 åˆ†æ”¯ï¼Œä¸åŒç‰ˆæœ¬ä¸‹ï¼Œä¸€äº›ç»†èŠ‚å¯èƒ½ä¼šæœ‰å·®å¼‚ã€‚\nè¿™ç¯‡æ–‡ç« å› ä¸ºç¯‡å¹…æ‰€é™ï¼Œæ²¡æ³•æŠŠredisç½‘ç»œè¯»å†™çš„æ‰€æœ‰ç»†èŠ‚éƒ½åˆ†æåˆ°ï¼Œåªèƒ½æŠŠè¿™ä¸ªç½‘ç»œå¤„ç†çš„å¤§æ¦‚æµç¨‹èµ°ä¸€éã€‚\nçœ‹å®Œè¿™ç¯‡æ–‡ç« ï¼Œèƒ½å¯¹redisç½‘ç»œå¤„ç†æµç¨‹æœ‰ä¸ªåŸºæœ¬äº†è§£ï¼Œèƒ½çŸ¥é“redisåŠ å…¥äº†å¤šçº¿ç¨‹åï¼Œä¸ºä»€ä¹ˆè¿˜æ˜¯å•çº¿ç¨‹å¤„ç†æ•°æ®ã€‚èƒ½çŸ¥é“redisæ˜¯å¦‚ä½•å®ç°é€‚é…ä¸åŒç³»ç»Ÿä¸‹ç½‘ç»œæ¥å£ã€‚\nå…ˆæ¥å†™ä¸€ä¸‹redisç½‘ç»œéœ€è¦çš„ä¸€äº›æ•°æ®ç»“æ„ã€‚\næ•°æ®ç»“æ„ï¼š rediså¯ä»¥æ”¯æŒå¤šä¸ªå¹³å°ï¼ˆLinuxï¼ŒUnixï¼‰ï¼Œè¿™ä¸¤ä¸ªå¹³å°çš„ç½‘ç»œè°ƒç”¨æ˜¯ä¸ä¸€æ ·çš„ï¼ŒLinuxä¸­é«˜æ€§èƒ½çš„ç½‘ç»œæ¥å£æ˜¯epollï¼ŒUnixä¸Šæ˜¯kqueueã€‚å› ä¸ºç‰ˆæœ¬çš„åŸå› ï¼Œåœ¨ä½ç‰ˆæœ¬çš„Linuxå†…æ ¸ä¸­ï¼Œepoolä¹Ÿæ˜¯ä¸æ”¯æŒçš„ï¼Œè¿™æ—¶å€™å°±éœ€è¦ç”¨åˆ°selectã€‚redisä½¿ç”¨äº† aeEvent è¿™ä¸ªç»“æ„æ¥å°è£…äº†ç½‘ç»œï¼Œå®ç°äº†å¯¹ä¸åŒç½‘ç»œæ¥å£çš„å…¼å®¹ã€‚ ç»“æ„çš„å®šä¹‰åœ¨ ae.h æ–‡ä»¶ä¸­ aeEventLoop\naeEventLoop æ˜¯redisç½‘ç»œä¸­ï¼Œæ‰€æœ‰ç½‘ç»œäº‹ä»¶çš„ç®¡ç†å™¨ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œç°åœ¨çš„ç½‘ç»œä¸€èˆ¬éƒ½æ˜¯é€šè¿‡å¤šè·¯å¤ç”¨æ¥å¤„ç†å¤šä¸ªé“¾æ¥ï¼Œå¤šè·¯å¤ç”¨çš„å®ç°åœ¨ä¸åŒçš„ç³»ç»Ÿä¸­æœ‰ä¸åŒçš„å®ç°ï¼Œæ‰€æœ‰redisä½¿ç”¨ aeEventLoop çš„å°è£…æ¥å®ç°ä¸åŒå¹³å°çš„å…¼å®¹ã€‚è¿™ä¸ªç»“æ„æ˜¯å…¨å±€å”¯ä¸€çš„ï¼Œrediså¯åŠ¨åå®Œæˆåˆå§‹åŒ–ã€‚\n1typedef struct aeEventLoop { 2 int maxfd; /* highest file descriptor currently registered */ 3 int setsize; /* max number of file descriptors tracked */ 4 long long timeEventNextId; 5 aeFileEvent *events; /* Registered events */ 6 aeFiredEvent *fired; /* Fired events */ 7 aeTimeEvent *timeEventHead; 8 int stop; 9 void *apidata; /* This is used for polling API specific data */ 10 aeBeforeSleepProc *beforesleep; 11 aeBeforeSleepProc *aftersleep; 12 int flags; 13} aeEventLoop; aeFileEvent å’Œ aeFiredEvent æ˜¯å¤„ç†ç½‘ç»œäº‹ä»¶çš„æ•°ç»„ç»“æ„ï¼ŒaeTimeEvent æ˜¯å¤„ç†rediså®šæ—¶å›è°ƒçš„ç»“æ„æ•°ç»„ã€‚\naeFileEvent æ˜¯æ³¨å†Œåˆ°ç³»ç»Ÿä¸­çš„äº‹ä»¶ï¼Œåœ¨ epoll ä¸­å°±æ˜¯ struct epoll_event ç»“æ„ã€‚ aeFiredEvent æ˜¯è¿™æ¬¡è¦å¤„ç†çš„äº‹ä»¶ã€‚åœ¨ epoll ä¸­å°±æ˜¯ é€šè¿‡ epoll_wait è¿”å›çš„äº‹ä»¶ã€‚ timeEventHead æ˜¯å®šæ—¶å™¨è¦å¤„ç†çš„äº‹ä»¶ã€‚ aeFileEvent æ˜¯redisä¸­ï¼Œå¤šè·¯å¤ç”¨çš„äº‹ä»¶å°è£…ã€‚æ¯ä¸€ä¸ªç½‘ç»œé“¾æ¥éƒ½ä¼šè¢«åŒ…è£…æˆä¸€ä¸ª aeFileEvent å¯¹è±¡ï¼Œï¼ˆå› ä¸ºåœ¨ Unixç³»åˆ—çš„ç³»ç»Ÿä¸­ï¼Œä¸‡ç‰©çš†æ˜¯æ–‡ä»¶å˜›ï¼Œæ‰€æœ‰è¿™é‡Œä¹Ÿå°±å« aeFileEventäº†ï¼‰ï¼Œç„¶ååŠ å…¥åˆ° aeEventLoop ä¸­ï¼Œæœ€åäº¤ç»™æ“ä½œç³»ç»Ÿä¸­çš„å¤šè·¯å¤ç”¨ç®¡ç†ã€‚å½“è¢«ç®¡ç†çš„äº‹ä»¶è¢«è§¦å‘åï¼Œä¼šå›è°ƒå¯¹åº”çš„å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯ rfileProc æˆ–è€… wfileProc å‡½æ•°æŒ‡é’ˆï¼Œæ¥å®Œæˆæ“ä½œã€‚\n1typedef struct aeFileEvent { 2 int mask; /* one of AE_(READABLE|WRITABLE|BARRIER) */ 3 aeFileProc *rfileProc; 4 aeFileProc *wfileProc; 5 void *clientData; 6} aeFileEvent; ç½‘ç»œå¤„ç†çš„å®ç°åœ¨ ae.c ä¸­\nåœ¨ae.cä¸­ï¼Œé€šè¿‡å®å®šä¹‰ï¼Œæ¥å®ç°å¯¹ä¸åŒå¹³å°çš„å…¼å®¹\n1#ifdef HAVE_EVPORT 2#include \u0026#34;ae_evport.c\u0026#34; 3#else 4 #ifdef HAVE_EPOLL 5 #include \u0026#34;ae_epoll.c\u0026#34; 6 #else 7 #ifdef HAVE_KQUEUE 8 #include \u0026#34;ae_kqueue.c\u0026#34; 9 #else 10 #include \u0026#34;ae_select.c\u0026#34; 11 #endif 12 #endif 13#endif ae.c#L52-L65 é€šè¿‡åˆ¤æ–­å®å®šä¹‰ï¼Œç„¶åincludeä¸åŒçš„ .cæ–‡ä»¶ã€‚\nè¿™é‡Œå¯èƒ½æœ‰å¯¹Cè¯­è¨€äº†è§£ä¸æ·±çš„åŒå­¦å¯èƒ½ä¼šç–‘é—®ï¼Œinclude å…³é”®å­—ä¸æ˜¯ç”¨æ¥åŒ…å«å¤´æ–‡ä»¶çš„å—ï¼Œè¿˜èƒ½ç”¨æ¥å¼•å…¥ .cæ–‡ä»¶å—ï¼Ÿå…¶å®includeæ˜¯ç¼–è¯‘å™¨çš„ä¸€ä¸ªé¢„å¤„ç†æŒ‡ä»¤ï¼Œå°±æ˜¯ç®€å•çš„æŠŠå¯¹åº”çš„æ–‡ä»¶é‡Œçš„æ‰€æœ‰å†…å®¹ï¼Œæ”¾åˆ°includeçš„åœ°æ–¹è€Œå·²ã€‚\næ‰“å¼€ ae_evport.c ae_epoll.c ae_kqueue.c ae_select.c è¿™å››ä¸ªæ–‡ä»¶æ¥çœ‹ï¼Œå¯¹å¤–æš´éœ²çš„å‡½æ•°æ¥å£éƒ½æ˜¯ä¸€æ ·çš„ã€‚åªæ˜¯åœ¨ä¸åŒçš„å¹³å°ä¸Šå†…éƒ¨çš„å¤„ç†ä¸åŒã€‚\nå¯¹å¤–æš´éœ²äº†è¿™äº›å‡½æ•°ï¼Œæ¥å®Œæˆç½‘ç»œçš„å¤„ç†\n1//åˆ›å»ºä¸€ä¸ªloop 2static int aeApiCreate(aeEventLoop *eventLoop) 3//è®¾ç½®loopçš„å¤§å° 4static int aeApiResize(aeEventLoop *eventLoop, int setsize) 5//é‡Šæ”¾ä¸€ä¸ª loop 6static void aeApiFree(aeEventLoop *eventLoop) 7//æ·»åŠ ä¸€ä¸ª eventLoop 8static int aeApiAddEvent(aeEventLoop *eventLoop, int fd, int mask) 9//åˆ é™¤ä¸€ä¸ª eventLoop 10static void aeApiDelEvent(aeEventLoop *eventLoop, int fd, int delmask) 11//ä¸åŒçš„ç½‘ç»œå¤„ç†ä¸­,è¿”å›éœ€è¦å¤„ç†çš„äº‹ä»¶ 12static int aeApiPoll(aeEventLoop *eventLoop, struct timeval *tvp) 13//è¿”å›è¿™ä¸ªaeçš„åå­—,åœ¨epollä¸­å°±æ˜¯è¿”å› \u0026#34;epoll\u0026#34; 14static char *aeApiName(void) è¿™é‡Œæˆ‘ä»¬ä»¥Linuxå¹³å°ä¸ºä¸»ï¼Œæ‰€ä»¥ä½¿ç”¨çš„æ˜¯ ae_epoll.cæ–‡ä»¶ä¸­çš„å†…å®¹ã€‚è¿™é‡Œå…ˆä¸å±•å¼€åˆ†ææ¯ä¸€ä¸ªå‡½æ•°ï¼Œå› ä¸ºè¿™ä¸æ˜¯æœ¬æ¬¡çš„é‡ç‚¹ã€‚\nå¯åŠ¨ç½‘ç»œæœåŠ¡ åŸºæœ¬çš„æ•°æ®ç»“æ„ä»‹ç»å®Œï¼Œä¸‹é¢å¼€å§‹å¯åŠ¨ç½‘ç»œæœåŠ¡\nç›‘å¬client ç¬¬ä¸€æ­¥æ˜¯è°ƒç”¨ aeEventLoop *aeCreateEventLoop(int setsize) å‡½æ•°ï¼Œåˆ›å»º aeEventLoop è¿™ä¸ªå¯¹è±¡ã€‚\n1aeEventLoop *aeCreateEventLoop(int setsize) { 2 aeEventLoop *eventLoop; 3 int i; 4 5 monotonicInit(); /* just in case the calling app didn\u0026#39;t initialize */ 6 7 if ((eventLoop = zmalloc(sizeof(*eventLoop))) == NULL) goto err; 8 eventLoop-\u0026gt;events = zmalloc(sizeof(aeFileEvent)*setsize); 9 eventLoop-\u0026gt;fired = zmalloc(sizeof(aeFiredEvent)*setsize); 10 if (eventLoop-\u0026gt;events == NULL || eventLoop-\u0026gt;fired == NULL) goto err; 11 eventLoop-\u0026gt;setsize = setsize; 12 eventLoop-\u0026gt;timeEventHead = NULL; 13 eventLoop-\u0026gt;timeEventNextId = 0; 14 eventLoop-\u0026gt;stop = 0; 15 eventLoop-\u0026gt;maxfd = -1; 16 eventLoop-\u0026gt;beforesleep = NULL; 17 eventLoop-\u0026gt;aftersleep = NULL; 18 eventLoop-\u0026gt;flags = 0; 19 if (aeApiCreate(eventLoop) == -1) goto err; 20 /* Events with mask == AE_NONE are not set. So let\u0026#39;s initialize the 21 * vector with it. */ 22 for (i = 0; i \u0026lt; setsize; i++) 23 eventLoop-\u0026gt;events[i].mask = AE_NONE; 24 return eventLoop; 25 26err: 27 if (eventLoop) { 28 zfree(eventLoop-\u0026gt;events); 29 zfree(eventLoop-\u0026gt;fired); 30 zfree(eventLoop); 31 } 32 return NULL; 33} è¿™é‡Œçš„å¤„ç†é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯åˆå§‹åŒ– aeEventLoop ä¸­çš„æ•°æ®ç»“æ„ã€‚å¦‚æœä¸­é—´å‡ºé”™äº†ï¼Œå°±è¿”å› NULL\nè¿™ä¸ªåœ¨ void initServer(void) å‡½æ•°ä¸­è¢«è°ƒç”¨ã€‚ aeCreateEventLoop\nåˆ›å»ºä¸€ä¸ªaeEventLoop å¹¶èµ‹å€¼ç»™ serverã€‚å†å¾€ä¸Šç¿»ï¼Œæœ€ç»ˆçš„è°ƒç”¨ä½ç½®æ˜¯ main å‡½æ•°ä¸­çš„initServer();\nåœ¨å¾€ä¸‹ï¼Œè¿˜æœ‰ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„å‡½æ•°ï¼Œé€šè¿‡è°ƒç”¨ aeCreateTimeEvent å‡½æ•°ï¼Œå®Œæˆå®šæ—¶å™¨ å¯¹åº”çš„ eventLoop çš„åˆ›å»ºã€‚\n1long long aeCreateTimeEvent(aeEventLoop *eventLoop, long long milliseconds, 2 aeTimeProc *proc, void *clientData, 3 aeEventFinalizerProc *finalizerProc) 4{ 5 long long id = eventLoop-\u0026gt;timeEventNextId++; 6 aeTimeEvent *te; 7 8 te = zmalloc(sizeof(*te)); 9 if (te == NULL) return AE_ERR; 10 te-\u0026gt;id = id; 11 te-\u0026gt;when = getMonotonicUs() + milliseconds * 1000; 12 te-\u0026gt;timeProc = proc; 13 te-\u0026gt;finalizerProc = finalizerProc; 14 te-\u0026gt;clientData = clientData; 15 te-\u0026gt;prev = NULL; 16 te-\u0026gt;next = eventLoop-\u0026gt;timeEventHead; 17 te-\u0026gt;refcount = 0; 18 if (te-\u0026gt;next) 19 te-\u0026gt;next-\u0026gt;prev = te; 20 eventLoop-\u0026gt;timeEventHead = te; 21 return id; 22} éƒ½æ˜¯å¸¸è§„çš„å¤„ç†ï¼Œæ³¨æ„ä¸€ä¸‹ä¼ é€’è¿›æ¥çš„å‡ ä¸ªå‚æ•°\neventLoop æ˜¯ä¹‹å‰åˆ›å»ºçš„ eventLoopå¯¹è±¡ proc æ˜¯å®šæ—¶å™¨è§¦å‘æ—¶çš„å›è°ƒå‡½æ•° milliseconds å®šæ—¶å™¨è§¦å‘çš„æ—¶é—´é—´éš” proc å‡½æ•°çš„å®šä¹‰\nè¿™é‡Œä¸è¯¦ç»†å±•å¼€äº†ï¼Œå°±æ˜¯redisä¸­çš„ä¸€äº›å®šæ—¶æ“ä½œã€‚\nåœ¨ main å‡½æ•°ä¸­ç»§ç»­å¾€ä¸‹ï¼Œä¼šçœ‹åˆ° initListeners(); è¿™ä¸ªå‡½æ•°ï¼Œä¸­è¿™é‡Œä¹Ÿèƒ½çŸ¥é“ï¼Œè¿™é‡Œåˆ›å»º ç½‘ç»œçš„ç›‘å¬\n1void initListeners(void) { 2 /* Setup listeners from server config for TCP/TLS/Unix */ 3 int conn_index; 4 connListener *listener; 5 //åˆ¤æ–­æ˜¯å¦éœ€è¦ç›‘å¬æ™®é€šçš„TCP 6 if (server.port != 0) { 7 conn_index = connectionIndexByType(CONN_TYPE_SOCKET); 8 if (conn_index \u0026lt; 0) 9 serverPanic(\u0026#34;Failed finding connection listener of %s\u0026#34;, CONN_TYPE_SOCKET); 10 listener = \u0026amp;server.listeners[conn_index]; 11 listener-\u0026gt;bindaddr = server.bindaddr; 12 listener-\u0026gt;bindaddr_count = server.bindaddr_count; 13 listener-\u0026gt;port = server.port; 14 listener-\u0026gt;ct = connectionByType(CONN_TYPE_SOCKET); 15 } 16 //åˆ¤æ–­æ˜¯å¦éœ€è¦ç›‘å¬,å¦‚æœéœ€è¦,æ£€æŸ¥tlséœ€è¦çš„é…ç½®æ˜¯å¦æ­£ç¡® 17 if (server.tls_port || server.tls_replication || server.tls_cluster) { 18 ConnectionType *ct_tls = connectionTypeTls(); 19 if (!ct_tls) { 20 serverLog(LL_WARNING, \u0026#34;Failed finding TLS support.\u0026#34;); 21 exit(1); 22 } 23 if (connTypeConfigure(ct_tls, \u0026amp;server.tls_ctx_config, 1) == C_ERR) { 24 serverLog(LL_WARNING, \u0026#34;Failed to configure TLS. Check logs for more info.\u0026#34;); 25 exit(1); 26 } 27 } 28 //åˆ¤æ–­æ˜¯å¦éœ€è¦ç›‘å¬ TLSçš„TCP 29 if (server.tls_port != 0) { 30 conn_index = connectionIndexByType(CONN_TYPE_TLS); 31 if (conn_index \u0026lt; 0) 32 serverPanic(\u0026#34;Failed finding connection listener of %s\u0026#34;, CONN_TYPE_TLS); 33 listener = \u0026amp;server.listeners[conn_index]; 34 listener-\u0026gt;bindaddr = server.bindaddr; 35 listener-\u0026gt;bindaddr_count = server.bindaddr_count; 36 listener-\u0026gt;port = server.tls_port; 37 listener-\u0026gt;ct = connectionByType(CONN_TYPE_TLS); 38 } 39 //åˆ¤æ–­æ˜¯å¦éœ€è¦unixsocket 40 if (server.unixsocket != NULL) { 41 conn_index = connectionIndexByType(CONN_TYPE_UNIX); 42 if (conn_index \u0026lt; 0) 43 serverPanic(\u0026#34;Failed finding connection listener of %s\u0026#34;, CONN_TYPE_UNIX); 44 listener = \u0026amp;server.listeners[conn_index]; 45 listener-\u0026gt;bindaddr = \u0026amp;server.unixsocket; 46 listener-\u0026gt;bindaddr_count = 1; 47 listener-\u0026gt;ct = connectionByType(CONN_TYPE_UNIX); 48 listener-\u0026gt;priv = \u0026amp;server.unixsocketperm; /* Unix socket specified */ 49 } 50 51 /* create all the configured listener, and add handler to start to accept */ 52 int listen_fds = 0; 53 for (int j = 0; j \u0026lt; CONN_TYPE_MAX; j++) { 54 listener = \u0026amp;server.listeners[j]; 55 if (listener-\u0026gt;ct == NULL) 56 continue; 57 58 if (connListen(listener) == C_ERR) { 59 serverLog(LL_WARNING, \u0026#34;Failed listening on port %u (%s), aborting.\u0026#34;, listener-\u0026gt;port, listener-\u0026gt;ct-\u0026gt;get_type(NULL)); 60 exit(1); 61 } 62 //åˆ›å»ºæ–°çš„è¿æ¥å¤„ç†äº‹ä»¶ 63 if (createSocketAcceptHandler(listener, connAcceptHandler(listener-\u0026gt;ct)) != C_OK) 64 serverPanic(\u0026#34;Unrecoverable error creating %s listener accept handler.\u0026#34;, listener-\u0026gt;ct-\u0026gt;get_type(NULL)); 65 66 listen_fds += listener-\u0026gt;count; 67 } 68 69 if (listen_fds == 0) { 70 serverLog(LL_WARNING, \u0026#34;Configured to not listen anywhere, exiting.\u0026#34;); 71 exit(1); 72 } 73} åœ¨è¿™ä¸ªå‡½æ•°é‡Œï¼Œæ ¹æ®é…ç½®æ–‡ä»¶ï¼Œå¼€å§‹ç›‘å¬å¯¹åº”çš„ç«¯å£æˆ–è€… unixsocktã€‚\nè¿™é‡Œå¼•å…¥äº† connListener connection ConnectionType è¿™ä¸‰ä¸ªç»“æ„\nconnListener æ˜¯å¯¹ç½‘ç»œç›‘å¬çš„å°è£… connection æ˜¯å¯¹ç½‘ç»œè¿æ¥çš„å°è£… ConnectionType å°è£…äº†æ“ä½œç½‘ç»œéœ€è¦çš„å‡½æ•° ConnectionType æœ‰ä¸‰ä¸ªä¸åŒçš„å®ç°ï¼Œåˆ†åˆ«æ˜¯:\nCT_Socket å¯¹åº”çš„TCP CT_Socket CT_Unix å¯¹åº”çš„æ˜¯ unix socket CT_Unix CT_TLS å¯¹åº”çš„ ä½¿ç”¨äº† TLSçš„TCP CT_TLS ConnectionType å®šä¹‰\nConnectionTypeå†…éƒ¨çš„å‡½æ•°è¿™é‡Œå°±ä¸å±•å¼€è¯¦ç»†ä»‹ç»äº†ã€‚\nåœ¨ initListeners ä¸­è°ƒç”¨äº† connListen å‡½æ•°ï¼Œæ¥å®Œæˆå¯¹ä¸åŒç½‘ç»œçš„ç›‘å¬ï¼Œè¿™é‡Œå®ç°ä¹ŸæŒºç®€å•çš„ï¼Œå°±æ˜¯è°ƒç”¨äº†ConnectionType ä¸­çš„ listen å‡½æ•°ï¼Œå®Œæˆäº†å¯¹ç«¯å£æˆ–è€…unixsocketçš„ç›‘å¬ã€‚\n1static inline int connListen(connListener *listener) { 2 return listener-\u0026gt;ct-\u0026gt;listen(listener); 3} ä»¥ socket ä¸ºä¾‹ï¼Œå¯¹åº”çš„listenå‡½æ•°å°±æ˜¯ connSocketListen å¯¹åº”çš„åˆå§‹åŒ–åœ¨è¿™é‡Œ.listen = connSocketListen\næœ€ç»ˆå®ç°å¯¹ç«¯å£ç›‘å¬çš„å‡½æ•°æ˜¯ listenToPort(connListener *sfd)\nè¯é¢˜æ”¶å›æ¥ï¼Œå›åˆ° initListeners å‡½æ•°ä¸­ è°ƒç”¨ connListen å‡½æ•°å®Œæˆç›‘å¬åï¼Œä¼šå†è°ƒç”¨createSocketAcceptHandler å‡½æ•° å®Œæˆç½‘ç»œçš„ Accept å¤„ç†é€»è¾‘ã€‚\n1int createSocketAcceptHandler(connListener *sfd, aeFileProc *accept_handler) { 2 int j; 3 4 for (j = 0; j \u0026lt; sfd-\u0026gt;count; j++) { 5 if (aeCreateFileEvent(server.el, sfd-\u0026gt;fd[j], AE_READABLE, accept_handler,sfd) == AE_ERR) { 6 /* Rollback */ 7 for (j = j-1; j \u0026gt;= 0; j--) aeDeleteFileEvent(server.el, sfd-\u0026gt;fd[j], AE_READABLE); 8 return C_ERR; 9 } 10 } 11 return C_OK; 12} è¿™é‡Œé€»è¾‘ä¹ŸæŒºç®€å•ï¼Œéå†ä¹‹å‰acceptçš„ fdï¼Œå°†fdåŠ å…¥åˆ° aeEventLoop ä¸­ï¼Œå¦‚æœå¤±è´¥äº†ï¼Œå°±å›æ»šæ‰€æœ‰æ•°æ®ï¼Œä¹Ÿå°±æ˜¯ä¸­ aeEventLoop ä¸­åˆ é™¤å¯¹åº”çš„äº‹ä»¶ã€‚\naeCreateFileEventçš„å®ç°\n1int aeCreateFileEvent(aeEventLoop *eventLoop, int fd, int mask, 2 aeFileProc *proc, void *clientData) 3{ 4 if (fd \u0026gt;= eventLoop-\u0026gt;setsize) { 5 errno = ERANGE; 6 return AE_ERR; 7 } 8 aeFileEvent *fe = \u0026amp;eventLoop-\u0026gt;events[fd]; 9 //è°ƒç”¨å¯¹åº”å¹³å°çš„ç³»ç»Ÿå‡½æ•°,æŠŠå¯¹åº”çš„äº‹ä»¶åŠ å…¥åˆ°æ“ä½œç³»ç»Ÿä¸­ 10 //æ¯”å¦‚åœ¨epollä¸­å°±æ˜¯è°ƒç”¨ epoll_ctl å‡½æ•°æŠŠ äº‹ä»¶åŠ å…¥ epollä¸­ 11 if (aeApiAddEvent(eventLoop, fd, mask) == -1) 12 return AE_ERR; 13 fe-\u0026gt;mask |= mask; 14 if (mask \u0026amp; AE_READABLE) fe-\u0026gt;rfileProc = proc; 15 if (mask \u0026amp; AE_WRITABLE) fe-\u0026gt;wfileProc = proc; 16 fe-\u0026gt;clientData = clientData; 17 if (fd \u0026gt; eventLoop-\u0026gt;maxfd) 18 eventLoop-\u0026gt;maxfd = fd; 19 return AE_OK; 20} ä¹Ÿæ˜¯å¸¸è§„çš„å¤„ç†é€»è¾‘ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„ä¸€ä¸‹ï¼Œä¼ é€’çš„å‡ ä¸ªå‚æ•°ã€‚\naeEventLoop å°±æ˜¯ä¹‹å‰é€šè¿‡ aeCreateEventLoop å‡½æ•°åˆ›å»ºçš„å¯¹è±¡ã€‚ fd æ˜¯å¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦ mask å¯¹åº”çš„è¿™ä¸ªevent éœ€è¦å¤„ç†çš„äº‹ä»¶ç±»å‹ï¼Œæ¯”å¦‚ è¯»ï¼Œå†™ç­‰ç­‰ proc è¿™ä¸ªæ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œå½“å¯¹åº”çš„äº‹ä»¶è§¦å‘æ—¶ï¼Œä½¿ç”¨è¿™ä¸ªå‡½æ•°æ¥å¤„ç†ã€‚æ¯”å¦‚è¿™é‡Œå°±æ˜¯å½“fdæœ‰è¯»å†™äº‹ä»¶è§¦å‘æ—¶ï¼Œå°±ä¼šè°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œä¹Ÿå°±æ˜¯å½“æœ‰æ–°çš„å®¢æˆ·ç«¯è¿æ¥æ—¶ï¼Œå°±é€šè¿‡è¿™ä¸ªå‡½æ•°æ¥å¤„ç† clientData æ˜¯è¿™ä¸ªeventçš„æ•°æ® è¿™é‡Œçš„ proc æ˜¯socket.cæ–‡ä»¶ä¸­çš„ connSocketAcceptHandler å‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°åé¢ç½‘ç»œè¯»å†™åœ¨åˆ†æã€‚åˆ°è¿™é‡Œï¼Œrediså¯¹clientçš„ç½‘ç»œç›‘å¬åŸºæœ¬å®Œæˆäº†ã€‚\nç›‘å¬cluster å¦‚æœrediså¼€å¯äº†é›†ç¾¤ï¼Œéœ€è¦å¯¹é›†ç¾¤ä¸­å…¶ä»–çš„redisåšç½‘ç»œç›‘å¬ï¼Œä¸å…¶ä»–çš„redisäº’è”\nå¼€å¯cluster\nåœ¨è¿™é‡Œè°ƒç”¨ clusterInitListeners å¼€å¯å¯¹ cluster çš„ç›‘å¬ã€‚\n1void clusterInitListeners(void) { 2 if (connectionIndexByType(connTypeOfCluster()-\u0026gt;get_type(NULL)) \u0026lt; 0) { 3 serverLog(LL_WARNING, \u0026#34;Missing connection type %s, but it is required for the Cluster bus.\u0026#34;, connTypeOfCluster()-\u0026gt;get_type(NULL)); 4 exit(1); 5 } 6 7 int port = defaultClientPort(); 8 connListener *listener = \u0026amp;server.clistener; 9 listener-\u0026gt;count = 0; 10 listener-\u0026gt;bindaddr = server.bindaddr; 11 listener-\u0026gt;bindaddr_count = server.bindaddr_count; 12 listener-\u0026gt;port = server.cluster_port ? server.cluster_port : port + CLUSTER_PORT_INCR; 13 listener-\u0026gt;ct = connTypeOfCluster(); 14 if (connListen(listener) == C_ERR ) { 15 /* Note: the following log text is matched by the test suite. */ 16 serverLog(LL_WARNING, \u0026#34;Failed listening on port %u (cluster), aborting.\u0026#34;, listener-\u0026gt;port); 17 exit(1); 18 } 19 20 if (createSocketAcceptHandler(\u0026amp;server.clistener, clusterAcceptHandler) != C_OK) { 21 serverPanic(\u0026#34;Unrecoverable error creating Redis Cluster socket accept handler.\u0026#34;); 22 } 23} è¿™é‡Œçš„é€»è¾‘å’Œclienté‚£éƒ¨åˆ†ç±»ä¼¼ï¼Œä¸åŒçš„åœ°æ–¹æ˜¯ aeFileEvent ä¸­çš„å›è°ƒå‡½æ•°å˜æˆäº† clusterAcceptHandler è¿™é‡Œä¸å±•å¼€äº†ã€‚\nç„¶åä¼šè°ƒç”¨ InitServerLast å‡½æ•°\nè¿™é‡Œæ³¨æ„å…³æ³¨ initThreadedIO è¿™ä¸ªå‡½æ•°\nredis åœ¨6.0 ç‰ˆæœ¬åŠ å…¥äº†å¤šçº¿ç¨‹æ”¯æŒï¼Œå…¶å®redisçš„å¤šçº¿ç¨‹åªæ˜¯åœ¨ ç½‘ç»œ I/O åŠ å…¥äº†å¤šçº¿ç¨‹å¤„ç†ï¼Œåœ¨å¤„ç†å‘½ä»¤æ—¶è¿˜æ˜¯å•çº¿ç¨‹ï¼Œè¿™é‡Œå°±æ˜¯åšäº†å¤šçº¿ç¨‹çš„å¤„ç†ã€‚\n1void initThreadedIO(void) { 2 server.io_threads_active = 0; /* We start with threads not active. */ 3 4 /* Indicate that io-threads are currently idle */ 5 io_threads_op = IO_THREADS_OP_IDLE; 6 7 //å¦‚æœå°±ä¸€ä¸ªçº¿ç¨‹ï¼Œä¹Ÿæ²¡å¿…è¦å¼€æ–°çš„çº¿ç¨‹äº† 8 if (server.io_threads_num == 1) return; 9 10 //åˆ¤æ–­ä¸€ä¸‹ï¼Œå¦‚æœçº¿ç¨‹å¤ªå¤šäº†ï¼Œå°±æç¤ºé”™è¯¯ï¼Œä¸èƒ½å¼€å¯å¤ªå¤šçº¿ç¨‹ 11 if (server.io_threads_num \u0026gt; IO_THREADS_MAX_NUM) { 12 serverLog(LL_WARNING,\u0026#34;Fatal: too many I/O threads configured. \u0026#34; 13 \u0026#34;The maximum number is %d.\u0026#34;, IO_THREADS_MAX_NUM); 14 exit(1); 15 } 16 17 /* Spawn and initialize the I/O threads. */ 18 for (int i = 0; i \u0026lt; server.io_threads_num; i++) { 19 /* Things we do for all the threads including the main thread. */ 20 io_threads_list[i] = listCreate(); 21 if (i == 0) continue; /* Thread 0 is the main thread. */ 22 23 /* Things we do only for the additional threads. */ 24 pthread_t tid; 25 pthread_mutex_init(\u0026amp;io_threads_mutex[i],NULL); 26 setIOPendingCount(i, 0); 27 pthread_mutex_lock(\u0026amp;io_threads_mutex[i]); /* Thread will be stopped. */ 28 if (pthread_create(\u0026amp;tid,NULL,IOThreadMain,(void*)(long)i) != 0) { 29 serverLog(LL_WARNING,\u0026#34;Fatal: Can\u0026#39;t initialize IO thread.\u0026#34;); 30 exit(1); 31 } 32 io_threads[i] = tid; 33 } 34} ä½¿ç”¨ pthread_create åˆ›å»ºçº¿ç¨‹çº¿ç¨‹ï¼ŒIOThreadMain æ˜¯å¯¹åº”çº¿ç¨‹çš„å¤„ç†å‡½æ•°ã€‚\nè¿™ä¸ªå‡½æ•°å…ˆä¸å±•å¼€ï¼Œç­‰åé¢å¤„ç†ç½‘ç»œè¯»å†™çš„æ—¶å€™ï¼Œä¼šæåˆ°ã€‚\nå›åˆ° main å‡½æ•°é‡Œï¼Œç»§ç»­å¾€ä¸‹èµ°ï¼Œæœ€åä¼šè°ƒç”¨ aeMain æ¥é˜»å¡å½“å‰çº¿ç¨‹ï¼Œç„¶åå¤„ç†ç½‘ç»œã€‚\n1void aeMain(aeEventLoop *eventLoop) { 2 eventLoop-\u0026gt;stop = 0; 3 while (!eventLoop-\u0026gt;stop) { 4 aeProcessEvents(eventLoop, AE_ALL_EVENTS| 5 AE_CALL_BEFORE_SLEEP| 6 AE_CALL_AFTER_SLEEP); 7 } 8} aeProcessEvents ä¸­å¤„ç†ä¹‹å‰ æ·»åŠ çš„ aeEvent äº‹ä»¶å›è°ƒ\n1int aeProcessEvents(aeEventLoop *eventLoop, int flags) 2{ 3 int processed = 0, numevents; 4 5 /* Nothing to do? return ASAP */ 6 if (!(flags \u0026amp; AE_TIME_EVENTS) \u0026amp;\u0026amp; !(flags \u0026amp; AE_FILE_EVENTS)) return 0; 7 8 if (eventLoop-\u0026gt;maxfd != -1 || 9 ((flags \u0026amp; AE_TIME_EVENTS) \u0026amp;\u0026amp; !(flags \u0026amp; AE_DONT_WAIT))) { 10 int j; 11 struct timeval tv, *tvp = NULL; /* NULL means infinite wait. */ 12 int64_t usUntilTimer; 13 //æ£€æŸ¥beforesleepå‡½æ•°æŒ‡é’ˆ,å¦‚æœæœ‰å¯¹åº”çš„å‡½æ•°,è°ƒç”¨è¿™ä¸ªå‡½æ•° 14 if (eventLoop-\u0026gt;beforesleep != NULL \u0026amp;\u0026amp; (flags \u0026amp; AE_CALL_BEFORE_SLEEP)) 15 eventLoop-\u0026gt;beforesleep(eventLoop); 16 17 if ((flags \u0026amp; AE_DONT_WAIT) || (eventLoop-\u0026gt;flags \u0026amp; AE_DONT_WAIT)) { 18 tv.tv_sec = tv.tv_usec = 0; 19 tvp = \u0026amp;tv; 20 } else if (flags \u0026amp; AE_TIME_EVENTS) { 21 usUntilTimer = usUntilEarliestTimer(eventLoop); 22 if (usUntilTimer \u0026gt;= 0) { 23 tv.tv_sec = usUntilTimer / 1000000; 24 tv.tv_usec = usUntilTimer % 1000000; 25 tvp = \u0026amp;tv; 26 } 27 } 28 29 numevents = aeApiPoll(eventLoop, tvp); 30 31 /* Don\u0026#39;t process file events if not requested. */ 32 if (!(flags \u0026amp; AE_FILE_EVENTS)) { 33 numevents = 0; 34 } 35 36 //æ£€æŸ¥aftersleepå‡½æ•°æŒ‡é’ˆ,å¦‚æœæœ‰å¯¹åº”çš„å‡½æ•°,è°ƒç”¨è¿™ä¸ªå‡½æ•° 37 if (eventLoop-\u0026gt;aftersleep != NULL \u0026amp;\u0026amp; flags \u0026amp; AE_CALL_AFTER_SLEEP) 38 eventLoop-\u0026gt;aftersleep(eventLoop); 39 //æ£€æŸ¥å°±ç»ªçš„äº‹ä»¶,ç„¶ååšå¯¹åº”çš„å¤„ç† 40 for (j = 0; j \u0026lt; numevents; j++) { 41 int fd = eventLoop-\u0026gt;fired[j].fd; 42 aeFileEvent *fe = \u0026amp;eventLoop-\u0026gt;events[fd]; 43 int mask = eventLoop-\u0026gt;fired[j].mask; 44 int fired = 0; /* Number of events fired for current fd. */ 45 46 int invert = fe-\u0026gt;mask \u0026amp; AE_BARRIER; 47 //éœ€è¦ç¿»è½¬çš„è¯,å…ˆå¤„ç†è¯»çš„å›è°ƒå‡½æ•° 48 if (!invert \u0026amp;\u0026amp; fe-\u0026gt;mask \u0026amp; mask \u0026amp; AE_READABLE) { 49 fe-\u0026gt;rfileProc(eventLoop,fd,fe-\u0026gt;clientData,mask); 50 fired++; 51 fe = \u0026amp;eventLoop-\u0026gt;events[fd]; /* Refresh in case of resize. */ 52 } 53 54 //å¦‚æœæœ‰å†™äº‹ä»¶,åšå›è°ƒ 55 if (fe-\u0026gt;mask \u0026amp; mask \u0026amp; AE_WRITABLE) { 56 if (!fired || fe-\u0026gt;wfileProc != fe-\u0026gt;rfileProc) { 57 fe-\u0026gt;wfileProc(eventLoop,fd,fe-\u0026gt;clientData,mask); 58 fired++; 59 } 60 } 61 62 if (invert) {//å¦‚æœä¹‹å‰æ²¡æœ‰å¤„ç†è¯»äº‹ä»¶ 63 fe = \u0026amp;eventLoop-\u0026gt;events[fd]; /* Refresh in case of resize. */ 64 if ((fe-\u0026gt;mask \u0026amp; mask \u0026amp; AE_READABLE) \u0026amp;\u0026amp; 65 (!fired || fe-\u0026gt;wfileProc != fe-\u0026gt;rfileProc)) 66 {//è¯»å›è°ƒå‡½æ•°æŒ‡é’ˆå’Œå†™å›è°ƒå‡½æ•°æŒ‡é’ˆä¸æ˜¯åŒä¸€ä¸ª, å¹¶ä¸”æœ‰è¯»äº‹ä»¶,å›è°ƒè¯»å‡½æ•° 67 fe-\u0026gt;rfileProc(eventLoop,fd,fe-\u0026gt;clientData,mask); 68 fired++; 69 } 70 } 71 72 processed++; 73 } 74 } 75 //å¦‚æœæœ‰æ—¶é—´å›è°ƒäº‹ä»¶,å›è°ƒæ—¶é—´çš„å›è°ƒå‡½æ•° 76 if (flags \u0026amp; AE_TIME_EVENTS) 77 processed += processTimeEvents(eventLoop); 78 79 return processed; /* return the number of processed file/time events */ 80} beforeSleep å‡½æ•°\nafterSleep å‡½æ•°\nè¿™ä¸¤ä¸ªå‡½æ•°å†…å®¹éå¸¸å¤šï¼Œå¾ˆå¤šå’Œç½‘ç»œæ˜¯æ— å…³çš„ï¼Œä¸å±•å¼€åˆ†æï¼Œåé¢æœ‰ç”¨çš„å†å›æ¥ä»‹ç»ã€‚\naeApiPoll å‡½æ•°åœ¨ä¸åŒçš„å¹³å°ä¸Šæœ‰ä¸åŒçš„å®ç°ï¼Œæœ€ç»ˆçš„ç›®çš„æ˜¯ç­‰å¾…ç³»ç»Ÿçš„å›è°ƒäº‹ä»¶ã€‚åœ¨ epoll ä¸­æ˜¯ç­‰å¾… epoll_wait çš„å›è°ƒã€‚\nç®€å•ç”»å›¾ç†è§£ä¸€ä¸‹\nå¦‚å›¾æ‰€ç¤ºï¼Œredisè™½ç„¶å¼€å¯äº†å¤šçº¿ç¨‹ï¼Œä½†æ˜¯æ¯ä¸ªè¿æ¥è¿˜æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­ï¼Œè€Œä¸”å¤„ç†å‘½ä»¤ä¹Ÿæ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­ã€‚\né‚£ä¹ˆåœ¨ä»€ä¹ˆæ—¶å€™ç”¨åˆ°å¤šçº¿ç¨‹ï¼Œä»¥åŠæ€æ ·ä½¿ç”¨å‘¢ã€‚\nåœ¨ä¸Šé¢çš„ä»£ç ä¸­ä¹Ÿæåˆ°äº†ï¼Œå°±æ˜¯åœ¨ç½‘ç»œIOä¸­ä¼šç”¨åˆ°å¤šçº¿ç¨‹ã€‚\nå¦‚å›¾ï¼š\næ‹¿ä»ç½‘ç»œä¸­è¯»å–æ•°æ®æ¥ä¸¾ä¾‹ï¼Œå½“å›¾ä¸­çš„ client1 client2 client3 åŒæ—¶æœ‰æ•°æ®éœ€è¦è¯»å–çš„æ—¶å€™ï¼Œè¿™æ—¶å€™ä¼šæŠŠè¿™ä¸‰ä¸ª clientçš„ fd åˆ†é…åˆ°ç©ºé—²çš„çº¿ç¨‹ä¸­ï¼Œç”±ä¸åŒçš„çº¿ç¨‹æ¥è¯»å–æ•°æ®ï¼ŒæŠŠè¯»åˆ°çš„æ•°æ®å†™å…¥ client çš„ buffä¸­ã€‚å½“æ‰€æœ‰çš„ fd è¯»å–å®Œæˆåï¼Œ ç„¶ååœ¨çº¿ç¨‹ä¸­ï¼Œä¾æ¬¡å¤„ç†æ¯ä¸ªclientã€‚å…·ä½“ä»£ç åœ¨ä¸‹æ–‡ä¸­ã€‚\nç½‘ç»œè¯»å†™å¤„ç† Listener å›è°ƒ ä¹‹å‰åœ¨æ·»åŠ  listener çš„æ—¶å€™ï¼Œæ·»åŠ çš„æ˜¯ AE_READABLE äº‹ä»¶ï¼Œ aeCreateFileEvent(server.el, sfd-\u0026gt;fd[j], AE_READABLE, accept_handler,sfd)\næ‰€ä»¥ï¼Œaccept çš„å›è°ƒä¼šåœ¨ å¯è¯»çš„å›è°ƒå‡½æ•°ä¸­ã€‚\naccept_handleræŒ‡é’ˆæ˜¯ connSocketAcceptHandler å‡½æ•°\n1static void connSocketAcceptHandler(aeEventLoop *el, int fd, void *privdata, int mask) { 2 int cport, cfd, max = MAX_ACCEPTS_PER_CALL; 3 char cip[NET_IP_STR_LEN]; 4 UNUSED(el); 5 UNUSED(mask); 6 UNUSED(privdata); 7 8 while(max--) { 9 //æŠŠå½“å‰çš„ accept çš„ fd è½¬æ¢æˆä¸€ä¸ªTCPè¿æ¥ 10 cfd = anetTcpAccept(server.neterr, fd, cip, sizeof(cip), \u0026amp;cport); 11 if (cfd == ANET_ERR) { 12 if (errno != EWOULDBLOCK) 13 serverLog(LL_WARNING, 14 \u0026#34;Accepting client connection: %s\u0026#34;, server.neterr); 15 return; 16 } 17 serverLog(LL_VERBOSE,\u0026#34;Accepted %s:%d\u0026#34;, cip, cport); 18 acceptCommonHandler(connCreateAcceptedSocket(cfd, NULL),0,cip); 19 } 20} åœ¨ anetTcpAccept ä¸­ è°ƒç”¨ anetGenericAccept å‡½æ•°ï¼Œ åœ¨å‡½æ•°ä¸­\n1#ifdef HAVE_ACCEPT4 2 fd = accept4(s, sa, len, SOCK_NONBLOCK | SOCK_CLOEXEC); 3#else 4 fd = accept(s,sa,len); 5#endif æœ€ç»ˆé€šè¿‡ accept4 æˆ–è€… accept ç³»ç»Ÿè°ƒç”¨ï¼Œæ¥å—ä¸€ä¸ªæ–°çš„TCPé“¾æ¥ã€‚\næœ€åè°ƒç”¨ acceptCommonHandler å‡½æ•°, è¿™ä¸ªå‡½æ•°é‡Œä¼šè°ƒç”¨ createClient(conn) æ¥åˆ›å»ºä¸€ä¸ª client\nåœ¨ createClient ä¸­ï¼Œå…³æ³¨è¿™æ®µå‡½æ•°\n1 client *c = zmalloc(sizeof(client)); 2 if (conn) { 3 connEnableTcpNoDelay(conn); 4 if (server.tcpkeepalive) 5 connKeepAlive(conn,server.tcpkeepalive); 6 //æŠŠå½“å‰çš„connåŠ å…¥åˆ° eventPoolä¸­,å¹¶ä¸”æŠŠ readQueryFromClient è®¾ç½®ä¸ºå›è°ƒå‡½æ•° 7 connSetReadHandler(conn, readQueryFromClient); 8 connSetPrivateData(conn, c); 9 } 10 //åˆå§‹åŒ–clientçš„buffer 11 c-\u0026gt;buf = zmalloc_usable(PROTO_REPLY_CHUNK_BYTES, \u0026amp;c-\u0026gt;buf_usable_size); 12 selectDb(c,0); 13 uint64_t client_id; connEnableTcpNoDelay æœ€ç»ˆä¼šè°ƒç”¨ anet.cä¸­çš„ anetSetTcpNoDelay å‡½æ•°ï¼Œæ¥å®Œæˆå¯¹TCPè¿æ¥çš„è®¾ç½®ã€‚\nconnKeepAlive æœ€ç»ˆè°ƒç”¨åˆ° anet.cä¸­çš„ anetKeepAlive å¯¹ KeepAlive çš„è®¾ç½®\nconnSetReadHandler é€šè¿‡è¿™ä¸ªå‡½æ•°ï¼Œå®ŒæˆæŠŠ è¯¥TCPè¿æ¥çš„ fd åŠ å…¥çš„ eventLoop ä¸­è¿›è¡Œç®¡ç†ã€‚\n1static inline int connSetReadHandler(connection *conn, ConnectionCallbackFunc func) { 2 return conn-\u0026gt;type-\u0026gt;set_read_handler(conn, func); 3} é€šè¿‡ set_read_handler è¿™ä¸ªå‡½æ•°æŒ‡é’ˆè°ƒç”¨åˆ° socket.c ä¸­çš„ connSocketSetReadHandler å‡½æ•°\n1static int connSocketSetReadHandler(connection *conn, ConnectionCallbackFunc func) { 2 if (func == conn-\u0026gt;read_handler) return C_OK; 3 4 conn-\u0026gt;read_handler = func; 5 if (!conn-\u0026gt;read_handler) 6 aeDeleteFileEvent(server.el,conn-\u0026gt;fd,AE_READABLE); 7 else 8 if (aeCreateFileEvent(server.el,conn-\u0026gt;fd, 9 AE_READABLE,conn-\u0026gt;type-\u0026gt;ae_handler,conn) == AE_ERR) return C_ERR; 10 return C_OK; 11} è°ƒç”¨ aeCreateFileEvent æŠŠå½“å‰çš„ conn åŠ å…¥åˆ° server.el ä¹Ÿå°±æ˜¯å¯åŠ¨redisæ—¶ï¼Œåˆ›å»ºçš„ aeEventPool ä¸­ã€‚\nå›åˆ° createClient å‡½æ•°ä¸­ï¼ŒconnSetReadHandler(conn, readQueryFromClient); ç¬¬äºŒå‚æ•°ä¼ é€’çš„æ˜¯ readQueryFromClient è¿™ä¸ªå‡½æ•°çš„æŒ‡é’ˆã€‚è¿™ä¸ªå‡½æ•° ä¼šèµ‹å€¼ç»™ aeFileEvent çš„ rfileProc å‡½æ•°æŒ‡é’ˆä¸­ã€‚åç»­ï¼Œå¦‚æœè¿™ä¸ª conn æœ‰å¯è¯»äº‹ä»¶å›è°ƒæ—¶ï¼Œä¼šä½¿ç”¨ readQueryFromClient è¿™ä¸ªå‡½æ•°æ¥å¤„ç†ã€‚\nåˆ°è¿™é‡Œï¼Œä¸€ä¸ªæ–°TCPè¿æ¥çš„å¤„ç†åŸºæœ¬å°±å®Œæˆäº†ã€‚\nå¤„ç†clientè¯»å†™ è¯»å¤„ç† å½“redis-server æ”¶åˆ°clientå‘æ¥çš„æ•°æ®åï¼Œä¹Ÿæ˜¯é€šè¿‡ aeEventPool æ¥å›è°ƒé€šçŸ¥å¯¹åº”çš„ clientæ¥å¤„ç†ã€‚\nä¸Šé¢æˆ‘ä»¬è¯´è¿‡äº†ï¼Œclientæ”¶åˆ°è¯»äº‹ä»¶çš„å›è°ƒå‡½æ•°æ˜¯ readQueryFromClientï¼Œå½“clientå¯¹åº”çš„ç½‘ç»œæœ‰å¯è¯»äº‹ä»¶è§¦å‘æ—¶ï¼Œä¼šå›è°ƒè¿™ä¸ªå‡½æ•°ã€‚\n1void readQueryFromClient(connection *conn) { 2 client *c = connGetPrivateData(conn); 3 int nread, big_arg = 0; 4 size_t qblen, readlen; 5 //åˆ¤æ–­ä¸€ä¸‹,æ˜¯å¦å¼€å¯äº†IOçº¿ç¨‹,å¦‚æœå¼€å¯äº†é‚£ä¹ˆä¼šä»IOçº¿ç¨‹è¯»å–æ•°æ® 6 if (postponeClientRead(c)) return; 7 8 //è¯»å–æ¬¡æ•° åŸå­æ€§çš„ +1 9 atomicIncr(server.stat_total_reads_processed, 1); 10 11 readlen = PROTO_IOBUF_LEN; 12 //å¦‚æœæ˜¯ä¸€ä¸ªmultiè¯·æ±‚,é‚£ä¹ˆè°ƒæ•´ä¸€ä¸‹ç¼“å†²åŒºçš„å¤§å° 13 if (c-\u0026gt;reqtype == PROTO_REQ_MULTIBULK \u0026amp;\u0026amp; c-\u0026gt;multibulklen \u0026amp;\u0026amp; c-\u0026gt;bulklen != -1 14 \u0026amp;\u0026amp; c-\u0026gt;bulklen \u0026gt;= PROTO_MBULK_BIG_ARG) 15 { 16 ssize_t remaining = (size_t)(c-\u0026gt;bulklen+2)-(sdslen(c-\u0026gt;querybuf)-c-\u0026gt;qb_pos); 17 big_arg = 1; 18 19 if (remaining \u0026gt; 0) readlen = remaining; 20 21 if (c-\u0026gt;flags \u0026amp; CLIENT_MASTER \u0026amp;\u0026amp; readlen \u0026lt; PROTO_IOBUF_LEN) 22 readlen = PROTO_IOBUF_LEN; 23 } 24 25 qblen = sdslen(c-\u0026gt;querybuf); 26 if (!(c-\u0026gt;flags \u0026amp; CLIENT_MASTER) \u0026amp;\u0026amp; 27 (big_arg || sdsalloc(c-\u0026gt;querybuf) \u0026lt; PROTO_IOBUF_LEN)) { 28 c-\u0026gt;querybuf = sdsMakeRoomForNonGreedy(c-\u0026gt;querybuf, readlen); 29 if (c-\u0026gt;querybuf_peak \u0026lt; qblen + readlen) c-\u0026gt;querybuf_peak = qblen + readlen; 30 } else { 31 c-\u0026gt;querybuf = sdsMakeRoomFor(c-\u0026gt;querybuf, readlen); 32 33 readlen = sdsavail(c-\u0026gt;querybuf); 34 } 35 36 //ä»ç½‘ç»œä¸­è¯»å–æ•°æ®,å¦‚æœæ˜¯ socket,ä½¿ç”¨ connSocketRead å‡½æ•° 37 nread = connRead(c-\u0026gt;conn, c-\u0026gt;querybuf+qblen, readlen); 38 if (nread == -1) { 39 if (connGetState(conn) == CONN_STATE_CONNECTED) { 40 return; 41 } else { 42 serverLog(LL_VERBOSE, \u0026#34;Reading from client: %s\u0026#34;,connGetLastError(c-\u0026gt;conn)); 43 freeClientAsync(c); 44 goto done; 45 } 46 } else if (nread == 0) { 47 if (server.verbosity \u0026lt;= LL_VERBOSE) { 48 sds info = catClientInfoString(sdsempty(), c); 49 serverLog(LL_VERBOSE, \u0026#34;Client closed connection %s\u0026#34;, info); 50 sdsfree(info); 51 } 52 freeClientAsync(c); 53 goto done; 54 } 55 56 sdsIncrLen(c-\u0026gt;querybuf,nread); 57 qblen = sdslen(c-\u0026gt;querybuf); 58 if (c-\u0026gt;querybuf_peak \u0026lt; qblen) c-\u0026gt;querybuf_peak = qblen; 59 60 c-\u0026gt;lastinteraction = server.unixtime; 61 if (c-\u0026gt;flags \u0026amp; CLIENT_MASTER) { 62 c-\u0026gt;read_reploff += nread; 63 atomicIncr(server.stat_net_repl_input_bytes, nread); 64 } else { 65 atomicIncr(server.stat_net_input_bytes, nread); 66 } 67 68 if (!(c-\u0026gt;flags \u0026amp; CLIENT_MASTER) \u0026amp;\u0026amp; sdslen(c-\u0026gt;querybuf) \u0026gt; server.client_max_querybuf_len) { 69 sds ci = catClientInfoString(sdsempty(),c), bytes = sdsempty(); 70 71 bytes = sdscatrepr(bytes,c-\u0026gt;querybuf,64); 72 serverLog(LL_WARNING,\u0026#34;Closing client that reached max query buffer length: %s (qbuf initial bytes: %s)\u0026#34;, ci, bytes); 73 sdsfree(ci); 74 sdsfree(bytes); 75 freeClientAsync(c); 76 goto done; 77 } 78 //å¤„ç†è¯»åˆ°çš„æ•°æ®,å°è¯•è§£æRESPåè®® 79 if (processInputBuffer(c) == C_ERR) 80 c = NULL; 81 82done: 83 beforeNextClient(c); 84} åœ¨è¿™ä¸ªå‡½æ•°ä¸­åˆ¤æ–­æ˜¯å¦éœ€è¦ä½¿ç”¨å¤šçº¿ç¨‹ã€‚\n1int postponeClientRead(client *c) { 2 //åœ¨è¿™é‡Œåˆ¤æ–­æ˜¯å¦éœ€è¦ä½¿ç”¨å¤šçº¿ç¨‹ä»ç½‘ç»œè¯»å–æ•°æ® 3 if (server.io_threads_active \u0026amp;\u0026amp; 4 server.io_threads_do_reads \u0026amp;\u0026amp; 5 !ProcessingEventsWhileBlocked \u0026amp;\u0026amp; 6 !(c-\u0026gt;flags \u0026amp; (CLIENT_MASTER|CLIENT_SLAVE|CLIENT_BLOCKED)) \u0026amp;\u0026amp; 7 io_threads_op == IO_THREADS_OP_IDLE) 8 { 9 //å¦‚æœéœ€è¦å¤šçº¿ç¨‹è¯»å–,æŠŠå½“å‰clientåŠ å…¥åˆ°`clients_pending_read`ä¸­,ç­‰å¾…åç»­è°ƒç”¨ 10 listAddNodeHead(server.clients_pending_read,c); 11 c-\u0026gt;pending_read_list_node = listFirst(server.clients_pending_read); 12 return 1; 13 } else { 14 return 0; 15 } 16} åœ¨é…ç½®æ–‡ä»¶ä¸­\nio-threads IOçº¿ç¨‹æ•°é‡,é»˜è®¤åªæœ‰ä¸€ä¸ªï¼Œä¹Ÿå°±æ˜¯ä¸ç”¨å¤šçº¿ç¨‹è¯»å†™ç½‘ç»œ io-threads-do-reads æ˜¯å¦å¼€å¯å¤šçº¿ç¨‹è¯»å’Œè§£æRESPåŠŸèƒ½ï¼Œå¦‚æœä¸å¼€å¯ï¼Œé‚£ä¹ˆå¤šçº¿ç¨‹åªä¼šå¤„ç†å†™ å¦‚æœåªæœ‰ä¸€ä¸ªclientå°±ç»ªï¼ˆä¹Ÿå°±æ˜¯æ²¡æœ‰å¹¶å‘è¯·æ±‚ï¼‰æ—¶ï¼Œå³ä½¿å¼€äº†å¤šçº¿ç¨‹å’ŒIOçº¿ç¨‹è¯»ï¼Œä¹Ÿä¸ä¼šä½¿ç”¨å¤šçº¿ç¨‹å»è¯»ç½‘ç»œï¼Œåªæœ‰å½“å¤šä¸ªclientåŒæ—¶è¯»å†™æ•°æ®ï¼Œè¿™æ—¶å€™ä¼šåœ¨ handleClientsWithPendingReadsUsingThreads ä¸­å¼€å¯ å¤šçº¿ç¨‹å¤„ç†ã€‚\nå¼€å¯å¤šçº¿ç¨‹è¯»å†™\n1if (!server.io_threads_active) startThreadedIO(); æ­¤æ—¶ï¼Œå½“clientè¯»äº‹ä»¶å°±ç»ªåï¼Œå†æ¬¡å›è°ƒ readQueryFromClient å‡½æ•°åï¼Œä¼šè¿›å…¥ listAddNodeHead(server.clients_pending_read,c); åŠ å…¥é“¾è¡¨ï¼Œç­‰å¾…IOçº¿ç¨‹å¤„ç†\nå¦‚æœéœ€è¦å¤šçº¿ç¨‹\nåœ¨ä¸»çº¿ç¨‹é‡Œè°ƒç”¨ ä½¿ç”¨ aeEventPool çš„ beforesleep å‡½æ•°æŒ‡é’ˆè°ƒç”¨ beforeSleep å‡½æ•°æ¥æ‰§è¡Œ sleepå‰çš„å¤„ç†å‡½æ•°ï¼Œç„¶ååœ¨è°ƒç”¨ handleClientsWithPendingReadsUsingThreads å‡½æ•°æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦ä½¿ç”¨å¤šçº¿ç¨‹æ¥è¯»æ•°æ®ã€‚\næœ€åçš„è¯»å–æ˜¯ç”± readQueryFromClient å‡½æ•°æ¥å®Œæˆæ•°æ®çš„è¯»å–ã€‚\nreadQueryFromClient å‡½æ•°å¯ä»¥é€šè¿‡ handleClientsWithPendingReadsUsingThreads å‡½æ•°åœ¨ä¸»çº¿ç¨‹è°ƒç”¨ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ IOThreadMain å‡½æ•°é€šè¿‡IOçº¿ç¨‹å¹¶å‘è¯»å–ã€‚\n1//å¯åŠ¨IOå¤šçº¿ç¨‹è¯»å–æ•°æ® 2io_threads_op = IO_THREADS_OP_READ; 3for (int j = 1; j \u0026lt; server.io_threads_num; j++) { 4 int count = listLength(io_threads_list[j]); 5 setIOPendingCount(j, count); 6} 7....... 8//ç­‰å¾…IOçº¿ç¨‹è¯»å–å®Œæˆ 9while(1) { 10 unsigned long pending = 0; 11 for (int j = 1; j \u0026lt; server.io_threads_num; j++) 12 pending += getIOPendingCount(j); 13 if (pending == 0) break; 14} å½“æ‰§è¡Œå®Œ beforesleep å‡½æ•°åï¼Œå†ç”± aeFileEvent çš„ rfileProc å‡½æ•°æŒ‡é’ˆè°ƒç”¨ processInputBuffer å‡½æ•°å†…ä¸»è¦æ˜¯åˆ¤æ–­å’Œè§£æå­—ç¬¦ä¸²ï¼Œå°±ä¸å±•å¼€åˆ†æäº†\nä¸»è¦å…³æ³¨è¿™éƒ¨åˆ†é€»è¾‘\n1 if (c-\u0026gt;reqtype == PROTO_REQ_INLINE) { 2 //å¦‚æœæ˜¯ä¸€è¡Œçš„å­—ç¬¦ä¸²,è§£ææ–¹å¼ 3 if (processInlineBuffer(c) != C_OK) break; 4 } else if (c-\u0026gt;reqtype == PROTO_REQ_MULTIBULK) { 5 //å¦‚æœæ˜¯å¤šè¡Œçš„,è§£ææ–¹å¼ 6 if (processMultibulkBuffer(c) != C_OK) break; 7 } else { 8 serverPanic(\u0026#34;Unknown request type\u0026#34;); 9 } 10 11 //å¦‚æœè§£æåˆ°çš„å‚æ•°ä¸ªæ•°æ˜¯0,é‚£ä¹ˆè¯´æ˜è¿˜æ²¡æœ‰è§£æå®Œæˆ,é‡ç½®client 12 if (c-\u0026gt;argc == 0) { 13 resetClient(c); 14 } else { 15 //åˆ¤æ–­ä¸€ä¸‹æ˜¯å¦åœ¨IOçº¿ç¨‹é‡Œ,å¦‚æœæ˜¯çš„è¯,è®¾ç½®ä¸€ä¸‹flag,ç„¶åç»“æŸ. 16 //å› ä¸ºredisçš„å¤šçº¿ç¨‹åªèƒ½ç”¨æ¥è¯»å†™ç½‘ç»œ,æ“ä½œredisçš„æ•°æ®åº“è¿˜æ˜¯ç”¨å•çº¿çš„ 17 if (io_threads_op != IO_THREADS_OP_IDLE) { 18 serverAssert(io_threads_op == IO_THREADS_OP_READ); 19 c-\u0026gt;flags |= CLIENT_PENDING_COMMAND; 20 break; 21 } 22 23 //å¼€å§‹æ‰§è¡Œå‘½ä»¤äº† 24 if (processCommandAndResetClient(c) == C_ERR) { 25 return C_ERR; 26 } 27 } æœ€ç»ˆä¼šè°ƒç”¨ processCommand å‡½æ•°æ‰§è¡Œå‘½ä»¤\næ‰§è¡Œå‘½ä»¤çš„é€»è¾‘å…ˆä¸ç®¡ï¼Œè¿™ä¸æ˜¯æœ¬æ–‡çš„é‡ç‚¹ã€‚\nå†™å¤„ç† å½“å‘½ä»¤å¤„ç†å®Œæˆåï¼ŒæŠŠæœ‰éœ€è¦å›å¤å®¢æˆ·ç«¯çš„æ•°æ®å†™å…¥clientçš„bufä¸­ã€‚\næœ€åä¼šè°ƒç”¨ writeToClient å‡½æ•°æŠŠ client buf ä¸­çš„æ•°æ®å†™å…¥åˆ°ç½‘ç»œä¸­ï¼Œå®Œæˆæ•°æ®è¿”å›ã€‚\nwriteToClient æœ‰å¤šä¸ªå›è°ƒè·¯å¾„ã€‚ä½†æ˜¯éƒ½æ˜¯ç”± aeEventpool ä¸­çš„ aftersleep å‡½æ•°æŒ‡é’ˆ è°ƒç”¨ beforeSleep å‡½æ•°æ¥å®Œæˆçš„ã€‚\nåœ¨ beforeSleep ä¸­è°ƒç”¨ handleClientsWithPendingWritesUsingThreads å‡½æ•°ã€‚\nè¿™ä¸ªå‡½æ•°ä¹Ÿæ¯”è¾ƒé•¿ï¼Œå°±ä¸è´´äº†ï¼ŒåªæŒ‘ä¸€äº›é‡ç‚¹çš„ã€‚è¿™æœŸè´´äº†ä¸å°‘æºç ï¼Œä¸€ç›´çœ‹æºç ï¼Œä¹ŸæŒºæ¯ç‡¥çš„ã€‚è¿™ä¸ªå‡½æ•°çš„å¤§æ¦‚é€»è¾‘å’Œ handleClientsWithPendingReadsUsingThreads å‡½æ•°çš„å·®ä¸å¤šï¼Œåªä¸è¿‡è¿™é‡Œå¤„ç†çš„æ˜¯å†™ç½‘ç»œã€‚\n1if (server.io_threads_num == 1 || stopThreadedIOIfNeeded()) { 2 return handleClientsWithPendingWrites(); 3} è¿™é‡Œåˆ¤æ–­ä¸€ä¸‹ï¼Œå¦‚æœæ²¡æœ‰å¼€å¯å¤šçº¿ç¨‹æˆ–è€…åœäº†IOçº¿ç¨‹ï¼Œå°±ä½¿ç”¨ handleClientsWithPendingWrites å‡½æ•°åœ¨ä¸»çº¿ç¨‹å¤„ç†å†™é€»è¾‘ã€‚\nhandleClientsWithPendingWrites é‡Œçš„é€»è¾‘å¾ˆç®€å•ï¼Œéå† server.clients_pending_write ä¸­çš„clientï¼Œç„¶åè°ƒç”¨ writeToClient æŠŠæ•°æ®å†™å…¥åˆ°ç½‘ç»œä¸­ã€‚\nå›åˆ° handleClientsWithPendingWritesUsingThreads å‡½æ•°ä¸­ï¼Œè°ƒç”¨ startThreadedIO() å¯åŠ¨ IOçº¿ç¨‹å¹¶å‘å¤„ç†å†™å…¥ã€‚\n1//åœ¨ä¸»çº¿ç¨‹ä¸­ä¹Ÿä¼šå¤„ç†å†™å…¥ 2listRewind(io_threads_list[0],\u0026amp;li); 3while((ln = listNext(\u0026amp;li))) { 4 client *c = listNodeValue(ln); 5 writeToClient(c,0); 6} 7listEmpty(io_threads_list[0]); 8//å’Œä¸Šé¢çš„å¤šçº¿ç¨‹è¯»ä¸€æ ·,è¿™é‡Œä¹Ÿä¼šç­‰å¾…æ‰€æœ‰IOçº¿ç¨‹ä»»åŠ¡ç»“æŸ 9while(1) { 10 unsigned long pending = 0; 11 for (int j = 1; j \u0026lt; server.io_threads_num; j++) 12 pending += getIOPendingCount(j); 13 if (pending == 0) break; 14} åˆ°è¿™åŸºæœ¬redisçš„æ•´ä¸ªç½‘ç»œå¤„ç†æµç¨‹å¤§æ¦‚å°±å†™å®Œäº†ã€‚æ³¨æ„ï¼Œè¿™åªæ˜¯ä¸ªå¤§æ¦‚ï¼Œå…¶ä¸­çš„ä¸€äº›ç»†èŠ‚è¿˜æ²¡æœ‰æ·±å…¥åˆ†æã€‚æ¯”å¦‚åœ¨ aeProcessEvents å‡½æ•°ä¸­ï¼Œä¸ºä»€ä¹ˆæœ‰ beforesleep å’Œ aftersleep è¿™ä¸¤ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œä»¥åŠè°ƒç”¨ä¸¤ä¸ªå‡½æ•°ä¸­çš„å…ˆåè°ƒç”¨é¡ºåºã€‚ aeFileEvent ä¸­ rfileProc å’Œ wfileProc è¿™ä¸¤ä¸ªå‡½æ•°æŒ‡é’ˆçš„è°ƒç”¨é¡ºåºï¼Œä»¥åŠè°ƒç”¨çš„å‡½æ•°çš„é€»è¾‘ã€‚æ¯ä¸€ä¸ªéƒ½å¯ä»¥æ‹¿å‡ºæ¥å•ç‹¬å†™ä¸€ç¯‡ã€‚\nä»¥åæœ‰æ—¶é—´åœ¨å•ç‹¬æ‹¿å‡ºæ¥åˆ†æå§ã€‚å¦‚æœæœ‰æ—¶é—´å†è¿™ç¯‡æ–‡ç« è¡¥ä¸€ä¸ªæµç¨‹å›¾ã€‚\nredisç”¨Cå†™çš„ï¼ŒCå¯¹å¤šæ€çš„æ”¯æŒä¸å¤ªå¥½ï¼Œä¸åƒé¢å‘å¯¹è±¡çš„è¯­è¨€é‚£æ ·ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„ä½¿ç”¨å¤šæ€ã€‚æ‰€ä»¥åœ¨redisçš„æºç é‡Œï¼Œå¤§é‡ä½¿ç”¨äº†å‡½æ•°æŒ‡é’ˆå’Œå›è°ƒå‡½æ•°ï¼Œæ¥é—´æ¥çš„å®ç°äº†å¤šæ€ã€‚è¿™æ ·ä¼šåœ¨é˜…è¯»æºç çš„æ—¶å€™å¢åŠ äº†å¾ˆå¤šç†è§£æˆæœ¬ã€‚\nä½†æ˜¯é²è¿…å…ˆç”Ÿæ›¾ç»è¯´è¿‡ï¼Œåœ¨æ–­ç‚¹é¢å‰ï¼Œä¸€åˆ‡è¯­æ³•éƒ½æ˜¯çº¸è€è™ã€‚æ‰€ä»¥é‡åˆ°å¤æ‚çš„å‡½æ•°è°ƒç”¨é€»è¾‘ï¼Œä½¿ç”¨æ–­ç‚¹å»çœ‹ä¸€ä¸‹å‡½æ•°çš„è°ƒç”¨å…³ç³»ï¼Œå †æ ˆï¼ŒåŸºæœ¬éƒ½èƒ½è§£å†³é—®é¢˜ã€‚\nä¹Ÿå¿«è¿‡å¹´äº†ï¼Œæå‰ç¥æ‰€æœ‰è¯»è€… æ–°å¹´å¿«ä¹\n","date":"2024-01-28T20:10:27Z","image":"https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/OIP-C.R8n6zHAP4N2M01vSoRwkSQHaDW","permalink":"https://lqxhub.github.io/posts/bce71a0/","title":"redisæºç å­¦ä¹ |ç½‘ç»œ redis ç½‘ç»œéƒ¨åˆ†æºç åˆ†æï¼Œå­¦ä¹ ã€‚redisç½‘ç»œå¤šè·¯å¤ç”¨ - QX's blog"},{"content":"2023é©¬ä¸Šå°±ç»“æŸäº†ï¼Œåœ¨å¹´åº•å›å¿†æ€»ç»“ä¸€ä¸‹ä»Šå¹´çš„ä¸€äº›äº‹æƒ…ï¼Œé¡ºä¾¿æ€è€ƒä¸€ä¸‹æ˜å¹´çš„ä¸€äº›è®¡åˆ’ã€‚ ä»¥å‰æ¯å¹´æˆ‘ä¹Ÿä¼šå†™ä¸€ä¸‹ï¼Œåªæ˜¯æ²¡æœ‰å…¬å¼€å‡ºæ¥ï¼Œä»Šå¹´æƒ³ç€å…¬å¼€ä¸€ä¸‹ï¼Œä¸€äº›äº‹æƒ…å…¬å¼€å‡ºæ¥ï¼Œå¯èƒ½è¿˜ä¼šæœ‰é­ç­–çš„ä½œç”¨ 0.0\nè¿˜æ˜¯ä» ç”Ÿæ´» ä¸ å·¥ä½œ ä¸¤æ–¹é¢æ¥å†™å§\nç”Ÿæ´» ä»Šå¹´æ²¡æœ‰å£ç½©ç®¡æ§äº†ï¼Œèƒ½å‡ºå»ç©ï¼Œä¸€äº›æç½®äº†å¥½ä¹…çš„äº‹æƒ…ç»ˆäºå¯ä»¥åšäº†ã€‚å›æƒ³ä¸€ä¸‹ï¼Œæ¯•ä¸šåŠå¹´åå°±é‡åˆ°äº†å£ç½©ï¼Œè¿™å‡ å¹´ä¸€ç›´æ²¡æœ‰æ€ä¹ˆå‡ºå»ç©è¿‡ï¼Œä»Šå¹´ç®—æ˜¯å¿™é‡Œå·é—²å‡ºå»ç©äº†å‡ æ¬¡ã€‚\nLPL ä»Šå¹´ï¼Œå»çœ‹äº†ä¸€åœº LPL çš„çº¿ä¸‹èµ›ï¼Œè§åˆ°äº†shyå“¥ã€‚è™½ç„¶é‚£å¤©shyå“¥è¾“äº†ã€‚(WBG ä¸æ•Œ RNG) ä½†æ˜¯çœ‹åˆ°äº† GALA çš„å¡èäº”æ€ï¼Œä¹Ÿç®—å€¼å›ç¥¨ä»·äº†\næˆ‘ä¹Ÿæ²¡æœ‰æ‹ç…§çš„ä¹ æƒ¯ï¼Œå¥½å¤šç…§ç‰‡æ‰¾ä¸åˆ°äº†ï¼Œå°±å‡‘åˆæ”¾è¿™ä¸¤å¼ å§\næ¼”å”±ä¼š ä»Šå¹´æ˜æ˜Ÿæ‰å †å¼€æ¼”å”±ä¼šï¼Œçƒ­é—¹çš„æ—¶å€™ï¼Œä¸Šæµ·ä¸€å‘¨å¥½å‡ åœºã€‚æœ‰å‡ ä¸ªçƒ­é—¨çš„æ²¡æœ‰æŠ¢åˆ°ï¼Œä½†æ˜¯æŠ¢åˆ°äº† å¤§å¼ ä¼Ÿ çš„ã€‚ä¸å¾—ä¸è¯´ï¼Œå¤§å¼ ä¼Ÿè€å¸ˆç»å¯¹æ²¡æœ‰å‡å”±(æ‰‹åŠ¨ç‹—å¤´)ç°åœºæ°›å›´æ‹‰æ»¡ï¼Œå¤ªå—¨äº†ã€‚ä¹°çš„æ˜¯æ¼”å”±ä¼šçš„é—¨ç¥¨ï¼Œè¿˜èƒ½ç°åœºå¬è„±å£ç§€ï¼Œå¤ªå€¼äº†ã€‚\nä»Šå¹´æœ‰å‡ ä¸ªæ²¡æœ‰æŠ¢åˆ°æœ‰ç‚¹å¯æƒœã€‚ä¸€ä¸ªæ˜¯ æˆ¿ä¸œçš„çŒ« è¿˜ä¸€ä¸ªæ˜¯ é™ˆç²’ æˆ‘æ¯”è¾ƒå–œæ¬¢çš„ä¸¤ä¸ªæ°‘è°£æ­Œæ‰‹ï¼Œè¿˜æœ‰ ä¼ä½° æ²¡æœ‰æŠ¢åˆ°æœ‰ç‚¹å¯æƒœï¼Œç­‰ä¸‹æ¬¡æœ‰æœºä¼šå§ã€‚è‡³äº å‘¨è‘£çš„ï¼Œæˆ‘éƒ½æ²¡æŠ¢è¿‡ï¼Œæˆ‘çŸ¥é“æˆ‘æŠ¢ä¸åˆ°ã€‚\nç© ä»Šå¹´æ²¡æœ‰ç®¡æ§äº†ï¼Œå¯ä»¥è‡ªç”±å‡ºå»ç©äº†ã€‚ä»¥å‰æˆ‘å§å§å’Œå¦¹å¦¹å°±æƒ³æ¥ä¸Šæµ·ç©äº†ï¼Œå¯æƒœä»¥å‰ä¸èƒ½è¯´æ¥å°±æ¥ï¼Œä»Šå¹´æš‘å‡ç»ˆäºæœ‰æœºä¼šäº†ã€‚å¥¹ä»¬æ¥ä¸Šæµ·ç©äº†å¥½å‡ å¤©ï¼Œç„¶ååˆä¸€èµ·å»æ­å·ç©äº†å‡ å¤©ã€‚æš‘å‡å‡ºå»ç©çš„ç¼ºç‚¹å°±æ˜¯äººå¤šå’Œå¤ªçƒ­ï¼Œæ„Ÿè§‰æ­å·æ¯”ä¸Šæµ·è¿˜çƒ­ã€‚\nä»Šå¹´æˆ‘ä¸€äº›åŒå­¦ä¹Ÿæœ‰æ¥ä¸Šæµ·ç©çš„ï¼Œç„¶åå°±æ˜¯åœ¨ä¸Šæµ·è±ªé¥®ï¼Œç»™æ—è¾¹çš„äººéƒ½çœ‹è’™äº†ï¼Œä½ ä»¬è¿™æ˜¯ä»€ä¹ˆå–æ³•ï¼Œä¸€äººå¥”ç€ä¸€ç®±å•¤é…’å–0.0\nå¥½ä¹…ä¹‹å‰å°±è®¡åˆ’ç€å»é‡åº†ç©äº†ï¼Œä»Šå¹´ç»ˆäºå»äº†ã€‚åæœˆåº•å»çš„ï¼Œä¸ºäº†é¿å¼€å›½åº†å‡æœŸã€‚å»ç©äº†ä¸‰å¤©ï¼Œè€å¹´ç‰¹ç§å…µæ—…æ¸¸ï¼Œä¸€å¤©èµ°ä¸‰ä¸‡æ­¥ã€‚æ•´ä½“æ„Ÿè§‰è¿˜æ˜¯éå¸¸æ£’çš„ï¼Œéå¸¸å–œæ¬¢é‡åº†çš„ç¾é£Ÿï¼Œä¹Ÿå–œæ¬¢é‚£é‡Œçš„ç”Ÿæ´»æ°›å›´ã€‚å¦‚æœåªæ˜¯ç”Ÿæ´»çš„è¯ï¼Œæ„Ÿè§‰æ¯”ä¸Šæµ·è¦èˆ’é€‚\nå½“æ—¶æ˜¯ä¸€ä¸ªäººå»çš„ï¼Œå»çš„æ—¶å€™è®¤è¯†äº†ä¸¤ä¸ªæ­å­ï¼ˆä»Šå¹´å¥½åƒæµè¡Œæ‰¾æ­å­ï¼‰ä¸ºäº†ä¿æŠ¤éšç§ï¼Œä¸æ”¾å¥¹ä»¬ç…§ç‰‡äº†ã€‚å‡ºå»ç©äº†ä¸€åœˆï¼Œè¿˜è®¤è¯†äº†æ–°çš„æœ‹å‹ï¼Œå¿«ä¹åˆç¥å¥‡ã€‚\næœ¬æ¥ä»Šå¹´è¿˜è®¡åˆ’ç§‹å¤©å»ä¸€è¶Ÿå—äº¬ï¼Œçœ‹ä¸€åœºå—äº¬çš„è½å¶ï¼Œå› ä¸ºä¸€äº›äº‹æƒ…æ²¡æœ‰å»æˆã€‚ç­‰åˆ°æœ‰ç©ºçš„æ—¶å€™ï¼Œå·²ç»æ˜¯å†¬å­£äº†ã€‚æ˜å¹´ä¸€å®šå§å“ˆå“ˆå“ˆã€‚\nğŸ§‘â€ğŸ¤â€ğŸ§‘ å»å¹´ç»“å©šçš„åŒå­¦å¤šï¼Œä½†æ˜¯æˆ‘æ²¡åŠæ³•å›å»ã€‚ä»Šå¹´ä¸¤ä¸ªåŒå­¦çš„å©šç¤¼éƒ½å›å»ï¼Œè¿˜ç»™ä¸€ä¸ªåŒå­¦è¿˜å½“äº†ä¸€æ¬¡ä¼´éƒã€‚\nè‡³äºæˆ‘è‡ªå·±ï¼Œè¿˜æ˜¯ä¸€ä¸ªäººã€‚å»å¹´å°±è¯´ä»Šå¹´åŠªåŠ›ï¼Œç°åœ¨æ¥çœ‹ï¼Œæ˜å¹´è¿˜è¦ç»§ç»­åŠªåŠ›ã€‚\nå·¥ä½œ ä»Šå¹´å·¥ä½œç®—æ˜¯æ¯”è¾ƒå¿™ï¼Œäº‹æƒ…æŒºå¤šçš„ã€‚æ•´ä½“çœ‹ä¸‹æ¥ï¼Œä¹Ÿç®—æ˜¯åœ¨å·¥ä½œå’Œç”Ÿæ´»ä¸­æ‰¾åˆ°äº†ä¸€ä¸ªå¹³è¡¡ç‚¹ã€‚å·¥ä½œè¿™ä¹ˆå¤šå¹´äº†ï¼Œå¾ˆå¤šäº‹æƒ…å¤„ç†èµ·æ¥ä¹Ÿç®—æ˜¯æ¯”è¾ƒå¾—å¿ƒåº”æ‰‹ï¼Œä»Šå¹´åœ¨å·¥ä½œä¸Šç®—æ˜¯æ²¡æœ‰é‡åˆ°å¤§çš„å›°éš¾ã€‚å»å¹´ç®—æ˜¯ç»™äº†æˆ‘ä¸€ä¸ªtitleï¼Œè´Ÿè´£çš„äº‹æƒ…å¤šäº†ã€‚ä½†æ˜¯æˆ‘æ„Ÿè§‰è¿˜æ˜¯ï¼Œå¤„ç†ä»£ç æ¯”å¤„ç†äººé™…å…³ç³»è¦ç®€å•ï¼Œæ‰€ä»¥æˆ‘ç°åœ¨ä¹Ÿè¿˜æ˜¯åªç®¡ä»£ç ï¼Œä¸ç®¡äººå§ã€‚\næˆ‘è‡ªå·±ä¹ŸçŸ¥é“ï¼Œè¿™äº›ä¸œè¥¿éœ€è¦å»çªç ´ï¼Œå¯èƒ½è¿˜æ˜¯ä¸æƒ³èµ°å‡ºèˆ’é€‚åœˆã€‚è‡³äºæˆ‘ä¸æƒ³ç®¡äººï¼Œä¹Ÿä¸æ˜¯è¯´è‡ªå·±å†…å‘ï¼Œæˆ–è€…ä¸ä¼šè¯´è¯ï¼Œæˆ‘æƒ³å¯èƒ½å°±æ˜¯ä¸æƒ³æ“å¿ƒå¤ªå¤šäº‹å§ï¼Œå› ä¸ºä»£ç æ¯”äººè¦ç®€å•ï¼Œä»£ç å‡ºé—®é¢˜äº†ä¸€å®šæ˜¯æˆ‘çš„é—®é¢˜ï¼Œäººå°±å¤ªå¤æ‚äº†ã€‚\nè¿˜æœ‰å‰å‡ å¤©ï¼Œä¸€å¼ æ–‡ä»¶ä¸‹æ¥ï¼Œç›´æ¥ç»™æˆ‘å“å°¿äº†ã€‚æˆ‘éƒ½åœ¨æƒ³ï¼Œè¿™è¦æ˜¯çœŸå®æ–½äº†ï¼Œæˆ‘æ€•ä¸æ˜¯è¦å¤±ä¸šäº†ã€‚æ¸¸æˆè¿˜æ˜¯å¤ªçœ‹æ”¿ç­–äº†ï¼Œå¸Œæœ›ä¸€åˆ‡ç¨³ä¸­å‘å¥½å§ã€‚\nä»Šå¹´å·¥ä½œä¸­å¥½åƒæ²¡æœ‰å‘ç”Ÿå¤ªå¤šçš„äº‹æƒ…ï¼Œä¹Ÿæ²¡æœ‰å¤ªå¤šæƒ³è®°å½•ã€‚å°±è¿™æ ·ä¸€ç¬”å¸¦è¿‡å§\nå¼€æºç¤¾åŒº ä»Šå¹´å‚ä¸å¼€æºç¤¾åŒºæ¯”è¾ƒå¤šï¼Œè™½ç„¶ä»¥å‰ä¹Ÿç»™å¼€æºé¡¹ç›®æäº¤è¿‡ä»£ç ï¼Œä½†æ˜¯æ²¡æœ‰åƒä»Šå¹´è¿™æ ·æ·±åº¦å‚ä¸\næ”¾ä¸€å¼  GitHubçš„ æˆªå›¾å§ï¼Œè™½è¿œä¸åŠå¤§ä½¬ä»¬ï¼Œå¯¹è‡ªå·±æ¥è¯´ä¹Ÿæ˜¯è¿›æ­¥äº†ã€‚\nä»Šå¹´å‘ç°äº† redisçš„ä¸€ä¸ªbugï¼Œç»™ä»–ä»¬æäº† issueï¼ŒåŸæœ¬è¿˜æƒ³ä¿®ä¸€ä¸‹ï¼Œæ··ä¸ªprå‘¢ã€‚æ²¡æƒ³åˆ°ï¼Œredisç¤¾åŒºçš„å¤§ä½¬å¤„ç†çš„å¤ªåŠæ—¶äº†ï¼Œæˆ‘æ™šä¸Š11ç‚¹å¤šå·¦å³æçš„issueï¼Œç¬¬äºŒå¤©æˆ‘ä¸Šç­æ‰“å¼€GitHubï¼Œå‘ç°é‚£è€å“¥ï¼ˆç¾å›½çš„ï¼‰å·²ç»å›å¤æˆ‘äº†ï¼Œç¡®è®¤é‚£æ˜¯bugï¼Œå¹¶ä¸”å°†bugä¿®å¤äº†ã€‚å°±è¿™æ ·præ²¡æ··æˆğŸ¤£\nä»Šå¹´ä¸»è¦ç»™ pika ï¼ˆå°†è¦æ”¹åä¸º pikiwidbï¼‰è´¡çŒ®ä»£ç ã€‚ä»Šå¹´ç¤¾åŒºæ˜¯é›¨å“¥åœ¨å¸¦é¢†ï¼Œç¤¾åŒºå‘å±•å¾ˆå¿«ï¼Œä»¥å‰ç›¼æœ›çš„ä¸€äº›åŠŸèƒ½ï¼Œä»Šå¹´å®ç°äº†ä¸å°‘ã€‚\nè¿™ä¸€å¹´å‚ä¸ä¸‹æ¥ï¼Œæ”¶è·è¿˜æ˜¯å¾ˆå¤§çš„ï¼Œä¹Ÿç»“è¯†äº†ä¸å°‘å¤§ä½¬ï¼Œåé¢ç»§ç»­å‚ä¸å¼€æºç¤¾åŒºï¼Œç»§ç»­å­¦ä¹ ã€‚\næ„Ÿè°¢ç¤¾åŒºçš„è‚¯å®š\nä»Šå¹´å‚ä¸å¼€æºç¤¾åŒºæ¯”è¾ƒå¤šï¼Œæ¸¸æˆä¹Ÿä¸æ€ä¹ˆç©äº†ï¼Œä¸€å¹´å¥½åƒæ²¡æœ‰æ‰“å¼€è¿‡å‡ æ¬¡æ¸¸æˆäº†ã€‚\nå…¶ä»– ä¹Ÿä¸çŸ¥é“è¿™äº›æ€ä¹ˆåˆ†ç±»äº†ï¼Œæƒ³åˆ°å“ªå†™åˆ°å“ªå§\nä»Šå¹´å¤§Aè¿˜æ˜¯äºé’±çš„ä¸€å¹´ï¼Œäºå¾—è‚‰ç–¼ã€‚\nä»Šå¹´æœ‰ä¸€æ®µæ—¶é—´è¿˜æ˜¯ç„¦è™‘ï¼Œæœ‰æ—¶å€™è¿˜æ˜¯å¤±çœ ã€‚è‡³äºåœ¨ç„¦è™‘äº›ä»€ä¹ˆæˆ‘ä¹Ÿè¯´ä¸ä¸Šæ¥ã€‚å¾ˆå¤šæ—¶å€™ï¼Œå¯èƒ½çœ‹åˆ°ä¸€äº›äº‹æƒ…ï¼Œæœ‰äº›ä»€ä¹ˆæ„Ÿæƒ³ï¼Œæœ‰æ—¶å€™å°±ä¼šä¸€ä¸ªäººåœ¨æ·±å¤œçš„æ—¶å€™æƒ³å¾ˆå¤šã€‚äººæ€»æ˜¯åŠåˆ«äººå®¹æ˜“ï¼Œå’Œè‡ªå·±å’Œè§£å´æ²¡æœ‰é‚£ä¹ˆç®€å•ã€‚æœ‰æ—¶å€™å’Œæˆ‘å§èŠå¤©ï¼Œæˆ‘è¿˜åŠå¥¹ï¼Œä½†æ˜¯ä¸€äº›äº‹æƒ…è‡ªå·±å´ä¼šemoã€‚ä»Šå¹´å¬äº†å¾ˆå¤šæå®—ç››çš„æ­Œï¼Œå°¤å…¶æ˜¯æ·±å¤œçš„æ—¶å€™ã€‚\nå°±åœ¨æ˜¨å¤©æˆ‘ä¸€ä¸ªå¤§å­¦åŒå­¦æ¥ä¸Šæµ·ï¼Œä¸¤äººåƒå®Œé¥­åœ¨è¡—ä¸Šæºœè¾¾èŠå¤©ï¼Œå›å»ç¡å‰ä¹Ÿä¸€ç›´åœ¨èŠï¼ŒèŠåˆ°å‡Œæ™¨ä¸€ç‚¹å¤šã€‚ä»å¤§å­¦æ—¶å€™ï¼ŒèŠåˆ°ç°åœ¨å·¥ä½œã€‚ä»å·¥ä½œèŠåˆ°å®¶åº­ã€‚ä»æˆ‘ä¿©èŠåˆ°äº†ä¸€äº›å…¶ä»–çš„åŒå­¦ã€‚æœ€åæ„Ÿæ…¨ï¼Œå¾ˆå¤šæ—¶å€™å°±æ˜¯å‘½ä¸­æ³¨å®šã€‚æ¯ä¸ªäººçš„ç”Ÿæ´»éƒ½æœ‰å…‰é²œäº®ä¸½çš„ä¸€é¢ï¼Œä¹Ÿæœ‰ä¸€åœ°é¸¡æ¯›çš„çª˜è¿«ã€‚\nè¿™ä¸¤å¹´èº«è¾¹å¥½å¤šåŒå­¦éƒ½ç»“å©šäº†ï¼Œå¥½å¤šè¿˜æœ‰å­©å­ã€‚è¯´æ˜¯è‡ªå·±ä¸ç€æ€¥ï¼Œä½†æœ‰æ—¶å€™ä¹Ÿä¼šåœ¨æƒ³ï¼Œè‡ªå·±ä»€ä¹ˆæ—¶å€™èƒ½ç»“å©šå‘¢ã€‚å°±æ˜¯æ€ä¹ˆè¯´å‘¢ï¼Œåˆ«äººéƒ½äº¤å·äº†ï¼Œæˆ‘è¿˜æ²¡æœ‰å¼€å§‹ç­”é¢˜ã€‚ä¹‹å‰æˆ‘æƒ³è¿‡ï¼Œæˆ‘ä¸€ç›´åœ¨å¤–åœ°ï¼Œç®—æ˜¯ä¸€ç§é€ƒé¿ï¼Œé€ƒé¿å®¶é‡Œçš„å‚¬ã€‚ä¸€ç›´è¿™æ ·é€ƒé¿æœ‰ç‚¹è‡ªç§ï¼Œåªé¡¾è‡ªå·±ï¼Œæ²¡æœ‰è€ƒè™‘å®¶äººçš„æ„Ÿå—ä»¥å‰æ€»æ˜¯å¬å¤§äººä»¬æ˜¯è°å®¶å­©å­å¤šå¤§äº†ï¼Œå¤šå¤§äº†ï¼Œæ²¡æƒ³åˆ°æˆ‘ç°åœ¨ä¹Ÿæˆäº†åˆ«äººå£ä¸­è°å®¶çš„å­©å­äº†ã€‚\nä¹‹å‰æ€»æ˜¯è¯´å·¥ä½œå¿™ï¼Œæ¥è§¦ä¸åˆ°äººä½œä¸ºå€Ÿå£ã€‚ç°åœ¨å‘ç°ï¼Œè¿™ç¡®å®æ˜¯ä¸€éƒ¨åˆ†åŸå› ï¼Œä½†æ˜¯è‡ªå·±ä¹Ÿæœ‰ä¸€äº›é—®é¢˜ã€‚è‡ªå·±æ²¡æœ‰æƒ³ç€å»æ”¹å˜ï¼Œèµ°å‡ºè¿™ä¸ªèˆ’é€‚åœˆï¼Œæ°¸è¿œè¿™æ ·ï¼Œæ°¸è¿œä¸å¯èƒ½æœ‰æ”¹å˜ã€‚è¿˜æœ‰ä¸€éƒ¨åˆ†åŸå› ï¼Œè‡ªå·±ä¸å–„äºå¤„ç†äººä¸äººä¹‹é—´çš„å…³ç³»ã€‚å’Œå®¶äººè¿˜æœ‰é‚£äº›ç†Ÿæ‚‰çš„æœ‹å‹ä¹‹é—´è¿˜å¥½ï¼Œå› ä¸ºéƒ½ç†Ÿæ‚‰äº†ï¼Œå¾ˆå¤šäº‹æƒ…çŸ¥é“è¯¥æ€ä¹ˆåšï¼Œä»–ä»¬ä¹ŸçŸ¥é“æˆ‘çš„ä¸€äº›æ€§æ ¼ã€‚ç›¸å¤„èµ·æ¥å°±ä¼šç®€å•å¾ˆå¤šã€‚ä½†æ˜¯å’Œä¸€ä¸ªä¸ç†Ÿæ‚‰çš„äººäº¤æµæˆ‘å°±æœ‰ç‚¹åŠ›ä¸ä»å¿ƒäº†ã€‚è¯´æ˜¯ä¸æ“…é•¿å’Œé™Œç”Ÿäººäº¤æµå§ï¼Œä½†æ˜¯ä»Šå¹´åœ¨å¼€æºç¤¾åŒºï¼Œå’Œå¾ˆå¤šäººäº¤æµæ„Ÿè§‰å´æŒºå¥½çš„ï¼Œå¯èƒ½æ˜¯å› ä¸ºåœ¨è®¨è®ºæŠ€æœ¯é—®é¢˜å§ã€‚ä»Šå¹´æˆ‘å§ç»™æˆ‘ä»‹ç»äº†ä¸€ä¸ªå¥³å­©è®¤è¯†ï¼Œè€å®¶ä¸€ä¸ªåœ°æ–¹çš„ï¼Œå¥¹ä¹Ÿæ˜¯åœ¨ä¸Šæµ·å·¥ä½œï¼Œæ¥è§¦ä¸‹æ¥æ„Ÿè§‰å°±æ˜¯ä¸¤ä¸ªäººæ²¡ä»€ä¹ˆè¯èŠï¼Œåæ¥ä¹Ÿå°±ä¸æ€ä¹ˆè”ç³»äº†ï¼Œå¯èƒ½å¾ˆå¤§ä¸€éƒ¨åˆ†åŸå› åœ¨æˆ‘å§ã€‚\næ˜å¹´ æ˜å¹´å°è¯•å»æ”¹å˜ä¸€ä¸‹å§ï¼ŒæŠŠè‡ªå·±çš„ä¸€äº›é—®é¢˜å°è¯•å»çªç ´ã€‚æŠŠå·¥ä½œåšå¥½ï¼Œå¤šå‚ä¸å¼€æºç¤¾åŒºï¼Œå¤šå­¦ä¹ ã€‚\næ˜å¹´æœ‰æ—¶é—´çš„è¯ï¼Œè¿˜æƒ³å‡ºå»ç©ä¸€è¶Ÿã€‚è‡³äºå»å“ªè¿˜æ²¡æƒ³å¥½ï¼Œè¥¿å®‰ï¼Œå¹¿å·ï¼Œå¦é—¨ï¼ŒåŒ—äº¬ï¼Œé¦™æ¸¯ï¼Œæ­¦æ±‰ï¼Ÿåˆ°æ—¶å€™å†å®šå§\nä»¥å‰çš„æ—¶å€™ï¼Œè¿˜è®¡åˆ’ç€å°†æ¥å’Œé‚£ä¸ªå¥¹å»é‡åº†åƒç«é”…ï¼Œå»é¼“æµªå±¿çœ‹æµ·ï¼Œå»å¹¿å·åƒå¥½åƒçš„ï¼Œå»è¥¿å®‰çš„åŸå¢™ä¸‹æ•£æ­¥ç­‰ç­‰å¥½å¤šåœ°æ–¹ã€‚ç€ç­‰äº†è¿™ä¹ˆå¤šå¹´è¿˜æ˜¯æ²¡ç­‰åˆ°ï¼Œæˆ‘å°±è‡ªå·±å…ˆå»äº†ğŸ¤£\nä»Šå¹´å¥½åƒæ²¡æ€ä¹ˆè¯»ä¹¦ï¼Œé‚£æ˜å¹´è¦å¤šè¯»å‡ æœ¬ä¹¦ï¼Œæˆ–è€…ç¿»ç¿»ä»¥å‰è¯»çš„ä¹¦ã€‚ä¸ºæ•…è€ŒçŸ¥æ–°å˜›ã€‚\nGood luck next year\n","date":"2023-12-25T19:26:56Z","image":"https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/1703414244771.jpg","permalink":"https://lqxhub.github.io/posts/f5a4584b/","title":"æˆ‘çš„2023"},{"content":"åœ¨C++ä½¿ç”¨åŠ¨æ€åº“ï¼Œ(linuxä¸‹æ˜¯.soï¼Œwindowsä¸‹æ˜¯.dll) æ¯”è¾ƒå¸¸è§çš„æ–¹å¼æ˜¯åœ¨ç¼–è¯‘æ—¶ï¼Œç›´æ¥è¿æ¥åˆ°ç¨‹åºä¸­ã€‚ä½†æ˜¯é™¤äº†è¿™ç§æ–¹å¼å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨çš„åŠ¨æ€åŠ è½½çš„æ–¹å¼å»ä½¿ç”¨åŠ¨æ€åº“ã€‚\nä¸¤ç§æ–¹å¼çš„åŒºåˆ« åœ¨ç¼–è¯‘æ—¶æŠŠåº“è¿æ¥åˆ°ç¨‹åºï¼šè¿™ç§æ–¹å¼æ˜¯åœ¨ç¼–è¯‘çš„æ—¶å€™ï¼Œå°±ç¡®å®šäº†è¦é“¾æ¥çš„åº“æ–‡ä»¶ï¼Œç„¶åé€šè¿‡ç¼–è¯‘å‚æ•°åœ¨é“¾æ¥æ—¶ç›´æ¥æŠŠåŠ¨æ€åº“çš„åœ°å€ç©ºé—´ç­‰ç­‰ä¿¡æ¯è¿æ¥åˆ°ç¨‹åºä¸­ã€‚ç¨‹åºåœ¨è¿è¡Œæ—¶ï¼Œå¯ä»¥ç›´æ¥æ ¹æ®è·¯å¾„å»å¯»æ‰¾åŠ¨æ€åº“ï¼Œç„¶ååŠ è½½åˆ°ç¨‹åºä¸­ï¼Œç„¶åè¿è¡Œï¼Œè¿™ç§æ–¹å¼åœ¨æ—¥å¸¸å¼€å‘ä¸­ç”¨çš„æ¯”è¾ƒå¤šã€‚\nåœ¨ç¨‹åºè¿è¡Œæ—¶åŠ¨æ€åŠ è½½åº“ï¼šè¿™ç§æ–¹å¼æ˜¯åœ¨ç¨‹åºè¿è¡Œæ—¶ï¼Œé€šè¿‡è°ƒç”¨ç³»ç»Ÿå‡½æ•°ï¼ŒæŠŠåŠ¨æ€åº“åŠ è½½åˆ°ç¨‹åºä¸­ï¼Œç„¶åæ‰§è¡ŒåŠ¨æ€åº“ä¸­çš„ä»£ç ã€‚è¿™ç§æ–¹å¼å’Œç¼–è¯‘æ—¶é“¾æ¥çš„ä¼˜åŠ¿æ˜¯å¯ä»¥åœ¨ç¨‹åºè¿è¡Œçš„è¿‡ç¨‹ä¸­åŠ¨æ€åŠ è½½å’Œå¸è½½åº“ã€‚å¯ä»¥åœ¨ä¸ä¿®æ”¹æºç¨‹åºçš„å‰æä¸‹ï¼Œä½¿ç”¨æ–°çš„åº“ã€‚è¿™ç§æ–¹å¼ï¼Œæ¯”è¾ƒå¸¸è§çš„åº”ç”¨æ˜¯ç¨‹åºçš„æ’ä»¶ç³»ç»Ÿã€‚è¿˜æœ‰ä¸€ä¸ªå°±æ˜¯æœåŠ¡å™¨çš„çƒ­æ›´å¯ä»¥ç”¨è¿™ä¸ªæ¥å®ç°ã€‚\nåœ¨ç¼–è¯‘æ—¶ä½¿ç”¨åŠ¨æ€åº“çš„ä¾‹å­ä¼ é€é—¨\nåŠ¨æ€åŠ è½½åº“ ä¸åºŸè¯äº†ï¼Œç›´æ¥å¼€å§‹ä¸Šä»£ç \nåœ¨ç¨‹åºè¿è¡Œçš„è¿‡ç¨‹ä¸­åŠ¨æ€åŠ è½½åº“ï¼Œéœ€è¦ä¾èµ–æ“ä½œç³»ç»Ÿï¼Œæ‰€ä»¥åœ¨ä¸åŒçš„ç³»ç»Ÿä¸Šæœ‰ä¸åŒçš„ç³»ç»Ÿè°ƒç”¨å‡½æ•°ã€‚\nåœ¨linux ä¸Šéœ€è¦ç”¨åˆ° dlopen å‡½æ•°åŠ è½½åº“ï¼Œdlclose å‡½æ•°é‡Šæ”¾åº“ï¼Œdlsym å‡½æ•° æŸ¥æ‰¾åº“å‡½æ•° éœ€è¦çš„å¤´æ–‡ä»¶ #include \u0026lt;dlfcn.h\u0026gt;\nåœ¨windows ä¸Šéœ€è¦ LoadLibrary å®åŠ è½½åº“ï¼ŒFreeLibrary å®é‡Šæ”¾åº“ï¼ŒGetProcAddress å‡½æ•°æŸ¥æ‰¾åº“å‡½æ•° éœ€è¦çš„å¤´æ–‡ä»¶ #include \u0026lt;windows.h\u0026gt;\nåŸºç±»åŠŸèƒ½ åœ¨C++ä¸­å¯ä»¥é€šè¿‡å®šä¹‰ä¸€ä¸ªæŠ½è±¡ç±»æ¥ä½œä¸ºæ‰€æœ‰åº“çš„åŸºç±»ï¼Œæ‰€æœ‰çš„åº“æ–‡ä»¶éƒ½å®ç°è¿™ä¸ªåŸºç±»ï¼Œç„¶åé‡å†™åŸºç±»çš„çº¯è™šå‡½æ•°ã€‚å¯ä»¥åœ¨åŠ è½½åˆ°æ‰€æœ‰åº“åï¼Œéƒ½å¯ä»¥æŠŠåº“é‡Œçš„ç±»ä½œä¸ºæŠ½è±¡ç±»çš„æ´¾ç”Ÿç±»ã€‚\nå…ˆå®šä¹‰ä¸€ä¸ªåŸºç±» base.h\n1#ifndef DLOAD_BASE_H 2#define DLOAD_BASE_H 3 4/** 5 * å¿…é¡»å®ç° moduleName_create å‡½æ•°,æ¥åˆå§‹åŒ–å¯¹è±¡ 6 * extern \u0026#34;C\u0026#34; Base *module1_create() { 7 * return new Module; 8 * } 9 * 10 * //å¿…é¡»å®ç° moduleName_destroy å‡½æ•°,æ¥å›æ”¶å¯¹è±¡ 11 * extern \u0026#34;C\u0026#34; void module1_destroy(Base *obj) { 12 * delete obj; 13 * } 14 */ 15 16 17class Base { 18 public: 19 virtual std::string readLine(const std::string \u0026amp;) = 0; 20 21 virtual ~Base() = default; 22}; 23 24#endif //DLOAD_BASE_H è¿™ä¸ªåŸºç±»çš„åŠŸèƒ½å¾ˆç®€å•ï¼Œåªæœ‰ä¸€ä¸ªçº¯è™šå‡½æ•°readLine è¿™ä¸ªå‡½æ•°ä¼šä¼ å…¥ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œç„¶åè¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²\næ³¨é‡Šä¸­çš„å“ªä¸¤ä¸ªå‡½æ•°ï¼Œåé¢ä¼šæœ‰è¯¦ç»†çš„ä»‹ç»\nå®ç°ä¸€ä¸ªæ¨¡å— å¯ä»¥æŠŠä¸€ä¸ªåº“çœ‹åšæ˜¯ä¸€ä¸ªæ¨¡å—ï¼Œç°åœ¨å®ç°ä¸€ä¸ªæ¨¡å—\n1//ç®€å•çš„æ¨¡å— ä¾‹å­ 2//è½¬å¤§å†™ 3 4#include \u0026lt;algorithm\u0026gt; 5#include \u0026lt;string\u0026gt; 6#include \u0026#34;../base.h\u0026#34; 7 8class Module1 : public Base { 9 std::string readLine(const std::string \u0026amp;str) override { 10 std::string str2(str); 11 std::transform(str.begin(), str.end(), str2.begin(), ::toupper); 12 return str2; 13 } 14}; 15 16//å¿…é¡»å®ç° moduleName_create å‡½æ•°,æ¥åˆå§‹åŒ–å¯¹è±¡ 17extern \u0026#34;C\u0026#34; Base *module1_create() { 18 return new Module1; 19} 20 21//å¿…é¡»å®ç° moduleName_destroy å‡½æ•°,æ¥å›æ”¶å¯¹è±¡ 22extern \u0026#34;C\u0026#34; void module1_destroy(Base *obj) { 23 delete obj; 24} è¿™ä¸ªåŠŸèƒ½éå¸¸ç®€å•ï¼ŒæŠŠä¼ å…¥çš„å­—ç¬¦ä¸²è½¬æˆå¤§å†™ï¼Œç„¶åè¿”å›\nä¸ºä»€ä¹ˆéœ€è¦ Base *module1_create() å’Œ void module1_destroy(Base *obj) è¿™ä¸¤ä¸ªå‡½æ•° å› ä¸ºåœ¨æŠŠåº“åŠ è½½å®Œæˆåï¼Œéœ€è¦ä½¿ç”¨åº“é‡Œçš„å‡½æ•°ï¼Œä½†æ˜¯ä¸èƒ½ç›´æ¥æŸ¥æ‰¾C++çš„ç±»ï¼Œç„¶åå†åˆå§‹åŒ–å¯¹è±¡ï¼Œåªèƒ½åœ¨åº“é‡Œå®ŒæˆC++å¯¹è±¡çš„åˆå§‹åŒ–ï¼Œç„¶åè¿”å›å¯¹è±¡çš„æŒ‡é’ˆã€‚\næ‰€ä»¥éœ€è¦åœ¨åº“é‡Œæœ‰å¯¹åº”çš„å‡½æ•°æ¥åˆå§‹åŒ–å¯¹è±¡å’Œå›æ”¶å¯¹è±¡ï¼Œæ‰€ä»¥å°±æœ‰äº†è¿™ä¸¤ä¸ªå‡½æ•°ã€‚\nä¸ºä»€ä¹ˆè¦ extern \u0026quot;C\u0026quot; å› ä¸ºC++æœ‰å‡½æ•°é‡è½½çš„åŠŸèƒ½ï¼Œæ‰€ä»¥ç¼–è¯‘å™¨åœ¨ç¼–è¯‘ä»£ç çš„æ—¶å€™ï¼Œä¼šå¯¹å‡½æ•°é‡å‘½åã€‚ä½†æ˜¯å¯¹å‡½æ•°é‡å‘½åçš„è§„åˆ™ï¼Œæ²¡æœ‰ç»Ÿä¸€çš„æ ‡å‡†ï¼Œä¸åŒç¼–è¯‘å™¨æœ‰ä¸åŒçš„è§„åˆ™ã€‚åƒ module1_create è¿™ä¸ªå‡½æ•°å¯èƒ½å°±è¢«é‡å‘½åæˆ _Z14module1_createè¿™æ ·çš„å­—ç¬¦ä¸²ã€‚è¿™æ ·åé¢ä½¿ç”¨ dlsym æˆ–è€… GetProcAddress å‡½æ•°æŸ¥æ‰¾åº“é‡Œçš„å‡½æ•°æ—¶ï¼Œå°±æ²¡æ³•æ‰¾åˆ°å¯¹åº”çš„å‡½æ•°äº†ã€‚æ‰€ä»¥ä½¿ç”¨extern \u0026quot;C\u0026quot; è®©ç¼–è¯‘å™¨ä½¿ç”¨Cçš„è§„åˆ™æ¥ç¼–è¯‘è¿™æ®µå‡½æ•°\nè‡³äºè¿™ä¸¤ä¸ªå‡½æ•°çš„åå­— module1_create å’Œ module1_destroy æ²¡æœ‰å¼ºåˆ¶çš„è¦æ±‚ï¼Œä½†æ˜¯è¦æœ‰ä¸€å®šçš„è§„èŒƒã€‚å¦åˆ™åœ¨åŠ è½½åˆ°åº“åï¼Œæ²¡æ³•æ ¹æ®å‡½æ•°åæŸ¥æ‰¾åˆ°å¯¹åº”çš„å‡½æ•°ã€‚è¿™é‡Œç”¨åˆ°çš„è§„åˆ™æ˜¯ æ¨¡å—å_create å’Œ æ¨¡å—å_destroy\nåŠ è½½åº“ ä¸‹é¢å¼€å§‹åŠ è½½åº“ï¼Œå› ä¸ºåœ¨åŒçš„ç³»ç»Ÿä¸‹ï¼ŒåŠ è½½åº“è°ƒç”¨çš„å‡½æ•°ä¸åŒï¼Œæ‰€ä»¥ä½¿ç”¨ å®æ¥å®Œæˆä¸ç”¨ç³»ç»Ÿä¸‹çš„æ¡ä»¶ç¼–è¯‘ï¼Œæœ€ç»ˆå®ŒæˆåŠ è½½åº“\n1//å£°æ˜åˆ›å»ºå¯¹è±¡çš„å‡½æ•° 2typedef Base *(*create)(); 3 4//å£°æ˜å›æ”¶å¯¹è±¡çš„å‡½æ•° 5typedef void (*destroy)(Base *); 6 7//è°ƒç”¨ç³»ç»Ÿå‡½æ•°,åŠ è½½åŠ¨æ€åº“ 8 9#ifdef _WIN32 10 11HINSTANCE loadLib(Base **base, const char *path, const char *funName) { 12 auto handle = LoadLibrary(path); 13 if (!handle) { 14 return nullptr; 15 } 16 auto cr = (create) GetProcAddress(handle, funName); 17 if (cr) { 18 *base = cr(); 19 } 20 return handle; 21} 22 23//è°ƒç”¨ç³»ç»Ÿå‡½æ•°,å¸è½½åŠ¨æ€åº“ 24void freeLib(HINSTANCE handle, Base *obj, const char *funName) { 25 auto free = (destroy) GetProcAddress(handle, funName); 26 if (free) { 27 free(obj); 28 } 29 FreeLibrary(handle); 30} 31 32#else 33 34void *loadLib(Base **base, const char *path, const char *funName) { 35 auto handle = dlopen(path, RTLD_LAZY); 36 if (!handle) { 37 return nullptr; 38 } 39 auto cr = (create) dlsym(handle, funName); 40 if (cr) { 41 *base = cr(); 42 } 43 return handle; 44} 45 46//è°ƒç”¨ç³»ç»Ÿå‡½æ•°,å¸è½½åŠ¨æ€åº“ 47void freeLib(void *handle, Base *obj, const char *funName) { 48 auto free = (destroy) dlsym(handle, funName); 49 if (free) { 50 free(obj); 51 } 52 dlclose(handle); 53} 54 55#endif åœ¨ä»£ç æœ€å¼€å§‹çš„ä½ç½®ï¼Œé€šè¿‡ typedef å£°æ˜äº†ä¸¤ä¸ªå‡½æ•°çš„æŒ‡é’ˆï¼Œåœ¨æŸ¥æ‰¾åˆ°å‡½æ•°åï¼ŒæŠŠå‡½æ•°å¼ºè½¬æˆå¯¹åº”çš„ç±»å‹ï¼Œæ‰èƒ½åœ¨åé¢ä½¿ç”¨\nä½¿ç”¨åº“ 1 2int main() { 3 std::string libPath; 4#ifdef _WIN32 5 libPath = std::string(\u0026#34;./module/libmodule1\u0026#34; + \u0026#34;.dll\u0026#34;); 6#else 7 libPath = std::string(\u0026#34;./module/libmodule1\u0026#34; + \u0026#34;.so\u0026#34;); 8#endif 9 Base *module = nullptr; 10 auto handle = loadLib(\u0026amp;module, libPath.c_str(), std::string(\u0026#34;module1_create\u0026#34;).c_str()); 11 12 if (!module) { 13 std::cout \u0026lt;\u0026lt; \u0026#34;load lib module1\u0026#34; \u0026lt;\u0026lt; \u0026#34; fail\u0026#34; \u0026lt;\u0026lt; std::endl; 14 return 1; 15 } 16 std::cout \u0026lt;\u0026lt; module-\u0026gt;readLine(\u0026#34;abc\u0026#34;) \u0026lt;\u0026lt; std::endl; 17 18 return 0; 19} ç°åœ¨åŸºæœ¬å°±å®Œæˆäº†ä¸€ä¸ªåŠ¨æ€åº“çš„åŠ¨æ€åŠ è½½è¿‡ç¨‹ã€‚å¦‚æœæƒ³è¦æ‹“å±•ï¼Œåªè¦å†æŒ‰ç…§è¿™ä¸ªè§„åˆ™ï¼Œå†™ä¸€ä¸ªæ–°çš„æ¨¡å—ç„¶ååŠ è½½ä¸Šæ¥å°±å¯ä»¥äº†ã€‚\næœ€åæ”¾ä¸€ä¸ªç›¸å¯¹å®Œæ•´çš„åŠ¨æ€åŠ è½½çš„demoï¼Œgithub\n","date":"2023-07-22T21:56:18Z","image":"https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/7e0d79d47f0173b9b7a0c351c5d719303aa0f0e8.png","permalink":"https://lqxhub.github.io/posts/b810e905/","title":"C++ä¸­åŠ¨æ€åŠ è½½å…±äº«åº“ï¼Œä½¿ç”¨.so/dllæ–‡ä»¶ã€‚è¯¦ç»†è®²è§£ç¼–è¯‘æ—¶é“¾æ¥ä¸è¿è¡Œæ—¶åŠ¨æ€åŠ è½½çš„åŒºåˆ«"},{"content":"Redis åœ¨6.0 ä¸­åŠ å…¥äº†ACLï¼ˆAccess Control List) çš„æ”¯æŒï¼Œåœ¨æ­¤å‰çš„ç‰ˆæœ¬ä¸­,Redisæ˜¯æ²¡æœ‰ç”¨æˆ·çš„æ¦‚å¿µçš„ï¼Œæ²¡æœ‰åŠæ³•å¾ˆå¥½çš„æ§åˆ¶æƒé™ï¼Œåœ¨6.0ä¸­åŠ å…¥äº†ç”¨æˆ·çš„æ¦‚å¿µï¼Œå¯ä»¥ç»™æ¯ä¸ªç”¨æˆ·åˆ†é…ä¸åŒçš„æƒé™æ¥æ§åˆ¶æƒé™ã€‚\nACLä½œç”¨ ACLçš„ä½œç”¨å°±æ˜¯å¯¹ä¸åŒç”¨æˆ·çš„æƒé™åšé™åˆ¶ï¼Œé™åˆ¶ä¸åŒç”¨æˆ·çš„æƒé™ã€‚æ¯”å¦‚é™åˆ¶æŸäº›ç”¨æˆ·ä½¿ç”¨åˆ é™¤å‘½ä»¤ï¼Œé™åˆ¶æŸäº›ç”¨æˆ·åªèƒ½ä½¿ç”¨è¯»å‘½ä»¤ç­‰ç­‰ã€‚åœ¨ 6.0 ä¹‹å‰ï¼Œredisæ²¡æœ‰ç”¨æˆ·çš„æ¦‚å¿µï¼Œæ˜¯ä¸èƒ½åšå…·ä½“ç”¨æˆ·çš„é™åˆ¶çš„ï¼Œå¦‚æœæœ‰çš„ç”¨æˆ·æ‰§è¡Œäº† FLUSHALL å‘½ä»¤ï¼Œé‚£ä¹ˆæ•´ä¸ªåº“çš„æ•°æ®éƒ½æ²¡æœ‰äº†ï¼Œè¿™æ ·æ˜¯æœ‰é£é™©çš„ã€‚ ACLå‘½ä»¤ redisè¿˜æ˜¯ä½¿ç”¨åŸæ¥çš„ AUTH å‘½ä»¤æ¥è¿›è¡Œè®¤è¯ï¼Œè¿™ä¸ªå‘½ä»¤åšäº†å¯¹ä½ç‰ˆæœ¬çš„å…¼å®¹\n6.0 åŠä»¥åç‰ˆæœ¬ AUTH \u0026lt;username\u0026gt; \u0026lt;password\u0026gt; 6.0 ä¹‹å‰ç‰ˆæœ¬ AUTH \u0026lt;password\u0026gt; åœ¨ä½¿ç”¨ AUTH \u0026lt;password\u0026gt; è¿™ä¸ªå‘½ä»¤æ—¶ï¼Œä½¿ç”¨çš„æ˜¯redisçš„é»˜è®¤ç”¨æˆ·ï¼Œredis ACL ä¸­åˆå§‹åŒ–äº†ä¸€ä¸ªé»˜è®¤ç”¨æˆ·default è¿™æ ·å°±å®ç°äº†å¯¹ä½ç‰ˆæœ¬çš„å…¼å®¹ã€‚åœ¨ 6.0 ä»¥åçš„ç‰ˆæœ¬ä¸­ä½¿ç”¨ AUTH \u0026lt;password\u0026gt; è¿™ä¸ªå‘½ä»¤æ—¶ï¼Œå®é™…ä¸Šæ˜¯å¯¹defaultç”¨æˆ·åšäº†è®¤è¯ã€‚\nACLæ˜¯ä½¿ç”¨ DSLï¼ˆdomain specific languageï¼‰å®šä¹‰çš„ï¼Œè¯¥ DSL æè¿°äº†ç»™å®šç”¨æˆ·èƒ½å¤Ÿæ‰§è¡Œçš„æ“ä½œã€‚æ­¤ç±»è§„åˆ™å§‹ç»ˆä»å·¦åˆ°å³ä»ç¬¬ä¸€ä¸ªåˆ°æœ€åä¸€ä¸ªå®æ–½ï¼Œå› ä¸ºæœ‰æ—¶è§„åˆ™çš„é¡ºåºå¯¹äºç†è§£ç”¨æˆ·çš„å®é™…èƒ½åŠ›å¾ˆé‡è¦ã€‚\nACL ç®€å•çš„è¯­æ³•\nçœ‹ä¸€ä¸‹å½“å‰ç”¨æˆ·\n1127.0.0.1:6379\u0026gt; acl list 21) \u0026#34;user default on nopass ~* \u0026amp;* +@all\u0026#34; default ç”¨æˆ·å on è¡¨ç¤ºç”¨æˆ·æ˜¯æ¿€æ´»çš„ï¼Œå¦‚æœæ˜¯ offé‚£ä¹ˆè¿™ä¸ªç”¨æˆ·æ— æ³•é€šè¿‡ AUTH å‘½ä»¤ nopass è¡¨ç¤ºè¿™ä¸ªç”¨æˆ·æ²¡æœ‰å¯†ç  ~* è¡¨ç¤ºå¯ä»¥è®¿é—®çš„Keyï¼ˆæ­£åˆ™åŒ¹é…ï¼‰ \u0026amp;* 6.2 åŠ å…¥çš„ï¼Œè¡¨ç¤ºchannelçš„æƒé™ +@ è¡¨ç¤ºç”¨æˆ·çš„æƒé™ï¼Œâ€œ+â€è¡¨ç¤ºæˆæƒæƒé™ï¼Œæœ‰æƒé™æ“ä½œæˆ–è®¿é—®ï¼Œâ€œ-â€è¡¨ç¤ºè¿˜æ˜¯æ²¡æœ‰æƒé™ï¼› @ä¸ºæƒé™åˆ†ç±»ï¼Œå¯ä»¥é€šè¿‡Â ACL CATÂ æŸ¥è¯¢æ”¯æŒçš„åˆ†ç±»ã€‚+@all è¡¨ç¤ºæ‰€æœ‰æƒé™ï¼Œnocommands è¡¨ç¤ºä¸ç»™ä¸ä»»ä½•å‘½ä»¤çš„æ“ä½œæƒé™ ç”¨æˆ·æƒé™åˆ†ç±»\n1 \u0026#34;keyspace\u0026#34; 2 \u0026#34;read\u0026#34; 3 \u0026#34;write\u0026#34; 4 \u0026#34;set\u0026#34; 5 \u0026#34;sortedset\u0026#34; 6 \u0026#34;list\u0026#34; 7 \u0026#34;hash\u0026#34; 8 \u0026#34;string\u0026#34; 9 \u0026#34;bitmap\u0026#34; 10 \u0026#34;hyperloglog\u0026#34; 11 \u0026#34;geo\u0026#34; 12 \u0026#34;stream\u0026#34; 13 \u0026#34;pubsub\u0026#34; 14 \u0026#34;admin\u0026#34; 15 \u0026#34;fast\u0026#34; 16 \u0026#34;slow\u0026#34; 17 \u0026#34;blocking\u0026#34; 18 \u0026#34;dangerous\u0026#34; 19 \u0026#34;connection\u0026#34; 20 \u0026#34;transaction\u0026#34; 21 \u0026#34;scripting\u0026#34; è‡³äºæ€ä¹ˆæ“ä½œï¼Œä¸æ˜¯è¿™æ¬¡çš„é‡ç‚¹ï¼Œç›´æ¥å»çœ‹å®˜æ–¹æ–‡æ¡£å°±å¥½äº† redis acl\nACLæºç  å¼€å§‹ä¸Šæºç äº†ï¼Œæœ¬æ¬¡æºç åŸºäºredisçš„ 7.0.11ç‰ˆæœ¬ï¼Œä¸åŒçš„ç‰ˆæœ¬ä¹‹é—´å¯èƒ½æœ‰å·®å¼‚ã€‚\nACLç›¸å…³çš„æ•°æ®ç»“æ„ ACLé‰´æƒå¯¹åº”çš„æ˜¯ä¸€ä¸ªUserï¼Œå…ˆçœ‹ä¸€ä¸‹Userå’Œç›¸å…³çš„selectorçš„å®šä¹‰\n1typedef struct { 2 //ç”¨æˆ·å 3 sds name; /* The username as an SDS string. */ 4 5 //ç”¨æˆ·çš„flag,ç”¨æ¥åšå„ç§æ¯”å¯¹ 6 uint32_t flags; /* See USER_FLAG_* */ 7 8 //è¿™ä¸ªç”¨æˆ·çš„å¯†ç ï¼Œä¸€ä¸ªç”¨æˆ·å¯ä»¥æœ‰å¤šä¸ªå¯†ç ï¼Œæ‰€ä»¥æ˜¯ç”¨é“¾è¡¨ä¿å­˜çš„ 9 //è¿™ä¸ªé“¾è¡¨çš„nodeæ˜¯ä¸€ä¸ªæ˜æ–‡å¯†ç ç»è¿‡ `SHA256` è®¡ç®—è¿‡åçš„ å­—ç¬¦ä¸² 10 list *passwords; /* A list of SDS valid passwords for this user. */ 11 12 //éªŒè¯ç”¨æˆ·æƒé™çš„é€‰æ‹©å™¨ï¼Œè¯¥ç”¨æˆ·çš„æƒé™ä¿å­˜åœ¨è¿™ä¸ªé“¾è¡¨ä¸­ 13 list *selectors; /* A list of selectors this user validates commands 14 against. This list will always contain at least 15 one selector for backwards compatibility. */ 16 //ç¼“å­˜ACLå‘½ä»¤çš„å­—ç¬¦ä¸² 17 robj *acl_string; /* cached string represent of ACLs */ 18} user; 19 20 21//userä¸­ `selectors` é“¾è¡¨ä¸­çš„ç»“æ„ 22typedef struct { 23 //è¿™ä¸ª selectors çš„flag 24 uint32_t flags; /* See SELECTOR_FLAG_* */ 25 26 /* The bit in allowed_commands is set if this user has the right to 27 * execute this command. 28 * If the bit for a given command is NOT set and the command has 29 * allowed first-args, Redis will also check allowed_firstargs in order to 30 * understand if the command can be executed. */ 31 32 //ä½¿ç”¨ bit è®°å½•å…è®¸çš„å‘½ä»¤ 33 uint64_t allowed_commands[USER_COMMAND_BITS_COUNT/64]; 34 35 /* allowed_firstargs is used by ACL rules to block access to a command unless a 36 * specific argv[1] is given. 37 * 38 * For each command ID (corresponding to the command bit set in allowed_commands), 39 * This array points to an array of SDS strings, terminated by a NULL pointer, 40 * with all the first-args that are allowed for this command. When no first-arg 41 * matching is used, the field is just set to NULL to avoid allocating 42 * USER_COMMAND_BITS_COUNT pointers. */ 43 44 sds **allowed_firstargs; 45 46 //redis key åŒ¹é…è§„åˆ™çš„å­—ç¬¦ä¸²é“¾è¡¨ 47 list *patterns; /* A list of allowed key patterns. If this field is NULL 48 the user cannot mention any key in a command, unless 49 the flag ALLKEYS is set in the user. */ 50 51 //redis channels è§„åˆ™çš„å­—ç¬¦ä¸² é“¾è¡¨ 52 list *channels; /* A list of allowed Pub/Sub channel patterns. If this 53 field is NULL the user cannot mention any channel in a 54 `PUBLISH` or [P][UNSUBSCRIBE] command, unless the flag 55 ALLCHANNELS is set in the user. */ 56} aclSelector; 57 58 59/* Structure used for handling key patterns with different key 60 * based permissions. */ 61//`aclSelector` ä¸­ patterns é“¾è¡¨ä¸­çš„ç»“æ„ 62typedef struct { 63 int flags; /* The CMD_KEYS_* flags for this key pattern */ 64 sds pattern; /* The pattern to match keys against */ 65} keyPattern; useræºç \naclSelectoræºç \naclSelector ç»“æ„å…ˆæœ‰ä¸ªå¤§æ¦‚çš„äº†è§£å³å¯ï¼Œåé¢åœ¨æƒé™æ ¡éªŒçš„é‚£éƒ¨åˆ†ä¼šæœ‰è¯¦ç»†çš„åˆ†æ\nACLçš„åˆå§‹åŒ– ACLçš„åˆå§‹åŒ–åœ¨ACLInitå‡½æ•°ä¸­å®Œæˆ\n1void ACLInit(void) { 2 Users = raxNew(); 3 UsersToLoad = listCreate(); 4 listSetMatchMethod(UsersToLoad, ACLListMatchLoadedUser); 5 ACLLog = listCreate(); 6 DefaultUser = ACLCreateDefaultUser(); 7} ACLInit\nACLInitè¿™ä¸ªå‡½æ•°åœ¨ main å‡½æ•°ä¸­è¢«è°ƒç”¨ï¼Œä¹Ÿå°±æ˜¯åœ¨rediså¯åŠ¨çš„æ—¶å€™ï¼Œå°±ä¼šåˆå§‹åŒ–ACLçš„æ•°æ®ç»“æ„\næ‰€æœ‰çš„ç”¨æˆ·éƒ½å­˜åœ¨Usersè¿™ä¸ªå…¨å±€å˜é‡ä¸­ï¼Œè¿™ä¸ªå˜é‡æ˜¯raxç±»å‹çš„\nUsersToLoad è®°å½•äº†ä»é…ç½®æ–‡ä»¶ä¸­åŠ è½½çš„ç”¨æˆ·\nACLLog ACLæ“ä½œç›¸å…³çš„log\nDefaultUser ç‰¹æ®Šçš„ç”¨æˆ·ï¼Œdefaultç”¨æˆ·\nä¼šä½¿ç”¨ ACLCreateDefaultUser è¿™ä¸ªå‡½æ•°åˆå§‹åŒ–defaultè¿™ä¸ªç”¨æˆ·\n1user *ACLCreateDefaultUser(void) { 2 user *new = ACLCreateUser(\u0026#34;default\u0026#34;,7); 3 ACLSetUser(new,\u0026#34;+@all\u0026#34;,-1); 4 ACLSetUser(new,\u0026#34;~*\u0026#34;,-1); 5 ACLSetUser(new,\u0026#34;\u0026amp;*\u0026#34;,-1); 6 ACLSetUser(new,\u0026#34;on\u0026#34;,-1); 7 ACLSetUser(new,\u0026#34;nopass\u0026#34;,-1); 8 return new; 9} ACLCreateDefaultUser\nåˆ›å»ºä¸€ä¸ªç”¨æˆ·æ˜¯åœ¨ACLCreateUser è¿™ä¸ªå‡½æ•°ä¸­å®Œæˆçš„\n1user *ACLCreateUser(const char *name, size_t namelen) { 2 //å…ˆåˆ¤æ–­ä¸€ä¸‹è¿™ä¸ªé±¼æŠ¤æ˜¯å¦å­˜åœ¨,å¦‚æœå­˜åœ¨äº†ç›´æ¥return 3 if (raxFind(Users,(unsigned char*)name,namelen) != raxNotFound) return NULL; 4 user *u = zmalloc(sizeof(*u)); 5 u-\u0026gt;name = sdsnewlen(name,namelen); 6 //æ–°åˆ›å»ºçš„ç”¨æˆ·é»˜è®¤éƒ½æ˜¯ä¸èƒ½ä½¿ç”¨çš„ 7 u-\u0026gt;flags = USER_FLAG_DISABLED; 8 u-\u0026gt;passwords = listCreate(); 9 u-\u0026gt;acl_string = NULL; 10 listSetMatchMethod(u-\u0026gt;passwords,ACLListMatchSds); 11 listSetFreeMethod(u-\u0026gt;passwords,ACLListFreeSds); 12 listSetDupMethod(u-\u0026gt;passwords,ACLListDupSds); 13 14 u-\u0026gt;selectors = listCreate(); 15 listSetFreeMethod(u-\u0026gt;selectors,ACLListFreeSelector); 16 listSetDupMethod(u-\u0026gt;selectors,ACLListDuplicateSelector); 17 18 /* Add the initial root selector */ 19 aclSelector *s = ACLCreateSelector(SELECTOR_FLAG_ROOT); 20 listAddNodeHead(u-\u0026gt;selectors, s); 21 22 raxInsert(Users,(unsigned char*)name,namelen,u,NULL); 23 return u; 24} ACLCreateUser\nåˆ°è¿™ï¼Œdefault ç”¨æˆ·çš„åˆå§‹åŒ–å°±å®Œæˆäº†\nåé¢ä¼šä»é…ç½®æ–‡ä»¶ä¸­åŠ è½½å…¶ä»–ç”¨æˆ·çš„æ•°æ®ï¼Œå®Œæˆå…¶ä»–ç”¨æˆ·çš„åˆå§‹åŒ–\nåœ¨main å‡½æ•°ä¸­è°ƒç”¨ ACLLoadUsersAtStartup å®Œæˆä»é…ç½®æ–‡ä»¶ä¸­åŠ è½½ç”¨æˆ·\nåœ¨æ­¤ä¹‹å‰ä¼šå…ˆä½¿ç”¨ACLAppendUserForLoading å‡½æ•°å®Œæˆä» redis.conf ä¸­åŠ è½½ç”¨æˆ·ã€‚å› ä¸ºredisä¸­çš„ç”¨æˆ·æ—¢å¯ä»¥é…ç½®åœ¨redis.confä¸­ï¼Œä¹Ÿå¯ä»¥é…ç½®åœ¨ä¸€ä¸ªå•ç‹¬çš„ACLæ–‡ä»¶ä¸­ï¼ˆä¸¤è€…åªèƒ½é€‰æ‹©å…¶ä¸­ä¸€ä¸ªï¼Œä¸èƒ½åŒæ—¶å¯ç”¨ï¼‰ã€‚è¿™ä¸ªå‡½æ•°æ˜¯ä»redis.confä¸­åŠ è½½ç”¨æˆ·\næœ€ç»ˆæŠŠä»é…ç½®æ–‡ä»¶ä¸­åŠ è½½çš„ç”¨æˆ·éƒ½æ”¾åˆ°UsersToLoad è¿™ä¸ªé“¾è¡¨ä¸­\nACLAppendUserForLoading\nå®ŒæˆåŠ è½½åï¼Œä¼šè°ƒç”¨ACLLoadUsersAtStartup å®Œæˆç”¨æˆ·ä¿¡æ¯çš„åˆå§‹åŒ–\n1void ACLLoadUsersAtStartup(void) { 2 //å…ˆåˆ¤æ–­ä¸€ä¸‹,å¦‚æœé…ç½®äº†ACLæ–‡ä»¶çš„åŒæ—¶ï¼Œåˆåœ¨redis.conf ä¸­é…ç½®äº†ç”¨æˆ·ï¼Œé‚£ä¹ˆrediså¯åŠ¨ä¼šå¤±è´¥ 3 //ACLçš„é…ç½®åªèƒ½åœ¨ä¸€ä¸ªé‡Œé¢é…ç½® 4 if (server.acl_filename[0] != \u0026#39;\\0\u0026#39; \u0026amp;\u0026amp; listLength(UsersToLoad) != 0) { 5 serverLog(LL_WARNING, 6 \u0026#34;Configuring Redis with users defined in redis.conf and at \u0026#34; 7 \u0026#34;the same setting an ACL file path is invalid. This setup \u0026#34; 8 \u0026#34;is very likely to lead to configuration errors and security \u0026#34; 9 \u0026#34;holes, please define either an ACL file or declare users \u0026#34; 10 \u0026#34;directly in your redis.conf, but not both.\u0026#34;); 11 exit(1); 12 } 13 14 //å¤„ç†ä»redisé…ç½®æ–‡ä»¶ä¸­åŠ è½½çš„ç”¨æˆ· 15 if (ACLLoadConfiguredUsers() == C_ERR) { 16 serverLog(LL_WARNING, 17 \u0026#34;Critical error while loading ACLs. Exiting.\u0026#34;); 18 exit(1); 19 } 20 21 //å¤„ç†ä»aclæ–‡ä»¶ä¸­åŠ è½½çš„ç”¨æˆ· 22 if (server.acl_filename[0] != \u0026#39;\\0\u0026#39;) { 23 sds errors = ACLLoadFromFile(server.acl_filename); 24 if (errors) { 25 serverLog(LL_WARNING, 26 \u0026#34;Aborting Redis startup because of ACL errors: %s\u0026#34;, errors); 27 sdsfree(errors); 28 exit(1); 29 } 30 } 31} ACLLoadUsersAtStartup\nä»é…ç½®æ–‡ä»¶ä¸­åŠ è½½çš„é€»è¾‘ï¼Œéœ€è¦å®Œæˆç”¨æˆ·åŠ è½½å’Œç”¨æˆ·ä¿¡æ¯çš„åˆå§‹åŒ–ï¼ˆç”¨æˆ·çš„å¯†ç ï¼Œflagï¼Œselectorsè§„åˆ™ç­‰ï¼‰\n1int ACLLoadConfiguredUsers(void) { 2 listIter li; 3 listNode *ln; 4 listRewind(UsersToLoad,\u0026amp;li); 5 //éå†UsersToLoadè¿™ä¸ªé“¾è¡¨ å®Œæˆä¿¡æ¯åˆå§‹åŒ– 6 while ((ln = listNext(\u0026amp;li)) != NULL) { 7 sds *aclrules = listNodeValue(ln); 8 sds username = aclrules[0]; 9 10 if (ACLStringHasSpaces(aclrules[0],sdslen(aclrules[0]))) { 11 serverLog(LL_WARNING,\u0026#34;Spaces not allowed in ACL usernames\u0026#34;); 12 return C_ERR; 13 } 14 15 user *u = ACLCreateUser(username,sdslen(username)); 16 //åšç”¨æˆ·å»é‡ï¼Œä¸€ä¸ªç”¨æˆ·åªå…è®¸æœ‰ä¸€ä¸ª 17 if (!u) { 18 /* Only valid duplicate user is the default one. */ 19 serverAssert(!strcmp(username, \u0026#34;default\u0026#34;)); 20 u = ACLGetUserByName(\u0026#34;default\u0026#34;,7); 21 ACLSetUser(u,\u0026#34;reset\u0026#34;,-1); 22 } 23 24 /* Load every rule defined for this user. */ 25 26 //éå†å¾—åˆ°çš„è§„åˆ™ï¼ŒæŠŠè¿™äº›è§„åˆ™èµ‹ç»™userï¼Œå®Œæˆuserä¿¡æ¯çš„åˆå§‹åŒ– 27 for (int j = 1; aclrules[j]; j++) { 28 if (ACLSetUser(u,aclrules[j],sdslen(aclrules[j])) != C_OK) { 29 const char *errmsg = ACLSetUserStringError(); 30 serverLog(LL_WARNING,\u0026#34;Error loading ACL rule \u0026#39;%s\u0026#39; for \u0026#34; 31 \u0026#34;the user named \u0026#39;%s\u0026#39;: %s\u0026#34;, 32 aclrules[j],aclrules[0],errmsg); 33 return C_ERR; 34 } 35 } 36 37 /* Having a disabled user in the configuration may be an error, 38 * warn about it without returning any error to the caller. */ 39 //å®Œæˆä¿¡æ¯åˆå§‹å,åˆ¤æ–­ä¸€ä¸‹è¿™ä¸ªç”¨æˆ·æ˜¯ä¸æ˜¯è¿˜æ˜¯ä¸å¯ç”¨çš„ 40 if (u-\u0026gt;flags \u0026amp; USER_FLAG_DISABLED) { 41 serverLog(LL_NOTICE, \u0026#34;The user \u0026#39;%s\u0026#39; is disabled (there is no \u0026#34; 42 \u0026#34;\u0026#39;on\u0026#39; modifier in the user description). Make \u0026#34; 43 \u0026#34;sure this is not a configuration error.\u0026#34;, 44 aclrules[0]); 45 } 46 } 47 return C_OK; 48} ACLLoadConfiguredUsers\nä»ACLæ–‡ä»¶ä¸­åŠ è½½userä»£ç æ¯”è¾ƒå¤šï¼Œä¸‹é¢ä¼šæŠŠä¸€äº›ä¸é‡è¦çš„ï¼ˆæ¯”å¦‚æ–‡ä»¶åŠ è½½ç­‰ç­‰ï¼‰åˆ æ‰\n1sds ACLLoadFromFile(const char *filename) { 2 //è¿™é‡Œä¼šå…ˆæŠŠå…¨å±€çš„ Users ä¿å­˜åˆ° old_usersæŒ‡é’ˆ, 3 //ç„¶åé‡æ–° åˆå§‹åŒ–ä¸€ä¸ª User,åé¢åŠ è½½å¦‚æœå‡ºé”™äº†,å¯ä»¥å›æ»š 4 rax *old_users = Users; 5 Users = raxNew(); 6 7 //éå†æ–‡ä»¶ä¸­æ‰€æœ‰çš„è¡Œ,å¼€å§‹åŠ è½½user 8 for (int i = 0; i \u0026lt; totlines; i++) 9 ............ çœç•¥è¯»æ–‡ä»¶éƒ¨åˆ†............... 10 //åˆ›å»ºä¸€ä¸ªUser 11 user *u = ACLCreateUser(argv[1],sdslen(argv[1])); 12 13 //å¦‚æœç”¨æˆ·å·²ç»å­˜åœ¨äº†,è·³è¿‡ 14 if (!u) { 15 errors = sdscatprintf(errors,\u0026#34;WARNING: Duplicate user \u0026#39;%s\u0026#39; found on line %d. \u0026#34;, argv[1], linenum); 16 sdsfreesplitres(argv,argc); 17 continue; 18 } 19 20 /* Finally process the options and validate they can 21 * be cleanly applied to the user. If any option fails 22 * to apply, the other values won\u0026#39;t be applied since 23 * all the pending changes will get dropped. */ 24 int merged_argc; 25 26 //è¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯æŠŠè¯»åˆ°çš„å­—ç¬¦ä¸²,æå–æˆå…·ä½“çš„userå±æ€§çš„æ•°ç»„ 27 sds *acl_args = ACLMergeSelectorArguments(argv + 2, argc - 2, \u0026amp;merged_argc, NULL); 28 if (!acl_args) { 29 errors = sdscatprintf(errors, 30 \u0026#34;%s:%d: Unmatched parenthesis in selector definition.\u0026#34;, 31 server.acl_filename, linenum); 32 } 33 34 int syntax_error = 0; 35 for (int j = 0; j \u0026lt; merged_argc; j++) { 36 acl_args[j] = sdstrim(acl_args[j],\u0026#34;\\t\\r\\n\u0026#34;); 37 //éå†ä¸Šé¢å¾—åˆ°çš„æ‰‹åŠ¿,ç»™åˆ›å»ºçš„userè®¾ç½®å±æ€§ 38 if (ACLSetUser(u,acl_args[j],sdslen(acl_args[j])) != C_OK) { 39 const char *errmsg = ACLSetUserStringError(); 40 if (errno == ENOENT) { 41 /* For missing commands, we print out more information since 42 * it shouldn\u0026#39;t contain any sensitive information. */ 43 errors = sdscatprintf(errors, 44 \u0026#34;%s:%d: Error in applying operation \u0026#39;%s\u0026#39;: %s. \u0026#34;, 45 server.acl_filename, linenum, acl_args[j], errmsg); 46 } else if (syntax_error == 0) { 47 /* For all other errors, only print out the first error encountered 48 * since it might affect future operations. */ 49 errors = sdscatprintf(errors, 50 \u0026#34;%s:%d: %s. \u0026#34;, 51 server.acl_filename, linenum, errmsg); 52 syntax_error = 1; 53 } 54 } 55 } 56 57 for (int i = 0; i \u0026lt; merged_argc; i++) sdsfree(acl_args[i]); 58 zfree(acl_args); 59 60 /* Apply the rule to the new users set only if so far there 61 * are no errors, otherwise it\u0026#39;s useless since we are going 62 * to discard the new users set anyway. */ 63 if (sdslen(errors) != 0) { 64 sdsfreesplitres(argv,argc); 65 continue; 66 } 67 68 sdsfreesplitres(argv,argc); 69 } 70 71 sdsfreesplitres(lines,totlines); 72 73 /* Check if we found errors and react accordingly. */ 74 if (sdslen(errors) == 0) { 75 //åˆ¤æ–­ä¸€ä¸‹,æ˜¯å¦åŠ è½½äº†æ–°çš„`default` user,å¦‚æœæœ‰çš„è¯æŠŠæ—§çš„default useré‡Šæ”¾æ‰,ç”¨æ–°åŠ è½½çš„ 76 user *new_default = ACLGetUserByName(\u0026#34;default\u0026#34;,7); 77 if (!new_default) { 78 new_default = ACLCreateDefaultUser(); 79 } 80 81 ACLCopyUser(DefaultUser,new_default); 82 ACLFreeUser(new_default); 83 raxInsert(Users,(unsigned char*)\u0026#34;default\u0026#34;,7,DefaultUser,NULL); 84 raxRemove(old_users,(unsigned char*)\u0026#34;default\u0026#34;,7,NULL); 85 ACLFreeUsersSet(old_users); 86 sdsfree(errors); 87 return NULL; 88 } else { 89 //å¦‚æœå‡ºé”™äº†,æ•°æ®å›æ»š 90 ACLFreeUsersSet(Users); 91 Users = old_users; 92 errors = sdscat(errors,\u0026#34;WARNING: ACL errors detected, no change to the previously active ACL rules was performed\u0026#34;); 93 return errors; 94 } 95} ACLLoadFromFile\nä¸ç®¡æ˜¯ä» é…ç½®æ–‡ä»¶ä¸­åŠ è½½ç”¨æˆ·è¿˜æ˜¯ä»ACLæ–‡ä»¶ä¸­åŠ è½½ç”¨æˆ·ï¼Œæœ€ç»ˆéƒ½ä¼šè°ƒç”¨ACLSetUser è¿™ä¸ªå‡½æ•°æ¥å®Œæˆ user å±æ€§çš„åˆå§‹åŒ–ã€‚ä½¿ç”¨redisçš„ ACL å‘½ä»¤æ¥ç®¡ç†ç”¨æˆ·æ—¶ä¹Ÿæ˜¯é€šè¿‡è¿™ä¸ªå‡½æ•°æ¥å¤„ç†çš„ã€‚\n1int ACLSetUser(user *u, const char *op, ssize_t oplen) { 2 //ç¬¬ä¸€æ­¥,å…ˆæŠŠä»¥å‰çš„å±æ€§å­—ç¬¦ä¸²åˆ æ‰ 3 if (u-\u0026gt;acl_string) { 4 decrRefCount(u-\u0026gt;acl_string); 5 u-\u0026gt;acl_string = NULL; 6 } 7 8 if (oplen == -1) oplen = strlen(op); 9 if (oplen == 0) return C_OK; /* Empty string is a no-operation. */ 10 if (!strcasecmp(op,\u0026#34;on\u0026#34;)) { 11 //è®¾ç½® user æ˜¯ å¼€å¯çš„ 12 u-\u0026gt;flags |= USER_FLAG_ENABLED; 13 u-\u0026gt;flags \u0026amp;= ~USER_FLAG_DISABLED; 14 } else if (!strcasecmp(op,\u0026#34;off\u0026#34;)) { 15 //è®¾ç½® user æ˜¯å…³é—­çš„ 16 u-\u0026gt;flags |= USER_FLAG_DISABLED; 17 u-\u0026gt;flags \u0026amp;= ~USER_FLAG_ENABLED; 18 } else if (!strcasecmp(op,\u0026#34;skip-sanitize-payload\u0026#34;)) { 19 u-\u0026gt;flags |= USER_FLAG_SANITIZE_PAYLOAD_SKIP; 20 u-\u0026gt;flags \u0026amp;= ~USER_FLAG_SANITIZE_PAYLOAD; 21 } else if (!strcasecmp(op,\u0026#34;sanitize-payload\u0026#34;)) { 22 u-\u0026gt;flags \u0026amp;= ~USER_FLAG_SANITIZE_PAYLOAD_SKIP; 23 u-\u0026gt;flags |= USER_FLAG_SANITIZE_PAYLOAD; 24 } else if (!strcasecmp(op,\u0026#34;nopass\u0026#34;)) { 25 u-\u0026gt;flags |= USER_FLAG_NOPASS; 26 listEmpty(u-\u0026gt;passwords); 27 } else if (!strcasecmp(op,\u0026#34;resetpass\u0026#34;)) { 28 u-\u0026gt;flags \u0026amp;= ~USER_FLAG_NOPASS; 29 listEmpty(u-\u0026gt;passwords); 30 } else if (op[0] == \u0026#39;\u0026gt;\u0026#39; || op[0] == \u0026#39;#\u0026#39;) { 31 //è®¾ç½®å¯†ç  32 sds newpass; 33 if (op[0] == \u0026#39;\u0026gt;\u0026#39;) { 34 //å¦‚æœæ˜¯æ˜æ–‡,å…ˆè½¬æˆsha256å­—ç¬¦ä¸² 35 newpass = ACLHashPassword((unsigned char*)op+1,oplen-1); 36 } else { 37 //åˆ¤æ–­ä¸€ä¸‹è¾“å…¥çš„å€¼æ˜¯ä¸æ˜¯æœ‰æ•ˆçš„hashå€¼ 38 if (ACLCheckPasswordHash((unsigned char*)op+1,oplen-1) == C_ERR) { 39 errno = EBADMSG; 40 return C_ERR; 41 } 42 newpass = sdsnewlen(op+1,oplen-1); 43 } 44 45 listNode *ln = listSearchKey(u-\u0026gt;passwords,newpass); 46 //å¦‚æœä¹‹å‰æœ‰è¿™ä¸ªå¯†ç ,ä¸ç”¨æ·»åŠ äº†,é¿å…åŒä¸€ä¸ªå¯†ç æ·»åŠ å¤šæ¬¡ 47 if (ln == NULL) 48 listAddNodeTail(u-\u0026gt;passwords,newpass); 49 else 50 sdsfree(newpass); 51 u-\u0026gt;flags \u0026amp;= ~USER_FLAG_NOPASS; 52 } else if (op[0] == \u0026#39;\u0026lt;\u0026#39; || op[0] == \u0026#39;!\u0026#39;) { 53 //åˆ é™¤å¯†ç ,åŒæ ·çš„,å¦‚æœæ˜¯æ˜æ–‡,å…ˆè½¬æˆsha256å­—ç¬¦ä¸² 54 sds delpass; 55 if (op[0] == \u0026#39;\u0026lt;\u0026#39;) { 56 delpass = ACLHashPassword((unsigned char*)op+1,oplen-1); 57 } else { 58 //åŒæ ·,åˆ¤æ–­è¿™ä¸ªå­—ç¬¦ä¸²æ˜¯ä¸æ˜¯æœ‰æ•ˆçš„hashå€¼ 59 if (ACLCheckPasswordHash((unsigned char*)op+1,oplen-1) == C_ERR) { 60 errno = EBADMSG; 61 return C_ERR; 62 } 63 delpass = sdsnewlen(op+1,oplen-1); 64 } 65 listNode *ln = listSearchKey(u-\u0026gt;passwords,delpass); 66 sdsfree(delpass); 67 if (ln) { 68 listDelNode(u-\u0026gt;passwords,ln); 69 } else { 70 errno = ENODEV; 71 return C_ERR; 72 } 73 } else if (op[0] == \u0026#39;(\u0026#39; \u0026amp;\u0026amp; op[oplen - 1] == \u0026#39;)\u0026#39;) { 74 //å¤„ç† `()` å†…çš„ selector 75 aclSelector *selector = aclCreateSelectorFromOpSet(op, oplen); 76 if (!selector) { 77 /* No errorno set, propagate it from interior error. */ 78 return C_ERR; 79 } 80 listAddNodeTail(u-\u0026gt;selectors, selector); 81 return C_OK; 82 } else if (!strcasecmp(op,\u0026#34;clearselectors\u0026#34;)) { 83 //æ¸…ç†æ‰æ‰€æœ‰çš„ selector 84 listIter li; 85 listNode *ln; 86 listRewind(u-\u0026gt;selectors,\u0026amp;li); 87 /* There has to be a root selector */ 88 serverAssert(listNext(\u0026amp;li)); 89 while((ln = listNext(\u0026amp;li))) { 90 listDelNode(u-\u0026gt;selectors, ln); 91 } 92 return C_OK; 93 } else if (!strcasecmp(op,\u0026#34;reset\u0026#34;)) { 94 //é‡ç½®è¿™ä¸ªç”¨æˆ· 95 serverAssert(ACLSetUser(u,\u0026#34;resetpass\u0026#34;,-1) == C_OK); 96 serverAssert(ACLSetUser(u,\u0026#34;resetkeys\u0026#34;,-1) == C_OK); 97 serverAssert(ACLSetUser(u,\u0026#34;resetchannels\u0026#34;,-1) == C_OK); 98 if (server.acl_pubsub_default \u0026amp; SELECTOR_FLAG_ALLCHANNELS) 99 serverAssert(ACLSetUser(u,\u0026#34;allchannels\u0026#34;,-1) == C_OK); 100 serverAssert(ACLSetUser(u,\u0026#34;off\u0026#34;,-1) == C_OK); 101 serverAssert(ACLSetUser(u,\u0026#34;sanitize-payload\u0026#34;,-1) == C_OK); 102 serverAssert(ACLSetUser(u,\u0026#34;clearselectors\u0026#34;,-1) == C_OK); 103 serverAssert(ACLSetUser(u,\u0026#34;-@all\u0026#34;,-1) == C_OK); 104 } else { 105 //å¤„ç†ç”¨æˆ·çš„ selector è®¾ç½®, æ¯”å¦‚ `+@, -@, \u0026amp;, ~*` ç­‰ç­‰å‘½ä»¤ 106 aclSelector *selector = ACLUserGetRootSelector(u); 107 if (ACLSetSelector(selector, op, oplen) == C_ERR) { 108 return C_ERR; 109 } 110 } 111 return C_OK; 112} aclCreateSelectorFromOpSet è¿™ä¸ªå‡½æ•°æœ€ç»ˆä¼šè°ƒç”¨ ACLSetSelector æ¥æŠŠå­—ç¬¦ä¸²è½¬æ¢æˆå…·ä½“çš„è§„åˆ™\nACLSetSelector\n1int ACLSetSelector(aclSelector *selector, const char* op, size_t oplen) { 2 if (!strcasecmp(op,\u0026#34;allkeys\u0026#34;) || !strcasecmp(op,\u0026#34;~*\u0026#34;)) { 3 //å…è®¸æ‰€æœ‰key 4 selector-\u0026gt;flags |= SELECTOR_FLAG_ALLKEYS; 5 listEmpty(selector-\u0026gt;patterns); 6 } else if (!strcasecmp(op,\u0026#34;resetkeys\u0026#34;)) { 7 //å»æ‰æ‰€æœ‰keyæƒé™ 8 selector-\u0026gt;flags \u0026amp;= ~SELECTOR_FLAG_ALLKEYS; 9 listEmpty(selector-\u0026gt;patterns); 10 } else if (!strcasecmp(op,\u0026#34;allchannels\u0026#34;) || !strcasecmp(op,\u0026#34;\u0026amp;*\u0026#34;)) { 11 //channel å’Œkeyä¸€æ ·,å…è®¸æ‰€æœ‰å’Œå»æ‰æ‰€æœ‰ 12 selector-\u0026gt;flags |= SELECTOR_FLAG_ALLCHANNELS; 13 listEmpty(selector-\u0026gt;channels); 14 } else if (!strcasecmp(op,\u0026#34;resetchannels\u0026#34;)) { 15 selector-\u0026gt;flags \u0026amp;= ~SELECTOR_FLAG_ALLCHANNELS; 16 listEmpty(selector-\u0026gt;channels); 17 } else if (!strcasecmp(op,\u0026#34;allcommands\u0026#34;) || !strcasecmp(op,\u0026#34;+@all\u0026#34;)) { 18 //å…è®¸æ‰€æœ‰çš„æƒé™, ä¸‹é¢æ˜¯å»æ‰æ‰€æœ‰æƒé™ 19 memset(selector-\u0026gt;allowed_commands,255,sizeof(selector-\u0026gt;allowed_commands)); 20 selector-\u0026gt;flags |= SELECTOR_FLAG_ALLCOMMANDS; 21 ACLResetFirstArgs(selector); 22 } else if (!strcasecmp(op,\u0026#34;nocommands\u0026#34;) || !strcasecmp(op,\u0026#34;-@all\u0026#34;)) { 23 memset(selector-\u0026gt;allowed_commands,0,sizeof(selector-\u0026gt;allowed_commands)); 24 selector-\u0026gt;flags \u0026amp;= ~SELECTOR_FLAG_ALLCOMMANDS; 25 ACLResetFirstArgs(selector); 26 } else if (op[0] == \u0026#39;~\u0026#39; || op[0] == \u0026#39;%\u0026#39;) { 27 if (selector-\u0026gt;flags \u0026amp; SELECTOR_FLAG_ALLKEYS) { 28 //å¦‚æœæ˜¯å…è®¸æ‰€æœ‰keyäº†, å†åŠ é™åˆ¶keyçš„å‘½ä»¤,ä¼šè¿”å›é”™è¯¯ 29 errno = EEXIST; 30 return C_ERR; 31 } 32 int flags = 0; 33 size_t offset = 1; 34 if (op[0] == \u0026#39;%\u0026#39;) { 35 //å¦‚æœæ˜¯%å¼€å¤´,éœ€è¦åˆ¤æ–­æ˜¯è¯»è¿˜æ˜¯å†™ 36 for (; offset \u0026lt; oplen; offset++) { 37 if (toupper(op[offset]) == \u0026#39;R\u0026#39; \u0026amp;\u0026amp; !(flags \u0026amp; ACL_READ_PERMISSION)) { 38 flags |= ACL_READ_PERMISSION; 39 } else if (toupper(op[offset]) == \u0026#39;W\u0026#39; \u0026amp;\u0026amp; !(flags \u0026amp; ACL_WRITE_PERMISSION)) { 40 flags |= ACL_WRITE_PERMISSION; 41 } else if (op[offset] == \u0026#39;~\u0026#39;) { 42 offset++; 43 break; 44 } else { 45 errno = EINVAL; 46 return C_ERR; 47 } 48 } 49 } else { 50 flags = ACL_ALL_PERMISSION; 51 } 52 53 if (ACLStringHasSpaces(op+offset,oplen-offset)) { 54 errno = EINVAL; 55 return C_ERR; 56 } 57 keyPattern *newpat = ACLKeyPatternCreate(sdsnewlen(op+offset,oplen-offset), flags); 58 listNode *ln = listSearchKey(selector-\u0026gt;patterns,newpat); 59 //é¿å…é‡å¤ 60 if (ln == NULL) { 61 listAddNodeTail(selector-\u0026gt;patterns,newpat); 62 } else { 63 //å¦‚æœæœ‰é‡å¤çš„. åˆå¹¶ä¸¤ä¸ªpatternçš„flag 64 ((keyPattern *)listNodeValue(ln))-\u0026gt;flags |= flags; 65 ACLKeyPatternFree(newpat); 66 } 67 selector-\u0026gt;flags \u0026amp;= ~SELECTOR_FLAG_ALLKEYS; 68 } else if (op[0] == \u0026#39;\u0026amp;\u0026#39;) { 69 if (selector-\u0026gt;flags \u0026amp; SELECTOR_FLAG_ALLCHANNELS) { 70 //åŒæ ·,å¦‚æœå·²ç»å…è®¸æ‰€æœ‰channeläº†,å†å»é™åˆ¶channel,ä¹Ÿä¼šæŠ¥é”™ 71 errno = EISDIR; 72 return C_ERR; 73 } 74 if (ACLStringHasSpaces(op+1,oplen-1)) { 75 errno = EINVAL; 76 return C_ERR; 77 } 78 sds newpat = sdsnewlen(op+1,oplen-1); 79 listNode *ln = listSearchKey(selector-\u0026gt;channels,newpat); 80 //åŒæ ·,ä¹Ÿä¼šå¯¹channel pattern å»é‡ 81 if (ln == NULL) 82 listAddNodeTail(selector-\u0026gt;channels,newpat); 83 else 84 sdsfree(newpat); 85 selector-\u0026gt;flags \u0026amp;= ~SELECTOR_FLAG_ALLCHANNELS; 86 } else if (op[0] == \u0026#39;+\u0026#39; \u0026amp;\u0026amp; op[1] != \u0026#39;@\u0026#39;) { 87 //åŠ å‘½ä»¤æƒé™ (æ²¡æœ‰åœ¨ ACL CATåˆ†ç±»é‡Œçš„) 88 //å¦‚æœä¸€ä¸ªå‘½ä»¤æ²¡æœ‰åœ¨åˆ†ç±»é‡Œ,å¯ä»¥é€šè¿‡å‰ç¼€æ¥åšåŒ¹é…,æ¯”å¦‚ 89 //DBæä¾›æ‰§è¡ŒSELECTçš„èƒ½åŠ›ï¼Œä½†å¯èƒ½ä»ç„¶å¸Œæœ›èƒ½å¤Ÿè¿è¡ŒSELECT 0ã€‚ 90 //ACL SETUSER myuser -select +select|0 91 if (strrchr(op,\u0026#39;|\u0026#39;) == NULL) { 92 //å¦‚æœopå­—ç¬¦ä¸²ä¸­æ²¡æœ‰ `|` ä¸éœ€è¦å¤„ç†å‰ç¼€, ç›´æ¥å¤„ç†å³å¯ 93 //éœ€è¦å…ˆå¤„ç†ä¸€ä¸‹é‡å‘½åçš„å‘½ä»¤ 94 struct redisCommand *cmd = ACLLookupCommand(op+1); 95 if (cmd == NULL) { 96 errno = ENOENT; 97 return C_ERR; 98 } 99 //å¤„ç†ç¦ç”¨å’Œå…è®¸çš„å‘½ä»¤,åŒ…æ‹¬å­å‘½ä»¤ 100 ACLChangeSelectorPerm(selector,cmd,1); 101 } else { 102 //åˆ†å‰²å­—ç¬¦ä¸²,å¾—åˆ°å­å‘½ä»¤ 103 char *copy = zstrdup(op+1); 104 char *sub = strrchr(copy,\u0026#39;|\u0026#39;); 105 sub[0] = \u0026#39;\\0\u0026#39;; 106 sub++; 107 108 struct redisCommand *cmd = ACLLookupCommand(copy); 109 110 /* Check if the command exists. We can\u0026#39;t check the 111 * first-arg to see if it is valid. */ 112 if (cmd == NULL) { 113 zfree(copy); 114 errno = ENOENT; 115 return C_ERR; 116 } 117 118 //ä¸èƒ½ç›´æ¥ä½œç”¨äºå­å‘½ä»¤ 119 if (cmd-\u0026gt;parent) { 120 zfree(copy); 121 errno = ECHILD; 122 return C_ERR; 123 } 124 125 //å­å‘½ä»¤ä¸èƒ½æ˜¯ç©ºçš„,æ¯”å¦‚ `HASH|` è¿™ç§æ˜¯ä¸åˆæ³•çš„ 126 if (strlen(sub) == 0) { 127 zfree(copy); 128 errno = EINVAL; 129 return C_ERR; 130 } 131 132 if (cmd-\u0026gt;subcommands_dict) { 133 //è¿™ä¸ªå‘½ä»¤æœ‰å­å‘½ä»¤,å¤„ç†å­å‘½ä»¤ 134 cmd = ACLLookupCommand(op+1); 135 if (cmd == NULL) { 136 zfree(copy); 137 errno = ENOENT; 138 return C_ERR; 139 } 140 ACLChangeSelectorPerm(selector,cmd,1); 141 } else { 142 /* If user is trying to use the ACL mech to block SELECT except SELECT 0 or 143 * block DEBUG except DEBUG OBJECT (DEBUG subcommands are not considered 144 * subcommands for now) we use the allowed_firstargs mechanism. */ 145 146 /* Add the first-arg to the list of valid ones. */ 147 serverLog(LL_WARNING, \u0026#34;Deprecation warning: Allowing a first arg of an otherwise \u0026#34; 148 \u0026#34;blocked command is a misuse of ACL and may get disabled \u0026#34; 149 \u0026#34;in the future (offender: +%s)\u0026#34;, op+1); 150 ACLAddAllowedFirstArg(selector,cmd-\u0026gt;id,sub); 151 } 152 153 zfree(copy); 154 } 155 } else if (op[0] == \u0026#39;-\u0026#39; \u0026amp;\u0026amp; op[1] != \u0026#39;@\u0026#39;) { 156 //å»æ‰ å‘½ä»¤æƒé™ (æ²¡æœ‰åœ¨ ACL CATåˆ†ç±»é‡Œçš„) 157 struct redisCommand *cmd = ACLLookupCommand(op+1); 158 if (cmd == NULL) { 159 errno = ENOENT; 160 return C_ERR; 161 } 162 ACLChangeSelectorPerm(selector,cmd,0); 163 } else if ((op[0] == \u0026#39;+\u0026#39; || op[0] == \u0026#39;-\u0026#39;) \u0026amp;\u0026amp; op[1] == \u0026#39;@\u0026#39;) { 164 //åŠ æˆ–è€…å‡æƒé™ (åªå¤„ç†åœ¨ACL CATåˆ†ç±»é‡Œçš„) 165 int bitval = op[0] == \u0026#39;+\u0026#39; ? 1 : 0; 166 if (ACLSetSelectorCommandBitsForCategory(selector,op+2,bitval) == C_ERR) { 167 errno = ENOENT; 168 return C_ERR; 169 } 170 } else { 171 errno = EINVAL; 172 return C_ERR; 173 } 174 return C_OK; 175} æƒé™è®¾ç½®ç›¸å…³çš„å·®ä¸å¤šå°±æ˜¯è¿™äº›äº†ï¼ŒåŸºæœ¬éƒ½æ˜¯å¾—åˆ°å­—ç¬¦ä¸²åï¼Œå¤„ç†å­—ç¬¦ä¸²ï¼Œç„¶åå¤„ç†å¯¹åº”çš„æƒé™ã€‚ä»£ç é‡ä¸å°ï¼Œå…¶ä¸­ä¸€äº›ç»†èŠ‚æ²¡æœ‰è¯¦ç»†å±•å¼€åˆ†æï¼Œé€»è¾‘éƒ½ä¸å¤ªå¤æ‚ï¼Œåé¢æœ‰æ—¶é—´ä¼šè€ƒè™‘æŠŠè¿™é‡Œçš„å‘å¡«ä¸Šã€‚\nACLè§„åˆ™å­˜å‚¨ ä½¿ç”¨ ACL SETUSER å‘½ä»¤è®¾ç½®çš„è§„åˆ™ï¼Œé»˜è®¤åªä¼šå­˜åœ¨å†…å­˜ä¸­ï¼Œå¦‚æœæ²¡æœ‰è°ƒç”¨ACL SAVEå‘½ä»¤è¿›è¡Œå­˜å‚¨ï¼Œredisé‡å¯åä¼šä¸¢å¤±æ‰€æœ‰ ç”¨æˆ·ä¿¡æ¯\nä½¿ç”¨ACL SAVE å‘½ä»¤çš„å‰ææ˜¯ redis é…ç½®äº† ACL æ–‡ä»¶ï¼Œå¦‚æœæ²¡æœ‰é…ç½® ACL æ–‡ä»¶ï¼Œé‚£ä¹ˆ ä½¿ç”¨ ACL SAVEå‘½ä»¤ä¼šæŠ¥é”™\nä½¿ç”¨ ACL SAVE å’Œ ACL LISTæœ€ç»ˆéƒ½ä¼šè°ƒç”¨è¿™ä¸ªå‡½æ•°æ¥ç”Ÿæˆ ACL è§„åˆ™çš„å­—ç¬¦ä¸²\nACLDescribeUser\n1robj *ACLDescribeUser(user *u) { 2 if (u-\u0026gt;acl_string) { 3 incrRefCount(u-\u0026gt;acl_string); 4 return u-\u0026gt;acl_string; 5 } 6 7 sds res = sdsempty(); 8 9 å…ˆå¤„ç†flag 10 for (int j = 0; ACLUserFlags[j].flag; j++) { 11 if (u-\u0026gt;flags \u0026amp; ACLUserFlags[j].flag) { 12 res = sdscat(res,ACLUserFlags[j].name); 13 res = sdscatlen(res,\u0026#34; \u0026#34;,1); 14 } 15 } 16 17 //å¤„ç†å¯†ç  18 listIter li; 19 listNode *ln; 20 listRewind(u-\u0026gt;passwords,\u0026amp;li); 21 while((ln = listNext(\u0026amp;li))) { 22 sds thispass = listNodeValue(ln); 23 res = sdscatlen(res,\u0026#34;#\u0026#34;,1); 24 res = sdscatsds(res,thispass); 25 res = sdscatlen(res,\u0026#34; \u0026#34;,1); 26 } 27 28 //ç”Ÿæˆ selectorçš„è§„åˆ™å­—ç¬¦ä¸² 29 listRewind(u-\u0026gt;selectors,\u0026amp;li); 30 while((ln = listNext(\u0026amp;li))) { 31 aclSelector *selector = (aclSelector *) listNodeValue(ln); 32 //é€šè¿‡ ACLDescribeSelector ç”Ÿæˆ selectorçš„è§„åˆ™å­—ç¬¦ä¸² 33 //è¿™é‡Œé¢çš„å¤„ç†å¦‚æœè¯¦ç»†æ¥æ‹†åˆ†çš„è¯,è¿˜æ˜¯æœ‰ç‚¹å¤šçš„,å°±ä¸å±•å¼€äº† 34 sds default_perm = ACLDescribeSelector(selector); 35 //è¿™é‡Œéœ€è¦æ³¨æ„ä¸€ä¸‹, å¦‚æœæ˜¯éroot selector, è§„åˆ™éœ€è¦ç”¨ () åŒ…è£¹ 36 if (selector-\u0026gt;flags \u0026amp; SELECTOR_FLAG_ROOT) { 37 res = sdscatfmt(res, \u0026#34;%s\u0026#34;, default_perm); 38 } else { 39 res = sdscatfmt(res, \u0026#34; (%s)\u0026#34;, default_perm); 40 } 41 sdsfree(default_perm); 42 } 43 44 u-\u0026gt;acl_string = createObject(OBJ_STRING, res); 45 /* because we are returning it, have to increase count */ 46 incrRefCount(u-\u0026gt;acl_string); 47 48 return u-\u0026gt;acl_string; 49} ACLé‰´æƒ ä¸‹é¢å¼€å§‹åˆ†æ é‰´æƒç›¸å…³çš„ä»£ç ã€‚\nä¸Šé¢çš„åŸºæœ¬æ˜¯å’Œæƒé™è®¾ç½®ç›¸å…³çš„ï¼Œæœ‰äº†æƒé™åï¼Œè¦æ‰§è¡Œå‘½ä»¤æ—¶ï¼Œéœ€è¦åˆ¤æ–­æ˜¯å¦å¯ä»¥æ‰§è¡Œï¼Œè¿™éƒ¨åˆ†å°±æ˜¯é‰´æƒäº†ã€‚\nå…ˆæ¥æœ€åŸºæœ¬çš„ AUTH å‘½ä»¤\nauthCommand\nAUTH å‘½ä»¤å…¼å®¹ä»¥å‰çš„å‘½ä»¤å‚æ•°ï¼Œä¼šæ ¹æ®å‚æ•°çš„ä¸ªæ•°åˆ¤æ–­å‘½åçš„ç‰ˆæœ¬ï¼Œå¦‚æœå‚æ•°é•¿åº¦æ˜¯2ï¼Œä¼šä½¿ç”¨ä»¥å‰çš„æ¨¡å¼æ¥å¤„ç†ã€‚\nå¦‚æœå‚æ•°é•¿åº¦æ˜¯3ï¼Œä¼šæŒ‰ç…§ACLçš„æ¨¡å¼æ¥å¤„ç†\n1void authCommand(client *c) { 2 //å¦‚æœå‚æ•°\u0026gt;3äº†è¿™ä¸ªå‘½ä»¤æ˜¯é”™è¯¯çš„,ç›´æ¥è¿”å› 3 if (c-\u0026gt;argc \u0026gt; 3) { 4 addReplyErrorObject(c,shared.syntaxerr); 5 return; 6 } 7 redactClientCommandArgument(c, 1); 8 9 /* Handle the two different forms here. The form with two arguments 10 * will just use \u0026#34;default\u0026#34; as username. */ 11 robj *username, *password; 12 if (c-\u0026gt;argc == 2) { 13 //å¤„ç†ä¸¤ç§å‚æ•°çš„æƒ…å†µ,å¦‚æœé»˜è®¤ç”¨æˆ·æ˜¯æ²¡æœ‰å¯†ç çš„, è¿”å›é”™è° 14 if (DefaultUser-\u0026gt;flags \u0026amp; USER_FLAG_NOPASS) { 15 addReplyError(c,\u0026#34;AUTH \u0026lt;password\u0026gt; called without any password \u0026#34; 16 \u0026#34;configured for the default user. Are you sure \u0026#34; 17 \u0026#34;your configuration is correct?\u0026#34;); 18 return; 19 } 20 21 username = shared.default_username; 22 password = c-\u0026gt;argv[1]; 23 } else { 24 //å¤„ç†ä¸‰ç§å‚æ•°çš„æƒ…å†µ 25 username = c-\u0026gt;argv[1]; 26 password = c-\u0026gt;argv[2]; 27 redactClientCommandArgument(c, 2); 28 } 29 //æ ¡éªŒç”¨æˆ·åå’Œå¯†ç æ˜¯å¦åŒ¹é… 30 if (ACLAuthenticateUser(c,username,password) == C_OK) { 31 addReply(c,shared.ok); 32 } else { 33 addReplyError(c,\u0026#34;-WRONGPASS invalid username-password pair or user is disabled.\u0026#34;); 34 } 35} AUTH å‘½ä»¤å¤„ç†è¿˜æ˜¯æŒºç®€å•çš„ï¼Œä¸‹é¢å¼€å§‹ACLå¯¹å…·ä½“å‘½ä»¤çš„åˆ¤æ–­\nå½“ä¸€ä¸ªå‘½ä»¤è¿›æ¥åï¼Œredisè¦å…ˆåˆ¤æ–­å‘½ä»¤æ˜¯å¦èƒ½æ‰§è¡Œï¼Œä» server.c:3769 å¼€å§‹ï¼Œè°ƒç”¨ACLCheckAllPermå‡½æ•°ã€‚\næœ€ç»ˆä¼šè°ƒç”¨åˆ° ACLCheckAllUserCommandPerm å‡½æ•°å»åšå…·ä½“çš„æ ¡éªŒé€»è¾‘\nä¼šéå†userçš„ Selectors è¿™ä¸ªé“¾è¡¨æ¥åšé‰´æƒ\n1 listRewind(u-\u0026gt;selectors,\u0026amp;li); 2 while((ln = listNext(\u0026amp;li))) { 3 aclSelector *s = (aclSelector *) listNodeValue(ln); 4 int acl_retval = ACLSelectorCheckCmd(s, cmd, argv, argc, \u0026amp;local_idxptr, \u0026amp;cache); 5 if (acl_retval == ACL_OK) { 6 //å¦‚æœé€šè¿‡æ ¡éªŒäº†,å¯ä»¥ç»“æŸå¾ªç¯,ç„¶åè¿”å›æ­£ç¡® 7 cleanupACLKeyResultCache(\u0026amp;cache); 8 return ACL_OK; 9 } 10 if (acl_retval \u0026gt; relevant_error || 11 (acl_retval == relevant_error \u0026amp;\u0026amp; local_idxptr \u0026gt; last_idx)) 12 { 13 relevant_error = acl_retval; 14 last_idx = local_idxptr; 15 } 16 } åšé‰´æƒåˆ¤æ–­çš„æ˜¯è¿™ä¸ªå‡½æ•°ACLSelectorCheckCmd\nACLSelectorCheckCmd\né‰´æƒçš„ä¼˜å…ˆçº§\nåˆ¤æ–­å‘½ä»¤ç±»å‹ï¼Œæ¯”å¦‚GET,SET,HGET ç­‰ç­‰,åˆ¤æ–­æ˜¯å¦æœ‰è¿™ä¸ªç±»å‹å‘½ä»¤çš„æƒé™ åˆ¤æ–­keyåï¼Œé€šè¿‡å¯¹æ¯”keyçš„åå­—ï¼Œåˆ¤æ–­è¿™ä¸ªkeyæ˜¯å¦æœ‰æƒé™ åˆ¤æ–­æ˜¯å¦æ˜¯channelå‘½ä»¤ï¼Œç„¶ååˆ¤æ–­æƒé™ 1static int ACLSelectorCheckCmd(aclSelector *selector, struct redisCommand *cmd, robj **argv, int argc, int *keyidxptr, aclKeyResultCache *cache) { 2 uint64_t id = cmd-\u0026gt;id; 3 int ret; 4 //å¦‚æœ flags ä¸æ˜¯å…¨éƒ¨ ALLCOMMANDS å¹¶ä¸” è¿™ä¸ªå‘½ä»¤ä¸æ˜¯ä¸éœ€è¦éªŒè¯çš„å‘½ä»¤(è¿™ä¸ªå‘½ä»¤éœ€è¦authåæ‰èƒ½ä½¿ç”¨) 5 //CMD_NO_AUTHå‘½ä»¤åŒ…æ‹¬ `auth`,`hello`,`quit`,`reset` 6 if (!(selector-\u0026gt;flags \u0026amp; SELECTOR_FLAG_ALLCOMMANDS) \u0026amp;\u0026amp; !(cmd-\u0026gt;flags \u0026amp; CMD_NO_AUTH)) { 7 //å¦‚æœå‘½ä»¤bité‡Œæ²¡æœ‰æ‰¾åˆ°,éœ€è¦å†å»åŒ¹é…ä¸€ä¸‹å‰ç¼€,é˜²æ­¢æ¼åˆ¤ 8 if (ACLGetSelectorCommandBit(selector,id) == 0) { 9 /* Check if the first argument matches. */ 10 if (argc \u0026lt; 2 || 11 selector-\u0026gt;allowed_firstargs == NULL || 12 selector-\u0026gt;allowed_firstargs[id] == NULL) 13 { 14 return ACL_DENIED_CMD; 15 } 16 17 long subid = 0; 18 //éå†,æ¯”è¾ƒå‰ç¼€ 19 while (1) { 20 if (selector-\u0026gt;allowed_firstargs[id][subid] == NULL) 21 return ACL_DENIED_CMD; 22 int idx = cmd-\u0026gt;parent ? 2 : 1; 23 if (!strcasecmp(argv[idx]-\u0026gt;ptr,selector-\u0026gt;allowed_firstargs[id][subid])) 24 break; /* First argument match found. Stop here. */ 25 subid++; 26 } 27 } 28 } 29 30 //å¦‚æœä¸æ˜¯å…è®¸æ‰€æœ‰çš„key å¹¶ä¸”è¿™ä¸ªå‘½ä»¤é‡Œ åŒ…å«äº†key 31 //æ’é™¤ç±»ä¼¼ select 0 ç­‰ç­‰æ²¡æœ‰keyæ“ä½œçš„å‘½ä»¤ 32 if (!(selector-\u0026gt;flags \u0026amp; SELECTOR_FLAG_ALLKEYS) \u0026amp;\u0026amp; doesCommandHaveKeys(cmd)) { 33 //è¿™é‡Œæœ‰ä¸€ä¸ªä»å‡½æ•°å¤–ä¼ è¿›æ¥çš„,ç”¨æ¥ç¼“å­˜key çš„ç»“æ„, å¦‚æœæ²¡æœ‰åˆå§‹åŒ–è¿‡,éœ€è¦åˆå§‹åŒ–ä¸€ä¸‹ 34 if (!(cache-\u0026gt;keys_init)) { 35 cache-\u0026gt;keys = (getKeysResult) GETKEYS_RESULT_INIT; 36 //è·å–åˆ°è¿™æ¡å‘½ä»¤ä¸­æ‰€æœ‰çš„key 37 getKeysFromCommandWithSpecs(cmd, argv, argc, GET_KEYSPEC_DEFAULT, \u0026amp;(cache-\u0026gt;keys)); 38 cache-\u0026gt;keys_init = 1; 39 } 40 getKeysResult *result = \u0026amp;(cache-\u0026gt;keys); 41 keyReference *resultidx = result-\u0026gt;keys; 42 for (int j = 0; j \u0026lt; result-\u0026gt;numkeys; j++) { 43 int idx = resultidx[j].pos; 44 //é€šè¿‡éå†æ‰€æœ‰çš„key,åˆ¤æ–­æ˜¯å¦ç¬¦åˆè§„åˆ™ 45 ret = ACLSelectorCheckKey(selector, argv[idx]-\u0026gt;ptr, sdslen(argv[idx]-\u0026gt;ptr), resultidx[j].flags); 46 //é‡åˆ°ä¸€ä¸ªä¸ç¬¦åˆçš„,ç›´æ¥å°±å¯ä»¥é€€å‡º,å¹¶è¿”å›é”™è¯¯ 47 if (ret != ACL_OK) { 48 if (keyidxptr) *keyidxptr = resultidx[j].pos; 49 return ret; 50 } 51 } 52 } 53 54 //æ£€æŸ¥channelçš„æƒé™,åªéœ€è¦æ£€æŸ¥ pub å’Œ subè¿™ä¸¤ä¸ªæƒé™å³å¯ 55 const int channel_flags = CMD_CHANNEL_PUBLISH | CMD_CHANNEL_SUBSCRIBE; 56 if (!(selector-\u0026gt;flags \u0026amp; SELECTOR_FLAG_ALLCHANNELS) \u0026amp;\u0026amp; doesCommandHaveChannelsWithFlags(cmd, channel_flags)) { 57 getKeysResult channels = (getKeysResult) GETKEYS_RESULT_INIT; 58 getChannelsFromCommand(cmd, argv, argc, \u0026amp;channels); 59 keyReference *channelref = channels.keys; 60 for (int j = 0; j \u0026lt; channels.numkeys; j++) { 61 int idx = channelref[j].pos; 62 if (!(channelref[j].flags \u0026amp; channel_flags)) continue; 63 int is_pattern = channelref[j].flags \u0026amp; CMD_CHANNEL_PATTERN; 64 //å’ŒåŒ¹é…keyç±»ä¼¼,ä¹Ÿæ˜¯éå†åŒ¹é…,é‡åˆ°ä¸ç¬¦åˆçš„å°±ç»“æŸå¹¶è¿”å›é”™è¯¯ 65 int ret = ACLCheckChannelAgainstList(selector-\u0026gt;channels, argv[idx]-\u0026gt;ptr, sdslen(argv[idx]-\u0026gt;ptr), is_pattern); 66 if (ret != ACL_OK) { 67 if (keyidxptr) *keyidxptr = channelref[j].pos; 68 getKeysFreeResult(\u0026amp;channels); 69 return ret; 70 } 71 } 72 getKeysFreeResult(\u0026amp;channels); 73 } 74 return ACL_OK; 75} ACLé‰´æƒçš„åŸºæœ¬å°±æ˜¯è¿™äº›äº†\nACLç›¸å…³çš„ä¸€äº›çŸ¥è¯† ACL ç›¸å…³çš„ä¸€äº›å®šä¹‰\n1//å‘½ä»¤åˆ†ç±»çš„å®šä¹‰ 2struct ACLCategoryItem { 3 const char *name; 4 uint64_t flag; 5} ACLCommandCategories[] = { /* See redis.conf for details on each category. */ 6 {\u0026#34;keyspace\u0026#34;, ACL_CATEGORY_KEYSPACE}, 7 {\u0026#34;read\u0026#34;, ACL_CATEGORY_READ}, 8 {\u0026#34;write\u0026#34;, ACL_CATEGORY_WRITE}, 9 {\u0026#34;set\u0026#34;, ACL_CATEGORY_SET}, 10 {\u0026#34;sortedset\u0026#34;, ACL_CATEGORY_SORTEDSET}, 11 {\u0026#34;list\u0026#34;, ACL_CATEGORY_LIST}, 12 {\u0026#34;hash\u0026#34;, ACL_CATEGORY_HASH}, 13 {\u0026#34;string\u0026#34;, ACL_CATEGORY_STRING}, 14 {\u0026#34;bitmap\u0026#34;, ACL_CATEGORY_BITMAP}, 15 {\u0026#34;hyperloglog\u0026#34;, ACL_CATEGORY_HYPERLOGLOG}, 16 {\u0026#34;geo\u0026#34;, ACL_CATEGORY_GEO}, 17 {\u0026#34;stream\u0026#34;, ACL_CATEGORY_STREAM}, 18 {\u0026#34;pubsub\u0026#34;, ACL_CATEGORY_PUBSUB}, 19 {\u0026#34;admin\u0026#34;, ACL_CATEGORY_ADMIN}, 20 {\u0026#34;fast\u0026#34;, ACL_CATEGORY_FAST}, 21 {\u0026#34;slow\u0026#34;, ACL_CATEGORY_SLOW}, 22 {\u0026#34;blocking\u0026#34;, ACL_CATEGORY_BLOCKING}, 23 {\u0026#34;dangerous\u0026#34;, ACL_CATEGORY_DANGEROUS}, 24 {\u0026#34;connection\u0026#34;, ACL_CATEGORY_CONNECTION}, 25 {\u0026#34;transaction\u0026#34;, ACL_CATEGORY_TRANSACTION}, 26 {\u0026#34;scripting\u0026#34;, ACL_CATEGORY_SCRIPTING}, 27 {NULL,0} /* Terminator. */ 28}; 29 30//userflagçš„å®šä¹‰ 31struct ACLUserFlag { 32 const char *name; 33 uint64_t flag; 34} ACLUserFlags[] = { 35 /* Note: the order here dictates the emitted order at ACLDescribeUser */ 36 {\u0026#34;on\u0026#34;, USER_FLAG_ENABLED}, 37 {\u0026#34;off\u0026#34;, USER_FLAG_DISABLED}, 38 {\u0026#34;nopass\u0026#34;, USER_FLAG_NOPASS}, 39 {\u0026#34;skip-sanitize-payload\u0026#34;, USER_FLAG_SANITIZE_PAYLOAD_SKIP}, 40 {\u0026#34;sanitize-payload\u0026#34;, USER_FLAG_SANITIZE_PAYLOAD}, 41 {NULL,0} /* Terminator. */ 42}; è¿˜æœ‰ä¸€ä¸ªåœ¨æƒé™æ ¡éªŒä¸­ç”¨åˆ°çš„ä¸œè¥¿ cmd-\u0026gt;id è¿™ä¸ªæ˜¯æ¯ä¸ªrediså‘½ä»¤çš„idï¼Œå…·ä½“æ˜¯é€šè¿‡è¿™ä¸ªå‡½æ•°å¾—åˆ°çš„\nACLGetCommandID\n1//è·å–ä¸€ä¸ªå‘½ä»¤çš„id 2unsigned long ACLGetCommandID(sds cmdname) { 3 sds lowername = sdsdup(cmdname); 4 sdstolower(lowername); 5 if (commandId == NULL) commandId = raxNew(); 6 void *id = raxFind(commandId,(unsigned char*)lowername,sdslen(lowername)); 7 if (id != raxNotFound) { 8 sdsfree(lowername); 9 //å¦‚æœæ‰¾åˆ°äº†,ç›´æ¥return idå°±å¯ä»¥äº† 10 return (unsigned long)id; 11 } 12 13 //å¦‚æœæ²¡æœ‰æ‰¾åˆ°, æŠŠè¿™ä¸ªå‘½ä»¤æ’å…¥çš„raxè¡¨ä¸­,å¹¶å¾—åˆ°id 14 raxInsert(commandId,(unsigned char*)lowername,strlen(lowername), 15 (void*)nextid,NULL); 16 sdsfree(lowername); 17 unsigned long thisid = nextid; 18 //idè‡ªå¢, nextidæ˜¯åœ¨aclä¸­å®šä¹‰çš„ 19 nextid++; 20 21 //å¦‚æœid==1023äº†, å†è‡ªå¢ä¸€æ¬¡,é˜²æ­¢idæ˜¯1024 22 //å› ä¸ºè¿™ä¸ªå€¼è¦ç»™aclSelectorä¸­çš„allowed_commandsåšç´¢å¼•, 23 //allowed_commands æ˜¯ä¸€ä¸ªé•¿åº¦ä¸º16çš„æ•°ç»„,è‡³äºä¸ºä»€ä¹ˆä¸èƒ½æ˜¯1024è¿™ä¸ªå€¼,åé¢ä¼šçœ‹åˆ° 24 if (nextid == USER_COMMAND_BITS_COUNT-1) nextid++; 25 return thisid; 26} 27 28//nextidçš„å®šä¹‰ 29static unsigned long nextid = 0; /* Next command id that has not been assigned */ 30 31//aclSelector ä¸­çš„ allowed_commandså®šä¹‰ 32uint64_t allowed_commands[USER_COMMAND_BITS_COUNT/64]; ACLSetSelectorCommandBit\næ ¹æ® cmd.id è®¾ç½® selector\n1void ACLSetSelectorCommandBit(aclSelector *selector, unsigned long id, int value) { 2 uint64_t word, bit; 3 //è°ƒç”¨ ACLGetCommandBitCoordinates è®¡ç®—å¾—åˆ° word å’Œbit 4 if (ACLGetCommandBitCoordinates(id,\u0026amp;word,\u0026amp;bit) == C_ERR) return; 5 if (value) { 6 //å¦‚æœæ˜¯å…è®¸çš„è¯,è®¾ç½®è¿™ä¸ªbit 7 selector-\u0026gt;allowed_commands[word] |= bit; 8 } else { 9 //å¦‚æœæ˜¯ä¸äºˆè®¸, å–æ¶ˆè¿™ä¸ªä½, å†æŠŠflagè®¾ç½®ä¸€ä¸‹ 10 selector-\u0026gt;allowed_commands[word] \u0026amp;= ~bit; 11 selector-\u0026gt;flags \u0026amp;= ~SELECTOR_FLAG_ALLCOMMANDS; 12 } 13} 14 15int ACLGetCommandBitCoordinates(uint64_t id, uint64_t *word, uint64_t *bit) { 16 //å¦‚æœid \u0026gt;= 1024äº†,return é”™è¯¯ 17 if (id \u0026gt;= USER_COMMAND_BITS_COUNT) return C_ERR; 18 //sizeof(uint64_t) è®¡ç®—å¾—åˆ°8 19 //word å¾—åˆ°ä½†æ˜¯ æ•°ç»„çš„ç´¢å¼• 20 //åˆ°è¿™åº”è¯¥å°±æ˜ç™½ä¸ºä»€ä¹ˆ åœ¨ `ACLGetCommandID` id ä¸èƒ½æ˜¯1024äº†å§ 21 *word = id / sizeof(uint64_t) / 8; 22 //bit æ˜¯é€šè¿‡ä½è¿ç®—å¾—åˆ°çš„, æ˜¯id%64 å¾—åˆ°çš„ä¸€ä¸ª[0,63]çš„å€¼,ç„¶åå†å·¦ç§»å¾—åˆ° bitçš„å€¼ 23 *bit = 1ULL \u0026lt;\u0026lt; (id % (sizeof(uint64_t) * 8)); 24 return C_OK; 25} è¿™æ ·ä¸€ç•ªæ“ä½œä¸‹æ¥ï¼Œselector.allowed_commands å¾—åˆ°ä¸€ä¸ªé•¿åº¦æ˜¯64çš„ uint64_t çš„æ•°ç»„ï¼Œæ•°ç»„å†…çš„æ¯ä¸€ä¸ªæ•´æ•°çš„æ¯ä¸€ä¸ªä½ï¼Œè®°å½•äº†ä¸€ä¸ªå‘½ä»¤å¼€å¯æˆ–è€…å…³é—­ï¼ˆå¯¹åº”ä½çš„0æˆ–1ï¼‰\nè¿™é‡Œæœ‰ä¸ªéå¸¸å·§å¦™çš„è®¡ç®—è¿‡ç¨‹ã€‚\nä¸€èˆ¬æˆ‘ä»¬åœ¨ä½¿ç”¨ä½è¿ç®—è®°å½•çš„æ—¶å€™ï¼Œéƒ½æ˜¯1ï¼Œ2ï¼Œ4ï¼Œ8 ç­‰ç­‰è¿™äº›2çš„å€æ•°æ¥åšï¼Œå› ä¸ºè¦ä¿è¯ä¸ä¼šå‡ºç°ä½å†²çªã€‚æ¯”å¦‚2çš„äºŒè¿›åˆ¶æ˜¯ 10, 3çš„äºŒè¿›åˆ¶æ˜¯ 11 åœ¨åŒæ—¶ä½¿ç”¨ 10 å’Œ 11 è¿›è¡Œ ä¸æˆ–è¿ç®—çš„æ—¶å€™ï¼Œ2 å’Œ 3 ç¬¬ä¸€ä½çš„ 1 ä¼šç›¸äº’å½±å“ï¼Œä½¿ç»“æœä¸å‡†ç¡®ã€‚\nä½†æ˜¯å¦‚æœç›´æ¥ç”¨idçš„å€¼å·¦ç§»æ¥è®¡ç®—ï¼Œuint64_t bit = 1ULL \u0026lt;\u0026lt; id å‡è®¾æœ‰100ä¸ªcmd,idçš„å€¼å°±æ˜¯100ï¼Œé‚£å°±éœ€è¦ä¸€ä¸ªæ•´æ•°æ˜¯100ä½çš„é•¿åº¦ã€‚ä½†æ˜¯ç°åœ¨Cè¯­è¨€çš„æœ€å¤§æ•´æ•°æ˜¯64ä½é•¿åº¦ã€‚æ˜¾ç„¶æ˜¯ä¸å¤Ÿç”¨çš„ã€‚æ‰€ä»¥è¿™é‡Œåœ¨è®¡ç®—çš„æ—¶å€™ï¼Œä¼šæŠŠå‘½ä»¤å…ˆåˆ†ç»„ï¼Œè®©å‘½ä»¤è½åœ¨[0,63]è¿™ä¸ªèŒƒå›´å†…ï¼Œç„¶åå†å¯¹ç»„å†…çš„æ•°å­—è¿›è¡Œå·¦ç§»è®¡ç®—ã€‚è¿™æ ·ï¼Œä½¿ç”¨é•¿åº¦æ˜¯64çš„ uint64_t çš„æ•°ç»„å°±èƒ½å®Œæˆ 1024ä¸ªå‘½ä»¤çš„bitè®°å½•äº†ã€‚\nå‘½ä»¤åˆå§‹åŒ– åœ¨ACLä¸­ï¼Œæœ‰ å‘½ä»¤åˆ†ç±» (acl_categories) å’Œ å­å‘½ä»¤(subcommands) è¿™ä¸¤ä¸ªæ¦‚å¿µï¼Œè¿™ä¸ªä¸œè¥¿éœ€è¦åœ¨å‘½ä»¤åˆå§‹åŒ–æ—¶å°±èµ‹å€¼ã€‚\nacl_categories æ˜¯ä¸€ä¸ª uint64_t ç±»å‹çš„ï¼Œå¯¹åº”çš„å€¼æ˜¯ ACL_CATEGORY_ çš„å®å®šä¹‰ï¼Œåœ¨ è¿™é‡Œ è¢«å®šä¹‰\nsubcommands æ˜¯ä¸€ä¸ª redisCommandç±»å‹çš„æŒ‡é’ˆï¼Œå…¶å®å°±æ˜¯ redisCommand ç±»å‹çš„æ•°ç»„\ncommandsåˆå§‹åŒ–\nåœ¨è¿™é‡Œï¼Œredisçš„æ‰€æœ‰å‘½ä»¤éƒ½ä¼šè¢«åˆå§‹åŒ–\nå°±æ‹¿ ACL è¿™ä¸ªå‘½ä»¤æ¥è¯´å§ ACLå‘½ä»¤åˆå§‹åŒ–\nACLå‘½ä»¤çš„ acl_categories è¢«è®¾ç½®ä¸ºäº†0, subcommands è¢«è®¾ç½®ä¸ºäº† ACL_Subcommands\nå…¶ä¸­ ACL_Subcommands æ˜¯ä¸€ä¸ªå‘½ä»¤çš„æ•°ç»„ï¼Œåœ¨è¿™é‡Œè¢«åˆå§‹åŒ–\næœ‰å­å‘½ä»¤çš„ä¼šæŠŠå¯¹åº”çš„å­å‘½ä»¤èµ‹å€¼å¯¹ subcommands ä¸­ï¼Œæ²¡æœ‰å­å‘½ä»¤çš„å°±ç›´æ¥æ˜¯ç©ºæŒ‡é’ˆäº†\næš‚æ—¶èƒ½æƒ³åˆ°çš„å°±æ˜¯è¿™äº›äº†ï¼Œåé¢æœ‰æ–°çš„å†è¡¥å……\n","date":"2023-07-03T21:07:02Z","image":"https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/174339-62bacd4b7f65d.png","permalink":"https://lqxhub.github.io/posts/eeb1e692/","title":"redisæºç å­¦ä¹ |ACLï¼Œç»†æ¢è®¨äº†Redis ACLçš„ä½œç”¨ã€å‘½ä»¤å’Œæƒé™è®¾ç½®ï¼Œä»¥åŠå¦‚ä½•åœ¨æºç å±‚é¢å®ç°ACLçš„åˆå§‹åŒ–ã€åŠ è½½å’Œé‰´æƒã€‚"},{"content":"æœ€è¿‘æƒ³æ·±å…¥å­¦ä¹ ä¸€ä¸‹redisï¼Œé‚£é˜…è¯»æºç æ˜¯æœ€å¥½çš„å­¦ä¹ æ–¹å¼äº†ï¼Œæ­£å¥½æœ€è¿‘pikaç¤¾åŒºåœ¨è®¨è®º äº‹åŠ¡ çš„å®ç°ï¼Œå®ç°äº‹åŠ¡çš„åŸºç¡€å°±æ˜¯æ•°æ®çš„ä¸€è‡´æ€§ è™½ç„¶redisçš„äº‹åŠ¡æ²¡æœ‰åƒ å…³ç³»å‹æ•°æ®åº“é‚£æ ·ï¼Œæ”¯æŒæ•°æ®å›æ»šã€‚ä½†æ˜¯redisçš„äº‹åŠ¡ä¹Ÿå¯ä»¥ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ï¼Œå¦‚ä½•ä¿è¯æ•°æ® ä¸€è‡´æ€§ï¼Œå°±æ˜¯é  watch è¿™ä¸ªåŠŸèƒ½æ¥å®ç°çš„ã€‚è¯´ç™½äº†ï¼Œredisçš„watchåŠŸèƒ½å°±æ˜¯ä¸€ä¸ªä¹è§‚é”\nä¹è§‚é” æˆ‘çš„ç†è§£æ˜¯ï¼Œæ‰€è°“çš„ä¹è§‚é”ï¼Œå¯¹æ•°æ®åŠ é”ä¸ä¼šé˜»æ­¢åˆ«çš„äººä¿®æ”¹æ•°æ®ï¼Œä½†æ˜¯åˆ«äººä¿®æ”¹è¿‡çš„æ•°æ®ï¼ŒåŠ é”çš„äººèƒ½çŸ¥é“è¿™ä¸ªæ•°æ®è¢«ä¿®æ”¹è¿‡\nredis å®ç° æœ¬æ–‡ä¸­çš„æºç åŸºäºredis 7.0.11ï¼Œä¸åŒçš„ç‰ˆæœ¬å®ç°å¯èƒ½ä¼šä¸åŒ\nå…ˆæ”¾ä¸€å¼ watchçš„æ•°æ®ç»“æ„å›¾\nåœ¨redisçš„ db ç»“æ„ä¸­ï¼Œæœ‰ä¸€ä¸ªmapï¼Œç”¨æ¥è®°å½•æ‰€æœ‰è¢«watchçš„keyï¼Œæ‰€æœ‰watchè¿™ä¸ªkeyçš„clientéƒ½ä½¿ç”¨é“¾è¡¨ä¸²è”åœ¨ä¸€èµ·\næºç \n1/* Redis database representation. There are multiple databases identified 2 * by integers from 0 (the default database) up to the max configured 3 * database. The database number is the \u0026#39;id\u0026#39; field in the structure. */ 4typedef struct redisDb { 5 dict *dict; /* The keyspace for this DB */ 6 dict *expires; /* Timeout of keys with a timeout set */ 7 dict *blocking_keys; /* Keys with clients waiting for data (BLPOP)*/ 8 dict *ready_keys; /* Blocked keys that received a PUSH */ 9 dict *watched_keys; /* WATCHED keys for MULTI/EXEC CAS è¿™ä¸ªmapå°±æ˜¯è®°å½•è¢«watchçš„key*/ 10 int id; /* Database ID */ 11 long long avg_ttl; /* Average TTL, just for stats */ 12 unsigned long expires_cursor; /* Cursor of the active expire cycle. */ 13 list *defrag_later; /* List of key names to attempt to defrag one by one, gradually. */ 14 clusterSlotToKeyMapping *slots_to_keys; /* Array of slots to keys. Only used in cluster mode (db 0). */ 15} redisDb; åœ¨redisçš„ clientä¸­ä¹Ÿæœ‰ä¸€ä¸ªé“¾è¡¨ï¼Œè®°å½•äº†å½“å‰client watchçš„æ‰€æœ‰key\nè¿˜æœ‰ä¸€ä¸ªflagè®°å½•å½“å‰clientçš„çŠ¶æ€ï¼Œè¿™ä¸ªflagå¯ä»¥è®°å½•å¾ˆå¤šçŠ¶æ€ï¼Œåœ¨watchåŠŸèƒ½é‡Œï¼Œå¯ä»¥è®°å½•è¿™ä¸ªå½“å‰client watchçš„keyï¼Œæ˜¯å¦è¢«åˆ«çš„clientä¿®æ”¹è¿‡\næºç \n1typedef struct client { 2 uint64_t flags; /* Client flags: CLIENT_* macros. */ 3 list *watched_keys; /* Keys WATCHED for MULTI/EXEC CAS */ 4}; å› ä¸ºredisä¸åŒçš„dbæ˜¯äº’ç›¸éš”ç¦»çš„ï¼Œæ‰€ä»¥åœ¨dbå±‚é¢åšwatchå°±å¯ä»¥äº†\nwatch key ç°åœ¨æ¥çœ‹ä¸€ä¸‹å¦‚ä½•watchä¸€ä¸ªkey\næºç \n1void watchForKey(client *c, robj *key) { 2 list *clients = NULL; 3 listIter li; 4 listNode *ln; 5 watchedKey *wk; 6 7 /* Check if we are already watching for this key */ 8 listRewind(c-\u0026gt;watched_keys,\u0026amp;li); 9 //éå†å½“å‰clientå·²ç»watchçš„keyä¸­,æ˜¯å¦åŒ…å«å½“å‰è¦watchçš„key 10 while((ln = listNext(\u0026amp;li))) { 11 wk = listNodeValue(ln); 12 //å› ä¸ºredisä¸åŒçš„dbä¸­,æ•°æ®æ˜¯éš”ç¦»çš„,æ‰€ä»¥è¦åˆ¤æ–­ä¸€ä¸‹,dbæ˜¯å¦ç›¸åŒ 13 //æ¯”å¦‚db0å’Œdb1éƒ½æœ‰key1è¿™ä¸ªkey 14 if (wk-\u0026gt;db == c-\u0026gt;db \u0026amp;\u0026amp; equalStringObjects(key,wk-\u0026gt;key)) 15 //å¦‚æœè¿™ä¸ªkeyå·²ç»è¢«watchäº†,ç›´æ¥rerunå°±å¥½äº† 16 return; /* Key already watched */ 17 } 18 /* This key is not already watched in this DB. Let\u0026#39;s add it */ 19 //å»db çš„ `watched_keys`è¿™ä¸ªmapä¸­,æ‰¾åˆ°watchè¿™ä¸ªkeyçš„æ‰€æœ‰client 20 clients = dictFetchValue(c-\u0026gt;db-\u0026gt;watched_keys,key); 21 if (!clients) { 22 //å¦‚æœæ²¡æœ‰client watch è¿™ä¸ªkey,è¿”å›çš„é“¾è¡¨æ˜¯ç©ºæŒ‡é’ˆ,è¿™æ—¶å€™åˆå§‹åŒ–ä¸€ä¸ªé“¾è¡¨ 23 clients = listCreate(); 24 //æŠŠé“¾è¡¨èµ‹å€¼ç»™map 25 dictAdd(c-\u0026gt;db-\u0026gt;watched_keys,key,clients); 26 incrRefCount(key); 27 } 28 /* Add the new key to the list of keys watched by this client */ 29 wk = zmalloc(sizeof(*wk)); 30 wk-\u0026gt;key = key; 31 wk-\u0026gt;client = c; 32 wk-\u0026gt;db = c-\u0026gt;db; 33 //è®°å½•ä¸€ä¸‹,åœ¨watchæ—¶,è¿™ä¸ªkeyæ˜¯å¦è¿‡æœŸäº†,å¦‚æœåœ¨watchå‰å°±å·²ç»è¿‡æœŸäº†,åœ¨æ‰§è¡Œäº‹åŠ¡çš„æ—¶å€™,å°±å¿½ç•¥è¿™ä¸ªkey 34 wk-\u0026gt;expired = keyIsExpired(c-\u0026gt;db, key); 35 incrRefCount(key); 36 //æŠŠå½“å‰çš„clientåŠ åˆ°é“¾è¡¨ä¸­ 37 listAddNodeTail(c-\u0026gt;watched_keys,wk); 38 //æŠŠwatchçš„key åŠ å…¥çš„client watché“¾è¡¨ä¸­ 39 listAddNodeTail(clients,wk); 40} watchä¸€ä¸ªkeyå‰ï¼Œä¼šæ£€æŸ¥ä¸€ä¸‹è¿™ä¸ªkeyæ˜¯å¦å·²ç»è¢«watchäº†ï¼Œé¿å…é‡å¤watch\næ‰¾åˆ°watchè¿™ä¸ªkeyçš„æ‰€æœ‰clientï¼Œå¹¶ä½¿ç”¨å°¾æ’æ³•æŠŠå½“å‰clientåŠ å…¥é“¾è¡¨ï¼Œå¹¶ä¸”è®°å½•ä¸€ä¸‹watchè¿™ä¸ªkeyä¹‹å‰ï¼Œè¿™ä¸ªkeyæ˜¯å¦è¿‡æœŸäº†\nåˆ°è¿™é‡Œï¼Œwatchçš„è¿‡ç¨‹å°±å®Œæˆäº†ï¼Œé€šè¿‡æºç å¯ä»¥å‘ç°ï¼Œwatchçš„è¿‡ç¨‹è¿˜æ˜¯æŒºå¥½ç†è§£çš„ï¼Œå°±æ˜¯åœ¨è®°å½•ä¸€ä¸‹\næ‰§è¡Œäº‹åŠ¡ å½“redisçš„clientåœ¨æ‰§è¡Œ EXECå‘½ä»¤æ—¶ï¼Œä¼šæŠŠå½“å‰äº‹åŠ¡æ‰€æœ‰çš„å‘½ä»¤ä¸€èµ·æ‰§è¡Œï¼Œåœ¨æ‰§è¡Œå‘½ä»¤å‰ï¼Œä¼šå…ˆæ£€æŸ¥ä¸€ä¸‹watchçš„keyæ˜¯å¦è¢«ä¿®æ”¹äº†ï¼Œå¦‚æœè¢«ä¿®æ”¹äº†ï¼Œ å°±ä¼šæ”¾å¼ƒæ‰§è¡Œå‘½ä»¤ï¼Œè¿”å›å¤±è´¥\næºç \n1void execCommand(client *c) { 2 int j; 3 robj **orig_argv; 4 int orig_argc, orig_argv_len; 5 struct redisCommand *orig_cmd; 6 7 //å…ˆæ£€æŸ¥ä¸€ä¸‹,å¦‚æœclientåœ¨æ­¤ä¹‹å‰æ²¡æœ‰æ‰§è¡Œè¿‡`MULTI`å‘½ä»¤,å°±æ‰§è¡Œ`EXEC`,è¿”å›é”™è¯¯ 8 if (!(c-\u0026gt;flags \u0026amp; CLIENT_MULTI)) { 9 addReplyError(c,\u0026#34;EXEC without MULTI\u0026#34;); 10 return; 11 } 12 13 /* EXEC with expired watched key is disallowed*/ 14 //æ£€æŸ¥ä¸€ä¸‹è¢«watchçš„keyæ˜¯å¦è¿‡æœŸäº†,å¦‚æœè¿‡æœŸäº†,äº‹åŠ¡ä¹Ÿä¼šå¤±è´¥ 15 //å¦‚æœè¿™ä¸ªkeyåœ¨watchä¹‹å‰å°±è¿‡æœŸäº†,é‚£ä¹ˆè¿™ä¸ªkeyä¼šè¢«å¿½ç•¥ 16 if (isWatchedKeyExpired(c)) { 17 c-\u0026gt;flags |= (CLIENT_DIRTY_CAS); 18 } 19 20 /* Check if we need to abort the EXEC because: 21 * 1) Some WATCHed key was touched. 22 * 2) There was a previous error while queueing commands. 23 * A failed EXEC in the first case returns a multi bulk nil object 24 * (technically it is not an error but a special behavior), while 25 * in the second an EXECABORT error is returned. */ 26 //è¿™é‡Œå°±æ˜¯åˆ¤æ–­è¿™ä¸ªkeyæ˜¯å¦è¢«å…¶ä»–clientæ”¹åŠ¨äº†,å¦‚æœkeyè¢«åˆ«çš„clientæ”¹åŠ¨äº†,æˆ–è€…äº‹åŠ¡å‡ºé”™äº†,é‚£ä¹ˆæœ¬æ¬¡äº‹åŠ¡éƒ½ä¼šå¤±è´¥ 27 if (c-\u0026gt;flags \u0026amp; (CLIENT_DIRTY_CAS | CLIENT_DIRTY_EXEC)) { 28 if (c-\u0026gt;flags \u0026amp; CLIENT_DIRTY_EXEC) { 29 addReplyErrorObject(c, shared.execaborterr); 30 } else { 31 addReply(c, shared.nullarray[c-\u0026gt;resp]); 32 } 33 34 discardTransaction(c); 35 return; 36 } 37 uint64_t old_flags = c-\u0026gt;flags; 38 39 /* we do not want to allow blocking commands inside multi */ 40 c-\u0026gt;flags |= CLIENT_DENY_BLOCKING; 41 42 /* Exec all the queued commands */ 43 //å–æ¶ˆwatchçš„æ‰€æœ‰key 44 unwatchAllKeys(c); /* Unwatch ASAP otherwise we\u0026#39;ll waste CPU cycles */ 45 ..................................................... 46 çœç•¥ 47} åœ¨æ‰§è¡Œäº‹åŠ¡å‰ï¼Œä¼šæ£€æŸ¥ä¸€ä¸‹å½“å‰clientæ˜¯å¦å¼€å¯äº†äº‹åŠ¡ï¼ˆæ˜¯å¦æ‰§è¡Œäº† MULTI å‘½ä»¤ï¼‰ï¼Œæ²¡æœ‰å¼€å¯äº‹åŠ¡ï¼Œè¿™æ¬¡äº‹åŠ¡ä¼šå¤±è´¥\nå†æ£€æŸ¥è¿™ä¸ªclient watchçš„keyæ˜¯å¦è¢«ä¿®æ”¹äº†ã€‚å¦‚æœè¿™ä¸ªkeyè¢«å…¶ä»–çš„clientä¿®æ”¹äº†ï¼Œåˆ™è¿™ä¸ªäº‹åŠ¡ä¼šæ‰§è¡Œå¤±è´¥\nwatchæ£€æŸ¥æ²¡æœ‰é—®é¢˜åï¼Œä¼šæ¸…é™¤å½“å‰client watchçš„æ‰€æœ‰key\nåˆ°è¿™ï¼Œäº‹åŠ¡æ‰§è¡Œå‰çš„æ£€æŸ¥å°±å®Œæˆäº†ï¼Œåé¢å°±æ˜¯äº‹åŠ¡ç›¸å…³çš„åˆ¤æ–­å’Œæ“ä½œäº†\nä¿®æ”¹watchçš„key å¦‚æœä¸€ä¸ªè¢«watchçš„keyè¢«ä¿®æ”¹äº†ï¼Œé‚£ä¹ˆæ‰€æœ‰watchè¿™ä¸ªkeyçš„clientéƒ½ä¼šçŸ¥é“ï¼Œå…·ä½“å®ç°å¦‚ä¸‹\næºç \næ‰€æœ‰ä¿®æ”¹å‘½ä»¤(æ¯”å¦‚set,hsetç­‰ç­‰)åœ¨æ‰§è¡Œå,éƒ½ä¼šè°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼ŒæŠŠwatchçš„keyæ ‡è®°ä¸ºä¿®æ”¹çŠ¶æ€\n1void touchWatchedKey(redisDb *db, robj *key) { 2 list *clients; 3 listIter li; 4 listNode *ln; 5 6 //å¦‚æœè®°å½•keyçš„mapä¸ºç©ºæˆ–è€…clienté“¾è¡¨æ˜¯ç©º,ç›´æ¥return 7 if (dictSize(db-\u0026gt;watched_keys) == 0) return; 8 clients = dictFetchValue(db-\u0026gt;watched_keys, key); 9 if (!clients) return; 10 11 /* Mark all the clients watching this key as CLIENT_DIRTY_CAS */ 12 /* Check if we are already watching for this key */ 13 listRewind(clients,\u0026amp;li); 14 //éå†watchè¿™ä¸ªkeyçš„clienté“¾è¡¨,æŠŠæ‰€æœ‰clientçš„flagä¿®æ”¹ä¸º `CLIENT_DIRTY_CAS` çŠ¶æ€ 15 while((ln = listNext(\u0026amp;li))) { 16 watchedKey *wk = listNodeValue(ln); 17 client *c = wk-\u0026gt;client; 18 19 if (wk-\u0026gt;expired) { 20 /* The key was already expired when WATCH was called. */ 21 if (db == wk-\u0026gt;db \u0026amp;\u0026amp; 22 equalStringObjects(key, wk-\u0026gt;key) \u0026amp;\u0026amp; 23 dictFind(db-\u0026gt;dict, key-\u0026gt;ptr) == NULL) 24 { 25 //å¦‚æœåœ¨è¿™ä¸ªclientåœ¨watchå‰,è¿™ä¸ªkeyå°±å·²ç»è¿‡æœŸäº† \u0026amp;\u0026amp; æ˜¯è¿™ä¸ªdbçš„ \u0026amp;\u0026amp; keyæ˜¯åŒä¸€ä¸ª \u0026amp;\u0026amp; å†…å­˜é‡Œæ²¡æœ‰è¿™ä¸ªkeyäº† 26 //å°±æ¸…é™¤ watchå°±è¿‡æœŸçš„ flag 27 /* Already expired key is deleted, so logically no change. Clear 28 * the flag. Deleted keys are not flagged as expired. */ 29 wk-\u0026gt;expired = 0; 30 goto skip_client; 31 } 32 //å¦åˆ™å°±ç»“æŸ 33 break; 34 } 35 36 //æŠŠè¿™ä¸ªclientçš„flagä¿®æ”¹ä¸º è¢«å…¶ä»–clientä¿®æ”¹äº† 37 c-\u0026gt;flags |= CLIENT_DIRTY_CAS; 38 /* As the client is marked as dirty, there is no point in getting here 39 * again in case that key (or others) are modified again (or keep the 40 * memory overhead till EXEC). */ 41 //å¦‚æœè¿™ä¸ªclient watchçš„keyè¢«æ ‡è®°ä¸ºä»¥ä¿®æ”¹,é‚£ä¹ˆå°±æŠŠè¿™ä¸ªclient watchçš„keyéƒ½åˆ æ‰ 42 unwatchAllKeys(c); 43 44 skip_client: 45 continue; 46 } 47} 48 49//åˆ é™¤client watchçš„key 50void unwatchAllKeys(client *c) { 51 listIter li; 52 listNode *ln; 53 54 if (listLength(c-\u0026gt;watched_keys) == 0) return; 55 listRewind(c-\u0026gt;watched_keys,\u0026amp;li); 56 //å˜é‡å½“å‰client watchçš„key æŠŠè¿™äº›keyåœ¨å¯¹åº”çš„dbçš„`watched_keys`ä¸­åˆ é™¤ 57 while((ln = listNext(\u0026amp;li))) { 58 list *clients; 59 watchedKey *wk; 60 61 /* Lookup the watched key -\u0026gt; clients list and remove the client\u0026#39;s wk 62 * from the list */ 63 wk = listNodeValue(ln); 64 clients = dictFetchValue(wk-\u0026gt;db-\u0026gt;watched_keys, wk-\u0026gt;key); 65 serverAssertWithInfo(c,NULL,clients != NULL); 66 listDelNode(clients,listSearchKey(clients,wk)); 67 /* Kill the entry at all if this was the only client */ 68 if (listLength(clients) == 0) 69 dictDelete(wk-\u0026gt;db-\u0026gt;watched_keys, wk-\u0026gt;key); 70 /* Remove this watched key from the client-\u0026gt;watched list */ 71 listDelNode(c-\u0026gt;watched_keys,ln); 72 decrRefCount(wk-\u0026gt;key); 73 zfree(wk); 74 } 75} ä»»æ„clientåœ¨ä¿®æ”¹keyå,éƒ½ä¼šè°ƒç”¨ touchWatchedKey æŠŠwatchè¿™ä¸ªkeyçš„clientçš„flagæ ‡è®°ä¸ºè¢«ä¿®æ”¹çŠ¶æ€ï¼Œwatchè¿™ä¸ªkeyçš„clientï¼Œä¼šéå†è‡ªå·±çš„watch çš„é“¾è¡¨ï¼ŒæŠŠæ‰€æœ‰çš„keyéƒ½åˆ æ‰ã€‚åç»­åœ¨æ‰§è¡Œäº‹åŠ¡æ—¶ä¼šå¤±è´¥\nåœ¨æ‰§è¡Œ UNWATCH å‘½ä»¤æ—¶ï¼Œæœ€ç»ˆè°ƒç”¨çš„ä¹Ÿæ˜¯ unwatchAllKeys è¿™ä¸ªå‡½æ•°\næ€»ç»“ redisé€šè¿‡ watch å‘½ä»¤å®ç°ä¹è§‚é”ï¼Œä¿è¯äº†äº‹åŠ¡ä¸­æ•°æ®çš„ä¸€è‡´æ€§ã€‚\nredisçš„ä¹è§‚é”åœ¨é›†ç¾¤æ¨¡å¼ä¸‹å¹¶ä¸é€‚ç”¨ï¼Œåœ¨é›†ç¾¤æ¨¡å¼ä¸‹ï¼Œè¿˜æ˜¯è¦ä½¿ç”¨ SETEX KEY_NAME TIMEOUT VALUE è¿™ç§æ–¹å¼åŠ é”æ¥ä¿è¯æ•°æ®ä¸€è‡´\nåˆšå¼€å§‹å­¦ä¹ redisæºç ï¼Œå¯¹ä¸€äº›æ¦‚å¿µç†è§£è¿˜ä¸æ˜¯å¾ˆæ·±ï¼Œå¦‚æœæœ‰é”™è¯¯çš„åœ°æ–¹ï¼Œè¿˜è¯·æ‰¹è¯„æŒ‡æ­£\n","date":"2023-05-27T15:20:19Z","image":"https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/2293d1c588ec113daecfde68815267b8.png","permalink":"https://lqxhub.github.io/posts/aadf9734/","title":"redis ä¹è§‚é”ï¼Œäº‹åŠ¡ä¸­å¦‚ä½•ç¡®ä¿æ•°æ®ä¸€è‡´æ€§,watchå‘½ä»¤æºç ,watchçš„å®ç°åŸç†ï¼Œæ•°æ®ç»“æ„ã€å¦‚ä½•ç›‘æ§å’Œç®¡ç†keyçš„å˜åŒ–"},{"content":"æ ¹æ®debianå®˜æ–¹å‘å¸ƒçš„å…¬å‘Šï¼Œdebian12çš„å‘å¸ƒæ—¥æœŸæ˜¯2023å¹´6æœˆ10æ—¥ã€‚ æˆ‘åŸæœ¬ä»¥ä¸ºè¦ç­‰åˆ°é‚£å¤©æ‰èƒ½æ›´æ–°å‘¢ï¼Œå»ç½‘ç«™çœ‹äº†ä¸€ä¸‹ï¼Œç°åœ¨å°±å¯ä»¥æ›´æ–°äº†ï¼Œé‚£è¿˜ç”¨è¯´äº†ï¼Œç›´æ¥å†²ã€‚\nå…¶å®æ›´æ–°æ–¹å¼ä¹Ÿéå¸¸ç®€å•ï¼Œåªéœ€è¦æŠŠ apt çš„æºæ¢æˆ debian12çš„ï¼Œç„¶åæ‰§è¡Œ apt full-upgrade å°±å¯ä»¥äº†\nåœ¨å›½å†…ï¼Œä¸å»ºè®®ä½¿ç”¨å®˜æ–¹çš„æºï¼Œç½‘é€Ÿæ…¢ï¼Œå›½å†…æœ‰å¾ˆå¤šé•œåƒï¼Œæ‰¾ä¸€ä¸‹æ›¿æ¢ä¸€ä¸‹å°±è¡Œã€‚\næˆ‘ç”¨çš„æ˜¯æ¸…åå¤§å­¦çš„é•œåƒï¼Œ\nåœ°å€\né€‰æ‹©å¯¹åº”çš„debianç‰ˆæœ¬ï¼Œå¦‚å›¾ä¸­\nå›åˆ°linuxä¸­ï¼Œåœ¨å‡çº§12å‰ï¼Œå»ºè®®æŠŠå…³é”®æ•°æ®åšä¸€æ¬¡å¤‡ä»½ï¼Œå‡ºé—®é¢˜äº†è¿˜æœ‰å›å¤´è·¯ã€‚ æˆ‘ä½¿ç”¨çš„è™šæ‹Ÿæœºï¼Œåœ¨å‡çº§å‰åˆ›å»ºäº†ä¸€ä¸ªå¿«ç…§\nåœ¨å‡çº§å‰ å…ˆæŠŠ11çš„æ‰€æœ‰åŒ…éƒ½æ›´æ–°åˆ°æœ€æ–°\nsudo apt update sudo apt upgrade å°† /etc/apt/sources.list æ‰€æœ‰çš„é…ç½®åˆ æ‰ï¼ŒæŠŠdebian12 çš„å¤åˆ¶è¿›å»\nç„¶åæ‰§è¡Œ\nsudo apt update sudo apt full-upgrade ç­‰å¾…ä¸‹è½½å®Œæˆåä¼šè‡ªåŠ¨å®‰è£…ã€‚å¦‚æœä½ æœ‰æ›´æ”¹è¿‡ä¸€äº›åŒ…çš„é…ç½®ï¼Œåœ¨é‡æ–°å®‰è£…çš„æ—¶å€™ä¼šè¯¢é—®ä½ ä½¿ç”¨é»˜è®¤çš„é…ç½®è¿˜æ˜¯ä¿®æ”¹åçš„é…ç½®\nä¸€èˆ¬æƒ…å†µä¸‹é€‰æ‹©è‡ªå·±ä¿®æ”¹åçš„é…ç½®å°±å¯ä»¥äº†ã€‚\nç­‰å…¨éƒ¨å®Œæˆå é‡å¯è¿›å…¥ç³»ç»Ÿï¼Œæ•´ä¸ªå‡çº§å°±å®Œæˆäº†\nç³»ç»Ÿå‡çº§åï¼Œå¦‚æœä½¿ç”¨çš„æ˜¯gnomeæ¡Œé¢ï¼Œå› ä¸ºgnomeä»3å‡çº§åˆ°äº†4ï¼Œæ‰€ä»¥åŸæ¥çš„ä¸€äº›æ’ä»¶å°±ä¸èƒ½ç”¨äº†ï¼Œè¿™æ—¶å€™åªéœ€è¦æŠŠæ—§çš„æ’ä»¶å¸è½½ æ¢æˆæ–°çš„å°±å¯ä»¥\nå¦‚æœè¿™ä¸ªæ’ä»¶æ²¡æœ‰å…¼å®¹gnome4çš„ï¼Œé‚£å°±æ²¡æ³•äº† 0.0\næˆ‘å‡çº§ååªæœ‰ä¸€ä¸ªæ’ä»¶ä¸èƒ½ç”¨äº†ï¼Œæ¢æˆæœ€æ–°ç‰ˆçš„å°±å¯ä»¥ï¼ŒåŸæ¥è½¯ä»¶éƒ½èƒ½æ­£å¸¸ä½¿ç”¨ï¼Œå·²ç»ç”¨äº†ä¸¤å¤©äº†ï¼Œå®Œå…¨æ²¡æœ‰é—®é¢˜\n","date":"2023-05-14T14:12:12Z","image":"https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/debian-12-banner.jpg","permalink":"https://lqxhub.github.io/posts/39fad342/","title":"debian11 å‡çº§åˆ° debian12"},{"content":"goçš„ math åŒ…åªæä¾›äº†ç®€å•çš„å°æ•°æ“ä½œï¼Œåƒå¸¸ç”¨çš„å››èˆäº”å…¥ï¼Œä¿ç•™å‡ ä½å°æ•°è¿™äº›å¸¸ç”¨çš„æ“ä½œï¼Œå´æ²¡æœ‰æä¾›ï¼Œé‚£åªå¥½è‡ªå·±é€ è½®å­äº†ã€‚\nå››èˆäº”å…¥å–æ•´ 1func Rounding(v float64) int { 2 return int(v + 0.5) 3} å››èˆäº”å…¥å–æ•´è¿˜æ˜¯å¾ˆç®€å•çš„ï¼Œç›´æ¥ +0.5 ç„¶åå–æ•´å°±å¯ä»¥äº†ã€‚\nä¿ç•™æŒ‡å®šå°æ•°ä½æ•° 1func FloatRetainBit(v float64, bit int) float64 { 2 if bit == 0 { 3 return math.Floor(v) 4 } 5 pow10 := math.Pow10(bit) 6 return math.Floor(v*pow10) / pow10 7} è¿™ä¸ªå¤šäº†ä¸€ç‚¹æ•°å­¦è¿ç®—ï¼Œå…¶å®å°±æ˜¯ * 10 çš„ å¤šå°‘æ¬¡æ–¹ï¼Œç„¶åå‘ä¸‹å–æ•´ï¼Œå† Ã· 10 çš„ å¤šå°‘æ¬¡æ–¹å°±å¯ä»¥äº†\nå…¶ä¸­çš„æ•°å­¦çŸ¥è¯†ï¼š\n* 10 çš„ å¤šå°‘æ¬¡æ–¹ å°±æ˜¯å°æ•°ç‚¹ å³ ç§»å¤šå°‘ä½\nÃ· 10 çš„ å¤šå°‘æ¬¡æ–¹ å°±æ˜¯å°æ•°ç‚¹ å·¦ ç§»å¤šå°‘ä½\nä¿ç•™æŒ‡å®šå°æ•°ä½æ•°å–æ•´ 1func FloatRoundingRetainBit(v float64, bit int) float64 { 2 if bit == 0 { 3 return math.Floor(v + 0.5) 4 } 5 pow10 := math.Pow10(bit) 6 return math.Floor(v*pow10+0.5) / pow10 7} è¿™ä¸ªä¹Ÿæ²¡å•¥å¤æ‚çš„ï¼Œå°±æ˜¯åœ¨ä¿ç•™ä½æ•°çš„åŸºç¡€ä¸Šå†åŠ ä¸€ä¸ªå››èˆäº”å…¥å°±å¥½äº†\næµ‹è¯•ä¸€ä¸‹ 1package main 2 3import ( 4 \u0026#34;fmt\u0026#34; 5 \u0026#34;math\u0026#34; 6 \u0026#34;math/rand\u0026#34; 7) 8 9func main() { 10 f := rand.Float64() 11 fmt.Println(f) 12 fmt.Println(Rounding(f)) 13 fmt.Println(FloatRetainBit(f, 4)) 14 fmt.Println(FloatRoundingRetainBit(f, 4)) 15} 16 17func Rounding(v float64) int { 18 return int(v + 0.5) 19} 20 21func FloatRetainBit(v float64, bit int) float64 { 22 if bit == 0 { 23 return math.Floor(v) 24 } 25 pow10 := math.Pow10(bit) 26 return math.Floor(v*pow10) / pow10 27} 28 29func FloatRoundingRetainBit(v float64, bit int) float64 { 30 if bit == 0 { 31 return math.Floor(v + 0.5) 32 } 33 pow10 := math.Pow10(bit) 34 return math.Floor(v*pow10+0.5) / pow10 35} çœ‹ä¸€ä¸‹è¿è¡Œç»“æœ\n10.6046602879796196 21 30.6046 40.6047 æ˜¯ç¬¦åˆé€»è¾‘çš„\nbenchmark ä¿ç•™æŒ‡å®šä½æ•°çš„å°æ•°ï¼Œå‡ºäº†ç”¨è¿™ç§æ•°å­¦è®¡ç®—çš„æ–¹å¼å¤–ï¼Œè¿˜å¯ä»¥ç”¨ fmt åŒ…çš„å‡½æ•°æ¥åš\næ¯”å¦‚ï¼š\n1sprintf := fmt.Sprintf(\u0026#34;%.4f\u0026#34;, f) 2float, = strconv.ParseFloat(sprintf, 64) é€šè¿‡å ä½ç¬¦ %.4f æ¥ç¡®å®šå°æ•°ç‚¹åé¢ä¿ç•™å‡ ä½\nè¿™ä¸ªæ–¹å¼åœ¨æ€§èƒ½ä¸Šæ¯”æ•°å­¦è®¡ç®—çš„è¦å·®å¥½å¤šï¼Œç”¨benchmark æµ‹è¯•ä¸€ä¸‹\n1package main 2 3import ( 4 \u0026#34;fmt\u0026#34; 5 \u0026#34;math/rand\u0026#34; 6 \u0026#34;strconv\u0026#34; 7 \u0026#34;testing\u0026#34; 8) 9 10func BenchmarkFloatRetainBit(b *testing.B) { 11 f := rand.Float64() 12 for i := 0; i \u0026lt; b.N; i++ { 13 FloatRetainBit(f, 5) 14 } 15} 16 17func BenchmarkFloatRetainFmt(b *testing.B) { 18 f := rand.Float64() 19 for i := 0; i \u0026lt; b.N; i++ { 20 sprintf := fmt.Sprintf(\u0026#34;%.4f\u0026#34;, f) 21 _, _ = strconv.ParseFloat(sprintf, 64) 22 } 23} æ‰§è¡Œï¼š\n1go test -bench . -benchmem ç»“æœï¼š\n1goos: windows 2goarch: amd64 3pkg: test2 4cpu: AMD Ryzen 5 3500X 6-Core Processor 5BenchmarkFloatRetainBit-6 310487731 3.865 ns/op 0 B/op 0 allocs/op 6BenchmarkFloatRetainFmt-6 3773605 322.6 ns/op 16 B/op 2 allocs/op 7PASS 8ok test2 3.179s å¯ä»¥çœ‹åˆ°ï¼Œæ— è®ºæ˜¯é€Ÿåº¦è¿˜æ˜¯å†…å­˜ä½¿ç”¨ä¸Šï¼Œéƒ½æ˜¯æ•°å­¦è®¡ç®—æ›´å¥½\n","date":"2023-04-17T19:08:17Z","image":"https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/OIP-C.5vDPz8YnSqT_cxT-CicKkwHaEK","permalink":"https://lqxhub.github.io/posts/9a5e1240/","title":"goå°æ•°å››èˆäº”å…¥å–æ•´"},{"content":"å¥½ä¹…æ²¡æœ‰å†™ä¸œè¥¿äº†ï¼Œä¸Šæ¬¡å†™è¿˜æ˜¯åœ¨å»å¹´10æœˆï¼Œéƒ½å¿«åŠå¹´äº†ã€‚è¿™æœŸé—´ï¼Œé™¤äº†å·¥ä½œæ¯”è¾ƒå¿™å¤–ï¼Œä¹Ÿå¼€å§‹å‚ä¸ä¸€äº›å¼€æºé¡¹ç›®ï¼Œæ¯”å¦‚ pika åˆšå¥½ä»Šå¹´pikaåšäº†ä¸€äº›æ”¹åŠ¨ï¼Œæ¯”å¦‚ç¼–è¯‘æ–¹å¼ä»MakeFile æ”¹æˆäº† cmakeã€‚æˆ‘æœ‰å¹¸å‚ä¸äº†ä¸€äº›å·¥ä½œï¼Œæ­£å¥½è¶æ­¤æœºä¼šï¼Œåˆæ·±å…¥å­¦ä¹ äº†ä¸€ä¸‹cmake çš„çŸ¥è¯†ï¼Œè¿™å‘¨æœ«æœ‰æ—¶é—´ï¼Œæ¥è®°å½•ä¸€ä¸‹\nä»¥å‰æˆ‘ä¹Ÿå†™è¿‡ä¸¤ç¯‡å’Œcmakeç›¸å…³çš„æ–‡ç« ï¼Œè¿™æ¬¡åˆæœ‰äº†æ–°çš„æ”¶è·ï¼Œå°±æƒ³ç€å†å†™ä¸€ç¯‡è®°å½•ä¸€ä¸‹\næˆ‘é‚£å°±ä»pikaä¸­ç”¨åˆ°çš„cmakeçš„ä¸€äº›çŸ¥è¯†ï¼Œè®°å½•ä¸€ä¸‹å§ã€‚æˆ‘æ²¡æœ‰æ‰¾åˆ°å¥½çš„ä¸­æ–‡cmakeæ–‡æ¡£ï¼Œé‡åˆ°é—®é¢˜æœ€å¥½è¿˜æ˜¯å»å®˜ç½‘æŸ¥ï¼Œæ–‡ä¸­çš„ç›¸å…³çŸ¥è¯†,å¾ˆå¤šéƒ½æ˜¯ä»å®˜ç½‘å­¦åˆ°çš„ã€‚cmakeå®˜ç½‘ ä¼ é€é—¨\nfind_program ä¸»è¦åŠŸèƒ½æ˜¯æ£€æŸ¥å½“å‰ç³»ç»Ÿä¸Šæ˜¯å¦æœ‰å¯¹åº”çš„ç¨‹åº\næ¯”å¦‚åœ¨pikaä¸­ï¼Œç”¨æ¥æ£€æŸ¥ç³»ç»Ÿä¸­æ˜¯å¦æœ‰autoconfè¿™ä¸ªç¨‹åº\nè¿™ä¸ªå‡½æ•°çš„ç¬¬ä¸€å‚æ•°æ˜¯ä¸€ä¸ªå˜é‡ï¼Œç”¨æ¥æ¥æ”¶æ£€æŸ¥ç»“æœ\nç¬¬äºŒä¸ªå‚æ•°æ˜¯è¦æ£€æŸ¥çš„ç¨‹åºçš„åå­—\nåé¢æ˜¯ä¸€äº›å¯é€‰å‚æ•°ï¼Œåœ¨cmakeä¸­ï¼Œå¯é€‰å‚æ•°è¦åŠ ä¸Šå‚æ•°çš„åæ¯”å¦‚åœ¨è¿™é‡Œï¼Œè¦ç»™å‡ºæ£€æŸ¥çš„è·¯å¾„ï¼Œå‚æ•°åæ˜¯PATHS\n1find_program(AUTOCONF 2 autoconf 3 PATHS /usr/bin /usr/local/bin) 4 5if (${AUTOCONF} MATCHES AUTOCONF-NOTFOUND) 6 message(FATAL_ERROR \u0026#34;not find autoconf on localhost\u0026#34;) 7endif() åé¢é€šè¿‡æ¯”è¾ƒ AUTOCONF æ˜¯ä¸æ˜¯ AUTOCONF-NOTFOUNDæ¥ç¡®å®šç³»ç»Ÿä¸­æ˜¯å¦å­˜åœ¨ autoconfè¿™ä¸ªç¨‹åº\nè¿™çŸ¥è¯†æœ€åŸºæœ¬çš„ç”¨æ³•ï¼Œfind_program è¿˜æœ‰å¾ˆå¤šå‚æ•°ï¼Œå¯ä»¥å®ç°æ›´å¤šçš„åŠŸèƒ½ï¼Œå¯ä»¥å»å®˜ç½‘ç›´æ¥å­¦ä¹ ä¼ é€é—¨\nexecute_process ä¸»è¦åŠŸèƒ½æ˜¯æ‰§è¡Œä¸€ä¸ªå‘½ä»¤ï¼Œä¸€èˆ¬å¸¸ç”¨äºæ‰§è¡Œä¸€ä¸ªæœ¬æœºçš„ç¨‹åºæˆ–è€…è„šæœ¬\nè¿™ä¸ªå‡½æ•°å¸¸ç”¨çš„æœ‰ä¸‹é¢è¿™äº›å‚æ•°\nCOMMAND è¦æ‰§è¡Œçš„å‘½ä»¤ï¼Œåé¢å¯ä»¥åŠ å‚æ•°ï¼Œå¯ä»¥æ”¯æŒæ‰§è¡Œå¤šä¸ªå‘½ä»¤\nWORKING_DIRECTORY è¿™ä¸ªå‘½ä»¤æ‰§è¡Œæ—¶çš„å·¥ä½œç›®å½•\nTIMEOUT æ‰§è¡Œè¿™ä¸ªå‘½ä»¤çš„è¶…æ—¶æ—¶é—´\nRESULT_VARIABLE è¿™æ˜¯ä¸€ä¸ªå˜é‡ï¼Œä¿å­˜å‘½ä»¤æ‰§è¡Œçš„ç»“æœ\nOUTPUT_VARIABLE è°ƒç”¨ç»“æœçš„è¿”å›å€¼\nERROR_VARIABLE å¦‚æœå‡ºé”™äº†ï¼Œerrorçš„è¿”å›å€¼\nåœ¨pikaä¸­çš„åº”ç”¨\n1execute_process(COMMAND sh ${CMAKE_UTILS_DIR}/Get_OS_Version.sh 2 OUTPUT_VARIABLE OS_VERSION) è¿™æ®µå‘½ä»¤çš„ä½œç”¨æ˜¯æ‰§è¡Œä¸€ä¸ªshellè„šæœ¬ï¼Œå¾—åˆ°è¿™ä¸ªè„šæœ¬çš„è¿”å›å€¼\néœ€è¦æ³¨æ„çš„æ˜¯ï¼Œexecute_processä¸æ˜¯ä½¿ç”¨shellå»æ‰§è¡Œå‘½ä»¤ï¼Œæ‰€ä»¥è¦æŒ‡å®šæ‰§è¡Œçš„ç¨‹åºã€‚\næ¯”å¦‚è¿™é‡Œï¼Œè¦æ‰§è¡Œshellè„šæœ¬ï¼Œå¿…é¡»æŒ‡å®šç”¨shç¨‹åºå»æ‰§è¡Œè¿™ä¸ªè„šæœ¬ã€‚\ncmake_host_system_information è·å–æœ¬æœºçš„ä¸€äº›ä¿¡æ¯\nè¿™ä¸ªå‡½æ•°ä½¿ç”¨æ¯”è¾ƒç®€å•ï¼Œåªæœ‰ä¸¤ä¸ªå‚æ•°ï¼Œ\nRESULT è·å–çš„ç»“æœ\nQUERY è¦è·å–çš„ä¿¡æ¯\nQUERY å¸¸ç”¨çš„å€¼ï¼Œè¿™äº›å€¼åœ¨ä¸åŒç‰ˆæœ¬çš„cmakeä¸Šæ”¯æŒç¨‹åº¦ä¹Ÿæ˜¯ä¸ä¸€æ ·çš„ï¼Œä½¿ç”¨å‰è¿˜æ˜¯å»å®˜ç½‘çœ‹ä¸€ä¸‹ï¼Œä¼ é€é—¨\nNUMBER_OF_LOGICAL_CORESï¼šé€»è¾‘æ ¸å¿ƒæ•°é‡ã€‚ NUMBER_OF_PHYSICAL_CORESï¼šç‰©ç†æ ¸å¿ƒæ•°é‡ã€‚ HOSTNAMEï¼šä¸»æœºåç§°ã€‚ TOTAL_VIRTUAL_MEMORYï¼šæ€»è™šæ‹Ÿå†…å­˜ï¼Œå•ä½æ˜¯Mã€‚ AVAILABLE_VIRTUAL_MEMORYï¼šå¯ç”¨è™šæ‹Ÿå†…å­˜ï¼Œå•ä½æ˜¯Mã€‚ TOTAL_PHYSICAL_MEMORYï¼šæ€»ç‰©ç†å†…å­˜ï¼Œå•ä½æ˜¯Mã€‚ AVAILABLE_PHYSICAL_MEMORYï¼šå¯ç”¨ç‰©ç†å†…å­˜ï¼Œå•ä½æ˜¯Mã€‚ IS_64BITï¼šå¦‚æœå¤„ç†å™¨æ˜¯64ä½ï¼ŒæŸ¥è¯¢ç»“æœä¸º1ã€‚ HAS_FPUï¼šå¦‚æœå¤„ç†å™¨æ‹¥æœ‰æµ®ç‚¹å¤„ç†å•å…ƒï¼ŒæŸ¥è¯¢ç»“æœä¸º1ã€‚ HAS_MMXï¼šå¦‚æœå¤„ç†å™¨æ”¯æŒMMXæŒ‡ä»¤é›†ï¼ŒæŸ¥è¯¢ç»“æœä¸º1ã€‚ HAS_MMX_PLUSï¼šå¦‚æœå¤„ç†å™¨æ”¯æŒExt. MMXæŒ‡ä»¤é›†ï¼ŒæŸ¥è¯¢ç»“æœä¸º1ã€‚ HAS_SSEï¼šå¦‚æœå¤„ç†å™¨æ”¯æŒSSEæŒ‡ä»¤é›†ï¼ŒæŸ¥è¯¢ç»“æœä¸º1ã€‚ HAS_SSE2ï¼šå¦‚æœå¤„ç†å™¨æ”¯æŒSSE2æŒ‡ä»¤é›†ï¼ŒæŸ¥è¯¢ç»“æœä¸º1ã€‚ HAS_SSE_FPï¼šå¦‚æœå¤„ç†å™¨æ”¯æŒSSE FPæŒ‡ä»¤é›†ï¼ŒæŸ¥è¯¢ç»“æœä¸º1ã€‚ HAS_SSE_MMXï¼šå¦‚æœå¤„ç†å™¨æ”¯æŒSSE MMXæŒ‡ä»¤é›†ï¼ŒæŸ¥è¯¢ç»“æœä¸º1ã€‚ HAS_AMD_3DNOWï¼šå¦‚æœå¤„ç†å™¨æ”¯æŒ3DNowæŒ‡ä»¤é›†ï¼ŒæŸ¥è¯¢ç»“æœä¸º1ã€‚ HAS_AMD_3DNOW_PLUSï¼šå¦‚æœå¤„ç†å™¨æ”¯æŒ3DNow+æŒ‡ä»¤é›†ï¼ŒæŸ¥è¯¢ç»“æœä¸º1ã€‚ HAS_IA64ï¼šå¦‚æœIA64å¤„ç†å™¨å¯ä»¥æ¨¡æ‹ŸX86ï¼ŒæŸ¥è¯¢ç»“æœä¸º1ã€‚ HAS_SERIAL_NUMBERï¼šå¦‚æœå¤„ç†å™¨æœ‰åºåˆ—å·ï¼ŒæŸ¥è¯¢ç»“æœä¸º1ã€‚ PROCESSOR_SERIAL_NUMBERï¼šå¤„ç†å™¨åºåˆ—å·ã€‚ PROCESSOR_NAMEï¼šå¯è¯»çš„å¤„ç†å™¨å…¨ç§°ã€‚ OS_NAMEï¼šæ“ä½œç³»ç»Ÿåç§°ï¼Œä¹Ÿå°±æ˜¯uname -sçš„è¾“å‡ºï¼Œä¸‰å¤§æ“ä½œç³»ç»Ÿå¯¹åº”çš„åç§°æ˜¯Linuxã€Windowså’ŒDarwinï¼ˆmasOSï¼‰ï¼Œä¹Ÿå¯ä»¥é€šè¿‡CMAKE_HOST_SYSTEM_NAMEå˜é‡è·å–ã€‚ OS_RELEASEï¼šæ“ä½œç³»ç»Ÿå­ç±»å‹ï¼Œä¾‹å¦‚Windows Professionalã€‚ OS_VERSIONï¼šæ“ä½œç³»ç»Ÿæ„å»ºIDã€‚ OS_PLATFORMï¼šå¤„ç†å™¨æ¶æ„ï¼ŒWindowsä¸‹å¯ä»¥é€šè¿‡PROCESSOR_ARCHITECTUREå˜é‡è·å–ï¼ŒUnix/Linux/macOSç­‰å¹³å°å¯ä»¥é€šè¿‡uname -mæˆ–uname -pè·å–ã€‚ä¹Ÿå¯ä»¥é€šè¿‡CMAKE_HOST_SYSTEM_PROCESSORå˜é‡è·å–ã€‚ ç¤ºä¾‹ï¼š\n1cmake_host_system_information(RESULT CPU_CORE QUERY NUMBER_OF_LOGICAL_CORES) 2message(STATUS \u0026#34;Cpu core ${CPU_CORE}\u0026#34;) è·å–å½“å‰ç”µè„‘çš„é€»è¾‘æ ¸æ•°\nExternalProject_Add è¿™ä¸ªå°±æ¯”è¾ƒå¤æ‚äº†ï¼Œä¸»è¦åŠŸèƒ½æ˜¯å¼•å…¥ä¸€ä¸ªå¤–éƒ¨é¡¹ç›®ã€‚æ¯”å¦‚åœ¨ä¸€äº›é¡¹ç›®ä¸­ï¼Œéœ€è¦åˆ«çš„åº“ï¼Œå¯ä»¥ä½¿ç”¨è¿™ä¸ªå‡½æ•°æ¥å®ç°ã€‚åªéœ€è¦ä¸€äº›ç®€å•çš„é…ç½®å°±èƒ½å®Œæˆä¾èµ–çš„ç¼–è¯‘å’Œå®‰è£…ï¼Œæå¤§çš„ç®€åŒ–äº†C++çš„ä¾èµ–ç®¡ç†ã€‚\nä½¿ç”¨è¿™ä¸ªå‡½æ•°å‰ï¼Œéœ€è¦å…ˆå¯¼å…¥\n1include(ExternalProject) è¿™ä¸ªå‡½æ•°çš„å¸¸ç”¨å‚æ•°æœ‰\nDirectory Options: è¿™éƒ¨åˆ†æ˜¯ç›®å½•ç›¸å…³çš„é…ç½®\nPREFIXï¼šå¤–éƒ¨é¡¹ç›®çš„æ ¹ç›®å½•\nTMP_DIRï¼šå¤–éƒ¨é¡¹ç›®çš„ä¸´æ—¶ç›®å½•\nLOG_DIR ï¼šå¤–éƒ¨é¡¹ç›®åœ¨æ‰§è¡Œæ—¶ï¼Œäº§ç”Ÿçš„logç›®å½•\nSTAMP_DIRï¼šå¤–éƒ¨é¡¹ç›®åœ¨æ‰§è¡Œæ—¶ï¼Œæ¯ä¸€æ­¥çš„æ—¶é—´æˆ³éƒ½ä¼šè®°å½•åœ¨è¿™é‡Œï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®LOG_DIR logæ–‡ä»¶é»˜è®¤ä¹Ÿä¼šåœ¨è¿™é‡Œ\nDOWNLOAD_DIRï¼š å¤–éƒ¨é¡¹ç›®ä¸‹è½½æ–‡ä»¶çš„å­˜æ”¾ç›®å½•\nSOURCE_DIRï¼š å¤–éƒ¨é¡¹ç›®çš„æºç å­˜æ”¾ç›®å½•\nBINARY_DIRï¼š å¤–éƒ¨é¡¹ç›®ç¼–è¯‘äº§ç”Ÿçš„äºŒè¿›åˆ¶æ–‡ä»¶çš„å­˜æ”¾ç›®å½•\nINSTALL_DIRï¼š å¤–éƒ¨é¡¹ç›®ç¼–è¯‘äº§ç”Ÿçš„åŠ¨æ€åº“å’Œé™æ€åº“çš„å­˜æ”¾ç›®å½•\nå¦‚æœè®¾ç½®äº†PREFIX å±æ€§ï¼Œé‚£ä¹ˆé»˜è®¤çš„ç›®å½•ç»“æ„æ˜¯è¿™æ ·çš„\n1TMP_DIR = \u0026lt;prefix\u0026gt;/tmp 2STAMP_DIR = \u0026lt;prefix\u0026gt;/src/\u0026lt;name\u0026gt;-stamp 3DOWNLOAD_DIR = \u0026lt;prefix\u0026gt;/src 4SOURCE_DIR = \u0026lt;prefix\u0026gt;/src/\u0026lt;name\u0026gt; 5BINARY_DIR = \u0026lt;prefix\u0026gt;/src/\u0026lt;name\u0026gt;-build 6INSTALL_DIR = \u0026lt;prefix\u0026gt; 7LOG_DIR = \u0026lt;STAMP_DIR\u0026gt; å¦‚æœè®¾ç½®äº†EP_BASEï¼Œç›®å½•ç»“æ„æ˜¯è¿™æ ·çš„\n1TMP_DIR = \u0026lt;base\u0026gt;/tmp/\u0026lt;name\u0026gt; 2STAMP_DIR = \u0026lt;base\u0026gt;/Stamp/\u0026lt;name\u0026gt; 3DOWNLOAD_DIR = \u0026lt;base\u0026gt;/Download/\u0026lt;name\u0026gt; 4SOURCE_DIR = \u0026lt;base\u0026gt;/Source/\u0026lt;name\u0026gt; 5BINARY_DIR = \u0026lt;base\u0026gt;/Build/\u0026lt;name\u0026gt; 6INSTALL_DIR = \u0026lt;base\u0026gt;/Install/\u0026lt;name\u0026gt; 7LOG_DIR = \u0026lt;STAMP_DIR\u0026gt; åœ¨pikaä¸­ï¼Œæ˜¯è¿™æ ·è®¾ç½®çš„\n1set(EP_BASE_SUFFIX \u0026#34;buildtrees\u0026#34;) 2set_property(DIRECTORY PROPERTY EP_BASE ${CMAKE_CURRENT_SOURCE_DIR}/${EP_BASE_SUFFIX}) æœ€åçš„ç›®å½•ç»“æ„æ˜¯è¿™æ ·çš„\n1buildtrees/ 2â”œâ”€â”€ Build 3â”œâ”€â”€ Download 4â”œâ”€â”€ Install 5â”œâ”€â”€ Source 6â”œâ”€â”€ Stamp 7â””â”€â”€ tmp Download Step Options: è¿™éƒ¨åˆ†æ˜¯ä¾èµ–ä¸‹è½½ç›¸å…³çš„ï¼Œä¸‹è½½åˆå¯ä»¥åˆ†urlä¸‹è½½ï¼Œgitã€svnã€ç­‰ç­‰ç‰ˆæœ¬ç®¡ç†å·¥å…·çš„ä¸‹è½½\nURLï¼šæ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œå°±æ˜¯ä¸‹è½½ä¾èµ–åŒ…æˆ‘ç½‘å€\nURL_HASHï¼šå¯¹ä¸‹è½½çš„æ–‡ä»¶åšæ ¡éªŒï¼Œå¿…é¡»è¦æŒ‡å®šæ ¡éªŒçš„ç®—æ³•ï¼Œæ¯”å¦‚ SHA1=0cf3c3d176a2134dec9702c64abb13da593aea0c\nURL_MD5ï¼šä½¿ç”¨md5å¯¹æ–‡ä»¶æ ¡éªŒ\nDOWNLOAD_NAMEï¼šä¸‹è½½çš„æ–‡ä»¶å\nTIMEOUTï¼šä¸‹è½½çš„è¶…æ—¶æ—¶é—´\nGIT_REPOSITORYï¼šæ‹‰å–ä»£ç çš„gitä»“åº“çš„urlåœ°å€\nGIT_TAGï¼šæ‹‰å–ä»£ç çš„tag\nè¿˜æœ‰ä¸€äº›å°±ä¸ä¸€ä¸€åˆ—ä¸¾äº†\nConfigure Step Options: ç¼–è¯‘å‰çš„å‡†å¤‡æ­¥éª¤ï¼Œæ¯”å¦‚ç”ŸæˆMakeFile\nCONFIGURE_COMMANDï¼š é€šè¿‡autoconfç”ŸæˆMakeFileæ–‡ä»¶\nCMAKE_COMMANDï¼šä½¿ç”¨CMakeList.txtç”ŸæˆMakeFileæ–‡ä»¶\nCMAKE_ARGSï¼šcmakeçš„å‚æ•°\nBuild Step Options: ç¼–è¯‘ç›¸å…³çš„å‚æ•°\nBUILD_COMMANDï¼šç¼–è¯‘å‘½ä»¤\nBUILD_IN_SOURCEï¼šæ˜¯å¦åœ¨æºä»£ç ç›®å½•è¿›è¡Œç¼–è¯‘ï¼Œä¸€èˆ¬æ¥è¯´è¿™ä¸ªä¸ç”¨æŒ‡å®šå³å¯\nBUILD_ALWAYSï¼šå¯ç”¨æ­¤é€‰é¡¹å°†å¼ºåˆ¶å§‹ç»ˆè¿è¡Œæ„å»ºæ­¥éª¤ã€‚è¿™å¯èƒ½æ˜¯æœ€ç®€å•çš„æ–¹æ³•ï¼Œå¯ä»¥å¯é åœ°ç¡®ä¿è¯„ä¼°å¤–éƒ¨é¡¹ç›®è‡ªå·±çš„æ„å»ºä¾èµ–å…³ç³»ï¼Œè€Œä¸æ˜¯ä¾èµ–äºé»˜è®¤çš„åŸºäºæˆåŠŸæ—¶é—´æˆ³çš„æ–¹æ³•ã€‚ä¸€èˆ¬ä¹Ÿä¸ç”¨è®¾ç½®\nåé¢çš„ä¸€äº›ä¸å¤ªå¸¸ç”¨ï¼Œå°±ä¸åˆ—ä¸¾äº†ã€‚æœ‰éœ€è¦è¿˜æ˜¯çœ‹å®˜æ–¹æ–‡æ¡£\nåœ¨pikaä¸­çš„ä½¿ç”¨ 1ExternalProject_Add(gflags 2 URL 3 https://github.com/gflags/gflags/archive/refs/tags/v2.2.2.tar.gz 4 URL_HASH 5 MD5=1a865b93bacfa963201af3f75b7bd64c 6 DOWNLOAD_NO_PROGRESS 7 1 8 UPDATE_COMMAND 9 \u0026#34;\u0026#34; 10 LOG_CONFIGURE 11 1 12 LOG_BUILD 13 1 14 LOG_INSTALL 15 1 16 BUILD_ALWAYS 17 1 18 CMAKE_ARGS 19 -DCMAKE_INSTALL_PREFIX=${STAGED_INSTALL_PREFIX} 20 -DCMAKE_BUILD_TYPE=${LIB_BUILD_TYPE} 21 -DGFLAGS_NAMESPACE=gflags 22 -DBUILD_STATIC_LIBS=ON 23 -DBUILD_SHARED_LIBS=OFF 24 BUILD_COMMAND 25 make -j${CPU_CORE} 26) å°±æ˜¯ä¸€äº›å¾ˆå¸¸è§„çš„ä½¿ç”¨\næ€»ç»“ cmakeåŠŸèƒ½è¿˜æ˜¯éå¸¸å¼ºå¤§ï¼Œä½†æ˜¯åŒæ ·çš„ï¼Œä½¿ç”¨ä¹Ÿæ˜¯æƒ³å¯¹å¤æ‚çš„ï¼Œè€Œä¸”ä¹Ÿæ²¡æœ‰ç›¸å¯¹å¥½çš„ä¸­æ–‡æ–‡æ¡£ï¼Œè¦ç”¨å¥½è¿˜æ˜¯æœ‰ä¸€å®šå­¦ä¹ é—¨æ§›çš„ã€‚ä½†æ˜¯ç”¨å¥½cmake å¯ä»¥å¾ˆå¤§ç¨‹åº¦ä¸Šå‡è½»ä¸€äº›å·¥ä½œé‡çš„ã€‚\npikaåœ¨æ”¹ç”¨cmakeçš„è¿‡ç¨‹ä¸­æˆ‘ä¹Ÿæäº¤è¿‡å‡ ä¸ªç®€å•çš„PRï¼Œä¹Ÿæ˜¯ä¸€æ¬¡å¾ˆå¥½çš„å­¦ä¹ è¿‡ç¨‹ï¼Œå…ˆè®°å½•è¿™äº›å§ï¼Œåé¢æƒ³èµ·æ¥å†è¡¥å……ã€‚\n","date":"2023-04-16T12:53:34Z","image":"https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/bdbfc42c62bafe98a218d05d53402cb4ecb80454.jpg","permalink":"https://lqxhub.github.io/posts/d026638f/","title":"cmakeç¬”è®°3ã€‚CMakeä¸­å‡ ä¸ªå¸¸ç”¨å‡½æ•°å’Œå‘½ä»¤çš„åº”ç”¨åœºæ™¯å’Œä»£ç ç¤ºä¾‹ï¼Œfind_programã€execute_processã€cmake_host_system_informationä»¥åŠExternalProject_Add"},{"content":"è®¿é—®æœ¬æœºç½‘ç»œçš„æ–¹å¼ è®¿é—®åŒä¸€å°ç”µè„‘ä¸Šçš„ç½‘ç»œï¼Œä¸€èˆ¬ç”¨çš„åœ°å€æ˜¯ localhost æˆ–è€… 127.0.0.1è¿™ä¸¤ç§æ–¹å¼ï¼Œæ¯”å¦‚æœ¬æœºæœ‰ä¸€ä¸ªNginxæœåŠ¡å™¨ï¼Œæƒ³è¦è®¿é—®æœ¬æœºNginxï¼Œåœ¨æµè§ˆå™¨ä¸­è¾“å…¥localhost æˆ–è€… 127.0.0.1å°±èƒ½è®¿é—®åˆ°Nginxçš„é¦–é¡µã€‚å¦‚æœè¦è¿æ¥åˆ°æœ¬æœºçš„mysqlï¼Œ åœ¨è¿æ¥çš„æ—¶å€™ï¼ŒæŠŠåœ°å€å¡«127.0.0.1å°±å¥½äº†\ntcp æœ¬åœ°å›ç¯ ä¸ºä»€ä¹ˆä½¿ç”¨localhostæˆ–è€…1270.0.1å°±èƒ½è®¿é—®æœ¬æœºçš„ç½‘ç»œæˆ–è€…ç¨‹åºå‘¢ï¼Œæ˜¯å› ä¸ºåœ¨æ¯å°ç”µè„‘ä¸Šéƒ½æœ‰ä¸€ä¸ªç‰¹æ®Šçš„ç½‘ç»œï¼Œè¿™ä¸ªç½‘ç»œå°±æ˜¯æœ¬åœ°å›ç¯ï¼ˆlocal loopbackï¼‰ã€‚localhostå¯ä»¥çœ‹åšæ˜¯ 127.0.0.1 çš„åŸŸåã€‚ä¸€èˆ¬åœ¨hostsæ–‡ä»¶ä¸­éƒ½ä¼šæœ‰ä¸€æ¡é…ç½®ï¼Œä½¿ localhost æ˜ å°„åˆ°1270.0.0.1\nåœ¨linuxç³»ç»Ÿ(debin 11)ä¸­, ä½¿ç”¨ ip aå‘½ä»¤å¯ä»¥æŸ¥çœ‹æœ¬æœºçš„ç½‘ç»œ\nå¯ä»¥çœ‹åˆ°ï¼Œç¬¬ä¸€ä¸ªç½‘ç»œå°±æ˜¯æœ¬åœ°å›ç¯ï¼ˆloopbackï¼‰ï¼Œä»–çš„ ip åœ°å€å°±æ˜¯å°±æ˜¯ 127.0.0.1\næœ¬åœ°å›ç¯ä¹Ÿæ˜¯ç½‘ç»œï¼Œæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„è™šæ‹Ÿç½‘å¡ã€‚ä½¿ç”¨æœ¬åœ°å›ç¯ç½‘ç»œæ—¶ï¼Œæ•°æ®ä¹Ÿä¼šç»è¿‡ç½‘ç»œæ ˆçš„å°åŒ…å’Œè§£åŒ…ã€‚\nå¯ä»¥çœ‹åˆ°ï¼Œtcpå±äºè¿è¾“å±‚ï¼ˆä¼ è¾“å±‚ï¼‰åè®®ï¼Œæ‰€ä»¥åœ¨æœ¬æœºå‘é€æ•°æ®æ—¶ï¼Œä¹Ÿä¼šç»è¿‡\n1ä¼ è¾“å±‚-\u0026gt;ç½‘ç»œå±‚-\u0026gt;lookback-\u0026gt;ç½‘ç»œå±‚-\u0026gt;ä¼ è¾“å±‚ è¿™æ ·ä¸€ä¸ªè¿‡ç¨‹ã€‚\nunix domain ä¸Šé¢è¯´äº†ä»€ä¹ˆæ˜¯ tcp æœ¬åœ°å›ç¯ï¼Œé‚£ä»€ä¹ˆæ˜¯ unix domain å‘¢ã€‚unix domain ä¸¥æ ¼æ¥è¯´ä¸æ˜¯ç½‘ç»œï¼Œæ˜¯unix å’Œ linuxç³»ç»Ÿæä¾›çš„ä¸€ä¸ªè¿›ç¨‹é—´é€šä¿¡çš„æ–¹å¼ï¼Œæœ‰ç‚¹ç±»ä¼¼ç®¡é“ã€‚çœ‹åå­—ä¹ŸçŸ¥é“ï¼Œunix domain åªæ”¯æŒunixç±»çš„ç³»ç»Ÿä¸­ï¼Œwindowsç³»ç»Ÿæ˜¯ä¸æ”¯æŒçš„ã€‚unix çš„ä½¿ç”¨æ–¹å¼å’Œ tcpå¾ˆåƒï¼Œä½†æ˜¯åº•å±‚çš„å·¥ä½œåŸç†å·®åˆ«å´å¾ˆå¤§ã€‚\nunix domain ä¸­çš„æ•°æ®ä¼ è¾“ å°±ä¸éœ€è¦ç½‘ç»œæ ˆäº†ï¼Œå¯ä»¥çœ‹åšæ˜¯æ“ä½œç³»ç»Ÿåšäº†ä¸€æ¬¡å†…å­˜ä¸­çš„ä¸€ä¸ªæ•°æ®å¤åˆ¶ã€‚\nä½¿ç”¨ unix domain å¦‚ä½•ä½¿ç”¨tcp ç›¸ä¿¡éƒ½å¾ˆç†Ÿäº†ï¼Œå°±ä¸ä¸Šdemoäº†ã€‚åªä¸Š unix domain çš„ä»£ç å§ã€‚å› ä¸º unix domain ä¸æ”¯æŒ windowsç³»ç»Ÿï¼Œæ‰€ä»¥è¦åœ¨linuxæˆ–è€…unixç³»ç»Ÿä¸­æµ‹è¯•ï¼Œä¸‹é¢ä¼šä½¿ç”¨goåœ¨debinä¸­æµ‹è¯•ä¸€ä¸‹\nunix domain å’Œtcp ä¸€æ · ä¹Ÿæ˜¯åˆ† æœåŠ¡å™¨ å’Œ å®¢æˆ·ç«¯ çš„\nunix domain æœåŠ¡å™¨ 1package main 2 3import ( 4\t\u0026#34;fmt\u0026#34; 5\t\u0026#34;io\u0026#34; 6\t\u0026#34;net\u0026#34; 7) 8 9func main() { 10\tlisten, err := GetUnixListen(\u0026#34;/tmp/test_server.sock\u0026#34;) 11\tif err != nil { 12\tpanic(err) 13\t} 14 15\tdefer listen.Close() 16\tfor { 17\tconn, err := listen.Accept() 18\tif err != nil { 19\tpanic(err) 20\t} 21 22\tbuf := make([]byte, 1024) 23\t//è¯»æ•°æ® 24\tn, err := conn.Read(buf) 25\tif err != nil \u0026amp;\u0026amp; err != io.EOF { 26\tpanic(err) 27\t} 28\tfmt.Printf(\u0026#34;%s\\n\u0026#34;, buf[:n]) 29 30\t//å†™æ•°æ® 31\t_, err = conn.Write([]byte(\u0026#34;hello\u0026#34;)) 32\tpanic(err) 33\t} 34} 35 36func GetUnixListen(addr string) (net.Listener, error) { 37\tlisten, err := net.Listen(\u0026#34;unix\u0026#34;, addr) 38\tif err != nil { 39\treturn nil, err 40\t} 41\treturn listen, nil 42} unix domain å®¢æˆ·ç«¯\n1package main 2 3import ( 4\t\u0026#34;fmt\u0026#34; 5\t\u0026#34;io\u0026#34; 6\t\u0026#34;net\u0026#34; 7) 8 9func main() { 10\tconn, err := GetUnixConn(\u0026#34;/tmp/test_server.sock\u0026#34;) 11\tif err != nil { 12\tpanic(err) 13\t} 14 15\tbuff := make([]byte, 1024) 16\tn, err := conn.Read(buff) 17\tif err != nil { 18\tif err != io.EOF { 19\tpanic(err) 20\t} 21\t} 22\tfmt.Printf(\u0026#34;%s\\n\u0026#34;, buff[:n]) 23 24\tconn.Write([]byte(\u0026#34;ok\u0026#34;)) 25} 26 27func GetUnixConn(addr string) (net.Conn, error) { 28\tconn, err := net.Dial(\u0026#34;unix\u0026#34;, addr) 29\tif err != nil { 30\treturn nil, err 31\t} 32\treturn conn, nil 33} å¯ä»¥çœ‹åˆ°ï¼Œåœ¨goä¸­ä½¿ç”¨ unix domainçš„api å’ŒtcpåŸºæœ¬æ²¡æœ‰åŒºåˆ«ã€‚æœ‰åŒºåˆ«çš„åœ°æ–¹æ˜¯åœ¨ç›‘å¬å’Œè¿æ¥çš„åœ°æ–¹ã€‚\ntcp é€šè¿‡ IP+ç«¯å£çš„æ–¹å¼æ¥ç¡®å®šåœ°å€çš„ï¼Œè€Œunix domain åŒæ—¶ä¸€ä¸ªæ–‡ä»¶ç¬¦ æ¥ç¡®å®šåœ°å€ã€‚\nå½“unix domainå¼€å¯ç›‘å¬åï¼Œä¼šåœ¨ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ã€‚åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œå°±ä¼šåœ¨ /tmp ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ªtest_server.sock æ–‡ä»¶ã€‚ è¿™æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„æ–‡ä»¶é€šè¿‡ fileå‘½ä»¤å¯ä»¥çœ‹åˆ°\n1file test_server.sock 2test_server.sock: socket å¦‚æœåœ¨åŒä¸€ä¸ªç›®å½•ä¸‹æœ‰ä¸€ä¸ªåŒåçš„æ–‡ä»¶ï¼Œunix domain çš„ç›‘å¬å°±ä¼šå¤±è´¥ã€‚å°±åƒä¸€ä¸ªç«¯å£é»˜è®¤åªèƒ½è¢«ç›‘å¬ä¸€æ¬¡ä¸€æ ·ã€‚\nunix domain å’Œ tcp loopback æ€§èƒ½å¯¹æ¯” æˆ‘æ²¡æœ‰è¿‡ä¸¥æ ¼çš„æ€§èƒ½æµ‹è¯•ï¼Œåªæ˜¯å†™äº†ä¸€äº›ç®€å•çš„æµ‹è¯•çœ‹äº†ä¸€ä¸‹ï¼Œåœ¨å‘é€å°çš„æ•°æ®åŒ…æ—¶ï¼Œunix domain çš„æ€§èƒ½ä¼šå¥½äº tcpã€‚å½“å‘é€å¤§çš„æ•°æ®åŒ…æ—¶ï¼Œä¸¤è€…çš„æ€§èƒ½å·®è·å¯ä»¥å¿½ç•¥ä¸è®¡äº†ã€‚\nè¿™ä¸ªä¹Ÿæ˜¯ç¬¦åˆé¢„æœŸçš„ï¼Œå°çš„æ•°æ®åŒ…æ—¶ï¼Œtcpä¼šç»è¿‡ç½‘ç»œåè®®æ ˆï¼Œå½“æ•°æ®é‡å˜å¤§æ—¶ï¼Œç½‘ç»œåè®®æ ˆçš„å½±å“å¯ä»¥å¿½ç•¥ä¸è®¡äº†ã€‚\næ€»ç»“ tcp look back å¯ä»¥åœ¨å¤šä¸ªå¹³å°ä½¿ç”¨ï¼Œé€šè¿‡æœ¬æœºçš„è™šæ‹Ÿç½‘å¡å®Œæˆæ•°æ®ä¼ è¾“ï¼Œéœ€è¦ç»è¿‡ç½‘ç»œåè®®æ ˆï¼Œæ€§èƒ½å¼€é”€ç›¸å¯¹å¤§ä¸€äº›ã€‚\nunix domain åªèƒ½åœ¨unixç±»ç³»ç»Ÿä¸­ä½¿ç”¨ï¼Œæ˜¯æ“ä½œç³»ç»Ÿæä¾›çš„ä¸€ç§è¿›ç¨‹é—´é€šä¿¡æ–¹å¼ã€‚ä¸éœ€è¦ç»è¿‡ç½‘ç»œåè®®æ ˆï¼Œæ€§èƒ½ç›¸å¯¹é«˜ä¸€äº›ã€‚\n","date":"2022-10-23T17:35:05Z","image":"https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/8025.jpg_wh860.jpg","permalink":"https://lqxhub.github.io/posts/afb2aaad/","title":"tcp loopbcakä¸unix domainåŒºåˆ«ä¸æ€§èƒ½å¯¹æ¯”ï¼Œåœ¨Linuxç³»ç»Ÿä¸­å¦‚ä½•ä½¿ç”¨è¿™ä¸¤ç§ç½‘ç»œé€šä¿¡æ–¹å¼ï¼Œå±•ç¤ºUnixå¥—æ¥å­—çš„ä½¿ç”¨æ–¹æ³•"},{"content":"ä»€ä¹ˆæ˜¯å†…å­˜é€ƒé€¸åˆ†æ å†…å­˜é€ƒé€¸åˆ†ææ˜¯goçš„ç¼–è¯‘å™¨åœ¨ç¼–è¯‘æœŸé—´ï¼Œæ ¹æ®å˜é‡çš„ç±»å‹å’Œä½œç”¨åŸŸï¼Œç¡®å®šå˜é‡æ˜¯å †ä¸Šè¿˜æ˜¯æ ˆä¸Š\nç®€å•è¯´å°±æ˜¯ç¼–è¯‘å™¨åœ¨ç¼–è¯‘æœŸé—´ï¼Œå¯¹ä»£ç è¿›è¡Œåˆ†æï¼Œç¡®å®šå˜é‡åˆ†é…å†…å­˜çš„ä½ç½®ã€‚å¦‚æœå˜é‡éœ€è¦åˆ†é…åœ¨å †ä¸Šï¼Œåˆ™ç§°ä½œå†…å­˜é€ƒé€¸äº†ã€‚\nä¸ºä»€ä¹ˆéœ€è¦é€ƒé€¸åˆ†æ å› ä¸ºgoè¯­è¨€æ˜¯è‡ªåŠ¨è‡ªåŠ¨å†…å­˜ç®¡ç†çš„ï¼Œä¹Ÿå°±æ˜¯æœ‰GCçš„ã€‚å¼€å‘è€…åœ¨å†™ä»£ç çš„æ—¶å€™ä¸éœ€è¦å…³å¿ƒè€ƒè™‘å†…å­˜é‡Šæ”¾çš„é—®é¢˜ï¼Œè¿™æ ·ç¼–è¯‘å™¨å’Œgoè¿è¡Œæ—¶ï¼ˆruntimeï¼‰å°±éœ€è¦å‡†ç¡®åˆ†é…å’Œç®¡ç†å†…å­˜ï¼Œæ‰€ä»¥ç¼–è¯‘å™¨åœ¨ç¼–è¯‘æœŸé—´è¦ç¡®å®šå˜é‡æ˜¯æ”¾åœ¨å †ç©ºé—´å’Œæ ˆç©ºé—´ã€‚\nå¦‚æœå˜é‡æ”¾é”™äº†ä½ç½®ä¼šæ€æ · æˆ‘ä»¬çŸ¥é“ï¼Œæ ˆç©ºé—´å’Œç”Ÿå‘½å‘¨æœŸæ˜¯å’Œå‡½æ•°ç”Ÿå‘½å‘¨æœŸç›¸å…³çš„ï¼Œå¦‚æœä¸€ä¸ªå‡½æ•°çš„å±€éƒ¨å˜é‡ç¦»å¼€äº†å‡½æ•°çš„èŒƒå›´ï¼Œæ¯”å¦‚å‡½æ•°ç»“æŸæ—¶ï¼Œå±€éƒ¨å˜é‡å°±ä¼šå¤±æ•ˆã€‚æ‰€ä»¥è¦æŠŠè¿™æ ·çš„å˜é‡æ”¾åˆ°å †ç©ºé—´ä¸Šã€‚\næ—¢ç„¶å¦‚æ­¤ï¼Œé‚£æŠŠæ‰€æœ‰åœ¨å˜é‡éƒ½æ”¾åœ¨å †ä¸Šä¸å°±è¡Œäº†ï¼Œè¿™æ ·ä¸€æ¥ï¼Œæ˜¯æ²¡å•¥é—®é¢˜äº†ï¼Œä½†æ˜¯å †å†…å­˜çš„ä½¿ç”¨æˆæœ¬æ¯”å å†…å­˜è¦é«˜å¥½å¤šã€‚ä½¿ç”¨å †å†…å­˜ï¼Œè¦å‘æ“ä½œç³»ç»Ÿç”³è¯·å’Œå½’è¿˜ï¼Œè€Œå å†…å­˜æ˜¯ç¨‹åºè¿è¡Œæ—¶å°±ç¡®å®šå¥½äº†ï¼Œå¦‚ä½•ä½¿ç”¨å®Œå…¨ç”±ç¨‹åºè‡ªå·±ç¡®å®šã€‚åœ¨æ ˆä¸Šåˆ†é…å’Œå›æ”¶å†…å­˜æˆæœ¬å¾ˆä½ï¼Œåªéœ€è¦ 2 ä¸ª CPU æŒ‡ä»¤ï¼šPUSH å’Œ POPï¼Œpush å°†æ•°æ®æ”¾åˆ°åˆ°æ ˆç©ºé—´å®Œæˆåˆ†é…ï¼Œpop åˆ™æ˜¯é‡Šæ”¾ç©ºé—´ã€‚\næ¯”å¦‚ C++ ç»å…¸é”™è¯¯ï¼Œreturn ä¸€ä¸ª å‡½æ•°å†…éƒ¨å˜é‡çš„æŒ‡é’ˆ\n1#include\u0026lt;iostream\u0026gt; 2 3int* one(){ 4 int i = 10; 5 return \u0026amp;i; 6} 7 8int main(){ 9 std::cout \u0026lt;\u0026lt; *one(); 10} è¿™æ®µä»£ç åœ¨ç¼–è¯‘çš„æ—¶å€™ä¼šå¦‚ä¸‹è­¦å‘Š:\n1one.cpp: åœ¨å‡½æ•°â€˜int* one()â€™ä¸­: 2one.cpp:4:6: è­¦å‘Šï¼šè¿”å›äº†å±€éƒ¨å˜é‡çš„â€˜iâ€™çš„åœ°å€ [-Wreturn-local-addr] 3 int i = 10; 4 ^ è™½ç„¶ç¨‹åºçš„è¿è¡Œç»“æœå¤§å¤šæ•°æ—¶å€™éƒ½å’Œæˆ‘ä»¬é¢„æœŸçš„ä¸€æ ·ï¼Œä½†æ˜¯è¿™æ ·çš„ä»£ç è¿˜æ˜¯æœ‰é£é™©çš„ã€‚\nè¿™æ ·çš„ä»£ç åœ¨goé‡Œå°±å®Œå…¨æ²¡æœ‰é—®é¢˜äº†ï¼Œå› ä¸ºgoçš„ç¼–è¯‘å™¨ä¼šæ ¹æ®å˜é‡çš„ä½œç”¨èŒƒå›´ç¡®å®šå˜é‡æ˜¯æ”¾åœ¨æ ˆä¸Šå’Œå †ä¸Šã€‚\nå†…å­˜é€ƒé€¸åœºæ™¯ goçš„ç¼–è¯‘å™¨æä¾›äº†é€ƒé€¸åˆ†æçš„å·¥å…·ï¼Œåªéœ€è¦åœ¨ç¼–è¯‘çš„æ—¶å€™åŠ ä¸Š -gcflags=-m å°±å¯ä»¥çœ‹åˆ°é€ƒé€¸åˆ†æçš„ç»“æœäº†\nå¸¸è§çš„æœ‰4ç§åœºæ™¯ä¸‹ä¼šå‡ºç°å†…å­˜é€ƒé€¸\nreturn å±€éƒ¨å˜é‡çš„æŒ‡é’ˆ 1package main 2 3func main() { 4 5} 6 7func One() *int { 8 i := 10 9 return \u0026amp;i 10} æ‰§è¡Œ go build -gcflags=-m main.go\n1# command-line-arguments 2.\\main.go:3:6: can inline main 3.\\main.go:7:6: can inline One 4.\\main.go:8:2: moved to heap: i å¯ä»¥çœ‹åˆ°å˜é‡ i å·²ç»è¢«åˆ†é…åˆ°å †ä¸Šäº†\ninterface{} åŠ¨æ€ç±»å‹ å½“å‡½æ•°ä¼ é€’çš„å˜é‡ç±»å‹æ˜¯ interface{} ç±»å‹çš„æ—¶å€™ï¼Œå› ä¸ºç¼–è¯‘å™¨æ— æ³•æ¨æ–­è¿è¡Œæ—¶å˜é‡çš„å®é™…ç±»å‹ï¼Œæ‰€ä»¥ä¹Ÿä¼šå‘ç”Ÿé€ƒé€¸\n1package main 2 3import \u0026#34;fmt\u0026#34; 4 5func main() { 6 i := 10 7 fmt.Println(i) 8} æ‰§è¡Œ go build -gcflags=-m .\\main.go\n1.\\main.go:11:13: inlining call to fmt.Println 2.\\main.go:11:13: i escapes to heap 3.\\main.go:11:13: []interface {} literal does not escape 4\u0026lt;autogenerated\u0026gt;:1: .this does not escape 5\u0026lt;autogenerated\u0026gt;:1: .this does not escape å¯çœ‹åˆ°ï¼Œi ä¹Ÿè¢«åˆ†é…åˆ°å †ä¸Šäº†\næ ˆç©ºé—´ä¸è¶³ å› ä¸ºæ ˆçš„ç©ºé—´æ˜¯æœ‰é™çš„ï¼Œæ‰€ä»¥åœ¨åˆ†é…å¤§å—å†…å­˜æ—¶ï¼Œä¼šè€ƒè™‘æ ˆç©ºé—´å†…å¦å­˜ä¸‹ï¼Œå¦‚æœæ ˆç©ºé—´å­˜ä¸ä¸‹ï¼Œä¼šåˆ†é…åˆ°å †ä¸Šã€‚\n1package main 2 3func main() { 4 Make10() 5 Make100() 6 Make10000() 7 MakeN(5) 8} 9 10func Make10() { 11 arr10 := make([]int, 10) 12 _ = arr10 13} 14 15func Make100() { 16 arr100 := make([]int, 100) 17 _ = arr100 18} 19 20func Make10000() { 21 arr10000 := make([]int, 10000) 22 _ = arr10000 23} 24 25func MakeN(n int) { 26 arrN := make([]int, n) 27 _ = arrN 28} æ‰§è¡Œ go build -gcflags=-m main.go\n1# command-line-arguments 2.\\main.go:10:6: can inline Make10 3.\\main.go:15:6: can inline Make100 4.\\main.go:20:6: can inline Make10000 5.\\main.go:25:6: can inline MakeN 6.\\main.go:3:6: can inline main 7.\\main.go:4:8: inlining call to Make10 8.\\main.go:5:9: inlining call to Make100 9.\\main.go:6:11: inlining call to Make10000 10.\\main.go:7:7: inlining call to MakeN 11.\\main.go:4:8: make([]int, 10) does not escape 12.\\main.go:5:9: make([]int, 100) does not escape 13.\\main.go:6:11: make([]int, 10000) escapes to heap 14.\\main.go:7:7: make([]int, n) escapes to heap 15.\\main.go:11:15: make([]int, 10) does not escape 16.\\main.go:16:16: make([]int, 100) does not escape 17.\\main.go:21:18: make([]int, 10000) escapes to heap 18.\\main.go:26:14: make([]int, n) escapes to heap å¯ä»¥çœ‹åˆ°å½“éœ€è¦åˆ†é…é•¿åº¦ä¸º10ï¼Œ100çš„intç±»å‹çš„sliceæ—¶ï¼Œä¸éœ€è¦é€ƒé€¸åˆ°å †ä¸Šï¼Œåœ¨æ ˆä¸Šå°±å¯ä»¥ï¼Œå¦‚æœsliceé•¿åº¦è¾¾åˆ°1000æ—¶ï¼Œå°±éœ€è¦åˆ†é…åˆ°å †ä¸Šäº†ã€‚\nè¿˜æœ‰ä¸€ç§æƒ…å†µï¼Œå½“åœ¨ç¼–è¯‘æœŸé—´é•¿åº¦ä¸ç¡®å®šæ—¶ï¼Œä¹Ÿéœ€è¦åˆ†é…åˆ°å †ä¸Šã€‚\né—­åŒ… 1package main 2 3func main() { 4 One() 5} 6 7func One() func() { 8 n := 10 9 return func() { 10 n++ 11 } 12} åœ¨å‡½æ•°Oneä¸­returnäº†ä¸€ä¸ªåŒ¿åå‡½æ•°ï¼Œå½¢æˆäº†ä¸€ä¸ªé—­åŒ…ï¼Œçœ‹ä¸€ä¸‹é€ƒé€¸åˆ†æ\n1# command-line-arguments 2.\\main.go:3:6: can inline main 3.\\main.go:9:9: can inline One.func1 4.\\main.go:8:2: moved to heap: n 5.\\main.go:9:9: func literal escapes to heap å¯ä»¥çœ‹åˆ° å˜é‡ n ä¹Ÿåˆ†é…åˆ°å †ä¸Šäº†\nè¿˜æœ‰ä¸€ç§æƒ…å†µï¼Œnew å‡ºæ¥çš„å˜é‡ä¸ä¸€å®šåˆ†é…åˆ°å †ä¸Š\n1package main 2 3func main() { 4 i := new(int) 5 _ = i 6} åƒjava C++ç­‰è¯­è¨€ï¼Œnew å‡ºæ¥çš„å˜é‡æ­£å¸¸éƒ½ä¼šåˆ†é…åˆ°å †ä¸Šï¼Œä½†æ˜¯åœ¨goé‡Œï¼Œnewå‡ºæ¥çš„å˜é‡ä¸ä¸€å®šåˆ†é…åˆ°å †ä¸Šï¼Œè‡³äºåˆ†é…åˆ°å“ªé‡Œï¼Œè¿˜æ˜¯çœ‹ç¼–è¯‘å™¨çš„é€ƒé€¸åˆ†ææ¥ç¡®å®š\nç¼–è¯‘ä¸€ä¸‹çœ‹çœ‹ go build -gcflags=-m main.go\n1# command-line-arguments 2.\\main.go:3:6: can inline main 3.\\main.go:4:10: new(int) does not escape å¯ä»¥çœ‹åˆ° newå‡ºæ¥çš„å˜é‡ï¼Œå¹¶æ²¡æœ‰é€ƒé€¸ï¼Œè¿˜æ˜¯åœ¨æ ˆä¸Šã€‚\nå¸¸è§çš„å†…å­˜é€ƒé€¸åœºæ™¯å·®ä¸å¤šå°±æ˜¯è¿™äº›äº†ï¼Œå†è¯´ä¸€ä¸‹å†…å­˜é€ƒé€¸å¸¦æ¥çš„å½±å“å§\næ€§èƒ½ é‚£è‚¯å®šå°±æ˜¯æ€§èƒ½é—®é¢˜äº†ï¼Œå› ä¸ºæ“ä½œæ ˆç©ºé—´æ¯”å †ç©ºé—´è¦å¿«å¤šäº†ï¼Œè€Œä¸”ä½¿ç”¨å †ç©ºé—´è¿˜ä¼šæœ‰GCé—®é¢˜ï¼Œé¢‘ç¹çš„åˆ›å»ºå’Œé‡Šæ”¾å †ç©ºé—´ï¼Œä¼šå¢åŠ GCçš„å‹åŠ›\nä¸€ä¸ªç®€å•çš„ä¾‹å­æµ‹è¯•ä¸€ä¸‹ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œå‡½æ•°è¿”å›ç»“æ„ä½“çš„æŒ‡é’ˆæ¯”ç›´æ¥è¿”å›ç»“æ„ä½“æ€§èƒ½è¦å¥½\n1package main 2 3import \u0026#34;testing\u0026#34; 4 5type MyStruct struct { 6 A int 7} 8 9func BenchmarkOne(b *testing.B) { 10 for i := 0; i \u0026lt; b.N; i++ { 11 One() 12 } 13} 14 15//go:noinline 16func One() MyStruct { 17 return MyStruct{ 18 A: 10, 19 } 20} 21 22func BenchmarkTwo(b *testing.B) { 23 for i := 0; i \u0026lt; b.N; i++ { 24 Two() 25 } 26} 27 28//go:noinline 29func Two() *MyStruct { 30 return \u0026amp;MyStruct{ 31 A: 10, 32 } 33} æ³¨æ„ è¢«è°ƒç”¨çš„å‡½æ•°ä¸€å®šè¦åŠ ä¸Š //go:noinline æ¥ç¦æ­¢ç¼–è¯‘å™¨å†…è”ä¼˜åŒ–\nç„¶åæ‰§è¡Œ\ngo test -bench . -benchmem\n1goos: windows 2goarch: amd64 3pkg: escape 4BenchmarkOne-6 951519297 1.26 ns/op 0 B/op 0 allocs/op 5BenchmarkTwo-6 74933496 15.4 ns/op 8 B/op 1 allocs/op 6PASS 7ok escape 2.698s å¯ä»¥æ˜æ˜¾çœ‹åˆ° å‡½æ•° Oneè¿”å›ç»“æ„ä½“ æ¯” å‡½æ•°Two è¿”å› ç»“æ„ä½“æŒ‡é’ˆ çš„æ€§èƒ½æ›´å¥½ï¼Œè€Œä¸”è¿˜ä¸ä¼šæœ‰å†…å­˜åˆ†é…ï¼Œä¸ä¼šå¢åŠ GCå‹åŠ›\næŠ›å¼€ç»“æ„ä½“çš„å¤§å°è°ˆæ€§èƒ½éƒ½æ˜¯è€æµæ°“ï¼Œå¦‚æœç»“æ„ä½“æ¯”è¾ƒå¤æ‚äº†è¿˜æ˜¯æŒ‡é’ˆæ€§èƒ½æ›´é«˜ï¼Œè¿˜æœ‰ä¸€äº›åœºæ™¯å¿…é¡»ä½¿ç”¨æŒ‡é’ˆï¼Œæ‰€ä»¥å®é™…å·¥ä½œä¸­è¿˜æ˜¯è¦åˆ†åœºæ™¯åˆç†ä½¿ç”¨\næœ€å å¸¸è§çš„go é€ƒé€¸åˆ†æå·®ä¸å¤šå°±æ˜¯è¿™äº›äº†ï¼Œè™½ç„¶goä¼šè‡ªåŠ¨ç®¡ç†å†…å­˜ï¼Œå‡å°äº†å†™ä»£ç çš„è´Ÿæ‹…ï¼Œä½†æ˜¯æƒ³è¦å†™å‡ºé«˜æ•ˆå¯é çš„ä»£ç è¿˜æ˜¯æœ‰ä¸€äº›ç»†èŠ‚æœ‰æ³¨æ„çš„ã€‚\n","date":"2022-10-15T20:13:45Z","image":"https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/51143d2916746e4930adcb7433814f52eb693f29.jpg","permalink":"https://lqxhub.github.io/posts/e0a249f3/","title":"èŠä¸€èŠgoçš„å†…å­˜é€ƒé€¸åˆ†æ"},{"content":"ä»€ä¹ˆæ˜¯å†…å­˜å¯¹é½å‘¢ ç®€å•è¯´å°±æ˜¯ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­ï¼Œç¨‹åºä¸­çš„å˜é‡åœ¨å†…å­˜ä¸­çš„åˆ†å¸ƒæƒ…å†µï¼Œä¸ºä»€ä¹ˆè¦æœ‰å¯¹é½è¿™ä¸ªé—®é¢˜å‘¢ï¼Œæ˜¯å› ä¸ºä¸åŒç±»å‹çš„å˜é‡å ç”¨å†…å­˜çš„å¤§å°æ˜¯ä¸ä¸€æ ·çš„ï¼Œ ä½†æ˜¯cpuæ¯æ¬¡è¯»å–çš„å†…å­˜é•¿åº¦æ˜¯å›ºå®šçš„ï¼Œä¸ºäº†cpuèƒ½é«˜æ•ˆçš„è¯»å†™æ•°æ®ï¼ˆcpuè¯»å–æ•°æ®ä¸æ˜¯ä¸€ä¸ªå­—èŠ‚ä¸€ä¸ªå­—èŠ‚è¯»å–çš„ï¼Œä¸€æ¬¡è¯»å–çš„ä¸€å—å†…å­˜ï¼‰ï¼Œ æ‰€ä»¥ç¼–è¯‘å™¨åœ¨ç¼–è¯‘çš„æ—¶å€™ä¼šé€šè¿‡å¡«å……ç©ºæ•°æ®(æ•°æ®ä¸æ˜¯è¿ç»­çš„)ï¼Œè®©ä¸€ä¸ªå˜é‡ï¼Œä½¿cpuèƒ½ä¸€æ¬¡æ“ä½œå°±èƒ½å®Œæˆè¯»å†™ã€‚è¿˜æœ‰è·¨å¹³å°çš„é—®é¢˜ï¼Œæœ‰çš„å¹³å°ä¸æ”¯æŒè®¿é—®ä»»æ„åœ°å€ä¸Šçš„ä»»æ„æ•°æ®ï¼Œå¿…é¡»æŒ‰ç…§é¡ºåºä¾æ¬¡æŒ‰å—è¯»å–ã€‚\nä¸€ä¸ªç®€å•çš„ä¾‹å­çœ‹ä¸€ä¸‹:\n1package main 2 3import ( 4 \u0026#34;fmt\u0026#34; 5 \u0026#34;unsafe\u0026#34; 6) 7 8type One struct { 9 a bool 10 b int8 11 c int32 12} 13 14type Two struct { 15 a bool 16 c int32 17 b int8 18} 19 20func main() { 21 fmt.Println(unsafe.Sizeof(One{})) 22 fmt.Println(unsafe.Sizeof(Two{})) 23} è¿™ä¸¤ä¸ªç»“æ„ä½“åœ¨è¿è¡Œæ—¶ï¼Œå ç”¨çš„å†…å­˜å¤§å°ï¼Œçœ‹èµ·æ¥åº”è¯¥æ¥è¯´æ˜¯ä¸€æ ·å¤§çš„ï¼Œæ¯•ç«Ÿå†…éƒ¨çš„å˜é‡æ˜¯ä¸€æ ·çš„ï¼Œåªæ˜¯é¡ºåºä¸åŒè€Œå·²ã€‚\nä½†å®é™…ä¸Šï¼Œå ç”¨çš„å†…å­˜æ˜¯ä¸ä¸€æ ·çš„ï¼Œçœ‹ä¸€ä¸‹è¿è¡Œç»“æœï¼š\n1go run main.go 24 312 ä¸ºä»€ä¹ˆä¼šè¿™æ ·å‘¢ï¼Œç”»ä¸€ä¸‹å†…å­˜çš„ç¤ºæ„å›¾å°±æ¸…æ¥šäº†\nOneçš„å†…å­˜ Twoçš„å†…å­˜\nå›¾ä¸­ç°è‰²çš„å—æ˜¯ä¸ºäº†å¯¹é½è€Œå¡«å……çš„æ— ç”¨åŒºåŸŸï¼Œå¯è§ One çš„ å†…å­˜åˆ©ç”¨ç‡æ¯” Two è¦é«˜å¥½å¤šï¼Œå› ä¸ºcpuä¸€æ¬¡è¯»å–çš„å†…å­˜å¤§å°æ˜¯4ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯32ä½ã€‚ä¸ºäº†èƒ½è®©cpuä¸€æ¬¡å°±è¯»å–å®Œè¿™ä¸ªå˜é‡ï¼Œæ‰€ä»¥ç¼–è¯‘å™¨å°±åšäº†ä¸€äº›è°ƒæ•´ï¼Œä½¿å†…å­˜åˆ©ç”¨ç‡ä½äº†ï¼Œä½†æ˜¯å´æé«˜äº†æ•ˆç‡ã€‚\nè¿™é‡Œåˆå¸¦æ¥ä¸€ä¸ªé—®é¢˜ï¼Œcpuä¸€æ¬¡è¯»å–æ•°æ®çš„é•¿åº¦æ˜¯å¦‚ä½•ç¡®å®šçš„ï¼Œè¿™ä¸ªå«å¯¹é½ç³»æ•°ã€‚\ngoä¸­æœ‰ä¸€ä¸ªå‡½æ•°ï¼Œå¯ä»¥è®¡ç®—å‡ºå¯¹é½ç³»æ•°ï¼Œä¸€æ®µä»£ç çœ‹ä¸€ä¸‹\n1package main 2 3import ( 4 \u0026#34;fmt\u0026#34; 5 \u0026#34;unsafe\u0026#34; 6) 7 8type One struct { 9 a bool 10 b int8 11} 12 13type Two struct { 14 a bool 15 c int32 16 b int8 17} 18 19type Three struct { 20 a bool 21 b int8 22 c int64 23} 24 25func main() { 26 fmt.Println(unsafe.Alignof(One{})) 27 fmt.Println(unsafe.Alignof(Two{})) 28 fmt.Println(unsafe.Alignof(Three{})) 29} è¿è¡Œç»“æœå¦‚ä¸‹\n1go run main.go 21 34 48 å¯ä»¥å¾—åˆ°ï¼Œcpuä¸€æ¬¡è¯»å–çš„æ•°æ®é•¿åº¦å’Œè¿™ç»“æ„ä½“ä¸­çš„æœ€å¤§çš„æ•°æ®æœ‰å…³ã€‚\nOne ä¸­æœ€å¤§çš„æ•°æ®é•¿åº¦æ˜¯1ä¸ªå­—èŠ‚, Two ä¸­æœ€å¤§çš„æ•°æ®é•¿åº¦æ˜¯4ä¸ªå­—èŠ‚, Three ä¸­æœ€å¤§çš„æ•°æ®é•¿åº¦æ˜¯8ä¸ªå­—èŠ‚\nå¦‚æœæˆ‘æ¢æˆ 32ä½æ“ä½œç³»ç»Ÿ å‘¢\n1$env:GOARCH=\u0026#34;386\u0026#34; 2go run main.go 31 44 54 æ­¤æ—¶çš„å¯¹é½ç³»æ•°å˜æˆäº†4ï¼Œå› ä¸º32ä½çš„ç³»ç»Ÿä¸€æ¬¡èƒ½å¤„ç†çš„æ•°æ®é•¿åº¦å°±æ˜¯ 4ä¸ªå­—èŠ‚ï¼Œè¯´æ˜å¯¹é½ç³»æ•°è¿˜å’Œæ“ä½œç³»ç»Ÿæœ‰å…³ã€‚\næ‰€ä»¥ï¼šå¯¹é½ç³»æ•°å’Œç»“æ„ä½“ä¸­æœ€å¤§çš„çš„æ•°æ®æœ‰å…³ï¼ŒåŒæ—¶å’Œæ“ä½œç³»ç»Ÿä¹Ÿæœ‰å…³ã€‚å–è¿™ä¸¤ä¸ªæ¡ä»¶ä¸­çš„å°å€¼\nå†…å­˜å¯¹é½çš„åˆ©å¼Š åˆ©\né«˜æ•ˆ. æ•°æ®åªéœ€è¦ä¸€æ¬¡å°±èƒ½å®Œæˆè¯»å†™ï¼Œæ•ˆç‡è‚¯å®šæ¯”å¤šæ¬¡è¯»å†™è¦é«˜æ•ˆ æ•°æ®åŸå­æ€§. è¿˜æ˜¯æ•°æ®ä¸€æ¬¡å°±èƒ½å®Œæˆè¯»å†™ï¼Œä¿è¯äº†åŸå­æ€§ å¼Š\né‚£å°±æ˜¯å†…å­˜çš„åˆ©ç”¨ç‡å˜ä½äº†ï¼Œè¿™ä¸ªå¯ä»¥é€šè¿‡ä¼˜åŒ–æ¥è§£å†³ä¸€éƒ¨åˆ†\nçœ‹ä¸€ä¸‹å¦‚æœæ²¡æœ‰å†…å­˜å¯¹é½çš„æƒ…å†µå§ï¼Œå¦‚æœåœ¨32ä½çš„ç³»ç»Ÿä¸Šï¼Œå˜é‡Cè¦ç»è¿‡ä¸¤æ¬¡æ‰èƒ½è¯»åˆ°\nä¸åŒç±»å‹çš„å¯¹é½ç³»æ•° åœ¨64ä½æ“ä½œç³»ç»Ÿä¸­\nç±»å‹ ç³»æ•° bool, byte, uint8, int8 1 uint16, int16 2 uint32, int32 4 float32, complex64 4 int, uint, int64, uint64,string,uintptr,float64 8 æœ‰ä¸ªç‰¹æ®Šçš„ç±»å‹ struct{} ç©ºç»“æ„ä½“ï¼Œè¿™ä¸ªç»“æ„ä½“çš„ç©ºé—´å¤§å°æ˜¯0ï¼Œä½†æ˜¯è®¡ç®—å‡ºçš„å¯¹é½ç³»æ•°æ˜¯1ã€‚\nè€Œä¸” struct{}çš„ä½ç½®ä¸åŒï¼Œå ç”¨çš„ç©ºé—´ä¹Ÿä¸ç›¸åŒ\n1package main 2 3import ( 4 \u0026#34;fmt\u0026#34; 5 \u0026#34;unsafe\u0026#34; 6) 7 8type One struct { 9 s struct{} 10 x int 11} 12type Two struct { 13 x int 14 s struct{} 15} 16 17func main() { 18 fmt.Println(unsafe.Sizeof(One{})) 19 fmt.Println(unsafe.Sizeof(Two{})) 20} è¿è¡Œç»“æœå¦‚ä¸‹:\n1go run main.go 28 316 One å’Œ Two ä¸­ï¼Œåªæ˜¯ struct{}çš„ä½ç½®ä¸åŒï¼Œå°±ä¼šå¯¼è‡´å†…å­˜å ç”¨ä¸åŒ\nä¹‹æ‰€ä»¥è¿™æ ·æ˜¯å› ä¸ºï¼Œå½“struct{} ä½œä¸ºç»“æ„ä½“æœ€åä¸€ä¸ªå­—æ®µæ—¶ï¼Œå¦‚æœstruct{}ä¸åšå¡«å……ï¼Œå°±ä¼šå¯¼è‡´æŒ‡å‘ struct{} çš„åœ°å€æŒ‡å‘äº† ç»“æ„ä½“ä¹‹å¤–äº†ï¼Œæ‰€ä»¥ä¸ºäº†å‡ºé”™ï¼Œå°±ä¼šå¡«å……ä¸€ä¸ªæ•°æ®ä½ç½®ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ª intçš„å¤§å°ã€‚\nå¦‚ä½•ä¼˜åŒ–å†…å­˜å¸ƒå±€ é¦–å…ˆï¼Œgoçš„ç¼–è¯‘å™¨ä¸ä¼šåšå†…å­˜å¯¹é½çš„ä¼˜åŒ–ï¼Œä¹Ÿå°±æ˜¯åœ¨ç¼–è¯‘æœŸé—´ï¼Œç¼–è¯‘å™¨ä¸ä¼šè°ƒæ•´ç»“æ„ä½“ä¸­å­—æ®µçš„é¡ºåºã€‚è‡³äºä¸ºå•¥ä¸åšï¼Œæˆ‘è¿˜æ²¡æƒ³é€šï¼Œæœ‰çŸ¥é“çš„æ¬¢è¿è¯„è®ºåŒºæ¢è®¨ã€‚\næ‰€ä»¥å†…å­˜å¯¹é½çš„ä¼˜åŒ–éœ€è¦æˆ‘ä»¬è‡ªå·±åšã€‚\næˆ‘è‡ªå·±æ€»ç»“çš„ä¸¤ç‚¹ï¼Œæ¬¢è¿è¡¥å……\nå°½é‡æŠŠç›¸åŒç±»å‹çš„å˜é‡æ”¾åˆ°ä¸€èµ· æŠŠå°çš„æ•°æ®æ”¾åˆ°å‰é¢ï¼Œå¤§çš„æ•°æ®æ”¾åˆ°åé¢ å¥½äº†ï¼Œå¸¸è§çš„goå†…å­˜å¯¹é½çš„é—®é¢˜ å·®ä¸å¤šå°±æ˜¯è¿™äº›äº†ã€‚\nè¯´å®è¯ï¼Œæˆ‘åœ¨å·¥ä½œä¸­ä¸æ˜¯ç‰¹åˆ«æ³¨æ„å†…å­˜å¯¹é½çš„é—®é¢˜ï¼Œåªæœ‰åœ¨æƒ³åˆ°çš„æ—¶å€™æ‰ä¼šåšä¸€ä¸‹ã€‚è¿™ä¸ªä¸œè¥¿å¸¦æ¥çš„æ”¶ç›Šä¸æ˜¯ç‰¹åˆ«å¤§ï¼Œåœ¨å†…å­˜åŠ¨ä¸åŠ¨16Gèµ·æ­¥çš„æ—¶ä»£ï¼Œè¿™ç‚¹ä¼˜åŒ–å¯ä»¥å¿½ç•¥ä¸è®¡çš„ï¼Œå½“åšçŸ¥è¯†äº†è§£ä¸€ä¸‹å°±å¥½äº†ã€‚\n","date":"2022-09-24T18:56:10Z","image":"https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/13daf0aa276c1739c5ae961efd41eeacac540a19.jpg","permalink":"https://lqxhub.github.io/posts/4992c058/","title":"èŠä¸€èŠgoçš„å†…å­˜å¯¹é½"},{"content":"ç»™Githubä¸Šçš„å¼€æºé¡¹ç›®è´¡çŒ®ä»£ç ï¼Œå°±å°‘ä¸äº† pull request ä¹Ÿä¼šç®€ç§°ä¸º PR æˆ–è€… MR\nä¸ºå•¥æˆ‘ä¸èƒ½ç›´æ¥ç»™å¼€æºé¡¹ç›®æäº¤ä»£ç ï¼Œéè¦é€šè¿‡ PR è´¡çŒ®å‘¢ã€‚ ä¸»è¦æœ‰ä¸¤ä¸ªæ–¹é¢å§\nå¼€æºé¡¹ç›®çš„ä½œè€…è¦ç”„åˆ«æäº¤çš„ä»£ç çš„è´¨é‡ï¼Œä¸èƒ½ä»€ä¹ˆçƒ‚ä»£ç éƒ½å¯ä»¥æäº¤åˆ°è¿™ä¸ªé¡¹ç›®é‡Œï¼Œåªæœ‰ä½œè€…è§‰å¾—åˆé€‚çš„ä»£ç æ‰å¯ä»¥åŠ åˆ°é¡¹ç›®é‡Œ é˜²æ­¢åˆ«äººæç ´åï¼Œè¦æ˜¯è°éƒ½èƒ½éšä¾¿æäº¤ä»£ç ï¼Œä¸‡ä¸€ä½ ç»™æˆ‘æ¥ä¸ªåˆ åº“è·‘è·¯ï¼Œä½œè€…æƒ³é—®å€™ä»–å…¨å®¶ åŸºäºè¿™ä¸¤ä¸ªæ–¹é¢çš„è€ƒè™‘å§ï¼Œgitbubåªèƒ½ä¿®æ”¹è‡ªå·±çš„é¡¹ç›®çš„ä»£ç ï¼Œç„¶åå‘åŸé¡¹ç›®æäº¤ PRï¼Œ åŸé¡¹ç›®ä½œè€…å¯ä»¥é€‰æ‹©æ€§çš„åˆå¹¶åˆ°é¡¹ç›®ä¸­ã€‚\næ‰€ä»¥ï¼ŒGithubè´¡çŒ®ä»£ç åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š\nfork è¿™ä¸ªæ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œæ‰¾åˆ°ä½ æƒ³è¦è´¡çŒ®ä»£ç çš„é¡¹ç›®ï¼Œç„¶åç‚¹å³ä¸Šè§’çš„ fork å°±å¥½äº†\nç„¶åå›åˆ°è‡ªå·±çš„ repositories ä¸­å°±èƒ½çœ‹åˆ°åˆšæ‰fork çš„é¡¹ç›®äº†ï¼Œå…¶å®forkå°±æ˜¯å¤åˆ¶äº†å½“å‰é¡¹ç›®çš„é•œåƒï¼Œè¿™ä¸ªå¤åˆ¶åçš„é•œåƒå°±æ˜¯ä½ è‡ªå·±çš„äº†ï¼Œä½ æ‹¥æœ‰æœ€é«˜çš„æƒé™ã€‚\npull pull å°±æ˜¯æŠŠfork åçš„é¡¹ç›®æ‹‰åˆ°æœ¬åœ°ï¼Œç„¶åä¿®æ”¹ä»£ç ã€‚è¿™ä¸ªæ²¡å•¥è¯´çš„ï¼Œå°±æ˜¯å¸¸è§„æ“ä½œã€‚\ncommit commit ä¹Ÿæ²¡å•¥ï¼Œå’Œæ­£å¸¸çš„æäº¤ä»£ç ä¸€æ ·ï¼Œå†™å¥½æäº¤ä¿¡æ¯å°±å¥½äº†ã€‚\npush push å°±æ˜¯æŠŠè¿™æ¬¡çš„commitæäº¤åˆ°è‡ªå·±çš„githubä¸Šå»ã€‚æ³¨æ„ï¼Œè¿™æ¬¡pushæ˜¯pushåˆ°è‡ªå·±forkåçš„ä»“åº“ä¸­ï¼Œåˆ«ææ··äº†ã€‚\npull request ç°åœ¨å°±åˆ°æœ€é‡è¦çš„ä¸€æ­¥äº†ï¼Œåˆ›å»º pull requestäº†ã€‚ åˆ°è‡ªå·±çš„githubä¸­ï¼Œèƒ½çœ‹åˆ°è‡ªå·±åˆšæ‰çš„commitäº†ï¼Œè¿™æ—¶å€™github å°±ä¼šæç¤ºæˆ‘ä»¬å»åˆ›å»ºpull requestäº†\næˆ–è€…æŒ‰ç…§ä¸‹å›¾ä¸­çš„é¡ºåºï¼Œä¸€æ ·å¯ä»¥åˆ°åˆ›å»º PRçš„é¡µé¢\né€šè¿‡ä¸‹å›¾æ ‡æ³¨çš„åœ°æ–¹ï¼Œé€‰æ‹©è¦Mergeçš„åˆ†æ”¯ï¼Œä¸€èˆ¬é»˜è®¤éƒ½æ˜¯æ­£ç¡®çš„ã€‚\nå› ä¸ºæˆ‘å·²ç»æŠŠè¿™ä¸ªPRæäº¤äº†ï¼Œæ‰€ä»¥æ˜¾ç¤ºçš„æ˜¯ View pull requestï¼Œæ­£å¸¸çš„æ˜¾ç¤ºçš„æ˜¯ create pull request ç„¶åæ ¹æ®æç¤ºåˆ›å»ºè¿™ä¸ªPRå°±å¥½äº†ã€‚\nåˆ°è¿™é‡Œï¼Œä¸€æ¬¡å®Œæ•´çš„PRæµç¨‹åŸºæœ¬å°±å®Œæˆäº†ï¼Œå‰©ä¸‹çš„å°±ç­‰ç€åŸé¡¹ç›®ä½œè€…Mergeå°±è¡Œäº†ã€‚\nä½†æ˜¯äº‹æƒ…æ²¡æœ‰ç»“æŸ\nå¦‚æœåŸé¡¹ç›®ä½œè€…åŒæ„åˆå¹¶äº†ï¼Œæäº¤çš„ä»£ç å°±ä¼šåˆå¹¶åˆ°ä¸»é¡¹ç›®ä¸­ï¼Œæˆ–è€…æœ‰åˆ«äººä¹Ÿæäº¤PRäº†ï¼Œè¿™æ˜¯ä½ æƒ³å†æ¬¡æäº¤PRçš„è¯ï¼Œå°±è¦å…ˆåŒæ­¥ä»“åº“äº†ï¼Œå°±æ˜¯æŠŠè‡ªå·±forkçš„ä»“åº“å’Œæºé¡¹ç›®çš„ä»“åº“ä¿æŒåŒæ­¥ã€‚ å¦‚æœç›´æ¥åœ¨githubä¸Šç‚¹ sync forkï¼Œgithubä¼šè‡ªåŠ¨å¸®ä½ Mergeä¸¤ä¸ªä»“åº“ï¼Œä¹Ÿå°±æ˜¯ä¼šæŠŠä¹‹å‰ä½ çš„commitä¿¡æ¯ä¸€èµ·Mergeè¿‡æ¥ï¼Œ å½“ä½ ä¸‹æ¬¡å†è¦æäº¤PRçš„æ—¶å€™ï¼Œå°±ä¼šå‡ºç°ä¹‹å‰çš„commitä¿¡æ¯ã€‚å› ä¸ºåœ¨ sync fork çš„æ—¶å€™æ˜¯Mergeçš„ï¼Œæ‰€ä»¥ä¼šå¸¦ä¸Šä¹‹å‰çš„æäº¤ä¿¡æ¯ã€‚\nå…ˆè¯´å·²ç»sync forkåï¼Œåœ¨åˆ›å»º PRæ—¶æ‰å‘ç°çš„è§£å†³åŠæ³•ï¼š å›åˆ°è‡ªå·±ç”µè„‘ä¸Š\næŠŠæœ¬åœ°çš„ä»£ç å›é€€åˆ°é‡å¤ä¹‹å‰çš„é‚£ä¸ªç‰ˆæœ¬ é€šè¿‡ git log æ‰¾åˆ°é‡å¤å‰çš„é‚£ä¸ªç‰ˆæœ¬ã€‚ ç„¶åå›é€€åˆ°é‚£ä¸ªç‰ˆæœ¬\n1git reset å¯¹åº”ç‰ˆæœ¬çš„id è¿™æ—¶å€™æœ¬åœ°ä¿®æ”¹çš„ä»£ç å°±ä¼šå›åˆ°æœªæäº¤çš„çŠ¶æ€ï¼Œè¿™æ—¶å€™å…ˆæŠŠæ”¹çš„ä»£ç å¤åˆ¶ä¸€ä»½å‡ºæ¥ï¼Œé¿å…æ“ä½œå¤±è¯¯æ‰¾ä¸åˆ°äº†å°±å°´å°¬äº†ã€‚ å†é€šè¿‡\n1git checkout . æŠŠæ”¾å¼ƒæœ¬åœ°ä¿®æ”¹ã€‚\nç„¶åé‡ç‚¹æ¥äº†ï¼Œç»™é¡¹ç›®åŠ ä¸€ä¸ªä¸Šæ¸¸åœ°å€ã€‚ å…ˆçœ‹ä¸€ä¸‹å½“å‰çš„åˆ†æ”¯\n1git remote -v 2 3origin\tgit@github.com:lqxhub/pika.git (fetch) 4origin\tgit@github.com:lqxhub/pika.git (push) æ­¤æ—¶åªæœ‰è‡ªå·±forkåçš„ä»“åº“ã€‚ ç°åœ¨è¦ç»™forkåçš„ä»“åº“ï¼ŒåŠ ä¸€ä¸ªä¸Šæ¸¸åœ°å€ï¼Œä¹Ÿå°±æ˜¯æŒ‡å®šè¿™ä¸ªä»“åº“æ˜¯ä»å“ªé‡Œforkæ¥çš„\n1git remote add upstream https://github.com/OpenAtomFoundation/pika.git upstream åé¢è·Ÿä¸Šæºä»“åº“åœ°å€ ç°åœ¨æ¥çœ‹çœ‹åˆ†æ”¯å™¨æƒ…å†µ\n1git remote -v 2origin\tgit@github.com:lqxhub/pika.git (fetch) 3origin\tgit@github.com:lqxhub/pika.git (push) 4 5upstream\thttps://github.com/OpenAtomFoundation/pika.git (fetch) 6upstream\thttps://github.com/OpenAtomFoundation/pika.git (push) åˆ°è¿™ä¸Šæ¸¸ä»“åº“å·²ç»åŠ å¥½äº†\nç„¶åæ‰§è¡Œ\n1git fetch upstream åŒæ­¥ä¸Šæ¸¸ä»“åº“åˆ°æœ¬åœ°\nç­‰ä»£ç åŒæ­¥å®Œæˆ\n1git branch -a çœ‹ä¸€ä¸‹å½“å‰çš„åˆ†æ”¯æƒ…å†µ\n1* master 2 remotes/origin/HEAD -\u0026gt; origin/master 3 remotes/origin/master 4 remotes/upstream/2.3 5 remotes/upstream/3.0 6 remotes/upstream/3.0.16 7 remotes/upstream/3.2.9_beta_rocksdb5.18.3 8 remotes/upstream/develop 9 remotes/upstream/master 10 remotes/upstream/pika_codis è¿™æ—¶å€™å°±èƒ½çœ‹åˆ°å¾ˆå¤šåˆ†æ”¯äº†ï¼Œç„¶åæŠŠè‡ªå·±æœ¬åœ°çš„ä»£ç rebaseåˆ°æƒ³è¦çš„åˆ†æ”¯ï¼Œä¸€èˆ¬å°±æ˜¯remote/upstream/master\næ‰§è¡Œ\n1git rebase remotes/upstream/master åˆ°è¿™ï¼Œæœ¬åœ°çš„ä»£ç å°±å·²ç»å’ŒåŸä»“åº“ä¿æŒåŒæ­¥äº†ã€‚æ³¨æ„ä¸€å®šæ˜¯ bebase ä¸è¦ merge\næ ¸å¿ƒæ€æƒ³å°±æ˜¯è®©æœ¬åœ°ä»£ç è½åäºä¸Šæ¸¸ä»“åº“ï¼Œç„¶åå†æŠŠæœ¬åœ°çš„rebaseåˆ°æœ€æ–°çš„\nç„¶åå°±æ­£å¸¸çš„ä¿®æ”¹ä»£ç  commit push\næ³¨æ„ è¿™é‡Œpushçš„æ—¶å€™è¦å¼ºåˆ¶ push git push -f è¦ä¸ç„¶ä¼šå¤±è´¥\næœ€åå»githubä¸Š æäº¤ PRå°±å¥½äº†ã€‚\nä¸Šé¢è¯´çš„æ˜¯å‡ºé”™äº†æ€ä¹ˆè¡¥æ•‘ï¼Œå†è¯´ä¸€ä¸‹åº”è¯¥æ€ä¹ˆæ­£ç¡®æ“ä½œ\næ­£ç¡®çš„æ“ä½œ æ­£ç¡®çš„æ“ä½œæ˜¯ï¼Œæ¯æ¬¡ä¿®æ”¹ä»£ç éƒ½æ–°å»ºä¸€ä¸ªåˆ†æ”¯ï¼Œåœ¨åˆ†æ”¯ä¸Šä¿®æ”¹ä»£ç ï¼Œè¿™æ ·å°±ä¸ä¼šå¸¦ä¸Šä¹‹å‰çš„ä¿¡æ¯äº†ã€‚\næˆ–è€…ä¸€å¼€å§‹å°±åœ¨æœ¬åœ°åŠ ä¸Šä¸Šæ¸¸ä»“åº“åœ°å€ï¼Œæ¯æ¬¡éƒ½æ˜¯git fetch upstream ç„¶ååŸºäºremote/upstream/masteråˆ†æ”¯ï¼Œåœ¨æœ¬åœ°æ–°å»ºä¸€ä¸ªåˆ†æ”¯(å‡è®¾æ–°åˆ†æ”¯æ˜¯ newDev)å¼€å§‹å¼€å‘ã€‚\n1git checkout -b newDev remote/upstream/master æ–°ç‰ˆæœ¬çš„gitå¯ä»¥ç”¨\n1git switch -c newDev remote/upstream/master å¥½äº†ï¼Œé—®é¢˜è§£å†³äº†ï¼Œåˆå¯ä»¥æ„‰å¿«çš„å‚ä¸å¼€æºé¡¹ç›®äº†ã€‚\n","date":"2022-08-20T17:44:17Z","image":"https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/1573462520_5dc921f8018f2.jpeg","permalink":"https://lqxhub.github.io/posts/639c962/","title":"githubæäº¤pull requestæµç¨‹å’Œcommité‡å¤è§£å†³åŠæ³•"},{"content":"åœ¨C/C++ä¸­å¯ä»¥é€šè¿‡å®å®šä¹‰å®ç°æ¡ä»¶ç¼–è¯‘ï¼Œæ¯”å¦‚åœ¨ä¸åŒå¹³å°çš„æœºå™¨ä¸Šï¼Œè°ƒç”¨ä¸åŒçš„å‡½æ•°ï¼Œæˆ–è€…é€šè¿‡ç¼–è¯‘æ˜¯ä¼ é€’å‚æ•°ï¼Œè°ƒç”¨ä¸åŒçš„å‡½æ•°ï¼Œæ¯”å¦‚ä¸‹é¢çš„ä¾‹å­\nC++æ¡ä»¶ç¼–è¯‘ 1#include \u0026lt;iostream\u0026gt; 2 3#ifdef DEBUG 4 5void fun1() { 6 std::cout \u0026lt;\u0026lt; \u0026#34;I am debug\u0026#34; \u0026lt;\u0026lt; std::endl; 7} 8 9#else 10 11void fun1() { 12 std::cout \u0026lt;\u0026lt; \u0026#34;I am release\u0026#34; \u0026lt;\u0026lt; std::endl; 13} 14 15#endif 16 17int main() { 18 fun1(); 19 return 0; 20} ç°åœ¨å°±å¯ä»¥ä½¿ç”¨ä¸åŒçš„ç¼–è¯‘å‚æ•°ï¼Œæ§åˆ¶ç¨‹åºè°ƒç”¨ä¸åŒçš„å‡½æ•°\nä¸æ·»åŠ å‚æ•°ï¼Œç›´æ¥ç¼–è¯‘ g++ -o test main.cpp ç¨‹åºä¸­æ²¡æœ‰å®šä¹‰ DEBUGè¿™ä¸ªå®ï¼Œæ‰€ä»¥ç¨‹åºæœ€ç»ˆä¼šè°ƒç”¨ I am releaseè¿™ä¸ªå‡½æ•° æ‰§è¡Œç¨‹åºéªŒè¯ä¸€ä¸‹ å’Œæˆ‘ä»¬é¢„æœŸçš„ä¸€æ ·\nåœ¨ç¼–è¯‘çš„æ—¶å€™æ·»åŠ å‚æ•°ï¼Œè®©ç¨‹åºè°ƒç”¨debugå‡½æ•° g++ -DDEBUG -o test main.cpp ä¹Ÿæ²¡æœ‰é—®é¢˜ï¼Œç¨‹åºæœ€ç»ˆè°ƒç”¨çš„æ˜¯ I am debug è¿™ä¸ªå‡½æ•°\ngoæ¡ä»¶ç¼–è¯‘ goè™½ç„¶ä¸æ”¯æŒå®å®šä¹‰ï¼Œä½†æ˜¯goå¯ä»¥é€šè¿‡ build tags å®ç°ç±»ä¼¼çš„åŠŸèƒ½ã€‚ goçš„æ¡ä»¶ç¼–è¯‘æ²¡æœ‰C++é‚£ä¹ˆå¼ºå¤§ï¼Œå¯ä»¥åœ¨ä»£ç ä»»æ„ä½ç½®æ·»åŠ å®ï¼Œå®ç°æ¡ä»¶ç¼–è¯‘ï¼Œgoçš„tagsçš„ä½œç”¨èŒƒå›´æ˜¯æ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯è¯´goçš„ç¼–è¯‘å™¨é€šè¿‡ä¸åŒçš„tagå»é€‰æ‹©ä¸åŒçš„æ–‡ä»¶ã€‚ å…ˆåˆ›å»ºfile.go file_debug.go main.goè¿™ä¸‰ä¸ªæ–‡ä»¶\nfile.go\n1// +build !debug 2 3package main 4 5import \u0026#34;fmt\u0026#34; 6 7func Fun1() { 8\tfmt.Println(\u0026#34;I am release\u0026#34;) 9} file_debug.go\n1// +build debug 2 3package main 4 5import \u0026#34;fmt\u0026#34; 6 7func Fun1() { 8\tfmt.Println(\u0026#34;I am debug\u0026#34;) 9} main.go\n1package main 2 3func main() { 4\tFun1() 5} goçš„tagsæœ‰å‡ ä¸ªæ³¨æ„çš„ç‚¹\n// +build debug å¿…é¡»åœ¨æ–‡ä»¶çš„æœ€å¼€å§‹ä½ç½®ï¼Œä¸€èˆ¬åœ¨ç¬¬ä¸€è¡Œ // å’Œ +ä¹‹é—´å¿…é¡»æœ‰ä¸€ä¸ªç©ºæ ¼ // +build debug ä¸‹é¢å¿…é¡»æœ‰ä¸€ä¸ªç©ºè¡Œ åªæœ‰æ»¡è¶³è¿™äº›æ¡ä»¶åï¼Œè¿™ä¸ªtagæ‰èƒ½æ­£ç¡®çš„è¢«ç¼–è¯‘å™¨è¯†åˆ«\nå…ˆæ­£å¸¸ç¼–è¯‘ go build -o release.exe æ‰§è¡Œç¨‹åºï¼Œæœ€ç»ˆç¨‹åºè°ƒç”¨çš„æ˜¯I am release è¿™ä¸ªå‡½æ•° åœ¨ç¼–è¯‘çš„æ—¶å€™ï¼ŒåŠ å‚æ•°ä½¿ç”¨debugç‰ˆæœ¬çš„å‡½æ•° go build -tags debug -o debug.exe go1.17æ”¹å˜ åœ¨go1.17ä¹‹å‰ï¼Œgoçš„build tags æ ¼å¼æ˜¯ // +build æ¡ä»¶\nä»go1.17å¼€å§‹ï¼Œå¼€å§‹æ”¯æŒ //go:build æ¡ä»¶ è¿™ç§æ ¼å¼äº†\n//go:build æ¡ä»¶ è¿™ç§æ ¼å¼æœ‰ä»€ä¹ˆå¥½å¤„å‘¢ï¼Œæœ€æ˜æ˜¾çš„å°±æ˜¯å…³ç³»è¿ç®—æ›´ç¬¦åˆç¼–ç¨‹è¯­æ³•äº†\nåœ¨ä¹‹å‰ï¼Œæƒ³è¦è¡¨ç¤º windows 64ä½ç³»ç»Ÿ æˆ–è€… æ˜¯ linux ç³»ç»Ÿéœ€è¦ä¸‹é¢çš„è¯­æ³•\n// +build windows,amd64 linux\nåŸæ¥çš„build tags , æ˜¯ and ç©ºæ ¼ æ˜¯ or ï¼Œä¸ç¬¦åˆå¸¸è§ç¼–ç¨‹è¯­è¨€çš„è¯­æ³•\nä»go1.17å¼€å§‹ï¼ŒåŒæ ·çš„æ¡ä»¶å¯ä»¥è¿™æ ·å†™äº†\n//go:build (windows \u0026amp;\u0026amp; amd64) || linux\nè¿™ä¸ªè¡¨è¾¾å¼å°±æ¯”ä¹‹å‰çš„æ˜æ˜¾å¤šäº†\nå¼€å§‹æµ‹è¯•ä¸€ä¸‹ å…ˆåˆ›å»ºfile.go file_x64.go main.goä¸‰ä¸ªæ–‡ä»¶\nfile.go\n1//go:build windows \u0026amp;\u0026amp; 386 2 3package main 4 5import \u0026#34;fmt\u0026#34; 6 7func Fun1() { 8\tfmt.Println(\u0026#34;I am windows 386\u0026#34;) 9} file_x64\n1//go:build windows \u0026amp;\u0026amp; amd64 2 3package main 4 5import \u0026#34;fmt\u0026#34; 6 7func Fun1() { 8\tfmt.Println(\u0026#34;I am windows amd64\u0026#34;) 9} main.go\n1package main 2 3func main() { 4\tFun1() 5} ç¼–è¯‘ 32ä½ç¨‹åº ç¼–è¯‘64ä½ç¨‹åº å…¨éƒ½ç¬¦åˆé¢„æœŸ\nå®é™…åº”ç”¨ è¯´äº†è¿™ä¹ˆå¤šï¼Œtagsåœ¨å®é™…å¼€å‘ä¸­æœ‰ä»€ä¹ˆç”¨å¤„å‘¢ã€‚ æœ€ä¸»è¦çš„å°±æ˜¯åŠŸèƒ½å°±æ˜¯å¯ä»¥é€šè¿‡ç¼–è¯‘å‚æ•°æ§åˆ¶ä½¿ç”¨é‚£äº›ä»£ç ç¼–è¯‘å¾—åˆ°ç¨‹åºã€‚æ¯”å¦‚åœ¨ä¸åŒçš„å¹³å°å¯ä»¥æœ‰ä¸åŒçš„å‡½æ•°å®ç°ã€‚ä¸åŒçš„ç‰ˆæœ¬æœ‰ä¸åŒçš„å®ç°ã€‚\nä¸¾ä¸ªæ —å­ ä¸€èˆ¬logéƒ½ä¼šæœ‰ä¸åŒçš„çº§åˆ«ï¼Œå¿…é¡»å¼€å‘ä¸­å¯ä»¥é€šè¿‡å¤šæ‰“å°ä¸€äº›æ•°æ®ï¼Œæ–¹ä¾¿è°ƒè¯•ã€‚ä½†æ˜¯ç¨‹åºä¸Šçº¿åï¼Œä¸ºäº†æ€§èƒ½è€ƒè™‘ä¼šå…³é—­ä¸€äº›ä½çº§åˆ«çš„logï¼Œåªä¿ç•™ error å’Œ waning çº§åˆ«çš„logã€‚\nè™½ç„¶ç°åœ¨å¤§å¤šæ•°logåº“éƒ½æœ‰logçº§åˆ«ï¼Œä½†æ˜¯å¦‚æœä¸éœ€è¦æ‰“å°çš„logï¼Œä½†æ˜¯è¿˜æ˜¯è°ƒç”¨äº†å‡½æ•°ï¼Œå…¶å®è¿˜æ˜¯ä¼šæœ‰ä¸€éƒ¨åˆ†æ€§èƒ½å¼€é”€çš„ï¼Œæ¯”å¦‚å‡½æ•°è°ƒç”¨å¼€é”€ï¼Œå‚æ•°ä¼ é€’å¼€é”€ç­‰ã€‚ä¸ºäº†è¿›ä¸€æ­¥å‹æ¦¨æ€§èƒ½ï¼Œå¯ä»¥é€šè¿‡tags åœ¨ç¼–è¯‘ç¨‹åºçš„æ—¶å€™ï¼ŒæŠŠä½ç­‰çº§çš„logç›´æ¥ä¸ç¼–è¯‘åˆ°ç¨‹åºä¸­ã€‚\nå›åˆ°ç¬¬ä¸€ä¸ªç¤ºä¾‹ä¸­ï¼Œä¿®æ”¹ä¸€ä¸‹ä»£ç \nfile.go\n1// +build !debug 2 3package main 4 5import \u0026#34;fmt\u0026#34; 6 7func LogDebug(info string) { 8\tfmt.Println(info) 9} file_debug.go\n1// +build debug 2 3package main 4 5func LogDebug(info string) { 6} main.go\n1package main 2 3func main() { 4\tLogDebug(\u0026#34;aaaaaaaaaaaa\u0026#34;) 5} å¯ä»¥çœ‹åˆ°ï¼Œåœ¨édebugç‰ˆæœ¬ä¸­ï¼Œæ¨¡æ‹Ÿæ­£å¸¸æ‰“å°logï¼Œåœ¨debugç‰ˆæœ¬ä¸­ï¼Œlogå‡½æ•°åªæœ‰ä¸€ä¸ªç©ºçš„å‡½æ•°ï¼Œæ²¡æœ‰å®ç°ã€‚ å…ˆç¼–è¯‘ä¸¤ä¸ªç¨‹åºï¼Œç„¶åé€šè¿‡åç¼–è¯‘çœ‹çœ‹ä¸¤æ¬¡å‡½æ•°è°ƒç”¨çš„åŒºåˆ«\næ‰§è¡Œå¦‚ä¸‹å‘½ä»¤\n1go build -tags debug -o debug.exe 2go build -o release.exe 3go tool objdump -s \u0026#34;main.main\u0026#34; ./debug.exe \u0026gt; ./debug.s 4go tool objdump -s \u0026#34;main.main\u0026#34; ./release.exe \u0026gt; ./release.s åˆ†åˆ«å¾—åˆ°debugç‰ˆæœ¬å’Œreleaseç‰ˆæœ¬çš„æ±‡ç¼–ä»£ç \ndebug.s\n1TEXT main.main(SB) D:/goProject/src/build_tag/main.go 2 main.go:3\t0x49e750\t65488b0c2528000000\tMOVQ GS:0x28, CX\t3 main.go:3\t0x49e759\t488b8900000000\tMOVQ 0(CX), CX\t4 main.go:3\t0x49e760\t483b6110\tCMPQ 0x10(CX), SP\t5 main.go:3\t0x49e764\t0f8687000000\tJBE 0x49e7f1\t6 main.go:3\t0x49e76a\t4883ec58\tSUBQ $0x58, SP\t7 main.go:3\t0x49e76e\t48896c2450\tMOVQ BP, 0x50(SP)\t8 main.go:3\t0x49e773\t488d6c2450\tLEAQ 0x50(SP), BP\t9 main.go:4\t0x49e778\t488d0542fd0200\tLEAQ go.string.*+5001(SB), AX\t10 file.go:8\t0x49e77f\t48890424\tMOVQ AX, 0(SP)\t11 file.go:8\t0x49e783\t48c74424080c000000\tMOVQ $0xc, 0x8(SP)\t12 file.go:8\t0x49e78c\te87fb1f6ff\tCALL runtime.convTstring(SB)\t13 file.go:8\t0x49e791\t488b442410\tMOVQ 0x10(SP), AX\t14 file.go:8\t0x49e796\t0f57c0\tXORPS X0, X0\t15 file.go:8\t0x49e799\t0f11442440\tMOVUPS X0, 0x40(SP)\t16 file.go:8\t0x49e79e\t488d0d3be70000\tLEAQ runtime.types+57056(SB), CX\t17 file.go:8\t0x49e7a5\t48894c2440\tMOVQ CX, 0x40(SP)\t18 file.go:8\t0x49e7aa\t4889442448\tMOVQ AX, 0x48(SP)\t19 print.go:274\t0x49e7af\t488b0592a50d00\tMOVQ os.Stdout(SB), AX\t20 print.go:274\t0x49e7b6\t488d0da3c40400\tLEAQ go.itab.*os.File,io.Writer(SB), CX\t21 print.go:274\t0x49e7bd\t48890c24\tMOVQ CX, 0(SP)\t22 print.go:274\t0x49e7c1\t4889442408\tMOVQ AX, 0x8(SP)\t23 print.go:274\t0x49e7c6\t488d442440\tLEAQ 0x40(SP), AX\t24 print.go:274\t0x49e7cb\t4889442410\tMOVQ AX, 0x10(SP)\t25 print.go:274\t0x49e7d0\t48c744241801000000\tMOVQ $0x1, 0x18(SP)\t26 print.go:274\t0x49e7d9\t48c744242001000000\tMOVQ $0x1, 0x20(SP)\t27 print.go:274\t0x49e7e2\te8e998ffff\tCALL fmt.Fprintln(SB)\t28 file.go:8\t0x49e7e7\t488b6c2450\tMOVQ 0x50(SP), BP\t29 file.go:8\t0x49e7ec\t4883c458\tADDQ $0x58, SP\t30 file.go:8\t0x49e7f0\tc3\tRET\t31 main.go:3\t0x49e7f1\te87acffbff\tCALL runtime.morestack_noctxt(SB)\t32 main.go:3\t0x49e7f6\te955ffffff\tJMP main.main(SB)\tå¯ä»¥çœ‹åˆ°åœ¨debugç‰ˆæœ¬ä¸­ï¼ŒLogDebug å‡½æ•°å·²ç»è¢«ç¼–è¯‘å™¨å†…è”å¤„ç†äº†ã€‚æœ€ç»ˆç¨‹åºæ˜¯è°ƒç”¨äº†fmt.Printlnå‡½æ•°ã€‚\nrelease.s\n1TEXT main.main(SB) D:/goProject/src/build_tag/main.go 2 main.go:4\t0x45b630\tc3\tRET\t3 :0\t0x45b631\tcc\tINT $0x3\t4 :0\t0x45b632\tcc\tINT $0x3\t5 :0\t0x45b633\tcc\tINT $0x3\t6 :0\t0x45b634\tcc\tINT $0x3\t7 :0\t0x45b635\tcc\tINT $0x3\t8 :0\t0x45b636\tcc\tINT $0x3\t9 :0\t0x45b637\tcc\tINT $0x3\t10 :0\t0x45b638\tcc\tINT $0x3\t11 :0\t0x45b639\tcc\tINT $0x3\t12 :0\t0x45b63a\tcc\tINT $0x3\t13 :0\t0x45b63b\tcc\tINT $0x3\t14 :0\t0x45b63c\tcc\tINT $0x3\t15 :0\t0x45b63d\tcc\tINT $0x3\t16 :0\t0x45b63e\tcc\tINT $0x3\t17 :0\t0x45b63f\tcc\tINT $0x3\tç›¸æ¯”ä¹‹ä¸‹ï¼Œreleaseç‰ˆæœ¬çš„æ±‡ç¼–ä»£ç å°±ç®€å•å¤šäº†ï¼Œå› ä¸ºç¼–è¯‘å™¨ä¼šè¿›è¡Œå†…è”å¤„ç†ï¼Œä½†æ˜¯å‘ç°LogDebugè¿™ä¸ªå‡½æ•°æ˜¯ä¸€ä¸ªç©ºå‡½æ•°ï¼Œæ‰€ä»¥å°±ç›´æ¥è·³è¿‡ç¼–è¯‘äº†ã€‚\næ€»ç»“ goä¹Ÿå¯ä»¥å®ç°æ¡ä»¶ç¼–è¯‘ï¼Œä½†æ˜¯ä¸èƒ½åƒC++é‚£æ ·çµæ´»ï¼Œåªèƒ½ä»¥æ–‡ä»¶ä¸ºå•ä½ åœ¨go1.17ä¹‹å‰ä½¿ç”¨// +build æ¡ä»¶ï¼Œä»1.17å¼€å§‹å¯ä»¥ä½¿ç”¨//go:build æ¡ä»¶ goé¢„è®¾äº†å¾ˆå¤štagsï¼Œä¹Ÿå¯ä»¥è‡ªå®šä¹‰tags åœ¨ç¼–è¯‘æ—¶ï¼Œä½¿ç”¨ -tags ä¸ªè‡ªå®šä¹‰çš„tagsèµ‹å€¼ ","date":"2022-07-31T17:11:07Z","permalink":"https://lqxhub.github.io/posts/84a29eaf/","title":"goä½¿ç”¨build tagså®ç°æ¡ä»¶ç¼–è¯‘ï¼ŒGoä¸­çš„æ¡ä»¶ç¼–è¯‘ï¼ŒGoä¸­çš„build tagsçš„ä½¿ç”¨æ–¹æ³•åŠå…¶å®ç°åŸç† - QX's blog"},{"content":"ä¸€ç›´ä»¥æ¥ç®—æ³•é¢˜åˆ·çš„æ¯”è¾ƒå°‘ï¼Œç®—æ³•è¿™å—ç®—æ˜¯æˆ‘çš„å¼±é¡¹ã€‚å‰å‡ å¤©ï¼Œçœ‹åˆ°ä¸€ä¸ªæŒºæœ‰æ„æ€çš„é“¾è¡¨é¢˜\nåŸé¢˜ åŸé¢˜æ˜¯è¿™æ ·çš„ï¼Œç»™ä¸€ä¸ªé“¾è¡¨ [1,2,3,4,5] ç„¶åè½¬æ¢æˆ [5,3,1,2,4] è¿™ç§æ ¼å¼ æ‰¾ä¸€ä¸‹è§„å¾‹ï¼Œå…¶å®å°±æ˜¯ç¬¬ä¸€ä¸ªå…ˆæ‹¿ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œç„¶åæŠŠç¬¬äºŒä¸ªå…ƒç´ æ”¾åœ¨æ–°çš„é“¾è¡¨åé¢ï¼Œç¬¬ä¸‰ä¸ªå…ƒç´ æ”¾åœ¨æ–°çš„é“¾è¡¨å‰é¢ï¼Œç„¶åç¬¬å››ä¸ªæ”¾åœ¨æ–°é“¾è¡¨çš„åé¢ï¼Œç¬¬äº”ä¸ªæ”¾åœ¨æ–°é“¾è¡¨å‰é¢ï¼Œä»¥æ­¤ç±»æ¨ã€‚\nå…¶å®å°±æ˜¯ä¸€ä¸ªé“¾è¡¨å¤´æ’å’Œå°¾æ’çš„ç»“åˆå˜›\nç›´æ¥ä¸Šä»£ç \n1package main 2 3import ( 4\t\u0026#34;fmt\u0026#34; 5) 6 7type Node struct { 8\tNext *Node 9\tVal int 10} 11 12//é€šè¿‡æ•°ç»„ç”Ÿæˆé“¾è¡¨ 13func Make(nums []int) *Node { 14\thead := \u0026amp;Node{} 15\tmove := head 16\tfor _, num := range nums { 17\tt := \u0026amp;Node{ 18\tVal: num, 19\t} 20\tmove.Next = t 21\tmove = move.Next 22\t} 23\treturn head.Next 24} 25 26//æ‰“å°é“¾è¡¨ 27func Print(list *Node) { 28\tfor h := list; h != nil; h = h.Next { 29\tfmt.Printf(\u0026#34;%d \u0026#34;, h.Val) 30\t} 31\tfmt.Println() 32} 33 34func main() { 35\tnums := make([]int, 5) 36\tfor i := 1; i \u0026lt;= 5; i++ { 37\tnums[i-1] = i 38\t} 39\tnodes := Make(nums) 40\tPrint(nodes) 41\tnodes = TurnList(nodes) 42\tPrint(nodes) 43} 44 45//è½¬æ¢é“¾è¡¨ 46func TurnList(list *Node) *Node { 47\ti := 0 48\th := list 49\tt := list 50\tlist = list.Next 51\tfor list != nil { 52\tif i%2 == 0 { 53\tt.Next = list 54\tlist = list.Next 55\tt = t.Next 56\tt.Next = nil 57\t} else { 58\tx := list.Next 59\tlist.Next = h 60\th = list 61\tlist = x 62\t} 63\ti++ 64\t} 65\treturn h 66} åˆå§‹é“¾è¡¨å¦‚å›¾ï¼š å˜æ¢è¿‡ç¨‹ï¼š å°±æ˜¯æ ·æ ¹æ®å¥‡å¶åˆ†åˆ«å¤´æ’å’Œå°¾æ’å°±èƒ½å®Œæˆ è¿™ä¹ˆç®€å•å½“æ—¶å°±æ˜¯æ²¡å†™å‡ºæ¥ã€‚ æ·¦\nåªå†™è¿™ä¸€ä¸ªä¹ŸæŠ¬ä¸è¿‡ç˜¾äº†ï¼Œå†æ¥ä¸€ä¸ªé“¾è¡¨æ’åºçš„ leetcode 148\né“¾è¡¨æ’åº æ’åºçš„æ–¹æ³•æœ‰å¥½å¤šï¼Œä½†æ˜¯æˆ‘æ„Ÿè§‰é€‚åˆç”¨äºé“¾è¡¨çš„æ˜¯ æ’å…¥æ’åº å’Œ å½’å¹¶æ’åº å°¤å…¶æ˜¯å½’å¹¶æ’åºï¼Œç®€ç›´å°±æ˜¯ä¸ºé“¾è¡¨å®šåšçš„ã€‚\nå…ˆæ¥ä¸€ä¸ªç®€å•çš„ï¼Œæ’å…¥æ’åºå§ æ’å…¥æ’åºçš„æ€æƒ³å°±æ˜¯é€‰æ‹©ä¸€ä¸ªåŸºå‡†ï¼Œç„¶åæŠŠæ•´ä¸ªåºåˆ—ä¸­çš„æ¯”è‡ªå·±å°çš„æ”¾åˆ°åŸºå‡†çš„å‰é¢ï¼Œç”¨æ•°ç»„çš„å½¢å¼è¿˜æ˜¯å¾ˆå¥½ç†è§£å’Œæ“ä½œçš„ã€‚ä½†æ˜¯é“¾è¡¨ä¸èƒ½éšæœºè®¿é—®ï¼Œæ‰€ä»¥ä¸èƒ½ç”¨æ•°ç»„é‚£æ ·çš„æ’å…¥æ’åºäº†ï¼Œéœ€è¦åšä¸€ä¸‹å˜æ¢ï¼Œçœ‹èµ·æ¥æœ‰ç‚¹åƒæ˜¯é€‰æ‹©æ’åºå’Œæ’å…¥æ’åºçš„ç»“åˆã€‚ ä¸åºŸè¯äº†ï¼Œç›´æ¥ä¸Šä»£ç ï¼Œæ’å…¥æ’åºï¼š\n1func InsertSort(list *Node) *Node { 2\thead := \u0026amp;Node{ 3\tNext: list, 4\t} 5\th := head 6\tfor h.Next != nil { 7\tt := h 8\tfor t.Next != nil { 9\tif t.Next.Val \u0026lt; h.Next.Val { 10\tx := t.Next 11\tt.Next = t.Next.Next 12\tx.Next = h.Next 13\th.Next = x 14\t} else { 15\tt = t.Next 16\t} 17\t} 18\th = h.Next 19\t} 20\treturn head.Next 21} æ— åºçš„é“¾è¡¨\næ’åºè¿‡ç¨‹ å›¾ä¸­æœ‰ä¸ªè¿·æƒ‘çš„åœ°æ–¹ï¼Œå°±æ˜¯è“è‰²çš„çº¿æ˜¯ next æŒ‡é’ˆçš„æŒ‡å‘ï¼Œå°±æ˜¯ä¸€å¼€å§‹çš„æ—¶å€™ï¼Œhead h t çš„nextæŒ‡é’ˆæŒ‡å‘ 3 ä¹Ÿå°±æ˜¯ h tè‡ªèº«æ˜¯æŒ‡å‘ headçš„ï¼Œheadæ˜¯ä¸€å¼€å§‹çš„æ—¶å€™ï¼Œæ–°å»ºçš„ä¸€ä¸ªä¸´æ—¶ç»“ç‚¹ï¼Œå› ä¸ºå•å‘é“¾è¡¨æ— æ³•å‘å‰æŸ¥æ‰¾ï¼Œåªèƒ½å‘åæŸ¥æ‰¾ï¼Œæ‰€ä»¥è¦ç”¨ next æŒ‡é’ˆã€‚ åŒæ ·ï¼Œåœ¨ä½¿ç”¨ t å’Œ h æŒ‡é’ˆçš„æ—¶å€™ï¼Œä¹Ÿéƒ½æ˜¯ä½¿ç”¨ next ç”¨æ¥åˆ¤æ–­ã€‚ æ¯”è¾ƒé€»è¾‘ t.Next.Val \u0026lt; h.Next.Val å½“ tçš„ next æ˜¯ 3ï¼Œhçš„ next æ˜¯ 2 æ—¶,æ»¡è¶³æ¡ä»¶ï¼Œæ‰€ä»¥äº¤æ¢ 2 å’Œ 3 å¦‚æ­¤å¾€å¤ï¼Œå½“ t èµ°å®Œä¸€è¶Ÿåï¼Œé“¾è¡¨ä¸­çš„ç¬¬ä¸€ä¸ªç»“ç‚¹å°±æ˜¯æœ€å°çš„äº†ã€‚ å½“ t èµ°å®Œä¸€è¶Ÿåï¼ŒhæŒ‡é’ˆè¦åç§»ä¸€ä¸ªã€‚ä»¥æ­¤ç±»æ¨ï¼Œç›´åˆ° h å’Œ t éƒ½èµ°å®Œåï¼Œå°±å®Œæˆäº†æ’åºã€‚\nè¿™ä¸ªæ’åºæ–¹æ³•ç”¨çš„æ˜¯æ’å…¥æ’åºçš„æ€æƒ³åŠ ä¸Šä¸€äº›é€‰æ‹©æ’åºçš„æ–¹æ³•å®Œæˆçš„ï¼Œæ—¶é—´å¤æ‚åº¦è¿˜æ˜¯O(nÂ²)ã€‚æ˜¯ç¨³å®šçš„æ’åºã€‚\nå½’å¹¶æ’åº ç›¸æ¯”æ’å…¥æ’åºå’Œé€‰æ‹©æ’åºï¼Œå½’å¹¶æ’åºå°±è¦å¤æ‚ä¸€äº›äº†\nå½’å¹¶æ’åºçš„æ€æƒ³æ˜¯åˆ†æ²»æ³•ï¼ŒæŠŠæ•´ä¸ªåºåˆ—æ‹†åˆ†ï¼Œå½“æ‹†åˆ†åˆ°ä¸èƒ½å†æ‹†åˆ†æ—¶ï¼Œå­åºåˆ—å°±æ˜¯æœ‰åºçš„äº†ã€‚ä¹Ÿå°±æ˜¯å½“åºåˆ—é•¿åº¦æ˜¯1çš„æ—¶å€™ï¼Œåºåˆ—å°±æ˜¯æœ‰åºçš„ã€‚ç„¶ååœ¨æŠŠå­åºåˆ—æœ‰åºçš„åˆå¹¶èµ·æ¥ã€‚\nå½’å¹¶æ’åºç®€ç›´å°±æ˜¯ä¸ºäº†é“¾è¡¨æ’åºè€Œç”Ÿçš„ã€‚å¦‚æœç”¨æ•°ç»„æ’åºï¼Œæ‹†åˆ†å’Œé‡ç»„è¿˜æ˜¯æ¯”è¾ƒå¤æ‚çš„ï¼Œé“¾è¡¨å°±ç®€å•å¤šäº†ã€‚è¯´å®è¯ï¼Œæ•°ç»„çš„å½’å¹¶æ’åºæˆ‘éƒ½ä¸ä¼šå†™ã€‚\nçº¿ä¸Šä»£ç ï¼Œå½’å¹¶æ’åº\n1func MergerSort(list *Node) *Node { 2\tif list == nil || list.Next == nil { 3\treturn list 4\t} 5 6\tfast := list.Next 7\tslow := list 8\tfor fast != nil \u0026amp;\u0026amp; fast.Next != nil { 9\tfast = fast.Next.Next 10\tslow = slow.Next 11\t} 12 13\th1 := MergerSort(slow.Next) 14\tslow.Next = nil 15\th2 := MergerSort(list) 16 17\treturn Merge(h1, h2) 18} 19 20func Merge(list1, list2 *Node) *Node { 21\thead := \u0026amp;Node{} 22\th := head 23\tfor list1 != nil \u0026amp;\u0026amp; list2 != nil { 24\tif list1.Val \u0026lt; list2.Val { 25\th.Next = list1 26\tlist1 = list1.Next 27\t} else { 28\th.Next = list2 29\tlist2 = list2.Next 30\t} 31\th = h.Next 32\t} 33\tif list1 != nil { 34\th.Next = list1 35\t} else { 36\th.Next = list2 37\t} 38\treturn head.Next 39} å½’å¹¶æ’åºæœ‰ä¸¤ä¸ªéƒ¨åˆ†ï¼Œä¸€ä¸ªæ˜¯æ‹†åˆ†ï¼Œå¦ä¸€ä¸ªæ˜¯åˆå¹¶ã€‚\næ‹†åˆ† æ‹†åˆ†æ˜¯äºŒåˆ†æ³•ï¼Œä¹Ÿå°±æ˜¯æ¯æ¬¡ä»ä¸­é—´åˆ†å¼€ã€‚é“¾è¡¨ä¸­æ‰¾åˆ°ä¸­é—´ä½ç½®ï¼Œæœ€æ–¹ä¾¿çš„å°±æ˜¯å¿«æ…¢æŒ‡é’ˆäº†ï¼Œå°±æ˜¯ä¸€ä¸ªæŒ‡é’ˆæ¯æ¬¡ç§»åŠ¨ä¸€ä¸ªä½ç½®ï¼ŒæŒ‡é’ˆæ¯æ¬¡ç§»åŠ¨ä¸¤ä¸ªä½ç½®ã€‚å½“å¿«çš„æŒ‡é’ˆç§»åŠ¨åˆ°æœ€åçš„æ—¶å€™ï¼Œæ…¢çš„æŒ‡é’ˆæ­£å¥½ç§»åŠ¨åˆ°é“¾è¡¨çš„ä¸­é—´ä½ç½®ã€‚é€’å½’æ‹†åˆ†ï¼Œç›´åˆ°é“¾è¡¨é•¿åº¦æ˜¯1çš„æ—¶å€™ï¼Œå°±å®Œæˆäº†æ‹†åˆ†ã€‚\nåˆå¹¶ åˆå¹¶çš„è¿‡ç¨‹å…¶å®å°±æ˜¯åˆå¹¶ä¸¤ä¸ªæœ‰åºé“¾è¡¨ã€‚leetcode 21 å¾ˆç®€å•æ²¡ä»€ä¹ˆéœ€è¦è§£é‡Šçš„ã€‚\nç®€å•çš„æŠŠæ’åºè¿‡ç¨‹èŠ±äº†å‡ºæ¥ã€‚\næ•´ä¸ªå½’å¹¶æ’åºï¼Œä¸å¥½ç†è§£çš„åœ°æ–¹å°±æ˜¯é€’å½’æ‹†åˆ†çš„è¿‡ç¨‹ï¼Œå…¶å®ä¹Ÿä¸éš¾ç†è§£ï¼Œå°±æ˜¯èƒ½æ‹†çš„æƒ…å†µä¸‹å°±ä¸€ç›´æ‹†ï¼Œç›´åˆ°ä¸èƒ½æ‹†äº†ä¸ºæ­¢ã€‚\n1 fast := list.Next 2 slow := list 3 for fast != nil \u0026amp;\u0026amp; fast.Next != nil { 4 fast = fast.Next.Next 5 slow = slow.Next 6 } å½“ä¸€æ¬¡æ‹†åˆ†å®Œæˆæ—¶ï¼Œslow æŒ‡é’ˆæŒ‡å‘çš„å°±æ˜¯é“¾è¡¨çš„ä¸­é—´ä½ç½®ï¼Œæ‰€ä»¥ slow çš„ next å°±æ˜¯é“¾è¡¨çš„ååŠéƒ¨åˆ†äº†ï¼Œlist æŒ‡é’ˆå°±æ˜¯é“¾è¡¨çš„å‰åŠéƒ¨åˆ†ã€‚\næ‹†åˆ†çš„è¿‡ç¨‹ä¸­æœ‰ä¸ªåœ°æ–¹éœ€è¦æ³¨æ„ï¼Œå°±æ˜¯æ–­é“¾ï¼Œslow.Next = nil å› ä¸ºåœ¨ç”¨å¿«æ…¢æŒ‡é’ˆæ‰¾åˆ°é“¾è¡¨çš„ä¸­é—´ä½ç½®æ—¶,å¹¶æ²¡æœ‰æŠŠé“¾è¡¨åˆ‡åˆ†å¼€ï¼Œéœ€è¦æ‰‹åŠ¨æŠŠé“¾è¡¨æ–­å¼€ï¼Œè¦ä¸ç„¶ä»å¤´å¼€å§‹éå†ï¼Œè¿˜æ˜¯èƒ½éå†æ•´ä¸ªé“¾è¡¨çš„ã€‚\næ€»ç»“ é“¾è¡¨çš„é—®é¢˜å…¶å®æ²¡æœ‰æ²¡æœ‰ç‰¹åˆ«éš¾çš„ç®—æ³•ï¼ŒåŸºæœ¬éƒ½æ˜¯ä¸€äº›åŸºç¡€çš„æ“ä½œã€‚é“¾è¡¨éš¾çš„åœ°æ–¹æ˜¯å› ä¸ºå†…å­˜åœ°å€ä¸è¿ç»­ï¼Œä¸åƒæ•°ç»„é‚£æ ·å¯ä»¥éšæœºè®¿é—®ï¼Œåªèƒ½é€šè¿‡æŒ‡é’ˆæ“ä½œï¼Œç†è§£èµ·æ¥æ²¡æœ‰é‚£ä¹ˆç›´è§‚æ‰€ä»¥ä¼šè§‰éš¾ã€‚é‡åˆ°é“¾è¡¨é—®é¢˜å°±ç”»å›¾ï¼ŒåŸºæœ¬ä¸Šå›¾ç”»å‡ºæ¥äº†ï¼Œé—®é¢˜ä¹ŸåŸºæœ¬èƒ½è§£å†³äº†ã€‚\n","date":"2022-05-21T16:56:04Z","image":"https://cdn.jsdelivr.net/gh/lqxhub/images/blog/02F73302CA875C38.jpg","permalink":"https://lqxhub.github.io/posts/f8e89faa/","title":"é“¾è¡¨æ’åºï¼ŒLeetCodeé“¾è¡¨æ’åºï¼Œgolangé“¾è¡¨å½’å¹¶æ’åº - QX's blog"},{"content":"äº”ä¸€å‡æœŸåœ¨å®¶æ²¡äº‹é€›è®ºå›çš„æ—¶å€™ï¼Œå‘ç°äº†ä¸€ä¸ªå®è—ç½‘ç«™ï¼Œä¼ é€é—¨ è¿™ä¸ªç½‘ç«™å¯ä»¥åœ¨çº¿ç”Ÿæˆå¤šç§è¯­è¨€çš„æ±‡ç¼–ä»£ç ï¼Œæœ‰è¿™ä¸ªå¥½ä¸œè¥¿ï¼Œé‚£å¿…é¡»æ‹¿goå®éªŒä¸€ç•ªã€‚\nå¾ˆä¹…ä¹‹å‰æˆ‘å†™è¿‡ä¸€ç¯‡goé€šè¿‡goæ±‡ç¼–çœ‹å¤šè¿”å›å€¼å®ç°çš„æ–‡ç« ä¼ é€é—¨ã€‚å½“æ—¶å†™çš„æ—¶å€™æ¯”è¾ƒæ—©ï¼Œåæ¥ go 1.17 å¯¹å‡½æ•°è°ƒç”¨æ—¶ï¼Œä¼ é€’å‚æ•°åšäº†ä¿®æ”¹ï¼Œç®€å•è¯´å°±æ˜¯go1.17ä¹‹å‰ï¼Œå‡½æ•°å‚æ•°æ˜¯é€šè¿‡æ ˆç©ºé—´æ¥ä¼ é€’çš„ï¼Œåœ¨go1.17æ—¶åšå‡ºäº†æ”¹å˜ï¼Œåœ¨ä¸€äº›å¹³å°ä¸Šï¼ˆAMD64ï¼‰å¯ä»¥åƒC,C++é‚£æ ·ä½¿ç”¨å¯„å­˜å™¨ä¼ é€’å‚æ•°å’Œå‡½æ•°è¿”å›å€¼äº†ã€‚ä¸ºä»€ä¹ˆåšå‡ºè¿™ä¸ªæ”¹å˜å‘¢ï¼ŒåŸå› å°±æ˜¯å¯„å­˜å™¨æ›´å¿«ã€‚è™½ç„¶å†…å­˜å·²ç»å¾ˆå¿«äº†ï¼Œä½†æ˜¯è¿˜æ˜¯æ²¡æ³•å’Œå¯„å­˜å™¨ç›¸æ¯”ã€‚ä¹‹å‰ä¸ºå•¥ä¸ç”¨å¯„å­˜å™¨ï¼Œç”¨æ ˆç©ºé—´ï¼ŒåŸå› æ˜¯å®ç°ç®€å•ï¼Œä¸ç”¨è€ƒè™‘ä¸åŒå¹³å°ï¼Œä¸ç”¨æ¶æ„çš„åŒºåˆ«ã€‚\nç®€å•æ€»ç»“ä¸€ä¸‹ä¸¤ç§æ–¹å¼\næ ˆç©ºé—´ï¼š ä¼˜ç‚¹ï¼šå®ç°ç®€å•ï¼Œä¸ç”¨åŒºåˆ†ä¸åŒçš„å¹³å°ï¼Œé€šç”¨æ€§å¼º ç¼ºç‚¹ï¼šæ•ˆç‡ä½ å¯„å­˜å™¨ï¼š ä¼˜ç‚¹ï¼šé€Ÿåº¦å¿« ç¼ºç‚¹ï¼šé€šç”¨æ€§å·®ï¼Œä¸åŒçš„å¹³å°éœ€è¦å•ç‹¬å¤„ç† å½“ç„¶ï¼Œè¿™é‡Œè¯´çš„é€šç”¨æ€§å·®æ˜¯å¯¹äºç¼–è¯‘å™¨æ¥è¯´çš„ goæ±‡ç¼–åŸºç¡€çŸ¥è¯† å†æ¥æ€»ç»“ä¸€æ¬¡goæ±‡ç¼–çš„åŸºç¡€çŸ¥è¯†å§ï¼Œç°åœ¨å›å¤´çœ‹ä¹‹å‰æ€»ç»“çš„è¿˜æ˜¯ä¸å…¨é¢çš„ goä½¿ç”¨çš„ plan9 æ±‡ç¼–ï¼Œè¿™ä¸ªå’Œ AT\u0026amp;T çš„æ±‡ç¼–å·®åˆ«è¿˜æ˜¯æœ‰ç‚¹å¤§çš„ï¼Œæˆ‘ä¸ªäººæ„Ÿè§‰plan9æ±‡ç¼–æ¯”è¾ƒé‡è¦çš„å°±æ˜¯å››ä¸ªå¯„å­˜å™¨ï¼Œåªè¦ç†è§£äº†è¿™å››ä¸ªå¯„å­˜å™¨ï¼Œæ±‡ç¼–å°±ç†è§£äº†ä¸€åŠäº†\næ±‡ç¼–ä¸­ä¸ªå‡ ä¸ªæœ¯è¯­:\næ ˆï¼šè¿›ç¨‹ã€çº¿ç¨‹ã€goroutine éƒ½æœ‰è‡ªå·±çš„è°ƒç”¨æ ˆï¼Œå…ˆè¿›åå‡ºï¼ˆFILOï¼‰ æ ˆå¸§ï¼šå¯ä»¥ç†è§£æ˜¯å‡½æ•°è°ƒç”¨æ—¶ï¼Œåœ¨æ ˆä¸Šä¸ºå‡½æ•°æ‰€åˆ†é…çš„å†…å­˜åŒºåŸŸ è°ƒç”¨è€…ï¼šcallerï¼Œæ¯”å¦‚ï¼šA å‡½æ•°è°ƒç”¨äº† B å‡½æ•°ï¼Œé‚£ä¹ˆ A å°±æ˜¯è°ƒç”¨è€… è¢«è°ƒè€…ï¼šcalleeï¼Œæ¯”å¦‚ï¼šA å‡½æ•°è°ƒç”¨äº† B å‡½æ•°ï¼Œé‚£ä¹ˆ B å°±æ˜¯è¢«è°ƒè€… å¯„å­˜å™¨ è¯´æ˜ SB(Static base pointer) global symbols å…¨å±€é™æ€æŒ‡é’ˆ FP(Frame pointer) arguments and locals æŒ‡å‘æ ˆå¸§çš„å¼€å§‹ SP(Stack pointer) top of stack æŒ‡å‘æ ˆé¡¶ PC(Program counter) jumps and branches ç®€å•è¯´ç¨‹åºè®¡æ•°å™¨ ç®€å•å±•å¼€è¯´ä¸€ä¸‹å‡ ä¸ªå¯„å­˜å™¨å§\nSBï¼šå…¨å±€é™æ€æŒ‡é’ˆï¼Œå³ç¨‹åºåœ°å€ç©ºé—´çš„å¼€å§‹åœ°å€ã€‚ä¸€èˆ¬ç”¨åœ¨å£°æ˜å‡½æ•°ã€å…¨å±€å˜é‡ä¸­ã€‚ FPï¼šæŒ‡å‘çš„æ˜¯ caller è°ƒç”¨ callee æ—¶ä¼ é€’çš„ç¬¬ä¸€ä¸ªå‚æ•°çš„ä½ç½®ï¼Œå¯ä»¥çœ‹ä½œæ˜¯æŒ‡å‘ä¸¤ä¸ªå‡½æ•°æ ˆçš„åˆ†å‰²ä½ç½®ï¼›ä½†æ˜¯FPæŒ‡å‘çš„ä½ç½®ä¸åœ¨ callee çš„ stack frame ä¹‹å†…ã€‚è€Œæ˜¯åœ¨ caller çš„ stack frame ä¸Šï¼ŒæŒ‡å‘è°ƒç”¨ add å‡½æ•°æ—¶ä¼ é€’çš„ç¬¬ä¸€ä¸ªå‚æ•°çš„ä½ç½®ï¼›å¯ä»¥åœ¨ callee ä¸­ç”¨ symbol+offset(FP) æ¥è·å–å…¥å‚çš„å‚æ•°å€¼ï¼Œæ¯”å¦‚ a+8(FP)ã€‚è™½ç„¶ symbol æ²¡æœ‰ä»€ä¹ˆå…·ä½“æ„ä¹‰ï¼Œä½†æ˜¯ä¸åŠ ç¼–è¯‘å™¨ä¼šæŠ¥é”™ã€‚ SPï¼šè¿™ä¸ªæ˜¯æœ€å¸¸ç”¨çš„å¯„å­˜å™¨äº†ï¼ŒåŒæ ·ä¹Ÿæ˜¯æœ€å¤æ‚çš„å¯„å­˜å™¨äº†ã€‚ä¸åŒçš„å¼•ç”¨æ–¹å¼ï¼Œä»£è¡¨ä¸åŒçš„ä½ç½®ã€‚SPå¯„å­˜å™¨ åˆ†ä¸ºä¼ª SP å¯„å­˜å™¨å’Œç¡¬ä»¶ SP å¯„å­˜å™¨ã€‚symbol+offset(SP) å½¢å¼ï¼Œåˆ™è¡¨ç¤ºä¼ªå¯„å­˜å™¨ SP ï¼ˆè¿™ä¸ªä¹Ÿç®€ç§°ä¸º BPï¼‰ã€‚å¦‚æœæ˜¯ offset(SP) åˆ™è¡¨ç¤ºç¡¬ä»¶å¯„å­˜å™¨ SPã€‚ä¼ª SP å¯„å­˜å™¨æŒ‡å‘å½“å‰æ ˆå¸§ç¬¬ä¸€ä¸ªå±€éƒ¨å˜é‡çš„ç»“æŸä½ç½®ï¼›ç¡¬ä»¶SPæŒ‡å‘çš„æ˜¯æ•´ä¸ªå‡½æ•°æ ˆç»“æŸçš„ä½ç½®ã€‚**æœ‰ä¸ªæ¯”è¾ƒå‘çš„åœ°æ–¹ï¼š**å¯¹äºç¼–è¯‘è¾“å‡º(go tool compile -S / go tool objdump)çš„ä»£ç æ¥è®²ï¼Œæ‰€æœ‰çš„ SP éƒ½æ˜¯ç¡¬ä»¶ SP å¯„å­˜å™¨ï¼Œæ— è®ºæ˜¯å¦å¸¦ symbolï¼ˆè¿™ä¸€ç‚¹éå¸¸å…·æœ‰è¿·æƒ‘æ€§ï¼Œéœ€è¦æ…¢æ…¢ç†è§£ã€‚å¾€å¾€åœ¨åˆ†æç¼–è¯‘è¾“å‡ºçš„æ±‡ç¼–æ—¶ï¼Œçœ‹åˆ°çš„å°±æ˜¯ç¡¬ä»¶ SP å¯„å­˜å™¨ï¼‰ã€‚ PCï¼šè¿™ä¸ªå°±æ˜¯è®¡ç®—æœºå¸¸è§çš„ pc å¯„å­˜å™¨ï¼Œåœ¨ x86 å¹³å°ä¸‹å¯¹åº” ip å¯„å­˜å™¨ï¼Œamd64 ä¸Šåˆ™æ˜¯ ripã€‚è¿™ä¸ªå¾ˆå°‘æœ‰ç”¨åˆ°ã€‚ é€šè¿‡ä¸€ä¸ªæ ˆå¸§çš„å›¾æ¥ç†è§£ä¸€ä¸‹è¿™å‡ ä¸ªå¯„å­˜å™¨\nå¤§ä½“çš„æ ˆå¸§å°±æ˜¯å›¾ä¸­çš„è¿™æ ·ï¼Œå›¾ä¸­æ ‡æ³¨çš„å¯„å­˜å™¨éƒ½æ˜¯ä»¥ callee å‡½æ•°ä¸ºåŸºå‡†çš„\né€šè¿‡å›¾ä¸­å¯çŸ¥ï¼Œå¦‚æœcalleeå‡½æ•°ä¸­æ²¡æœ‰å±€éƒ¨å˜é‡çš„è¯ï¼ŒSPç¡¬å¯„å­˜å™¨å’ŒSPä¼ªå¯„å­˜å™¨æŒ‡å‘çš„æ˜¯åŒä¸€ä¸ªåœ°æ–¹\nä¼ª FP å¯„å­˜å™¨å¯¹åº”çš„æ˜¯ caller å‡½æ•°çš„å¸§æŒ‡é’ˆï¼Œä¸€èˆ¬ç”¨æ¥è®¿é—® callee å‡½æ•°çš„å…¥å‚å‚æ•°å’Œè¿”å›å€¼ã€‚ä¼ª SP æ ˆæŒ‡é’ˆå¯¹åº”çš„æ˜¯å½“å‰ callee å‡½æ•°æ ˆå¸§çš„åº•éƒ¨ï¼ˆä¸åŒ…æ‹¬å‚æ•°å’Œè¿”å›å€¼éƒ¨åˆ†ï¼‰ï¼Œä¸€èˆ¬ç”¨äºå®šä½å±€éƒ¨å˜é‡ã€‚ç¡¬ä»¶ SP æ˜¯ä¸€ä¸ªæ¯”è¾ƒç‰¹æ®Šçš„å¯„å­˜å™¨ï¼Œå› ä¸ºè¿˜å­˜åœ¨ä¸€ä¸ªåŒåçš„ SP çœŸå¯„å­˜å™¨ï¼Œç¡¬ä»¶ SP å¯„å­˜å™¨å¯¹åº”çš„æ˜¯æ ˆçš„é¡¶éƒ¨ã€‚\nåœ¨ç¼–å†™ Go æ±‡ç¼–æ—¶ï¼Œå½“éœ€è¦åŒºåˆ†ä¼ªå¯„å­˜å™¨å’ŒçœŸå¯„å­˜å™¨çš„æ—¶å€™åªéœ€è¦è®°ä½ä¸€ç‚¹ï¼šä¼ªå¯„å­˜å™¨ä¸€èˆ¬éœ€è¦ä¸€ä¸ªæ ‡è¯†ç¬¦å’Œåç§»é‡ä¸ºå‰ç¼€ï¼Œå¦‚æœæ²¡æœ‰æ ‡è¯†ç¬¦å‰ç¼€åˆ™æ˜¯çœŸå¯„å­˜å™¨ã€‚æ¯”å¦‚(SP)ã€+8(SP)æ²¡æœ‰æ ‡è¯†ç¬¦å‰ç¼€ä¸ºçœŸ SP å¯„å­˜å™¨ï¼Œè€Œ a(SP)ã€b+8(SP)æœ‰æ ‡è¯†ç¬¦ä¸ºå‰ç¼€è¡¨ç¤ºä¼ªå¯„å­˜å™¨ã€‚\nè¿˜æœ‰ä¸€ç‚¹\nå¦‚æœcalleeçš„æ ˆç©ºé—´å¤§å°æ˜¯0çš„è¯ï¼Œ caller BP æ˜¯ä¸ä¼šè¢«å‹å…¥æ ˆä¸­çš„ï¼Œæ­¤æ—¶çš„SPç¡¬ä»¶å¯„å­˜å™¨å’Œä¼ªFPå¯„å­˜å™¨æŒ‡å‘çš„æ˜¯åŒä¸€ä¸ªä½ç½®ã€‚\nåœ¨æ±‡ç¼–ä¸­ï¼Œå‡½æ•°çš„å®šä¹‰\n1TEXT \u0026#34;\u0026#34;.add(SB), NOSPLIT|ABIInternal, $0-24 TEXT æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„æŒ‡ä»¤ï¼Œå®šä¹‰ä¸€ä¸ªå‡½æ•°\n.add æ˜¯å‡½æ•°çš„å\nNOSPLIT å‘ç¼–è¯‘å™¨è¡¨æ˜ä¸åº”è¯¥æ’å…¥ stack-split çš„ç”¨æ¥æ£€æŸ¥æ ˆéœ€è¦æ‰©å¼ çš„å‰å¯¼æŒ‡ä»¤\n$0-24 è¿™ä¸¤ä¸ªå‚æ•°ï¼Œ0æ˜¯å£°æ˜è¿™ä¸ªå‡½æ•°éœ€è¦çš„æ ˆç©ºé—´çš„å¤§å°ï¼Œä¸€èˆ¬æ¥è¯´å°±æ˜¯å±€éƒ¨å˜é‡éœ€è¦çš„ç©ºé—´ï¼Œå•ä½æ˜¯ä½ã€‚ 24æ˜¯å£°æ˜å‡½æ•°ä¼ å…¥å‚æ•°å’Œè¿”å›å€¼éœ€è¦çš„æ ˆç©ºé—´çš„å¤§å°ï¼Œå•ä½ä¹Ÿæ˜¯ä½ã€‚\nç”Ÿæˆæ±‡ç¼– äº†è§£äº†è¿™äº›åŸºæœ¬æ¦‚å¿µåï¼Œä¸Šä¸€æ®µä»£ç ï¼Œé€šè¿‡æ±‡ç¼–çœ‹ä¸€ä¸‹ä¸åŒç‰ˆæœ¬goæ˜¯å¦‚ä½•å¤„ç†å‡½æ•°ä¼ é€’å‚æ•°çš„\nå…ˆé€šè¿‡ä¸€æ®µç®€å•çš„ä»£ç çœ‹ä¸€ä¸‹åŒºåˆ«\n1package main 2 3func main(){ 4 add(10,20) 5} 6 7//go:noinline 8func add(a,b int) int{ 9 return a+b 10} //go:noinline è¿™ä¸ªæ˜¯å‘Šè¯‰ç¼–è¯‘å™¨ä¸è¦å¯¹è¿™ä¸ªå‡½æ•°å†…è”ï¼Œè¿™ä¸ªä¸œè¥¿å«goçš„ç¼–è¯‘æŒ‡ä»¤ï¼Œgoè¿˜æœ‰ä½ å¾ˆå¤šåˆ«çš„æŒ‡ä»¤ï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†ã€‚ æƒ³æƒ³goä¹ŸæŒºæœ‰æ„æ€çš„ï¼ŒC++æ˜¯é€šè¿‡ inline æ˜¾å¼çš„æŒ‡å®šè¦å†…è”ï¼Œgoæ˜¯å‘Šè¯‰ç¼–è¯‘å™¨ä¸è¦å†…è”ã€‚\nå…ˆçœ‹ä¸€ä¸‹åœ¨1.16ä¸‹çš„æ±‡ç¼–ä»£ç \n1main_pc0: 2 .file 1 \u0026#34;\u0026lt;source\u0026gt;\u0026#34; 3 .loc 1 5 0 4 TEXT \u0026#34;\u0026#34;.main(SB), ABIInternal, $32-0 5 MOVQ (TLS), CX 6 CMPQ SP, 16(CX) 7 PCDATA $0, $-2 8 JLS main_pc64 9 PCDATA $0, $-1 10 SUBQ $32, SP 11 MOVQ BP, 24(SP) 12 LEAQ 24(SP), BP 13 FUNCDATA $0, gclocalsÂ·33cdeccccebe80329f1fdbee7f5874cb(SB) 14 FUNCDATA $1, gclocalsÂ·33cdeccccebe80329f1fdbee7f5874cb(SB) 15 .loc 1 11 0 16 MOVQ $10, (SP) 17 MOVQ $20, 8(SP) 18 PCDATA $1, $0 19 CALL \u0026#34;\u0026#34;.add(SB) 20 .loc 1 12 0 21 MOVQ 24(SP), BP 22 ADDQ $32, SP 23 RET 24 NOP 25 .loc 1 5 0 26 PCDATA $1, $-1 27 PCDATA $0, $-2 28 NOP 29main_pc64: 30 CALL runtime.morestack_noctxt(SB) 31 PCDATA $0, $-1 32 JMP main_pc0 33 .loc 1 21 0 34 TEXT \u0026#34;\u0026#34;.add(SB), NOSPLIT|ABIInternal, $0-24 35 FUNCDATA $0, gclocalsÂ·33cdeccccebe80329f1fdbee7f5874cb(SB) 36 FUNCDATA $1, gclocalsÂ·33cdeccccebe80329f1fdbee7f5874cb(SB) 37 .loc 1 22 0 38 MOVQ \u0026#34;\u0026#34;.b+16(SP), AX 39 MOVQ \u0026#34;\u0026#34;.a+8(SP), CX 40 ADDQ CX, AX 41 MOVQ AX, \u0026#34;\u0026#34;.~r2+24(SP) 42 RET ä»£ç æœ‰å¾ˆå¤šï¼Œåªå…³æ³¨ä¸‹é¢å›¾ä¸­æ ‡æ³¨çš„\né€š MOVQ \u0026quot;\u0026quot;.b+16(SP), AX å’Œ MOVQ \u0026quot;\u0026quot;.a+8(SP), CX å¯ä»¥å¾—çŸ¥ï¼Œå‡½æ•°æ˜¯é€šè¿‡SPå¯„å­˜å™¨åç§»å®Œæˆä¼ é€’å‚æ•°çš„ã€‚ è¿™é‡Œè¦æ³¨æ„ï¼Œ.b+16(SP) è¿™ç§å†™æ³•çœ‹ç€åƒæ˜¯ä½¿ç”¨çš„æ˜¯ä¼ªSPå¯„å­˜å™¨ï¼Œå®é™…ä¸Šç”¨çš„æ˜¯ç¡¬ä»¶SPå¯„å­˜å™¨\nåŒæ ·çš„ï¼Œåœ¨å‡½æ•°è°ƒç”¨ä¹‹å‰ï¼Œä¹Ÿä¼šæŠŠæ•°å€¼æ”¾åˆ°æ ˆçš„æŒ‡å®šä½ç½®\nMOVQ $10, (SP) , MOVQ $20, 8(SP)\næŠŠç¼–è¯‘å™¨æ¢æˆæœ€æ–°çš„ 1.18çœ‹ä¸€ä¸‹\n1main_pc0: 2 .file 1 \u0026#34;\u0026lt;source\u0026gt;\u0026#34; 3 .loc 1 5 0 4 TEXT \u0026#34;\u0026#34;.main(SB), ABIInternal, $24-0 5 CMPQ SP, 16(R14) 6 PCDATA $0, $-2 7 JLS main_pc47 8 PCDATA $0, $-1 9 SUBQ $24, SP 10 MOVQ BP, 16(SP) 11 LEAQ 16(SP), BP 12 FUNCDATA $0, gclocalsÂ·33cdeccccebe80329f1fdbee7f5874cb(SB) 13 FUNCDATA $1, gclocalsÂ·33cdeccccebe80329f1fdbee7f5874cb(SB) 14 .loc 1 11 0 15 MOVL $10, AX 16 MOVL $20, BX 17 PCDATA $1, $0 18 NOP 19 CALL \u0026#34;\u0026#34;.add(SB) 20 .loc 1 12 0 21 MOVQ 16(SP), BP 22 ADDQ $24, SP 23 RET 24main_pc47: 25 NOP 26 .loc 1 5 0 27 PCDATA $1, $-1 28 PCDATA $0, $-2 29 CALL runtime.morestack_noctxt(SB) 30 PCDATA $0, $-1 31 JMP main_pc0 32 .loc 1 21 0 33 TEXT \u0026#34;\u0026#34;.add(SB), NOSPLIT|ABIInternal, $0-16 34 FUNCDATA $0, gclocalsÂ·33cdeccccebe80329f1fdbee7f5874cb(SB) 35 FUNCDATA $1, gclocalsÂ·33cdeccccebe80329f1fdbee7f5874cb(SB) 36 FUNCDATA $5, \u0026#34;\u0026#34;.add.arginfo1(SB) 37 FUNCDATA $6, \u0026#34;\u0026#34;.add.argliveinfo(SB) 38 PCDATA $3, $1 39 .loc 1 22 0 40 ADDQ BX, AX 41 RET åœ¨1.18çš„æ±‡ç¼–ä»£ç ä¸­å°±æ²¡æœ‰é€šè¿‡æ ˆç©ºé—´æ¥ä¼ é€’å‚æ•°äº†ï¼Œè€Œæ˜¯ç›´æ¥é€šè¿‡å¯„å­˜å™¨å®Œæˆæ“ä½œï¼Œ ADDQ BX, AXï¼Œå¹¶ä¸”è¿”å›å€¼ç›´æ¥æ”¾åˆ°å¯„å­˜å™¨ä¸­ã€‚\nå¯„å­˜å™¨æ•°é‡æ˜¯æœ‰ä¸Šé™çš„ï¼Œå¦‚æœä¼ é€’çš„å‚æ•°ä¸ªæ•°è¶…è¿‡äº†å¯„å­˜å™¨çš„ä¸Šé™ï¼Œåˆä¼šæ€æ ·å¤„ç†å‘¢\n1package main 2 3func main(){ 4 add(1,2,3,4,5,6,7,8,9,10,11,12) 5} 6 7//go:noinline 8func add(a,b,c,d,e,f,g,h,i,j,k,l int) int{ 9 return a+b+c+d+e+f+g+h+i+j+k+l 10} å¯¹åº”çš„æ±‡ç¼–\n1main_pc0: 2 .file 1 \u0026#34;\u0026lt;source\u0026gt;\u0026#34; 3 .loc 1 5 0 4 TEXT \u0026#34;\u0026#34;.main(SB), ABIInternal, $104-0 5 CMPQ SP, 16(R14) 6 PCDATA $0, $-2 7 JLS main_pc111 8 PCDATA $0, $-1 9 SUBQ $104, SP 10 MOVQ BP, 96(SP) 11 LEAQ 96(SP), BP 12 FUNCDATA $0, gclocalsÂ·33cdeccccebe80329f1fdbee7f5874cb(SB) 13 FUNCDATA $1, gclocalsÂ·33cdeccccebe80329f1fdbee7f5874cb(SB) 14 .loc 1 11 0 15 MOVQ $10, (SP) 16 MOVQ $11, 8(SP) 17 MOVQ $12, 16(SP) 18 MOVL $1, AX 19 MOVL $2, BX 20 MOVL $3, CX 21 MOVL $4, DI 22 MOVL $5, SI 23 MOVL $6, R8 24 MOVL $7, R9 25 MOVL $8, R10 26 MOVL $9, R11 27 PCDATA $1, $0 28 NOP 29 CALL \u0026#34;\u0026#34;.add(SB) 30 .loc 1 12 0 31 MOVQ 96(SP), BP 32 ADDQ $104, SP 33 RET 34main_pc111: 35 NOP 36 .loc 1 5 0 37 PCDATA $1, $-1 38 PCDATA $0, $-2 39 CALL runtime.morestack_noctxt(SB) 40 PCDATA $0, $-1 41 JMP main_pc0 42 .loc 1 21 0 43 TEXT \u0026#34;\u0026#34;.add(SB), NOSPLIT|ABIInternal, $0-96 44 FUNCDATA $0, gclocalsÂ·33cdeccccebe80329f1fdbee7f5874cb(SB) 45 FUNCDATA $1, gclocalsÂ·33cdeccccebe80329f1fdbee7f5874cb(SB) 46 FUNCDATA $5, \u0026#34;\u0026#34;.add.arginfo1(SB) 47 FUNCDATA $6, \u0026#34;\u0026#34;.add.argliveinfo(SB) 48 PCDATA $3, $1 49 .loc 1 22 0 50 LEAQ (BX)(AX*1), DX 51 ADDQ DX, CX 52 ADDQ DI, CX 53 ADDQ SI, CX 54 ADDQ R8, CX 55 ADDQ R9, CX 56 ADDQ R10, CX 57 ADDQ R11, CX 58 MOVQ \u0026#34;\u0026#34;.j+8(SP), DX 59 ADDQ DX, CX 60 MOVQ \u0026#34;\u0026#34;.k+16(SP), DX 61 ADDQ DX, CX 62 MOVQ \u0026#34;\u0026#34;.l+24(SP), DX 63 LEAQ (DX)(CX*1), AX 64 RET é€šè¿‡æ±‡ç¼–å¯ä»¥çœ‹åˆ°ï¼Œä¼šå…ˆä½¿ç”¨å¯„å­˜å™¨ï¼Œå½“å¯„å­˜å™¨ä¸å¤Ÿæ—¶ï¼Œä¼šä½¿ç”¨æ ˆç©ºé—´ã€‚\næ‰‹å†™æ±‡ç¼– é€šè¿‡æ‰‹å†™ä¸€æ®µæ±‡ç¼–ä»£ç ï¼ŒéªŒè¯ä¸€ä¸‹å„ä¸ªå¯„å­˜å™¨çš„ä½ç½®ï¼Œæˆ‘ç”¨çš„goç‰ˆæœ¬æ˜¯ 1.14.13ï¼Œæ‰€ä»¥ä¼ å‚æ•°ç”¨çš„æ˜¯æ ˆç©ºé—´ã€‚ åœ¨ main.go æ–‡ä»¶ä¸­\n1package main 2 3func add(int, int) int 4 5func main() { 6\tprint(add(10, 20)) 7} å®šä¹‰ä¸€ä¸ª main å‡½æ•°ä½œä¸ºæ•´ä¸ªç¨‹åºçš„å…¥å£ï¼Œå£°æ˜ä¸€ä¸ª add(int, int) int å‡½æ•°ï¼Œadd å‡½æ•°çš„å…·ä½“å®ç°æ˜¯ç”¨æ±‡ç¼–å†™çš„, åœ¨ main.go åŒçº§ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª add_amd64.s çš„æ–‡ä»¶ã€‚\nä½¿ç”¨ç¡¬BPå¯„å­˜å™¨ 1TEXT Â·add(SB), $0-24 2 MOVQ 8(SP), AX 3 MOVQ 16(SP), BX 4 ADDQ BX, AX 5 MOVQ AX, 24(SP) 6 RET ä½¿ç”¨ go run . å‘½ä»¤ï¼Œçœ‹ä¸€ä¸‹ç¨‹åºæ‰§è¡Œçš„ç»“æœã€‚ è¿™æ—¶å€™çš„æ ˆå¸§å¦‚å›¾æ‰€ç¤º å› ä¸ºaddå‡½æ•°æ ˆç©ºé—´æ˜¯0ï¼Œæ‰€ä»¥ä¼ªSPå¯„å­˜å™¨æ²¡æœ‰è¢«å‹å…¥æ ˆä¸­ï¼Œä¼ªSPå¯„å­˜å™¨å’Œç¡¬ä»¶SPå¯„å­˜å™¨æŒ‡å‘çš„æ˜¯åŒä¸€ä¸ªä½ç½®ã€‚\nä½¿ç”¨ä¼ªSPå¯„å­˜å™¨ 1TEXT Â·add(SB), $16-24 2 MOVQ a+16(SP), AX 3 MOVQ b+24(SP), BX 4 ADDQ BX, AX 5 MOVQ AX, ret+32(SP) 6 RET ä¸ºäº†åŒºåˆ†å¯¹æ¯”ï¼Œè¿™æ—¶å€™æŠŠaddå‡½æ•°çš„æ ˆç©ºé—´è®¾ç½®ä¸º16ï¼Œç„¶åä½¿ç”¨ä¼ªSPå¯„å­˜å™¨æ¥è·å–å€¼ã€‚ æ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š è¿™æ—¶å€™çš„æ ˆç©ºé—´å¦‚å›¾ ä½¿ç”¨FPå¯„å­˜å™¨ ä»£ç å¦‚ä¸‹:\n1TEXT Â·add(SB), $16-24 2 MOVQ a+0(FP), AX 3 MOVQ b+8(FP), BX 4 ADDQ BX, AX 5 MOVQ AX, ret+16(FP) 6 RET æ‰§è¡Œç»“æœ:\nè¯´æ˜è¿˜æ˜¯æ­£ç¡®çš„ï¼Œæ­¤æ—¶çš„æ ˆç©ºé—´æ²¡æœ‰å˜åŒ–ï¼Œå’Œä¸Šé¢æ˜¯ä¸€æ ·çš„ã€‚\nåˆ°è¿™ï¼Œåº”è¯¥èƒ½ç†è§£å„ä¸ªå¯„å­˜å™¨çš„ç›¸å¯¹ä½ç½®äº†å§ï¼š åœ¨calleeæ ˆç©ºé—´ä¸ä¸º0çš„æ—¶å€™ï¼Œ\n1FP = ç¡¬ä»¶SP + framsize + 16 2SP = ç¡¬ä»¶SP + framsize åœ¨calleeæ ˆç©ºé—´ä¸º0çš„æ—¶å€™ï¼Œ\n1FP = ç¡¬ä»¶SP + 8 2SP = ç¡¬ä»¶SP æ±‡ç¼–ç®€å•åˆ†æ é€šè¿‡ä¸Šé¢çš„ä»£ç ä¼šå‘ç°ï¼Œæ‰‹å†™æ±‡ç¼–çš„ä»£ç å’Œåæ±‡ç¼–çš„ä»£ç æœ‰äº›ä¸åŒã€‚åæ±‡ç¼–å¾—åˆ°çš„ä»£ç ï¼Œåœ¨å‡½æ•°å‰é¢ä¼šæœ‰ä¸€æ®µ CALL runtime.morestack_noctxt(SB) å…¶å®è¿™ä¸ªæ˜¯ç¼–è¯‘å™¨è‡ªåŠ¨æ’å…¥çš„ä¸€æ®µå‡½æ•°ï¼Œè¿™æ®µæŒ‡ä»¤ä¼šè°ƒç”¨ä¸€æ¬¡ runtime.morestack_noctxt è¿™ä¸ªå‡½æ•°å…·ä½“çš„ä½œç”¨æ˜¯æŒºå¤æ‚çš„ï¼Œä¸»è¦æœ‰ æ£€æŸ¥æ˜¯å¦éœ€è¦æ‰©å¼ æ ˆï¼Œgoçš„æ ˆç©ºé—´æ˜¯å¯ä»¥åŠ¨æ€æ‰©å……çš„ï¼Œæ‰€ä»¥åœ¨è°ƒç”¨å‡½æ•°å‰ä¼šæ£€æŸ¥å½“å‰çš„æ ˆç©ºé—´æ˜¯å¦éœ€è¦æ‰©å……ã€‚è¿˜æœ‰ä¸€ä¸ªåŠŸèƒ½å°±æ˜¯æ£€æŸ¥å½“å‰åç¨‹éœ€è¦æŠ¢å ã€‚goåœ¨1.14ä¹‹å‰goroutineçš„æŠ¢å æ˜¯åä½œå¼æŠ¢å æ¨¡å¼ï¼Œæ€ä¹ˆåˆ¤æ–­ä¸€ä¸ªåç¨‹æ˜¯å¦éœ€è¦æŠ¢å å‘¢ï¼Ÿåå°åç¨‹ä¼šå®šæ—¶æ‰«æå½“å‰è¿è¡Œä¸­çš„åç¨‹ï¼Œå¦‚æœå‘ç°ä¸€ä¸ªåç¨‹è¿è¡Œæ¯”è¾ƒä¹…ï¼Œä¼šå°†å…¶æ ‡è®°ä¸ºæŠ¢å çŠ¶æ€ã€‚è¿™ä¸ªæ‰«æçš„æ—¶é—´ç‚¹å°±æ˜¯å‡½æ•°è°ƒç”¨æœŸé—´å®Œæˆçš„ã€‚\nä¸åŒç±»å‹å‚æ•°ä¼ é€’ ä¼ ç»“æ„ä½“ 1package main 2 3type One struct { 4 a int 5 b int 6} 7 8func main(){ 9 o := One { 10 a:10, 11 b.20, 12 } 13 f1(o) 14} 15 16//go:noinline 17 func f1(o One) int { 18 return o.a + o.b 19 } åªè´´ å…³é”®çš„æ±‡ç¼–ä»£ç å§\n1 MOVQ $10, (SP) 2 MOVQ $0, 8(SP) 3 PCDATA $1, $0 4 CALL \u0026#34;\u0026#34;.f1(SB) 5 6.......................... 7 8 TEXT \u0026#34;\u0026#34;.f1(SB), NOSPLIT|ABIInternal, $0-24 9 MOVQ \u0026#34;\u0026#34;.o+16(SP), AX 10 MOVQ \u0026#34;\u0026#34;.o+8(SP), CX 11 ADDQ CX, AX 12 MOVQ AX, \u0026#34;\u0026#34;.~r1+24(SP) 13 RET åœ¨ä¼ ç»“æ„ä½“çš„æ—¶å€™ï¼ŒåªæŠŠç»“æ„ä½“çš„å†…å®¹ä¼ è¿›å»äº†ã€‚\nä¼ ç»“æ„ä½“æŒ‡é’ˆ 1package main 2 3type One struct { 4 a int 5 b int 6} 7 8func main(){ 9 o := \u0026amp;One{ 10 a:10, 11 b:20, 12 } 13 f1(o) 14} 15 16//go:noinline 17 func f1(o *One) int { 18 return o.a + o.b 19 } æ±‡ç¼–\n1 LEAQ \u0026#34;\u0026#34;..autotmp_2+16(SP), AX 2 MOVQ AX, (SP) 3 PCDATA $1, $0 4 CALL \u0026#34;\u0026#34;.f1(SB) 5 6....................... 7 8 TEXT \u0026#34;\u0026#34;.f1(SB), NOSPLIT|ABIInternal, $0-16 9 MOVQ \u0026#34;\u0026#34;.o+8(SP), AX 10 MOVQ (AX), CX 11 ADDQ 8(AX), CX 12 MOVQ CX, \u0026#34;\u0026#34;.~r1+16(SP) 13 RET å¯ä»¥çœ‹åˆ°ï¼Œä¼ é€’æŒ‡é’ˆçš„æ—¶å€™ï¼Œåªæ˜¯æŠŠç»“æ„ä½“ç¬¬ä¸€ä¸ªå…ƒç´ çš„åœ°å€ä¼ é€’è¿›å»äº†ã€‚\nå¦‚æœæ˜¯ä¼ ä¸€ä¸ªç©ºçš„ç»“æ„ä½“\n1package main 2 3type One struct { 4} 5 6func main(){ 7 o := One{} 8 f1(o,10,20) 9} 10 11//go:noinline 12 func f1(o One, a,b int) int { 13 return a + b 14 } æ±‡ç¼–\n1 TEXT \u0026#34;\u0026#34;.f1(SB), NOSPLIT|ABIInternal, $0-24 2 .loc 1 15 0 3 MOVQ \u0026#34;\u0026#34;.b+16(SP), AX 4 MOVQ \u0026#34;\u0026#34;.a+8(SP), CX 5 ADDQ CX, AX 6 MOVQ AX, \u0026#34;\u0026#34;.~r3+24(SP) 7 RET å¯ä»¥çœ‹åˆ°ï¼Œå½“ä¼ é€’ä¸€ä¸ªç©ºç»“æ„ä½“æ—¶ï¼Œç›¸å½“äºæ²¡æœ‰ä¼ é€’ï¼Œå› ä¸ºç©ºç»“æ„ä½“çš„ç©ºé—´å¤§å°æ˜¯0ï¼Œæ‰€ä»¥ç¼–è¯‘å™¨å°±ç»™å¿½ç•¥äº†ã€‚\næœ€å æš‚æ—¶å°±æƒ³åˆ°è¿™ä¹ˆå¤šï¼Œå…ˆå†™è¿™äº›å§ï¼Œåé¢æƒ³èµ·åˆ«çš„å†è¡¥å……å§\n","date":"2022-05-02T19:10:56Z","image":"https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/3622259-778243d5661a39cd.webp","permalink":"https://lqxhub.github.io/posts/549df04c/","title":"golangæ±‡ç¼– æ·±å…¥æ¢è®¨äº† Go è¯­è¨€ä¸­çš„æ±‡ç¼–å®ç°åŠå‚æ•°ä¼ é€’çš„æ¼”å˜ - QX's blog"},{"content":"goçš„1.18ç‰ˆæœ¬åœ¨3æœˆ15è¿™å¤©æ­£å¼å‘å¸ƒäº† release notesï¼Œè™½ç„¶åœ¨bateç‰ˆæœ¬å°±å¯ä»¥å°è¯•äº†ï¼Œæ¯•ç«Ÿé‚£æ—¶å€™è¿˜æ²¡æ­£å¼å‘å¸ƒï¼Œä¹Ÿå°±æ²¡å»å°è¯•äº†ï¼Œç°åœ¨æ­£å¼å‘å¸ƒäº†ï¼Œé©¬ä¸Šå°±æ›´äº†å°è¯•ä¸€ä¸‹ã€‚\næ€»ç®—æ˜¯åƒå‘¼ä¸‡å”¤å§‹å‡ºæ¥ï¼Œå…¶å®æˆ‘å¯¹Goçš„æ³›å‹è¿˜æ˜¯æŒºæœŸå¾…çš„ï¼Œæ¯•ç«Ÿç”¨ interface èƒ½å®ç°ä¸€äº›ä¸œè¥¿ï¼Œä½†æ˜¯è¿˜æ˜¯ä¸å¦‚åŸç”Ÿæ”¯æŒæ¥å¾—å¥½ï¼Œç”¨interfaceé¦–å…ˆä¼šå› ä¸ºç±»å‹è½¬æ¢å¸¦æ¥ä¸€äº›æ€§èƒ½æŸå¤±ï¼Œç”¨interfaceåšç±»å‹å¼ºè½¬ï¼Œæœ‰æ—¶å€™ä¼šå› ä¸ºä¸å°å¿ƒå†™é”™äº†ï¼Œå¯¼è‡´ä¸€äº›è¿è¡Œæ—¶é”™è¯¯ã€‚è¦æ˜¯æ”¯æŒæ³›å‹ï¼Œè¿™äº›é—®é¢˜å°±ä¼šè§£å†³äº†ï¼Œä¸€äº›é€šç”¨çš„åº“å°±ä¼šæ›´å¥½ç”¨äº†ã€‚\nå½“ç„¶æ³›å‹ä¹Ÿä¸æ˜¯å®Œç¾æ— ç¼ºçš„ï¼Œæ³›å‹ä¼šå¯¼è‡´è¯­è¨€å˜å¾—å¤æ‚ï¼Œå¤§å‹é¡¹ç›®çš„ä»£ç å¯èƒ½ä¼šæ›´éš¾è¯»ã€éš¾ç†è§£äº†ï¼Œè¿™ä¹Ÿä¼šå¯¼è‡´ç¼–è¯‘å™¨å®ç°èµ·æ¥æ›´å¤æ‚ã€‚ä½†æ˜¯ä¼˜åŠ¿è¿˜æ˜¯å¤§äºåŠ£åŠ¿çš„\nè¿™é‡Œæƒ³éª‚ä¸€å¥ï¼Œå…¶ä»–è¯­è¨€çš„æ³›å‹ä¸€èˆ¬éƒ½æ˜¯ç”¨ \u0026lt;\u0026gt; go çš„æ³›å‹ç”¨ [] æä¸æ‡‚ä¸ºå•¥ä¸ç”¨ \u0026lt;\u0026gt; éè¦ç‹¬æ ‘ä¸€å¸œï¼Œæ‰“ä¸è¿‡å°±åŠ å…¥ï¼Œä½ è¯´ç”¨å•¥å°±ç”¨å•¥å§\nå…ˆé€šè¿‡å‡ ä¸ªç®€å•çš„ä¾‹å­æ¥ç»ƒä¹ ä¸€ä¸‹\næ³›å‹å‡½æ•° 1func main() { 2\tfmt.Println(Max[int](1, 2)) 3\tfmt.Println(Max(1.5, 2.6)) 4\tfmt.Println(Max(\u0026#34;abc\u0026#34;, \u0026#34;efg\u0026#34;)) 5} 6 7func Max[T int | float64 | string](a, b T) T { 8\tif a \u0026gt; b { 9\treturn a 10\t} 11\treturn b 12} é€šè¿‡æ³›å‹ï¼Œå®ç°äº†ä¸€ä¸ªè·å–å¤§å€¼çš„å‡½æ•°ï¼Œå¦‚æœæ²¡æœ‰æ³›å‹ï¼Œå°±è¦æ‰‹å†™ä¸‰ä¸ªä¸åŒç±»å‹çš„å‡½æ•°ã€‚ åœ¨ä½¿ç”¨æ³›å‹å‡½æ•°çš„æ—¶å€™ï¼Œfmt.Println(Max[int](1, 2)) å’Œ fmt.Println(Max(1.5, 2.6)) ä¸¤ç§å†™æ³•éƒ½æ˜¯å¯ä»¥çš„ã€‚å¯ä»¥æŒ‡å®šç±»å‹ï¼Œä¹Ÿå¯ä»¥ä¸æŒ‡å®šï¼Œè®©ç¼–è¯‘å™¨è‡ªå·±ç±»å‹æ¨å¯¼\nMaxå‡½æ•°çš„å‚æ•°å¯ä¸æ˜¯ä»»æ„ç±»å‹çš„å‚æ•°éƒ½å¯ä»¥ä¼ å…¥ï¼Œåªèƒ½ä¼ å…¥int float64 string è¿™ä¸‰ç§ç±»å‹ï¼Œå› ä¸ºå®šä¹‰å‡½æ•°çš„æ—¶å€™ï¼Œç±»å‹å‚æ•°å°±åªæœ‰è¿™ä¸‰ç§ã€‚æ³›å‹ä¸æ˜¯ä»»æ„ç±»å‹çš„ï¼Œä¹Ÿæ˜¯æœ‰ç±»å‹çš„ï¼Œè¿™å°±æ˜¯æ³›å‹çš„ç±»å‹çº¦æŸ\næ³›å‹çº¦æŸ 1func main() { 2\tx := uint32(10) 3\ty := uint32(20) 4\tfmt.Println(Max(x, y)) 5} 6 7func Max[T int | float64 | string](a, b T) T { 8\tif a \u0026gt; b { 9\treturn a 10\t} 11\treturn b 12} ä¸Šé¢è¿™æ®µä»£ç æ˜¯æ— æ³•é€šè¿‡ç¼–è¯‘çš„ï¼Œä¼šæœ‰å¦‚ä¸‹çš„æŠ¥é”™ uint32 does not implement int|float64|string å› ä¸º Max åªå…è®¸ int float64 string è¿™ä¸‰ç§\nè¿˜æœ‰ä¸€ç§æƒ…å†µæ˜¯æ— æ³•é€šè¿‡ç¼–è¯‘çš„\n1type Myint int 2 3func main() { 4\tx := Myint (10) 5\ty := Myint (20) 6\tfmt.Println(Max(x, y)) 7} 8 9func Max[T int | float64 | string](a, b T) T { 10\tif a \u0026gt; b { 11\treturn a 12\t} 13\treturn b 14} è¿™ä¸ªä¹Ÿæ˜¯æ— æ³•é€šè¿‡ç¼–è¯‘çš„ï¼Œè™½ç„¶ Myint æ˜¯ int ç±»å‹çš„ï¼Œä½†æ˜¯ä¾ç„¶æ— æ³•é€šè¿‡ç¼–è¯‘ã€‚è¿™ç§æƒ…å†µæ˜¯å¯ä»¥åœ¨å®šä¹‰æ—¶ï¼Œä¿®æ”¹ä¸€ä¸‹å°±è¡Œäº†\n1type Myint int 2 3func main() { 4\tx := Myint (10) 5\ty := Myint (20) 6\tfmt.Println(Max(x, y)) 7} 8 9func Max[T ~int | ~float64 | ~string](a, b T) T { 10\tif a \u0026gt; b { 11\treturn a 12\t} 13\treturn b 14} åœ¨å®šä¹‰å‡½æ•°æ—¶ï¼Œåªè¦åœ¨ç±»å‹å‰åŠ ä¸Š ~ å°±å¯ä»¥äº†ã€‚\næ¯æ¬¡åœ¨å®šä¹‰æ³›å‹çº¦æŸæ—¶ï¼Œéƒ½è¦å†™ä¸€å †ç±»å‹å¥½éº»çƒ¦å•Šï¼Œgo å®˜æ–¹ä¹Ÿæƒ³åˆ°äº†ï¼Œå°±æ˜¯å®šä¹‰çº¦æŸç±»å‹\n1type MyGenerics interface { 2 ~int | ~float64 | ~string 3} 4 5func Max[T MyGenerics](a, b T) T { 6\tif a \u0026gt; b { 7\treturn a 8\t} 9\treturn b 10} è¿™æ ·å°±å®Œæˆäº†ä¸€ä¸ªæ³›å‹çš„çº¦æŸç±»å‹çš„å®šä¹‰\nè€Œä¸”goçš„æ³›å‹çº¦æŸä¹Ÿå¯ä»¥åƒ interface é‚£æ ·ç›¸äº’åµŒå¥—çš„\n1type Int interface { 2 ~int | ~uint 3} 4 5type Float interface { 6 ~float32 | ~float64 7} 8 9type Number interface { 10\tInt | Float 11} 12 13func Max2[T Number](a, b T) T { 14\tif a \u0026gt; b { 15\treturn a 16\t} 17\treturn b 18} Goå†…ç½®ä¸€ä¸ª constraintsåŒ…ï¼Œå®šä¹‰å¥½äº†ä¸€äº›å¸¸ç”¨çš„æ³›å‹çº¦æŸ\n1type Signed interface { 2\t~int | ~int8 | ~int16 | ~int32 | ~int64 3} 4 5type Unsigned interface { 6\t~uint | ~uint8 | ~uint16 | ~uint32 | ~uint64 | ~uintptr 7} 8 9type Integer interface { 10\tSigned | Unsigned 11} 12 13type Float interface { 14\t~float32 | ~float64 15} 16 17type Complex interface { 18\t~complex64 | ~complex128 19} 20 21type Ordered interface { 22\tInteger | Float | ~string 23} go è¿˜å®šä¹‰äº†ä¸€ä¸ª ç±»å‹çº¦æŸ any çœ‹è¿™ä¸ªåå­—åº”è¯¥å°±çŸ¥é“ä»€ä¹ˆæ„æ€äº†ï¼Œå°±æ˜¯ä»»æ„ç±»å‹ï¼Œè¿™ä¸ªä¹Ÿæ²¡å•¥ç¥ç§˜çš„ï¼Œå°±æ˜¯ç»™ interface æ•´äº†ä¸€ä¸ªåˆ«å\n1type any interface{} go è¿˜æœ‰ä¸€ç§çº¦æŸç±»å‹ï¼Œå‡½æ•°ç±»å‹çº¦æŸï¼Œä¹Ÿå°±æ˜¯åªæœ‰å®ç°äº† å¯¹åº”å‡½æ•°ï¼Œæ‰èƒ½ä½œä¸ºæ³›å‹ç±»å‹\n1type MyToString interface { 2\tToString() string 3} 4 5type Myint int 6 7func (m Myint) ToString() string { 8\treturn strconv.Itoa(int(m)) 9} 10 11func MyString[T MyToString](value T) { 12\tfmt.Println(value.ToString()) 13} 14 15func main() { 16\tvar x Myint 17\tx = 100 18\tMyString[Myint](x) 19} åœ¨å®šä¹‰å‡½æ•° MyString å‡½æ•°çš„æ—¶å€™ï¼ŒMyString[T MyToString](value T) å‡½æ•°çš„æ³›å‹çº¦æŸæ—¶ä¸€ä¸ªæ¥å£ï¼Œå‡½æ•° MyString çš„ç±»å‹çº¦æŸå°±æ˜¯ å®ç°äº† MyToString æ¥å£çš„ç±»å‹ã€‚æ‰€ä»¥ä¼ å…¥å‡½æ•°çš„ T ç±»å‹çš„ value ä¸€å®šä¼šæœ‰ ToString è¿™ä¸ªå‡½æ•°ã€‚\næ³›å‹ç»“æ„ä½“ 1func main() { 2\tstack := NewStack[int](10) 3 4\tfor i := 0; i \u0026lt; 10; i++ { 5\tstack.Push(i) 6\t} 7 8\tfor i := 0; i \u0026lt; 10; i++ { 9\tfmt.Printf(\u0026#34;%d \u0026#34;, stack.Pop()) 10\t} 11} 12 13func NewStack[T any](size int) *Stack[T] { 14\tstack := \u0026amp;Stack[T]{ 15\tarr: make([]T, size), 16\t} 17\tstack.size = size 18\tstack.index = -1 19\treturn stack 20} 21 22type Stack[T any] struct { 23\tarr []T 24\tsize int 25\tindex int 26} 27 28func (s *Stack[T]) Full() bool { 29\treturn s.index+1 == s.size 30} 31 32func (s *Stack[T]) Empty() bool { 33\treturn s.index \u0026lt; 0 34} 35 36func (s *Stack[T]) Push(v T) bool { 37\tif s.Full() { 38\treturn false 39\t} 40\ts.index++ 41\ts.arr[s.index] = v 42\treturn true 43} 44 45func (s *Stack[T]) Pop() T { 46\tvar v T 47\tif s.Empty() { 48\treturn v 49\t} 50\tv = s.arr[s.index] 51\ts.index-- 52\treturn v 53} ç”¨æ³›å‹å†™äº†ä¸€ä¸ªç®€å•çš„æ ˆ\n1type Stack[T any] struct { 2 arr []T 3 size int 4 index int 5} åœ¨å®šä¹‰ç»“æ„ä½“çš„åŒæ—¶æŒ‡å®šäº†æ³›å‹ç±»å‹ï¼Œè¿™æ ·å°±å®šä¹‰äº†æ³›å‹çš„ç»“æ„ä½“\nç›®å‰ç»“æ„ä½“çš„æ³›å‹è¿˜æ˜¯æœ‰ä¸€äº›é™åˆ¶ï¼Œæ¯”å¦‚ç»“æ„çš„ method ä¸èƒ½æ˜¯æ³›å‹çš„\n1type Mystruct struct { 2} 3 4func (m Mystruct) One[T ~int | ~float64](value T) { 5\tfmt.Println(value) 6} è¿™æ®µä»£ç æ˜¯ç¼–è¯‘ä¸è¿‡çš„ï¼Œåç»­å¯èƒ½ä¼šå®Œå–„è¿™éƒ¨åˆ†å§\nend goçš„æ³›å‹æ€»ç®—æ˜¯æ­£å¼å‘å¸ƒäº†ï¼Œè¶å‘¨æœ«å­¦ä¹ äº†ä¸€æ³¢ã€‚ç°åœ¨goæ³›å‹åˆšå‘å¸ƒï¼Œå·¥ä½œä¸­ç”¨ä¸Šæ³›å‹å¯èƒ½è¿˜è¦ç­‰å¾ˆé•¿æ—¶é—´ï¼Œæ¯•ç«Ÿçº¿ä¸Šçš„ä¸œè¥¿ç¨³å®šæœ€é‡è¦ã€‚æˆ‘è®°å¾—æˆ‘åˆšå…¥èŒå…¬å¸çš„æ—¶å€™ï¼Œé‚£æ—¶å€™å…¬å¸ç”¨çš„goç‰ˆæœ¬è¿˜æ˜¯ 1.4ï¼Œ é‚£æ—¶å€™go å·²ç»åˆ°äº† 1.13äº†ã€‚åæ¥å› ä¸ºdlvè°ƒè¯•ä¸å…¼å®¹ä½ç‰ˆæœ¬çš„goï¼Œå°±é€æ­¥å‡ä¸Šæ¥äº†ã€‚ç›¸ä¿¡goçš„æ³›å‹è‚¯å®šæ˜¯ä¸€ä¸ªè¶‹åŠ¿ï¼Œåç»­å¾ˆå¤šçš„å†…ç½®é…·å’Œç¬¬ä¸‰æ–¹åº“éƒ½ä¼šç”¨ä¸Šæ³›å‹äº†ã€‚ å…ˆå­¦åˆ°è¿™é‡Œå§ï¼Œç­‰æœ‰ç©ºç»§ç»­å­¦ä¹ goæ³›å‹çš„æ›´å¤šçŸ¥è¯†ï¼Œæ¯”å¦‚åº•å±‚æ˜¯æ€æ ·å®ç°çš„ï¼Œæ˜¯javaé‚£æ ·ç±»å‹æ“¦é™¤è¿˜æ˜¯C++é‚£æ ·ä»£ç å±•å¼€çš„ã€‚\n","date":"2022-03-19T17:38:55Z","permalink":"https://lqxhub.github.io/posts/c86abacd/","title":"golangæ³›å‹åˆå°è¯•"},{"content":"åœ¨goä¸­å®ç°ä¸€ä¸ªtcpæœåŠ¡å™¨è¿˜æ˜¯å¾ˆç®€å•çš„ï¼Œè‡³å°‘å’ŒC/C++ç›¸æ¯”è¿˜æ˜¯å¾ˆç®€å•çš„äº†ã€‚\nä¸€ä¸ªç®€å•çš„ä¾‹å­\n1\tlisten, err := net.Listen(\u0026#34;tcp\u0026#34;, \u0026#34;0.0.0.0:8088\u0026#34;) åªéœ€è¦è¿™æ ·ä¸€è¡Œå°±å¯ä»¥ç›‘å¬äº†ï¼Œå°±èƒ½ç­‰å¾…å®¢æˆ·ç«¯è¿æ¥äº†ã€‚æ˜¯ä¸æ˜¯è¿˜æ˜¯å¾ˆç®€å•çš„\nåœ¨C/C++ä¸­ï¼Œéœ€è¦ä¾æ¬¡ è°ƒç”¨socket() bind() listen() accept()å‡½æ•°ï¼Œå®Œæˆæ‰“å¼€ï¼Œç»‘å®šï¼Œç›‘å¬ï¼Œç­‰å¾…æ“ä½œï¼Œæ‰èƒ½å®Œæˆç­‰å¾…å®¢æˆ·ç«¯æ¥è¿æ¥ã€‚ è¿™è¿˜æ²¡å®Œï¼Œæƒ³è¦æé«˜æ€§èƒ½è¿˜éœ€è¦è‡ªå·±é€šè¿‡ epollç­‰æ‰‹æ®µå®Œæˆå¤šè·¯å¤ç”¨ã€‚\nå…¶å®åœ¨C/C++ä¸­æ˜¯é€šè¿‡è°ƒç”¨ç³»ç»Ÿå‡½æ•°æ¥å®Œæˆçš„ï¼Œåªæ˜¯goæŠŠè¿™éƒ¨åˆ†ä¸œè¥¿éƒ½ç»™åŒ…è£…äº†ï¼Œåªéœ€è¦ç®€å•çš„ä¸€è¡Œå°±å¯ä»¥å®Œæˆäº†ã€‚\nå…¶å®åœ¨goä¸­ä¹Ÿå¯ä»¥é€šè¿‡ç³»ç»Ÿå‡½æ•°è‡ªå·±æ¥å®Œæˆäº›äº‹æƒ…ã€‚åªæ˜¯è¿™äº›äº‹æƒ…æ¯”è¾ƒå¤æ‚ï¼Œè·¨å¹³å°è¿˜ä¸å¥½å¼„ï¼Œåƒä½¿ç”¨äº†epollå°±åªèƒ½åœ¨linuxç³»ç»Ÿä¸Šç¼–è¯‘è¿è¡Œäº†ã€‚\nåºŸè¯ä¸å¤šè¯´äº†ï¼Œç›´æ¥ä¸Šå‡½æ•°å§ã€‚åœ¨goä¸­å’ŒC/C++ä¸­åŒºåˆ«ä¸å¤§ï¼ŒåŒæ ·æ˜¯é€šè¿‡ç³»ç»Ÿè°ƒç”¨è¿™äº›å‡½æ•°æ¥å®Œæˆã€‚\n1func Socket(domain, typ, proto int) (fd int, err error) 2 3func Bind(fd int, sa Sockaddr) (err error) 4 5func Listen(s int, n int) (err error) 6 7func Accept(fd int) (nfd int, sa Sockaddr, err error) åœ¨goå¼€å¯tcp æœåŠ¡éœ€è¦ç”¨åˆ°çš„å‡½æ•°.\n1func EpollCreate(size int) (fd int, err error) 2 3func EpollCtl(epfd int, op int, fd int, event *EpollEvent) (err error) 4 5func EpollWait(epfd int, events []EpollEvent, msec int) (n int, err error) åœ¨goä¸­ä½¿ç”¨epolléœ€è¦çš„å‡½æ•°\nè¿™äº›å‡½æ•°éƒ½æ˜¯åœ¨syscall åŒ…ä¸‹ï¼Œæ‰€ä»¥è¿™äº›å‡½æ•°ä¸æ˜¯æ‰€æœ‰ç³»ç»Ÿä¸‹éƒ½æœ‰çš„ï¼Œ åƒepoll ç›¸å…³çš„å‡½æ•°ï¼Œå°±åªèƒ½åœ¨linuxä¸‹æ‰èƒ½ç¼–è¯‘è¿‡ã€‚\næ‰€ä»¥ï¼Œåœ¨è¿™é‡Œå°±å¼•ç”³å‡ºä¸€ä¸ªä¸œè¥¿å°±æ˜¯ æ¡ä»¶ç¼–è¯‘ åœ¨C/C++ä¸­å¯ä»¥é€šè¿‡å®å®šä¹‰æ¥å®ç°æ¡ä»¶ç¼–è¯‘\n1 #ifdef linux 2 cout\u0026lt;\u0026lt;\u0026#34;It is in Linux OS!\u0026#34;\u0026lt;\u0026lt;endl; 3 #endif è¿™æ®µä»£ç å°±åªèƒ½åœ¨linuxç³»ç»Ÿä¸Šæ‰ä¼šè¢«ç¼–è¯‘\ngoè™½ç„¶æ²¡æœ‰è¿™ä¹ˆå¼ºå¤§çš„å®å‘½ä»¤æ¥åˆ¤æ–­ï¼Œä½†æ˜¯goä¸­å¯ä»¥é€šè¿‡ç¼–è¯‘æ ‡ç­¾ å’Œ æ–‡ä»¶åç¼€æ¥åˆ¤æ–­ã€‚\næ¯”å¦‚åœ¨æ–‡ä»¶çš„ç¬¬ä¸€è¡ŒåŠ ä¸Š\n1// +build linux 2..... 3..... è¿™æ ·ï¼Œè¿™ä¸ªæ–‡ä»¶å°±åªèƒ½åœ¨linuxä¸Šæ‰ä¼šè¢«ç¼–è¯‘ï¼ˆæ³¨æ„ï¼Œ// +build linuxä¸‹é¢ä¸€å®šè¦æœ‰ä¸€ä¸ªç©ºè¡Œï¼‰ è¯¦ç»†ç”¨æ³•çœ‹è¿™é‡Œ goæ¡ä»¶ç¼–è¯‘\nä¸‹é¢å¼€å§‹å…·ä½“çš„ä»£ç \n1//å®šä¹‰ä¸€ä¸ªç»“æ„ä½“å­˜å‚¨ç›¸å…³çš„æ•°æ® 2type EpollM struct { 3\tconn map[int]*ServerConn 4 5\tsocketFd int //ç›‘å¬socketçš„fd 6\tepollFd int //epollçš„fd 7} 8 9//å¼€å¯ç›‘å¬ 10func (e *EpollM) Listen(ipAddr string, port int) error { 11\t//ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨,æ‰“å¼€ä¸€ä¸ªsocket 12\tfd, err := syscall.Socket(syscall.AF_INET, syscall.SOCK_STREAM, syscall.IPPROTO_TCP) 13\tif err != nil { 14\treturn err 15\t} 16 17\t//ipåœ°å€è½¬æ¢ 18\tvar addr [4]byte 19\tcopy(addr[:], net.ParseIP(ipAddr).To4()) 20\tnet.ParseIP(ipAddr).To4() 21\terr = syscall.Bind(fd, \u0026amp;syscall.SockaddrInet4{ 22\tPort: port, 23\tAddr: addr, 24\t}) 25\tif err != nil { 26\treturn err 27\t} 28 29\t//å¼€å¯ç›‘å¬ 30\terr = syscall.Listen(fd, 10) 31\tif err != nil { 32\treturn err 33\t} 34\te.socketFd = fd 35\treturn nil 36} è¿™æ ·å°±å®Œæˆäº†ç›‘å¬\nä¸‹é¢æ˜¯ epoll å¤„ç†éƒ¨åˆ†\n1 2//å¤„ç†epoll 3func (e *EpollM) HandlerEpoll() error { 4\tevents := make([]syscall.EpollEvent, 100) 5\t//åœ¨æ­»å¾ªç¯ä¸­å¤„ç†epoll 6\tfor { 7\t//msec -1,ä¼šä¸€ç›´é˜»å¡,ç›´åˆ°æœ‰äº‹ä»¶å¯ä»¥å¤„ç†æ‰ä¼šè¿”å›, n äº‹ä»¶ä¸ªæ•° 8\tn, err := syscall.EpollWait(e.epollFd, events, -1) 9 10\tif err != nil { 11\treturn err 12\t} 13\tfor i := 0; i \u0026lt; n; i++ { 14\t//å…ˆåœ¨mapä¸­æ˜¯å¦æœ‰è¿™ä¸ªé“¾æ¥ 15\tconn := e.GetConn(int(events[i].Fd)) 16\tif conn == nil { //æ²¡æœ‰è¿™ä¸ªé“¾æ¥,å¿½ç•¥ 17\tcontinue 18\t} 19\tif events[i].Events\u0026amp;syscall.EPOLLHUP == syscall.EPOLLHUP || events[i].Events\u0026amp;syscall.EPOLLERR == syscall.EPOLLERR { 20\t//æ–­å¼€||å‡ºé”™ 21\tif err := e.CloseConn(int(events[i].Fd)); err != nil { 22\treturn err 23\t} 24\t} else if events[i].Events == syscall.EPOLLIN { 25\t//å¯è¯»äº‹ä»¶ 26\tconn.Read() 27\t} 28\t} 29\t} 30} ä»è¿æ¥ä¸­è¯»å†™æ•°æ®\n1//è¯»å–æ•°æ® 2func (s *ServerConn) Read() { 3\tdata := make([]byte, 100) 4\t5\t//é€šè¿‡ç³»ç»Ÿè°ƒç”¨,è¯»å–æ•°æ®,næ˜¯è¯»åˆ°çš„é•¿åº¦ 6\tn, err := syscall.Read(s.fd, data) 7\tif n == 0 { 8\treturn 9\t} 10\tif err != nil { 11\tfmt.Printf(\u0026#34;fd %d read error:%s\\n\u0026#34;, s.fd, err.Error()) 12\t} else { 13\tfmt.Printf(\u0026#34;%d say: %s \\n\u0026#34;, s.fd, data[:n]) 14\ts.Write([]byte(fmt.Sprintf(\u0026#34;hello %d\u0026#34;, s.fd))) 15\t} 16} 17 18//å‘è¿™ä¸ªé“¾æ¥ä¸­å†™æ•°æ® 19func (s *ServerConn) Write(data []byte) { 20\t_, err := syscall.Write(s.fd, data) 21\tif err != nil { 22\tfmt.Printf(\u0026#34;fd %d write error:%s\\n\u0026#34;, s.fd, err.Error()) 23\t} 24} æœ€ååœ¨ä¾æ¬¡è°ƒç”¨è¿™äº›å‡½æ•°\n1package main 2 3func main() { 4\tepollM := NewEpollM() 5\t//å¼€å¯ç›‘å¬ 6\terr := epollM.Listen(\u0026#34;0.0.0.0\u0026#34;, 8088) 7\tif err != nil { 8\tpanic(err) 9\t} 10 11\t//åˆ›å»ºepoll 12\terr = epollM.CreateEpoll() 13\tif err != nil { 14\tpanic(err) 15\t} 16 17\t//å¼‚æ­¥å¤„ç†epoll 18\tgo func() { 19\terr := epollM.HandlerEpoll() 20\tepollM.Close() 21\tpanic(err) 22\t}() 23 24\t//ç­‰å¾…clientçš„è¿æ¥ 25\terr = epollM.Accept() 26\tepollM.Close() 27\tpanic(err) 28} åˆ°è¿™æ•´ä¸ªæœåŠ¡å°±è¿è¡Œèµ·æ¥äº†ï¼Œä»£ç å·²ç»ä¸Šä¼ åˆ°githubäº†ï¼Œä¼ é€é—¨\næ•´ä¸ªè¿‡ç¨‹çœ‹ä¸‹æ¥ï¼Œå’ŒC/C++å®ç°è¿‡ç¨‹è¿˜æ˜¯éå¸¸ç›¸ä¼¼çš„ï¼Œéƒ½æ˜¯é€šè¿‡ç³»ç»Ÿè°ƒç”¨å®Œæˆçš„ã€‚ä¹Ÿæ²¡æœ‰ä»€ä¹ˆéš¾ç‚¹ï¼Œå°±è¿™æ ·å§\n","date":"2022-02-13T15:17:44Z","image":"https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/c03de538924642947b1683e7e8f4ba121339581a.jpg","permalink":"https://lqxhub.github.io/posts/a59127c5/","title":"go ä½¿ç”¨ epoll å®ç°é«˜æ€§èƒ½tcpæœåŠ¡å™¨"},{"content":"pika æ˜¯å•¥æ‡‚å¾—éƒ½æ‡‚ï¼Œå¦‚æœä½ ä¸çŸ¥é“ï¼Œè¿™ç¯‡æ–‡ç« å¯¹ä½ ä¹Ÿæ²¡æœ‰ä»»ä½•å¸®åŠ©\nè¿™ç¯‡æ–‡ç« å·²ç»åŒæ­¥åˆ° pika çš„ githubä¸­\npika issue\nç¼–è¯‘ pika 0 å‡†å¤‡ éœ€è¦è½¯ä»¶ centos7.x gcc4.8 g++4.8 git cmake æœ€å¥½ç”¨centos7ç³»åˆ—, åœ¨åˆ«çš„ç³»ç»Ÿä¸­ç¼–è¯‘å¯èƒ½ä¼šæŠ¥é”™, äººç”Ÿè‹¦çŸ­, åˆ«å’Œè‡ªå·±è¿‡ä¸å»\nä½¿ç”¨make ç¼–è¯‘çš„æ—¶å€™, ä½¿ç”¨ make -jN (N=cpuæ ¸æ•° åŠ å¿«ç¼–è¯‘é€Ÿåº¦)\n1 å®‰è£…å·¥å…· gcc g++ git ä¸€èˆ¬ç”¨ yum å®‰è£…\nå®‰è£…cmake\ncmake æºç  https://cmake.org/download/\ncmakeä¾èµ– openssl-devel å…ˆç”¨yumå®‰è£… openssl-devel yum install openssl openssl-devel\nç¼–è¯‘å®‰è£…cmake\nè§£å‹cmakeæºç \n./bootstrap\nmake \u0026amp;\u0026amp; make install\n2 è§£å†³rocksdbä¾èµ–,å®‰è£…å¿…å¤‡çš„åº“ rocksdb ä¾èµ–åº“ snappy gflags zlib bzip2 stdc++ lz4 zstd lzma è¿™äº›åº“éƒ½è¦å®‰è£… ä¸ºäº†èƒ½é™æ€ç¼–è¯‘,è¿™äº›åº“éƒ½è¦å®‰è£…é™æ€åº“\nç¼–è¯‘snappy\nmkdir build \u0026amp;\u0026amp; cd build\nç¼–è¯‘ åŠ¨æ€åº“ cmake -DSNAPPY_BUILD_BENCHMARKS=OFF -DSNAPPY_BUILD_TESTS=OFF -DBUILD_SHARED_LIBS=ON ..\nmake \u0026amp;\u0026amp; make install\nç¼–è¯‘ é™æ€åº“ cmake -DSNAPPY_BUILD_BENCHMARKS=OFF -DSNAPPY_BUILD_TESTS=OFF -DBUILD_SHARED_LIBS=OFF ..\nmake \u0026amp;\u0026amp; make install\næˆ‘æ²¡æœ‰æ‰¾åˆ°åŒæ—¶ç¼–è¯‘åŠ¨æ€åº“å’Œé™æ€åº“çš„æ–¹æ³•ï¼Œåªèƒ½åˆ†å¼€ç¼–è¯‘äº†\nç¼–è¯‘gflags\n./configure\nmake \u0026amp;\u0026amp; make install\nç¼–è¯‘zlib\n./configure\nmake \u0026amp;\u0026amp; make install\nbzip2 ä¸€èˆ¬linuxéƒ½è‡ªå¸¦, æ²¡æœ‰çš„ç”¨ yum å®‰è£…ä¸€ä¸ª\nyum install bzip2-devel bzip2-libs\nstdc++ è¿™ä¸ªåº“éœ€è¦å®‰è£…é™æ€åº“,ç›´æ¥ yum å®‰è£…\nyum install libstdc++ libstdc++-devel libstdc++-static\nå®‰è£…lz4\nè§£å‹,è¿›å…¥ æºç ç›®å½•\n1cd build/cmake 2 3mkdir build \u0026amp;\u0026amp; build 4 5cmake -DBUILD_STATIC_LIBS=ON -DLZ4_BUILD_CLI=OFF -DLZ4_BUILD_LEGACY_LZ4C=OFF CMAKE_BUILD_TYPE=Relase -D LZ4_POSITION_INDEPENDENT_LIB=OFF .. 6 7make \u0026amp;\u0026amp; make install å®‰è£… zstd\nè§£å‹æºç \ncd build/cmake/lib\nmake \u0026amp;\u0026amp; make install\nå®‰è£…lzma\nè§£å‹æºç  xzå‹ç¼©åŒ…\n1./configure --disable-xz --disable-xzdec --disable-lzmadec --disable-lzmainfo --disable-lzma-links --disable-scripts --disable-doc 2make \u0026amp;\u0026amp; make install æœ€å, æ‰€æœ‰çš„åº“éƒ½å®‰è£…å¥½å,æŠŠåº“åŠ åˆ° ld ç›®å½•ä¸­ã€‚å› ä¸ºæœ‰çš„åº“ä¼šå®‰è£…åˆ° /usr/local/lib64 ç›®å½•ä¸‹ï¼Œä½†æ˜¯æœ‰çš„ç³»ç»Ÿæ²¡æœ‰æŠŠè¿™ä¸ªç›®å½•åŠ åˆ°åŠ¨æ€åº“æœç´¢ç›®å½•ä¸­,\nè§£å†³åŠæ³•\n1echo \u0026#34;/usr/local/lib64\u0026#34; \u0026gt;\u0026gt; /etc/ld.so.conf.d/usr.local.conf 2echo \u0026#34;/usr/local/lib\u0026#34; \u0026gt;\u0026gt; /etc/ld.so.conf.d/usr.local.conf æ‰§è¡Œ ldconfig\nå®‰è£… protobuf ç¼–è¯‘ protobuf, ç”¨cmakeç¼–è¯‘ protobuf release åœ°å€ https://github.com/protocolbuffers/protobuf/releases ä¸‹è½½ protobuf-cpp-XX.XX.XX.tar.gz\nxx.XX.XX æ˜¯ç‰ˆæœ¬å·ï¼Œéœ€è¦ä¸‹è½½3.Xç‰ˆæœ¬çš„\n./configure\nmake \u0026amp;\u0026amp; make install\nprotobuf ä¹Ÿè¦å®‰è£…é™æ€åº“\nåˆ°è¿™ protobuf å®‰è£…å®Œæˆ\n3 æ‹‰ä»£ç  æ‹‰ pika ä»£ç  github https://github.com/OpenAtomFoundation/pika è¿™é‡Œæœ€å¥½é€šè¿‡ä»£ç†å»æ‹‰ä»£ç ,è¦ä¸ç„¶ é€Ÿåº¦æ„Ÿäºº\ngit è®¾ç½®ä»£ç† 1git config --global https.proxy http://127.0.0.1:1080 2 3git config --global https.proxy https://127.0.0.1:1080 4 5git config --global --unset http.proxy 6 7git config --global --unset https.proxy æ‹‰å– ä¾èµ–åº“ä»£ç  cd pika æºç ç›®å½•\ngit submodule init git submodule update\n4 ç¼–è¯‘ é¢„å…ˆç¼–è¯‘ é¢„å…ˆç¼–è¯‘ä¸€æ¬¡ glog å’Œ rocksdb, å› ä¸ºè¿™ä¸¤ä¸ªåº“ç›´æ¥ç”¨ pika çš„ MakeFile ç¼–è¯‘å®¹æ˜“å‡ºé—®é¢˜,å…ˆé¢„ç¼–è¯‘ä¸€ä¸‹\nå…ˆç‰¹æ®Šç¼–è¯‘ä¸€ä¸‹glogåº“ 1cd /third/glog 2./configu 3make \u0026amp;\u0026amp; make install ç¼–è¯‘rocksdb rocksdbç¼–è¯‘å®Œä¸éœ€è¦å®‰è£…ï¼Œåªéœ€è¦å¤åˆ¶ä¸€ä¸‹é™æ€åº“å°±å¥½\nä½¿ç”¨cmakeæ„å»º\ncmake éœ€è¦ cmake3, cmakeå‘½ä»¤å¦‚ä¸‹\n1cmakeç¬”è®°3 -DWITH_BZ2=ON -DWITH_MD_LIBRARY=OFF -DWITH_SNAPPY=ON -DWITH_ZLIB=ON -DWITH_ZSTD=ON -DWITH_TOOLS=OFF -DWITH_TESTS=OFF -DCMAKE_BUILD_TYPE=Release .. 2 3make -jN æŠŠç¼–è¯‘åçš„ librocksdb.a å¤åˆ¶åˆ° rocksdb çš„æ ¹ç›®å½•\næ­£å¸¸ç¼–è¯‘ æŒ‰ç…§å®˜æ–¹ç»™çš„æ–‡æ¡£ç¼–è¯‘å³å¯,\næ‰§è¡Œ make\nç­‰å¾…æ‹‰å„ä¸ªä¾èµ–æ¨¡å—çš„ä»£ç  ç„¶åè‡ªåŠ¨ç¼–è¯‘\nå‰æœŸå·¥ä½œåšå¥½,ç¼–è¯‘ä¸­åº”è¯¥ä¸ä¼šå‡ºé”™\næ£€æŸ¥ç¼–è¯‘æ˜¯å¦æ­£ç¡®\nåç»­ ç¼–è¯‘å®Œæˆå,è¿™ä¸ªå¯æ‰§è¡Œæ–‡ä»¶æœ‰å¾ˆå¤š .soçš„ä¾èµ–, å¯ç§»æ¤æ¯”è¾ƒå·®, é€šè¿‡ è„šæœ¬ç¼–è¯‘ä¸€ä¸ªä¾èµ–è¾ƒå°‘çš„.soæ–‡ä»¶\næ‰§è¡Œ link_3_3_path-master.sh è„šæœ¬ç­‰å¾…å®Œæˆé“¾æ¥\nç¼–è¯‘å®Œæˆ æ­£å¸¸ç¼–è¯‘\nåˆ° output/bin/ ç›®å½•ä¸­, æ‰§è¡Œ ldd pika å¦‚æœæ²¡æœ‰ notfind çš„ä¾èµ–åº“ è¯´æ˜ç¼–è¯‘å®Œæˆäº†\né™æ€é“¾æ¥ output/bin/ ç›®å½•ä¸­çš„æ˜¯æ­£å¸¸ç¼–è¯‘çš„, link_3_3_path-master.sh åŒçº§ç›®å½•ä¸‹çš„æ˜¯é™æ€é“¾æ¥çš„\né™æ€é“¾æ¥è„šæœ¬ 1#!/usr/bin/sh 2source_path=/root 3dependence_path=/root/pika_static 4g++ \\ 5 ${source_path}/pika/src/build_version.o \\ 6 ${source_path}/pika/src/pika_stable_log.o \\ 7 ${source_path}/pika/src/pika_consensus.o \\ 8 ${source_path}/pika/src/pika_slave_node.o \\ 9 ${source_path}/pika/src/pika_statistic.o \\ 10 ${source_path}/pika/src/pika_client_processor.o \\ 11 ${source_path}/pika/src/pika_admin.o \\ 12 ${source_path}/pika/src/pika_binlog.o \\ 13 ${source_path}/pika/src/pika_bit.o \\ 14 ${source_path}/pika/src/pika.o \\ 15 ${source_path}/pika/src/pika_proxy.o \\ 16 ${source_path}/pika/src/pika_proxy_cli.o \\ 17 ${source_path}/pika/src/pika_proxy_conn.o \\ 18 ${source_path}/pika/src/pika_client_conn.o \\ 19 ${source_path}/pika/src/pika_command.o \\ 20 ${source_path}/pika/src/pika_pubsub.o \\ 21 ${source_path}/pika/src/pika_conf.o \\ 22 ${source_path}/pika/src/pika_dispatch_thread.o \\ 23 ${source_path}/pika/src/pika_hash.o \\ 24 ${source_path}/pika/src/pika_hyperloglog.o \\ 25 ${source_path}/pika/src/pika_kv.o \\ 26 ${source_path}/pika/src/pika_list.o \\ 27 ${source_path}/pika/src/pika_monitor_thread.o \\ 28 ${source_path}/pika/src/pika_server.o \\ 29 ${source_path}/pika/src/pika_set.o \\ 30 ${source_path}/pika/src/pika_geo.o \\ 31 ${source_path}/pika/src/pika_geohash.o \\ 32 ${source_path}/pika/src/pika_geohash_helper.o \\ 33 ${source_path}/pika/src/pika_binlog_transverter.o \\ 34 ${source_path}/pika/src/pika_binlog_reader.o \\ 35 ${source_path}/pika/src/pika_partition.o \\ 36 ${source_path}/pika/src/pika_repl_bgworker.o \\ 37 ${source_path}/pika/src/pika_repl_client.o \\ 38 ${source_path}/pika/src/pika_repl_client_conn.o \\ 39 ${source_path}/pika/src/pika_repl_client_thread.o \\ 40 ${source_path}/pika/src/pika_repl_server.o \\ 41 ${source_path}/pika/src/pika_repl_server_conn.o \\ 42 ${source_path}/pika/src/pika_repl_server_thread.o \\ 43 ${source_path}/pika/src/pika_cmd_table_manager.o \\ 44 ${source_path}/pika/src/pika_auxiliary_thread.o \\ 45 ${source_path}/pika/src/pika_rm.o \\ 46 ${source_path}/pika/src/pika_table.o \\ 47 ${source_path}/pika/src/pika_rsync_service.o \\ 48 ${source_path}/pika/src/pika_inner_message.pb.o \\ 49 ${source_path}/pika/src/pika_slot.o \\ 50 ${source_path}/pika/src/pika_data_distribution.o \\ 51 ${source_path}/pika/src/pika_meta.o \\ 52 ${source_path}/pika/src/pika_cluster.o \\ 53 ${source_path}/pika/third/slash/slash/lib/libslash.a \\ 54 ${source_path}/pika/third/pink/pink/lib/libpink.a \\ 55 ${source_path}/pika/third/blackwidow/lib/libblackwidow.a \\ 56 ${source_path}/pika/third/rocksdb/librocksdb.a \\ 57 ${source_path}/pika/src/pika_zset.o -static-libstdc++ -Wl,-Bstatic -lprotobuf -llz4 -lzstd -llz4 -lglog -lgflags -llzma -lsnappy -Wl,-Bdynamic -lpthread -lrt -lz -lbz2 -Wl,--dynamic-linker=/lib64/ld-linux-x86-64.so.2 -o pika -Wl,-Bstatic åé¢çš„æ˜¯è¦ é™æ€é“¾æ¥ çš„åº“\n-Wl,-Bdynamic åé¢çš„æ˜¯è¦ åŠ¨æ€é“¾ æ¥çš„åº“\n","date":"2022-02-12T14:28:10Z","permalink":"https://lqxhub.github.io/posts/d9a4c4a4/","title":"pikaç¼–è¯‘ç¬”è®°"},{"content":"æœ€è¿‘åœ¨çœ‹ç ”ç©¶å…¬å¸ä¸šåŠ¡çš„å­˜å‚¨æ¶æ„ï¼Œç°æœ‰çš„å­˜å‚¨ç”¨redis å’Œ leveldb é€šè¿‡è‡ªå·±å†™çš„ä¸­é—´ä»¶åšæ•°æ®è½åœ°ã€‚è¿™æ ·å†™ä¸šåŠ¡å’Œæ•°æ®æ¢å¤æœ‰ç‚¹éº»çƒ¦ï¼Œæƒ³ç€ä¼˜åŒ–ä¸€ä¸‹ï¼Œå°±å»ç ”ç©¶rediså’Œleveldbçš„æºç ã€‚å‘ç°äº†è·³è¡¨è¿™ä¸ªæ•°æ®ç»“æ„å¾ˆæœ‰æ„æ€ï¼Œæ€§èƒ½ä¸é”™ï¼Œå®ç°ä¹Ÿç›¸å¯¹ç®€å•ï¼Œå°±æƒ³ç€è‡ªå·±ç”¨goå®ç°ä¸€ä¸ªè·³è¡¨ï¼Œåœ¨é€šè¿‡è¿™ä¸ªè·³è¡¨å®ç°ä¸€ä¸ªç±»ä¼¼redis çš„ zset åŠŸèƒ½ã€‚æˆ‘ä¼šå°½å¯èƒ½ è¯¦ç»†çš„å»ä»‹ç»æ‰€æœ‰å®ç°ç»†èŠ‚ã€‚\nçœ‹ç€ç¯‡æ–‡ç« ï¼Œé¦–å…ˆç†Ÿæ‚‰é“¾è¡¨çš„ç›¸å…³çŸ¥è¯†ï¼Œæ¯”å¦‚é“¾è¡¨çš„æ’å…¥å’Œåˆ é™¤ã€‚æœ€å¥½ä¼šä¸€ç‚¹goï¼Œä¸ä¼šå…³ç³»ä¹Ÿä¸å¤§ï¼Œgoçš„è¯­æ³•å¾ˆç®€å•ï¼Œå’ŒCæœ‰ä¸€ç‚¹åƒï¼Œæœ‰è®¡ç®—æœºåŸºç¡€çš„åŸºæœ¬å¾ˆå¿«å°±èƒ½çœ‹æ‡‚goçš„è¯­æ³•ã€‚\nä¸‹é¢åˆ†è¿™ä¸ªå‡ ç‚¹æ¥ä»‹ç»\nè·³è¡¨æ˜¯ä»€ä¹ˆ è·³è¡¨çš„ä¼˜ç¼ºç‚¹ è·³è¡¨çš„ç»“æ„ æ€ä¹ˆå®ç°ä¸€ä¸ªè·³è¡¨(å¢åˆ æ”¹æŸ¥) è·³è¡¨æ˜¯ä»€ä¹ˆ è·³è¡¨æ˜¯ä¸€ä¸ªå¯ä»¥å¿«é€ŸæŸ¥æ‰¾çš„æœ‰åºé“¾è¡¨, æœç´¢ã€æ’å…¥ã€åˆ é™¤æ“ä½œçš„æ—¶é—´å‡ä¸ºO(logn), å…³äºè·³è¡¨çš„è¯¦ç»†å®šä¹‰ ç»´åŸºç™¾ç§‘ ç™¾åº¦ç™¾ç§‘ è·³è¡¨è™½ç„¶æ˜¯éå¸¸æœ‰ç”¨çš„æ•°æ®ç»“æ„ï¼Œä½†æ˜¯å¾ˆå¤šä¹¦é‡Œéƒ½æ²¡æœ‰å†™è¿™ä¸ªï¼Œæˆ‘åœ¨å¤§å­¦çš„æ•°æ®ç»“æ„è¯¾æœ¬é‡Œä¹Ÿæ²¡æœ‰å†™è·³è¡¨ï¼Œå°±å¯¼è‡´å¾ˆå¤šäººå¯¹è·³è¡¨ä¸ç†Ÿæ‚‰ã€‚\nè·³è¡¨æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œå› ä¸ºé“¾è¡¨çš„éšæœºæŸ¥æ‰¾æ€§èƒ½å¤ªå·®ï¼Œæ˜¯O(N)ï¼ŒæŸ¥æ‰¾å…ƒç´ åªèƒ½ä»å¤´ç»“ç‚¹æˆ–è€…å°¾ç»“ç‚¹éå†ã€‚\nå¦‚å›¾ä¸­è¦æŸ¥æ‰¾ç»“ç‚¹6ï¼Œåªèƒ½ä»ç»“ç‚¹1 ä¸€ç‚¹ç‚¹å¾€å³éå†ã€‚\nèƒ½ä¸èƒ½åœ¨é“¾è¡¨ä¸­ä½¿ç”¨äºŒåˆ†æŸ¥æ‰¾å‘¢ï¼Œå½“ç„¶æ˜¯å¯ä»¥çš„ï¼Œå°±æ˜¯ç»™é“¾è¡¨åŠ ç´¢å¼•ï¼Œä¹Ÿå°±æ˜¯è·³è¡¨äº†\nä¸Šå›¾å°±æ˜¯ä¸€ä¸ªç®€å•çš„è·³è¡¨äº†ï¼ˆå›¾ä¸­çš„å„ç§é¢œè‰²å’Œæ•°å­—åé¢ä¼šæœ‰è¯¦ç»†çš„ä»‹ç»ï¼‰ã€‚ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œè·³è¡¨æ˜¯åœ¨åŒå‘é“¾è¡¨çš„åŸºç¡€ä¸Šï¼ŒåŠ äº†å¤šå±‚ç´¢å¼•å®ç°çš„ã€‚\nè·³è¡¨çš„ä¼˜ç¼ºç‚¹ ä½œä¸ºå¿«é€ŸæŸ¥æ‰¾çš„æ•°æ®ç»“æ„ï¼Œè·³è¡¨å¸¸ç”¨æ¥å’Œçº¢é»‘æ ‘ åšæ¯”è¾ƒï¼Œåˆ—ä¸€ä¸‹è·³è¡¨å’Œçº¢é»‘æ ‘çš„ä¼˜ç¼ºç‚¹å§\nè·³è¡¨çš„ä¼˜ç‚¹ï¼š è·³è¡¨å®ç°èµ·æ¥ç›¸å¯¹ç®€å•ã€‚çº¢é»‘æ ‘çš„å®šä¹‰å’Œå·¦æ—‹å³æ—‹æ“ä½œï¼Œç¡®å®å¤æ‚ï¼Œæˆ‘èµ„è´¨æ„šé’ï¼Œç†è§£èµ·æ¥è¿˜æ˜¯æœ‰å•å›°éš¾ã€‚åé¢æˆ‘ä¼šè§£é‡Šè·³è¡¨å®ç°ç®€å•çš„åŸå› çš„. åŒºé—´æŸ¥æ‰¾æ–¹ä¾¿ã€‚åœ¨è·³è¡¨ä¸­æ‰¾åˆ°ä¸€ä¸ªèŠ‚ç‚¹åï¼Œå°±å¯ä»¥é€šè¿‡å‰åæŒ‡é’ˆæ‰¾åˆ°ç›¸é‚»çš„å…ƒç´ ã€‚çº¢é»‘æ ‘åˆ™éœ€è¦é€šè¿‡çˆ¶èŠ‚ç‚¹ï¼Œå­èŠ‚ç‚¹å»å¯»æ‰¾ï¼Œç›¸å¯¹éº»çƒ¦ã€‚ çº¢é»‘æ ‘çš„ä¼˜ç‚¹ å†…å­˜å ç”¨å°ï¼Œåªéœ€è¦3ä¸ªæŒ‡é’ˆå°±å¯ä»¥ï¼ˆå·¦å­æ ‘ï¼Œå³å­æ ‘ï¼Œçˆ¶èŠ‚ç‚¹ï¼‰ è€Œè·³è¡¨æœ‰ä¸€ä¸ªå‘åçš„æŒ‡é’ˆï¼Œæ¯ä¸€å±‚éƒ½æœ‰ä¸€ä¸ªå‘å‰çš„æŒ‡é’ˆ çº¢é»‘æ ‘çš„æŸ¥æ‰¾ç¨³å®šï¼Œçº¢é»‘æ ‘æœ‰ç€ä¸¥æ ¼çš„å®šä¹‰ï¼Œæ¯æ¬¡æ’å…¥å’Œåˆ é™¤æ•°æ®éƒ½ä¼šé€šè¿‡å·¦æ—‹å³æ—‹æ¥å¹³è¡¡æ ‘çš„ç»“æ„ï¼Œé€šè¿‡çº¢é»‘æ ‘æŸ¥æ‰¾æœ‰ç€ç¨³å®šçš„æŸ¥æ‰¾æ—¶é—´O(logn) ï¼Œä¸ºå•¥è·³è¡¨æ˜¯ä¸ç¨³å®šçš„ï¼Œçœ‹åˆ°è·³è¡¨æ˜¯æ€æ ·ç¡®å®šå±‚æ•°çš„å°±æ˜ç™½äº† è·³è¡¨å’Œæ™®é€šé“¾è¡¨ç›¸æ¯”ï¼Œé™¤äº†è´¹å†…å­˜ï¼Œå¥½åƒæ²¡å•¥ç¼ºç‚¹äº† è·³è¡¨çš„ç»“æ„å’Œå®ç° è·³è¡¨çš„å®ç°æ€è·¯å€Ÿé‰´äº†redisçš„zsetå®ç°æ€æƒ³å…·ä½“ä»£ç åœ¨github è·³è¡¨ç®€å•è¯´å¯ä»¥æœ‰ä¸¤ç§å®ç°æ€è·¯ï¼Œä¸€ç§æ˜¯è·³è¡¨å†…ä¸èƒ½æœ‰é‡å¤çš„å…ƒç´ ï¼Œå¦ä¸€ç§æ˜¯è·³è¡¨å†…å…è®¸æœ‰é‡å¤å…ƒç´ ã€‚redisä¸­çš„è·³è¡¨æ˜¯å…è®¸æœ‰é‡å¤å…ƒç´ çš„ï¼Œæˆ‘è¿™æ¬¡å®ç°çš„ä¹Ÿæ˜¯å¯ä»¥æœ‰é‡å¤å…ƒç´ çš„ã€‚\nè·³è¡¨node çš„ç»“æ„ 1type SkipListLevel struct { 2\t//æŒ‡å‘ä¸‹ä¸€ä¸ªç»“ç‚¹ 3\tforward *SkipListNode 4 5\t/* 6\t* åˆ°ä¸‹ä¸€ä¸ªnodeçš„è·ç¦»; 7\t* æ€è€ƒ,ä¸ºå•¥æ˜¯è®°å½•åˆ°ä¸‹ä¸€ä¸ªnode, è€Œä¸æ˜¯è®°å½•ä¸Šä¸€ä¸ªnodeåˆ°è¿™çš„è·ç¦» 8\t*/ 9\tspan int64 10} 11 12type SkipListNode struct { 13\t//æŒ‡å‘ä¸Šä¸€ä¸ªç»“ç‚¹ 14\tbackward *SkipListNode 15\t//ç´¢å¼•ç”¨çš„å±‚ 16\tlevel []SkipListLevel 17\t//å­˜å‚¨çš„å€¼ 18\tvalue ISkipListNode 19\t//æ’åç”¨çš„åˆ†æ•° 20\tscore float64 21} åœ¨ä¸€ä¸ªnodeä¸­ï¼Œé»‘è‰²çš„1æ˜¯ valueï¼Œ é»„è‰²çš„æ–¹å—æ˜¯levelï¼Œç™½è‰²çš„æ•°å­—æ˜¯spanï¼Œbackward å’Œ forward è¿™ä¸¤ä¸ªæŒ‡é’ˆåœ¨å›¾ä¸­æ²¡æœ‰ä½“ç°å‡ºæ¥ï¼Œåªä¼šæœ‰ä¸€ä¸ªbackward ï¼ˆå‘åçš„æŒ‡é’ˆï¼‰ï¼Œlevelæ•°ç»„é•¿åº¦æ˜¯å¤šå°‘ï¼Œå°±ä¼šæœ‰å¤šå°‘ä¸ªforwardï¼ˆå‘å‰çš„ï¼‰æŒ‡é’ˆã€‚ spanå€¼æ˜¯åˆ°ä¸‹ä¸€ä¸ªç»“ç‚¹çš„è·¨åº¦æ˜¯å¤šå°‘ï¼Œç›¸é‚»çš„ç»“ç‚¹æ•°å€¼æ˜¯1ã€‚è¿™ä¸ªå€¼çš„ä½œç”¨æ˜¯ç”¨æ¥è®¡ç®—è¿™ä¸ªnodeåœ¨è·³è¡¨ä¸­çš„æ’åã€‚ä¸€å¼€å§‹æˆ‘å¯¹spançš„å€¼ ä¸ç†è§£ï¼Œä»¥ä¸ºæ˜¯ä¸Šä¸ªç»“ç‚¹åˆ°è¿™é‡Œçš„è·ç¦»ï¼Œç›´åˆ°åœ¨å†™æ’å…¥å’Œæœç´¢ç»“ç‚¹çš„æ—¶å€™ï¼Œæ‰æ„è¯†åˆ°è¿™ä¸ªæ˜¯åˆ°ä¸‹ä¸ªç»“ç‚¹çš„è·¨åº¦ã€‚\nè·³è¡¨ç»“æ„ 1type SkipList struct { 2\t//å¤´ç»“ç‚¹å’Œå°¾ç»“ç‚¹ 3\t//é‡ç‚¹,å¤´ç»“ç‚¹æ˜¯ä¸€ä¸ªçœŸå®å­˜åœ¨çš„,å°¾ç»“ç‚¹åªæ˜¯ä¸€ä¸ªæŒ‡é’ˆ 4\thead, tail *SkipListNode 5 6\tsize int64 //nodeæ€»æ•° 7 8\tlevel int //å½“å‰è·³è¡¨çš„æœ€é«˜level 9 10\tmaxLevel int //å½“å‰æœ€å¤§å±‚æ•° 11} head å’Œ tail æ˜¯ä¸¤ä¸ªæŒ‡é’ˆæŒ‡å‘è·³è¡¨çš„å¤´å’Œå°¾ï¼Œsize æ˜¯æ•´ä¸ªè·³è¡¨ä¸­nodeçš„çš„æ•°é‡ï¼Œ level æ˜¯è·³è¡¨ä¸­ï¼Œå½“å‰çš„æœ€å¤§é«˜åº¦ï¼Œè¿™é‡Œä¼šå¼•ç”³å‡ºä¸€ä¸ªçŸ¥è¯†ç‚¹ï¼Œè·³è¡¨ä¸­çš„é«˜åº¦ä¸æ˜¯å›ºå®šä¸å˜çš„ï¼Œè€Œæ˜¯éšç€æ’å…¥å’Œåˆ é™¤åŠ¨æ€å˜åŒ–çš„ã€‚maxLevel æ˜¯è·³è¡¨å¯ä»¥è¾¾åˆ°çš„æœ€å¤§é«˜åº¦ï¼Œè¿™ä¸ªå€¼æ˜¯ä¸€å¼€å§‹å°±å›ºå®šçš„ä¸å˜çš„ã€‚\nå†æŠŠä¸Šé¢çš„å›¾æ‹¿è¿‡æ¥ï¼Œåˆ†æä¸€ä¸‹æ•´ä¸ªè·³è¡¨ç»“ç‚¹é—´çš„ç»„ç»‡å…³ç³»\nè·³è¡¨ä¸­ä¼šæœ‰ä¸€ä¸ª head ç»“ç‚¹ï¼Œä½†æ˜¯æ²¡æœ‰ tail ç»“ç‚¹ï¼Œtailåªæ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘è·³è¡¨çš„æœ€åä¸€ä¸ªç»“ç‚¹ã€‚è¿™ä¸ªåœ¨åˆå§‹åŒ–å‡½æ•°é‡Œæœ‰ä½“ç°\n1//åˆå§‹åŒ–ä¸€ä¸ªé»˜è®¤çš„è·³è¡¨ 2func NewDefaultSkipTable() *SkipList { 3\trand.Seed(time.Now().UnixNano()) 4\treturn \u0026amp;SkipList{ 5\thead: NewSkipListNode(SKIP_TABLE_DEFAULT_MAX_LEVEL, 0, nil), 6\tsize: 0, 7\tlevel: 1, 8\tmaxLevel: SKIP_TABLE_DEFAULT_MAX_LEVEL, 9\t} 10} å›¾ä¸­å‘å‰çš„æŒ‡é’ˆ (forward)ï¼Œä¹Ÿå°±æ˜¯æ©™è‰²çš„ç®­å¤´ï¼Œå‘åçš„æŒ‡é’ˆ (backward)ï¼Œä¹Ÿå°±æ˜¯ç»¿è‰²çš„ç®­å¤´ã€‚ forwardæŒ‡é’ˆåœ¨levelä¸­ï¼Œä¹Ÿå°±æ˜¯æ¯ä¸€å±‚éƒ½æœ‰ä¸€ä¸ªå‘å‰çš„æŒ‡é’ˆï¼Œbackwardåªå­˜åœ¨äºnodeä¸­ï¼Œä¹Ÿå°±æ˜¯æ¯ä¸ªèŠ‚ç‚¹åªæœ‰ä¸€ä¸ªå‘åçš„æŒ‡é’ˆã€‚æƒ³ä¸€ä¸‹ä¸ºå•¥åªéœ€è¦ä¸€ä¸ªå‘åçš„æŒ‡é’ˆå‘¢ï¼Ÿï¼Ÿï¼Ÿçœ‹å®Œæ•´ä¸ªæŸ¥æ‰¾è¿‡ç¨‹å°±æ˜ç™½ä¸ºå•¥åªéœ€è¦ä¸€ä¸ªå‘åæŒ‡é’ˆå°±è¡Œäº†ã€‚\næ’å…¥node åŸºç¡€çŸ¥è¯†å‡†å¤‡çš„å·®ä¸å¤šäº†ï¼Œå¼€å§‹è¿›å…¥è·³è¡¨çš„æ’å…¥é€»è¾‘ï¼Œå…ˆé€šè¿‡ä¸€å¼ å›¾æŠŠé€»è¾‘å±•ç¤ºä¸€ä¸‹\næ’å…¥å…ƒç´ çš„ç¬¬ä¸€æ­¥å°±æ˜¯å…ˆæŸ¥æ‰¾å…ƒç´ ã€‚å› ä¸ºæ˜¯æœ‰åºé“¾è¡¨ï¼Œå…ƒç´ éƒ½æ˜¯æŒ‰åºæ’åˆ—çš„ï¼Œæ’å…¥å…ƒç´ å‰å…ˆæ‰¾åˆ°å…ƒç´ åº”è¯¥åœ¨çš„ä½ç½®ã€‚\nå›¾ä¸­è¦æŠŠscoreä¸º3çš„å…ƒç´ æ’å…¥è·³è¡¨ä¸­ï¼Œå¸¦åºå·çš„ç®­å¤´ï¼ˆæŒ‡é’ˆï¼‰æ˜¯æœç´¢é¡ºåºï¼Œå…¶ä¸­é»‘è‰²çš„ç®­å¤´æ˜¯å®é™…ç¡®å®šçš„è·¯å¾„ï¼Œåœ¨æœç´¢è¿‡ç¨‹ä¸­ï¼Œè¿˜è¦è®°å½•ä¸€ä¸‹rankï¼Œä¹Ÿå°±æ˜¯ç»è¿‡æ‰€æœ‰nodeçš„spanä¹‹å’Œã€‚ å…ˆæ˜ç¡®ä¸€ä¸‹æˆ‘ä»¬è¦æœç´¢çš„ç»“ç‚¹æ˜¯å“ªä¸ªã€‚æˆ‘ä»¬è¦æ‰¾ä¸€ä¸ªå°äº3çš„æœ€å¤§çš„æ•°ï¼ˆå…ˆä¸è€ƒå°æ•°å’Œè™‘é“¾è¡¨ä¸­æœ‰å¤šä¸ª3çš„æƒ…å†µï¼‰ï¼Œä½“ç°åœ¨å›¾ä¸­ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬è¦æ‰¾åˆ°å…ƒç´ 2çš„ä½ç½®ã€‚\næœç´¢å‰å…ˆç¡®å®š å½“å‰è·³è¡¨çš„æœ€é«˜levelå€¼ã€‚ä¹Ÿå¯ä»¥æ— è„‘ä»æœ€ä¸Šå±‚å¼€å§‹ï¼Œä½†æ˜¯æ²¡æœ‰æ„ä¹‰ã€‚å›¾ä¸­æœ€é«˜levelæ˜¯4ï¼Œä¹Ÿå°±æ˜¯level3ï¼ˆå› ä¸ºlevelæ•°ç»„ä»0å¼€å§‹ï¼‰ã€‚ç„¶åä»å¤´ç»“ç‚¹ï¼ˆheadï¼‰çš„levelå±‚ï¼ˆlevel3ï¼‰å¼€å§‹ã€‚\nå…ˆè®¾ä¸€ä¸ªä¸´æ—¶æŒ‡é’ˆ t æŒ‡å‘headç»“ç‚¹ã€‚ å…ˆé€šè¿‡å›¾ä¸­ 1 æŒ‡é’ˆï¼ŒæŒ‡å‘çš„æ˜¯å…ƒç´ 4ï¼Œè¦æ’å…¥çš„èŠ‚ç‚¹æ˜¯3ï¼Œè¿™ä¸ªæ˜æ˜¾æ˜¯å¤§äº3çš„ï¼Œæ‰€ä»¥ä¸ç¬¦åˆã€‚åˆ’é‡ç‚¹äº† å½“ ç°åœ¨çš„nodeå½“å‰å±‚çš„ä¸‹ä¸€ä¸ªnodeä¸ç¬¦åˆæ¡ä»¶æ—¶ï¼Œå°±éœ€è¦å¼€å§‹æœç´¢ä¸‹ä¸€å±‚ è¿™ç®—æ˜¯ä¸€ä¸ªè½¬ç§»æ¡ä»¶å§ã€‚ è¿™æ—¶å€™å½“å‰nodeè¿˜æ˜¯åœ¨headï¼Œæ‰€ä»¥ä»headçš„level2å¼€å§‹å‘å³æœç´¢ã€‚æ­¤æ—¶nodeçš„ä¸‹ä¸€ä¸ªnodeæ˜¯1ï¼Œ1å°äº3ï¼Œæ‰€ä»¥ç¬¦åˆæ¡ä»¶ï¼Œæ‰€ä»¥ t æŒ‡é’ˆè¦æŒ‡å‘ 1 nodeï¼Œå†è®°å½•ä¸€ä¸‹headçš„spanå€¼ã€‚\nå¦‚æ­¤å¾€å¤ï¼Œç»è¿‡ 3 4 5 æŒ‡é’ˆçš„åˆ¤æ–­ï¼Œæœ€ç»ˆæ¥åˆ°äº†node 2 çš„level0ï¼Œè¿™æ—¶node2çš„ä¸‹ä¸€ä¸ªnodeæ˜¯å¤§äº3çš„ï¼Œè€Œæ­¤æ—¶ä¹Ÿæ˜¯æœ€åä¸€å±‚äº†ï¼Œæ‰€ä»¥node 2 å°±æ˜¯å°äº3 çš„æœ€å¤§å€¼äº†ï¼Œä¹Ÿå°±æ˜¯è¦æ‰¾çš„å…ƒç´ ã€‚\næ‰¾åˆ°åˆé€‚çš„ä½ç½®ï¼Œæ¥ä¸‹æ¥å°±æ˜¯æŠŠnode 3 æ’å…¥è¿›å»äº†ï¼Œå¹¶æŠŠspanè°ƒæ•´ä¸€ä¸‹ã€‚\nåœ¨ç¡®å®šå¥½è¦æ’å…¥çš„ä½ç½®åï¼Œè¿˜è¦ç¡®å®šnode3å…ƒç´ çš„levelé«˜åº¦ï¼Œè¿™ä¸ªé«˜åº¦æŒ‰ç…§ç†æƒ³çŠ¶æ€è·³è¡¨ä¸­é—´çš„nodeæ˜¯æœ€é«˜çš„ï¼Œç±»ä¼¼ä¸€ä¸ª å±± å­—å‹ï¼Œå±±å­—çš„å·¦åŠè¾¹ï¼Œå†æ‰¾åˆ°ä¸­é—´çš„nodeï¼Œè¿™ä¸ªnodeæ˜¯æ¬¡é«˜çš„ï¼Œä»¥æ­¤ç±»æ¨ã€‚ä½†å®é™…ä¸Šï¼Œè·³è¡¨æ²¡æœ‰ä¸¥æ ¼æ‰§è¡Œè¿™ç§ç†æƒ³çŠ¶æ€ï¼Œnodeçš„é«˜åº¦æ˜¯é€šè¿‡ éšæœº æ•°ç¡®å®šçš„ï¼Œä½ æ²¡çœ‹é”™ï¼Œå°±æ˜¯é€šè¿‡éšæœºæ•°ç¡®å®šã€‚è¿™ä¹Ÿå°±æ˜¯è·³è¡¨ç›¸å¯¹çº¢é»‘æ ‘å®ç°èµ·æ¥ç®€å•çš„åŸå› ã€‚\nè¿™æ˜¯éšæœºå‡½æ•°\n1//è·³è¡¨åŠ ä¸€å±‚ç´¢å¼•çš„æ¦‚ç‡ 2var SKIPLIST_P = 0.25 3 4//éšæœºç´¢å¼•çš„å±‚æ•° 5func (list *SkipList) randLevel() int { 6\tlevel := 1 7\tfor (rand.Uint32()\u0026amp;0xFFFF) \u0026lt; uint32(0xFFFF*SKIPLIST_P) \u0026amp;\u0026amp; level \u0026lt; list.maxLevel { 8\tlevel++ 9\t} 10\treturn level 11} 1func (list *SkipList) randLevel() int { 2\tlevel := 1 3\tfor rand.Int31n(100) \u0026lt; 25 \u0026amp;\u0026amp; level \u0026lt; list.maxLevel { 4\tlevel++ 5\t} 6\treturn level 7} ä¸Šé¢è¿™ä¸¤æ®µå‡½æ•°åŠŸèƒ½éƒ½æ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯25%çš„æ¦‚ç‡è®©node çš„ level æ•°+1ã€‚\nä¸‹é¢å°±æ˜¯æ•´ä¸ªæ’å…¥nodeçš„æºç \n1//æ’å…¥ä¸€ä¸ªç»“ç‚¹ 2func (list *SkipList) InsertByScore(score float64, value ISkipListNode) *SkipListNode { 3\trank := make([]int64, list.maxLevel) 4\tupdate := make([]*SkipListNode, list.maxLevel) 5\tt := list.head 6 //æœç´¢node 7\tfor i := list.level - 1; i \u0026gt;= 0; i-- { 8\tif i == list.level-1 { 9\trank[i] = 0 10\t} else { 11\trank[i] = rank[i+1] 12\t} 13\t//å½“å‰å±‚çš„ä¸‹ä¸€ä¸ªç»“ç‚¹å­˜åœ¨ \u0026amp;\u0026amp; (ä¸‹ä¸€ä¸ªç»“ç‚¹score\u0026lt;score || å½“scoreç›¸åŒæ—¶,æ¯”è¾ƒè¿™ä¸¤ä¸ªç»“ç‚¹,ä¸‹ä¸€ä¸ªç»“ç‚¹\u0026lt;æ–°æ’å…¥çš„ç»“ç‚¹) 14\tfor t.Next(i) != nil \u0026amp;\u0026amp; (t.Next(i).score \u0026lt; score || (t.Next(i).score == value.Score() \u0026amp;\u0026amp; t.Next(i).value.Compare(value) \u0026lt; 0)) { 15\trank[i] += t.level[i].span 16\tt = t.Next(i) 17\t} 18\tupdate[i] = t 19\t} 20 21\tlevel := list.randLevel() 22 23\tif level \u0026gt; list.level { 24\t//å¤„ç†rand levelå, level\u0026gt;å½“å‰levelåçš„æƒ…å†µ 25\tfor i := list.level; i \u0026lt; level; i++ { 26\trank[i] = 0 27\tupdate[i] = list.head 28\tupdate[i].SetSpan(i, list.size) 29\t} 30\tlist.level = level 31\t} 32\tnewNode := NewSkipListNode(level, score, value) 33 //æ’å…¥æ–°çš„node 34\tfor i := 0; i \u0026lt; level; i++ { 35\tnewNode.SetNext(i, update[i].Next(i)) 36\tupdate[i].SetNext(i, newNode) 37 38\tnewNode.SetSpan(i, update[i].Span(i)-(rank[0]-rank[i])) 39\tupdate[i].SetSpan(i, rank[0]-rank[i]+1) 40\t} 41 42\t//å¤„ç†æ–°å¢ç»“ç‚¹çš„span 43\tfor i := level; i \u0026lt; list.level; i++ { 44\tupdate[i].level[i].span++ 45\t} 46\t//å¤„ç†æ–°èŠ‚ç‚¹çš„åé€€æŒ‡é’ˆ 47\tif update[0] == list.head { 48\tnewNode.backward = nil 49\t} else { 50\tnewNode.backward = update[0] 51\t} 52 53\t//åˆ¤æ–­æ–°æ’å…¥çš„èŠ‚ç‚¹æ˜¯ä¸æ˜¯æœ€åä¸€ä¸ªèŠ‚ç‚¹ 54\tif newNode.Next(0) != nil { 55\tnewNode.Next(0).backward = newNode 56\t} else { 57\t//å¦‚æœæ˜¯æœ€åä¸€ä¸ªèŠ‚ç‚¹,å°±è®©tailæŒ‡é’ˆæŒ‡å‘è¿™æ–°æ’å…¥çš„èŠ‚ç‚¹ 58\tlist.tail = newNode 59\t} 60\tlist.size++ 61\treturn newNode 62} åœ¨æœç´¢è¿‡ç¨‹ä¸­ï¼Œéœ€è¦ä¸€ä¸ª rank æ•°ç»„å’Œä¸€ä¸ª update æ•°ç»„ è¿™ä¸¤ä¸ªè¾…åŠ©ç»“æ„ã€‚ rankç”¨æ¥è®°å½•æ¯å±‚çš„æ’åå€¼ï¼Œç”¨æ¥åé¢è°ƒæ•´æ–°node çš„rank ä½¿ç”¨ã€‚ updateç”¨æ¥è®°å½•ä»ä¸Šè€Œä¸‹ç»è¿‡çš„è·¯å¾„ï¼Œä¹Ÿå°±æ˜¯æ–°nodeçš„æ¯ä¸€å±‚åœ¨è·³è¡¨ä¸­çš„ä¸Šä¸€ä¸ªnodeã€‚\n1 //å½“å‰å±‚çš„ä¸‹ä¸€ä¸ªç»“ç‚¹å­˜åœ¨ \u0026amp;\u0026amp; (ä¸‹ä¸€ä¸ªç»“ç‚¹score\u0026lt;score || å½“scoreç›¸åŒæ—¶,æ¯”è¾ƒè¿™ä¸¤ä¸ªç»“ç‚¹,ä¸‹ä¸€ä¸ªç»“ç‚¹\u0026lt;æ–°æ’å…¥çš„ç»“ç‚¹) 2 for t.Next(i) != nil \u0026amp;\u0026amp; (t.Next(i).score \u0026lt; score || (t.Next(i).score == value.Score() \u0026amp;\u0026amp; t.Next(i).value.Compare(value) \u0026lt; 0)) { 3 rank[i] += t.level[i].span 4 t = t.Next(i) 5 } ä¸Šé¢æ˜¯æœç´¢è¿‡ç¨‹ä¸­ï¼Œåˆ¤æ–­æ˜¯å³ç§»è¿˜æ˜¯è°ƒåˆ°ä¸‹ä¸€å±‚çš„é€»è¾‘ã€‚è¿™é‡Œä¸æ­¢éœ€è¦åˆ¤æ–­nodeçš„socoreï¼Œè¿˜è¦è€ƒè™‘ä¸¤ä¸ªnode çš„ scoreç›¸åŒçš„æƒ…å†µï¼Œä¸¤ä¸ªnode çš„ socreç›¸åŒæ—¶ï¼Œéœ€è¦é€šè¿‡Compare å‡½æ•°åˆ¤æ–­ä¸¤ä¸ªnodeçš„å¤§å°ã€‚\n1 level := list.randLevel() 2 if level \u0026gt; list.level { 3 //å¤„ç†rand levelå, level\u0026gt;å½“å‰levelåçš„æƒ…å†µ 4 for i := list.level; i \u0026lt; level; i++ { 5 rank[i] = 0 6 update[i] = list.head 7 update[i].SetSpan(i, list.size) 8 } 9 list.level = level 10 } è¿™æ®µä»£ç ï¼Œæ˜¯ç¡®å®šæ–°nodeçš„é«˜åº¦åï¼Œå¤„ç†ä¸€ä¸‹æ–°åŠ å±‚çš„ã€‚å› ä¸ºåœ¨æœç´¢çš„æ—¶å€™ï¼Œæ²¡æœ‰æŠŠç°åœ¨é«˜å‡ºå±‚æ•°çš„headæ”¾åˆ°updateä¸­ï¼Œç°åœ¨æ”¾åˆ°å…¶ä¸­ã€‚\n1 //æ’å…¥æ–°çš„node 2 for i := 0; i \u0026lt; level; i++ { 3 newNode.SetNext(i, update[i].Next(i)) 4 update[i].SetNext(i, newNode) 5 6 newNode.SetSpan(i, update[i].Span(i)-(rank[0]-rank[i])) 7 update[i].SetSpan(i, rank[0]-rank[i]+1) 8 } è¿™æ®µä»£ç æ˜¯é€šè¿‡è°ƒæ•´nodeçš„å‰åæŒ‡é’ˆï¼Œå°†æ–°çš„nodeåŠ å…¥åˆ°è·³è¡¨ä¸­ã€‚å¹¶ä¸”è°ƒæ•´nodeçš„spanå€¼ã€‚è¿™æ—¶å€™ï¼Œspanå€¼æ˜¯åˆ°ä¸‹ä¸ªnodeçš„è·ç¦»è€Œä¸æ˜¯ä¸Šä¸ªnodeåˆ°è¿™çš„è·ç¦»çš„å¥½å¤„å°±æç°å‡ºæ¥äº†ï¼Œå› ä¸ºæ˜¯åˆ°ä¸‹ä¸ªnodeçš„è·ç¦»ï¼Œåªéœ€è¦æ”¹å½“å‰nodeçš„spanå€¼å°±å¥½äº†ï¼Œå¦‚æœå­˜çš„æ˜¯ä¸Šä¸ªnodeåˆ°è¿™ä¸ªnodeçš„è·ç¦»ï¼Œå°±éœ€è¦æ”¹ä¸‹ä¸ªnodeçš„spanäº†ï¼Œæ”¹åŠ¨èµ·äº†å°±ä¼šéº»çƒ¦äº†ã€‚è¯´çš„å¯èƒ½æœ‰ç‚¹å•°å—¦ï¼Œè‡ªå·±æ¨å¯¼ä¸€éå°±èƒ½ä½“ä¼šå‡ºæ¥äº†ã€‚\n1 //å¤„ç†æ–°å¢ç»“ç‚¹çš„span 2 for i := level; i \u0026lt; list.level; i++ { 3 update[i].level[i].span++ 4 } è¿™æ®µå¯èƒ½æ˜¯ä¸å¤ªå¥½ç†è§£çš„ï¼Œè¿™æ®µä»£ç çš„ä½œç”¨æ˜¯ï¼Œå¦‚æœæ–°nodeçš„levelå°äºè·³è¡¨ä¸­çš„æœ€å¤§levelæ—¶ï¼ˆæ–°nodeçš„levelæ˜¯2ï¼Œæ­¤æ—¶è·³è¡¨ä¸­æœ€å¤§çš„levelæ˜¯5çš„æƒ…å†µï¼‰ï¼Œè¿™æ—¶å€™è¦æŠŠ2ä¸Šé¢çš„æ‰€æœ‰çš„nodeçš„span+1ã€‚\nå‰©ä¸‹çš„ï¼Œå¤„ç†æ–°nodeçš„åé€€æŒ‡é’ˆï¼ˆbackwardï¼‰å’Œåˆ¤æ–­æ˜¯å¦æ˜¯æœ€åä¸€ä¸ªnodeï¼Œçš„æƒ…å†µå°±å¾ˆç®€å•äº†ã€‚\nåˆ°ç°åœ¨ï¼Œæ’å…¥nodeå°±å®Œæˆäº†ï¼Œæ˜¯ä¸æ˜¯ä¹Ÿä¸éš¾å˜›ï¼Œå¯¹ä¸å¯¹ã€‚å…¶å®è·³è¡¨ä¸­æœ€å¤æ‚çš„å°±æ˜¯æ’å…¥è¿‡ç¨‹äº†ï¼Œå‰©ä¸‹çš„åˆ é™¤ï¼Œæ›´æ–°ï¼ŒæŸ¥æ‰¾å°±æ˜¯å·®ä¸å¤šçš„é€»è¾‘ï¼Œå…ˆæ‰¾åˆ°å…³é”®nodeï¼Œå†åšå¤„ç†ã€‚\nåˆ é™¤node åŒæ ·çš„ï¼Œåˆ é™¤ä¹Ÿæ˜¯è¦å…ˆæœç´¢ï¼Œé€šè¿‡é»‘è‰²ç®­å¤´çš„è·¯å¾„ï¼Œæ‰¾åˆ°è¦åˆ é™¤çš„nodeå‰ä¸€ä¸ªï¼Œç„¶åä¿®æ”¹ç›®æ ‡nodeçš„ä¸Šä¸€ä¸ªnodeçš„æŒ‡é’ˆ,è·³è¿‡ç›®æ ‡node,å®Œæˆåˆ é™¤,æœ€åè°ƒæ•´ç›®æ ‡nodeå‰é¢nodeçš„spanå€¼ã€‚\nå…ˆæœç´¢node,å¹¶è®°å½•åˆ°updateæ•°ç»„\n1//è·å–æ‰¾åˆ°è¯¥ç»“ç‚¹çš„å„å±‚ç»“ç‚¹(è·¯å¾„) 2func (list *SkipList) GetUpdateList(node *SkipListNode) (update []*SkipListNode) { 3\tupdate = make([]*SkipListNode, list.maxLevel) 4\tt := list.head 5\tfor i := list.level - 1; i \u0026gt;= 0; i-- { 6\tfor t.Next(i) != nil \u0026amp;\u0026amp; (t.Next(i).score \u0026lt; node.score || (t.Next(i).score == node.score \u0026amp;\u0026amp; t.Next(i).value.Compare(node.value) \u0026lt; 0)) { 7\tt = t.Next(i) 8\t} 9\tupdate[i] = t 10\t} 11\treturn 12} è¿™æ®µé€»è¾‘å’Œæ’å…¥æ—¶çš„æœç´¢é€»è¾‘ä¸€æ ·\nä¸‹é¢æ˜¯åˆ é™¤çš„é€»è¾‘\n1//åˆ é™¤å¯¹åº”çš„ç»“ç‚¹ 2func (list *SkipList) Delete(node *SkipListNode, update []*SkipListNode) { 3\tif node == nil { 4\treturn 5\t} 6\t//head ä¸èƒ½åˆ  7\tif node == list.head { 8\treturn 9\t} 10 11\tfor i := 0; i \u0026lt; list.level; i++ { 12\tif update[i].Next(i) == node { 13\t//ä¿®æ”¹span 14\tupdate[i].SetSpan(i, update[i].Span(i)+node.Span(i)-1) 15\t//åˆ é™¤å¯¹åº”çš„ç»“ç‚¹ 16\tupdate[i].SetNext(i, node.Next(i)) 17\t} else { 18\tupdate[i].level[i].span-- 19\t} 20\t} 21 22\t//å¤„ç†nodeçš„åæŒ‡é’ˆ 23\tif node.Next(0) == nil { //nodeæ˜¯æœ€åä¸€ä¸ª,æŠŠtailæŒ‡é’ˆæŒ‡å‘nodeçš„ä¸Šä¸€ä¸ª(update[0]) 24\tlist.tail = update[0] 25\t} else { //nodeä¸æ˜¯æœ€åä¸€ä¸ª,nodeçš„ä¸‹ä¸€ä¸ªæŒ‡å‘nodeçš„ä¸Šä¸€ä¸ª(update[0]) 26\tnode.Next(0).backward = update[0] 27\t} 28 29\t//å¤„ç†åˆ æ‰çš„æ˜¯æœ€é«˜levelçš„æƒ…å†µ,å½“å‰çš„levelè¦å¯¹åº”çš„-- 30\tfor list.level \u0026gt; 1 \u0026amp;\u0026amp; list.head.Next(list.level-1) == nil { 31\tlist.level-- 32\t} 33 34\tlist.size-- 35} åˆ é™¤nodeçš„ä»£ç å°±ç®€å•å¤šäº†ï¼Œè¿™é‡Œé€šè¿‡å‚æ•°ä¼ å…¥ä»æœ€é«˜åˆ°æ‰¾åˆ°nodeçš„è·¯å¾„ï¼Œä¹Ÿå°±æ˜¯updateæ•°ç»„ã€‚\n1 for i := 0; i \u0026lt; list.level; i++ { 2 if update[i].Next(i) == node { 3 //ä¿®æ”¹span 4 update[i].SetSpan(i, update[i].Span(i)+node.Span(i)-1) 5 //åˆ é™¤å¯¹åº”çš„ç»“ç‚¹ 6 update[i].SetNext(i, node.Next(i)) 7 } else { 8 update[i].level[i].span-- 9 } 10 } è¿™ä¸ªæ®µé€»è¾‘å°±æ˜¯åˆ é™¤nodeçš„ï¼Œåˆ é™¤è¯´ç™½äº†å°±æ˜¯è®©ç›®æ ‡nodeçš„å‰é¢çš„nodeçš„åæŒ‡é’ˆæŒ‡å‘ç›®æ ‡nodeåé¢çš„nodeã€‚ å‰©ä¸‹çš„å°±æ˜¯å¤„ç†nodeçš„åé€€æŒ‡é’ˆå’Œåˆ¤æ–­æ˜¯å¦æ˜¯æœ€åä¸€ä¸ªnodeäº†ã€‚\næ›´æ–°node 1//æ›´æ–°ç»“ç‚¹çš„score 2func (list *SkipList) UpdateScore(node *SkipListNode, score float64) { 3\tif score == node.score { 4\treturn 5\t} 6\t//æ›´æ–°å,åˆ†æ•°è¿˜æ˜¯ \u0026lt; next nodeçš„ä½ç½®ä¸ç”¨å˜ 7\tif score \u0026gt; node.score { 8\tif node.Next(0) != nil \u0026amp;\u0026amp; score \u0026lt; node.Next(0).score { 9\tnode.score = score 10\treturn 11\t} 12\t} 13 14\t//æ›´æ–°å,åˆ†æ•°è¿˜æ˜¯ \u0026gt; per nodeçš„ä½ç½®ä¸ç”¨å˜ 15\tif score \u0026lt; node.score { 16\tif node.Pre() != nil \u0026amp;\u0026amp; score \u0026gt; node.Pre().score { 17\tnode.score = score 18\treturn 19\t} 20\t} 21\t//åˆ æ‰node,é‡æ–°æ’å…¥ 22\tupdateList := list.GetUpdateList(node) 23\tlist.Delete(node, updateList) 24\t//é‡æ–°æ’å…¥ 25\tlist.InsertByScore(score, node.value) 26} æ›´æ–°nodeçš„scoreï¼Œæ›´æ–°nodeçš„å‰ææ˜¯æ‰¾åˆ°ç›®æ ‡nodeï¼ŒåŸç†å’Œå‰é¢çš„æ’å…¥ï¼Œåˆ é™¤æ—¶çš„æœç´¢é€»è¾‘ä¸€æ ·ï¼Œå°±ä¸èµ˜è¿°äº†ã€‚ è¯´ä¸€ä¸‹æ›´æ–°node scoreçš„é€»è¾‘æŠŠï¼Œæœ€ç®€å•å°±æ˜¯æŠŠnodeåˆ äº†ï¼Œç„¶åå†æ’å…¥ã€‚å½“ç„¶è¿™æ ·çš„é€»è¾‘æ˜¯å¯ä»¥ä¼˜åŒ–çš„ï¼Œæ¯”å¦‚æœ‰ä¸€ç§æƒ…å†µ\nå¦‚å›¾æ‰€ç¤ºï¼Œè¦æŠŠnode4çš„scoreæ›´æ–°æˆ5ï¼Œè¿™æ—¶å€™ä¿®æ”¹nodeçš„scoreä¸å½±å“nodeçš„ä½ç½®ï¼Œæ‰€ä»¥è¿™ç§æƒ…å†µå°±åªéœ€è¦ä¿®æ”¹nodeçš„scoreå°±å¥½äº†ï¼Œä¸ç”¨è€ƒè™‘nodeåœ¨è·³è¡¨ä¸­çš„ä½ç½®ã€‚\nå¯¹äºé‚£ç§ä¿®æ”¹åˆ†æ•°ä¼šæ”¹å˜ä½ç½®çš„æƒ…å†µï¼Œå°±éœ€è¦å…ˆåˆ é™¤nodeï¼Œå†é‡æ–°æ’å…¥nodeäº†ã€‚\næŸ¥æ‰¾node çœ‹åˆ°è¿™é‡Œï¼ŒæŸ¥æ‰¾nodeåº”è¯¥æ˜¯éå¸¸ç®€å•äº†å§ï¼Œå› ä¸ºå‰é¢çš„æ’å…¥ï¼Œæ›´æ–°ï¼Œåˆ é™¤éƒ½éœ€è¦å‰æŸ¥æ‰¾nodeã€‚ä½†æ˜¯æŸ¥æ‰¾åˆ†ä¸¤ç§æƒ…å†µï¼Œä¸€ç§æ˜¯æ ¹æ®æ’åæŸ¥æ‰¾ï¼Œå¦ä¸€ç§æ˜¯æ ¹æ®scoreæŸ¥æ‰¾ã€‚\nå…ˆçœ‹æ ¹æ®æ’åæŸ¥æ‰¾\n1//æ ¹æ®æ’å èŒƒå›´ æŸ¥æ‰¾ node 2func (list *SkipList) GetNodeByRank(left, right int64) (result []*SkipListNode) { 3\t//èŒƒå›´å‡ºé”™ 4\tif list.Size() == 0 || left == 0 || right == 0 || right \u0026lt; left || left \u0026gt; list.Size() { 5\treturn 6\t} 7\ttRank := int64(0) 8\tt := list.head 9\tresult = make([]*SkipListNode, 0, right-left+1) 10\t//å…ˆæ‰¾åˆ°æ’åæœ€å°çš„å…ƒç´ ,ç„¶åå‘å³ä¸€ç‚¹ç‚¹æŸ¥æ‰¾,ç›´åˆ°æ‰¾åˆ°æ’åæœ€å¤§çš„å…ƒç´  11\tfor i := list.level - 1; i \u0026gt;= 0; i-- { 12\tfor t.Next(i) != nil \u0026amp;\u0026amp; tRank+t.level[i].span \u0026lt;= left { 13\ttRank += t.level[i].span 14\tt = t.Next(i) 15\t} 16\tif tRank == left { 17\tfor ; t != nil \u0026amp;\u0026amp; tRank \u0026lt;= right; t = t.Next(0) { 18\tresult = append(result, t) 19\ttRank++ 20\t} 21\treturn 22\t} 23\t} 24\treturn 25} å…ˆæ’é™¤ä¸ç¬¦åˆçš„æƒ…å†µï¼Œå†æ ¹æ®ä¹‹å‰çš„æŸ¥æ‰¾é€»è¾‘ï¼Œä¸€æ­¥æ­¥å»æŸ¥æ‰¾ã€‚ä¸åŒçš„æ˜¯ï¼Œç°åœ¨çš„é™åˆ¶æ¡ä»¶æ—¶æ’åã€‚\nåœ¨çœ‹æ ¹æ®scoreæŸ¥æ‰¾\n1 2//åˆ¤æ–­ è¿™ä¸ªè·³è¡¨ çš„æœ€å¤§å€¼å’Œæœ€å°å€¼ æ˜¯å¦åŒ…å« è¦æŸ¥è¯¢çš„scoreèŒƒå›´ 3func (list *SkipList) ScoreInRange(findRange *SkipListFindRange) bool { 4\tif !findRange.MaxInf \u0026amp;\u0026amp; list.head.Next(0).score \u0026gt; findRange.Max { 5\treturn false 6\t} 7\tif !findRange.MinInf \u0026amp;\u0026amp; list.tail.score \u0026lt; findRange.Min { 8\treturn false 9\t} 10\treturn true 11} 12 13//æ ¹æ® score èŒƒå›´ æŸ¥æ‰¾ node 14func (list *SkipList) GetNodeByScore(findRange *SkipListFindRange) (result []*SkipListNode) { 15\tif findRange == nil || list.Size() == 0 { 16\treturn 17\t} 18\t//æŸ¥æ‰¾èŒƒå›´ä¸åœ¨è¿™è·³è¡¨ä¸­,ç›´æ¥return 19\tif !list.ScoreInRange(findRange) { 20\treturn 21\t} 22\tt := list.head 23\tif findRange.MinInf { 24\t//ä»å¤´å¼€å§‹æŸ¥æ‰¾ 25\tt = list.head.Next(0) 26\t} else { 27\t//ä¸æ˜¯ä»å¤´,æ‰¾åˆ°æœ€å°çš„é‚£ä¸ªå…ƒç´  28\tfor i := list.level - 1; i \u0026gt;= 0; i-- { 29\tfor t.Next(i) != nil \u0026amp;\u0026amp; t.Next(i).score \u0026lt; findRange.Min { 30\tt = t.Next(i) 31\t} 32\t} 33\t} 34\tfor { 35\t//ç¬¦åˆèŒƒå›´çš„æ¡ä»¶ (ä»è´Ÿæ— ç©· || å½“å‰çš„score \u0026gt;= æŸ¥æ‰¾çš„æœ€å°å€¼) \u0026amp;\u0026amp; (åˆ°æ­£æ— ç©· || å½“å‰å…ƒç´  \u0026lt;= æŸ¥æ‰¾çš„æœ€å¤§å€¼) 36\tif (findRange.MinInf || t.score \u0026gt;= findRange.Min) \u0026amp;\u0026amp; (findRange.MaxInf || t.score \u0026lt;= findRange.Max) { 37\tresult = append(result, t) 38\t} 39\tif t.Next(0) == nil || (!findRange.MaxInf \u0026amp;\u0026amp; t.Next(0).score \u0026gt; findRange.Max) { 40\t//ä¸‹ä¸€ä¸ªå…ƒç´ æ˜¯ç©º(åˆ°å°¾äº†) || (ä¸æ˜¯æŸ¥æ‰¾åˆ°æ­£æ— ç©· \u0026amp;\u0026amp; ä¸‹ä¸€ä¸ªå…ƒç´ çš„ score \u0026gt; è¦æŸ¥æ‰¾çš„æœ€å¤§å€¼) 41\tbreak 42\t} else { 43\t//å‘å³ç§»åŠ¨ 44\tt = t.Next(0) 45\t} 46\t} 47\treturn 48} æ ¹æ®scoreæŸ¥æ‰¾ç¨å¾®å¤æ‚ä¸€ç‚¹ï¼Œå› ä¸ºæ ¹æ®scoreä¼šæœ‰æ­£æ— ç©·å’Œè´Ÿæ— ç©·è¿™ä¸¤ç§æƒ…å†µã€‚è¿™æ—¶å€™åªç»™ä¸¤ä¸ªç®€å•çš„èŒƒå›´å€¼å°±ä¸å¤Ÿç”¨äº†ï¼Œéœ€è¦ç”¨ä¸€ä¸ªç»“æ„ä½“æ¥æè¿°èŒƒå›´äº†ã€‚\n1//æ ¹æ®scoresæŸ¥æ‰¾å…ƒç´ çš„æ¡ä»¶ 2type SkipListFindRange struct { 3\tMin, Max float64 //æœ€å¤§å€¼å’Œæœ€å°å€¼ 4\tMinInf, MaxInf bool //æ˜¯å¦æ˜¯æ­£æ— ç©·å’Œè´Ÿæ— ç©· 5} åœ¨æŸ¥æ‰¾å‰å…ˆåˆ¤æ–­ä¸€ä¸‹ï¼Œç»™å®šçš„èŒƒå›´æ˜¯å¦åœ¨è·³è¡¨çš„èŒƒå›´å†…ï¼Œå¦‚æœä¸åœ¨å°±ä¸ç”¨æŸ¥æ‰¾äº†ã€‚\n1 t := list.head 2 if findRange.MinInf { 3 //ä»å¤´å¼€å§‹æŸ¥æ‰¾ 4 t = list.head.Next(0) 5 } else { 6 //ä¸æ˜¯ä»å¤´,æ‰¾åˆ°æœ€å°çš„é‚£ä¸ªå…ƒç´  7 for i := list.level - 1; i \u0026gt;= 0; i-- { 8 for t.Next(i) != nil \u0026amp;\u0026amp; t.Next(i).score \u0026lt; findRange.Min { 9 t = t.Next(i) 10 } 11 } 12 } è¿™æ®µé€»è¾‘æ˜¯ç¡®å®šæŸ¥æ‰¾çš„å¼€å§‹ä½ç½®ä¹Ÿå°±æ˜¯æ‰¾åˆ°ç›®æ ‡nodeï¼ˆæ ¹æ®èŒƒå›´æ‰¾åˆ°æœ€å°çš„nodeï¼‰ï¼Œå¦‚æœæ˜¯ä»è´Ÿæ— ç©·å¼€å§‹ï¼Œå°±ä¸ç”¨é€šè¿‡ä¹‹å‰çš„æ–¹å¼å»ç¡®å®šå¼€å§‹nodeäº†ï¼Œç›´æ¥ä»headå¼€å§‹å°±å¥½äº†ã€‚ åé¢çš„é€»è¾‘å°±æ²¡ä»€ä¹ˆç‰¹åˆ«çš„ï¼Œæ‰¾åˆ°ç›®æ ‡å¼„çš„åï¼Œå¼€å§‹å¾€åæ‰¾ï¼Œç›´åˆ°æœ€åæˆ–è€…ä¸ç¬¦åˆèŒƒå›´äº†ï¼Œå°±ç»“æŸã€‚\nå¥½äº†æŸ¥æ‰¾ä¹Ÿå®Œæˆäº†ã€‚\nè·³è¡¨çš„åŸºæœ¬åŠŸèƒ½åˆ°ç°åœ¨å·²ç»å®Œæˆï¼Œå‰©ä¸‹çš„å°±æ˜¯æŠŠè·³è¡¨åŒ…è£…ä¸€å±‚ï¼Œå»å®ç°redisä¸­zsetçš„åŠŸèƒ½å°±å¥½äº†ã€‚å…·ä½“ä»£ç å°±ä¸è´´äº†ï¼Œæœ€åæˆ‘ä¼šç»™å‡ºgithubçš„è¿æ¥ã€‚\næ€»ç»“ è·³è¡¨å¯ä»¥çœ‹åšä¸€ä¸ªæ”¯æŒäºŒåˆ†æŸ¥æ‰¾çš„æœ‰åºåŒå‘é“¾è¡¨ è·³è¡¨ä¸­æœ€æ ¸å¿ƒçš„å°±æ˜¯æœç´¢ï¼Œä¸ç®¡æ˜¯åœ¨æ’å…¥ï¼Œæ›´æ–°ï¼Œåˆ é™¤è¿˜æ˜¯æŸ¥æ‰¾ä¸­ï¼Œéƒ½è¦å…ˆæœç´¢ è·³è¡¨åœ¨æ’å…¥nodeæ—¶ï¼Œé€šè¿‡éšæœºæ•°ç¡®å®šnodeä¸­å±‚æ•°çš„ è·³è¡¨çš„nodeä¸­ï¼Œæœ‰ä¸€ä¸ªå‘åçš„æŒ‡é’ˆï¼Œåœ¨æ¯ä¸€å±‚ä¸­æœ‰ä¸€ä¸ªå‘å‰çš„æŒ‡é’ˆ è·³è¡¨ç›¸å¯¹äºçº¢é»‘æ ‘ï¼Œä¼˜åŠ¿æ˜¯ç›¸å¯¹å®¹æ˜“å®ç°ï¼Œå’ŒèŒƒå›´æŸ¥æ‰¾æ–¹ä¾¿ æœ€ååœ¨è¯´ä¸€ä¸‹å¸¸è§çš„è·³è¡¨çš„åº”ç”¨å§ã€‚redis çš„zsetå°±æ˜¯åŸºäºè·³è¡¨å®ç°çš„ï¼Œå½“ç„¶æˆ‘ä¹Ÿæ˜¯é€šè¿‡è¯»redisçš„æºç ï¼Œå­¦ä¹ è·³è¡¨çš„ã€‚è¿˜æœ‰ä¸€ä¸ªæ˜¯Googleå¼€å‘çš„ leveldb ä¹Ÿæ˜¯åŸºäºè·³è¡¨å®ç°çš„ã€‚\næœ€åæ”¾ä¸Šæ‰€æœ‰çš„æºç ï¼Œgithub gitee\nå¦‚æœè¿™ä¸ªæ–‡ç« å¯¹ä½ æœ‰å¸®åŠ©è®°å¾—ç»™æˆ‘ç‚¹ä¸ªstar è°¢è°¢äº†\n","date":"2021-10-17T18:30:19Z","image":"https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/fcc8e8e79ed84bc3a42374e0cac652db.webp","permalink":"https://lqxhub.github.io/posts/4f40161/","title":"4000å­—è¯¦è§£è·³è¡¨å®ç°(æŒ‘æˆ˜å…¨ç½‘ä¸­æ–‡æœ€è¯¦ç»†)"},{"content":" ä»€ä¹ˆæ˜¯æƒŠç¾¤ ç®€å•è¯´ï¼ŒæƒŠç¾¤æ˜¯å› ä¸ºå¤šè¿›ç¨‹ï¼ˆå¤šçº¿ç¨‹ï¼‰åœ¨åŒæ—¶é˜»å¡ç­‰å¾…åŒä¸€ä¸ªäº‹ä»¶çš„æ—¶å€™ï¼ˆä¼‘çœ çŠ¶æ€ï¼‰ï¼Œå½“äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œå°±ä¼šå”¤é†’æ‰€æœ‰ç­‰å¾…çš„ï¼ˆä¼‘çœ çš„ï¼‰è¿›ç¨‹ï¼ˆçº¿ç¨‹ï¼‰ã€‚ä½†æ˜¯äº‹ä»¶åªèƒ½è¢«ä¸€ä¸ªè¿›ç¨‹æˆ–çº¿ç¨‹å¤„ç†ï¼Œè€Œå…¶ä»–è¿›ç¨‹ï¼ˆçº¿ç¨‹ï¼‰è·å–å¤±è´¥ï¼Œåªèƒ½é‡æ–°è¿›å…¥ä¼‘çœ çŠ¶æ€ï¼Œè¿™ç§ç°è±¡å’Œæ€§èƒ½æµªè´¹å°±å«åšæƒŠç¾¤ã€‚ç»´åŸºç™¾ç§‘-æƒŠç¾¤\näº§ç”ŸæƒŠç¾¤çš„æ¡ä»¶ å¤šä¸ªè¿›ç¨‹æˆ–è€…å¤šä¸ªçº¿ç¨‹ åŒæ—¶ç­‰å¾…å¤„ç†ä¸€ä¸ªäº‹ä»¶ å…·ä½“åœºæ™¯å¤ç° æµ‹è¯•ç¯å¢ƒ :\ndebian11 å†…æ ¸5.10.0-8 ç¼–è¯‘å™¨ clang11 å¤šçº¿ç¨‹å’Œå¤šè¿›ç¨‹åœ¨æƒŠç¾¤é—®é¢˜ä¸Šå·®ä¸å¤šï¼Œä¸ºäº†å°‘äº›ä¸€ç‚¹ï¼Œä¸‹æ–‡ä¸­æ²¡æœ‰ç‰¹æ®Šè¯´æ˜ï¼Œå¤šçº¿ç¨‹ ä¹ŸåŒ…å«äº†å¤šè¿›ç¨‹\nåœ¨linuxä¸­ï¼Œä½¿ç”¨C/C++ ç¼–å†™ tcp serveræ—¶ï¼Œä¼šä¾æ¬¡è°ƒç”¨ socket() bind() listen() accept() è¿™å‡ ä¸ªå‡½æ•°ï¼Œè¿™å‡ ä¸ªå‡½æ•°ä¼šæ‰“å¼€socketï¼Œç»‘å®šipå’Œç«¯å£ï¼Œå¼€å§‹ç›‘å¬ç«¯å£ï¼Œacceptå‡½æ•°ä¼šé˜»å¡å½“å‰è¿›ç¨‹ï¼Œç­‰å¾…å®¢æˆ·ç«¯è¿æ¥ã€‚\nå¦‚æœåœ¨å•çº¿ç¨‹ä¸­ï¼Œåªæœ‰ä¸€ä¸ªacceptå‡½æ•°åœ¨ç­‰å¾…å®¢æˆ·ç«¯è¿æ¥ï¼Œå½“å®¢æˆ·ç«¯æ¥è¿æ¥çš„æ—¶å€™ï¼Œåªä¼šæœ‰ä¸€ä¸ªacceptå‡½æ•°æ¥å¤„ç†ï¼Œæ‰€ä»¥ä¹Ÿä¸ä¼šå­˜åœ¨æƒŠç¾¤é—®é¢˜äº†ã€‚\nåœ¨å¤šçº¿æ¨¡å‹ä¸­ï¼Œå¤šä¸ªçº¿ç¨‹åˆ†åˆ«acceptåŒä¸€ä¸ªsocketï¼Œå½“æœ‰å®¢æˆ·ç«¯è¿æ¥æ—¶ï¼Œå†…æ ¸ä¼šé€šçŸ¥æ‰€æœ‰çš„çº¿ç¨‹æ¥å¤„ç†è¿™ä¸ªè¯·æ±‚ï¼Œä½†æ˜¯å‘¢ï¼Œè¯·æ±‚åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹å¤„ç†ï¼Œå…¶ä»–çš„çº¿ç¨‹çš„ä¸åˆ°è¿™ä¸ªäº‹ä»¶ï¼Œåªèƒ½ç™½ç™½è¢«å”¤é†’ã€‚\nè¿™æ˜¯æœ€ç®€å•çš„ä¸€ç§æƒŠç¾¤ï¼Œè¿™ç§æƒ…å†µåœ¨linux2.6ä»¥åå°±ä¸ä¼šäº§ç”Ÿäº†ã€‚å› ä¸ºåœ¨Linux 2.6 ç‰ˆæœ¬ä¹‹åï¼Œé€šè¿‡å¼•å…¥ä¸€ä¸ªæ ‡è®°ä½ WQ_FLAG_EXCLUSIVEï¼Œè§£å†³æ‰äº† Accept æƒŠç¾¤æ•ˆåº”ã€‚æˆ‘åŸæœ¬è¿˜æƒ³åœ¨centos3.9ï¼ˆå†…æ ¸ç‰ˆæœ¬æ˜¯2.5ï¼‰ä¸­å»å¤ç°è¿™ç§æƒ…å†µï¼Œä½†æ˜¯æŠ˜è…¾äº†å¥½ä¹…ï¼Œä¹Ÿæ²¡èƒ½åœ¨centosä¸Šç¼–è¯‘ä¹Ÿè¿è¡ŒC++ç¨‹åºï¼Œé‚æ”¾å¼ƒã€‚ ä¸åºŸè¯äº†ï¼Œä¸Šä»£ç ï¼Œæµ‹è¯•ç¬¬ä¸€ç§æƒ…å†µ\n1#include \u0026lt;netinet/in.h\u0026gt; 2#include \u0026lt;iostream\u0026gt; 3#include \u0026lt;sys/epoll.h\u0026gt; 4#include \u0026lt;iostream\u0026gt; 5#include \u0026lt;thread\u0026gt; 6#include \u0026lt;mutex\u0026gt; 7#include \u0026lt;condition_variable\u0026gt; 8 9#define WORKER_THREAD 4 10//åˆ›å»ºsocketï¼Œå¹¶è¿”å›fd 11int createSocket() { 12 int fd = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP); 13 if (fd \u0026lt; 0) { 14 std::cout \u0026lt;\u0026lt; \u0026#34;create socket error\u0026#34; \u0026lt;\u0026lt; std::endl; 15 return 0; 16 } 17 18 sockaddr_in sockAddr{}; 19 sockAddr.sin_port = htons(PORT); 20 sockAddr.sin_family = AF_INET; 21 sockAddr.sin_addr.s_addr = htons(INADDR_ANY); 22 23 if (bind(fd, (sockaddr *) \u0026amp;sockAddr, sizeof(sockAddr)) \u0026lt; 0) { 24 std::cout \u0026lt;\u0026lt; \u0026#34;bind socket error, port:\u0026#34; \u0026lt;\u0026lt; PORT \u0026lt;\u0026lt; std::endl; 25 return 0; 26 } 27 28 if (listen(fd, 100) \u0026lt; 0) { 29 std::cout \u0026lt;\u0026lt; \u0026#34;listen port error\u0026#34; \u0026lt;\u0026lt; std::endl; 30 return 0; 31 } 32 return fd; 33} 34 35void Worker1(int socketFd, int k) { 36 std::cout \u0026lt;\u0026lt; \u0026#34; Worker\u0026#34; \u0026lt;\u0026lt; k \u0026lt;\u0026lt; \u0026#34; run \u0026#34; \u0026lt;\u0026lt; std::endl; 37 while (true) { 38 int tfd = 0; 39 sockaddr_in cli_addr{}; 40 socklen_t length = sizeof(cli_addr); 41 tfd = accept(socketFd, (sockaddr *) \u0026amp;cli_addr, \u0026amp;length); 42 std::cout \u0026lt;\u0026lt; \u0026#34;worker\u0026#34; \u0026lt;\u0026lt; k \u0026lt;\u0026lt; \u0026#34; in \u0026#34; \u0026lt;\u0026lt; std::endl; 43 if (tfd \u0026lt;= 0) { 44 std::cout \u0026lt;\u0026lt; \u0026#34;accept error\u0026#34; \u0026lt;\u0026lt; std::endl; 45 return; 46 } else { 47 std::cout \u0026lt;\u0026lt; \u0026#34;worker\u0026#34; \u0026lt;\u0026lt; k \u0026lt;\u0026lt; \u0026#34; accept \u0026#34; \u0026lt;\u0026lt; std::endl; 48 } 49 } 50} 51 52int main() { 53 std::mutex mutex; 54 std::unique_lock\u0026lt;std::mutex\u0026gt; lck(mutex); 55 std::condition_variable cv; 56 57 int fd = createSocket(); 58 //ç¬¬ä¸€ç§,å¤šä¸ªçº¿ç¨‹ä¸ä½¿ç”¨å¤šè·¯å¤ç”¨,acceptåŒä¸€ä¸ªsocket 59 for (int i = 0; i \u0026lt; WORKER_THREAD; ++i) { 60 std::thread th(\u0026amp;Worker1, fd, i + 1); 61 th.detach(); 62 } 63 64 cv.wait(lck); 65 return 0; 66} è¿™ä»£ç å¯ä»¥ç”¨Cå†™ï¼Œä½†æ˜¯ä¹ æƒ¯ç”¨C++äº†ï¼Œå°±ç”¨C++å†™å§ã€‚ä»£ç ä¹Ÿæ¯”è¾ƒç®€å•ï¼ŒcreateSocket()åˆ›å»ºäº†ä¸€ä¸ªsocketï¼Œç„¶å4ä¸ªçº¿ç¨‹åˆ†åˆ«å»acceptè¿™ä¸ªsocketã€‚ ä¸‹é¢æ˜¯è¿è¡Œç»“æœï¼š å¯ä»¥çœ‹åˆ°ï¼Œ4ä¸ªçº¿ç¨‹éƒ½åœ¨è¿è¡Œï¼Œå¹¶ä¸”acceptï¼Œä½†æ˜¯å½“è¿æ¥æ¥çš„æ—¶å€™ï¼Œåªæœ‰ä¸ªçº¿ç¨‹èƒ½å¾—åˆ°äº‹ä»¶ã€‚\næ—¢ç„¶linuxå†…æ ¸å·²ç»å¸®æˆ‘ä»¬å¤„ç†äº†æƒŠç¾¤ï¼Œé‚£æˆ‘ä»¬è¿˜è€ƒè™‘è¿™äº›å¹²å•¥ï¼Œç›´æ¥ç”¨ä¸å°±å®Œäº†ã€‚\nä½†æ˜¯ï¼Œæˆ‘ä»¬åœ¨å†™ä»£ç çš„æ—¶å€™ä¸€èˆ¬ä¸ä¼šç›´æ¥é˜»å¡acceptçš„ï¼Œéƒ½æ˜¯ä½¿ç”¨å¤šè·¯å¤ç”¨æ¥å¸®æˆ‘ä»¬å¤„ç†è¿æ¥é˜»å¡çš„æ˜¯å¤šè·¯å¤ç”¨å‡½æ•°ã€‚ç›®å‰ç»¼åˆæ€§èƒ½æ¯”è¾ƒå¥½çš„IOå¤šè·¯å¤ç”¨æ˜¯epollã€‚å½“åœ¨å¤šçº¿ç¨‹ä¸­ä½¿ç”¨epollæ—¶ï¼ŒæƒŠç¾¤é—®é¢˜å°±ä¼šå‡ºç°äº†ã€‚ å…ˆä»£ç å’Œç»“æœï¼Œç„¶åå†è§£é‡Š\n1#include \u0026lt;netinet/in.h\u0026gt; 2#include \u0026lt;iostream\u0026gt; 3#include \u0026lt;sys/epoll.h\u0026gt; 4#include \u0026lt;iostream\u0026gt; 5#include \u0026lt;thread\u0026gt; 6#include \u0026lt;mutex\u0026gt; 7#include \u0026lt;condition_variable\u0026gt; 8 9#define WORKER_THREAD 4 10//åˆ›å»ºsocketï¼Œå¹¶è¿”å›fd 11int createSocket() { 12 int fd = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP); 13 if (fd \u0026lt; 0) { 14 std::cout \u0026lt;\u0026lt; \u0026#34;create socket error\u0026#34; \u0026lt;\u0026lt; std::endl; 15 return 0; 16 } 17 18 sockaddr_in sockAddr{}; 19 sockAddr.sin_port = htons(PORT); 20 sockAddr.sin_family = AF_INET; 21 sockAddr.sin_addr.s_addr = htons(INADDR_ANY); 22 23 if (bind(fd, (sockaddr *) \u0026amp;sockAddr, sizeof(sockAddr)) \u0026lt; 0) { 24 std::cout \u0026lt;\u0026lt; \u0026#34;bind socket error, port:\u0026#34; \u0026lt;\u0026lt; PORT \u0026lt;\u0026lt; std::endl; 25 return 0; 26 } 27 28 if (listen(fd, 100) \u0026lt; 0) { 29 std::cout \u0026lt;\u0026lt; \u0026#34;listen port error\u0026#34; \u0026lt;\u0026lt; std::endl; 30 return 0; 31 } 32 return fd; 33} 34 35void Worker2(int socketFd, int k) { 36 std::cout \u0026lt;\u0026lt; \u0026#34; Worker\u0026#34; \u0026lt;\u0026lt; k \u0026lt;\u0026lt; \u0026#34; run \u0026#34; \u0026lt;\u0026lt; std::endl; 37 38 int eFd = epoll_create(1); 39 if (eFd \u0026lt; 0) { 40 std::cout \u0026lt;\u0026lt; \u0026#34;create epoll fail\u0026#34;; 41 return; 42 } 43 epoll_event epev_{}; 44 epev_.events = EPOLLIN; 45 epev_.data.fd = socketFd; 46 epoll_ctl(eFd, EPOLL_CTL_ADD, socketFd, \u0026amp;epev_); 47 epoll_event events[EVENT_NUM]; 48 49 while (true) { 50 int eNum = epoll_wait(eFd, events, EVENT_NUM, -1); 51 if (eNum == -1) { 52 std::cout \u0026lt;\u0026lt; \u0026#34;epoll error\u0026#34;; 53 return; 54 } 55 //ä¸€å®šè¦åŠ ä¸Šè¿™å¥,é˜²æ­¢äº‹ä»¶è¢«ç¬é—´å¤„ç†,å¯¼è‡´çœ‹ä¸åˆ°ç»“æœ 56 std::this_thread::sleep_for((std::chrono::seconds (1))); 57 std::cout \u0026lt;\u0026lt; \u0026#34;worker\u0026#34; \u0026lt;\u0026lt; k \u0026lt;\u0026lt; \u0026#34; in \u0026#34; \u0026lt;\u0026lt; std::endl; 58 for (int i = 0; i \u0026lt; eNum; ++i) { 59 if (events[i].data.fd == socketFd) { 60 int tfd = 0; 61 sockaddr_in cli_addr{}; 62 socklen_t length = sizeof(cli_addr); 63 tfd = accept(socketFd, (sockaddr *) \u0026amp;cli_addr, \u0026amp;length); 64 if (tfd \u0026lt;= 0) { 65 std::cout \u0026lt;\u0026lt; \u0026#34;accept error\u0026#34; \u0026lt;\u0026lt; std::endl; 66 } else { 67 std::cout \u0026lt;\u0026lt; \u0026#34;worker\u0026#34; \u0026lt;\u0026lt; k \u0026lt;\u0026lt; \u0026#34; accept \u0026#34; \u0026lt;\u0026lt; std::endl; 68 } 69 } else { 70 //å¤„ç†æ­£å¸¸çš„socketè¯»å†™äº‹ä»¶,è¿™é‡Œå¯ä»¥å¿½ç•¥,ä¸æ˜¯è¿™æ¬¡å…³æ³¨çš„ç‚¹ 71 } 72 } 73 } 74} 75 76int main() { 77 std::mutex mutex; 78 std::unique_lock\u0026lt;std::mutex\u0026gt; lck(mutex); 79 std::condition_variable cv; 80 int fd = createSocket(); 81 //ç¬¬äºŒç§,å¤šä¸ªçº¿ç¨‹ä½¿ç”¨epollå¤šè·¯å¤ç”¨,acceptåŒä¸€ä¸ªsocket 82 for (int i = 0; i \u0026lt; WORKER_THREAD; ++i) { 83 std::thread th(\u0026amp;Worker2, fd, i + 1); 84 th.detach(); 85 } 86} ç»“æœ è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œå½“æœ‰å®¢æˆ·ç«¯æ¥è¿æ¥çš„æ—¶å€™ï¼Œ4ä¸ªçº¿ç¨‹éƒ½è¢«å”¤é†’äº†ï¼Œä½†æ˜¯åªæœ‰workr2 çº¿ç¨‹æˆåŠŸè·å–äº†äº‹ä»¶ï¼Œå…¶ä½™çš„3ä¸ªçº¿ç¨‹éƒ½ç™½ç™½å”¤é†’æµªè´¹äº†æ€§èƒ½\nä¸ºå•¥å†…æ ¸å·²ç»å¤„ç†äº†ç¬¬ä¸€ç§æƒ…æ™¯ä¸‹çš„æƒŠç¾¤é—®é¢˜ï¼Œç¬¬äºŒç§æƒ…æ™¯ä¸‹çš„æƒŠç¾¤é—®é¢˜ä¸ºå•¥å°±ä¸å¤„ç†äº†å‘¢ï¼Ÿ\næˆ‘çš„çŒœæƒ³ä¸ä¸€å®šæ­£ç¡®ï¼Œå¦‚æœæœ‰é”™è¯¯ï¼Œè¯·æŒ‡å‡ºï¼š\naccept åªèƒ½æ˜¯è¢«ä¸€ä¸ªè¿›ç¨‹è°ƒç”¨æˆåŠŸï¼ˆè¿æ¥äº‹ä»¶åªä¼šå¤„ç†ä¸€æ¬¡å˜›ï¼‰ï¼Œæ‰€ä»¥å†…æ ¸å°±ç›´æ¥å¤„ç†äº†ï¼ˆä¸€ä¸ªacceptåªä¼šå”¤é†’ä¸€ä¸ªè¿›ç¨‹ï¼‰ã€‚ä½† epoll ä¸ä¸€æ ·ï¼Œepollä¸­ç®¡ç†äº†å¾ˆå¤šè¿æ¥ï¼Œä¸æ­¢socketè¿™ä¸€ä¸ªï¼Œé™¤äº†å¯èƒ½åç»­è¢« accept è°ƒç”¨å¤–ï¼Œè¿˜æœ‰å¯èƒ½æ˜¯å…¶ä»–ç½‘ç»œ IO äº‹ä»¶çš„ï¼Œè€Œå…¶ä»– IO äº‹ä»¶æ˜¯å¦åªèƒ½ç”±ä¸€ä¸ªè¿›ç¨‹å¤„ç†ï¼Œæ˜¯ä¸ä¸€å®šçš„ï¼Œè¿™æ˜¯ä¸€ä¸ªç”±ç”¨æˆ·å†³å®šçš„äº‹æƒ…ï¼Œä¾‹å¦‚å¯èƒ½ä¸€ä¸ªæ–‡ä»¶ä¼šç”±å¤šä¸ªè¿›ç¨‹æ¥è¯»å†™ã€‚æ‰€ä»¥ï¼Œå¯¹ epoll é»˜è®¤å¯¹äºå¤šè¿›ç¨‹ç›‘å¬åŒä¸€æ–‡ä»¶ä¸ä¼šè®¾ç½®äº’æ–¥ï¼Œæ‰€ä»¥å°±å¯¼è‡´äº†epollæƒŠç¾¤é—®é¢˜ã€‚\nåœ¨linux4.5å†…æ ¸ä¹‹åç»™epollæ·»åŠ äº†ä¸€ä¸ª EPOLLEXCLUSIVEçš„æ ‡å¿—ä½ï¼Œå¦‚æœè®¾ç½®äº†è¿™ä¸ªæ ‡å¿—ä½ï¼Œé‚£epollå°†è¿›ç¨‹æŒ‚åˆ°ç­‰å¾…é˜Ÿåˆ—æ—¶å°†ä¼šè®¾ç½®ä¸€ä¸‹äº’æ–¥æ ‡å¿—ä½ï¼Œè¿™æ—¶å®ç°è·Ÿå†…æ ¸åŸç”Ÿacceptä¸€æ ·çš„ç‰¹æ€§ï¼Œåªä¼šå”¤é†’é˜Ÿåˆ—ä¸­çš„ä¸€ä¸ªè¿›ç¨‹ã€‚å‚è€ƒèµ„æ–™ æ„Ÿè°¢è¿™ä½å¤§ç¥çš„æ–‡ç« \nä¿®æ”¹ä¸€ä¸‹worker2å‡½æ•°:\n1void Worker2(int socketFd, int k) { 2 std::cout \u0026lt;\u0026lt; \u0026#34; Worker\u0026#34; \u0026lt;\u0026lt; k \u0026lt;\u0026lt; \u0026#34; run \u0026#34; \u0026lt;\u0026lt; std::endl; 3 4 int eFd = epoll_create(1); 5 if (eFd \u0026lt; 0) { 6 std::cout \u0026lt;\u0026lt; \u0026#34;create epoll fail\u0026#34;; 7 return; 8 } 9 epoll_event epev_{}; 10 //ç»™epollåŠ ä¸Š äº’æ–¥æ ‡å¿— 11 epev_.events = EPOLLIN | EPOLLEXCLUSIVE; 12 epev_.data.fd = socketFd; 13 epoll_ctl(eFd, EPOLL_CTL_ADD, socketFd, \u0026amp;epev_); 14 epoll_event events[EVENT_NUM]; 15 16 while (true) { 17 int eNum = epoll_wait(eFd, events, EVENT_NUM, -1); 18 if (eNum == -1) { 19 std::cout \u0026lt;\u0026lt; \u0026#34;epoll error\u0026#34;; 20 return; 21 } 22 //ä¸€å®šè¦åŠ ä¸Šè¿™å¥,é˜²æ­¢äº‹ä»¶è¢«ç¬é—´å¤„ç†,å¯¼è‡´çœ‹ä¸åˆ°ç»“æœ 23 std::this_thread::sleep_for((std::chrono::seconds(1))); 24 std::cout \u0026lt;\u0026lt; \u0026#34;worker\u0026#34; \u0026lt;\u0026lt; k \u0026lt;\u0026lt; \u0026#34; in \u0026#34; \u0026lt;\u0026lt; std::endl; 25 for (int i = 0; i \u0026lt; eNum; ++i) { 26 if (events[i].data.fd == socketFd) { 27 int tfd = 0; 28 sockaddr_in cli_addr{}; 29 socklen_t length = sizeof(cli_addr); 30 tfd = accept(socketFd, (sockaddr *) \u0026amp;cli_addr, \u0026amp;length); 31 if (tfd \u0026lt;= 0) { 32 std::cout \u0026lt;\u0026lt; \u0026#34;accept error\u0026#34; \u0026lt;\u0026lt; std::endl; 33 } else { 34 std::cout \u0026lt;\u0026lt; \u0026#34;worker\u0026#34; \u0026lt;\u0026lt; k \u0026lt;\u0026lt; \u0026#34; accept \u0026#34; \u0026lt;\u0026lt; std::endl; 35 } 36 } else { 37 //å¤„ç†æ­£å¸¸çš„socketè¯»å†™äº‹ä»¶,è¿™é‡Œå¯ä»¥å¿½ç•¥,ä¸æ˜¯è¿™æ¬¡å…³æ³¨çš„ç‚¹ 38 } 39 } 40 } 41} ç°åœ¨æ¥æµ‹è¯•ä¸€ä¸‹ ç°åœ¨çš„epollå·²ç»ä¸ä¼šæœ‰æƒŠç¾¤é—®é¢˜äº†\nå¦ä¸€ç§æ–¹å¼ å…¶å®è§£å†³å¤šçº¿ç¨‹ä½¿ç”¨epollç­‰å¤šè·¯å¤ç”¨å¯¼è‡´çš„æƒŠç¾¤é—®é¢˜ï¼Œè¿˜æœ‰ä¸€ä¸ªæ›´å½»åº•è§£å†³æ–¹æ³•ï¼Œè®©æ¯ä¸ªçº¿ç¨‹åˆ†åˆ«æ‰“å¼€ä¸€ä¸ªsocketï¼Œå¹¶ä¸”è¿™äº›socketç»‘å®šåœ¨åŒä¸€ä¸ªç«¯å£ï¼Œç„¶åacceptè¿™ä¸ªsocketã€‚è¿™å°±åƒç¬¬ä¸€ç§æƒ…æ™¯é‚£æ ·ï¼Œå†…æ ¸ç›´æ¥å¸®æˆ‘ä»¬åšäº†æƒŠç¾¤å¤„ç†ã€‚è¿™é‡Œä¼šä½¿ç”¨åˆ° linux 3.9å socketæä¾›SO_REUSEPORTæ ‡å¿—ã€‚ä½¿ç”¨è¿™ä¸ªæ ‡å¿—åï¼Œä¼šå…è®¸å¤šä¸ªsocketç»‘å®šå’Œç›‘å¬åŒä¸€ä¸ªç«¯å£ã€‚ ä»£ç å¦‚ä¸‹\n1#include \u0026lt;netinet/in.h\u0026gt; 2#include \u0026lt;iostream\u0026gt; 3#include \u0026lt;sys/epoll.h\u0026gt; 4#include \u0026lt;iostream\u0026gt; 5#include \u0026lt;thread\u0026gt; 6#include \u0026lt;mutex\u0026gt; 7#include \u0026lt;condition_variable\u0026gt; 8 9#define WORKER_THREAD 4 10//åˆ›å»ºsocketï¼Œå¹¶è¿”å›fd 11int createSocket2() { 12 int fd = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP); 13 if (fd == -1) { 14 std::cout \u0026lt;\u0026lt; \u0026#34;create socket error\u0026#34; \u0026lt;\u0026lt; std::endl; 15 return 0; 16 } 17 18 int on = 1; 19 if (setsockopt(fd, SOL_SOCKET, SO_REUSEPORT, (const void *) \u0026amp;on, sizeof(on)) \u0026lt; 0) { 20 std::cout \u0026lt;\u0026lt; \u0026#34;set opt error, ret:\u0026#34; \u0026lt;\u0026lt; std::endl; 21 } 22 23 sockaddr_in sockAddr{}; 24 sockAddr.sin_port = htons(PORT); 25 sockAddr.sin_family = AF_INET; 26 sockAddr.sin_addr.s_addr = htons(INADDR_ANY); 27 28 if (bind(fd, (sockaddr *) \u0026amp;sockAddr, sizeof(sockAddr)) \u0026lt; 0) { 29 std::cout \u0026lt;\u0026lt; \u0026#34;bind socket error, port:\u0026#34; \u0026lt;\u0026lt; PORT \u0026lt;\u0026lt; std::endl; 30 return 0; 31 } 32 33 if (listen(fd, 100) \u0026lt; 0) { 34 std::cout \u0026lt;\u0026lt; \u0026#34;listen port error\u0026#34; \u0026lt;\u0026lt; std::endl; 35 return 0; 36 } 37 return fd; 38} 39 40void Worker3(int k) { 41 std::cout \u0026lt;\u0026lt; \u0026#34; Worker\u0026#34; \u0026lt;\u0026lt; k \u0026lt;\u0026lt; \u0026#34; run \u0026#34; \u0026lt;\u0026lt; std::endl; 42 43 int socketFd = createSocket2(); 44 int eFd = epoll_create(1); 45 if (eFd == -1) { 46 std::cout \u0026lt;\u0026lt; \u0026#34;create epoll fail\u0026#34; \u0026lt;\u0026lt; std::endl; 47 return; 48 } 49 50 epoll_event epev_{}; 51 epev_.events = EPOLLIN; 52 epev_.data.fd = socketFd; 53 epoll_ctl(eFd, EPOLL_CTL_ADD, socketFd, \u0026amp;epev_); 54 epoll_event events[EVENT_NUM]; 55 56 while (true) { 57 int eNum = epoll_wait(eFd, events, EVENT_NUM, -1); 58 if (eNum == -1) { 59 std::cout \u0026lt;\u0026lt; \u0026#34;epoll error\u0026#34; \u0026lt;\u0026lt; std::endl; 60 return; 61 } 62 std::this_thread::sleep_for((std::chrono::seconds(1))); 63 std::cout \u0026lt;\u0026lt; \u0026#34;worker\u0026#34; \u0026lt;\u0026lt; k \u0026lt;\u0026lt; \u0026#34; in \u0026#34; \u0026lt;\u0026lt; std::endl; 64 for (int i = 0; i \u0026lt; eNum; ++i) { 65 if (events[i].data.fd == socketFd) { 66 int tfd = 0; 67 sockaddr_in cli_addr{}; 68 socklen_t length = sizeof(cli_addr); 69 tfd = accept(socketFd, (sockaddr *) \u0026amp;cli_addr, \u0026amp;length); 70 if (tfd \u0026lt;= 0) { 71 std::cout \u0026lt;\u0026lt; \u0026#34;accept error\u0026#34; \u0026lt;\u0026lt; std::endl; 72 } else { 73 std::cout \u0026lt;\u0026lt; \u0026#34;worker\u0026#34; \u0026lt;\u0026lt; k \u0026lt;\u0026lt; \u0026#34; accept \u0026#34; \u0026lt;\u0026lt; std::endl; 74 } 75 } else { 76 //å¤„ç†æ­£å¸¸çš„socketè¯»å†™äº‹ä»¶ 77 } 78 } 79 } 80} 81 82int main() { 83 std::mutex mutex; 84 std::unique_lock\u0026lt;std::mutex\u0026gt; lck(mutex); 85 std::condition_variable cv; 86 87 //ç¬¬ä¸‰ç§,å¤šä¸ªçº¿ç¨‹ä½¿ç”¨epollå¤šè·¯å¤ç”¨,æ¯ä¸ªçº¿ç¨‹åˆ†åˆ«bind,listen åŒä¸€ä¸ªç«¯å£, acceptå„è‡ªçš„socket 88 for (int i = 0; i \u0026lt; WORKER_THREAD; ++i) { 89 std::thread th(\u0026amp;Worker3, i + 1); 90 th.detach(); 91 } 92 93 cv.wait(lck); 94 return 0; 95} ç»“æœ ä¹Ÿæ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œå¤šä¸ªè¿æ¥æ¥çš„æ—¶å€™ï¼Œåªä¼šæœ‰ä¸€ä¸ªçº¿ç¨‹è¢«å”¤é†’ï¼Œç›¸å½“äºåœ¨å†…æ ¸çº§åˆ«ä¸­å®ç°äº†ä¸€ä¸ªè´Ÿè½½å‡è¡¡\næ€»ç»“ ç®€å•æ€»ç»“ä¸€ä¸‹ï¼Œå½“å¤šä¸ªçº¿ç¨‹æˆ–è€…è¿›ç¨‹åŒæ—¶é˜»å¡åŒä¸€ä¸ªäº‹ä»¶çš„æ—¶å€™ï¼Œä¼šå‡ºç°æƒŠç¾¤ç°è±¡ï¼Œå¦‚æœä¸é€‚ç”¨epollç­‰å¤šè·¯å¤ç”¨æŠ€æœ¯ï¼Œåœ¨linux2.6 ä»¥åå†…æ ¸å·²ç»å¸®æˆ‘ä»¬å¤„ç†äº†æƒŠç¾¤é—®é¢˜ã€‚\nå¦‚æœä½¿ç”¨äº†epollï¼Œå°±éœ€è¦é¢å¤–å¤„ç†epollå¯¼è‡´çš„æƒŠç¾¤é—®é¢˜ï¼Œæœ‰ä¸¤ç§æ–¹å¼\nlinux4.5å†…æ ¸ä¹‹åï¼Œepollæœ‰ä¸€ä¸ªEPOLLEXCLUSIVEç‰¹æ€§ï¼Œå¯ä»¥é˜²æ­¢epollæƒŠç¾¤å‡ºç° linux 3.9å†…æ ¸ä¹‹åç»™ socket æä¾›SO_REUSEPORTç‰¹æ€§ï¼Œå¯ä»¥å…è®¸å¤šä¸ªsocketç»‘å®šåœ¨åŒä¸€ä¸ªç«¯å£ä¸Šï¼Œç›¸å½“äºæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªsocketï¼Œåœ¨å¤„ç†acceptæ—¶ï¼Œå†…æ ¸ä¼šè‡ªåŠ¨å¤„ç†æƒŠç¾¤é—®é¢˜ 1å’Œ2ä¸¤ç§æ–¹å¼éƒ½èƒ½æœ‰æ•ˆè§£å†³æƒŠç¾¤é—®é¢˜ï¼Œä½†æ˜¯ç›®å‰ä½¿ç”¨ socketçš„ SO_REUSEPORT æ˜¯æœ€å¥½çš„æ–¹å¼.ã€‚\næˆ‘é€šè¿‡æŸ¥èµ„æ–™å¾—åˆ° EPOLLEXCLUSIVE æ ‡è¯†ä¼šä¿è¯ä¸€ä¸ªäº‹ä»¶å‘ç”Ÿæ—¶å€™åªæœ‰ä¸€ä¸ªçº¿ç¨‹ä¼šè¢«å”¤é†’ï¼Œæ¥é¿å…å¤šæƒŠç¾¤é—®é¢˜ã€‚ä¸è¿‡ä»»ä¸€æ—¶å€™åªèƒ½æœ‰ä¸€ä¸ªWorkerè°ƒç”¨ acceptï¼Œé™åˆ¶äº†çœŸæ­£å¹¶è¡Œçš„ååé‡ã€‚ è¿™ä¸ªæœ‰å¾…éªŒè¯ï¼Œç­‰æˆ‘æœ‰æ—¶é—´å†å»æ·±å…¥äº†è§£ä¸€ä¸‹ã€‚\næµ‹è¯•demo\n","date":"2021-08-22T00:10:33Z","permalink":"https://lqxhub.github.io/posts/4926d2f3/","title":"linux å¤šçº¿ç¨‹æˆ–å¤šè¿›ç¨‹ epollå¤„ç† accept å¯¼è‡´æƒŠç¾¤"},{"content":"linuxç³»ç»Ÿä¸­ï¼Œå®ç°socketå¤šè·¯å¤ç”¨çš„æŠ€æœ¯æœ‰select ã€poll ã€epoll ç­‰å¤šç§æ–¹å¼ã€‚è¿™äº›ä¸åŒæ–¹å¼ä¸ªæœ‰ä¼˜ç¼ºç‚¹å’Œé€‚ç”¨åœºæ™¯ï¼Œè¿™ä¸æ˜¯æœ¬æ–‡è®¨è®ºçš„é‡ç‚¹ï¼Œåˆå…´è¶£çš„å¯ä»¥è‡ªå·±æœç´¢å­¦ä¹ ä¸€ä¸‹ã€‚ä½†æ˜¯åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œ epoll æ€§èƒ½æ˜¯æœ€é«˜çš„ï¼Œ Nginx éƒ½å¬è¯´è¿‡å§ï¼Œå¤§åé¼é¼çš„Nginx åº•å±‚ç”¨çš„å°±æ˜¯ epollã€‚\nè¿™ç¯‡æ–‡ç« ä¸»è¦æ˜¯å†™æ€ä¹ˆç”¨ epollï¼Œè€Œä¸æ˜¯åŸç†åˆ†æã€‚è¿™ç¯‡æ–‡ç« ä¸æ˜¯æœ€å…¨çš„ï¼Œä¹Ÿä¸æ˜¯æœ€æ·±å…¥çš„ï¼Œä½†æ˜¯ç»å¯¹æ˜¯ä¸€ç¯‡èƒ½è®©æ™®é€šäººçœ‹æ‡‚çš„ï¼Œçœ‹å®Œèƒ½è‡ªå·±ç”¨epollå†™å‡ºä¸€ä¸ªtcpserverçš„æ–‡ç« ã€‚å…¨åºŸè¯ä¸å¤šè¯´ï¼Œç›´æ¥å¼€å§‹æ\né¦–å…ˆæ˜ç¡®ä¸€ç‚¹ï¼Œepoll æ˜¯linuxç³»ç»Ÿæä¾›çš„ç³»ç»Ÿè°ƒç”¨ï¼Œä¹Ÿå°±è¯´ï¼Œepoll åœ¨Windowsç³»ç»Ÿä¸Šæ˜¯æ²¡æ³•ä½¿ç”¨çš„ï¼Œç›¸åº”çš„ä»£ç ä¹Ÿæ˜¯æ²¡æ³•ç¼–è¯‘çš„ã€‚å¦‚æœæœ‰äººçŸ¥é“æ€ä¹ˆåœ¨Windowsä¸­ç¼–è¯‘ï¼Œè¯·èµæ•™ã€‚\nå·¥å…· æ–‡ä¸­ä½¿ç”¨çš„å¼€å‘ç¯å¢ƒ\nç³»ç»Ÿ: Debian GNU/Linux 10 (buster) linuxå†…æ ¸: 4.19.0-14 gccç‰ˆæœ¬: 8.3.0 å‡†å¤‡çŸ¥è¯† epollæ˜¯linuxå†…æ ¸æä¾›çš„åŠŸèƒ½ï¼Œè¿™ä¸ªåŠŸèƒ½å¯¹å¤–æä¾›ç³»ç»Ÿè°ƒç”¨ï¼Œåœ¨C/C++ä¸­é€šè¿‡ä¸‰ä¸ªå‡½æ•°å¯¹ç”¨æˆ·æä¾›åŠŸèƒ½\nepoll_create(int __size) åˆ›å»ºä¸€ä¸ªepollï¼Œ_size å‚æ•°åœ¨linux2.6å†…æ ¸ä¹‹åå°±æ²¡æœ‰ä»€ä¹ˆä½œç”¨äº†, ä½†æ˜¯è¦\u0026gt;0ï¼Œä¸€èˆ¬ç›´æ¥å¡« 1 å°±å¥½äº†ã€‚å‡½æ•°è¿”å›åˆ›å»ºçš„epollçš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå¦‚æœåˆ›å»ºå¤±è´¥ï¼Œä¼šè¿”å› -1ã€‚\nepoll_ctl(nt __epfd, int __op, int __fd,struct epoll_event *__event) æ“ä½œå·²æœ‰çš„epoll,epfdepollçš„æ–‡ä»¶æè¿°ç¬¦ï¼›opæ“ä½œæ–¹å¼ï¼Œæœ‰æ·»åŠ ã€åˆ é™¤ã€ä¿®æ”¹ç­‰ç­‰ï¼›_fd è¦æ“ä½œå¯¹è±¡çš„æè¿°ç¬¦ï¼Œå¦‚æœæ˜¯æ“ä½œtcpè¿æ¥ï¼Œä¹Ÿä¼šå°±æ˜¯è¿™ä¸ªè¿æ¥çš„æè¿°ç¬¦ã€‚_event epoll çš„å“åº”äº‹ä»¶ï¼Œå½“epollç®¡ç†çš„tcpè¿æ¥æœ‰äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œä¼šé€šè¿‡ _event è¿™ä¸ªå¯¹è±¡ä¼ é€’å‡ºæ¥ï¼Œæ‰€ä»¥åœ¨æ·»åŠ è¿æ¥æ—¶ï¼Œè¦æŠŠè¿™ä¸ªè¿æ¥åŒ…è£…æˆä¸€ä¸ª epoll_event å¯¹è±¡ op ç±»å‹ EPOLL_CTL_ADD æ·»åŠ ä¸€ä¸ªæè¿°ç¬¦ EPOLL_CTL_DEL åˆ é™¤ä¸€ä¸ªæè¿°ç¬¦ EPOLL_CTL_MOD ä¿®æ”¹ä¸€ä¸ªæè¿°ç¬¦ epoll_wait(int __epfd, struct epoll_event *__events,int __maxevents, int __timeout) å½“epollç®¡ç†çš„è¿æ¥ä¸­æœ‰å“åº”äº‹ä»¶å‘ç”Ÿæ—¶,ä¼šå›è°ƒè¿™ä¸ªå‡½æ•°ã€‚epfdepollçš„æ–‡ä»¶æè¿°ç¬¦ï¼›__events å¯ä»¥æ“ä½œçš„è¿æ¥æ•°ç»„ï¼›__maxevents ä¸€ä¸ªå¯ä»¥å¤„ç†çš„æœ€å¤§äº‹ä»¶æ•°é‡ï¼›__timeout è¶…æ—¶æ—¶é—´ï¼ˆå•ä½æ¯«ç§’ï¼‰ï¼Œå¦‚æœå¡«-1ï¼Œä¼šç›´åˆ°æœ‰å¯æ“ä½œäº‹ä»¶å‘ç”Ÿæ—¶æ‰ä¼šè¿”å›ï¼Œå› ä¸ºC++ä¸æ”¯æŒå‡½æ•°å¤šè¿”å›å€¼ï¼ŒåƒGoå¯ä»¥ç›´æ¥è¿”å›æ‰€æœ‰äº‹ä»¶å’Œæ•°é‡äº† (â•¥â•¯^â•°â•¥)ã€‚\nevents ä¸­çš„å¸¸ç”¨çš„ç±»å‹ï¼š\nEPOLLIN ï¼šè¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦å¯ä»¥è¯»ï¼ˆSOCKETæ­£å¸¸å…³é—­ï¼‰ EPOLLOUTï¼šè¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦å¯ä»¥å†™ EPOLLPRIï¼šè¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦æœ‰ç´§æ€¥çš„æ•°æ®å¯è¯»ï¼ˆè¡¨ç¤ºæœ‰å¸¦å¤–æ•°æ®åˆ°æ¥ï¼‰ EPOLLERRï¼šè¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦å‘ç”Ÿé”™è¯¯(é»˜è®¤æ³¨å†Œ) EPOLLHUPï¼šè¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦è¢«æŒ‚æ–­(é»˜è®¤æ³¨å†Œ) EPOLLETï¼š å°†EPOLLè®¾ä¸ºè¾¹ç¼˜è§¦å‘(Edge Triggered)æ¨¡å¼ï¼Œè¿™æ˜¯ç›¸å¯¹äºæ°´å¹³è§¦å‘(Level Triggered)æ¥è¯´çš„ EPOLLONESHOTï¼šåªç›‘å¬ä¸€æ¬¡äº‹ä»¶ï¼Œå½“ç›‘å¬å®Œè¿™æ¬¡äº‹ä»¶ä¹‹åï¼Œå¦‚æœè¿˜éœ€è¦ç»§ç»­ç›‘å¬è¿™ä¸ªsocketçš„è¯ï¼Œéœ€è¦å†æ¬¡æŠŠè¿™ä¸ªsocketåŠ å…¥åˆ°EPOLLé˜Ÿåˆ—é‡Œ æ˜¯ä¸æ˜¯å¾ˆæƒŠå¥‡ï¼Œè¿™ä¹ˆç‰›é€¼çš„epollå°±ä¸‰ä¸ªå‡½æ•°ï¼Œç¬¬ä¸€æ¬¡çœ‹åˆ°çš„æ—¶å€™æˆ‘ä¹Ÿè§‰å¾—å¾ˆå¥‡æ€ªï¼Œä¸‰ä¸ªå‡½æ•°å°±èƒ½æå®šé‚£ä¹ˆå¤æ‚çš„äº‹æƒ…ã€‚ä¸è¿‡æƒ³æƒ³ä¹Ÿæ˜¯ï¼ŒæŠŠå¤æ‚çš„ä¸œè¥¿ç®€åŒ–ï¼Œæ‰èƒ½ä½“ç°å‡ºå¤§ç¥çš„å®åŠ› epollçš„ä¸¤ç§æ¨¡å¼ epoll äº‹ä»¶æœ‰ä¸¤ç§æ¨¡å‹ Level Triggered (LT) å’Œ Edge Triggered (ET)ï¼š\nLT(level triggeredï¼Œæ°´å¹³è§¦å‘æ¨¡å¼)æ˜¯é»˜è®¤çš„å·¥ä½œæ–¹å¼ï¼Œå¹¶ä¸”åŒæ—¶æ”¯æŒ block å’Œ non-block socketã€‚åœ¨è¿™ç§åšæ³•ä¸­ï¼Œå†…æ ¸å‘Šè¯‰ä½ ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦æ˜¯å¦å°±ç»ªäº†ï¼Œç„¶åä½ å¯ä»¥å¯¹è¿™ä¸ªå°±ç»ªçš„fdè¿›è¡ŒIOæ“ä½œã€‚å¦‚æœä½ ä¸ä½œä»»ä½•æ“ä½œï¼Œå†…æ ¸è¿˜æ˜¯ä¼šç»§ç»­é€šçŸ¥ä½ çš„ï¼Œæ‰€ä»¥ï¼Œè¿™ç§æ¨¡å¼ç¼–ç¨‹å‡ºé”™è¯¯å¯èƒ½æ€§è¦å°ä¸€ç‚¹ã€‚\nET(edge-triggeredï¼Œè¾¹ç¼˜è§¦å‘æ¨¡å¼)æ˜¯é«˜é€Ÿå·¥ä½œæ–¹å¼ï¼Œåªæ”¯æŒno-block socketã€‚åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œå½“æè¿°ç¬¦ä»æœªå°±ç»ªå˜ä¸ºå°±ç»ªæ—¶ï¼Œå†…æ ¸é€šè¿‡epollå‘Šè¯‰ä½ ã€‚ç„¶åå®ƒä¼šå‡è®¾ä½ çŸ¥é“æ–‡ä»¶æè¿°ç¬¦å·²ç»å°±ç»ªï¼Œå¹¶ä¸”ä¸ä¼šå†ä¸ºé‚£ä¸ªæ–‡ä»¶æè¿°ç¬¦å‘é€æ›´å¤šçš„å°±ç»ªé€šçŸ¥ï¼Œç­‰åˆ°ä¸‹æ¬¡æœ‰æ–°çš„æ•°æ®è¿›æ¥çš„æ—¶å€™æ‰ä¼šå†æ¬¡å‡ºå‘å°±ç»ªäº‹ä»¶ã€‚\næŠŠsocketè®¾ç½®ä¸ºéé˜»å¡æ¨¡å¼çš„æ–¹æ³•\n1int flags = fcntl(fd, F_GETFL, 0); 2fcntl(fd, F_SETFL, flags | O_NONBLOCK); éœ€è¦çš„å¤´æ–‡ä»¶ #include \u0026lt;fcntl.h\u0026gt;\nepollåŸç† ç®€å•é€šè¿‡ç”»å›¾è§£é‡Šä¸€ä¸‹epollçš„å·¥ä½œåŸç† è¿™é‡Œæ²¡æœ‰æ¶‰åŠå¤ªåº•å±‚çš„ä¸œè¥¿ï¼Œå› ä¸ºå¤ªåº•å±‚çš„æˆ‘ä¹Ÿæ²¡ç ”ç©¶è¿‡ï¼Œä¸æ•¢ä¹±è®²ã€‚çŸ¥ä¹‹ä¸ºçŸ¥ä¹‹ï¼Œä¸çŸ¥ä¸ºä¸çŸ¥ã€‚ epollå¯ä»¥çœ‹åšæ˜¯ä¸€ä¸ªç”±æ“ä½œç³»ç»Ÿæä¾›çš„å®¹å™¨ï¼Œè¿™ä¸ªå®¹å™¨ç®¡ç†äº†ä¸€äº› epoll_event ï¼ˆå›¾ä¸­æˆ‘ç”»æˆå•å‘é“¾è¡¨äº†ï¼Œå®é™…ä¸Šç”¨çš„æ˜¯çº¢é»‘æ ‘ï¼Œå› ä¸ºç”»æ ‘å¤ªéº»çƒ¦äº†ï¼‰ï¼Œè¿™ä¸ªeventæ˜¯æˆ‘ä»¬æ·»åŠ è¿›å»çš„ï¼Œeventä¸­è®¾ç½®äº†è¦å“åº”çš„äº‹ä»¶ç±»å‹ï¼Œå½“epoll æ£€æµ‹åˆ°å…·ä½“çš„ event æœ‰å¯¹åº”çš„äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œä¼šé€šè¿‡epoll_wait() é€šçŸ¥ã€‚\nç®€å•çš„epollå®ç° 1#include \u0026lt;iostream\u0026gt;//æ§åˆ¶å°è¾“å‡º 2#include \u0026lt;sys/socket.h\u0026gt;//åˆ›å»ºsocket 3#include \u0026lt;netinet/in.h\u0026gt;//socket addr 4#include \u0026lt;sys/epoll.h\u0026gt;//epoll 5#include \u0026lt;unistd.h\u0026gt;//closeå‡½æ•° 6#include \u0026lt;fcntl.h\u0026gt;//è®¾ç½®éé˜»å¡ 7 8using namespace std; 9 10int main() { 11 const int EVENTS_SIZE = 20; 12 //è¯»socketçš„æ•°ç»„ 13 char buff[1024]; 14 15 //åˆ›å»ºä¸€ä¸ªtcp socket 16 int socketFd = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP); 17 18 //è®¾ç½®socketç›‘å¬çš„åœ°å€å’Œç«¯å£ 19 sockaddr_in sockAddr{}; 20 sockAddr.sin_port = htons(8088); 21 sockAddr.sin_family = AF_INET; 22 sockAddr.sin_addr.s_addr = htons(INADDR_ANY); 23 24 //å°†socketå’Œåœ°å€ç»‘å®š 25 if (bind(socketFd, (sockaddr *) \u0026amp;sockAddr, sizeof(sockAddr)) == -1) { 26 cout \u0026lt;\u0026lt; \u0026#34;bind error\u0026#34; \u0026lt;\u0026lt; endl; 27 return -1; 28 } 29 30 //å¼€å§‹ç›‘å¬socket,å½“è°ƒç”¨listenä¹‹å, 31 //è¿›ç¨‹å°±å¯ä»¥è°ƒç”¨acceptæ¥æ¥å—ä¸€ä¸ªå¤–æ¥çš„è¯·æ±‚ 32 //ç¬¬äºŒä¸ªå‚æ•°,è¯·æ±‚é˜Ÿåˆ—çš„é•¿åº¦ 33 if (listen(socketFd, 10) == -1) { 34 cout \u0026lt;\u0026lt; \u0026#34;listen error\u0026#34; \u0026lt;\u0026lt; endl; 35 return -1; 36 } 37 38 //åˆ›å»ºä¸€ä¸ªepoll,sizeå·²ç»ä¸èµ·ä½œç”¨äº†,ä¸€èˆ¬å¡«1å°±å¥½äº† 39 int eFd = epoll_create(1); 40 41 //æŠŠsocketåŒ…è£…æˆä¸€ä¸ªepoll_eventå¯¹è±¡ 42 //å¹¶æ·»åŠ åˆ°epollä¸­ 43 epoll_event epev{}; 44 epev.events = EPOLLIN;//å¯ä»¥å“åº”çš„äº‹ä»¶,è¿™é‡Œåªå“åº”å¯è¯»å°±å¯ä»¥äº† 45 epev.data.fd = socketFd;//socketçš„æ–‡ä»¶æè¿°ç¬¦ 46 epoll_ctl(eFd, EPOLL_CTL_ADD, socketFd, \u0026amp;epev);//æ·»åŠ åˆ°epollä¸­ 47 48 //å›è°ƒäº‹ä»¶çš„æ•°ç»„,å½“epollä¸­æœ‰å“åº”äº‹ä»¶æ—¶,é€šè¿‡è¿™ä¸ªæ•°ç»„è¿”å› 49 epoll_event events[EVENTS_SIZE]; 50 51 //æ•´ä¸ªepoll_wait å¤„ç†éƒ½è¦åœ¨ä¸€ä¸ªæ­»å¾ªç¯ä¸­å¤„ç† 52 while (true) { 53 //è¿™ä¸ªå‡½æ•°ä¼šé˜»å¡,ç›´åˆ°è¶…æ—¶æˆ–è€…æœ‰å“åº”äº‹ä»¶å‘ç”Ÿ 54 int eNum = epoll_wait(eFd, events, EVENTS_SIZE, -1); 55 56 if (eNum == -1) { 57 cout \u0026lt;\u0026lt; \u0026#34;epoll_wait\u0026#34; \u0026lt;\u0026lt; endl; 58 return -1; 59 } 60 //éå†æ‰€æœ‰çš„äº‹ä»¶ 61 for (int i = 0; i \u0026lt; eNum; i++) { 62 //åˆ¤æ–­è¿™æ¬¡æ˜¯ä¸æ˜¯socketå¯è¯»(æ˜¯ä¸æ˜¯æœ‰æ–°çš„è¿æ¥) 63 if (events[i].data.fd == socketFd) { 64 if (events[i].events \u0026amp; EPOLLIN) { 65 sockaddr_in cli_addr{}; 66 socklen_t length = sizeof(cli_addr); 67 //æ¥å—æ¥è‡ªsocketè¿æ¥ 68 int fd = accept(socketFd, (sockaddr *) \u0026amp;cli_addr, \u0026amp;length); 69 if (fd \u0026gt; 0) { 70 //è®¾ç½®å“åº”äº‹ä»¶,è®¾ç½®å¯è¯»å’Œè¾¹ç¼˜(ET)æ¨¡å¼ 71 //å¾ˆå¤šäººä¼šæŠŠå¯å†™äº‹ä»¶(EPOLLOUT)ä¹Ÿæ³¨å†Œäº†,åé¢ä¼šè§£é‡Š 72 epev.events = EPOLLIN | EPOLLET; 73 epev.data.fd = fd; 74 //è®¾ç½®è¿æ¥ä¸ºéé˜»å¡æ¨¡å¼ 75 int flags = fcntl(fd, F_GETFL, 0); 76 if (flags \u0026lt; 0) { 77 cout \u0026lt;\u0026lt; \u0026#34;set no block error, fd:\u0026#34; \u0026lt;\u0026lt; fd \u0026lt;\u0026lt; endl; 78 continue; 79 } 80 if (fcntl(fd, F_SETFL, flags | O_NONBLOCK) \u0026lt; 0) { 81 cout \u0026lt;\u0026lt; \u0026#34;set no block error, fd:\u0026#34; \u0026lt;\u0026lt; fd \u0026lt;\u0026lt; endl; 82 continue; 83 } 84 //å°†æ–°çš„è¿æ¥æ·»åŠ åˆ°epollä¸­ 85 epoll_ctl(eFd, EPOLL_CTL_ADD, fd, \u0026amp;epev); 86 cout \u0026lt;\u0026lt; \u0026#34;client on line fd:\u0026#34; \u0026lt;\u0026lt; fd \u0026lt;\u0026lt; endl; 87 } 88 } 89 } else {//ä¸æ˜¯socketçš„å“åº”äº‹ä»¶ 90 91 //åˆ¤æ–­æ˜¯ä¸æ˜¯æ–­å¼€å’Œè¿æ¥å‡ºé”™ 92 //å› ä¸ºè¿æ¥æ–­å¼€å’Œå‡ºé”™æ—¶,ä¹Ÿä¼šå“åº”`EPOLLIN`äº‹ä»¶ 93 if (events[i].events \u0026amp; EPOLLERR || events[i].events \u0026amp; EPOLLHUP) { 94 //å‡ºé”™æ—¶,ä»epollä¸­åˆ é™¤å¯¹åº”çš„è¿æ¥ 95 //ç¬¬ä¸€ä¸ªæ˜¯è¦æ“ä½œçš„epollçš„æè¿°ç¬¦ 96 //å› ä¸ºæ˜¯åˆ é™¤,æ‰€æœ‰eventå‚æ•°å¤©nullå°±å¯ä»¥äº† 97 epoll_ctl(eFd, EPOLL_CTL_DEL, events[i].data.fd, nullptr); 98 cout \u0026lt;\u0026lt; \u0026#34;client out fd:\u0026#34; \u0026lt;\u0026lt; events[i].data.fd \u0026lt;\u0026lt; endl; 99 close(events[i].data.fd); 100 } else if (events[i].events \u0026amp; EPOLLIN) {//å¦‚æœæ˜¯å¯è¯»äº‹ä»¶ 101 102 //å¦‚æœåœ¨windowsä¸­,è¯»socketä¸­çš„æ•°æ®è¦ç”¨recv()å‡½æ•° 103 int len = read(events[i].data.fd, buff, sizeof(buff)); 104 //å¦‚æœè¯»å–æ•°æ®å‡ºé”™,å…³é—­å¹¶ä»epollä¸­åˆ é™¤è¿æ¥ 105 if (len == -1) { 106 epoll_ctl(eFd, EPOLL_CTL_DEL, events[i].data.fd, nullptr); 107 cout \u0026lt;\u0026lt; \u0026#34;client out fd:\u0026#34; \u0026lt;\u0026lt; events[i].data.fd \u0026lt;\u0026lt; endl; 108 close(events[i].data.fd); 109 } else { 110 //æ­£å¸¸è¯»å–,æ‰“å°è¯»åˆ°çš„æ•°æ® 111 cout \u0026lt;\u0026lt; buff \u0026lt;\u0026lt; endl; 112 113 //å‘å®¢æˆ·ç«¯å‘æ•°æ® 114 char a[] = \u0026#34;123456\u0026#34;; 115 //å¦‚æœåœ¨windowsä¸­,å‘socketä¸­å†™æ•°æ®è¦ç”¨send()å‡½æ•° 116 write(events[i].data.fd, a, sizeof(a)); 117 } 118 } 119 } 120 } 121 } 122} å¸¸è§çš„é—®é¢˜å’Œæ³¨æ„äº‹é¡¹åœ¨æ³¨é‡Šä¸­ï¼Œå°±å•è§£é‡Šä¸€ä¸‹æ–°è¿æ¥æ³¨å†Œäº‹ä»¶çš„é—®é¢˜å§ï¼Œå¾ˆå¤šæ–‡ç« ä¸­éƒ½ä¼šæŠŠå¯å†™äº‹ä»¶ä¹Ÿæ³¨å†Œè¿›å»ï¼Œåƒè¿™æ ·\n1sockaddr_in cli_addr{}; 2socklen_t length = sizeof(cli_addr); 3//æ¥å—æ¥è‡ªsocketè¿æ¥ 4int fd = accept(socketFd, (sockaddr *) \u0026amp;cli_addr, \u0026amp;length); 5if (fd \u0026gt; 0) { 6\tepev.events = EPOLLIN | EPOLLET | EPOLLOUT; 7\tepev.data.fd = fd; 8\tepoll_ctl(eFd, EPOLL_CTL_ADD, fd, \u0026amp;epev); 9\tcout \u0026lt;\u0026lt; \u0026#34;client on line fd:\u0026#34; \u0026lt;\u0026lt; fd \u0026lt;\u0026lt; endl; 10} ä½†æ˜¯ç»è¿‡æµ‹è¯•ï¼Œä¸æ³¨å†Œå¯å†™äº‹ä»¶ï¼Œç›´æ¥å¾€socketä¸­å†™ä¹Ÿæ˜¯å¯ä»¥çš„\nç»è¿‡æŸ¥èµ„æ–™å¾—çŸ¥:\nEPOLLIN : å¦‚æœçŠ¶æ€æ”¹å˜äº†(æ¯”å¦‚ ä»æ— åˆ°æœ‰)ï¼Œåªè¦è¾“å…¥ç¼“å†²åŒºå¯è¯»å°±ä¼šè§¦å‘ EPOLLOUT : å¦‚æœçŠ¶æ€æ”¹å˜äº†(æ¯”å¦‚ ä»æ»¡åˆ°ä¸æ»¡)ï¼Œåªè¦è¾“å‡ºç¼“å†²åŒºå¯å†™å°±ä¼šè§¦ å¦‚æœæŠŠå¯å†™ä¹Ÿæ³¨å†Œä¸Šï¼Œä¼šé¢‘ç¹å›è°ƒï¼Œè¿™é‡Œä¼šæœ‰å¾ˆå¤šæ— ç”¨çš„å›è°ƒï¼Œå¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚ æœ‰ä¸€ç§æ€è·¯ï¼Œå½“å‘socketå†™å¤±è´¥åï¼ˆwriteå‡½æ•°è¿”å›å€¼ == -1ï¼‰ï¼Œæ³¨å†Œä¸Š EPOLLOUT å½“å“åº”äº†å¯å†™äº‹ä»¶åï¼Œé‡æ–°å¾€socketä¸­å†™æ•°æ®ï¼Œå†™æˆåŠŸåï¼Œå†å–æ¶ˆæ‰ EPOLLOUTã€‚ è¿™é‡Œå°±ä¸ç»™å‡ºç¤ºä¾‹äº† å®¢æˆ·ç«¯æµ‹è¯• è¿™æ¬¡å…³æ³¨çš„æ˜¯æœåŠ¡ç«¯å®ç°ï¼Œå®¢æˆ·ç«¯å°±ä¸ç”¨C++å†™äº†ï¼Œç”¨Goå†™äº†ä¸€ä¸ªclientï¼ˆæ²¡åˆ«çš„åŸå› ï¼Œåªæ˜¯å› ä¸ºGoå†™èµ·äº†ç®€å•ï¼‰\n1package main 2 3import ( 4\t\u0026#34;fmt\u0026#34; 5\t\u0026#34;net\u0026#34; 6\t\u0026#34;sync\u0026#34; 7\t\u0026#34;time\u0026#34; 8) 9 10const ( 11\tMAX_CONN = 10 12) 13 14func main() { 15\tvar wg sync.WaitGroup 16\twg.Add(1) 17\tfor i := 0; i \u0026lt; MAX_CONN; i++ { 18\tgo Conn(\u0026#34;192.168.199.164:8088\u0026#34;, i) 19\ttime.Sleep(time.Millisecond * 100) 20\t} 21\twg.Wait() 22} 23 24func Conn(addr string, id int) { 25\tconn, err := net.Dial(\u0026#34;tcp\u0026#34;, addr) 26\tif err != nil { 27\tfmt.Println(err) 28\treturn 29\t} 30\tfmt.Println(\u0026#34;connect \u0026#34;, id) 31\tgo func() { 32\tbuf := make([]byte, 1024) 33\tfor { 34\tn, err := conn.Read(buf) 35\tif err != nil { 36\tbreak 37\t} 38\tfmt.Println(id, \u0026#34;read: \u0026#34;, string(buf[:n])) 39\t} 40\t}() 41\ttime.Sleep(time.Second * 1) 42\tfor { 43\t_, err := conn.Write([]byte(\u0026#34;hello\u0026#34;)) 44\tif err != nil { 45\tbreak 46\t} 47\ttime.Sleep(time.Second * 10) 48\t} 49} è¿™åªæ˜¯ä¸€ä¸ªæµ‹è¯•ç”¨çš„ï¼Œå†™çš„å¾ˆç²—ç³™ï¼Œä½†æ˜¯ä¸å½±å“ä½¿ç”¨\næœåŠ¡ç«¯æ‰“å°ä¿¡æ¯ å®¢æˆ·ç«¯æ‰“å°ä¿¡æ¯ æ€»ç»“ epollæ˜¯socketå¤šè·¯å¤ç”¨æŠ€æœ¯çš„ä¸€ç§ï¼Œè¿˜æœ‰selectå’Œpoll epoll åªèƒ½åœ¨linuxä½¿ç”¨(Windowsä¸‹æ€ä¹ˆç”¨æˆ‘æ²¡æ‰¾åˆ°,å¦‚æœè¯´é”™äº†è¯·æŒ‡æ­£) epoll äº‹ä»¶æœ‰ Level Triggered (LT) å’Œ Edge Triggered (ET) ä¸¤ç§æ¨¡å‹ï¼ŒLTæ˜¯é»˜è®¤æ¨¡å¼ï¼ŒETæ˜¯é«˜æ€§èƒ½æ¨¡å¼ å¦å¤–ï¼Œæˆ‘ä½¿ç”¨é¢å‘å¯¹è±¡çš„æ–¹å¼å°è£…äº†ä¸€ä¸ªepollçš„tcpserver ä»£ç æœ‰ç‚¹å¤šï¼Œå°±ä¸è´´åœ¨è¿™äº†ï¼Œå·²ç»ä¸Šä¼  github ç äº‘\næ¬¢è¿ç»™ç‚¹ä¸ªstar ãƒ¾(oâ—•âˆ€â—•)ï¾‰ãƒ¾\n","date":"2021-03-14T13:58:35Z","permalink":"https://lqxhub.github.io/posts/91655bdf/","title":"linuxä¸‹ C++ ä½¿ç”¨ epoll å¤šè·¯å¤ç”¨ å®ç°é«˜æ€§èƒ½çš„tcpserver"},{"content":"go æ˜¯è‡ªå¸¦gcçš„è¯­è¨€ï¼Œä¼šè‡ªåŠ¨ç®¡ç†å†…å­˜ï¼Œä¸ç”¨åƒC/C++é‚£æ ·ï¼Œéœ€è¦ç¨‹åºå‘˜æ‰‹åŠ¨é‡Šæ”¾å†…å­˜ï¼Œä¸ç”¨æ‰‹åŠ¨ç®¡ç†å†…å­˜ï¼Œå°±èƒ½å°‘æ‰å¾ˆå¤šå¤´å‘\ngoçš„GCä¼šè‡ªåŠ¨ç®¡ç†å†…å­˜ï¼Œä½†æ˜¯è¿™ä¸ä»£è¡¨goç¨‹åºå°±ä¸ä¼šå†…å­˜æ³„éœ²äº†ã€‚ goå¸¸è§äº§ç”Ÿå†…å­˜æ³„éœ²çš„åŸå› å°±æ˜¯goroutineæ²¡æœ‰ç»“æŸï¼Œç®€å•è¯´å°±æ˜¯goroutine è¢«é˜»å¡äº†ï¼Œè¿™æ ·å°±ä¼šå¯¼è‡´goroutineå¼•ç”¨çš„å†…å­˜ä¸è¢«GCå›æ”¶ï¼Œä¹Ÿå°±å¯¼è‡´äº†å†…å­˜æ³„éœ²ã€‚ å½“ç„¶äº§ç”Ÿå†…å­˜æ³„éœ²çš„åŸå› è¿˜æœ‰åˆ«çš„ï¼Œåªæ˜¯æš‚æ—¶æˆ‘è¿˜æ²¡æœ‰é‡åˆ°ã€‚ä¸ç®¡ä»€ä¹ˆåŸå› äº§ç”Ÿçš„å†…å­˜æ³„éœ²ï¼Œæœ€ç»ˆéƒ½æ˜¯å› ä¸ºå¼‚å¸¸çš„å¼•ç”¨ï¼Œå¯¼è‡´è¯¥è¢«å›æ”¶çš„å†…å­˜æ²¡æœ‰è¢«gc å›æ”¶æ‰\nèµ·å›  è¯´èµ·goå†…å­˜æ³„éœ²åˆ†æï¼Œè¿˜è¦ä»å¹´å‰çš„ä¸€æ¬¡ç¨‹åºå‹æµ‹è¯´èµ·ã€‚æˆ‘ç”¨ä¸€ä¸ªæµ‹è¯•ç¨‹åºå‹æµ‹æˆ‘ä»¬æ¸¸æˆçš„ä¸€äº›æ•°æ®ï¼Œå¤§çº¦å¼€äº†3000ä¸ªtcpè¿æ¥åˆ°æ¸¸æˆã€‚æ¸¸æˆæ•°æ®æ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯å½“æµ‹è¯•ç»“æŸåï¼Œå‘ç°æ¸¸æˆçš„Gatewayå†…å­˜å ç”¨ä¸€ç›´æ²¡æœ‰ä¸‹é™ã€‚æœ¬èƒ½çš„è®©æˆ‘æƒ³èµ·äº†æ˜¯ä¸æ˜¯å†…å­˜æ³„éœ²äº†ã€‚é©¬ä¸Šç”¨pprofåˆ†æäº†ä¸€ä¸‹å†…å­˜ï¼Œå‘ç°æœç„¶æ˜¯å†…å­˜æ³„éœ²äº†ã€‚\nå› ä¸ºæ—¶å…¬å¸ä»£ç ï¼Œä¸æ–¹ä¾¿æ‹¿å‡ºäº†åˆ†æï¼Œå¤§ä½“è¯´ä¸€ä¸‹åŸå› å§\nGatewayæ˜¯ä¸€ä¸ªè¯»å†™åˆ†ç¦»çš„tcpæœåŠ¡ï¼Œä¹Ÿå°±æ˜¯æ¯ä¸€ä¸ªè¿æ¥éƒ½è¦æœ‰ä¸¤ä¸ªgoroutineï¼Œä¸€ä¸ªè¯»ï¼Œä¸€ä¸ªå†™ã€‚\nä½†æ˜¯å½“tcpè¿æ¥æ–­å¼€æ—¶ï¼Œå› ä¸ºæ—¶åºé—®é¢˜ï¼Œå¯¼è‡´goroutineé˜»å¡äº†ï¼Œä¸€ç›´æ²¡æœ‰ç»“æŸï¼Œå°±æ˜¯å¯¼è‡´äº†ç›¸å…³è”çš„å†…å­˜æ²¡æœ‰é‡Šæ”¾ã€‚\nå› ä¸ºæ—¶å…¬å¸ä»£ç ï¼Œä¸èƒ½éšä¾¿è´´å‡ºæ¥ï¼Œè¿™æ¬¡å°±è‡ªå·±å†™ä¸ªç®€å•çš„demoæ¨¡æ‹Ÿä¸€ä¸‹å§\nå› ä¸ºgo è‡ªå¸¦çš„pprof åªèƒ½å±•ç¤ºæ–‡å­—ï¼Œä¸å¤ªæ˜æ˜¾ï¼Œæ‰€æœ‰å…ˆå®‰è£…ä¸€ä¸ªå¯è§†åŒ–æ’ä»¶ graphviz ä¼ é€é—¨ linuxä¸Šå¯ä»¥ç›´æ¥é€šè¿‡ apt æˆ–è€… yum å®‰è£…å°±è¡Œäº†ã€‚ windowsä¸Šå»ç½‘ç«™ä¸‹ä¸€ä¸ªå°±å¥½äº†ï¼Œæˆ‘ä¸‹è½½ .msi æ ¼å¼çš„å®‰è£…åä¸èƒ½ç”¨ï¼Œé‡æ–°ä¸‹äº†ä¸€ä¸ª å‹ç¼©åŒ…ï¼Œè§£å‹åæŠŠ bin ç›®å½•é…ç½®åˆ°ç¯å¢ƒå˜é‡çš„ path ä¸­å°±å¯ä»¥ä½¿ç”¨äº†\nå¼€å§‹ å†™ä¸€ä¸ªç®€å•çš„demo æ¨¡æ‹Ÿä¸€ä¸‹å†…å­˜æ³„éœ²\n1package main 2 3import ( 4\t\u0026#34;math/rand\u0026#34; 5\t\u0026#34;net/http\u0026#34; 6\t_ \u0026#34;net/http/pprof\u0026#34; 7\t\u0026#34;sync\u0026#34; 8) 9 10func main() { 11\tgo func() { 12\thttp.ListenAndServe(\u0026#34;0.0.0.0:8090\u0026#34;, nil) 13\t}() 14 15\tc := make(chan struct{}) 16\tvar wg sync.WaitGroup 17\twg.Add(1) 18\tfor i := 0; i \u0026lt; 10000; i++ { 19\tgo one(c) 20\t} 21\twg.Wait() 22} 23 24func one(c chan struct{}) { 25\tvar a []int64 26\tfor i := 0; i \u0026lt; 10000; i++ { 27\ta = append(a, rand.Int63()) 28\t} 29\t30\t\u0026lt;-c 31} ç¨‹åºå¾ˆç®€å•ï¼Œåœ¨ for å¾ªç¯ä¸­å¼€å¯ 1000 ä¸ªåç¨‹ï¼Œæ¯ä¸ªåç¨‹ä¸­å¾€åˆ‡ç‰‡ä¸­append 1000ä¸ªæ•°æ®ã€‚ ç”¨ä¸€ä¸ªchannelæ¨¡æ‹Ÿåç¨‹é˜»å¡ï¼Œè¿™æ ·å°±ä¼šå¯¼è‡´goroutineä¸ä¼šç»“æŸã€‚\nä½¿ç”¨goå†å¸¦çš„pprofæŸ¥çœ‹ ä»£ç ä¸­ç›‘å¬äº† 8090 ç«¯å£ï¼Œåœ¨æµè§ˆå™¨ä¸­è¾“å…¥ http://127.0.0.1:8090/debug/pprof/ ä¸‹é¢éƒ½æœ‰è§£é‡Šï¼Œå°±ä¸ç”¨è¯¦ç»†ä»‹ç»äº†ï¼ŒæŒ‘ä¸€ä¸¤ä¸ªè¯´ä¸€ä¸‹\nallocs : ç¨‹åºè¿è¡ŒæœŸé—´ï¼Œæ‰€æœ‰å†…å­˜åˆ†é…çš„æ ·æœ¬ heap : å½“å‰æ´»åŠ¨å¯¹è±¡çš„å†…å­˜åˆ†é…é‡‡æ · guroutine : å½“å‰æ‰€æœ‰åç¨‹çš„å †æ ˆè·Ÿè¸ª å¯ä»¥çœ‹åˆ°ï¼Œå½“å‰çš„ç¨‹åºæ€»å…±æœ‰10005ä¸ªåç¨‹ï¼Œ21æ¬¡å †å†…å­˜åˆ†é…ï¼Œè¯´æ˜æˆ‘ä»¬çš„åç¨‹æ˜¯è¢«é˜»å¡çš„ã€‚\nä½¿ç”¨graphvizæŸ¥çœ‹ åœ¨å‘½ä»¤è¡Œä¸­ï¼Œåœ¨Windowsä¸­å¯ä»¥ä½¿ç”¨ powerShell è¾“å…¥ go tool pprof -http :8081 http://127.0.0.1:8090/debug/pprof/heap\nå¦‚æœè¦åˆ†æCPUå ç”¨ï¼Œä½¿ç”¨\ngo tool pprof -http :8081 http://127.0.0.1:8090/debug/pprof/profile?seconds=120\nä¼šåœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ è¿™å°±æ˜¯å½“å‰ heap é‡‡æ ·å›¾ å¯ä»¥åœ¨ VIEW ä¸­åˆ‡æ¢ä¸åŒçš„æ˜¾ç¤ºæ–¹å¼\nå›¾ä¸­æ–¹å—è¶Šå¤§ä¾¿æ˜¯å ç”¨çš„å†…å­˜è¶Šå¤šï¼Œæ–¹å—ä¸­è¿çº¿è¶Šç²—è¡¨ç¤ºè€—æ—¶è¶Šå¤š\nå†…å­˜æ³„éœ²è¯¯åŒº æˆ‘åœ¨æ’æŸ¥å†…å­˜æ³„éœ²æ—¶ï¼Œå½“æˆ‘æŠŠgoroutineé˜»å¡è§£å†³åï¼Œé€šè¿‡linux çš„ top å‘½ä»¤æŸ¥çœ‹Gatewayå†…å­˜å ç”¨æ—¶ï¼Œå‘ç°å†…å­˜æ²¡æœ‰é™ä¸‹æ¥ï¼Œä¸€æ—¶è®©æˆ‘é™·å…¥å›°æƒ‘ï¼Œä¸ºå•¥goroutine éƒ½ç»“æŸäº†ï¼Œä¸ºå•¥å†…å­˜è¿˜ä¸é‡Šæ”¾å‘¢ï¼Ÿç›´åˆ°æˆ‘åœ¨ç½‘ä¸Šæ‰¾åˆ°äº†è¿™ç¯‡æ–‡ç«  ä¼ é€é—¨\nè¿™ä½å¤§ç¥å†™çš„golang ç›¸å…³çš„æ–‡ç« ï¼Œæ˜¯ç›®å‰æˆ‘åœ¨ç½‘ä¸Šæ‰¾åˆ°çš„æœ€ç‰›é€¼çš„ä¹‹ä¸€ï¼Œæ–‡ç« ä¸å…‰æœ‰æ·±åº¦ï¼Œè€Œä¸”é€šä¿—æ˜“æ‡‚ã€‚\né‡æ–°éªŒè¯ ä¿®æ”¹ä¸Šé¢çš„ä»£ç \n1package main 2 3import ( 4\t\u0026#34;math/rand\u0026#34; 5\t\u0026#34;net/http\u0026#34; 6\t_ \u0026#34;net/http/pprof\u0026#34; 7\t\u0026#34;sync\u0026#34; 8\t\u0026#34;time\u0026#34; 9) 10 11func main() { 12\tgo func() { 13\thttp.ListenAndServe(\u0026#34;0.0.0.0:8090\u0026#34;, nil) 14\t}() 15 16\tvar wg sync.WaitGroup 17\twg.Add(1) 18\tfor i := 0; i \u0026lt; 10000; i++ { 19\tgo one() 20\t} 21\twg.Wait() 22} 23 24func one() { 25\tvar a []int64 26\tfor i := 0; i \u0026lt; 10000; i++ { 27\ta = append(a, rand.Int63()) 28\t} 29\ttime.Sleep(time.Second * 1) 30} ç°åœ¨ go å‡ºæ¥çš„çš„å‡½æ•° one ä¸å†ä¸€ç›´é˜»å¡ï¼Œè€Œæ˜¯åªä¼šé˜»å¡5ç§’\næŠŠç¨‹åºè¿è¡Œèµ·æ¥çœ‹ä¸€ä¸‹\nç­‰ä¸€æ®µæ—¶é—´åï¼Œå‘ç°goroutineæ•°é‡å·²ç»ä¸‹æ¥äº†ï¼Œè¯´æ˜é˜»å¡çš„åç¨‹éƒ½å·²ç»ç»“æŸäº†ï¼Œå¦‚å›¾ ä½†æ˜¯é€šè¿‡ä»»åŠ¡ç®¡ç†å™¨ä¸­ï¼Œçœ‹åˆ°ç¨‹åºè¿˜æ˜¯å ç”¨ç€å¤§é‡çš„å†…å­˜ è¿™æ—¶ç‚¹å‡» heap æŸ¥çœ‹å…·ä½“çš„å †å†…å­˜æƒ…å†µï¼Œæ‹‰åˆ°æœ€ä½ä¸‹ï¼Œçœ‹åˆ°ä¸€å †å‚æ•°\nå‚æ•°å¾ˆå¤šï¼Œä½†æ˜¯é‡ç‚¹å…³æ³¨è¢«æ¡†å‡ºæ¥çš„é‚£å‡ ä¸ªå°±å¥½äº†ï¼Œè¯¦ç»†çš„åˆ†æåœ¨å¤§ç¥çš„æ–‡ç« ä¸­æœ‰åˆ†æï¼Œåœ¨goçš„åº“æ–‡ä»¶ä¸­ä¹Ÿèƒ½æ‰¾åˆ°ï¼Œé‡Œé¢æœ‰è¯¦ç»†çš„æ³¨é‡Šã€‚ è·¯å¾„ src-\u0026gt;runtime-\u0026gt;mstats.go æ–‡ä»¶ä¸­æœ‰ MemStats çš„å®šä¹‰å’Œæ³¨é‡Š\nè¿™äº›å‚æ•°çš„å•ä½éƒ½æ˜¯å­—èŠ‚\nTotalAlloc : æ‰€æœ‰å¯¹è±¡åˆ†é…çš„æ€»å’Œï¼Œæ•´ä¸ªç¨‹åºè¿è¡ŒæœŸé—´ï¼Œåªå¢ä¸å‡ HeapAlloc : åˆ†é…çš„å †å¯¹è±¡çš„å­—èŠ‚æ•°ï¼ŒåŒ…æ‹¬å¯è®¿é—®çš„å¯¹è±¡å’Œæœªè¢«GCå›æ”¶çš„ä¸å¯è®¿é—®çš„å¯¹è±¡ï¼Œè¿™ä¸ªå€¼ä¼šåŠ¨æ€å˜åŒ–ï¼Œåˆ†é…å¯¹è±¡æ—¶å¢åŠ ï¼Œå›æ”¶å¯¹è±¡åå‡å°‘ HeapIdle : é—²ç½®çš„spanä¸­çš„å­—èŠ‚æ•°ï¼Œè¿™äº›spanä¸­å·²ç»æ²¡æœ‰å¯¹è±¡äº†ï¼ˆä¸ç”¨äº†ï¼‰ï¼Œä½†æ˜¯ç°åœ¨è¿˜æ²¡æœ‰è¿˜ç»™æ“ä½œç³»ç»Ÿï¼Œè¿™äº›spanå¯ä»¥é‡æ–°ç”¨æ¥åˆ†é…heapå’Œstackã€‚HeapIdle å‡å» HeapReleased çš„å€¼å¯ä»¥å½“ä½œ \u0026ldquo;å¯ä»¥è¿”å›åˆ°æ“ä½œç³»ç»Ÿä½†ç”±è¿è¡Œæ—¶ä¿ç•™çš„å†…å­˜é‡\u0026rdquo;ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œgoçš„runtimeå¯ä»¥åœ¨ä¸åƒæ“ä½œç³»ç»Ÿç”³è¯·å†…å­˜çš„æƒ…å†µä¸‹ï¼Œä¹Ÿå¯ä»¥åˆ†é…heapç©ºé—´ï¼Œè¿™æ ·å¯ä»¥æé«˜ç¨‹åºæ€§èƒ½ HeapInuse : æ­£åœ¨ä½¿ç”¨çš„spançš„å­—èŠ‚å¤§å° HeapReleased : æ˜¯è¿”è¿˜ç»™æ“ä½œç³»ç»Ÿçš„ç‰©ç†å†…å­˜çš„å­—èŠ‚æ•° å›åˆ°æˆ‘ä»¬çš„æµ‹è¯•ç¨‹åºä¸­ï¼Œå½“æ‰€æœ‰çš„goroutineéƒ½ç»“æŸæ—¶ï¼ŒGCä¼šå¼€å§‹å›æ”¶åˆ‡ç‰‡ï¼Œä½†æ˜¯è¢«å›æ”¶çš„å†…å­˜ä¸ä¼šç›´æ¥æ¢ç»™æ“ä½œç³»ç»Ÿï¼Œè€Œæ˜¯ç”±goçš„runtimeæš‚æ—¶ä¿ç®¡ï¼ˆä¹Ÿå°±æ˜¯ HeapIdle å€¼ä¼šå˜å¤§ï¼‰ï¼Œæ¥ä¸‹æ¥å¦‚æœå†æ¬¡éœ€è¦åˆ†é…ç©ºé—´ï¼Œgoçš„runtimeå¯ä»¥ä¸å‘æ“ä½œç³»ç»Ÿç”³è¯·å†…å­˜ï¼Œç›´æ¥ä»è‡ªå·±ä¿ç®¡çš„é—²ç½®å†…å­˜ä¸­åˆ†é…ï¼Œè¿™æ ·å¯ä»¥æé«˜ç¨‹åºæ€§èƒ½ã€‚è‡³äºGOçš„runtimeä»€ä¹ˆæ—¶å€™æŠŠè¿™éƒ¨åˆ†å†…å­˜è¿˜ç»™æ“ä½œç³»ç»Ÿï¼Œä¸åŒçš„åˆ†é…ç­–ç•¥å’Œä¸åŒçš„ç³»ç»Ÿä¸å¤ªä¸€æ ·ï¼Œè¿™ä¸ªæœ‰ç‚¹æ·±ï¼Œæˆ‘è¿˜æ²¡æœ‰æ·±å…¥ç ”ç©¶è¿™äº›ã€‚ä¸è¿‡ ä¼ é€é—¨ çš„æ–‡ä¸­æœ‰ä»‹ç» MADV_FREE æœ‰å…´è¶£å¯ä»¥è‡ªå·±å­¦ä¹ ä¸€ä¸‹\næ€»ç»“ go è™½ç„¶æœ‰GCï¼Œä½†æ˜¯ä½¿ç”¨ä¸å½“ä¹Ÿä¼šå¯¼è‡´å†…å­˜æ³„éœ² ä¸åŒçš„æ“ä½œç³»ç»Ÿå’Œä¸ç”¨ç­–ç•¥ï¼Œä¼šå¯¼è‡´goç¨‹åºçš„å†…å­˜å·²ç»è¢«å›æ”¶äº†ï¼Œä½†æ˜¯æ²¡æœ‰åŠæ—¶çš„å½’è¿˜ç»™æ“ä½œç³»ç»Ÿ ç”±äºæ°´å¹³æœ‰é™ï¼Œæ–‡ä¸­å¦‚æœ‰è°¬å¤„ï¼Œè¿˜è¯·åœ¨è¯„è®ºåŒºä¸åèµæ•™\n","date":"2021-03-14T13:58:27Z","image":"https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/118dbbd1af54c33c82bdbd4d3297a9709b550205.jpg","permalink":"https://lqxhub.github.io/posts/24bc8405/","title":"go ä½¿ç”¨ pprof æ’æŸ¥å†…å­˜æ³„éœ²"},{"content":"è¿™æ¬¡ä¹¦æ¥ä¸Šå›ï¼Œå‰æ®µæ—¶é—´å†™äº†ä¸€ç¯‡ã€Šä½¿ç”¨cmakeæ„å»ºC/C++é¡¹ç›®å’ŒåŠ¨æ€åº“ã€‹çš„æ–‡ç« ï¼Œ ä¼ é€é—¨ã€‚ ä½†æ˜¯ç›´æ¥é€šè¿‡cmakeç¼–è¯‘é“¾æ¥åï¼Œä¼šæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œé‚£å°±æ˜¯éœ€è¦çš„.soæ–‡ä»¶ä¸èƒ½æ›´æ”¹ç›®å½•ï¼Œä¸€æ—¦.soæ–‡ä»¶ç›®å½•å˜äº†,æ•´ä¸ªç¨‹åºå°±æ²¡æ³•è¿è¡Œäº†ï¼Œè¿™è‚¯å®šæ˜¯ä¸è¡Œçš„ã€‚\nåŸå›  åæ¥æˆ‘æŸ¥ä¸€ä¸‹ä¸€ä¸‹ï¼Œlinuxç³»ç»Ÿä¸­ï¼Œç¨‹åºåŠ è½½è¿è¡Œéœ€è¦çš„.soæ–‡ä»¶æ˜¯æœ‰é¡ºåºçš„\nç¯å¢ƒå˜é‡LD_LIBRARY_PATHæŒ‡å®šçš„è·¯å¾„ gcc ç¼–è¯‘æ—¶æŒ‡å®šçš„è¿è¡Œæ—¶åº“è·¯å¾„-rpath ldconfig é…ç½®æ–‡ä»¶ld.so.confæŒ‡å®šçš„è·¯å¾„ ç³»ç»Ÿé»˜è®¤åº“ä½ç½® /lib, /usr/lib å¦‚æœæ²¡æœ‰æŒ‡å®šsoçš„ä½ç½®ï¼Œgccä¼šè‡ªåŠ¨æŠŠå½“å‰soæ‰€åœ¨çš„ç›®å½•ä½œä¸ºsoçš„è¿æ¥ç›®å½•ã€‚çŸ¥é“åŸå› äº†ï¼Œé—®é¢˜å°±å¥½è§£å†³äº†\nè§£å†³åŠæ³• å…ˆçœ‹ä¸€ä¸‹ç°åœ¨çš„ CMakeLists.txtæ–‡ä»¶\n1cmake_minimum_required(VERSION 3.13.3) 2project(project1 C) 3 4set(CMAKE_C_STANDARD 99) 5 6add_library(shared SHARED library.h library.c) 7 8set(LIBRARY_OUTPUT_PATH ${PROJECT_SOURCE_DIR}/lib) 9 10add_executable(project1 main.c) 11 12target_link_libraries(project1 shared) æˆ‘å®éªŒäº†ä¸¤ç§åŠæ³•ï¼Œä¸€æ˜¯æŠŠ.so æ–‡ä»¶æ”¾åˆ°/lib æˆ–è€… /usr/libä¸­ï¼Œè¿™ä¹Ÿæ˜¯åœ¨å®‰è£…å¾ˆå¤šè½¯ä»¶æ—¶çš„åšæ³•ï¼Œå½“ä½¿ç”¨åŒ…ç®¡ç†å™¨å®‰è£…è½¯ä»¶æ—¶ï¼Œéœ€è¦çš„.soæ–‡ä»¶å¤§å¤šæ˜¯å®‰è£…åˆ°è¿™ä¸¤ä¸ªç›®å½•ä¸‹ã€‚åœ¨ä¸€ç§å°±æ˜¯åœ¨ç¼–è¯‘æ—¶æŒ‡å®š rpathçš„ç›®å½•ï¼Œä½¿ç”¨ç›¸å¯¹ç›®å½•ï¼Œè¿™æ ·åœ¨å¤åˆ¶æ–‡ä»¶çš„æ—¶å€™ï¼ŒæŠŠ.soä¸€èµ·å¤åˆ¶å°±å¯ä»¥äº†ã€‚\nå…ˆç”¨æœ€ç®€å•çš„åŠæ³•ï¼ŒæŠŠsoç›®å½•æ”¾åˆ°ç³»ç»Ÿç›®å½•ä¸‹ ç°åœ¨çš„ç›®å½•ç»“æ„å¦‚ä¸‹ï¼Œç¨‹åºä¾èµ–çš„libshared.so åœ¨ lib ç›®å½•ä¸‹ï¼Œç°åœ¨æŠŠ libshared.so å¤åˆ¶åˆ° /lib ç›®å½•ä¸‹ã€‚è¿™é‡Œæœ‰ä¸ªè¦æ³¨æ„çš„åœ°æ–¹ï¼Œå¤åˆ¶å®Œåè¦æ‰§è¡Œ ldconfig å‘½ä»¤ï¼Œé‡æ–°ç”Ÿæˆç¼“å­˜ï¼Œè¦ä¸ç„¶ç¨‹åºä¾ç„¶æ‰¾ä¸åˆ°å¯¹åº”çš„.soæ–‡ä»¶ å‘½ä»¤å¦‚ä¸‹\nsudo mv lib/libshared.so /lib sudo ldconfig è¿™æ—¶å€™åœ¨è¿è¡Œ project1 ä¸ä¼šæŠ¥é”™\nç¼–è¯‘æ—¶æŒ‡å®š rpathç›®å½• è®¾ç½® rpaht æœ‰ä¸¤ç§æ–¹å¼\næ–¹å¼1\n1set(CMAKE_SKIP_BUILD_RPATH FALSE) 2set(CMAKE_BUILD_WITH_INSTALL_RPATH TRUE) 3set(CMAKE_INSTALL_RPATH $ORIGIN) é€šè¿‡ä¿®æ”¹ç¼–è¯‘åçš„ install è·¯å¾„, è®©ç¨‹åºåœ¨è¿è¡Œæ—¶é€šè¿‡ç¨‹åºçš„ç›¸å¯¹ç›®å½•åŠ è½½.soæ–‡ä»¶ï¼Œå…¶ä¸­ $ORIGIN å˜é‡æ˜¯ç¨‹åºçš„å½“å‰ç›®å½•\næ–¹å¼2\n1set_target_properties(project1 PROPERTIES LINK_FLAGS \u0026#34;-Wl,-rpath,./\u0026#34;) æ–¹å¼2æ›´ç²—æš´ï¼Œç›´æ¥è®¾ç½®gccçš„ç¼–è¯‘å‚æ•°ï¼ŒæŒ‡å®šrpaht æ˜¯å½“å‰ç›®å½•\nä¿®æ”¹ CMakeLists.txtæ–‡ä»¶\n1cmake_minimum_required(VERSION 3.13.3) 2project(project1 C) 3 4set(CMAKE_C_STANDARD 99) 5 6add_library(shared SHARED library.h library.c) 7 8set(LIBRARY_OUTPUT_PATH ${PROJECT_SOURCE_DIR}/lib) 9 10#æ–¹å¼1 11set(CMAKE_SKIP_BUILD_RPATH FALSE) 12set(CMAKE_BUILD_WITH_INSTALL_RPATH TRUE) 13set(CMAKE_INSTALL_RPATH $ORIGIN) 14 15add_executable(project1 main.c) 16 17#æ–¹å¼2 18#set_target_properties(project1 PROPERTIES LINK_FLAGS \u0026#34;-Wl,-rpath,./\u0026#34;) 19target_link_libraries(project1 shared) é‡æ–°ç”Ÿæˆ MakeFile æ–‡ä»¶, ç„¶åç¼–è¯‘\nç¼–è¯‘ç”Ÿæˆçš„ libshared.so è¿˜æ˜¯åœ¨ libç›®å½•ä¸‹ï¼Œå…ˆç§»åŠ¨åˆ°å¯æ‰§è¡Œæ–‡ä»¶çš„åŒçº§ç›®å½•ä¸‹ æœ€ç»ˆç›®å½•å¦‚å›¾ï¼Œç°åœ¨æ— è®ºæ€ä¹ˆå¤åˆ¶æ–‡ä»¶ï¼Œåªè¦å¯æ‰§è¡Œæ–‡ä»¶å’ŒåŠ¨æ€åº“åœ¨ä¸€ä¸ªç›®å½•ä¸‹ï¼Œéƒ½ä»¥è¿è¡Œäº†\næ€»ç»“ è§£å†³linuxä¸‹ åŠ¨æ€ç¼–è¯‘çš„ç¨‹åºæ‰¾ä¸åˆ°åŠ¨æ€åº“çš„é—®é¢˜ï¼Œæœ‰å¤šç§è§£å†³åŠæ³•ï¼Œè¿™æ¬¡ç”¨äº†ä¸¤ç§\næŠŠéœ€è¦çš„.soæ–‡ä»¶æ”¾åˆ° /lib æˆ–è€… /usr/lib ä¸‹ï¼Œ ç„¶åæ‰§è¡Œ ldconfigå‘½ä»¤ é€šè¿‡æŒ‡å®š rpath æ¥å†³å®šåŠ è½½ .soçš„ç›®å½• ","date":"2021-03-13T17:48:50Z","permalink":"https://lqxhub.github.io/posts/497a7ebf/","title":"linuxä¸‹é€šè¿‡rpathè§£å†³cmakeåŠ¨æ€ç¼–è¯‘åæ‰¾ä¸åˆ°åŠ¨æ€é“¾æ¥åº“é—®é¢˜"},{"content":"ç¼–è¯‘C/C++æ–‡ä»¶æ—¶ï¼Œå¾ˆå¤šæ—¶å€™éƒ½æ˜¯ç›´æ¥ä½¿ç”¨åƒ gcc main.c æˆ–è€… g++ main.cpp è¿™æ ·çš„å‘½ä»¤ç¼–è¯‘çš„ã€‚ä½†æ˜¯ä»£ç æ–‡ä»¶å¤šäº†åï¼Œè¿™æ ·ç¼–è¯‘å°±å¾ˆå›°éš¾äº†ã€‚è¿™æ—¶å€™ å°±å‡ºç°äº†MakeFile è¿™ä¸ªå·¥å…·ã€‚\nMakeFile è§£å†³äº†å¤šä¸ªæ–‡ä»¶ç¼–è¯‘éš¾çš„é—®é¢˜ï¼Œæœ‰äº†MakeFileï¼Œåªéœ€è¦åœ¨MakeFileçš„ç›®å½•ä¸­ è¿è¡Œä¸€ä¸‹make å‘½ä»¤ï¼Œ ç¼–è¯‘å°±ä¼šè‡ªåŠ¨å®Œæˆã€‚ä½†æ˜¯ç¼–å†™MakeFileåˆå¾ˆå•°å—¦ï¼Œäºæ˜¯èªæ˜çš„ç¨‹åºå‘˜ä»¬æœ‰å¼€å‘äº†ä¸€ä¸ªå·¥å…·ï¼Œè‡ªåŠ¨ç”ŸæˆMakeFile æ–‡ä»¶ï¼Œcmake çš„ä½œç”¨å°±æ˜¯è‡ªåŠ¨ç”ŸæˆMakeFileã€‚æ¯•ç«Ÿå†™cmakeè¦æ¯”å†™MakeFileè¦ç®€å•å¾ˆå¤š\nä¹Ÿè®¸ä½ ä¼šè¯´ï¼Œç°åœ¨éƒ½æ˜¯ç”¨IDEå†™ä»£ç ï¼ŒIDEéƒ½ä¼šè‡ªåŠ¨è‡ªåŠ¨ç¼–è¯‘å’Œè¿è¡Œï¼Œæˆ‘è¿˜å­¦è¿™äº›å¹²å•¥ã€‚ä½†æ˜¯æœ‰æ—¶å€™éœ€è¦æœåŠ¡å™¨ä¸Šç¼–è¯‘é¡¹ç›®ï¼Œæˆ–è€…åœ¨æ²¡æœ‰IDEçš„æœºå™¨ä¸Šç¼–è¯‘é¡¹ç›®ï¼Œè¿™æ—¶å€™MakeFileå°±å¾ˆæœ‰ç”¨äº†ã€‚å…¶å®å¾ˆå¤šIDEä¹Ÿæ˜¯ä½¿ç”¨cmakeå®Œæˆç¼–è¯‘çš„ï¼Œæ¯”å¦‚ clion\ncmake å®‰è£… åœ¨linuxä¸Šå¯ä»¥ä½¿ç”¨æºç å®‰è£…å’ŒåŒ…ç®¡ç†å®‰è£…ï¼Œä¸€èˆ¬ç›´æ¥ç”¨åŒ…ç®¡ç†å®‰è£…å°±å¥½äº† Ubuntuå’ŒDebian sudo apt-get install cmake\nCentOS sudo yum install cmake\nå› ä¸ºcmakeåªæ˜¯ç”ŸæˆMakeFileï¼Œæœ€ç»ˆç»„ç»‡ç¼–è¯‘çš„è¿˜æ˜¯MakeFileï¼Œæ‰€ä»¥è¿˜æœ‰å®‰è£…make\nmake ä¸€èˆ¬éƒ½ä¼šé¢„è£…ï¼Œä¸ºäº†ä¿é™©ï¼Œè¿˜æ˜¯è£…ä¸€ä¸‹\nUbuntuå’ŒDebian sudo apt-get install make\nCentOS sudo yum install make\ncmakeåŸºæœ¬è§„åˆ™ cmake ä¹Ÿæ²¡å•¥ç¥ç§˜çš„ï¼Œæœ¬è´¨ä¸Šä¹Ÿæ˜¯æ ¹æ®ä¸€å®šçš„è§„åˆ™è‡ªåŠ¨ç”ŸæˆMakeFileçš„ï¼Œä¹Ÿæ˜¯æœ‰è¯­æ³•çš„\n# æ˜¯æ³¨é‡Šç¬¦å·\né¢„å®šä¹‰å˜é‡ PROJECT_NAMEé¡¹ç›®åç§° PROJECT_SOURCE_DIRå·¥ç¨‹çš„æ ¹ç›®å½• PROJECT_BINARY_DIR æ‰§è¡Œcmakeå‘½ä»¤çš„ç›®å½• PROJECT_BINARY_DIR æ‰§è¡Œcmakeå‘½ä»¤çš„ç›®å½• CMAKE_CURRENT_SOURCE_DIR å½“å‰CMakeLists.txtæ–‡ä»¶æ‰€åœ¨ç›®å½• CMAKE_C_FLAGSè®¾ç½®Cç¼–è¯‘é€‰é¡¹ CMAKE_CXX_FLAGSè®¾ç½®C++ç¼–è¯‘é€‰é¡¹ CMAKE_C_COMPILERè®¾ç½®Cç¼–è¯‘å™¨ CMAKE_CXX_COMPILERè®¾ç½®C++ç¼–è¯‘å™¨ EXECUTABLE_OUTPUT_PATHè®¾ç½®ç¼–è¯‘åå¯æ‰§è¡Œæ–‡ä»¶ç›®å½• LIBRARY_OUTPUT_PATHè®¾ç½®ç”Ÿæˆçš„åº“æ–‡ä»¶ç›®å½•\nå¸¸ç”¨è§„åˆ™ cmake_minimum_required(VERSION 3.16) æŒ‡ä»¤cmake ç‰ˆæœ¬ project(hello_world) è®¾ç½®å·¥ç¨‹å include_directories(${PROJECT_SOURCE_DIR}/include) æ·»åŠ å¤´æ–‡ä»¶è·¯å¾„ link_directories(${PROJECT_SOURCE_DIR}/lib) æ·»åŠ é“¾æ¥åº“çš„è·¯å¾„ add_subdirectory(module)æ·»åŠ  module å­ç›®å½•, æ­¤ç›®å½•ä¸‹ä¹Ÿè¦æœ‰CMakeLists.txtæ–‡ä»¶ add_executable(project1 main.c)æŒ‡å®šç¼–è¯‘çš„å¯æ‰§è¡Œæ–‡ä»¶ add_library(lib1 SHARED library.c library.h)æŒ‡å®šç”Ÿæˆçš„åº“æ–‡ä»¶ï¼ŒSHAREDæ˜¯ç”ŸæˆåŠ¨æ€åº“ï¼ŒSTATICåç”Ÿæˆé™æ€åº“ add_compile_options() æ·»åŠ ç¼–è¯‘é€‰é¡¹ target_link_libraries()æŒ‡å®šåŠ¨æ€é“¾æ¥åº“ install()æŒ‡å®šmake installçš„ç›®å½•\nset(XXXX YYYYYY)ç”¨äºè®¾ç½®å’Œä¿®æ”¹å˜é‡ ${XXXX} ä½¿ç”¨å˜é‡\næ„å»ºä¸€ä¸ªç®€å•çš„é¡¹ç›® åªæœ‰ä¸€ä¸ª main.c æ–‡ä»¶\nCMakeList.txt\n1cmake_minimum_required(VERSION 3.15) 2project(project1 C) 3 4set(CMAKE_C_STANDARD 99) 5 6add_executable(project1 main.c) main.c\n1#include \u0026lt;stdio.h\u0026gt; 2 3int main() { 4 printf(\u0026#34;Hello, CMakeList!\\n\u0026#34;); 5 return 0; 6} ç¼–è¯‘ä¸€ä¸ªdebugç‰ˆæœ¬ mkdir debug æ–°å»ºdebugç›®å½• cd debug è¿›å…¥debugç›®å½• cmake -DCMAKE_BUILD_TYPR=debug .. æŒ‡å®šç¼–è¯‘æ¨¡å¼ä¸ºdebug make ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ æ­¤æ—¶ä¼šç”Ÿæˆproject1æ–‡ä»¶\næ­¥éª¤ 3 ä¸­ cmake -DCMAKE_BUILD_TYPE=release .. æŒ‡å®šç¼–è¯‘æ¨¡å¼ä¸ºrelease\næ„å»ºä¸€ä¸ªç”ŸæˆåŠ¨æ€åº“çš„é¡¹ç›® æœ‰ä¸¤ä¸ªæ–‡ä»¶library.hå’Œlibrary.c CMakeList.txt\n1cmake_minimum_required(VERSION 3.15) 2project(shared C) 3 4set(CMAKE_C_STANDARD 99) 5 6add_library(shared SHARED library.c library.h) library.h\n1int add(int a, int b); library.c\n1int add(int a, int b) { 2 return a + b; 3} ç”ŸæˆåŠ¨æ€åº“ mkdir lib æ–°å»ºlibç›®å½• cd lib è¿›å…¥libç›®å½• cmake -DCMAKE_BUILD_TYPE=debug .. æŒ‡å®šç¼–è¯‘æ¨¡å¼ä¸ºdebug make ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ æ­¤æ—¶ä¼šç”Ÿæˆ libshared.soæ–‡ä»¶ åœ¨ç¬¬ä¸€ä¸ªé¡¹ç›®ä¸­ä½¿ç”¨åŠ¨æ€åº“ é¦–å…ˆæŠŠ libshared.soæ–‡ä»¶å’Œlibrary.hæ–‡ä»¶å¤åˆ¶åˆ°ç¬¬ä¸€ä¸ªé¡¹ç›®ä¸­\nä¿®æ”¹ CMakeList.txt\n1cmake_minimum_required(VERSION 3.15) 2project(project1 C) 3 4set(CMAKE_C_STANDARD 99) 5 6add_executable(project1 main.c) 7 8target_link_libraries(project1 ${PROJECT_SOURCE_DIR}/libshared.so)#æŒ‡å®šåŠ¨æ€åº“æ–‡ä»¶ mkdir debug æ–°å»ºdebugç›®å½• cd debug è¿›å…¥debugç›®å½• cmake -DCMAKE_BUILD_TYPE=debug .. æŒ‡å®šç¼–è¯‘æ¨¡å¼ä¸ºdebug make ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ æœ€ç»ˆç›®å½•å¦‚å›¾ æŠŠä¸¤ä¸ªé¡¹ç›®åˆæˆä¸€ä¸ª èƒ½ä¸èƒ½åœ¨ä¸€ä¸ªé¡¹ç›®ä¸­ç”ŸæˆåŠ¨æ€åº“å¹¶åœ¨è¿™ä¸ªé¡¹ç›®ä¸­ä½¿ç”¨å‘¢ï¼Œå½“ç„¶æ˜¯å¯ä»¥çš„ã€‚\nä¹Ÿå°±æ˜¯åœ¨è¿™ä¸ªé¡¹ç›®ä¸­éƒ¨åˆ†æ–‡ä»¶ç¼–è¯‘æˆåŠ¨æ€åº“ .so æ–‡ä»¶ï¼Œ éƒ¨åˆ†æ–‡ä»¶ç¼–è¯‘æˆ å¯æ‰§è¡Œæ–‡ä»¶\nä¿®æ”¹ CMakeList.txt\n1cmake_minimum_required(VERSION 3.13.3) 2project(project1 C) 3 4set(CMAKE_C_STANDARD 99) 5 6add_library(shared SHARED library.h library.c) 7 8set(LIBRARY_OUTPUT_PATH ${PROJECT_SOURCE_DIR}/lib)#è®¾ç½®åŠ¨æ€åº“è¾“å‡ºç›®å½• 9 10add_executable(project1 main.c) 11 12target_link_libraries(project1 shared) mkdir debug æ–°å»ºdebugç›®å½• cd debug è¿›å…¥debugç›®å½• cmake -DCMAKE_BUILD_TYPE=debug .. æŒ‡å®šç¼–è¯‘æ¨¡å¼ä¸ºdebug make ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ æœ€ç»ˆç›®å½•å¦‚å›¾\næœ€å é€šè¿‡å‡ ä¸ªç®€å•çš„ä¾‹å­ï¼Œä»‹ç»äº†ä¸€ä¸‹cmakeçš„åŸºæœ¬ä½¿ç”¨ï¼Œæ–‡ä¸­æ˜¯ä½¿ç”¨cmakeæ„å»ºçš„Cé¡¹ç›®ï¼Œæ¢æˆC++åŸºæœ¬æ²¡ä»€ä¹ˆåŒºåˆ«ï¼Œå°±ä¸å±•ç¤ºäº†\ncmakeçš„åŠŸèƒ½è¿œä¸æ­¢è¿™äº›ï¼Œè¿˜éœ€è¦åœ¨å®æˆ˜ä¸­å¤šå­¦ä¹ ï¼Œå¤šæ€»ç»“\n2021-03-06 è¡¥å…… é€šè¿‡ä¸Šé¢çš„æ–¹å¼å¯ä»¥ç¼–è¯‘è¿è¡Œï¼Œä½†æ˜¯ä¼šæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯ .so æ–‡ä»¶ä¸èƒ½æ›´æ”¹ç›®å½•ï¼Œä¸€æ—¦åŠ¨æ€åº“ç›®å½•å˜äº†ï¼Œç¨‹åºå°±æ²¡æ³•åŠ è½½ï¼Œç¨‹åºä¹Ÿå°±æ²¡æ³•è¿è¡Œäº†ã€‚ä¸ºæ­¤åˆæ‰¾èµ„æ–™å­¦ä¹ ä¸€ç•ªï¼Œå¦å†™äº†ä¸€ç¯‡ï¼Œ{% post_link linuxä¸‹cmakeåŠ¨æ€ç¼–è¯‘åæ‰¾ä¸åˆ°åŠ¨æ€é“¾æ¥åº“ [ä¼ é€é—¨] %}\n","date":"2021-03-13T17:45:45Z","permalink":"https://lqxhub.github.io/posts/a20c5e48/","title":"ä½¿ç”¨cmakeæ„å»ºC/C++é¡¹ç›®å’ŒåŠ¨æ€åº“"},{"content":"golangä¸­æ˜¯æœ‰æŒ‡é’ˆæ¦‚å¿µçš„ï¼Œä½†æ˜¯goä¸­çš„æŒ‡é’ˆåŠŸèƒ½è¢«é™åˆ¶äº†ï¼Œä¸åƒC/C++ä¸­é‚£æ ·,å¯ä»¥å¯¹æŒ‡é’ˆè¿›è¡Œè¿ç®—\næ¯”å¦‚åœ¨C/C++ä¸­ *p++ è¿™æ ·æ˜¯æ­£ç¡®çš„ã€‚ä½†æ˜¯åœ¨goä¸­ï¼Œè¿™æ ·å†™æ˜¯é”™è¯¯çš„ã€‚è‡³äºgoä¸ºä»€ä¹ˆä¼šå±è”½æŒ‡é’ˆçš„è¿ç®—ï¼Œæ¯”è¾ƒå¤šçš„ä¸€ç§è¯´æ³•æ˜¯goå›¢é˜Ÿè®¤ä¸ºæŒ‡é’ˆçš„è¿ç®—ä¼šå¸¦æ¥ä¸€äº›å®‰å…¨é—®é¢˜ï¼Œå†æœ‰å°±æ˜¯ç®€åŒ–è¯­æ³•ï¼Œæ‰€ä»¥goç›´æ¥å°±ä¸æ”¯æŒæŒ‡é’ˆè¿ç®—äº†ã€‚\nè™½ç„¶goè¯­æ³•ä¸æ”¯æŒï¼Œä½†æ˜¯é€šè¿‡goçš„ unsafe åŒ…å¯ä»¥é—´æ¥çš„å®ç°å¯¹æŒ‡é’ˆçš„è¿ç®—ï¼Œå°±æƒ³è¿™ä¸ªåŒ…çš„åå­—ä¸€æ ·ï¼Œè¿™ä¸ªåŒ…æä¾›çš„ä¸œè¥¿ä¸æ˜¯å®‰å…¨çš„ï¼Œä½¿ç”¨ä¸å½“å¯èƒ½ä¼šå‡ºç°ä¸€äº›é—®é¢˜ï¼Œæ‰€ä»¥åœ¨goæ˜¯ä¸æ¨èä½¿ç”¨çš„ï¼Œè‡ªå·±ç©ç©è¿˜å¯ä»¥ï¼ŒçœŸæ­£çš„é¡¹ç›®ä¸­ï¼Œè¿˜æ˜¯å°½é‡ä¸è¦ä½¿ç”¨ã€‚\nåœ¨ä¸€ä¸ªçŸ¥è¯†ç‚¹ï¼Œgoæ˜¯é€šè¿‡é¦–å­—æ¯çš„å¤§å°å†™åœ¨å´åˆ« private å’Œ public çš„ï¼Œä¸åŒåŒ…ä¸­çš„æ˜¯æ— æ³•è®¿é—®privateå˜é‡çš„ã€‚å…¶å®æ‰€è°“çš„privateå’Œpublicåªæ˜¯è¯­æ³•ä¸Šçš„é™åˆ¶ï¼Œåˆ°äº†æ±‡ç¼–å±‚ï¼Œéƒ½æ˜¯åœ°å€ï¼Œå“ªæ¥çš„å…¬å¼€å’Œç§æœ‰çš„ï¼Œæ‰€ä»¥ï¼Œä½†æ˜¯æˆ‘ä»¬é€šè¿‡ä½¿ç”¨åœ°å€ï¼ˆä¹Ÿå°±æ˜¯æŒ‡é’ˆï¼‰æ¥ç»•è¿‡è¯­æ³•é™åˆ¶ï¼Œè®¿é—®å…¶ä»–åŒ…ä¸­çš„ç§æœ‰å˜é‡ã€‚\nè¯´äº†ä¸€å †åºŸè¯äº†ï¼Œå¼€å§‹ä¸ŠçœŸçš„ï¼Œå…ˆåˆ›å»ºæœ‰ä¸€ä¸ªprojectï¼Œç›®å½•å±‚æ¬¡å¦‚ä¸‹ï¼š\nä¸Šä»£ç  one.go 1package one 2 3type One struct { 4\tA int 5\tb int 6\tc *Two 7} two.go 1package one 2 3type Two struct { 4\tD int 5} main.go 1package main 2 3import ( 4\t\u0026#34;fmt\u0026#34; 5\t\u0026#34;pointer/one\u0026#34; 6\t\u0026#34;unsafe\u0026#34; 7) 8 9func main() { 10\to := \u0026amp;one.One{} 11 12\tp := unsafe.Pointer(o) 13\tp2 := (*int)(unsafe.Pointer(uintptr(p) + unsafe.Sizeof(o.A))) 14\t*p2 = 100 15 16\tt := \u0026amp;one.Two{D: 2000} 17\tfmt.Printf(\u0026#34;%p \\n\u0026#34;, t) 18 19\tp3 := (*int)(unsafe.Pointer(uintptr(p) + unsafe.Sizeof(o.A)*2)) 20 21\t*p3 = (int)(uintptr(unsafe.Pointer(t))) 22\t23\tfmt.Println(o) 24 25} è¿è¡Œç»“æœ å¯ä»¥çœ‹åˆ°ï¼Œoneä¸­ç§æœ‰å˜é‡å·²ç»è¢«æˆåŠŸèµ‹å€¼äº†ï¼Œ\né€šè¿‡æ‰“å°çš„æŒ‡é’ˆå¯ä»¥çœ‹åˆ°ï¼Œ two ç»“æ„ä½“çš„æŒ‡é’ˆå·²ç»èµ‹åˆ° one ç»“æ„çš„ç§æœ‰å˜é‡ c ä¸­äº†\nä»£ç å…·ä½“æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Œç®€å•ä»‹ç»ä¸€ä¸‹\nå…·ä½“è§£é‡Š p := unsafe.Pointer(o) æŠŠoneç»“æ„çš„æŒ‡é’ˆè½¬æ¢æˆ unsafe.Pointer ç±»å‹ã€‚\nè¿™ä¸ªç±»å‹æœ‰ç‚¹åƒ C/C++ ä¸­çš„ void*\nuintptr(p) æŠŠæŒ‡é’ˆè½¬æ¢æˆå¯ä»¥è¿ç®—çš„ç±»å‹\nunsafe.Sizeof(o.A) æ˜¯è·å–Aå˜é‡åœ¨ç»“æ„ä½“ä¸­é•¿åº¦ï¼Œå¯¹åº”çš„bå°±åœ¨ç»“æ„ä½“ä¸­çš„ä½ç½®ï¼Œä¹Ÿå°±æ˜¯æŒ‡é’ˆ\nå› ä¸º oneä¸­çš„bå˜é‡æ˜¯ int ç±»å‹,æ‰€ä»¥è¦å¼ºè½¬æˆ intç±»å‹çš„æŒ‡é’ˆï¼Œè¿™æ—¶å€™å°±å¯ä»¥ç»™privateå˜é‡bèµ‹å€¼äº†\nåŒæ ·ï¼Œä¹Ÿå¯ä»¥ä¸ºcèµ‹å€¼ï¼Œåªä¸è¿‡cä¸­æ˜¯æŒ‡é’ˆç±»å‹çš„ï¼Œå…¶å®æŒ‡é’ˆç±»å‹å¯ä»¥çœ‹åšæ˜¯intç±»å‹ï¼Œå˜é‡ä¸­ä¿å­˜çš„æ˜¯å†…å­˜åœ°å€ç½¢äº†\n(*int)(unsafe.Pointer(uintptr(p) + unsafe.Sizeof(o.A)*2)) åŒæ ·çš„æ–¹æ³•æ‹¿åˆ°cçš„åœ°å€\n(int)(uintptr(unsafe.Pointer(t))) åˆ›å»ºçš„twoçš„æŒ‡é’ˆåœ°å€è½¬æ¢æˆ int ç±»å‹\nå¥½äº†,åˆ°ç°åœ¨æ•´ä¸ªæŒ‡é’ˆçš„è¿ç®—è¿‡ç¨‹å°±ç»“æŸäº†\næ¢ä¸ªå½¢å¼ ä¹‹å‰æˆ‘ä»¬æ˜¯é€šè¿‡ unsafe.Sizeof(o.A) è·å–æŒ‡é’ˆåç§»é•¿åº¦çš„ï¼Œå…¶å®æˆ‘ä»¬å¯ä»¥æ ¹æ®å˜é‡çš„ç±»å‹è‡ªå·±æ¨ç®—å‡ºæ¥ã€‚\næˆ‘çš„ç”µè„‘æ˜¯64ä½çš„ï¼Œæ‰€æœ‰int å˜é‡çš„é•¿åº¦ä¹Ÿæ˜¯64ä½ï¼Œä¹Ÿå°±æ˜¯8ä¸ªå­—èŠ‚ï¼Œä¿®æ”¹ä¸€ä¸‹ä»£ç \nä¿®æ”¹å 1package main 2 3import ( 4\t\u0026#34;fmt\u0026#34; 5\t\u0026#34;pointer/one\u0026#34; 6\t\u0026#34;unsafe\u0026#34; 7) 8 9func main() { 10\to := \u0026amp;one.One{} 11 12\tp := unsafe.Pointer(o) 13\tp2 := (*int)(unsafe.Pointer(uintptr(p) + 8)) 14\t*p2 = 100 15 16\tt := \u0026amp;one.Two{D: 2000} 17\tfmt.Printf(\u0026#34;%p \\n\u0026#34;, t) 18 19\tp3 := (*int)(unsafe.Pointer(uintptr(p) + 16)) 20 21\t*p3 = (int)(uintptr(unsafe.Pointer(t))) 22 23\tfmt.Println(o) 24 25} è¿è¡Œç»“æœ å¯ä»¥å‘ç°ç»“æœæ˜¯ä¸€æ ·çš„\nä½†æ˜¯ç¬¬äºŒç§æ–¹å¼ä¸å¤Ÿé€šç”¨ï¼Œæ¢ä¸ªæœºå™¨å¯èƒ½å°±æŠ¥é”™äº†ï¼Œæ¯”å¦‚åœ¨32ä½çš„æœºå™¨ä¸Šï¼Œinté•¿åº¦æ˜¯32ä½ï¼Œç¨‹åºå°±å‡ºé”™äº†\næ€»ç»“ è™½ç„¶ go æœ¬èº«ä¸æ”¯æŒæŒ‡é’ˆçš„è¿ç®—ï¼Œä½†æ˜¯æœ‰äº›æ—¶å€™æˆ‘ä»¬éœ€è¦ç”¨åˆ°æŒ‡é’ˆçš„è¿ç®—ï¼Œæ¯”å¦‚è·å–privateå˜é‡ã€‚ä½†æ˜¯è¿™ç§æ–¹å¼æœ‰é£é™©ï¼Œåœ¨å®é™…é¡¹ç›®ä¸­ä½¿ç”¨è¦æ…é‡ï¼ï¼ï¼\n","date":"2021-03-13T17:43:57Z","permalink":"https://lqxhub.github.io/posts/560ffd6b/","title":"golangä½¿ç”¨unsafeåŒ…å®ç°æŒ‡é’ˆè¿ç®—æ“ä½œprivate"},{"content":"è¿‘æ¥æ— äº‹ï¼Œæœ¬ç€çˆ±æŠ˜è…¾çš„åŸåˆ™ï¼Œåœ¨goåŸç”Ÿ http client çš„åŸºç¡€ä¸Šï¼Œè‡ªå·±å°è£…äº†ä¸€ä¸ªgoçš„http clientã€‚ç”±äºæ‰ç–å­¦æµ…ï¼Œå†åŠ æ˜¯ç¬¬ä¸€æ¬¡é€ è½®å­ï¼Œåœ¨å„ä½å¤§ä½¬é¢å‰çŒ®ä¸‘äº†ï¼Œå†™çš„çƒ‚çš„åœ°æ–¹ï¼Œè¯·è½»å–·ã€‚è¿˜è¯·å„ä½ä¸åèµæ•™ã€‚\nå…ˆæ”¾åœ°å€\ngethubï¼š https://github.com/lqxhub/easy_http\nGiteeï¼š https://gitee.com/lqxlucky/easy_http\nç®€å•ä»‹ç»ä¸€ä¸‹åŠŸèƒ½ ä½¿ç”¨ æ„é€ å™¨æ¨¡å¼ï¼Œæä¾›äº†é“¾å¼è°ƒç”¨å’Œæ–¹ä¾¿ä½¿ç”¨çš„æ¥å£ æ”¯æŒhttpsè‡ªå®šä¹‰æœåŠ¡å™¨è¯ä¹¦æ ¡éªŒå’ŒåŒå‘è¯ä¹¦æ ¡éªŒ æ”¯æŒä»£ç†,å¯ä»¥æ–¹ä¾¿çš„è®¾ç½®ä»£ç† å°è£…äº†multipart åè®®, å¯ä»¥æ–¹ä¾¿çš„ä¸Šä¼ æ–‡ä»¶ å…·æœ‰å¾ˆå¼ºçš„æ‹“å±•æ€§,å¯ä»¥åœ¨åŸºç¡€ä¸Šéå¸¸æ–¹ä¾¿çš„å®šåˆ¶è‡ªå·±httpè¯·æ±‚ æ”¯æŒhttpçš„ è¿”å›ç»“æœ å¼‚æ­¥å›è°ƒ å¯ä»¥æ–¹ä¾¿çš„è‡ªå®šä¹‰Response å®‰è£…åº“ å¯ä»¥ä½¿ç”¨githubçš„åº“,ä¹Ÿå¯ä½¿ç”¨Giteeçš„åº“ï¼Œä¸¤ä¸ªåº“çš„ä»£ç éƒ½æ˜¯ä¸€æ ·çš„ï¼Œå› ä¸ºgithubç½‘é€Ÿçš„åŸå› ï¼Œæ‰€ä»¥åœ¨giteeä¸Šä¹Ÿä¼ äº†ä¸€ä»½\ngithubï¼šgo get -u https://github.com/lqxhub/easy_http\ngiteeï¼š go get -u https://gitee.com/lqxlucky/easy_http\nä½¿ç”¨ å¼•å…¥åº“ å› ä¸ºgithubå’Œgiteeæ‹‰ä¸‹æ¥çš„åº“ç›®å½•ä¸åŒï¼Œæ‰€ä»¥ä»¥githubçš„ä¸ºå‡†\n1import \u0026#34;github.com/lqxhub/easy_http\u0026#34; å…·ä½“ä½¿ç”¨ å…¨éƒ¨é…ç½® 1func main() { 2\t//å¾—åˆ°ä¸€ä¸ªhttp clientçš„æ„é€ å™¨ 3\tbuilder := easy_http.NewClientBuilder() 4 5\t//æ˜¯å¦è·³è¿‡æœåŠ¡å™¨è¯ä¹¦æ ¡éªŒ 6\tbuilder.SkipVerify(false) 7 8\t//è®¾ç½®è¶…æ—¶æ—¶é—´ 9\tbuilder.TimeOut(time.Second * 5) 10 11\t//è®¾ç½®ä»£ç† 12\tbuilder.ProxyUrl(\u0026#34;http://127.0.0.1:10809\u0026#34;) 13 14\t//è®¾ç½®æ ¹è¯ä¹¦ 15\tvar certPool [1]string 16\tcertPool[0] = \u0026#34;D:\\\\server.pem\u0026#34; 17\tbuilder.Cert(certPool[:]) 18\t19\t//è®¾ç½®åŒå‘æ ¡éªŒè¯ä¹¦ 20\tvar tlsPath [1]*easy_http.TlsPath 21\ttlsPath[0] = \u0026amp;easy_http.TlsPath{ 22\tCertFile: \u0026#34;D:\\\\client.pem\u0026#34;, 23\tKeyFile: \u0026#34;D:\\\\client.key\u0026#34;, 24\t} 25\tbuilder.Tls(tlsPath[:]) 26 27\t//è®¾ç½®httpè¯·æ±‚header 28\theader := make(map[string]string) 29\theader[\u0026#34;Accept-Language\u0026#34;] = \u0026#34;Accept-Language: en,zh\u0026#34; 30\tbuilder.Header(header) 31 32\t//è®¾ç½®httpè¯·æ±‚cookie 33\tcookie := make(map[string]string) 34\tcookie[\u0026#34;name\u0026#34;] = \u0026#34;value\u0026#34; 35\tbuilder.Cookie(easy_http.EasyCookie(cookie)) 36 37\t//å¼€å¯cookie jar 38\tbuilder.Jar(nil) 39 40\t//è®¾ç½® Response å¤„ç†å‡½æ•° 41\tbuilder.BuildResponse(easy_http.EasyBuildResponse) 42 43\t//æ„é€ client 44\tclient, err := builder.Build() 45\tif err != nil { 46\tfmt.Println(\u0026#34;aa\u0026#34;, err) 47\treturn 48\t} 49} è¿™æ ·å°±åˆå§‹åŒ–ä¸€ä¸ªhttpçš„å®¢æˆ·ç«¯\nå½“ç„¶ï¼Œä¸Šé¢çš„ä¾‹å­æ˜¯è®¾ç½®äº†æ‰€æœ‰é…ç½®çš„ï¼Œä¹Ÿå¯ä»¥å…¨éƒ¨ä½¿ç”¨é»˜è®¤é…ç½®\nä½¿ç”¨é»˜è®¤é…ç½® 1func DefaultClient() { 2\tbuilder := easy_http.NewClientBuilder() 3\tclient, err := builder.Build() 4\tif err != nil { 5\tfmt.Println(err) 6\treturn 7\t} 8\tclient.Get(\u0026#34;http://baidu.com\u0026#34;) 9} è¿™æ ·åŒæ ·æ˜¯å¯ä»¥çš„\neasy å‡½æ•° ä½¿ç”¨ åº“ä¸­æä¾›äº†ä¸€äº›å‡½æ•°ï¼Œå¯ä»¥æ–¹ä¾¿çš„æ„é€ httpè¯·æ±‚ç›¸å…³çš„ç»“æ„\n1func EasyFunction() { 2 3\turl := \u0026#34;http://baidu.com\u0026#34; 4 5\t//åˆæˆhttp getçš„urlå’Œå‚æ•° 6\tvalues := make(map[string]string) 7\tvalues[\u0026#34;v\u0026#34;] = \u0026#34;123456\u0026#34; 8\teasy_http.EasyGet(url, values) 9 10\t//æ„é€ cookie 11\tcookie := make(map[string]string) 12\tcookie[\u0026#34;name\u0026#34;] = \u0026#34;value\u0026#34; 13\teasy_http.EasyCookie(cookie) 14 15\t//åˆæˆ http post çš„å‚æ•° 16\teasy_http.EasyPost(values) 17 18\t//æ„é€  ä¸Šä¼ æ–‡ä»¶çš„multipart 19\tmultipartBuilder := easy_http.NewMultipartBuilder() 20\tmultipartBuilder.AddFile(\u0026#34;file1\u0026#34;,\u0026#34;D:\\\\a.txt\u0026#34;) 21\tmultipartBuilder.AddFromDate(\u0026#34;name\u0026#34;,\u0026#34;value\u0026#34;) 22\tmultipartBuilder.AddBytes(\u0026#34;name2\u0026#34;,[]byte(\u0026#34;aaaaa\u0026#34;)) 23\tmultipart, err := multipartBuilder.Builder() 24\t25} å¼‚æ­¥å›è°ƒä½¿ç”¨ åº“å°è£…äº† å¼‚æ­¥å›è°ƒåŠŸèƒ½ï¼Œè¯·æ±‚ä¼šåœ¨ä¸€ä¸ªæ–°çš„goroutineä¸­è¿›è¡Œã€‚å½“httpè¯·æ±‚å®Œæˆæ—¶ï¼Œä¼šå›è°ƒå‡½æ•°ã€‚å›è°ƒå‡½æ•°å¯ç”¨å½¢å‚ä½¿ç”¨ä¼ å…¥å‡½æ•°å’Œå®ç°æ¥å£ä¸¤ç§æ–¹å¼\n1 2func Call(response easy_http.IResponse) { 3\tfmt.Println(response.Error()) 4\tfmt.Println(response.StatusCode()) 5\tfmt.Println(string(response.Content())) 6} 7 8type Get struct { 9} 10 11func (g Get) EasyResponseCallback(response easy_http.IResponse) { 12\tfmt.Println(response.Error()) 13\tfmt.Println(response.StatusCode()) 14\tfmt.Println(string(response.Content())) 15} 16 17func AsynchronousRequest() { 18\turl := \u0026#34;http://baidu.com\u0026#34; 19\tclient, err := easy_http.NewClientBuilder().Build() 20\tif err != nil { 21\tfmt.Println(err) 22\treturn 23\t} 24 25\t//å‡½æ•°å¼‚æ­¥å›è°ƒ 26\tclient.GetAsyn(url, Call) 27 28\t//æ¥å£å¼‚æ­¥å›è°ƒ 29\tclient.GetAsynWithCallback(url, \u0026amp;Get{}) 30} è‡ªå®šä¹‰è¯·æ±‚ å› ä¸ºåº“ä¸­åªå°è£…äº† GETå’ŒPOSTè¿™ä¸¤ç§æ–¹å¼ï¼Œå‘PUTï¼ŒDELETEç­‰è¿™äº›æ–¹å¼éœ€è¦è‡ªå·±å»å®ç°ã€‚æ‰€ä»¥ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‡½æ•°æ¥å®ç°\n1func Call(response easy_http.IResponse) { 2\tfmt.Println(response.Error()) 3\tfmt.Println(response.StatusCode()) 4\tfmt.Println(string(response.Content())) 5} 6 7func CustomizeRequest() { 8\turl := \u0026#34;http://baidu.com\u0026#34; 9\tclient, err := easy_http.NewClientBuilder().Build() 10\tif err != nil { 11\tfmt.Println(err) 12\treturn 13\t} 14\tresponse := client.SendWithMethod(url, http.MethodPut, nil, func(request *http.Request) { 15\t//ä¿®æ”¹Request 16\t}) 17\tfmt.Println(response.Error()) 18\tfmt.Println(response.StatusCode()) 19 20\t//å¼‚æ­¥æ–¹å¼ 21\tclient.SendWithMethodCallBack(url, http.MethodPut, nil, func(request *http.Request) { 22\t//ä¹ æƒ¯Request 23\t}, Call) 24} ä½¿ç”¨go httpé»˜è®¤çš„å‡½æ•°è¯·æ±‚ å½“éœ€è¦æœ‰ä¸€äº›ç‰¹æ®Šçš„è¯·æ±‚ï¼Œè¿™ä¸ªåº“æ— æ³•æ»¡è¶³æ—¶ï¼Œå¯ä»¥ä½¿ç”¨go httpåŸç”Ÿçš„æ–¹å¼æ¥è¯·æ±‚\n1func Primitive() { 2\turl := \u0026#34;http://baidu.com\u0026#34; 3\tclient, err := easy_http.NewClientBuilder().Build() 4\tif err != nil { 5\tfmt.Println(err) 6\treturn 7\t} 8\t//è·å–Request 9\trequest, err := http.NewRequest(http.MethodGet, url, nil) 10\tif err != nil { 11\tfmt.Println(err) 12\treturn 13\t} 14\t//å¾—åˆ°httpçš„åŸç”ŸResponse 15\tresponse, err := client.DoRequest(request) 16\tif err != nil { 17\tfmt.Println(err) 18\treturn 19\t} 20\tfmt.Println(response) 21} è‡ªå®šä¹‰Response åº“ä¸­è¿”å›çš„Responseæ˜¯ä¸€ä¸ªæ¥å£ç±»å‹ï¼Œåªè¦å®ç°äº†è¿™ä¸ªæ¥å£ï¼Œéƒ½å¯ä½œä¸ºè¿”å›å€¼è¿”å›ï¼Œè‡ªå®šä¹‰çš„Responseï¼Œåœ¨æ„é€ clientçš„è®¾ç½®å°±å¯ä»¥äº†\n1type MyResponse struct { 2} 3 4func (m MyResponse) Error() error { 5\treturn nil 6} 7 8func (m MyResponse) StatusCode() int { 9\treturn 0 10} 11 12func (m MyResponse) Header() http.Header { 13\treturn nil 14} 15 16func (m MyResponse) ContentLength() int64 { 17\treturn 0 18} 19 20func (m MyResponse) Content() []byte { 21\treturn nil 22} 23 24func (m MyResponse) Resp() *http.Response { 25\treturn nil 26} 27 28func (m MyResponse) Request() *http.Request { 29\treturn nil 30} 31 32func (m MyResponse) Cookie(name string) *http.Cookie { 33\treturn nil 34} 35 36//æ„é€ HTTP responseçš„å‡½æ•° 37func MyBuildResponse(resp *http.Response, err error) easy_http.IResponse { 38\tresponse := new(MyResponse) 39 //åšå¤„ç† 40\treturn response 41} 42func CustomizeResponse() { 43\tclient, err := easy_http.NewClientBuilder(). 44\tBuildResponse(MyBuildResponse). 45\tBuild() 46\tif err != nil { 47\tfmt.Println(err) 48\treturn 49\t} 50} ç»“æ„ä½“ MyResponse å®ç°äº† easy_http.IResponse è¿™ä¸ªæ¥å£ã€‚ç„¶ååœ¨MyBuildResponseè¿™ä¸ªå‡½æ•°ä¸­ï¼Œnew ä¸€ä¸ª MyResponseçš„å¯¹è±¡ï¼Œå†æ ¹æ®è‡ªå·±çš„éœ€è¦ï¼Œåšç›¸åº”çš„å¤„ç†å°±å¯ä»¥äº†ã€‚ åœ¨clientBuilder.BuildResponse(MyBuildResponse)è®¾ç½®å°±å¯ä»¥äº†\næœ€å æ•´ä¸ªåº“çš„åŸºæœ¬åŠŸèƒ½å°±æ˜¯è¿™äº›äº†ã€‚ç¬¬ä¸€é€ è½®å­ï¼Œå†™çš„å¾ˆçƒ‚ã€‚å†™è¿™ç¯‡æ–‡ç« æ—¶ï¼Œè¿˜å‘ç°äº†å¥½å‡ ä¸ªå› ä¸ºé¦–å­—æ¯å°å†™å¯¼è‡´çš„é—®é¢˜ã€‚\næœ‰é—®é¢˜çš„åœ°æ–¹ï¼Œè¿˜è¯·ä¸åèµæ•™\n","date":"2021-03-13T17:40:55Z","permalink":"https://lqxhub.github.io/posts/19d697e6/","title":"golangé€ è½®å­ å°è£…ä¸€ä¸ªç®€å•çš„http client"},{"content":"å·¥ä½œä¸­ç»å¸¸éœ€è¦å†™shellè„šæœ¬æ¥å¤„ç†ä¸€äº›é‡å¤çš„ä¸œè¥¿ï¼Œä½¿ç”¨è„šæœ¬è‡ªåŠ¨ç¼–è¯‘ï¼Œä½¿ç”¨è„šæœ¬å¤šæœºå™¨ä¼ è¾“æ–‡ä»¶ã€‚\nå› ä¸ºä¸æ˜¯å¤©å¤©å†™shellï¼Œåªæ˜¯ç”¨åˆ°çš„æ—¶å€™å†™ä¸€ä¸ªï¼Œå†åŠ ä¸Šè„šæœ¬ä¸­çš„ifçš„åˆ¤æ–­æ¡ä»¶æœ‰ç‚¹å¤šï¼Œå®¹æ˜“å¿˜è®°ï¼Œæ‰€ä»¥åšä¸ªå¤‡å¿˜å½•ï¼Œä»¥å¤‡ä¸æ—¶ä¹‹éœ€\nå…ˆè¯´ä¸€ä¸‹ if è¡¨è¾¾å¼çš„åŸºæœ¬è¯­æ³• 1if [ command ]; then 2 ç¬¦åˆè¯¥æ¡ä»¶æ‰§è¡Œçš„è¯­å¥ 3fi 1if [ command ];then 2 ç¬¦åˆè¯¥æ¡ä»¶æ‰§è¡Œçš„è¯­å¥ 3elif [ command ];then 4 ç¬¦åˆè¯¥æ¡ä»¶æ‰§è¡Œçš„è¯­å¥ 5else 6 ç¬¦åˆè¯¥æ¡ä»¶æ‰§è¡Œçš„è¯­å¥ 7fi æ³¨æ„ï¼š\nif æ¡ä»¶ è¦ä»¥ fi ç»“æŸ [] ifè¯­å¥ä¸­ å’Œ è¡¨è¾¾å¼è¦æ³¨æ„ç©ºæ ¼ then å’Œ fi æ˜¯åˆ†å¼€çš„è¯­å¥ã€‚å¦‚æœè¦åœ¨åŒä¸€è¡Œé‡Œé¢è¾“å…¥ï¼Œåˆ™éœ€è¦ç”¨åˆ†å·å°†ä»–ä»¬éš”å¼€ ä½¿ç”¨ -z æˆ–è€… -n æ¥æ£€æŸ¥é•¿åº¦çš„æ—¶å€™ï¼Œæ²¡æœ‰å®šä¹‰çš„å˜é‡ä¹Ÿä¸º0 ä¸‹é¢æ˜¯å¸¸ç”¨è¡¨è¾¾å¼ æ•°å­—åˆ¤æ–­ è¡¨è¾¾å¼ å«ä¹‰ int1 -eq int2 ä¸¤æ•°ç›¸ç­‰ä¸ºçœŸ int1 -ne int2 ä¸¤æ•°ä¸ç­‰ä¸ºçœŸ int1 -gt int2 int1å¤§äºint2ä¸ºçœŸ int1 -ge int2 int1å¤§äºç­‰äºint2ä¸ºçœŸ int1 -lt int2 int1å°äºint2ä¸ºçœŸ int1 -le int2 int1å°äºç­‰äºint2ä¸ºçœŸ é€»è¾‘ç›¸å…³ è¡¨è¾¾å¼ å«ä¹‰ -a ä¸ -oã€€æˆ– ! é å­—ç¬¦ä¸²ç›¸å…³ è¡¨è¾¾å¼ å«ä¹‰ STRINGã€€å½“ä¸²str1ä¸ºéç©ºæ—¶ä¸ºçœŸ -z STRING â€œSTRINGâ€ çš„é•¿åº¦ä¸ºé›¶åˆ™ä¸ºçœŸ -n STRING â€œSTRINGâ€ çš„é•¿åº¦ä¸ºéé›¶ non-zeroåˆ™ä¸ºçœŸ STRING1 == STRING2 å¦‚æœ2ä¸ªå­—ç¬¦ä¸²ç›¸åŒåˆ™ä¸ºçœŸ STRING1 != STRING2 å¦‚æœå­—ç¬¦ä¸²ä¸ç›¸ç­‰åˆ™ä¸º æ–‡ä»¶ç›¸å…³ è¡¨è¾¾å¼ å«ä¹‰ -a FILE å¦‚æœ FILE å­˜åœ¨åˆ™ä¸ºçœŸ -b FILE å¦‚æœ FILE å­˜åœ¨ä¸”æ˜¯ä¸€ä¸ªå—ç‰¹æ®Šæ–‡ä»¶åˆ™ä¸ºçœŸ -c FILE å¦‚æœ FILE å­˜åœ¨ä¸”æ˜¯ä¸€ä¸ªå­—ç‰¹æ®Šæ–‡ä»¶åˆ™ä¸ºçœŸ -d FILE å¦‚æœ FILE å­˜åœ¨ä¸”æ˜¯ä¸€ä¸ªç›®å½•åˆ™ä¸ºçœŸ -e FILE å¦‚æœ FILE å­˜åœ¨åˆ™ä¸ºçœŸ -f FILE å¦‚æœ FILE å­˜åœ¨ä¸”æ˜¯ä¸€ä¸ªæ™®é€šæ–‡ä»¶åˆ™ä¸ºçœŸ -g FILE å¦‚æœ FILE å­˜åœ¨ä¸”å·²ç»è®¾ç½®äº†SGIDåˆ™ä¸ºçœŸ -h FILE å¦‚æœ FILE å­˜åœ¨ä¸”æ˜¯ä¸€ä¸ªç¬¦å·è¿æ¥åˆ™ä¸ºçœŸ -k FILE å¦‚æœ FILE å­˜åœ¨ä¸”å·²ç»è®¾ç½®äº†ç²˜åˆ¶ä½åˆ™ä¸ºçœŸ -p FILE å¦‚æœ FILE å­˜åœ¨ä¸”æ˜¯ä¸€ä¸ªåå­—ç®¡é“(Få¦‚æœO)åˆ™ä¸ºçœŸ -r FILE å¦‚æœ FILE å­˜åœ¨ä¸”æ˜¯å¯è¯»çš„åˆ™ä¸ºçœŸ -s FILE å¦‚æœ FILE å­˜åœ¨ä¸”å¤§å°ä¸ä¸º0åˆ™ä¸ºçœŸ -t FD å¦‚æœæ–‡ä»¶æè¿°ç¬¦ FD æ‰“å¼€ä¸”æŒ‡å‘ä¸€ä¸ªç»ˆç«¯åˆ™ä¸ºçœŸ -u FILE å¦‚æœ FILE å­˜åœ¨ä¸”è®¾ç½®äº†SUID (set user ID)åˆ™ä¸ºçœŸ -w FILE å¦‚æœ FILE å¦‚æœ FILE å­˜åœ¨ä¸”æ˜¯å¯å†™çš„åˆ™ä¸ºçœŸ -x FILE å¦‚æœ FILE å­˜åœ¨ä¸”æ˜¯å¯æ‰§è¡Œçš„åˆ™ä¸ºçœŸ -O FILE å¦‚æœ FILE å­˜åœ¨ä¸”å±æœ‰æ•ˆç”¨æˆ·IDåˆ™ä¸ºçœŸ -G FILE å¦‚æœ FILE å­˜åœ¨ä¸”å±æœ‰æ•ˆç”¨æˆ·ç»„åˆ™ä¸ºçœŸ -L FILE å¦‚æœ FILE å­˜åœ¨ä¸”æ˜¯ä¸€ä¸ªç¬¦å·è¿æ¥åˆ™ä¸ºçœŸ -S FILE å¦‚æœ FILE å­˜åœ¨ä¸”æ˜¯ä¸€ä¸ªå¥—æ¥å­—åˆ™ä¸ºçœŸ FILE1 -ot FILE2 å¦‚æœ FILE1 æ¯” FILE2 è¦è€, æˆ–è€… FILE2 å­˜åœ¨ä¸” FILE1 ä¸å­˜åœ¨åˆ™ä¸ºçœŸ FILE1 -ef FILE2 å¦‚æœ FILE1 å’Œ FILE2 æŒ‡å‘ç›¸åŒçš„è®¾å¤‡å’ŒèŠ‚ç‚¹å·åˆ™ä¸ºçœŸ -o OPTIONNAME å¦‚æœ shellé€‰é¡¹ â€œOPTIONNAMEâ€ å¼€å¯åˆ™ä¸ºçœŸ ","date":"2021-03-13T11:27:54Z","permalink":"https://lqxhub.github.io/posts/6cd27815/","title":"linux shell è„šæœ¬ å¸¸ç”¨çš„ifåˆ¤æ–­æ¡ä»¶"},{"content":"ä½¿ç”¨goæŸ¥è¯¢æ•°æ®åº“æ—¶ï¼Œæœ‰æ—¶å€™ä¼šé‡åˆ° **scan error sql: Scan error on column index XXXXX unsupported Scan, storing driver.Value type **è¿™ä¸ªé”™è¯¯ï¼Œ\nè¿™ä¸ªé”™è¯¯äº§ç”Ÿçš„åŸå› æ˜¯ï¼ŒæŸ¥è¯¢çš„ç»“æœä¸­æœ‰çš„å€¼æ˜¯NULL ï¼Œ å¯¼è‡´åœ¨è¯»æŸ¥è¯¢ç»“æœæ—¶ï¼Œé‡åˆ°NUL ç±»å‹çš„æ•°å€¼ï¼Œæ— æ³•æ­£ç¡®è¯»å‡ºæ•°å€¼ ç°åœ¨é€šè¿‡ä¸€ä¸ªç®€å•çš„ä¾‹å­å¤ç°ä¸€ä¸‹ å…ˆåˆ›å»ºä¸€ä¸ªç®€å•çš„è¡¨\n1CREATE TABLE `user` ( 2 `id` int(11) NOT NULL, 3 `name` varchar(255) DEFAULT NULL, 4 PRIMARY KEY (`id`) 5) ENGINE=InnoDB DEFAULT CHARSET=utf8; å…¶ä¸­ nameè¿™ä¸ªå­—æ®µé»˜è®¤æ˜¯NULL çš„ï¼Œç°åœ¨æ’å…¥å‡ æ¡æ•°æ®\n1 insert into user(`id`,`name`) values(1,\u0026#39;A\u0026#39;); 2 insert into user(`id`,`name`) values(2,\u0026#39;B\u0026#39;); 3 insert into user(`id`,`name`) values(3,NULL); goä»£ç \n1package main 2 3import ( 4\t\u0026#34;database/sql\u0026#34; 5\t\u0026#34;fmt\u0026#34; 6\t_ \u0026#34;github.com/go-sql-driver/mysql\u0026#34; 7) 8 9type User struct { 10\tid uint32 11\tname string 12} 13 14func main() { 15\tdb := Conn() 16\tif db == nil { 17\treturn 18\t} 19\tresult := make([]*User, 0, 10) 20\tq := \u0026#34;SELECT `id`, `name` FROM `user`\u0026#34; 21\tif rows, err := db.Query(q); err == nil { 22\tfor rows.Next() { 23\tid := uint32(0) 24\tname := \u0026#34;\u0026#34; 25\tif err := rows.Scan(\u0026amp;id, \u0026amp;name); err == nil { 26\tresult = append(result, \u0026amp;User{ 27\tid: id, 28\tname: name, 29\t}) 30\t} else { 31\tfmt.Println(\u0026#34;rows scan error\u0026#34;, err) 32\t} 33\t} 34\t} else { 35\tfmt.Println(\u0026#34;query error\u0026#34;, err) 36\t} 37\tfor _, v := range result { 38\tfmt.Println(v) 39\t} 40} 41 42func Conn() *sql.DB { 43\tdb, err := sql.Open(\u0026#34;mysql\u0026#34;, \u0026#34;root:123456@tcp(127.0.0.1)/go_test\u0026#34;) 44\tif err != nil { 45\tfmt.Print(\u0026#34;sql open error\u0026#34;, err) 46\treturn nil 47\t} 48\terr2 := db.Ping() 49\tif err2 != nil { 50\tfmt.Print(\u0026#34;sql pin error\u0026#34;, err2) 51\treturn nil 52\t} 53\treturn db 54} è¿è¡Œåï¼ŒæŠ¥é”™ è¿™ä¸ªé”™è¯¯æœ‰ä¸¤ç§è§£å†³åŠæ³•\nä»æ•°æ®å±‚é¢è§£å†³ï¼ŒæŠŠnameå­—æ®µè®¾ç½®ä¸ºéç©ºå­—æ®µï¼Œå¹¶ä¸”é»˜è®¤å€¼è®¾ç½®ä¸º**\u0026quot;\u0026quot;**ç©ºå­—ç¬¦ä¸²ï¼Œé—®é¢˜å°±è§£å†³äº† æ”¹ä¸€ä¸‹è¡¨ 1CREATE TABLE `user` ( 2 `id` int(11) NOT NULL, 3 `name` varchar(255) NOT NULL DEFAULT \u0026#39;\u0026#39;, 4 PRIMARY KEY (`id`) 5) ENGINE=InnoDB DEFAULT CHARSET=utf8; æŸ¥è¯¢ç»“æœæ˜¯æ­£å¸¸çš„ å¯¹äºä¸€äº›ç‰¹æ®Šçš„æŸ¥è¯¢ï¼Œç»“æœä¸­éš¾å…ä¼šæœ‰NULLå€¼ï¼Œæ¯”å¦‚è¿æ¥æŸ¥è¯¢ç­‰ç­‰ï¼Œè¿™æ—¶å€™éœ€è¦ç”¨ç¬¬äºŒç§æ–¹å¼æ¥è§£å†³ 2. ä½¿ç”¨go æä¾›çš„ sql.NullStringç±»å‹å€¼æ¥ç»“å±€ï¼Œè¿™ä¸ªæ˜¯stringç±»å‹çš„ï¼Œ go è¿˜æä¾›äº†å…¶ä»–ç±»å‹çš„ï¼Œè¿˜æœ‰NullBoolboolç±»å‹çš„ï¼ŒNullFloat64float64ç±»å‹çš„ï¼ŒNullInt64 int64ç±»å‹çš„\nä¸ºäº†æ–¹ä¾¿ï¼Œè¿˜æ˜¯æŠŠè¡¨æ”¹å›æœ€å¼€å§‹ï¼Œnameé»˜è®¤æ˜¯NULLç±»å‹çš„ ä¿®æ”¹ä¸€ä¸‹ä»£ç \n1\tresult := make([]*User, 0, 10) 2\tq := \u0026#34;SELECT `id`, `name` FROM `user`\u0026#34; 3\tif rows, err := db.Query(q); err == nil { 4\tfor rows.Next() { 5\tid := uint32(0) 6\tvar name sql.NullString 7\tif err := rows.Scan(\u0026amp;id, \u0026amp;name); err == nil { 8\tu := \u0026amp;User{ 9\tid: id, 10\t} 11\tif name.Valid { 12\tu.name = name.String 13\t} else { 14\tu.name = \u0026#34;\u0026#34; 15\t} 16\tresult = append(result, u) 17\t} else { 18\tfmt.Println(\u0026#34;rows scan error\u0026#34;, err) 19\t} 20\t} 21\t} else { 22\tfmt.Println(\u0026#34;query error\u0026#34;, err) 23\t} æŠŠ name çš„ç±»å‹æ”¹ä¸º sql.NullString å¹¶ä¸”åœ¨æŸ¥è¯¢å®Œæˆåï¼Œåˆ¤æ–­ä¸€ä¸‹nameæ˜¯å¦æœ‰æ•ˆ\nçœ‹ä¸€ä¸‹ç»“æœ æ²¡æœ‰é—®é¢˜\nåˆ°è¿™é—®é¢˜è§£å†³äº†\n","date":"2020-06-21T11:27:54Z","permalink":"https://lqxhub.github.io/posts/5c491bc1/","title":"goæ•°æ®åº“æŸ¥è¯¢ unsupported Scan"},{"content":"golangè¿™é—¨è¯­è¨€ï¼Œæœ‰ä¸ªæ¯”è¾ƒå¥½çš„ç‰¹æ€§ï¼Œå°±æ˜¯æ”¯æŒå‡½æ•°çš„å¤šè¿”å›å€¼ã€‚æƒ³Cï¼ŒC++ï¼ŒJavaç­‰è¿™äº›è¯­è¨€ï¼Œæ˜¯ä¸æ”¯æŒå‡½æ•°å¤šè¿”å›çš„ã€‚ä½†æ˜¯Cï¼ŒC++å¯ä»¥ä½¿ç”¨ä¼ é€’æŒ‡é’ˆï¼Œå®ç°å‡½æ•°å¤šè¿”å›ã€‚ä½†æ˜¯ï¼Œä½ æœ‰æ²¡æœ‰æƒ³è¿‡ï¼Œgolangæ˜¯æ€æ ·å®ç°å‡½æ•°å¤šè¿”å›å€¼çš„å‘¢ï¼Ÿ æˆ‘ä»¬çŸ¥é“ï¼ŒCï¼ŒC++æ˜¯é€šè¿‡å¯„å­˜å™¨å®ç°å‡½æ•°è¿”å›å€¼çš„ï¼Œä¹Ÿå°±æ˜¯å…ˆæŠŠè¿”å›å€¼å†™å…¥åˆ°ä¸€ä¸ªå¯„å­˜å™¨ä¸­ï¼Œç„¶åå†ä»å¯„å­˜å™¨ä¸­ï¼Œè¯»åˆ°å‡½æ•°çš„è¿”å›å€¼ã€‚golangä¹Ÿæ˜¯è¿™æ ·å®ç°çš„å—ï¼Ÿ\nä¼Ÿå¤§çš„æ€æƒ³å®¶å­”å­æ›¾è¯´è¿‡ï¼Œåœ¨æºç é¢å‰ä¸€åˆ‡éƒ½å¦‚åŒè£¸å¥”ã€‚åæ¥ï¼Œé²è¿…å…ˆç”Ÿï¼Œæ€»ç»“äº†å­”å­çš„æ€æƒ³ï¼Œè¯´å‡ºäº†ï¼Œåœ¨æ±‡ç¼–é¢å‰ï¼Œä¸€åˆ‡è¯­æ³•éƒ½æ˜¯çº¸è€è™ã€‚\nä¸‹é¢æˆ‘ä»¬é€šè¿‡golangçš„æ±‡ç¼–æŒ‡ä»¤ï¼Œæ¥çœ‹ä¸€ä¸‹golangæ˜¯æ€æ ·å®ç°å‡½æ•°çš„å¤šè¿”å›å€¼çš„\nåœ¨çœ‹æ±‡ç¼–ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆç”¨goçš„debugå‡½æ•°çœ‹ä¸‹å‡½æ•°çš„æ ˆä¿¡æ¯ ä»£ç å¾ˆç®€å•ï¼Œä¸ç”¨è§£é‡Šäº†\n1package main 2 3import ( 4\t\u0026#34;fmt\u0026#34; 5\t\u0026#34;runtime/debug\u0026#34; 6) 7 8func main() { 9\tone(3) 10} 11 12func one(a int) (int, int) { 13\tfmt.Println(string(debug.Stack())) 14\treturn a, a + 5 15} æˆ‘æ ‡çº¢çš„è¿™ä¸€è¡Œï¼Œå°±æ˜¯one å‡½æ•°çš„æ ˆä¿¡æ¯ï¼Œç¬¬ä¸€ä¸ªå‚æ•° 0x3 å¾ˆå¥½ç†è§£ï¼Œå°±æ˜¯æˆ‘ä»¬ä¼ å…¥çš„å‚æ•°3ï¼Œ ä½†æ˜¯åé¢è¿™ä¸¤ä¸ªæ˜¯å•¥ï¼Ÿè¿˜æœ‰ï¼Œæˆ‘æ˜æ˜åªä¼ äº†ä¸€ä¸ªå‚æ•°ï¼Œä¸ºå•¥ä¼šä¼ å…¥ä¸‰ä¸ªå‚æ•°ï¼Ÿ\nåˆ°è¿™é‡Œï¼Œæˆ‘ä¹Ÿå°±ä¸å–å…³å­äº†ï¼Œç›´æ¥è¯´äº†ï¼Œåé¢è¿™ä¸¤ä¸ªå‚æ•°ï¼Œå°±æ˜¯oneå‡½æ•°è¿”å›å€¼çš„åœ°å€ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œoneå‡½æ•°è¿”å›å€¼åœ°å€ä¸åœ¨oneå‡½æ•°ä¸­ï¼Œè€Œæ˜¯åœ¨è°ƒç”¨oneå‡½æ•°çš„mianå‡½æ•°ä¸­ã€‚golangçš„å‡½æ•°è¿”å›å€¼ï¼Œå’ŒCï¼ŒC++çš„ä¸åŒï¼Œgolangçš„è¿”å›å€¼æ˜¯é€šè¿‡æ ˆå†…åœ°å€å®ç°çš„ï¼ˆè¿”å›å€¼çš„åœ°å€æ˜¯ç”±å‡½æ•°è°ƒç”¨è€…æä¾›ï¼‰ã€‚\n1package main 2 3func main() { 4\tvar b, c *int 5\tone(3, b, c) 6} 7 8func one(a int, b, c *int) { 9} ä¹Ÿå°±æ˜¯è¯´ï¼Œåˆšå¼€å§‹çš„é‚£æ®µä»£ç ï¼Œå’Œè¿™æ®µåœ¨åŠŸèƒ½å®ç°ä¸Šï¼Œæ²¡æœ‰ä»€ä¹ˆå·®åˆ«ï¼Œåªæ˜¯golangç¼–è¯‘å™¨æä¾›çš„ä¸€ä¸ªè¯­æ³•ç³–ã€‚\nä¸‹é¢é€šè¿‡æ±‡ç¼–æ¥çœ‹ä¸€ä¸‹ è¿™æ¬¡æˆ‘ä»¬ä¸æ˜¯å¯¹æ·±å…¥åˆ†ægolangçš„æ±‡ç¼–ï¼Œåªæ˜¯ä»æ±‡ç¼–å±‚é¢ï¼ŒéªŒè¯æˆ‘ä»¬ä¹‹å‰ç»“è®ºï¼ˆgolangå‡½æ•°å¤šè¿”å›é—®é¢˜ï¼‰ æ‰€ä»¥ï¼Œä¸ä¼šæ­»ç£•plan9æ±‡ç¼–è¯­æ³•ï¼Œè¯´å®è¯ï¼Œplan9çš„å¾ˆå¤šçŸ¥è¯†æˆ‘ä¹Ÿä¸æ‡‚ï¼Œå¤§å­¦æ²¡å¼€è¿‡æ±‡ç¼–çš„è¯¾ç¨‹ï¼Œè¿™äº›ä¸œè¥¿éƒ½æ˜¯å› ä¸ºå…´è¶£è‡ªå­¦çš„ã€‚\ngolangç”¨çš„æ˜¯plan9æ±‡ç¼–ï¼Œçœ‹plan9ä¹‹å‰ï¼Œå…ˆäº†è§£ä¸€ä¸‹plan9çš„å‡ ä¸ªæ¦‚å¿µ\ngoæ±‡ç¼–ä¸­æœ‰4ä¸ªä¼ªå¯„å­˜å™¨\nFP: Frame pointerï¼ŒæŒ‡å‘æ ˆåº•ä½ç½®ï¼Œä¸€èˆ¬ç”¨æ¥å¼•ç”¨å‡½æ•°çš„è¾“å…¥å‚æ•°ï¼Œç”¨æ¥è®¿é—®å‡½æ•°çš„å‚æ•° PC: Program counter: ç¨‹åºè®¡æ•°å™¨ï¼Œç”¨äºåˆ†æ”¯å’Œè·³è½¬ SB: Static base pointer: ä¸€èˆ¬ç”¨äºå£°æ˜å‡½æ•°æˆ–è€…å…¨å±€å˜é‡ SP: Stack pointerï¼šæŒ‡å‘å½“å‰æ ˆå¸§çš„å±€éƒ¨å˜é‡çš„å¼€å§‹ä½ç½®(æ ˆé¡¶ä½ç½®)ï¼Œä¸€èˆ¬ç”¨æ¥å¼•ç”¨å‡½æ•°çš„å±€éƒ¨å˜é‡ æˆ‘ä»¬ç”¨è¿™æ®µä»£ç è¿›è¡Œæ±‡ç¼–\n1package main 2 3func main() { 4\tone(3) 5} 6 7func one(a int) (int, int) { 8\treturn a, a + 5 9} ä½¿ç”¨ go tool compile -N -l -S main.go å¾—åˆ°æ±‡ç¼–ä»£ç \n1\u0026#34;\u0026#34;.main STEXT nosplit size=2 args=0x0 locals=0x0 2 0x0000 00000 (C:\\Users\\bruce\\Desktop\\go\\main.go:3) TEXT \u0026#34;\u0026#34;.main(SB), NOSPLIT|ABIInternal, $0-0 3 0x0000 00000 (C:\\Users\\bruce\\Desktop\\go\\main.go:3) FUNCDATA $0, gclocalsÂ·33cdeccccebe80329f1fdbee7f5874cb(SB) 4 0x0000 00000 (C:\\Users\\bruce\\Desktop\\go\\main.go:3) FUNCDATA $1, gclocalsÂ·33cdeccccebe80329f1fdbee7f5874cb(SB) 5 0x0000 00000 (C:\\Users\\bruce\\Desktop\\go\\main.go:3) FUNCDATA $3, gclocalsÂ·33cdeccccebe80329f1fdbee7f5874cb(SB) 6 0x0000 00000 (C:\\Users\\bruce\\Desktop\\go\\main.go:4) PCDATA $2, $0 7 0x0000 00000 (C:\\Users\\bruce\\Desktop\\go\\main.go:4) PCDATA $0, $0 8 0x0000 00000 (C:\\Users\\bruce\\Desktop\\go\\main.go:4) XCHGL AX, AX 9 0x0001 00001 (\u0026lt;unknown line number\u0026gt;) RET 10 0x0000 90 c3 .. 11\u0026#34;\u0026#34;.one STEXT nosplit size=20 args=0x18 locals=0x0 12 0x0000 00000 (C:\\Users\\bruce\\Desktop\\go\\main.go:7) TEXT \u0026#34;\u0026#34;.one(SB), NOSPLIT|ABIInternal, $0-24 13 0x0000 00000 (C:\\Users\\bruce\\Desktop\\go\\main.go:7) FUNCDATA $0, gclocalsÂ·33cdeccccebe80329f1fdbee7f5874cb(SB) 14 0x0000 00000 (C:\\Users\\bruce\\Desktop\\go\\main.go:7) FUNCDATA $1, gclocalsÂ·33cdeccccebe80329f1fdbee7f5874cb(SB) 15 0x0000 00000 (C:\\Users\\bruce\\Desktop\\go\\main.go:7) FUNCDATA $3, gclocalsÂ·33cdeccccebe80329f1fdbee7f5874cb(SB) 16 0x0000 00000 (C:\\Users\\bruce\\Desktop\\go\\main.go:8) PCDATA $2, $0 17 0x0000 00000 (C:\\Users\\bruce\\Desktop\\go\\main.go:8) PCDATA $0, $0 18 0x0000 00000 (C:\\Users\\bruce\\Desktop\\go\\main.go:8) MOVQ \u0026#34;\u0026#34;.a+8(SP), AX 19 0x0005 00005 (C:\\Users\\bruce\\Desktop\\go\\main.go:8) MOVQ AX, \u0026#34;\u0026#34;.~r1+16(SP) 20 0x000a 00010 (C:\\Users\\bruce\\Desktop\\go\\main.go:8) ADDQ $5, AX 21 0x000e 00014 (C:\\Users\\bruce\\Desktop\\go\\main.go:8) MOVQ AX, \u0026#34;\u0026#34;.~r2+24(SP) 22 0x0013 00019 (C:\\Users\\bruce\\Desktop\\go\\main.go:8) RET 23 0x0000 48 8b 44 24 08 48 89 44 24 10 48 83 c0 05 48 89 H.D$.H.D$.H...H. 24 0x0010 44 24 18 c3 D$.. æˆ‘åªæˆªå–äº†å’Œmainï¼Œoneå‡½æ•°ç›¸å…³çš„éƒ¨åˆ† TEXT \u0026quot;\u0026quot;.one(SB), NOSPLIT|ABIInternal, $0-24è¿™è¡Œæœ€åï¼Œ $0-24 çš„å«ä¹‰ï¼Œ0ä»£è¡¨oneå‡½æ•°çš„æ ˆå¸§å¤§å°(å±€éƒ¨å˜é‡+å¯èƒ½éœ€è¦çš„é¢å¤–è°ƒç”¨å‡½æ•°çš„å‚æ•°ç©ºé—´çš„æ€»å¤§å°)ï¼Œ å› ä¸ºoneå‡½æ•°ä¸­æ²¡æœ‰é¢å¤–å¼€é”€ï¼Œæ‰€æœ‰å¤§å°æ˜¯0ï¼Œ24æ˜¯ä¼ å…¥å‚æ•°å’Œè¿”å›å€¼çš„å¤§å°ï¼Œå•ä½æ˜¯å­—èŠ‚ã€‚ä¼ å…¥çš„å‚æ•°å’Œè¿”å›å€¼éƒ½æ˜¯intï¼Œåœ¨64ä½æœºå™¨ä¸Šï¼Œå¤§å°æ˜¯8ä¸ªå­—èŠ‚ï¼Œ64ä½ã€‚\nç®€å•ç”»ä¸€ä¸‹æ ˆçš„ç¤ºæ„å›¾\nçœ‹ä¸€ä¸‹è¿™å¥ 0x0000 00000 (C:\\Users\\bruce\\Desktop\\go\\main.go:8) MOVQ \u0026quot;\u0026quot;.a+8(SP), AX\nSP å¯„å­˜å™¨æŒ‡å‘çš„æ˜¯æ ˆé¡¶çš„ä½ç½®ï¼ŒAX æ˜¯ä¸€ä¸ªé€šç”¨å¯„å­˜å™¨ MOVQ æŒ‡ä»¤ æŠŠ å‚æ•°a ä¹Ÿå°±æ˜¯(SP+8)çš„å€¼æ¬åˆ°AXä¸­\n0x0005 00005 (C:\\Users\\bruce\\Desktop\\go\\main.go:8) MOVQ AX, \u0026quot;\u0026quot;.~r1+16(SP)\nåŒæ ·ï¼ŒæŠŠAXä¸­çš„å€¼æ¬åˆ°r1ï¼ˆè¿”å›å€¼bï¼‰\n0x000a 00010 (C:\\Users\\bruce\\Desktop\\go\\main.go:8) ADDQ $5, AX ADDQæŒ‡ä»¤æŠŠAXå€¼+5\n0x000e 00014 (C:\\Users\\bruce\\Desktop\\go\\main.go:8) MOVQ AX, \u0026quot;\u0026quot;.~r2+24(SP) æœ€åæŠŠAXçš„å€¼æ¬åˆ°r2(è¿”å›å€¼c)\n0x0013 00019 (C:\\Users\\bruce\\Desktop\\go\\main.go:8) RET æœ€åRETæŒ‡ä»¤ï¼Œoneå‡½æ•°ç»“æŸ\næ€»ç»“\né€šè¿‡å¯¹golangè¿›è¡Œæ±‡ç¼–ï¼ŒçœŸå®äº†ä¹‹å‰çš„ç»“è®º\ngolangå‡½æ•°çš„å¤šè¿”å›å€¼ä¸æ˜¯é€šè¿‡å¯„å­˜å™¨ä¼ é€’ï¼Œä½¿ç”¨è¿‡ä½¿ç”¨è°ƒç”¨å€¼æä¾›çš„åœ°å€ï¼Œèµ‹å€¼å®ç°çš„\nå…ˆå†™è¿™äº›å§ï¼Œæˆ‘ä¹Ÿæ˜¯åˆšæ¥è§¦golangçš„æ±‡ç¼–ï¼Œæ–‡ä¸­å¦‚æœ‰ä¸æ­£ç¡®çš„åœ°æ–¹ï¼Œè¿˜è¯·åœ¨è¯„è®ºåŒºæŒ‡å‡º\n","date":"2020-06-21T11:27:54Z","permalink":"https://lqxhub.github.io/posts/1c1c3bd5/","title":"é€šè¿‡æ±‡ç¼–çœ‹golangå‡½æ•°çš„å¤šè¿”å›å€¼"},{"content":"ansibleæ˜¯ä¸€ä¸ªåŸºäºpythonå¼€å‘è‡ªåŠ¨åŒ–çš„è¿ç»´å·¥å…·ï¼Œè¿™ä¸ªå·¥å…·å¼ºå¤§çš„åœ°æ–¹æ˜¯ï¼Œè¢«æ“ä½œçš„æœºå™¨ä¸Šä¸éœ€è¦å®‰è£…ä»»ä½•è½¯ä»¶ï¼Œåªéœ€è¦åœ¨å‘èµ·æ“ä½œçš„æœºå™¨ä¸Šå®‰è£…å°±å¯ä»¥ä½¿ç”¨äº†ã€‚ è€Œä¸”ansibleæ”¯æŒå¾ˆå¤šæ¨¡å—ï¼Œè¿˜å¯ä»¥åŸºäºansibleäºŒæ¬¡å¼€å‘ï¼Œæ·»åŠ è‡ªå·±çš„åŠŸèƒ½\nansibleåŠŸèƒ½å’Œæ¨¡å—å¾ˆå¤šï¼Œè¿™æ¬¡æˆ‘ä»¬åªè®²å…¶ä¸­çš„ä¸€ä¸ªã€‚åœ¨å‘½ä»¤è¡Œä¸­ï¼Œç›´æ¥æŠŠè¦æ“ä½œä¸»æœºçš„ç”¨æˆ·åå’Œå¯†ç ä¼ å…¥ã€‚åˆ«çš„ä¸œè¥¿ç­‰ä»¥åæœ‰æ—¶é—´ä¼šç»§ç»­å†™çš„ï¼Œæ¯•ç«Ÿ996å¤ªç´¯äº†\næ­£å¸¸ä½¿ç”¨ansibleä¸€èˆ¬éƒ½æ˜¯ åœ¨ /ect/ansible/hosts ä¸­é…ç½®è¿œç¨‹ä¸»æœºçš„ç”¨æˆ·å’Œå¯†ç  ä¸€èˆ¬å†™æ³•\n1[test] 2one ansible_ssh_host=192.168.199.209 ansible_ssh_port=22 ansible_ssh_user=root ansible_ssh_pass=123456 ç„¶åä½¿ç”¨å‘½ä»¤è¡Œ ansible test -m ping çœ‹åˆ°æˆªå›¾ï¼Œè¯´æ˜å·²ç»pingé€šï¼Œè¯´æ˜é…ç½®æ˜¯æ²¡é—®é¢˜çš„\næœ‰æ—¶å€™ï¼Œéœ€è¦å•ç‹¬æŒ‡å®šè¿æ¥ä¸€å°ä¸»æœºï¼Œæˆ–è€…åªæ˜¯ä¸´æ—¶è¿æ¥ä¸€æ¬¡ï¼Œè¿™æ—¶å€™æ²¡å¿…è¦åœ¨hostsæ–‡ä»¶ä¸­é…ç½®ï¼Œå¯ä»¥ç›´æ¥åœ¨å‘½ä»¤è¡Œä¸­ä¼ å…¥ä¸»æœºipå’Œè¿æ¥ç”¨æˆ·åå’Œå¯†ç  ansible all -i \u0026quot;192.168.199.209:22,\u0026quot; -m ping -e\u0026quot;ansible_user=root ansible_password=123456\u0026quot; æ³¨æ„ï¼šipåé¢ä¸€å®šè¦æœ‰ä¸€ä¸ª\u0026quot;,\u0026quot; æˆªå›¾ä¸­ï¼Œè¯´æ˜æ²¡é—®é¢˜\nå¥½äº†å…ˆå†™è¿™äº›ï¼Œansibleæ¨¡å—è·Ÿå¤šï¼ŒåŠŸèƒ½å¾ˆå¤šã€‚å°¤å…¶æ˜¯playbookè¿™ä¸ªä¸œè¥¿ï¼Œæ›´æ˜¯ç‰›é€¼ï¼Œä»¥åæœ‰æ—¶é—´ç»§ç»­å†™\n","date":"2020-06-13T17:06:53Z","permalink":"https://lqxhub.github.io/posts/f6596db0/","title":"ansible åœ¨å‚æ•°ä¸­ä¼ å…¥å¯†ç "},{"content":"ä¹‹å‰ä½¿ç”¨dockerå®‰è£…è¿‡mysqlï¼Œä½¿ç”¨çš„æ˜¯åˆ«äººåˆ¶ä½œå¥½çš„é•œåƒã€‚ä»Šå¤©ä½¿ç”¨Dockerfileè‡ªå·±æ‰“åŒ…ä¸€ä¸ªdockerçš„é•œåƒã€‚è¿™ä¸ªé•œåƒæ˜¯ä¸€ä¸ªwebçš„é•œåƒï¼Œä½¿ç”¨goç¼–å†™ã€‚\ngoéå¸¸é€‚åˆç”¨æ¥å†™dockerçš„é•œåƒç¨‹åºï¼Œå› ä¸ºgoç¼–è¯‘åçš„äºŒè¿›åˆ¶ç¨‹åºä¸ä¾èµ–å¤–å¤–éƒ¨åº“ï¼ˆåˆ’é‡ç‚¹ï¼Œåé¢ä¼šç”¨åˆ°è¿™ä¸ªçŸ¥è¯†ç‚¹ï¼‰ï¼Œå¯ä»¥éå¸¸æ–¹ä¾¿çš„æ‰“åŒ…è¿›dockerä¸­ã€‚ è¿™æ¬¡æ‰“åŒ…é•œåƒä¼šç”¨åˆ°dockerçš„ç«¯å£æ˜ å°„å’Œç›®å½•æŒ‚è½½è¿™ä¸¤ä¸ªç‰¹æ€§ï¼Œåé¢ç”¨åˆ°ä¼šæŒ‡å‡º æˆ‘çš„ç¼–è¯‘å’Œæ‰“åŒ…æ˜¯åœ¨linuxä¸­å®Œæˆçš„ï¼Œæ–‡ä¸­æ‰€æœ‰çš„ä»‹ç»éƒ½æ˜¯ä»¥linuxç³»ç»Ÿä¸ºåŸºç¡€\nå…ˆä¸Šwebç¨‹åºçš„ä»£ç \n1package main 2 3import ( 4\t\u0026#34;net/http\u0026#34; 5\t\u0026#34;os\u0026#34; 6\t\u0026#34;strconv\u0026#34; 7\t\u0026#34;time\u0026#34; 8) 9 10const BASE_DIR = \u0026#34;./data/\u0026#34; 11 12func main() { 13\thttp.HandleFunc(\u0026#34;/\u0026#34;, Hand) 14\thttp.ListenAndServe(\u0026#34;0.0.0.0:8088\u0026#34;, nil) 15} 16 17func Hand(w http.ResponseWriter, r *http.Request) { 18\tquery := r.URL.Query() 19\tone := query.Get(\u0026#34;one\u0026#34;) 20\tnow := time.Now().Unix() 21\tfileName := strconv.FormatInt(now, 10) 22 23\tfile, err := os.OpenFile(BASE_DIR+fileName+\u0026#34;.txt\u0026#34;, os.O_RDWR|os.O_CREATE, 0666) 24\tif err == nil { 25\tfile.WriteString(one) 26\tfile.Close() 27\tw.Write([]byte(\u0026#34;ok\u0026#34;)) 28\t} else { 29\tw.Write([]byte(\u0026#34;open file error,\u0026#34;)) 30\tw.Write([]byte(err.Error())) 31\t} 32} ç®€å•è¯´ä¸€ä¸‹é€»è¾‘ï¼Œwebä¼šç›‘å¬ 8080 ç«¯å£ï¼Œå½“æ”¶åˆ°å®¢æˆ·ç«¯çš„è¯·æ±‚æ—¶ï¼Œä¼šåœ¨å½“å‰ç›®å½•çš„ /data/ ä¸‹åˆ›å»ºä¸€ä¸ª å½“å‰æ—¶é—´æˆ³.txt æ–‡ä»¶ï¼Œå¹¶æŠŠè·å–åˆ°çš„æ•°æ®å†™å…¥åˆ°æ–‡ä»¶ä¸­ï¼Œå¹¶æŠŠç»“æœè¿”å›åˆ°ç½‘é¡µä¸­\nå…ˆæŠŠä»£ç ç¼–è¯‘æˆå¯æ‰§è¡Œæ–‡ä»¶ï¼Œæ‰§è¡Œ go build -ldflags \u0026quot;-w -s\u0026quot; main.goï¼Œ-ldflags \u0026ldquo;-w -s\u0026rdquo; è¿™ä¸ªå‚æ•°ä¼šè‡ªåŠ¨ä¼˜åŒ–ä»£ç ï¼Œè¿™æ ·ç¼–è¯‘å‡ºæ¥çš„å¯æ‰§è¡Œæ–‡ä»¶ä½“ç§¯ä¼šå˜å°ã€‚ å…ˆåœ¨æœ¬åœ°è¿è¡Œä¸€ä¸‹çœ‹ä¸€ä¸‹æ•ˆæœ\næµè§ˆå™¨æ˜¾ç¤ºæ­£ç¡®ï¼Œå†çœ‹ä¸€ä¸‹dataç›®å½•ä¸‹æœ‰æ²¡æœ‰å¯¹åº”çš„æ–‡ä»¶\næ–‡ä»¶ä¹Ÿæ­£å¸¸å†™å…¥äº†ï¼Œè¯´æ˜ç¨‹åºæ˜¯æ²¡æœ‰é—®é¢˜çš„\nä¸‹é¢å¼€å§‹æ‰“åŒ…docker\nå¼€å§‹ç¼–å†™Dockerfileæ–‡ä»¶\n1FROM scratch 2 3WORKDIR /app 4 5VOLUME /app/data 6 7ADD main /app 8 9COPY data /app 10 11EXPOSE 8088 12 13CMD [\u0026#34;/app/main\u0026#34;] æ‰“åŒ…dockeré•œåƒéœ€è¦åœ¨ä¸€ä¸ªé•œåƒçš„åŸºç¡€ä¸Šæ‰“åŒ…ï¼Œscratchè¿™ä¸ªé•œåƒæ˜¯ä¸€ä¸ªå¾ˆç‰¹æ®Šçš„é•œåƒï¼Œæ˜¯ä¸€ä¸ªç©ºçš„é•œåƒï¼Œå¤§å°æ˜¯0ï¼Œè¿™æ ·æˆ‘ä»¬æ‰“åŒ…å‡ºæ¥çš„é•œåƒä¼šå¾ˆå°ï¼Œå¦‚æœä½¿ç”¨Ubuntuä½œä¸ºåŸºç¡€é•œåƒï¼Œæ‰“åŒ…å‡ºæ¥çš„é•œåƒä½“ç§¯ä¼šå¾ˆå¤§ï¼Œå› ä¸ºUbuntué•œåƒå°±è¦æœ‰60M+äº†ã€‚æ›´å¤šå…³äºscratchå¯ä»¥æŸ¥çœ‹è¿™é‡Œã€‚ ç”¨åˆ°çš„Dockerfileå‘½ä»¤\nFROM æŒ‡å®šä»¥å“ªä¸ªé•œåƒä¸ºåŸºç¡€å¼€å§‹æ„å»ºé•œåƒ WROKDIR æŒ‡å®šæˆ‘ä»¬dockerä¸­çš„å·¥ä½œç›®å½•ï¼Œå¦‚æœè¿™ä¸ªç›®å½•ä¸å­˜åœ¨ï¼Œä¼šè‡ªåŠ¨åˆ›å»º VOLUME æŒ‡å®šå¯¹å¤–æ˜ å°„çš„ç›®å½• ADD å°†æœ¬åœ°çš„æ–‡ä»¶æ·»åŠ åˆ°dockerä¸­ COPY å’ŒADDå‘½ä»¤ç›¸ä¼¼ä¹Ÿæ˜¯å°†æœ¬åœ°çš„æ–‡ä»¶æ·»åŠ åˆ°dockerä¸­ EXPOSE æŒ‡å®šå¯¹å¤–æ˜ å°„çš„ç«¯å£ CMD åœ¨dockerä¸­æ‰§è¡Œå‘½ä»¤ï¼Œå¦‚æœæœ‰å¤šä¸ªCMDï¼Œåªæœ‰æœ€æœ‰ä¸€ä¸ªç”Ÿæ•ˆ åˆ«çš„å‘½ä»¤æ²¡ä»€ä¹ˆç‰¹æ®Šçš„ï¼Œç®€å•è¯´ä¸€ä¸‹ADDå’ŒCOPYçš„åŒºåˆ«ï¼Œç›¸åŒç‚¹éƒ½æ˜¯è®²æ–‡ä»¶å¤åˆ¶åˆ°dockerä¸­ï¼Œä¸åŒçš„æ˜¯ADDå‘½ä»¤åŠŸèƒ½æ›´å¤šï¼Œå¦‚æœå¤åˆ¶åˆ°æ–‡ä»¶æ˜¯tarï¼Œzipç­‰å‹ç¼©æ–‡ä»¶æ—¶ï¼ŒADDå‘½ä»¤ä¼šè‡ªåŠ¨è§£å‹ç¼©ï¼ŒADDè¿˜å¯ä»¥ä»ç½‘ç»œä¸ŠåŠ è½½æ–‡ä»¶\nDockerfileæ–‡ä»¶å†™å¥½äº†ï¼Œä¸‹ä¸€æ­¥å¼€å§‹æ„å»ºäº† ä½¿ç”¨ docker build -t goweb .å‘½ä»¤æ„å»º goweb æ˜¯æŒ‡å®šæ„å»ºåé•œåƒçš„åå­— æ²¡æœ‰æŠ¥é”™,è¯´æ˜æ„å»ºå®Œæˆ\nå¯ä»¥åœ¨æœ¬åœ°çš„é•œåƒä¸­çœ‹åˆ°åˆšæ‰æ„å»ºçš„é•œåƒäº†ï¼Œå¤§å°åªæœ‰5.4M\næœ‰äº†é•œåƒå¼€å§‹åˆ›å»ºå®¹å™¨ ç°åœ¨ç”¨æˆ·ç›®å½•ä¸‹æ–°å»ºä¸€ä¸ª go_web ç›®å½• ä½¿ç”¨docker run -idt --name goweb -v ~/go_web:/app/data -p 8088:8088 gowebå‘½ä»¤åˆ›å»ºå®¹å™¨ ä¹‹å‰çš„æ–‡ç« å·²ç»ä»‹ç»è¿‡äº†ï¼Œä¸åœ¨èµ˜è¿°äº†ï¼Œæ–‡ç«  ä¼ é€é—¨ çœ‹ä¸€ä¸‹å®¹å™¨çš„è¿è¡Œæƒ…å†µ\nwhatï¼Œä¸ºå•¥å®¹å™¨é€€å‡ºäº†ï¼Œåº”è¯¥æ˜¯å‡ºé”™äº†ï¼Œçœ‹ä¸€ä¸‹é”™è¯¯\nè¿˜è®°å¾—å‰é¢ç”»çš„é‡ç‚¹å—ï¼Œgoç¼–è¯‘åçš„äºŒè¿›åˆ¶ç¨‹åºä¸ä¾èµ–å¤–å¤–éƒ¨åº“ï¼Œå…¶å®è¿™å¥è¯æ˜¯é”™è¯¯çš„ çœ‹ä¸€ä¸‹åˆšæ‰ç¼–è¯‘çš„ç¨‹åºä¾èµ–é‚£äº›å¤–éƒ¨åº“\nç°åœ¨çš„mainæ–‡ä»¶ä¾èµ–4ä¸ªå¤–éƒ¨æ–‡ä»¶ï¼Œå› ä¸ºæˆ‘ä»¬æ˜¯åŸºäºscratchæ‰“åŒ…çš„ï¼Œscratchæ˜¯ä¸€ä¸ªç©ºç™½çš„é•œåƒï¼Œæ²¡æœ‰è¿™äº›æ–‡ä»¶ï¼Œæ‰€ä»¥è¿è¡Œå°±æŠ¥é”™äº†ã€‚æœ‰ä¸¤ç§è§£å†³åŠæ³•\nä½¿ç”¨Ubuntuç­‰æœ‰è¿™äº›åº“çš„åŸºç¡€é•œåƒï¼Œä½†æ˜¯è¿™æ ·ä¼šå¢åŠ æ‰“åŒ…åé•œåƒçš„ä½“ç§¯ï¼Œå¾ˆæ˜¾ç„¶ä¸åˆ’ç®— ä½¿ç”¨é™æ€ç¼–è¯‘ï¼ŒæŠŠè¿™äº›åº“ç¼–è¯‘è¿›mainæ–‡ä»¶ä¸­ é‡æ–°ç¼–è¯‘goæ–‡ä»¶ å…ˆæŠŠåŸæ¥çš„mainæ”¹ä¸€ä¸ªåå­—mv main main2 é‡æ–°ç¼–è¯‘CGO_ENABLED=0 go build -ldflags \u0026quot;-w -s\u0026quot; main.go CGO_ENABLED=0 æŒ‡å®šä¸ºé™æ€ç¼–è¯‘ ç°åœ¨çœ‹ä¸€ä¸‹mainçš„å¤–éƒ¨ä¾èµ–\nç°åœ¨çš„mainä¸ä¾èµ–å¤–éƒ¨æ–‡ä»¶äº† æŠŠä¹‹å‰çš„dockeré•œåƒå’Œå®¹å™¨éƒ½åˆ æ‰ï¼Œé‡æ–°æ‰“åŒ…dockerï¼Œé‡æ–°ç”Ÿæˆå®¹å™¨\nç°åœ¨çœ‹ä¸€ä¸‹ å®¹å™¨å·²ç»è¿è¡Œäº†ï¼Œå¹¶ä¸”å®Œæˆäº†ç«¯å£æ˜ å°„ åœ¨æµè§ˆå™¨ä¸­è¯•ä¸€ä¸‹\nçœ‹ä¸€ä¸‹go_webç›®å½•\nåœ¨go_webç›®å½•ä¸­å·²ç»åˆ›å»ºäº†æ–‡ä»¶ï¼Œå¹¶ä¸”å†…å®¹ä¹Ÿæ­£ç¡®å†™å…¥äº†\nåˆ°è¿™ï¼Œè‡ªå·±æ‰“åŒ…dockeré•œåƒå°±å®Œæˆäº†ã€‚\n","date":"2020-04-12T21:24:55Z","permalink":"https://lqxhub.github.io/posts/c3d3e563/","title":"dockerå­¦ä¹ 3-æ‰“åŒ…ä¸€ä¸ªdockeré•œåƒ"},{"content":"æ“ä½œdockerå®¹å™¨ï¼Œå’Œæ“ä½œlinuxå·®ä¸å¤šï¼Œéƒ½æ˜¯ä½¿ç”¨å‘½ä»¤è¡Œæ“ä½œã€‚ä¸åŒçš„æ˜¯ï¼Œæ“ä½œdockeréœ€è¦ä½¿ç”¨dockerçš„å‘½ä»¤ã€‚dockerçš„å‘½ä»¤å’Œlinuxçš„å‘½ä»¤å¾ˆå¤šç›¸ä¼¼çš„ï¼Œä¹Ÿæœ‰ä¸€äº›ä¸åŒã€‚åºŸè¯ä¸å¤šè¯´ï¼Œå¼€å§‹å­¦ä¹ ã€‚dockerå‘½ä»¤åˆ†ä¸ºé•œåƒç›¸å…³ï¼Œå®¹å™¨ç”Ÿå‘½å‘¨æœŸç›¸å…³ï¼Œå®¹å™¨æ“ä½œç›¸å…³ï¼Œä»“åº“ç›¸å…³ç­‰ä¸€ç³»åˆ—å‘½ä»¤ã€‚æ˜¯ç”¨dockerå‘½ä»¤æ—¶ï¼Œå‰è¦åŠ ä¸Š docker ï¼Œæ¯”å¦‚æŸ¥çœ‹dockerç‰ˆæœ¬ï¼Œåœ¨ç»ˆç«¯è¾“å…¥ docker version\nç‰ˆæœ¬ç›¸å…³ version æŸ¥çœ‹dockerçš„ç‰ˆæœ¬ï¼Œèƒ½çœ‹åˆ°dockerçš„clientå’Œserverçš„ç‰ˆæœ¬ info æ˜¾ç¤º Docker ç³»ç»Ÿä¿¡æ¯ï¼ŒåŒ…æ‹¬é•œåƒå’Œå®¹å™¨æ•°ã€‚ å¯ä»¥çœ‹åˆ°ï¼Œæœ‰ä¸¤ä¸ªå®¹å™¨ï¼Œä¸€ä¸ªè¿è¡Œä¸­ä¸€ä¸ªåœæ­¢ã€‚æœ¬åœ°è¿˜æœ‰ä¸¤ä¸ªé•œåƒ\næœ¬åœ°é•œåƒç›¸å…³æ“ä½œ images æŸ¥çœ‹æœ¬åœ°æ‰€æœ‰é•œåƒ rmi åˆ é™¤æœ¬åœ°ä¸€ä¸ªæˆ–å¤šå°‘é•œåƒã€‚è¿™ä¸ªå‘½ä»¤å’Œlinuxçš„rmå‘½ä»¤å¾ˆåƒï¼Œå¯ä»¥ä½¿ç”¨ -f å¼ºåˆ¶åˆ é™¤\ntag ä¸ºæœ¬åœ°é•œåƒæ‰“ä¸€ä¸ªæ ‡ç­¾ï¼Œå¯ä»¥ç†è§£ä¸ºé‡å‘½åã€‚ å¯ä»¥çœ‹åˆ°ï¼Œä½¿ç”¨tagå‘½ä»¤ç»™mysqlåŠ äº†ä¸€ä¸ªæ ‡ç­¾ï¼Œä¸¤ä¸ªé•œåƒçš„idæ˜¯ç›¸åŒçš„ï¼Œè¯´æ˜è¿˜æ˜¯åŒä¸€ä¸ªé•œåƒã€‚ä½¿ç”¨rmiå‘½ä»¤åˆ é™¤ä¸€ä¸ªï¼Œå¦ä¸€ä¸ªä¸å—å½±å“ã€‚\nbuild å‘½ä»¤ç”¨äºä½¿ç”¨ Dockerfile åˆ›å»ºé•œåƒã€‚è¿™ä¸ªå‘½ä»¤æ¯”è¾ƒå¤æ‚ï¼Œæœ‰å¾ˆå¤šå‚æ•°ï¼Œè€Œä¸”éœ€è¦é…åˆDockerfileæ–‡ä»¶ä½¿ç”¨\nhistory æŸ¥çœ‹æŒ‡å®šé•œåƒçš„åˆ›å»ºå†å²ã€‚\n-H :ä»¥å¯è¯»çš„æ ¼å¼æ‰“å°é•œåƒå¤§å°å’Œæ—¥æœŸï¼Œé»˜è®¤ä¸ºtrueï¼› \u0026ndash;no-trunc :æ˜¾ç¤ºå®Œæ•´çš„æäº¤è®°å½•ï¼› -q :ä»…åˆ—å‡ºæäº¤è®°å½•IDã€‚ save å°†æœ¬åœ°çš„å®¹å™¨ä¿å­˜ä¸ºä¸€ä¸ªæ–‡ä»¶ã€‚ å·²ç»æŠŠæœ¬åœ°çš„redis é•œåƒä¿å­˜åˆ°äº†å½“å‰ç›®å½•\nload å¯¼å…¥ä½¿ç”¨ save å‘½ä»¤å¯¼å‡ºçš„é•œåƒã€‚ æˆ‘ä»¬å…ˆæŠŠæœ¬åœ°çš„redisé•œåƒåˆ é™¤ï¼Œå†é€šè¿‡loadå‘½ä»¤æŠŠåˆšæ‰å¯¼å‡ºçš„redisé•œåƒå†å¯¼å…¥\nimport ä¹Ÿæ˜¯ä»æœ¬åœ°æ–‡ä»¶å¯¼å…¥é•œåƒã€‚å’Œload ä¸åŒçš„æ˜¯ï¼Œimport å‘½ä»¤éœ€è¦æŒ‡å®šå¯¼å…¥åçš„é•œåƒçš„nameå’Œtag å…ˆæŠŠåŸæœ‰çš„redisé•œåƒåˆ æ‰ï¼Œå†ä½¿ç”¨importå‘½åå¯¼å…¥é•œåƒï¼Œå¹¶æŒ‡å®šnameå’Œtagã€‚ä¸€èˆ¬importå‘½ä»¤é…åˆexportå‘½ä»¤ä½¿ç”¨\nå®¹å™¨ä»“åº“ç›¸å…³ search åœ¨è¿œç¨‹ä»“åº“ä¸­æœç´¢ç›¸å…³çš„é•œåƒã€‚ åœ¨è¿œç¨‹ä»“åº“ä¸­æœç´¢mysqlç›¸å…³çš„é•œåƒ\npull ä»è¿œç¨‹ä»“åº“æ‹‰å–é•œåƒåˆ°æœ¬åœ°ï¼Œæ¯”å¦‚æ‹‰å–mysqlå‘½ä»¤ï¼Œ docker pull mysql\nå®¹å™¨ç”Ÿå‘½å‘¨æœŸç›¸å…³ run åˆ›å»ºä¸€ä¸ªæ–°çš„å®¹å™¨å¹¶è¿è¡Œï¼›runå‘½ä»¤æœ‰å¾ˆå¤šå‚æ•°ï¼ŒæŒ‘å‡ ä¸ªå¸¸ç”¨çš„ä»‹ç»ä¸€ä¸ª\n-d: åå°è¿è¡Œå®¹å™¨ï¼Œå¹¶è¿”å›å®¹å™¨ID; -i: ä»¥äº¤äº’æ¨¡å¼è¿è¡Œå®¹å™¨ï¼Œé€šå¸¸ä¸ -t åŒæ—¶ä½¿ç”¨ï¼› -t: ä¸ºå®¹å™¨é‡æ–°åˆ†é…ä¸€ä¸ªä¼ªè¾“å…¥ç»ˆç«¯ï¼Œé€šå¸¸ä¸ -i åŒæ—¶ä½¿ç”¨ï¼› \u0026ndash;name=\u0026ldquo;nginx-lb\u0026rdquo;: ä¸ºå®¹å™¨æŒ‡å®šä¸€ä¸ªåç§°ï¼›æ³¨æ„è¿™ä¸ªå‰é¢æ˜¯ \u0026ndash; -e: è®¾ç½®ç¯å¢ƒå˜é‡ï¼›åœ¨ç”¨dockerå¯åŠ¨mysqlçš„æ—¶å€™ï¼Œä¼šç”¨åˆ°ç¯å¢ƒå˜é‡è®¾ç½®mysqlçš„å¯†ç  -P: éšæœºç«¯å£æ˜ å°„ï¼Œå®¹å™¨å†…éƒ¨ç«¯å£éšæœºæ˜ å°„åˆ°ä¸»æœºçš„é«˜ç«¯å£ï¼Œå¤§å†™çš„Pï¼› -p: æŒ‡å®šç«¯å£æ˜ å°„ï¼Œæ ¼å¼ä¸ºï¼šä¸»æœº(å®¿ä¸»)ç«¯å£:å®¹å™¨ç«¯å£ï¼›æ¯”å¦‚ä½¿ç”¨dockerè¿è¡Œnginxæ—¶ï¼Œå°†å®¹å™¨çš„nginx80ç«¯å£æ˜ å°„åˆ°ä¸»æœºçš„8080ç«¯å£ï¼›-p 8080:80 -m :è®¾ç½®å®¹å™¨ä½¿ç”¨å†…å­˜æœ€å¤§å€¼ï¼› \u0026ndash;volume , -v: å°†ä¸»æœºä¸Šçš„ç›®å½•æŒ‚è½½åˆ°å®¹å™¨å†…ï¼›æ ¼å¼ä¸ºï¼šä¸»æœºç›®å½•:å®¹å™¨å†…çš„ç›®å½• ä»¥è¿è¡Œmysqlä¸ºä¾‹ï¼Œ è¿è¡Œä¸€ä¸ªmysqlå®¹å™¨ï¼Œé‡å‘½åä¸ºmy_mysqlï¼Œå°†å®¹å™¨çš„3306ç«¯å£æ˜ å°„åˆ°ä¸»æœºçš„3366ç«¯å£ï¼Œå¹¶å°†mysqlçš„å­˜å‚¨ç›®å½•*/var/lib/mysql* æŒ‚è½½åˆ°ç”¨æˆ·ç›®å½•çš„mysql_dataç›®å½•ä¸‹ start å¯åŠ¨ä¸€ä¸ªå®¹å™¨ï¼Œå¯ä»¥ä½¿ç”¨å®¹å™¨çš„idä¹Ÿå¯ä»¥ä½¿ç”¨å®¹å™¨çš„name\nstop åœæ­¢ä¸€ä¸ªå®¹å™¨\nrestart é‡å¯ä¸€ä¸ªå®¹å™¨\nkill æ€æ­»ä¸€ä¸ªå®¹å™¨ï¼Œå’Œlinuxçš„killå‘½ä»¤å¾ˆåƒï¼Œå¯ä»¥ä½¿ç”¨å®¹å™¨çš„nameæ“ä½œ\npause æš‚åœå®¹å™¨ä¸­æ‰€æœ‰çš„è¿›ç¨‹ã€‚\nunpause æ¢å¤å®¹å™¨æš‚åœçš„è¿›ç¨‹ã€‚\ncreate åˆ›å»ºä¸€ä¸ªå®¹å™¨,ä½†æ˜¯ä¸å¯åŠ¨è¿™ä¸ªå®¹å™¨\nexec åœ¨è¿è¡Œçš„å®¹å™¨ä¸­æ‰§è¡Œå‘½ä»¤ã€‚å¯ä»¥çœ‹åšæ˜¯è¿›å…¥åˆ°è¿™ä¸ªå®¹å™¨ä¸­ã€‚\n-d :åˆ†ç¦»æ¨¡å¼: åœ¨åå°è¿è¡Œ -i :é»˜è®¤æ‰“å¼€ï¼Œæ²¡æœ‰é™„åŠ ä¹Ÿä¿æŒSTDIN æ‰“å¼€ -t :åˆ†é…ä¸€ä¸ªä¼ªç»ˆç«¯ ä½¿ç”¨å‘½ä»¤ docker exec -it redis è¿›å…¥nameä¸ºredis çš„å®¹å™¨ä¸­ å®¹å™¨æ“ä½œç›¸å…³ ps åˆ—å‡ºå½“å‰æœºå™¨ä¸Šçš„å®¹å™¨\n-a:åˆ—å‡ºæ‰€æœ‰çš„å®¹å™¨ï¼ŒåŒ…æ‹¬æ²¡æœ‰è¿è¡Œçš„å®¹å™¨ -f :æ ¹æ®æ¡ä»¶è¿‡æ»¤æ˜¾ç¤ºçš„å†…å®¹ -n :åˆ—å‡ºæœ€è¿‘åˆ›å»ºçš„nä¸ªå®¹å™¨ -q :é™é»˜æ¨¡å¼ï¼Œåªæ˜¾ç¤ºå®¹å™¨ç¼–å· top æŸ¥çœ‹å®¹å™¨ä¸­è¿è¡Œçš„è¿›ç¨‹ä¿¡æ¯ï¼Œæ”¯æŒ ps å‘½ä»¤å‚æ•°ã€‚\nlogs è·å–å®¹å™¨çš„æ—¥å¿—\n-f : è·Ÿè¸ªæ—¥å¿—è¾“å‡ºï¼Œå’Œlinuxçš„ tail çš„-fæ•ˆæœç›¸åŒ \u0026ndash;since :æ˜¾ç¤ºæŸä¸ªå¼€å§‹æ—¶é—´çš„æ‰€æœ‰æ—¥å¿— -t : æ˜¾ç¤ºæ—¶é—´æˆ³ \u0026ndash;tail :ä»…åˆ—å‡ºæœ€æ–°Næ¡å®¹å™¨æ—¥å¿— **port ** åˆ—å‡ºæŒ‡å®šçš„å®¹å™¨çš„ç«¯å£æ˜ å°„ï¼Œæˆ–è€…æŸ¥æ‰¾å°†PRIVATE_PORT NATåˆ°é¢å‘å…¬ä¼—çš„ç«¯å£ã€‚\nexport å°†å®¹å™¨å¯¼å‡ºä¸ºä¸€ä¸ªæ–‡ä»¶ï¼Œå’Œsaveå‘½ä»¤ç›¸ä¼¼ï¼Œä½†æ˜¯saveå‘½ä»¤æ“ä½œçš„æ˜¯é•œåƒï¼Œexportæ“ä½œçš„æ˜¯å®¹å™¨ã€‚saveä¿å­˜çš„æ–‡ä»¶æ²¡æœ‰ä¸¢å¤±é•œåƒçš„å†å²ï¼Œå¯ä»¥å›æ»šåˆ°ä¹‹å‰ã€‚export ä¿å­˜çš„æ–‡ä»¶å†å¯¼å…¥æ—¶ä¼šä¸¢å¤±é•œåƒæ‰€æœ‰çš„å†å²ï¼Œæ‰€ä»¥æ— æ³•è¿›è¡Œå›æ»š ä½¿ç”¨å‘½ä»¤ docker export name \u0026gt; filename\ncommit ä»æŒ‡å®šå®¹å™¨åˆ›å»ºä¸€ä¸ªæ–°çš„é•œåƒã€‚\n-a :æäº¤çš„é•œåƒä½œè€… -c :ä½¿ç”¨DockerfileæŒ‡ä»¤æ¥åˆ›å»ºé•œåƒ -m :æäº¤æ—¶çš„è¯´æ˜æ–‡å­— -p :åœ¨commitæ—¶ï¼Œå°†å®¹å™¨æš‚åœ å°†mariadb å®¹å™¨ç”Ÿæˆä¸€ä¸ªæ–°çš„é•œåƒ cp åœ¨å®¿ä¸»æœºå’Œå®¹å™¨ä¹‹é—´å¤åˆ¶æ–‡ä»¶ã€‚ å°† a.txt å¤åˆ¶åˆ° nameä¸º mysql å®¹å™¨çš„ var ç›®å½• docker cp a.txt redis:/var\n","date":"2020-04-04T18:03:39Z","permalink":"https://lqxhub.github.io/posts/dff1cc87/","title":"dockerå­¦ä¹ 2-dockeråŸºæœ¬å‘½ä»¤"},{"content":"dockeræ˜¯å½“ä¸‹æ˜¯ç”¨çš„æœ€å¤šçš„è™šæ‹ŸåŒ–æŠ€æœ¯ï¼Œé‚£å¿…é¡»è¦å­¦ä¹ ä¸€æ³¢ã€‚å­¦ä¹ ä¹‹å‰å…ˆææ¸…æ¥šä¸‰ä¸ªé—®é¢˜\nä»€ä¹ˆæ˜¯docker dockerè§£å†³äº†å·¥ä½œä¸­çš„é‚£äº›é—®é¢˜ ç†æ¸…æ¥šdockerä¸­çš„å‡ ä¸ªæ¦‚å¿µ ä»€ä¹ˆæ˜¯docker å…ˆè§£å†³ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œdockeråˆ°åº•æ˜¯ä¸ªå•¥ç©æ„ã€‚dockeræ˜¯ä¸€ç§è™šæ‹ŸåŒ–æŠ€æœ¯ï¼Œé€šä¿—çš„è®²ï¼Œdockerç±»ä¼¼ä¸€ä¸ªè™šæ‹Ÿæœºï¼Œå¯ä»¥è™šæ‹Ÿå‡ºä¸€ä¸ªä¸»æœºã€‚åœ¨dockerä¸­ï¼Œæ¯ä¸ªå®¹å™¨ç›¸äº’éš”ç¦»ï¼Œå®¹å™¨å†…çš„ç¨‹åºä¸èƒ½è·¨å®¹å™¨ç›´æ¥äº¤äº’ã€‚å®¹å™¨ä¹‹é—´å¯ä»¥é€šè¿‡ç½‘ç»œæˆ–è€…å…±äº«æ–‡ä»¶äº¤äº’ã€‚ä½†æ˜¯dockerä¸æ˜¯è™šæ‹Ÿæœºï¼Œdockerä¸è™šæ‹Ÿæœºç›¸æ¯”ï¼Œdockeræ˜¯è½»é‡çº§çš„ï¼Œå¯ä»¥åšåˆ°ç§’çº§å¯åŠ¨ï¼Œdockerå ç”¨çš„ç³»ç»Ÿå¼€é”€ä¹Ÿæ˜¯å¾ˆä½çš„ã€‚ç”¨è¿‡è™šæ‹Ÿçš„éƒ½çŸ¥é“ï¼Œè™šæ‹Ÿæœºå¯åŠ¨å¾ˆæ…¢ï¼Œè€Œä¸”ä¼šå ç”¨å®¿ä¸»æœºå¾ˆå¤§çš„å†…å­˜å’Œcpuèµ„æºã€‚ä½¿ç”¨dockerï¼Œå‡ ä¹æ„Ÿè§‰ä¸åˆ°dockerçš„å­˜åœ¨ã€‚\ndockerè§£å†³äº†å·¥ä½œä¸­çš„é‚£äº›é—®é¢˜ dockerè§£å†³äº†å·¥ä½œä¸­çš„é‚£äº›é—®é¢˜ã€‚å¾ˆå¤šæ—¶å€™ï¼Œç”±äºå¼€å‘ç¯å¢ƒå’Œçº¿ä¸Šç¯å¢ƒæ˜¯ä¸åŒçš„ï¼Œæ¯”å¦‚åœ¨windowsä¸‹å¼€å‘ï¼Œç¨‹åºæœ€ç»ˆéƒ¨ç½²åˆ°linuxä¸Šã€‚å¾ˆå¤šæ—¶å€™ï¼Œä¼šå› ä¸ºä¾èµ–åº“çš„é—®é¢˜ï¼Œå¯¼è‡´ç¨‹åºè¿è¡ŒæŠ¥é”™ã€‚javaï¼Œphpï¼ŒC++ç­‰è¿™äº›ç¨‹åºï¼Œåœ¨å¼€å‘ç¯å¢ƒä¸­æ˜¯æ­£å¸¸çš„ã€‚ä½†æ˜¯åœ¨è¿è¡Œç¯å¢ƒä¸­ï¼Œç”±äºç¼ºå¤±è¿è¡Œæ‰€ä¾èµ–çš„åº“ï¼Œå¯¼è‡´ç¨‹åºæŠ¥é”™æˆ–è€…æ— æ³•è¿è¡Œã€‚å½“ä½ è´¹åŠ²ä¹ç‰›äºŒè™ä¹‹åŠ›é…ç½®å¥½è¿è¡Œç¯å¢ƒæ—¶ï¼Œè€æ¿å‘Šè¯‰ä½ ï¼Œè¿˜æœ‰100å°æœåŠ¡å™¨éœ€è¦é…ç½®ï¼Œä½ æ˜¯ä¸æ˜¯ç¬é—´å°±å¥”æºƒäº†ã€‚\nä½¿ç”¨dockerå°±å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚åªéœ€è¦æŠŠè¦éƒ¨ç½²çš„ç¨‹åºæ‰“åŒ…æˆä¸€ä¸ªdockerçš„é•œåƒï¼Œç„¶ååœ¨ç”¨dockeræŠŠé•œåƒç”Ÿæˆå®¹å™¨ï¼Œä½¿ç”¨å®¹å™¨è¿è¡Œã€‚å†ä¹Ÿä¸ç”¨é…ç½®è¿è¡Œç¯å¢ƒäº†ï¼Œä¸ç®¡æœ‰å¤šå°‘å°æœºå™¨ï¼Œåªéœ€è¦æŠŠdockeré•œåƒå¯¼å…¥ï¼Œå°±å¯ä»¥éå¸¸ç®€å•çš„éƒ¨ç½²ä¸€å°æœºå™¨ã€‚dockerä¸ºå•¥èƒ½åšåˆ°å‘¢ï¼Œå…¶å®è¿™ä¸ªæ‰“åŒ…æˆé•œåƒçš„è¿‡ç¨‹ï¼Œå·²ç»æŠŠè¿è¡Œç¨‹åºå¿…å¤‡çš„ä¸€äº›åº“ï¼Œå…¨éƒ½æ‰“åŒ…è¿›é•œåƒä¸­äº†ï¼Œå½“ç¨‹åºåœ¨å®¹å™¨ä¸­è¿è¡Œæ—¶ï¼Œå°±ä¸ä¼šå› ä¸ºç¯å¢ƒçš„é—®é¢˜å¯¼è‡´æŠ¥é”™äº†ã€‚\ndockerä¸­çš„å‡ ä¸ªæ¦‚å¿µ é•œåƒ(Images)ï¼šé•œåƒæ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œæ˜¯ç”¨é•œåƒæ–‡ä»¶å¯ä»¥åˆ›å»ºå®¹å™¨ã€‚æ¯”å¦‚æˆ‘ä»¬è£…ç³»ç»Ÿæ—¶ï¼Œä¼šç”¨åˆ°windowsçš„ç³»ç»Ÿé•œåƒï¼Œä¸€èˆ¬æ˜¯ä¸€ä¸ª**.iso** æ–‡ä»¶ï¼Œdockerä¸­çš„é•œåƒè¿™å°±æ˜¯ä¸€ä¸ªç±»ä¼¼çš„æ–‡ä»¶ã€‚ å®¹å™¨(Container)ï¼š å®¹å™¨æ˜¯ä¸€ä¸ªå¯ä»¥é€šè¿‡dockerè¿è¡Œçš„å®ä¾‹ï¼Œåƒæˆ‘ä»¬è£…æœºå®Œæˆåçš„ç³»ç»Ÿä¸€æ ·ã€‚ ä»“åº“(Repository)ï¼šä»“åº“æ˜¯ä¸€ä¸ªå­˜æ”¾dockeré•œåƒçš„ç½‘ç«™ï¼Œç±»ä¼¼ä¸€ä¸ªç½‘ç›˜ï¼Œè¿™é‡Œä¿å­˜ç€å¾ˆå¤šé•œåƒï¼Œå¯ä»¥é€šè¿‡ç½‘ç»œä¸‹è½½è¿™äº›é•œåƒ ä¸»æœº(Host)ï¼šä¸€ä¸ªç‰©ç†æœºæˆ–è€…è™šæ‹Ÿæœºï¼Œæ¯”å¦‚æˆ‘ä»¬çš„ç”µè„‘ã€äº‘æœåŠ¡å™¨ã€‚ç”¨äºæ‰§è¡Œ Docker å®ˆæŠ¤è¿›ç¨‹å’Œå®¹å™¨ å®¢æˆ·ç«¯(CLient)ï¼šDocker å®¢æˆ·ç«¯é€šè¿‡å‘½ä»¤è¡Œä¸ Docker çš„å®ˆæŠ¤è¿›ç¨‹é€šä¿¡ã€‚å°±æ˜¯æˆ‘ä»¬æ“ä½œdockerçš„å·¥å…· æ€»ç»“ä¸€ä¸‹ï¼Œé•œåƒå¯ä»¥çœ‹åšæ˜¯é¢å‘å¯¹è±¡ä¸­çš„ ç±»ï¼Œå®¹å™¨å°±æ˜¯ å¯¹è±¡ï¼ŒåŒæ ·çš„ï¼Œä¸€ä¸ªé•œåƒä¹Ÿå¯ä»¥åˆ›å»ºå¤šä¸ªå®¹å™¨\nè‡³äºæ€ä¹ˆå®‰è£…dockerï¼Œç½‘ä¸Šæ•™ç¨‹å¤ªå¤šäº†ï¼Œå°±ä¸èµ˜è¿°äº†ã€‚å»ºè®®åœ¨linuxä¸Šå®‰è£…dockerï¼Œæ²¡æœ‰linuxçš„å¯ä»¥åœ¨windowsä¸­è£…ä¸€ä¸ªè™šæ‹Ÿæœºï¼Œè™šæ‹Ÿæœºè£…linuxï¼Œç„¶ååœ¨è£…dockerã€‚æˆ‘å°±æ˜¯è¿™æ ·å¼„çš„ã€‚\n","date":"2020-04-02T19:56:27Z","permalink":"https://lqxhub.github.io/posts/79efdaf8/","title":"dockerå­¦ä¹ 1-åŸºæœ¬æ¦‚å¿µ"},{"content":"åœ¨æ’åºä¸­ï¼Œç»å¸¸é‡åˆ°å˜é‡ç›¸åŒæƒ…å†µä¸‹çš„æ’åºé—®é¢˜ã€‚åœ¨MySQLä¸­å¯ä»¥ä½¿ç”¨ ORDER BY çº¦æŸå¤šä¸ªå­—æ®µã€‚ä½†æ˜¯åœ¨redisä¸­ï¼Œä½¿ç”¨sorted setæ’åºæ—¶ï¼Œscoreåªèƒ½è®¾ç½®ä¸€ä¸ªå˜é‡ã€‚è¿™æ ·åœ¨scoreç›¸åŒæ—¶ï¼Œåªèƒ½ä½¿ç”¨å­—å…¸åºäº†ï¼ˆè¿™ä¸ªæ˜¯ä»æ–‡æ¡£ä¸Šçœ‹åˆ°çš„ï¼Œå…·ä½“æ²¡éªŒè¯ï¼‰ è¿™å°±ä¼šå‡ºç°ä¸€äº›é—®é¢˜äº†ï¼Œæœ€ç®€å•ï¼Œåœ¨æ¸¸æˆæ’è¡Œæ¦œä¸­ï¼Œæˆ‘åŸæ¥æ˜¯æ’ç¬¬ä¸€çš„ï¼Œçªç„¶æ¥äº†ä¸ªäººï¼Œåˆ†æ•°å’Œæˆ‘ç›¸åŒï¼Œä½†æ˜¯æ’åˆ°æˆ‘å‰é¢äº†ï¼Œæˆ‘æˆç¬¬äºŒäº†ï¼Œç©å®¶è‚¯å®šä¸å¹²äº†ã€‚ä½†æ˜¯redisåªèƒ½ä½¿ç”¨ä¸€ä¸ªå€¼ä½œä¸ºæ’åºæ¡ä»¶ï¼Œè¿™å°±éœ€è¦æˆ‘ä»¬åœ¨ä¸€ä¸ªå€¼é‡Œæ—¢èƒ½è®°å½•åŸæœ‰çš„åˆ†æ•°ï¼Œè¿˜è¦è®°å½•å¦ä¸€ä¸ªå€¼ã€‚\næ¯”è¾ƒå¸¸è§çš„æ˜¯ç”¨æ—¶é—´ä½œä¸ºç¬¬äºŒä¸ªæ’åºæ¡ä»¶ï¼Œè°å…ˆè¾¾åˆ°è¿™ä¸ªåˆ†æ•°ï¼Œè°æ’åœ¨å‰é¢ã€‚ è¦å®ç°è¿™ä¸ªåŠŸèƒ½ï¼Œè¦æ»¡è¶³ å¯é€† ï¼Œç¨³å®šæ’åº ä¸¤ä¸ªè¦æ±‚ã€‚\nå¯é€†ï¼šæŠŠæ•°å€¼å¤„ç†åè¿˜èƒ½åˆ°çš„åŸæ¥çš„å€¼ï¼ˆåˆ†æ•°å’Œæ—¶é—´ï¼‰ ç¨³å®šæ’åºï¼šæ·»åŠ æ—¶é—´åä¸èƒ½å½±å“åŸæ¥çš„æ’åºç»“æœï¼Œæ·»åŠ çš„æ—¶é—´åªæ˜¯åœ¨åˆ†æ•°ç›¸åŒçš„æƒ…å†µä¸‹æ‰èµ·ä½œç”¨ ç®€å•çš„å¯¹æ•°å€¼è¿›è¡ŒåŠ å‡ä¹˜é™¤æ˜¯æ²¡æ³•å®ç°çš„äº†ï¼Œç®€å•çš„æ•°å€¼åŠ å‡ä¹˜é™¤ä¸€æ˜¯ä¸èƒ½æ¢å¤åŸæ¥çš„æ•°æ®ï¼ŒäºŒæ˜¯ä¼šå½±å“åˆ°åŸæœ‰çš„æ’åºã€‚\nä¸å–å…³å­äº†ï¼Œä½¿ç”¨**â€˜æˆ–â€™è¿ç®—ï¼Œå¯ä»¥å®ç°è¿™ä¸ªéœ€æ±‚ã€‚æŠŠä¸¤ä¸ªæ•°å€¼è¿›è¡Œæˆ–**è¿ç®—ï¼Œç”Ÿæˆä¸€ä¸ªæ•°ã€‚ç®€å•è¯´ä¸€ä¸‹åŸç†ã€‚ æˆ– è¿ç®—çš„è§„åˆ™æ˜¯åœ¨äºŒè¿›åˆ¶ä½ä¸Šï¼Œæœ‰1 æˆ– è¿ç®—åè¿˜æ˜¯1ï¼Œä¸¤ä¸ªéƒ½æ˜¯0 æˆ–è¿ç®—åæ˜¯ 0ã€‚ ä¾‹ï¼š1æˆ–2 äºŒè¿›åˆ¶è¡¨ç¤º 01|10 = 11ã€‚ä½†æ˜¯ç°åœ¨å´å‘ç°ï¼Œæ— æ³•å®ç°æ•°æ®è¿˜åŸï¼Œè¿™å°±éœ€è¦ç§»ä½äº†ã€‚å°±æ˜¯ä¸¤ä¸ª8ä½é•¿çš„æ•°æ®ï¼Œæˆ– è¿ç®—åè¦æˆä¸º16ä½çš„æ•°æ®ã€‚ è¿˜æ˜¯ä¸Šä¸ªä¾‹å­ï¼šä¸ºäº†ç®€å•èµ·è§ï¼Œå‡è®¾åŸæ•°æ®æ˜¯2ä½é•¿ï¼Œå…ˆæŠŠåŸæ¥2ä½é•¿çš„æ•°æ®è½¬æˆ4ä½é•¿ï¼Œç„¶åå·¦ç§»2ä½ï¼Œ1å°±ä»åŸæ¥çš„01å˜æˆäº†0111ã€‚2åªå˜æˆ4ä½ï¼Œä¸ç§»ä½ã€‚2ä»10å˜æˆ0010ã€‚0100|0010 = 0110ã€‚è¿™æ ·å°±èƒ½è¿˜åŸæ•°æ®äº†ã€‚å‰ä¸¤ä½01æ˜¯åŸæ¥çš„1ï¼Œåä¸¤ä½10å°±æ˜¯åŸæ¥çš„2ã€‚ ä¸‹é¢é€šè¿‡ä»£ç æ¥å®ç°ä¸€ä¸‹ã€‚ ä»£ç ç”¨golangå®ç°\n1package main 2 3import ( 4\t\u0026#34;fmt\u0026#34; 5\t\u0026#34;math/rand\u0026#34; 6\t\u0026#34;sort\u0026#34; 7) 8 9func main() { 10\tarr := make([]uint64, 10) 11\tb := rand.Perm(10) 12\tfor i := 0; i \u0026lt; 10; i++ { 13\tvar a uint32 14\tif i%2 == 0 { 15\ta = 10 16\t} else { 17\ta = 5 18\t} 19\tarr[i] = uint64(a)\u0026lt;\u0026lt;32 | uint64(b[i]) 20\tfmt.Println(a, b[i], arr[i]) 21\t} 22\tsort.Sort(Myuint64(arr)) 23 24\tfmt.Println(\u0026#34;æ’åºå\u0026#34;) 25\tfor _, v := range arr { 26\tfmt.Println(v, v\u0026gt;\u0026gt;32, uint32(v)) 27\t} 28} 29 30type Myuint64 []uint64 31 32func (this Myuint64) Len() int { 33\treturn len(this) 34} 35func (this Myuint64) Less(i, j int) bool { 36\treturn this[i] \u0026gt; this[j] 37} 38 39func (this Myuint64) Swap(i, j int) { 40\tthis[i], this[j] = this[j], this[i] 41} ç®€å•è¯´ä¸€ä¸‹ä»£ç ï¼Œç¬¬ä¸€æ’åºæ¡ä»¶ç”¨äº†é—´éš”ä½¿ç”¨äº†5å’Œæ˜¯è¿™ä¸¤ä¸ªæ•°ï¼Œç¬¬äºŒæ¡ä»¶éšæœºç”Ÿæˆäº†10ä¸ªä¸é‡å¤çš„éšæœºæ•°ï¼Œä¸ç”¨æ—¶é—´æˆ³çš„åŸå› æ˜¯ï¼Œç¨‹åºè¿è¡Œçš„æ—¶é—´å¾ˆçŸ­ï¼Œå–åˆ°çš„æ—¶é—´æˆ³åŸºæœ¬æ˜¯ä¸€ä¸ªæ•°ï¼Œçœ‹ä¸å‡ºåŒºåˆ«ï¼Œæœ¬è´¨æ€æƒ³éƒ½æ˜¯ä¸€æ ·çš„ã€‚ æ’åºä½¿ç”¨äº†goè‡ªå¸¦çš„æ’åºæ¥å£\nä»£ç ä¸­fmt.Println(v, v\u0026gt;\u0026gt;32, uint32(v)) å°±æ˜¯è§£æ•°æ®ï¼Œæˆ– è¿ç®—åï¼Œå‰32ä½æ˜¯ä¸€ä¸ªæ•°ï¼Œå32ä½æ˜¯å¦ä¸€ä¸ªæ•°æ®ã€‚ å–å‰é¢çš„æ•°æ®åªéœ€è¦æŠŠè®¡ç®—åçš„æ•°æ®å³ç§»32ä½å°±è¡Œäº†ï¼Œå–åé¢çš„æ•°æ®ï¼Œæ›´ç®€å•äº†ï¼Œç›´æ¥å¼ºè½¬æˆ32ä½çš„ç±»å‹å°±è¡Œäº†ã€‚ çœ‹ä¸€ä¸‹è¿è¡Œç»“æœï¼š\nå¯ä»¥çœ‹åˆ°ï¼Œæ’åºå‰ï¼Œ10å’Œ5äº¤æ›¿å‡ºç°ï¼Œç¬¬äºŒæ¡ä»¶æ²¡æœ‰è§„å¾‹ æ’åºåï¼Œå…ˆä½¿ç”¨ç¬¬ä¸€ä¸ªæ•°æ’åºï¼Œç¬¬ä¸€ä¸ªæ•°ç›¸åŒæ—¶ï¼Œä½¿ç”¨ç¬¬äºŒæ¡ä»¶æ’åºã€‚è€Œä¸”æˆ‘ä»¬ä¹ŸæˆåŠŸè¿˜åŸäº†åŸæ¥çš„æ•°æ®ã€‚ å¥½äº†ï¼Œè¿™æ ·å°±å®ç°äº†ç”¨ä¸€ä¸ªæ•°å€¼å®ç°ç¬¬äºŒæ¡ä»¶æ’åºäº†ã€‚åœ¨å­˜å…¥redisæ—¶åªéœ€è¦æŠŠè®¡ç®—åçš„æ•°æ®å­˜å…¥rediså°±è¡Œäº†ï¼Œæ˜¾ç¤ºæ•°æ®çš„æ—¶å€™ï¼Œåªéœ€è¦è§£ä¸€ä¸‹æ•°æ®å°±è¡Œäº†ã€‚ å¥½äº†ï¼Œåˆ°è¿™å°±ä»‹ç»å®Œäº†ï¼Œæœ‰é—®é¢˜æ¬¢è¿è¯„è®ºåŒºè®¨è®º\n","date":"2019-11-24T22:07:45Z","permalink":"https://lqxhub.github.io/posts/f329a22f/","title":"ä½¿ç”¨ä¸€ä¸ªå­—æ®µå®ç°ç¬¬äºŒæ¡ä»¶æ’åº"},{"content":"åœ¨é¢å‘å¯¹è±¡ç¼–ç¨‹çš„æ€æƒ³ä¸­ï¼Œæ¥å£æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„æ¦‚å¿µã€‚æŒ‰ä¹¦ä¸Šä»‹ç»çš„ï¼Œä½¿ç”¨æ¥å£ï¼Œå¯ä»¥å®ç°è¿è¡Œæ—¶å¤šæ€ã€æ˜“ç»´æŠ¤ã€æ˜“æ‹“å±•ç­‰ç­‰ä¼˜ç‚¹ã€‚æ‹¥æœ‰å¤šå¹´ç¼–ç¨‹ç»éªŒçš„äººåº”è¯¥èƒ½ç†è§£è¿™äº›è¯çš„å«ä¹‰ï¼Œå¯¹äºä¸€ä¸ªåˆå­¦ç¼–ç¨‹çš„èŒæ–°æ¥è¯´ï¼Œçœ‹å®Œè¿™æ®µè¯å®Œå…¨ä¸çŸ¥æ‰€äº‘ã€‚é‚£ä»Šå¤©æˆ‘ç”¨ã€Šè‹±é›„è”ç›Ÿã€‹ä¸ºèƒŒæ™¯ï¼Œè¯¦ç»†çš„åˆ†æä¸€ä¸‹æ¥å£åœ¨é¢å‘å¯¹è±¡ç¼–ç¨‹ä¸­çš„ä½œç”¨ï¼Œä»¥åŠä½¿ç”¨æ¥å£çš„ä¼˜åŠ¿ã€‚\nè¿™æ¬¡ä½¿ç”¨javaä½œä¸ºç¼–å†™demoçš„è¯­è¨€ï¼Œä¸»è¦åŸå› æœ‰ä¸¤ä¸ªï¼š\njavaæ˜¯æœ€æµè¡Œçš„ç¼–ç¨‹è¯­è¨€ï¼ŒåŸºæœ¬ä¸Šå­¦è¿‡ç¼–ç¨‹çš„éƒ½ä¼šjavaè¯­è¨€ï¼› javaæ˜¯ä¸€é—¨å¯¹é¢å‘å¯¹è±¡ç‰¹æ€§æ”¯æŒæ¯”è¾ƒå¥½çš„è¯­è¨€ï¼› è¿˜è®°å¾—æˆ‘åˆšå¼€å§‹å­¦ä¹ javaçš„æ—¶å€™ï¼Œå°±å¾ˆä¸ç†è§£æ¥å£çš„ä½œç”¨ï¼Œæ„Ÿè§‰æ¥å£æœ‰ç‚¹å¤šä½™ã€‚\nä¾‹å¦‚æˆ‘å®šä¹‰äº†ä¸€ä¸ªæ¥å£ï¼Œä½†æ˜¯æˆ‘åœ¨å®ç°è¿™ä¸ªæ¥å£çš„ç±»ä¸­è¿˜è¦å†™æ¥å£çš„å®ç°æ–¹æ³•ï¼Œé‚£æˆ‘ä¸å¦‚ç›´æ¥å°±åœ¨è¿™ä¸ªç±»ä¸­å†™å®ç°æ–¹æ³•å²‚ä¸æ˜¯æ›´ä¾¿æ·ï¼Œè¿˜çœå»äº†å®šä¹‰æ¥å£\nç›¸ä¿¡ä¸æ­¢æˆ‘ä¸€ä¸ªäººæœ‰è¿‡è¿™æ ·çš„ç–‘æƒ‘å§ã€‚ åæ¥éšç€å†™ä»£ç ï¼Œçœ‹é˜…è¯»åˆ«äººçš„ä»£ç ï¼Œé€æ¸å¼€å§‹ç†è§£æ¥å£çš„ä½œç”¨äº†ï¼Œæ…¢æ…¢è§‰å¾—æ¥å£æ˜¯ä¸€ä¸ªéå¸¸æ–¹ä¾¿å’Œç‰›é€¼çš„ä¸œè¥¿ã€‚ æ•™æä¸Šï¼Œç½‘ä¸Šè§£é‡Šæ¥å£çš„ä¾‹å­å¤§å¤šæ•°ä½¿ç”¨å®šä¹‰ä¸€ä¸ªAnimalæ¥å£ï¼Œç„¶åDogå®ç°äº†è¿™ä¸ªæ¥å£ï¼ŒCatå®ç°äº†è¿™ä¸ªæ¥å£ï¼›è¿˜æœ‰ä¸€ç§ç”¨USBæ¥å£ä¸¾ä¾‹ã€‚å¤§å¤šæ•°äººçœ‹å®Œè¿˜æ˜¯ä¸€è„¸æ‡µé€¼ã€‚ ç°åœ¨ç”¨ä¸€ç§æ–°çš„æ–¹å¼â€”â€”ã€Šè‹±é›„è”ç›Ÿã€‹ä¸ºèƒŒæ™¯ä»‹ç»ä¸€ä¸‹ã€‚ è¯´äº†è¿™ä¹ˆåŠå¤©ï¼Œå¼€å§‹è¿›å…¥æ­£é¢˜å§ã€‚\nå…ˆåœˆä¸¤ä¸ªé‡ç‚¹ï¼š Javaä¹‹æ‰€ä»¥è¦æœ‰æ¥å£ï¼Œæ˜¯å› ä¸ºjavaä¸æ”¯æŒå¤šç»§æ‰¿ï¼Œä½¿ç”¨æ¥å£ï¼Œå¯ä»¥é—´æ¥çš„å®ç°å¤šç»§æ‰¿çš„ä¸€äº›ç‰¹æ€§ï¼›åƒC++å°±ä¸å­˜åœ¨æ¥å£è¿™ä¸ªä¸œè¥¿ï¼Œå› ä¸ºC++æ”¯æŒå¤šç»§æ‰¿ åœ¨é¢å‘å¯¹è±¡çš„æ¦‚å¿µä¸­ï¼Œå­ç±»ï¼ˆæ´¾ç”Ÿç±»ï¼‰å¯ä»¥è‡ªåŠ¨è½¬æ¢ä¸ºçˆ¶ç±»ï¼ˆåŸºç±»ï¼‰ç±»å‹ï¼›ä¹Ÿå°±æ˜¯è¯´ï¼ŒAç±»å®ç°äº†æ¥å£Bï¼Œé‚£ä¹ˆAçš„å®ä¾‹åŒ–å¯¹è±¡å¯ä»¥è‡ªåŠ¨è½¬æ¢ä¸ºBç±»å‹ 1public class Main { 2 public static void main(String[] args) { 3 B a = new A(); 4 } 5} 6 7interface B { 8 9} 10 11class A implements B { 12 13} è¿™æ ·çš„ä»£ç æ˜¯æ­£ç¡®çš„ã€‚\nå¼€å§‹demoéƒ¨åˆ†ï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªSkillæ¥å£ï¼Œé‡Œé¢æœ‰ Qã€Wã€Eã€R å››ä¸ªæ–¹æ³•ï¼Œä»£è¡¨è‹±é›„çš„å››ä¸ªæŠ€èƒ½ã€‚ä¸ºäº†ç®€å•ï¼Œè¢«åŠ¨æŠ€èƒ½å’Œå¬å”¤å¸ˆæŠ€èƒ½å°±ä¸å†™äº†ã€‚ ç„¶åä»äº”ä¸ªä½ç½®ä¸Šå•ã€æ‰“é‡ã€ä¸­å•ã€ADCã€è¾…åŠ©ä¸­å„æŒ‘é€‰ä¸€ä¸ªè‹±é›„ï¼Œä½œä¸ºä¾‹å­ã€‚ä¸Šè·¯ä¸­æˆ‘æœ€å–œæ¬¢çš„æ˜¯é”é›¯ï¼Œæ‰“é‡æˆ‘ç©çš„æœ€å¤šï¼Œçº ç»“äº†åŠå¤©é€‰äº†ç›²åƒ§ã€‚ä¸­å•é‡Œå¿…é¡»é€‰äºšç´¢ï¼ŒADCé‡Œé€‰æ‹©äº†æš´èµ°èè‰ï¼Œè¾…åŠ©é‡Œé€‰æ‹©äº†é”¤çŸ³ã€‚\nå…ˆä¸Šä»£ç å†è§£é‡Šï¼š\n1//æŠ€èƒ½æ¥å£ 2interface Skill { 3 void Q(); 4 5 void W(); 6 7 void E(); 8 9 void R(); 10} 11 12//æ”¾é€ä¹‹åˆƒ-é”é›¯ 13class RuiWen implements Skill { 14 15 public RuiWen() { 16 System.out.println(\u0026#34;æ–­å‰‘é‡é“¸ä¹‹æ—¥,éª‘å£«å½’æ¥ä¹‹æ—¶\u0026#34;); 17 } 18 19 @Override 20 public void Q() { 21 System.out.println(\u0026#34;æŠ˜ç¿¼ä¹‹èˆ\u0026#34;); 22 } 23 24 @Override 25 public void W() { 26 System.out.println(\u0026#34;éœ‡é­‚æ€’å¼\u0026#34;); 27 } 28 29 @Override 30 public void E() { 31 System.out.println(\u0026#34;å‹‡å¾€ç›´å‰\u0026#34;); 32 } 33 34 @Override 35 public void R() { 36 System.out.println(\u0026#34;æ”¾é€ä¹‹é”‹\u0026#34;); 37 } 38} 39 40//ç›²åƒ§-æé’ 41class LiQing implements Skill { 42 43 public LiQing() { 44 System.out.println(\u0026#34;æˆ‘ç”¨åŒæ‰‹æˆå°±ä½ çš„æ¢¦æƒ³\u0026#34;); 45 } 46 47 @Override 48 public void Q() { 49 System.out.println(\u0026#34;å¤©éŸ³æ³¢/å›éŸ³å‡»\u0026#34;); 50 } 51 52 @Override 53 public void W() { 54 System.out.println(\u0026#34;é‡‘é’Ÿç½©/é“å¸ƒè¡«\u0026#34;); 55 } 56 57 @Override 58 public void E() { 59 System.out.println(\u0026#34;å¤©é›·ç ´/æ‘§ç­‹æ–­éª¨\u0026#34;); 60 } 61 62 @Override 63 public void R() { 64 System.out.println(\u0026#34;çŒ›é¾™æ‘†å°¾\u0026#34;); 65 } 66} 67 68//ç–¾é£å‰‘è±ª-äºšç´¢ 69class YaSuo implements Skill { 70 71 public YaSuo() { 72 System.out.println(\u0026#34;æ­»äº¡å¦‚é£,å¸¸ä¼´å¾ç”Ÿ\u0026#34;); 73 } 74 75 @Override 76 public void Q() { 77 System.out.println(\u0026#34;æ–©é’¢é—ª\u0026#34;); 78 } 79 80 @Override 81 public void W() { 82 System.out.println(\u0026#34;é£ä¹‹éšœå£\u0026#34;); 83 } 84 85 @Override 86 public void E() { 87 System.out.println(\u0026#34;è¸å‰æ–©\u0026#34;); 88 } 89 90 @Override 91 public void R() { 92 System.out.println(\u0026#34;ç‹‚é£ç»æ¯æ–©\u0026#34;); 93 } 94} 95 96//æš´èµ°èè‰-é‡‘å…‹æ–¯ 97class JinKeSi implements Skill { 98 99 public JinKeSi() { 100 System.out.println(\u0026#34;è§„åˆ™å°±æ˜¯ç”¨æ¥æ‰“ç ´çš„\u0026#34;); 101 } 102 103 @Override 104 public void Q() { 105 System.out.println(\u0026#34;æªç‚®äº¤å“æ›²ï¼\u0026#34;); 106 } 107 108 @Override 109 public void W() { 110 System.out.println(\u0026#34;éœ‡è¡ç”µç£æ³¢ï¼\u0026#34;); 111 } 112 113 @Override 114 public void E() { 115 System.out.println(\u0026#34;åš¼ç«è€…æ‰‹é›·ï¼\u0026#34;); 116 } 117 118 @Override 119 public void R() { 120 System.out.println(\u0026#34;è¶…ç©¶ææ­»ç¥é£å¼¹ï¼\u0026#34;); 121 } 122} 123 124//é­‚é”å…¸ç‹±é•¿-é”¤çŸ³ 125class ChuiShi implements Skill { 126 127 public ChiShi() { 128 System.out.println(\u0026#34;æˆ‘ä»¬è¦æ€æ ·è¿›è¡Œè¿™ä»¤äººæ„‰æ‚¦çš„æŠ˜ç£¨å‘¢\u0026#34;); 129 } 130 131 @Override 132 public void Q() { 133 System.out.println(\u0026#34;æ­»äº¡åˆ¤å†³\u0026#34;); 134 } 135 136 @Override 137 public void W() { 138 System.out.println(\u0026#34;é­‚å¼•ä¹‹ç¯\u0026#34;); 139 } 140 141 @Override 142 public void E() { 143 System.out.println(\u0026#34;å„è¿é’Ÿæ‘†\u0026#34;); 144 } 145 146 @Override 147 public void R() { 148 System.out.println(\u0026#34;å¹½å†¥ç›‘ç‰¢\u0026#34;); 149 } 150} ä»£ç æœ‰ç‚¹å¤šï¼Œä½†æ˜¯å¾ˆç®€å•ï¼Œå†™äº†5ç±»ï¼Œå¯¹åº”5ä¸ªè‹±é›„ã€‚æ¯ä¸ªç±»çš„æ„é€ æ–¹æ³•ä¸­ï¼Œæ‰“å°äº†è¿™ä¸ªè‹±é›„åœ¨æ’ä½ä¸­è¢«é€‰ä¸­æ—¶çš„å°è¯ã€‚æ¯ä¸ªç±»éƒ½å®ç°äº†skillè¿™ä¸ªæ¥å£ï¼Œå¹¶é‡å†™äº†QWERè¿™4ä¸ªæ–¹æ³•ï¼Œåœ¨æ–¹æ³•ä¸­æ‰“å°äº†è¿™ä¸ªè‹±é›„æŠ€èƒ½çš„åç§°ã€‚ åœ¨mainæ–¹æ³•ä¸­åˆå§‹åŒ–è¿™5ä¸ªè‹±é›„ï¼Œå¹¶è°ƒç”¨æ¯ä¸ªè‹±é›„çš„QWERè¿™å››ä¸ªæŠ€èƒ½ï¼Œä»£ç ï¼š\n1public class Main { 2 public static void main(String[] args) { 3 //åˆå§‹åŒ–é”é›¯é‡Šï¼Œæ”¾æŠ€èƒ½ 4 Skill ruiWen = new RuiWen(); 5 ruiWen.Q(); 6 ruiWen.W(); 7 ruiWen.E(); 8 ruiWen.R(); 9 10 //åˆå§‹åŒ–æé’ï¼Œé‡Šæ”¾æŠ€èƒ½ 11 Skill liQing = new LiQing(); 12 liQing.Q(); 13 liQing.W(); 14 liQing.E(); 15 liQing.R(); 16 17 //åˆå§‹åŒ–äºšç´¢ï¼Œé‡Šæ”¾æŠ€èƒ½ 18 Skill yaSuo = new YaSuo(); 19 yaSuo.Q(); 20 yaSuo.W(); 21 yaSuo.E(); 22 yaSuo.R(); 23 24 //åˆå§‹åŒ–é‡‘å…‹æ–¯ï¼Œé‡Šæ”¾æŠ€èƒ½ 25 Skill jinKeSi = new JinKeSi(); 26 jinKeSi.Q(); 27 jinKeSi.W(); 28 jinKeSi.E(); 29 jinKeSi.R(); 30 31 //åˆå§‹åŒ–é”¤çŸ³ï¼Œé‡Šæ”¾æŠ€èƒ½ 32 Skill chuiShi = new ChuiShi(); 33 chuiShi.Q(); 34 chuiShi.W(); 35 chuiShi.E(); 36 chuiShi.R(); 37 } 38} æ³¨æ„ä¸€ç‚¹ï¼š æˆ‘ä»¬åœ¨å®ä¾‹åŒ–è¿™5ä¸ªè‹±é›„æ—¶ï¼Œè¿™5ä¸ªè‹±é›„éƒ½æ˜¯Skillç±»å‹çš„\nçœ‹ä¸€ä¸‹è¿è¡Œç»“æœï¼š\nå¯ä»¥çœ‹åˆ°ï¼Œè¿™5ä¸ªè‹±é›„ä¾æ¬¡è¢«å®ä¾‹åŒ–ï¼Œå¹¶é‡Šæ”¾äº†QWERè¿™4ä¸ªæŠ€èƒ½ã€‚\nå¯èƒ½åˆ°è¿™æœ‰çš„åŒå­¦æ²¡çœ‹æ‡‚ï¼Œè¿™å’Œæ¥å£æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿæ¥å£å¸¦æ¥äº†å“ªäº›å¥½å¤„ï¼Ÿ\nç®€å•åˆ†æä¸€ä¸‹: æ¥å£è¿™ä¸ªæ¦‚å¿µï¼Œå…¶å®å°±æ˜¯å®šä¹‰äº†ä¸€ç§è§„èŒƒã€‚åœ¨ Skill è¿™ä¸ªæ¥å£ä¸­ï¼Œå®šä¹‰äº†Qã€Wã€Eã€Rè¿™å››ä¸ªæ–¹æ³•ï¼Œåªè¦æ˜¯å®ç°äº†è¿™ä¸ªæ¥å£çš„ç±»ï¼Œä¸€å®šä¼šæœ‰è¿™å››ä¸ªæ–¹æ³•ã€‚ æ¥å£å¯ä»¥çœ‹åšæ˜¯å®ç°å¤šç»§æ‰¿çš„ä¸€ç§æ–¹å¼ï¼ˆè¿™æ ·è¯´å¯èƒ½ä¸ä¸¥è°¨ï¼‰ã€‚javaä¸­æ²¡æœ‰å¤šç»§æ‰¿è¿™ç§æœºåˆ¶ï¼Œå¤±å»äº†ä¸€äº›çµæ´»æ€§ã€‚ä½†æ˜¯å»æ‰å¤šç»§æ‰¿åï¼Œè¯­æ³•ç®€å•äº†å¾ˆå¤šï¼ŒåƒC++ä¸­ï¼Œå› ä¸ºæœ‰å¤šç»§æ‰¿ï¼Œåˆå¼•å…¥äº†è™šç»§æ‰¿çš„æ¦‚å¿µã€‚è¯´å¤šäº†ï¼Œå›åˆ°æ­£é¢˜ã€‚ä¸€ä¸ªç±»å®ç°ä¸€ä¸ªæ¥å£åï¼Œå¯ä»¥çœ‹åšæ˜¯è¿™ä¸ªæ¥å£çš„å­ç±»ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬åœ¨å®ä¾‹åŒ–è‹±é›„æ—¶ï¼ˆnew Ruiwen()ç­‰ï¼‰ï¼Œå¯ä»¥ç›´æ¥å®ä¾‹åŒ–ä¸º Skill ç±»å‹çš„ã€‚ ç»“åˆè¿™ä¸¤ç‚¹ï¼Œæ‰€ä»¥æˆ‘ä»¬æ¯ä¸€ä¸ªSkillç±»å‹çš„å¯¹è±¡ï¼Œéƒ½å¯ä»¥è°ƒç”¨ Qã€Wã€Eã€R è¿™å››ä¸ªæ–¹æ³•ã€‚ æœ‰äººä¼šæå‡ºç–‘é—®ï¼Œæˆ‘åœ¨æ¯ä¸ªç±»ä¸­éƒ½å®šä¹‰ Qã€Wã€Eã€R è¿™å››ä¸ªæ–¹æ³•ä¸å°±è¡Œäº†ã€‚ä½†æ˜¯å¦‚ä½•ä¿è¯æ¯ä¸ªç±»é‡Œéƒ½æœ‰è¿™å››ä¸ªæ–¹æ³•å‘¢ï¼Ÿé€šè¿‡æ¥å£çº¦æŸï¼Œå¯ä»¥ä¿è¯ï¼Œæ‰€æœ‰å®ç°è¿™ä¸ªæ¥å£çš„ç±»ä¸­ï¼Œä¸€å®šæœ‰è¿™å››ä¸ªæ–¹æ³•ã€‚\nå†é€šè¿‡ä¸‹é¢è¿™ä¸ªç”¨æ³•ï¼Œçœ‹ä¸€ä¸‹æ¥å£æ€æ ·å®ç°å¤šæ€çš„ï¼š\n1import java.util.Scanner; 2public class Main { 3 public static void main(String[] args) { 4 Skill hero; 5 Scanner scanner = new Scanner(System.in); 6 switch (scanner.nextInt()) { 7 case 1: 8 hero = new RuiWen(); 9 break; 10 case 2: 11 hero = new LiQing(); 12 break; 13 case 3: 14 hero = new YaSuo(); 15 break; 16 case 4: 17 hero = new JinKeSi(); 18 break; 19 case 5: 20 hero = new ChuiShi(); 21 break; 22 default: 23 hero = new RuiWen(); 24 } 25 26 hero.Q(); 27 hero.W(); 28 hero.E(); 29 hero.R(); 30 } 31} ç®€å•çœ‹ä¸€ä¸‹ä»£ç ï¼Œå®šä¹‰äº†ä¸€ä¸ªSkillç±»å‹çš„å˜é‡hreoã€‚é€šè¿‡è¾“å…¥ä¸åŒçš„å€¼ï¼Œæ¥åˆ¤æ–­å®ä¾‹åŒ–å“ªä¸€ä¸ªè‹±é›„ã€‚æœ€åè°ƒç”¨è‹±é›„çš„ Qã€Wã€Eã€R æ–¹æ³•ã€‚\nå…ˆè¾“å…¥ 1 çœ‹ä¸€ä¸‹ï¼Œè¾“å…¥ 1 åº”è¯¥æ˜¯å®ä¾‹åŒ–é”é›¯è¿™ä¸ªè‹±é›„\næ²¡æœ‰é—®é¢˜ï¼Œè¾“å…¥1æˆåŠŸå®ä¾‹åŒ–äº†é”é›¯è¿™ä¸ªè‹±é›„ï¼Œå¹¶è°ƒç”¨äº†é”é›¯çš„å››ä¸ªæŠ€èƒ½ã€‚\nå†æ¢ä¸€ä¸ªè¾“å…¥å€¼çœ‹ä¸€ä¸‹ï¼š\nè¿™æ¬¡è¾“å…¥äº† 2 ï¼Œå®ä¾‹åŒ–äº†æé’è¿™ä¸ªè‹±é›„ï¼Œå¹¶è°ƒç”¨äº†æé’çš„å››ä¸ªæŠ€èƒ½ã€‚\nä½¿ç”¨äº†æ¥å£åçš„ä¼˜åŠ¿ï¼š ä½¿ç”¨æ¥å£åï¼Œå®ç°äº†è¿è¡Œæ—¶å¤šæ€ï¼Œä¹Ÿå°±æ˜¯ hero å…·ä½“æ˜¯å“ªä¸ªç±»çš„å¯¹è±¡ï¼Œåœ¨ç¼–è¯‘é˜¶æ®µæˆ‘ä»¬æ˜¯ä¸çŸ¥é“çš„ï¼Œåªæœ‰å½“ç¨‹åºè¿è¡Œæ—¶ï¼Œé€šè¿‡æˆ‘ä»¬è¾“å…¥çš„å€¼æ‰èƒ½ç¡®å®š hero æ˜¯å“ªä¸ªç±»çš„å¯¹è±¡ã€‚\nä½¿ç”¨äº†æ¥å£åï¼Œæ‰€æœ‰å®ç°äº† Skill æ¥å£çš„ç±»ï¼Œéƒ½å¯ä»¥å®ä¾‹åŒ–ä¸º Skill ç±»å‹çš„å¯¹è±¡ã€‚å¦‚æœä¸æ˜¯è¿™æ ·ï¼Œé‚£æœ‰å¤šå°‘ä¸ªè‹±é›„ï¼ˆç±»ï¼‰å°±è¦å®šä¹‰å¤šå°‘ä¸ªå˜é‡ã€‚ç°åœ¨è‹±é›„è”ç›Ÿæœ‰145ä¸ªè‹±é›„ï¼Œé‚£å°±è¦å®šä¹‰145ä¸ªå˜é‡ï¼Œè¿™ã€‚ã€‚ã€‚ã€‚\næ€»ç»“ï¼š æ¥å£çš„ä½œç”¨æ˜¯å®šä¹‰äº†å®šä¹‰äº†ä¸€äº›è§„èŒƒï¼ˆä¹Ÿå°±æ˜¯å®šä¹‰äº†ä¸€äº›æ–¹æ³•ï¼‰ï¼Œæ‰€æœ‰å®ç°äº†è¿™ä¸ªæ¥å£çš„ç±»ï¼Œå¿…é¡»è¦éµå®ˆè¿™äº›è§„èŒƒï¼ˆç±»ä¸­ä¸€å®šæœ‰è¿™äº›æ–¹æ³•ï¼‰ ä¸€ä¸ªç±»å®ç°äº†ä¸€ä¸ªæ¥å£ï¼Œ å¯ä»¥çœ‹åš æ˜¯è¿™ä¸ªæ¥å£çš„å­ç±»ï¼Œæ³¨æ„æ˜¯å¯ä»¥çœ‹åšã€‚å­ç±»ç±»å‹å¯ä»¥è‡ªåŠ¨è½¬æ¢ä¸ºçˆ¶ç±»ç±»å‹ï¼Œæ‰€ä»¥ä»»ä½•å‡ºç°æ¥å£çš„åœ°æ–¹ï¼Œéƒ½å¯ä»¥ä½¿ç”¨å®ç°è¿™ä¸ªæ¥å£çš„ç±»çš„å¯¹è±¡ä»£æ›¿ã€‚æœ€å¸¸è§çš„å°±æ˜¯æ–¹æ³•ä¸­ä¼ å‚ï¼Œå®šä¹‰ä¸€ä¸ªæ¥å£ç±»å‹çš„å˜é‡ï¼Œä¼ å…¥ä¸€ä¸ªå®ç°äº†æ¥å£çš„å¯¹è±¡ã€‚ æœ€åï¼šæ–‡ç« æ˜¯ä¸‹ç­ååŠå¤œå†™çš„ï¼ŒåŠ ä¸Šè‡ªèº«èƒ½åŠ›æœ‰é™ï¼Œæ–‡ä¸­å¦‚æœ‰ä¸æ­£ç¡®çš„åœ°æ–¹ï¼Œæ¬¢è¿è¯„è®ºåŒºæ¢è®¨ï¼Œå…±åŒæé«˜ã€‚\n","date":"2019-08-27T23:23:14Z","permalink":"https://lqxhub.github.io/posts/a96f0ff3/","title":"ç”¨ã€Šè‹±é›„è”ç›Ÿã€‹è§£é‡Šä¸€ä¸‹é¢å‘å¯¹è±¡ä¸­æ¥å£çš„ä½œç”¨"},{"content":"åœ¨çœ‹golang çš„httpæœåŠ¡éƒ¨åˆ†ä»£ç æ—¶ï¼Œè¢«golang ä¸­çš„ type func()å†™æ³•éš¾ä½äº†ï¼Œä¸€æ—¶æ²¡çœ‹æ‡‚ä»£ç ã€‚åæ¥æŸ¥èµ„æ–™åï¼Œæœ‰äº†ä¸€ç‚¹ç†è§£ã€‚\nåœ¨golangä¸­å¯ä»¥é€šè¿‡è¿™æ ·ç®€å•å®ç°ä¸€ä¸ªhttpæœåŠ¡\n1package main 2 3import \u0026#34;net/http\u0026#34; 4 5func mHttp() { 6\thttp.HandleFunc(\u0026#34;/\u0026#34;, h) 7\thttp.ListenAndServe(\u0026#34;0.0.0.0:8888\u0026#34;,nil) 8} 9func h(w http.ResponseWriter, r *http.Request) { 10 11} http.HandleFunc()æ˜¯ä¸€ä¸ªæ³¨å†Œå‡½æ•°ï¼Œä¼ ä¸€ä¸ªstringç±»å‹çš„è·¯ç”±ï¼Œå’Œä¸€ä¸ªå‡½æ•°ï¼Œå‡½æ•°çš„å‚æ•°ä¸º(http.ResponseWriter, *http.Request)ã€‚è·Ÿè¸ªè¿›å…¥å‡½æ•°ï¼Œåœ¨golang æºç net/http/server.goæ–‡ä»¶ä¸­\n1func HandleFunc(pattern string, handler func(ResponseWriter, *Request)) { 2\tDefaultServeMux.HandleFunc(pattern, handler) 3} åœ¨HandleFuncè°ƒç”¨äº† DefaultServeMux.HandleFunc(pattern, handler) è‡³äºè¿™äº›å‡½æ•°æ˜¯å¹²å•¥çš„å…ˆä¸åšæ¢è®¨ï¼Œè¿™ä¸æ˜¯æœ¬æ–‡çš„é‡ç‚¹ã€‚ å†æ¬¡è·Ÿè¿›å‡½æ•°\n1func (mux *ServeMux) HandleFunc(pattern string, handler func(ResponseWriter, *Request)) { 2\tif handler == nil { 3\tpanic(\u0026#34;http: nil handler\u0026#34;) 4\t} 5\tmux.Handle(pattern, HandlerFunc(handler)) 6} åœ¨mux.Handle(pattern, HandlerFunc(handler)) çš„ç¬¬äºŒä¸ªå‚æ•°HandlerFunc(handler)æ˜¯ä»€ä¹ˆé¬¼ã€‚ è·Ÿè¿›çœ‹ä¸€ä¸‹\n1type HandlerFunc func(ResponseWriter, *Request) 2 3func (f HandlerFunc) ServeHTTP(w ResponseWriter, r *Request) { 4\tf(w, r) 5} åŸæ¥HandlerFunc æ˜¯ç”¨ type å®šä¹‰çš„å‡½æ•°ï¼Œè€Œå‡½æ•°çš„ç±»å‹å°±æ˜¯æœ€å¼€å§‹ä¼ å…¥çš„ç±»å‹func(ResponseWriter, *Request) ServeHTTPæ˜¯HandlerFuncçš„ä¸€ä¸ªæ–¹æ³•ï¼ˆæ³¨æ„ä¸€ä¸‹ï¼Œgolangä¸­æ–¹æ³•å’Œå‡½æ•°ä¸æ˜¯ä¸€å›äº‹ï¼‰ã€‚å¹¶ä¸”HandlerFuncå®ç°äº† Handleræ¥å£ Handleræ¥å£å®šä¹‰:\n1type Handler interface { 2\tServeHTTP(ResponseWriter, *Request) 3} å›åˆ°HandleFuncæ–¹æ³•ä¸­ï¼Œmux.Handle(pattern, HandlerFunc(handler))çš„ç¬¬äºŒä¸ªå‚æ•°æ˜¯æŠŠä¼ å…¥çš„å‡½æ•° handler å¼ºè½¬æˆ HandlerFuncç±»å‹ï¼Œè¿™æ ·handlerå°±å®ç°äº†Handleræ¥å£ã€‚ åˆ°è¿™æˆ‘ä»¬æ˜ç™½HandlerFunc(handler) æ˜¯æŠŠæ™®é€šå‡½æ•°å¼ºè½¬æˆtypeå®šä¹‰çš„å‡½æ•°ã€‚ ç°åœ¨å†™ä¸€ä¸ªç®€å•çš„demoéªŒè¯ä¸€ä¸‹ï¼š\n1package main 2 3import \u0026#34;fmt\u0026#34; 4 5func main() { 6\tone(2, callback) 7} 8 9//éœ€è¦ä¼ é€’å‡½æ•° 10func callback(i int) { 11\tfmt.Println(\u0026#34;i am callBack\u0026#34;) 12\tfmt.Println(i) 13} 14 15//mainä¸­è°ƒç”¨çš„å‡½æ•° 16func one(i int, f func(int)) { 17\ttwo(i, fun(f)) 18} 19 20//one()ä¸­è°ƒç”¨çš„å‡½æ•° 21func two(i int, c Call) { 22\tc.call(i) 23} 24 25//å®šä¹‰çš„typeå‡½æ•° 26type fun func(int) 27 28//funå®ç°çš„Callæ¥å£çš„call()å‡½æ•° 29func (f fun) call(i int) { 30\tf(i) 31} 32 33//æ¥å£ 34type Call interface { 35\tcall(int) 36} å…ˆçœ‹ä¸€ä¸‹ç¨‹åºçš„è¿è¡Œç»“æœ: æˆ‘ä»¬åœ¨ main() å‡½æ•°ä¸­è°ƒç”¨äº† one() å‡½æ•°ï¼Œå¹¶ä¼ å…¥äº† callback() å‡½æ•°ï¼Œæœ€ç»ˆè°ƒç”¨äº†æˆ‘ä»¬ä¼ å…¥çš„ callback() å‡½æ•°ã€‚\nç†ä¸€ä¸‹æ€è·¯ï¼š ä½¿ç”¨ type å®šä¹‰å‡½æ•° func(int) å®šä¹‰ Call æ¥å£ï¼ŒCallä¸­æœ‰ä¸€ä¸ªå‡½æ•° call(int) åœ¨ main() ä¸­è°ƒç”¨ one(2, callback)ï¼Œåœ¨ one() ä¸­è°ƒç”¨ two()ï¼Œä¼ å…¥two() å‡½æ•°å‰ï¼Œå¯¹callbackå‡½æ•°å®ç°äº†ç±»å‹è½¬æ¢ï¼Œä»æ™®é€šå‡½æ•°è½¬æ¢æˆtypeå®šä¹‰çš„å‡½æ•°ã€‚ åœ¨ two() ä¸­è°ƒç”¨ä¼ å…¥çš„ c å› ä¸º c å®ç°äº† Call æ¥å£ï¼Œæ‰€ä»¥å¯ä»¥è°ƒç”¨ call() å‡½æ•°ï¼Œæœ€ç»ˆè°ƒç”¨äº†æˆ‘ä»¬ä¼ å…¥çš„ callback() å‡½æ•°ã€‚\nå…³äºgolangä¸­ type func() ç”¨æ³•å…ˆåˆ†æåˆ°è¿™å§ï¼Œæœ‰ä¸åŒçš„è§è§£ï¼Œæ¬¢è¿è¯„è®ºåŒºæ¢è®¨ ","date":"2019-08-25T18:50:33Z","permalink":"https://lqxhub.github.io/posts/20b9663a/","title":"golangä¸­ type func() ç”¨æ³•"},{"content":"ä»Šå¤©åœ¨ç¼–è¯‘golangé¡¹ç›®æ—¶,é‡åˆ°äº†ä¸€ä¸ªé”™è¯¯ã€‚ç¼–è¯‘å™¨æç¤º cannot assign to m[1][1]\nåŸé¡¹ç›®å¤ªå¤§äº†ï¼Œä¸è´´äº†ä»£ç å¤§ä½“æ˜¯è¿™æ ·çš„\n1package main 2 3func main() { 4\tm := make(map[int][2]int) 5\ta := [2]int{1, 2} 6\tm[1] = a 7 8\tm[1][1] = 3 9} ç¼–è¯‘å™¨æç¤ºï¼Œä¸èƒ½å–åˆ°m[1][1]çš„åœ°å€ã€‚ ä½†æ˜¯ä½¿ç”¨ fmt èƒ½æ‰“å°å‡ºæ•°å€¼\n1package main 2 3import \u0026#34;fmt\u0026#34; 4 5func main() { 6\tm := make(map[int][2]int) 7\ta := [2]int{1, 2} 8\tm[1] = a 9 10\t// m[1][1] = 3 11\tfmt.Println(m[1][1]) 12} æ‰“å°ç»“æœ æƒ³äº†ä¸€ä¸‹ï¼Œgoä¸­çš„æ•°ç»„å’Œåˆ‡ç‰‡(Slice)çš„å’Œæ•°ç»„(Array)æ˜¯ä¸ä¸€æ ·çš„ï¼Œsliceæ˜¯å¼•ç”¨ä¼ é€’ï¼Œarrayæ˜¯å€¼ä¼ é€’ã€‚æŠŠ a æ¢æˆsliceè¯•ä¸€ä¸‹ ä»£ç å¦‚ä¸‹ï¼š\n1package main 2 3import \u0026#34;fmt\u0026#34; 4 5func main() { 6\tm := make(map[int][]int) 7\ta := []int{1, 2} 8\tm[1] = a 9 10\tm[1][1] = 3 11\tfmt.Println(m[1][1]) 12} ç¼–è¯‘é€šè¿‡ï¼Œæ²¡æœ‰é—®é¢˜ã€‚\né—®é¢˜æ‰¾åˆ°äº†ï¼Œæ˜¯å› ä¸ºå€¼ä¼ é€’å¯¼è‡´çš„é—®é¢˜ï¼Œè§£å†³åŠæ³•æœ‰ä¸‰ç§ 1 . åƒä¸Šé¢ä¸€æ ·ï¼Œä½¿ç”¨sliceä»£æ›¿arrayã€‚ 2 . ä¸ç›´æ¥ä¿®æ”¹æ•°ç»„çš„å€¼ï¼Œä¿®æ”¹å€¼æ—¶ï¼Œé‡æ–°åˆ›å»ºæ•°ç»„ï¼š\n1package main 2 3import \u0026#34;fmt\u0026#34; 4 5func main() { 6\tm := make(map[int][2]int) 7\ta := [2]int{1, 2} 8\tm[1] = a 9\tfmt.Println(m) 10 11\tb := [2]int{3, 4} 12\tm[1] = b 13\tfmt.Println(m) 14} ç»“æœå¦‚ä¸‹ï¼š 3 .ä½¿ç”¨æŒ‡å‘æ•°ç»„çš„æŒ‡é’ˆï¼š\n1package main 2 3import \u0026#34;fmt\u0026#34; 4 5func main() { 6\tm := make(map[int]*[2]int) 7\ta := \u0026amp;[2]int{1, 2} 8\tm[1] = a 9\tfmt.Println(m[1]) 10 11\tm[1][1] = 3 12\tfmt.Println(m[1]) 13} ç»“æœå¦‚ä¸‹ï¼š æ²¡æœ‰é—®é¢˜ï¼Œå¯ä»¥ä¿®æ”¹å€¼ åœ¨ç½‘ä¸Šæœç´¢æ²¡æœ‰æ‰¾åˆ°æ·±å…¥ç‚¹åˆ†æçš„æ–‡ç« ï¼Œæœ€ç»ˆåœ¨stack overflowä¸­æ‰¾åˆ°äº†ä¸€ä¸ªæŒºå¥½çš„åˆ†æä¼ é€é—¨ åŸæ–‡ï¼š\np[\u0026quot;HM\u0026quot;]Â isn\u0026rsquo;t quite a regularÂ addressableÂ value:Â hashmaps can grow at runtime, and then their values get moved around in memory, and the old locations become outdated. If values in maps were treated as regular addressable values, those internals of theÂ mapÂ implementation would get exposed. è‹±æ–‡æ¯”è¾ƒæ¸£ï¼Œå¤§ä½“çœ‹æ‡‚äº†ä¸€ç‚¹æ„æ€ã€‚æˆ‘ç†è§£çš„ï¼Œåº”è¯¥æ˜¯åœ¨ç¨‹åºæ‰§è¡Œè¿‡ç¨‹ä¸­mapçš„é•¿åº¦ä¼šå˜åŒ–ï¼Œä¸ºäº†mapå€¼çš„æ­£ç¡®ï¼Œgoè¯­è¨€ä¸å…è®¸ç›´æ¥ä¿®æ”¹mapä¸­çš„å€¼ç±»å‹ç»“æ„ã€‚\nåœ¨æƒ³å¦ä¸€ç§æƒ…å†µ:\n1package main 2 3import \u0026#34;fmt\u0026#34; 4 5func main() { 6\tm := make(map[int]T) 7\tt := T{ 8\tOne: 1, 9\tTwo: 2, 10\t} 11\tm[1] = t 12\tfmt.Println(m) 13\tm[1].Two = 3 14\tfmt.Println(m[1]) 15} 16 17type T struct { 18\tOne int 19\tTwo int 20} è¿è¡Œï¼š ç¼–è¯‘å™¨æç¤ºåŒæ ·çš„é”™è¯¯ æ¢æˆæŒ‡é’ˆåï¼š\n1package main 2 3import \u0026#34;fmt\u0026#34; 4 5func main() { 6\tm := make(map[int]*T) 7\tt := \u0026amp;T{ 8\tOne: 1, 9\tTwo: 2, 10\t} 11\tm[1] = t 12\tfmt.Println(m[1]) 13\tm[1].Two = 3 14\tfmt.Println(m[1]) 15} 16 17type T struct { 18\tOne int 19\tTwo int 20} è¿è¡Œï¼š å…ˆæ€»ç»“åˆ°è¿™æŠŠï¼Œ996ç¡®å®æœ‰ç‚¹ç´¯ã€‚æ—©ç¡æ—©èµ·å¤šæ¬ç – ","date":"2019-08-19T22:42:43Z","permalink":"https://lqxhub.github.io/posts/f0f408a8/","title":"golang cannot assign to XXX é”™è¯¯"},{"content":"golangæ˜¯ä¸€ç§å¼ºç±»å‹è¯­è¨€ï¼Œè™½ç„¶åœ¨ä»£ç ä¸­ç»å¸¸çœ‹åˆ°è¿™ç§å†™æ³•ï¼Œi:=10è¿™å…¶å®è¿™æ˜¯ç¼–è¯‘å™¨è‡ªåŠ¨åšäº†ç±»å‹æ¨æ–­åœ¨ç¼–è¯‘æœŸé—´ã€‚ç¼–è¯‘å™¨ä¼šå¯¹æ•°æ®è¿›è¡Œç±»å‹æ£€æŸ¥ã€‚ä¸åŒç±»å‹çš„æ•°æ®ä¸èƒ½èµ‹å€¼,ä¸èƒ½åœ¨å‡½æ•°ä¸­ä¼ å‚ã€‚å¼ºç±»å‹è¯­è¨€æœ‰ä¸€äº›ä¼˜åŠ¿ï¼Œå¾ˆå¤šçš„é”™è¯¯ä¼šåœ¨ç¼–è¯‘æœŸé—´è¢«æ£€æŸ¥å‡ºæ¥ï¼Œä¸æƒ³phpå’Œpythonç­‰å¼±ç±»å‹è¯­è¨€ï¼Œå¾ˆå¤šé”™è¯¯åªæœ‰è¿è¡Œåˆ°æ‰èƒ½è¢«å‘ç°ã€‚åŒæ ·ï¼Œå¼ºç±»å‹ä¹Ÿæœ‰ä¸€äº›ç¼ºç‚¹ï¼Œå†™ä»£ç çš„æ—¶å€™è¦è€ƒè™‘æ•°æ®ç±»å‹äº†ï¼Œå¤±å»äº†ä¸€äº›çµæ´»æ€§ã€‚\nè¨€å½’æ­£ä¼ ï¼Œå¼€å§‹golangçš„ç±»å‹è½¬æ¢é—®é¢˜ golangçš„ç±»å‹è½¬æ¢å’ŒC/C++ javaç­‰è¯­è¨€çš„ç±»å‹è½¬æ¢è¿˜æœ‰ç‚¹åŒºåˆ«\nC/C++ç­‰è¯­è¨€æœ‰éšå¼ç±»å‹è½¬æ¢ï¼Œgolangä¸­æ²¡æœ‰ golangä¸­çš„ç±»å‹è½¬æ¢åˆ†å¼ºåˆ¶ç±»å‹è½¬æ¢å’Œç±»å‹æ–­è¨€ åœ¨C/C++ä¸­ 1int main() 2{ 3 int a=5; 4 float b=3.5; 5 printf(\u0026#34;%f\u0026#34;,a*b); 6} è¿™æ ·çš„ä»£ç æ˜¯æ²¡æœ‰é—®é¢˜çš„,ç¼–è¯‘å™¨éšå¼çš„æŠŠaå‘ä¸Šè½¬ä¸ºfloatç±»å‹ã€‚ ä½†æ˜¯åœ¨golangä¸­\n1package main 2 3import \u0026#34;fmt\u0026#34; 4 5func main() { 6\tvar a float32 = 5.6 7\tvar b int = 10 8\tfmt.Println (a * b) 9} è¿™æ ·çš„ä»£ç ä¼šæŠ¥é”™ï¼Œå› ä¸ºç±»å‹ä¸åŒ¹é… è¿™æ—¶å€™éœ€è¦å¼ºåˆ¶ç±»å‹è½¬æ¢\n1package main 2 3import \u0026#34;fmt\u0026#34; 4 5func main() { 6\tvar a float32 = 5.6 7\tvar b int = 10 8\tfmt.Println (a * float32(b)) 9} è¿™æ ·å°±ä¸ä¼šæŠ¥é”™äº† æ™®é€šå˜é‡ç±»å‹int,float,string éƒ½å¯ä»¥ä½¿ç”¨ type (a)è¿™ç§å½¢å¼æ¥è¿›è¡Œå¼ºåˆ¶ç±»å‹è½¬æ¢,æ¯”å¦‚\n1var a int32 = 10 2var b int64 = int64(a) 3var c float32 = 12.3 4var d float64 =float64(c) golangä¸­ æŒ‡é’ˆä¹Ÿæ˜¯æœ‰ç±»å‹çš„,\n1package main 2 3func main() { 4\tvar a int = 10 5\tvar p *int =\u0026amp;a 6\tvar c *int64 7\tc= (*int64)(p) 8} è¿™æ ·çš„ä»£ç æ˜¯é”™è¯¯çš„,ç¼–è¯‘å™¨ä¼šæç¤ºcannot convert p (type *int) to type *int64 æŒ‡é’ˆçš„å¼ºåˆ¶ç±»å‹è½¬æ¢éœ€è¦ç”¨åˆ°unsafeåŒ…ä¸­çš„å‡½æ•°å®ç°\n1package main 2 3import \u0026#34;unsafe\u0026#34; 4import \u0026#34;fmt\u0026#34; 5 6func main() { 7 var a int =10 8 var b *int =\u0026amp;a 9\tvar c *int64 = (*int64)(unsafe.Pointer(b)) 10\tfmt.Println(*c) 11} golangä¸­è¿˜æœ‰ä¸€ä¸­ç±»å‹åˆ¤æ–­,ç±»å‹æ–­è¨€\n1package main 2 3import \u0026#34;fmt\u0026#34; 4 5func main() { 6\tvar a interface{} =10 7\tswitch a.(type){ 8\tcase int: 9\tfmt.Println(\u0026#34;int\u0026#34;) 10\tcase float32: 11\tfmt.Println(\u0026#34;string\u0026#34;) 12\t} 13} ç¨‹åºè¾“å‡ºç»“æœæ˜¯int\nç±»å‹æ–­è¨€è¿˜æœ‰ä¸€ç§ç”¨æ³•\n1package main 2 3import \u0026#34;fmt\u0026#34; 4 5func main() { 6\tvar a interface{} =10 7\tt,ok:= a.(int) 8\tif ok{ 9\tfmt.Println(\u0026#34;int\u0026#34;,t) 10\t} 11\tt2,ok:= a.(float32) 12\tif ok{ 13\tfmt.Println(\u0026#34;float32\u0026#34;,t2) 14\t} 15} t,ok:= a.(int)æœ‰ä¸¤ä¸ªè¿”å›å€¼,ç¬¬ä¸€ä¸ªæ˜¯å¯¹åº”ç±»å‹çš„å€¼,ç¬¬äºŒä¸ªæ˜¯boolç±»å‹çš„,ç±»å‹åˆ¤æ–­æ˜¯å¦æ­£ç¡®ã€‚\nå¥½äº†ï¼Œgolangçš„å¼ºåˆ¶ç±»å‹è½¬æ¢å†™å†™åˆ°è¿™ï¼ŒåŠå¤œå›°äº†ï¼Œæƒ³åˆ°å•¥åœ¨è¡¥å……å§ã€‚ä¸‹æ¬¡å†™ä¸€ä¸‹golangä¸­æ•°å­—å’Œå­—ç¬¦ä¸²ä¹‹é—´çš„è½¬æ¢\n","date":"2019-07-01T23:36:03Z","permalink":"https://lqxhub.github.io/posts/7395675/","title":"golangå¼ºåˆ¶ç±»å‹è½¬æ¢"},{"content":"åœ¨PHPæ—¥å¸¸å¼€å‘ä¸­,ç»å¸¸éœ€è¦å¤„ç†å‰ç«¯ä¸Šä¼ æ¥çš„å›¾ç‰‡,æœ€ç®€å•çš„å°±æ˜¯ä¿å­˜ä¸€ä¸‹,æœ‰æ—¶å€™éœ€è¦è¿›è¡Œä¸€äº›å¤„ç†,æ¯”å¦‚å‹ç¼©å›¾ç‰‡,ç”Ÿæˆç¼©ç•¥å›¾ç­‰ç­‰ è¿™äº›è¿˜å¥½è¯´,æ›´å‘çš„æ˜¯,æœ‰æ—¶å€™å‰ç«¯ä¸Šä¼ çš„å›¾ç‰‡,æœåŠ¡ç«¯è½¬å­˜å,è«åå…¶å¦™çš„æ—‹è½¬äº†90åº¦,æ—‹è½¬äº†180åº¦ã€‚å…³é”®æ˜¯æœ‰çš„æ—¶å€™è¿™äº›å›¾ç‰‡åœ¨å‰ç«¯æ˜¾ç¤ºæ˜¯æ­£å¸¸çš„,åˆ°æœåŠ¡ç«¯è½¬å­˜å,å°±å‡ºé—®é¢˜äº†,å‰ç«¯çš„åŒå­¦è¡¨ç¤ºä¸èƒŒè¿™é”…,è¿™æ˜¯ä½ åç«¯çš„é—®é¢˜!\næ²¡åŠæ³•,è‡ªå·±è§£å†³å§ PHPä¸­æœ‰å¤„ç†å›¾ç‰‡æ—‹è½¬çš„æ‹“å±•exifï¼Œè¦å¤„ç†å›¾ç‰‡æ—‹è½¬é—®é¢˜,å¿…é¡»å®‰è£…è¿™ä¸ªæ‹“å±•ï¼Œexifæ‹“å±•ä¾èµ–php_mbstringè¿™ä¸ªæ‹“å±•ï¼Œæ‰€ä»¥è¦å®‰è£…è¿™ä¸¤ä¸ªæ‹“å±•ã€‚ åœ¨phpinfoä¸­èƒ½çœ‹åˆ°è¿™ä¸¤ä¸ªæ‹“å±•,å°±OKäº†ã€‚ å¦‚æœæ²¡æœ‰å®‰è£…ï¼Œå°±éœ€è¦æ‰‹åŠ¨å®‰è£…ä¸€ä¸‹äº†ï¼Œåªè¯´Linuxä¸Šæ€ä¹ˆå®‰è£…ï¼ŒWindowsä¸Šä¸€èˆ¬éƒ½ç”¨WAMPï¼ŒWAMPå¯ä»¥ä¸€é”®å®‰è£…çš„ã€‚\nLinuxæ¨èä½¿ç”¨æºç å®‰è£…\né¦–å…ˆä¸‹è½½æ‹“å±•çš„æºç ï¼Œå¯ä»¥å»å®˜ç½‘ä¸‹è½½ï¼Œæˆ‘ç”¨çš„php7.2ï¼Œå¯ä»¥åœ¨è¿™é‡Œä¸‹è½½https://pan.baidu.com/s/1RmgFY3bAkyK_Yu636zrx3g æå–ç : pm7y ç¼–è¯‘å®‰è£… è¿›å…¥æºç çš„ç›®å½• ä½¿ç”¨/usr/local/php/bin/phpizeå‘½ä»¤,ç”Ÿæˆconfigureï¼ˆå‡è®¾phpå®‰è£…åœ¨/usr/local/phpç›®å½•ä¸‹ï¼‰ ä½¿ç”¨./configure --with-php-config=/usr/local/php/bin/php-configå‘½ä»¤ç”Ÿæˆ Makefileæ–‡ä»¶ ä½¿ç”¨make \u0026amp;\u0026amp; make installå‘½ä»¤ç¼–è¯‘å®‰è£… å»ä¿®æ”¹php.iniæ–‡ä»¶(å¯èƒ½åœ¨**/usr/local/php/etcç›®å½•æˆ–è€…/etc/php/ç›®å½•ä¸‹),æ‰¾åˆ° extension æŠŠ extension=mbstringå’Œ extension=exifå‰é¢çš„;**å»æ‰æ²¡æœ‰çš„åŠ ä¸Šè¿™ä¸¤å¥ï¼ŒæŠŠextension=mbstringæ”¾åœ¨extension=exifå‰é¢ï¼Œä¿å­˜é€€å‡º é‡å¯Apacheæˆ–è€…nginxï¼ŒæŸ¥çœ‹phpinfoï¼Œæœ‰æ²¡æœ‰è¿™ä¸¤ä¸ªæ‹“å±• å‡†å¤‡å·¥ä½œOKäº†,å¯ä»¥å¼€å§‹å†™ä»£ç äº†ï¼Œåªå†™ä¸€ä¸‹ç®€å•çš„é€»è¾‘ä»£ç å§\n1 $str = \u0026#39;æ–‡ä»¶è·¯å¾„\u0026#39;; 2 $savePath=\u0026#39;ä¿å­˜è·¯å¾„\u0026#39;; 3 $image = imagecreatefromstring(file_get_contents($str)); 4 $exif = exif_read_data($str); 5 6 if (!empty($exif[\u0026#39;Orientation\u0026#39;])) { 7 switch ($exif[\u0026#39;Orientation\u0026#39;]) { 8 case 8: 9 $image = imagerotate($image, 90, 0); 10 break; 11 case 3: 12 $image = imagerotate($image, 180, 0); 13 break; 14 case 6: 15 $image = imagerotate($image, -90, 0); 16 break; 17 } 18 imagejpeg($image, $savePath); 19 imagedestroy($image); 20 } Orientationä¸­çš„å€¼ä»£è¡¨ä»€ä¹ˆå«ä¹‰,æˆ‘è¿˜æ²¡æŸ¥åˆ°,ç­‰æŸ¥åˆ°å†è¡¥å……å§ï¼Œæ¬¢è¿å¤§ä½¬è¯„è®ºåŒºè¡¥å……\nè¯´ä¸€ä¸‹é‡åˆ°çš„å‘ è·å–å›¾ç‰‡ä¿¡æ¯ï¼Œåœ¨php7ä¹‹å‰ï¼Œç”¨exif_imagetype()å‡½æ•°ï¼Œåœ¨php7ä»¥åç”¨exif_read_data()å‡½æ•° ä¸€å®šè¦åˆ¤æ–­æ˜¯è·å–åˆ°å›¾ç‰‡ä¿¡æ¯çš„æ•°ç»„ä¸­å¦å­˜åœ¨Orientationå­—æ®µï¼Œå› ä¸ºå¾ˆå¤šå›¾ç‰‡ä¸­æ²¡æœ‰æ²¡æœ‰è¿™ä¸ªå±æ€§ï¼Œæˆ–è€…å±æ€§ä¸ºç©ºï¼Œä¸€ç‚¹è¦åˆ¤æ–­ ","date":"2019-03-29T10:53:57Z","permalink":"https://lqxhub.github.io/posts/9dd71679/","title":"PHPå¤„ç†å›¾ç‰‡(orientation)æ—‹è½¬é—®é¢˜"},{"content":"HTTPåè®®ä¸­çš„POST æ–¹æ³•æœ‰å¤šä¸­æ ¼å¼çš„æ•°æ®åè®®,åœ¨HTTPçš„headä¸­ç”¨ä¸åŒçš„Content-typeæ ‡è¯†.å¸¸ç”¨çš„æœ‰\napplication/x-www-form-urlencoded,è¿™æ˜¯æœ€å¸¸è§çš„,å°±æ˜¯fromè¡¨å•çš„æ ¼å¼.åœ¨HTTPçš„headä¸­æ˜¯Content-Type: application/x-www-form-urlencoded.\nmultipart/form-data,è¿™ä¸ªæ˜¯ç”¨æ¥ä¸Šä¼ æ–‡ä»¶çš„,åœ¨HTTPçš„headä¸­æ˜¯Content-Type: multipart/form-data; boundary=----WebKitFormBoundary7MA4YWxkTrZu0gW\nRaw è¿™ä¸ªä¸æ˜¯ç‰¹åˆ«å¸¸ç”¨,ä¼ è¾“çš„æ•°æ®åœ¨HTTPçš„bodyä¸­åªæœ‰ä¸€æ®µ,ä¸æ˜¯ä»¥é”®å€¼å¯¹çš„å½¢å¼å­˜æ”¾.åœ¨HTTPçš„headä¸­æ˜¯Content-Type: application/json,Content-Type: text,Content-Type: application/xml,Content-Type: text/xml,ç­‰ç­‰å½¢å¼\nå¯¹äºContent-Type: application/x-www-form-urlencodedè¿™ç§formè¡¨å•çš„æ•°æ®,åœ¨phpä¸­,ä½¿ç”¨$_POST['name']å¯ä»¥ç›´æ¥è·å–, æ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«çš„\nContent-Type: multipart/form-data; è¿™ç§æ ¼å¼çš„æ•°æ®,åœ¨phpä¸­ä½¿ç”¨$_POST['name']å¯ä»¥è·å–å­—ç¬¦æ•°æ®,ä½¿ç”¨$_FILES['file']å¯ä»¥è·å–.\nå¯¹äºRawè¿™ç§æ ¼å¼çš„æ•°æ®,ä½¿ç”¨ä»¥ä¸Šä¸¤ç§åŠæ³•æ²¡æœ‰åŠæ³•è·å–åˆ°,éœ€è¦ä½¿ç”¨åˆ«çš„æ‰‹æ®µ. 1.ä½¿ç”¨file_get_contents(\u0026quot;php://input\u0026quot;)è·å–;å†™ä¸€ä¸ªç®€å•phpæ–‡ä»¶æµ‹è¯•ä¸€ä¸‹\n1\u0026lt;?php 2$test=file_get_contents(\u0026#34;php://input\u0026#34;); 3echo $test; ç”¨postmanæµ‹è¯•ä¸€ä¸‹ æ²¡é—®é¢˜,å¯ä»¥æ¥æ”¶åˆ°\n2.ä½¿ç”¨$GLOBALS['HTTP_RAW_POST_DATA']æ¥æ”¶\n1\u0026lt;?php 2$test=$GLOBALS[\u0026#39;HTTP_RAW_POST_DATA\u0026#39;]; 3echo $test; ç”¨postmanæµ‹è¯•ä¸€ä¸‹ å§æ§½,ç«Ÿç„¶å‡ºé”™äº†,æç¤ºæ²¡æœ‰å‘ç°HTTP_RAW_POST_DATAè¿™ä¸ªæ•°ç»„ç´¢å¼•,ä»€ä¹ˆé¬¼.Googleä¸€ç•ª,åœ¨phpçš„å®˜ç½‘çœ‹åˆ°äº†è¿™æ ·ä¸€æ®µè¯ åŸæ¥HTTP_RAW_POST_DATAè¿™ä¸ªåœ¨php5.6ä¸­å·²ç»è¢«åºŸå¼ƒäº†,åœ¨php7.0ä»¥åçš„ç‰ˆæœ¬ä¸­å·²ç»è¢«åˆ é™¤äº†,æˆ‘ç”¨çš„phpç‰ˆæœ¬ä¸º7.2,è‚¯å®šå°±å‡ºé”™äº†\nå¥½å§,é‚£å°±è€è€å®å®çš„ç”¨file_get_contents(\u0026quot;php://input\u0026quot;)è·å–å§\nåœ¨å®é™…å¼€å‘ä¸­,ä¸€èˆ¬éƒ½æ˜¯ä½¿ç”¨æ¡†æ¶çš„,æˆ‘ç”¨thinkphpç”¨æ¯”è¾ƒå¤š,åœ¨tp5.0ä¸­å¯ä»¥ä½¿ç”¨Requestçš„getInput()å‡½æ•°è·å–Rawä¸­çš„æ•°æ®\n1\u0026lt;?php 2 3namespace app\\index\\controller; 4 5use think\\Request; 6 7class Index 8{ 9 public function index(Request $request) 10 { 11 echo $request-\u0026gt;getInput(); 12 } 13} æµ‹è¯•ä¸€ä¸‹ æ²¡æœ‰é—®é¢˜,å¯ä»¥æ­£å¸¸è·å–\nå…³äºphpè·å–HTTP POSTæ•°æ®çš„æ–¹æ³•å…ˆä»‹ç»åˆ°è¿™é‡Œ\n","date":"2018-12-27T13:39:26Z","permalink":"https://lqxhub.github.io/posts/ba4d9bad/","title":"php è·å–HTTP POSTä¸­ä¸åŒæ ¼å¼çš„æ•°æ®"},{"content":"åœ¨mysqlä¸­,å¤šè¡¨è¿æ¥æŸ¥è¯¢æ˜¯å¾ˆå¸¸è§çš„éœ€æ±‚,åœ¨ä½¿ç”¨å¤šè¡¨æŸ¥è¯¢æ—¶,å¯ä»¥fromå¤šä¸ªè¡¨,ä¹Ÿå¯ä»¥ä½¿ç”¨joinè¿æ¥è¿ä¸ªè¡¨ è¿™ä¸¤ç§æŸ¥è¯¢æœ‰ä»€ä¹ˆåŒºåˆ«?å“ªç§æŸ¥è¯¢çš„æ•ˆç‡æ›´é«˜å‘¢? å¸¦ç€è¿™äº›ç–‘é—®,å†³å®šåŠ¨æ‰‹è¯•è¯•\n1.å…ˆåœ¨æœ¬åœ°çš„mysqlä¸Šå…ˆå»ºä¸¤ä¸ªè¡¨oneå’Œtwo oneè¡¨\n1CREATE TABLE `one` ( 2 `id` int(0) NOT NULL AUTO_INCREMENT, 3 `one` varchar(100) NOT NULL, 4 PRIMARY KEY (`id`) 5) ENGINE = InnoDB CHARACTER SET = utf8; twoè¡¨\n1CREATE TABLE `two` ( 2 `id` int(0) NOT NULL AUTO_INCREMENT, 3 `two` varchar(100) NOT NULL, 4 PRIMARY KEY (`id`) 5) ENGINE = InnoDB CHARACTER SET = utf8; å…ˆéšä¾¿æ’å…¥å‡ æ¡æ•°æ®,æŸ¥è¯¢çœ‹ä¸€ä¸‹;\n1select one.id,one.one,two.id,two.two from one,two where one.id=two.id; 1select one.id,one.one,two.id,two.two from one join two on one.id=two.id; å¯¹æ¯”è¿™ä¸¤æ¬¡çš„æŸ¥è¯¢,æŸ¥è¯¢æ—¶é—´å‡ ä¹æ²¡æœ‰åŒºåˆ«,æŸ¥çœ‹sqlè¿è¡Œåˆ†æ,ä¹Ÿæ²¡æœ‰åŒºåˆ«\nä¸ºäº†çªå‡ºä¸¤ç§æŸ¥è¯¢çš„æ€§èƒ½å·®å¼‚,å¾€oneè¡¨ä¸­æ’å…¥100wæ¡æ•°æ®,å¾€twoè¡¨ä¸­æ’å…¥10wæ¡æ•°æ®,åœ¨å¤§é‡æ•°æ®é¢å‰,ä¸€ä¸ä¸€æ¯«çš„å·®åˆ«ä¹Ÿä¼šè¢«æ— é™æ”¾å¤§;è¿™æ—¶å€™åœ¨æ¥æ¯”è¾ƒä¸€ä¸‹å·®å¼‚\nå…ˆä½¿ç”¨pythonå¾€æ•°æ®åº“ä¸­æ’å…¥æ•°æ®,ä¸ºå•¥ç”¨python,å› ä¸ºpythonå†™èµ·äº†ç®€å• ä¸Šä»£ç \n1import pymysql 2 3db = pymysql.connect(\u0026#34;127.0.0.1\u0026#34;, \u0026#39;root\u0026#39;, \u0026#34;123456\u0026#34;, \u0026#34;bruce\u0026#34;) 4cursor = db.cursor() 5 6sql = \u0026#34;INSERT INTO one (one) values (%s)\u0026#34; 7for i in range(1000000): 8 cursor.executemany(sql, [\u0026#39;one\u0026#39; + str(i)]) 9 if i % 10000 == 0: 10 db.commit() 11 print(str(i) + \u0026#39;æ¬¡ commit\u0026#39;) 12db.commit() 13 14print(\u0026#39;insert one ok\u0026#39;) 15sql2 = \u0026#34;INSERT INTO two (two) values (%s)\u0026#34; 16for i in range(100000): 17 cursor.executemany(sql2, [\u0026#39;two\u0026#39; + str(i)]) 18 if i % 10000 == 0: 19 db.commit() 20 print(str(i) + \u0026#39;æ¬¡ commit\u0026#39;) 21db.commit() 22print(\u0026#39;insert two ok\u0026#39;) è€å¿ƒç­‰å¾…ä¸€ä¼š,æ’å…¥éœ€è¦ä¸€äº›æ—¶é—´;\nç­‰æ•°æ®æ’å…¥å®Œæˆ,æ¥æŸ¥è¯¢ä¸€äº›çœ‹çœ‹ å…ˆä½¿ç”¨FROMä¸¤ä¸ªè¡¨æŸ¥è¯¢\n1select one.id,one.one,two.id,two.two from one,two where one.id=two.id; ç”¨æ—¶å¤§çº¦20.49;\nå†ç”¨JOINæŸ¥è¯¢çœ‹ä¸€ä¸‹\n1select one.id,one.one,two.id,two.two from one join two on one.id=two.id; ç”¨æ—¶19.45,åœ¨10wæ¡æ•°æ®ä¸­,1ç§’çš„è¯¯å·®å¹¶ä¸ç®—å¤§, æŸ¥çœ‹ä¸€ä¸‹ä½¿ç”¨idä½œä¸ºæ¡ä»¶çº¦æŸæ—¶çš„æŸ¥è¯¢ æŸ¥è¯¢æ—¶é—´æ²¡æœ‰å·®åˆ«\nå†çœ‹ä¸€ä¸‹sqlæ‰§è¡Œåˆ†æ ç»“æœè¿˜æ˜¯ä¸€æ ·çš„\næ€»ç»“ åœ¨mysqlä¸­ä½¿ç”¨FROMæŸ¥è¯¢å¤šè¡¨å’Œä½¿ç”¨JOINè¿æ¥(LEFT JOIN,RIGHT JOINé™¤å¤–),æŸ¥è¯¢ç»“æœ,æŸ¥è¯¢æ•ˆç‡æ˜¯ä¸€æ ·çš„\n","date":"2018-12-27T11:29:19Z","permalink":"https://lqxhub.github.io/posts/63c229e6/","title":"mysqlä½¿ç”¨ fromä¸¤è¡¨æŸ¥è¯¢ä¸joinä¸¤è¡¨æŸ¥è¯¢åŒºåˆ«"},{"content":"æœ€è¿‘å’Œå­¦å¼Ÿåœ¨è°ƒè¯•ä¸€ä¸ªGPRSé€šä¿¡æ¨¡å—,éœ€æ±‚æ˜¯é€šè¿‡GPRSæ¨¡å—é€šè¿‡httpåè®®å‘é€æ•°æ®åˆ°æœåŠ¡å™¨,ä½†æ˜¯httpåè®®ä¸€ç›´å¤±è´¥,æœåŠ¡å™¨è¿”å›400,é€šè¿‡æŸ¥è¯¢httpçŠ¶æ€ç å¾—çŸ¥,http400é”™è¯¯æ˜¯è¯·æ±‚æ— æ•ˆ,å› ä¸ºGPRSæ¨¡å—æ²¡æœ‰å®ç°httpåè®®çš„å°è£…,éœ€è¦åœ¨TCPåè®®çš„åŸºç¡€ä¸Š,æ‰‹åŠ¨æ‹¼è£…httpæ ¼å¼çš„æŠ¥æ–‡.æ‰€ä»¥åˆæ­¥çŒœæµ‹æ˜¯httpåè®®æ ¼å¼é”™è¯¯å¯¼è‡´çš„.\nè¿™æ—¶å€™,æœ€ç®€å•æœ‰æ•ˆçš„è°ƒé”™æ–¹å¼å°±æ˜¯é€šè¿‡æŠ“åŒ…åˆ†æ,æŸ¥çœ‹æ•°æ®æ ¼å¼,ç„¶åä¿®æ”¹.ä½†æ˜¯åœ¨GPRSæ¨¡å—ä¸Šæ²¡æ³•å®‰è£…æŠ“åŒ…å·¥å…·,åªèƒ½åœ¨æœåŠ¡å™¨ä¸ŠæŠ“åŒ…,æœåŠ¡å™¨æ˜¯centosçš„,è™½ç„¶æœ‰tcpdumpå·¥å…·,ä½†æ˜¯æ²¡æœ‰ç•Œé¢,æ²¡æ³•å…·ä½“åˆ†ææ•°æ®åŒ…. ç›´æ¥ä½¿ç”¨tcpdumpæŠ“åˆ°çš„æ•°æ®åŒ…,æ ¹æœ¬æ²¡æ³•åˆ†æå¥½ä¸.\nåœ¨windowsä¸Š,æœ‰wiresharkè¿™ä¸ªå·¥å…·,å¯ä»¥å¾ˆæ–¹ä¾¿çš„åˆ†æç½‘ç»œæ•°æ®åŒ…,è¿™ä¸ªè½¯ä»¶æœ‰å¤šç‰›é¼»å°±ä¸ç”¨å¤šè¯´äº†,æ‰€æœ‰ç»è¿‡ç½‘å¡æ•°æ®éƒ½èƒ½æŠ“åˆ°,é…åˆå›¾å½¢ç•Œé¢,å¯ä»¥å¾ˆæ–¹ä¾¿çš„æŸ¥çœ‹åˆ†ææ•°æ®.ä¸çŸ¥èƒ½æŸ¥çœ‹åº”ç”¨å±‚åè®®çš„æ•°æ®,ç½‘ç»œä¸­çš„äº”å±‚åè®®éƒ½èƒ½æŸ¥çœ‹. æœ‰æ²¡æœ‰åŠæ³•æŠŠtcpdumpå’Œwiresharkè¿™ä¸¤ä¸ªè½¯ä»¶ç»“åˆèµ·æ¥ä½¿ç”¨å‘¢??? åŠæ³•å½“ç„¶æ˜¯æœ‰çš„,æŠŠtcpdumpæŠ“å–çš„æ•°æ®è½¬å­˜æ–‡ä»¶,ç„¶åç”¨wiresharkæ‰“å¼€æ–‡ä»¶,åˆ†ææ•°æ®.\n1.å¼€å¯tcpdumpæŠ“åŒ…,å¹¶å°†ç»“æœè½¬å­˜ä¸ºæ–‡ä»¶ tcpdump tcp -s 0 port 80 -w ./http.cap è¯´ä¸€ä¸‹è¿™å‡ ä¸ªå‚æ•° tcpæ˜¯æŒ‡å®šæŠ“å–é‚£ç§åè®®çš„æ•°æ®,å› ä¸ºæˆ‘ä»¬è¦æŠ“å–httpåè®®,ä½†æ˜¯tcpä¸èƒ½æŒ‡å®šhttpåè®®,ä½†æ˜¯httpåè®®æ˜¯åŸºäºTCPåè®®çš„,æ‰€ä»¥æŠ“å–TCPåè®®æ•°æ®. -s 0 tcpdump æŠ“å–æ•°æ®åŒ…æ—¶é»˜è®¤æŠ“å–é•¿åº¦ä¸º68å­—èŠ‚ã€‚åŠ ä¸Š-S 0 åå¯ä»¥æŠ“åˆ°å®Œæ•´çš„æ•°æ®åŒ… port 80 æˆ‘çš„æœåŠ¡å™¨ç›‘å¬çš„80ç«¯å£,æ‰€ä»¥åªæŠ“å–80ç«¯å£çš„æ•°æ®. -w ./http.cap æŒ‡å®štcpdumpè½¬å­˜æ•°æ®æ—¶çš„æ–‡ä»¶ ./http.capæ˜¯å½“å‰ç›®å½•ä¸‹çš„http.capæ–‡ä»¶\nå‘èµ·è¯·æ±‚ åœ¨ç»ˆç«¯ä¸­ä½¿ç”¨ ctrl+cç»„åˆé”®ç»“æŸæŠ“åŒ…,ç„¶åä¼šåœ¨å½“å‰ç›®å½•ä¸‹ç”Ÿæˆä¸€ä¸ªhttp.capæ–‡ä»¶ 3.æŠŠæ–‡ä»¶ä¸‹è½½ä¸‹æ¥,ä½¿ç”¨tcpdumpåˆ†ææ•°æ® åœ¨wiresharkä¸­,é€šè¿‡æ–‡ä»¶\u0026gt;æ‰“å¼€ æ‰¾åˆ°ä»æœåŠ¡å™¨ä¸‹è½½çš„http.capæ–‡ä»¶,å¹¶æ‰“å¼€ åˆ°è¿™å·²ç»æˆåŠŸæ‰“å¼€äº†,å‰©ä¸‹çš„å°±æ˜¯åˆ†ææ•°æ®åŒ…äº† åœ¨åè®®httpçš„é‚£ä¸€è¡Œå³é”®,é€‰æ‹©è¿½è¸ªæµ,ç„¶åé€‰æ‹©http åˆ°è¿™,æ•´ä¸ªæŠ“åŒ…å°±å®Œæˆäº†,æ˜¯ä¸æ˜¯å¾ˆç®€å•å‘¢\nç»è¿‡æŠ“åŒ…åˆ†æ,ç»ˆäºè§£å†³äº†http400çš„é—®é¢˜\n","date":"2018-12-16T10:54:33Z","permalink":"https://lqxhub.github.io/posts/a3fd02f/","title":"ä½¿ç”¨tcpdump+wiresharkæŠ“åŒ…åˆ†æç½‘ç»œæ•°æ®åŒ…"},{"content":"ä¸ºä»€ä¹ˆè¦åŠ é” å¤šæ ¸è®¡ç®—æœºçš„å‡ºç°,è®¡ç®—æœºå®ç°çœŸæ­£å¹¶è¡Œè®¡ç®—,å¯ä»¥åœ¨åŒä¸€æ—¶åˆ»,æ‰§è¡Œå¤šä¸ªä»»åŠ¡ã€‚åœ¨å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­ï¼Œå› ä¸ºçº¿ç¨‹æ‰§è¡Œé¡ºåºä¸å¯æ§å¯¼è‡´çš„æ•°æ®é”™è¯¯ã€‚æ¯”å¦‚ï¼Œå¤šçº¿ç¨‹çš„ç†æƒ³çŠ¶æ€æ˜¯è¿™æ ·çš„ ä½†æ˜¯å®é™…æƒ…å†µæ˜¯è¿™æ ·çš„: åœ¨ç½‘ç»œç¼–ç¨‹ä¸­ï¼Œåœ¨åŒä¸€æ—¶åˆ»ï¼Œå¤šä¸ªå®¢æˆ·ç«¯åŒæ—¶è¯·æ±‚åŒä¸€ä¸ªèµ„æºï¼Œå¦‚æœä¸åšæ§åˆ¶ï¼Œä¹Ÿä¼šå¸¦æ¥æ•°æ®é”™è¯¯ã€‚æ¯”å¦‚åœ¨åŒä¸€æ—¶é—´æœ‰10000äººå»æŠ¢10å¼ ç«è½¦ç¥¨ï¼Œ10å¼ ç«è½¦ç¥¨æœ‰å¯èƒ½ä¼šä¹°ç»™100ä¸ªäººï¼Œè¿™æ˜¾ç„¶æ˜¯ä¸ç¬¦åˆè¦æ±‚çš„ã€‚ åœ¨å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­,ä¸ºäº†è§£å†³çº¿ç¨‹æ‰§è¡Œä¸å¯æ§å¸¦æ¥çš„é—®é¢˜,é€šå¸¸æƒ…å†µä¸‹éƒ½æ˜¯é€šè¿‡åŠ é”æ¥å®ç°æ•°æ®åŒæ­¥çš„ã€‚åœ¨ç½‘ç»œç¼–ç¨‹ä¸­ï¼Œä¹Ÿå¯ä»¥é€šè¿‡åŠ é”æœºåˆ¶æ¥æ§åˆ¶ã€‚\nåœ¨ç½‘ç»œç¼–ç¨‹ä¸­ï¼Œå¯ä»¥é€šè¿‡ç»™æ•°æ®åº“åŠ é”ï¼Œè¾¾åˆ°æ§åˆ¶å¹¶å‘çš„ç›®çš„ã€‚åœ¨phpå¼€å‘æ—¶ï¼ŒåŸºæœ¬éƒ½æ˜¯ä½¿ç”¨mysqlä½œä¸ºæ•°æ®åº“ã€‚æ‰€ä»¥ï¼Œå°±ä¼šç»™mysqlåŠ é”æ§åˆ¶ç½‘ç»œå¹¶å‘å¼•èµ·æ•°æ®é”™è¯¯é—®é¢˜ã€‚\nMySQLçš„å­˜å‚¨å¼•æ“ ä¸æ˜¯è¦è¯´MySQLçš„é”å—,æ€ä¹ˆè¯´ä¸Šå­˜å‚¨å¼•æ“äº†?å› ä¸ºMySQLå­˜å‚¨å¼•æ“ä¸åŒ,é”ä¹Ÿä¼šä¸åŒã€‚MySQLæœ‰MyISAM å’ŒInnoDBä¸¤ç§å­˜å‚¨å¼•æ“ï¼Œç°åœ¨ä¸»è¦ä½¿ç”¨InnoDB,æ‰€ä»¥ä¸»è¦ä»‹ç»InnoDBä¸‹é”çš„ä½¿ç”¨ã€‚\nInnoDBå¼•æ“æ”¯æŒäº‹åŠ¡æ“ä½œï¼Œä½¿ç”¨äº‹åŠ¡å¯ä»¥ä¿è¯å¤šæ¡sqlè¯­å¥æ‰§è¡Œçš„å®Œæ•´æ€§(è¦ä¸éƒ½æˆåŠŸ,è¦ä¸éƒ½å¤±è´¥)\näº‹åŠ¡æ˜¯ç”±ä¸€ç»„SQLè¯­å¥ç»„æˆçš„é€»è¾‘å¤„ç†å•å…ƒï¼Œäº‹åŠ¡å…·æœ‰4å±æ€§ åŸå­æ€§ï¼ˆActomicityï¼‰ï¼šäº‹åŠ¡æ˜¯ä¸€ä¸ªåŸå­æ“ä½œå•å…ƒï¼Œå…¶å¯¹æ•°æ®çš„ä¿®æ”¹ï¼Œè¦ä¹ˆå…¨éƒ½æ‰§è¡Œï¼Œè¦ä¹ˆå…¨éƒ½ä¸æ‰§è¡Œã€‚ ä¸€è‡´æ€§ï¼ˆConsistentï¼‰ï¼šåœ¨äº‹åŠ¡å¼€å§‹å’Œå®Œæˆæ—¶ï¼Œæ•°æ®éƒ½å¿…é¡»ä¿æŒä¸€è‡´çŠ¶æ€ã€‚è¿™æ„å‘³ç€æ‰€æœ‰ç›¸å…³çš„æ•°æ®è§„åˆ™éƒ½å¿…é¡»åº”ç”¨äºäº‹åŠ¡çš„ä¿®æ”¹ï¼Œä»¥æ“æŒå®Œæ•´æ€§ï¼›äº‹åŠ¡ç»“æŸæ—¶ï¼Œæ‰€æœ‰çš„å†…éƒ¨æ•°æ®ç»“æ„ï¼ˆå¦‚Bæ ‘ç´¢å¼•æˆ–åŒå‘é“¾è¡¨ï¼‰ä¹Ÿéƒ½å¿…é¡»æ˜¯æ­£ç¡®çš„ã€‚ éš”ç¦»æ€§ï¼ˆIsolationï¼‰ï¼šæ•°æ®åº“ç³»ç»Ÿæä¾›ä¸€å®šçš„éš”ç¦»æœºåˆ¶ï¼Œä¿è¯äº‹åŠ¡åœ¨ä¸å—å¤–éƒ¨å¹¶å‘æ“ä½œå½±å“çš„â€œç‹¬ç«‹â€ç¯å¢ƒæ‰§è¡Œã€‚è¿™æ„å‘³ç€äº‹åŠ¡å¤„ç†è¿‡ç¨‹ä¸­çš„ä¸­é—´çŠ¶æ€å¯¹å¤–éƒ¨æ˜¯ä¸å¯è§çš„ï¼Œåä¹‹äº¦ç„¶ã€‚ æŒä¹…æ€§ï¼ˆDurableï¼‰ï¼šäº‹åŠ¡å®Œæˆä¹‹åï¼Œå®ƒå¯¹äºæ•°æ®çš„ä¿®æ”¹æ˜¯æ°¸ä¹…æ€§çš„ï¼Œå³ä½¿å‡ºç°ç³»ç»Ÿæ•…éšœä¹Ÿèƒ½å¤Ÿä¿æŒã€‚ å¤šä¸ªäº‹åŠ¡å¹¶å‘æ‰§è¡Œä¼šå¸¦æ¥æ–°çš„é—®é¢˜ æ›´æ–°ä¸¢å¤±ï¼ˆLost Updateï¼‰ï¼šå½“ä¸¤ä¸ªæˆ–å¤šä¸ªäº‹åŠ¡é€‰æ‹©åŒä¸€è¡Œï¼Œç„¶ååŸºäºæœ€åˆé€‰å®šçš„å€¼æ›´æ–°è¯¥è¡Œæ—¶ï¼Œç”±äºæ¯ä¸ª äº‹åŠ¡éƒ½ä¸çŸ¥é“å…¶ä»–äº‹åŠ¡çš„å­˜åœ¨ï¼Œå°±ä¼šå‘ç”Ÿä¸¢å¤±æ›´æ–°é—®é¢˜â€”â€”æœ€åçš„æ›´æ–°è¦†ç›–äº†å…¶ä»–äº‹åŠ¡æ‰€åšçš„æ›´æ–°ã€‚ä¾‹å¦‚ï¼Œä¸¤ä¸ªç¼–è¾‘äººå‘˜åˆ¶ä½œäº†åŒä¸€æ–‡æ¡£çš„ç”µå­å‰¯æœ¬ã€‚æ¯ä¸ªç¼–è¾‘äººå‘˜ç‹¬ç«‹åœ°æ›´æ”¹å…¶å‰¯æœ¬ï¼Œç„¶åä¿å­˜æ›´æ”¹åçš„å‰¯æœ¬ï¼Œè¿™æ ·å°±è¦†ç›–äº†åŸå§‹æ–‡æ¡£ã€‚æœ€åä¿å­˜å…¶æ›´æ”¹ä¿å­˜å…¶æ›´æ”¹å‰¯æœ¬çš„ç¼–è¾‘äººå‘˜è¦†ç›–å¦ä¸€ä¸ªç¼–è¾‘äººå‘˜æ‰€åšçš„ä¿®æ”¹ã€‚å¦‚æœåœ¨ä¸€ä¸ªç¼–è¾‘äººå‘˜å®Œæˆå¹¶æäº¤äº‹åŠ¡ä¹‹å‰ï¼Œå¦ä¸€ä¸ªç¼–è¾‘äººå‘˜ä¸èƒ½è®¿é—®åŒä¸€æ–‡ä»¶ï¼Œåˆ™å¯é¿å…æ­¤é—®é¢˜ è„è¯»ï¼ˆDirty Readsï¼‰ï¼šä¸€ä¸ªäº‹åŠ¡æ­£åœ¨å¯¹ä¸€æ¡è®°å½•åšä¿®æ”¹ï¼Œåœ¨è¿™ä¸ªäº‹åŠ¡å¹¶æäº¤å‰ï¼Œè¿™æ¡è®°å½•çš„æ•°æ®å°±å¤„äºä¸ä¸€è‡´çŠ¶æ€ï¼›è¿™æ—¶ï¼Œå¦ä¸€ä¸ªäº‹åŠ¡ä¹Ÿæ¥è¯»å–åŒä¸€æ¡è®°å½•ï¼Œå¦‚æœä¸åŠ æ§åˆ¶ï¼Œç¬¬äºŒä¸ªäº‹åŠ¡è¯»å–äº†è¿™äº›â€œè„â€çš„æ•°æ®ï¼Œå¹¶æ®æ­¤åšè¿›ä¸€æ­¥çš„å¤„ç†ï¼Œå°±ä¼šäº§ç”Ÿæœªæäº¤çš„æ•°æ®ä¾èµ–å…³ç³»ã€‚è¿™ç§ç°è±¡è¢«å½¢è±¡åœ°å«åšâ€œè„è¯»â€ã€‚ ä¸å¯é‡å¤è¯»ï¼ˆNon-Repeatable Readsï¼‰ï¼šä¸€ä¸ªäº‹åŠ¡åœ¨è¯»å–æŸäº›æ•°æ®å·²ç»å‘ç”Ÿäº†æ”¹å˜ã€æˆ–æŸäº›è®°å½•å·²ç»è¢«åˆ é™¤äº†ï¼è¿™ç§ç°è±¡å«åšâ€œä¸å¯é‡å¤è¯»â€ã€‚ å¹»è¯»ï¼ˆPhantom Readsï¼‰ï¼šä¸€ä¸ªäº‹åŠ¡æŒ‰ç›¸åŒçš„æŸ¥è¯¢æ¡ä»¶é‡æ–°è¯»å–ä»¥å‰æ£€ç´¢è¿‡çš„æ•°æ®ï¼Œå´å‘ç°å…¶ä»–äº‹åŠ¡æ’å…¥äº†æ»¡è¶³å…¶æŸ¥è¯¢æ¡ä»¶çš„æ–°æ•°æ®ï¼Œè¿™ç§ç°è±¡å°±ç§°ä¸ºâ€œå¹»è¯»â€ã€‚ æ›¾ç»å¹´å°‘æ— çŸ¥çš„æˆ‘,ä»¥ä¸ºä½¿ç”¨äº‹åŠ¡å°±èƒ½ä¿è¯å¹¶å‘æƒ…å†µä¸‹æ•°æ®åŒæ­¥é—®é¢˜,åæ¥çš„ä¸€æ¬¡æƒ¨ç—›ç»å†æ‰æ˜ç™½äº†,äº‹åŠ¡ä¸èƒ½ä¿è¯å¹¶å‘æƒ…å†µçš„æ•°æ®åŒæ­¥é—®é¢˜,éœ€è¦äº‹åŠ¡å’Œé”åŒæ—¶ä½¿ç”¨æ‰èƒ½ä¿è¯ã€‚\né”çš„ç§ç±» ä¹è§‚é” æœºåˆ¶é‡‡å–äº†æ›´åŠ å®½æ¾çš„åŠ é”æœºåˆ¶ã€‚æ‚²è§‚é”å¤§å¤šæ•°æƒ…å†µä¸‹ä¾é æ•°æ®åº“çš„é”æœºåˆ¶å®ç°ï¼Œä»¥ä¿è¯æ“ä½œæœ€å¤§ç¨‹åº¦çš„ç‹¬å æ€§ã€‚ä½†éšä¹‹è€Œæ¥çš„å°±æ˜¯æ•°æ®åº“æ€§èƒ½çš„å¤§é‡å¼€é”€ï¼Œç‰¹åˆ«æ˜¯å¯¹é•¿äº‹åŠ¡è€Œè¨€ï¼Œè¿™æ ·çš„å¼€é”€å¾€å¾€æ— æ³•æ‰¿å—ã€‚ç›¸å¯¹æ‚²è§‚é”è€Œè¨€ï¼Œä¹è§‚é”æ›´å€¾å‘äºå¼€å‘è¿ç”¨ã€‚ æ‚²è§‚é” å…·æœ‰å¼ºçƒˆçš„ç‹¬å å’Œæ’ä»–ç‰¹æ€§ã€‚å®ƒæŒ‡çš„æ˜¯å¯¹æ•°æ®è¢«å¤–ç•Œï¼ˆåŒ…æ‹¬æœ¬ç³»ç»Ÿå½“å‰çš„å…¶ä»–äº‹åŠ¡ï¼Œä»¥åŠæ¥è‡ªå¤–éƒ¨ç³»ç»Ÿçš„äº‹åŠ¡å¤„ç†ï¼‰ä¿®æ”¹æŒä¿å®ˆæ€åº¦ï¼Œå› æ­¤ï¼Œåœ¨æ•´ä¸ªæ•°æ®å¤„ç†è¿‡ç¨‹ä¸­ï¼Œå°†æ•°æ®å¤„äºé”å®šçŠ¶æ€ã€‚æ‚²è§‚é”çš„å®ç°ï¼Œå¾€å¾€ä¾é æ•°æ®åº“æä¾›çš„é”æœºåˆ¶ï¼ˆä¹Ÿåªæœ‰æ•°æ®åº“å±‚æä¾›çš„é”æœºåˆ¶æ‰èƒ½çœŸæ­£ä¿è¯æ•°æ®è®¿é—®çš„æ’ä»–æ€§ï¼Œå¦åˆ™ï¼Œå³ä½¿åœ¨æœ¬ç³»ç»Ÿä¸­å®ç°äº†åŠ é”æœºåˆ¶ï¼Œä¹Ÿæ— æ³•ä¿è¯å¤–éƒ¨ç³»ç»Ÿä¸ä¼šä¿®æ”¹æ•°æ®ï¼‰ã€‚ MySQLä¸­é”çš„ç§ç±» ä¹è§‚é”å’Œæ‚²è§‚é”æ˜¯ä¸€ç§æ€æƒ³,ä¸æ˜¯å…·ä½“å®ç°,åœ¨MySQLä¸­,æœ‰é”çš„å…·ä½“çš„å®ç°æ–¹å¼ (æ–‡ä¸­çš„çº¿ç¨‹åœ¨MySQLä¸­å¯ä»¥è§†ä½œMySQLçš„è¿æ¥)\nå…±äº«é” ä¸€ä¸ªçº¿ç¨‹åœ¨æŒæœ‰é”æ—¶,å…¶ä»–çš„çº¿ç¨‹å¯ä»¥æŸ¥è¯¢è¢«é”çš„æ•°æ®,ä½†æ˜¯ä¸èƒ½ä¿®æ”¹,ä¸èƒ½åˆ é™¤ã€‚å®ç°æ–¹å¼ SELECT * FROM table_name WHERE id =? lock in share mode; æ’å®ƒé” ä¸€ä¸ªçº¿ç¨‹åœ¨æŒæœ‰é”æ—¶,å…¶ä»–çš„çº¿ç¨‹ä¸èƒ½æŸ¥è¯¢,ä¸èƒ½æ›´æ–°,ä¸èƒ½åˆ é™¤è¢«é”çš„æ•°æ®,ç›´åˆ°é”è¢«é‡Šæ”¾. \u0026gt; SELECT * FROM table_name WHERE id =? for update æ€»ç»“ä¸€ä¸‹:å…±äº«é”ç±»ä¼¼äºjavaä¸­çš„è¯»é”,ä¸€ä¸ªçº¿ç¨‹åœ¨æŒæœ‰ä¹è§‚é”çš„æ—¶å€™,å…¶ä»–çš„çº¿ç¨‹ä¹Ÿå¯ä»¥å¯¹è¢«é”çš„æ•°æ®è¿›è¡Œè¯»æ“ä½œ,ä½†æ˜¯ä¸èƒ½å¯¹è¢«é”çš„æ•°æ®è¿›è¡Œåˆ é™¤å’Œæ›´æ–°æ“ä½œ;æ’ä»–é”ç±»ä¼¼äºjavaçš„å†™é”,ä¸€ä¸ªçº¿ç¨‹æŒæœ‰å†™é”çš„æ—¶å€™,å…¶ä»–çš„çº¿ç¨‹ä¸èƒ½å†å¯¹è¢«é”çš„æ•°æ®è¿›è¡Œä»»ä½•æŸ¥è¯¢,æ›´æ–°,åˆ é™¤æ“ä½œã€‚ é‡ç‚¹ InnoDBçš„è¡Œé”æ˜¯åŸºäºç´¢å¼•å®ç°çš„,å¦‚æœåœ¨æŸ¥è¯¢ä¸­ä¸ä½¿ç”¨ç´¢å¼•,ä¼šé”è¡¨ã€‚ MySQLé”ç²’åº¦ è¡¨çº§é” æ˜¯MySQLä¸­é”å®šç²’åº¦æœ€å¤§çš„ä¸€ç§é”ï¼Œè¡¨ç¤ºå¯¹å½“å‰æ“ä½œçš„æ•´å¼ è¡¨åŠ é”ï¼Œå®ƒå®ç°ç®€å•ï¼Œèµ„æºæ¶ˆè€—è¾ƒå°‘ï¼Œè¢«å¤§éƒ¨åˆ†MySQLå¼•æ“æ”¯æŒã€‚æœ€å¸¸ä½¿ç”¨çš„MyISAMä¸InnoDBéƒ½æ”¯æŒè¡¨çº§é”å®šã€‚è¡¨çº§é”åˆ†ä¸ºè¡¨å…±äº«è¯»é”ä¸è¡¨ç‹¬å å†™é”ã€‚ è¡Œçº§é” æ˜¯Mysqlä¸­é”å®šç²’åº¦æœ€ç»†çš„ä¸€ç§é”ï¼Œè¡¨ç¤ºåªé’ˆå¯¹å½“å‰æ“ä½œçš„è¡Œè¿›è¡ŒåŠ é”ã€‚è¡Œçº§é”èƒ½å¤§å¤§å‡å°‘æ•°æ®åº“æ“ä½œçš„å†²çªã€‚å…¶åŠ é”ç²’åº¦æœ€å°ï¼Œä½†åŠ é”çš„å¼€é”€ä¹Ÿæœ€å¤§ã€‚è¡Œçº§é”åˆ†ä¸ºå…±äº«é” å’Œ æ’ä»–é”ã€‚ å…±äº«é”çš„ä½¿ç”¨ æ³¨æ„: ä¸‹é¢çš„æ“ä½œ,éƒ½æ˜¯è¡Œé”æ“ä½œ,MySQLä¸ºInnoDBå¼•æ“,idä¸ºè‡ªå¢ä¸»é”® å…ˆåˆ›å»ºä¸€ä¸ªæµ‹è¯•è¡¨\n1CREATE TABLE `test` ( 2 `id` int(0) NOT NULL AUTO_INCREMENT, 3 `name` varchar(20) NOT NULL, 4 `number` bigint(0) NOT NULL, 5 `age` int(0) NULL, 6 PRIMARY KEY (`id`) 7) ENGINE = InnoDB; çœ‹ä¸€ä¸‹éšä¾¿æ’å…¥çš„å‡ æ¡æ•°æ® æ²¡æœ‰é—®é¢˜,ä½¿ç”¨å…±äº«é”çœ‹ä¸€ä¸‹æ•ˆæœ:\nå¼€å¯äº‹åŠ¡ begin; ç»™idä¸º1çš„æ•°æ®åŠ å…±äº«é” mysql\u0026gt; select * from test where id=1 lock in share mode; åˆ†åˆ«ä½¿ç”¨åŠ é”å’Œä¸åŠ é”æŸ¥è¯¢idä¸º1 çš„æ•°æ® \u0026gt;éƒ½å¯ä»¥æŸ¥è¯¢åˆ°æ•°æ® ä¿®æ”¹idä¸º1 çš„æ•°æ®çœ‹çœ‹ sqlè¯­å¥ä¼šä¸€ç›´åœåœ¨è¿™é‡Œ,ç›´åˆ°è¶…æ—¶æˆ–è€…é”é‡Šæ”¾(äº‹åŠ¡æäº¤æˆ–è€…å›æ»š) å·¦è¾¹çš„äº‹åŠ¡æäº¤å,å³è¾¹çš„sqlä¼šæ‰§è¡Œ,å®Œæˆæ›´æ–°æ“ä½œã€‚\nåŒæ ·,åˆ é™¤æ“ä½œä¹Ÿä¼šç­‰å¾…é”é‡Šæ”¾æ‰èƒ½æ“ä½œ,è¿™é‡Œå°±ä¸æ¼”ç¤ºäº†ã€‚\nå†çœ‹ä¸€ä¸‹å¦ä¸€ç§æƒ…å†µ,å·¦è¾¹é”ä½idä¸º5çš„æ•°æ®,å³è¾¹æ›´æ–°idä¸º1 çš„æ•°æ®,ä¸å—å½±å“ã€‚è¿™å°±æ˜¯è¡Œçº§é”ï¼Œåªä¼šé”ä½ç›¸å…³çš„ä¸€è¡Œæ•°æ® æ’ä»–é”çš„ä½¿ç”¨ è¿˜æ˜¯ä½¿ç”¨testè¿™å¼ è¡¨\nå¼€å¯äº‹åŠ¡begin; ç»™id1çš„æ•°æ®åŠ æ’ä»–é”select * from test where id = 1 for update; åœ¨å³è¾¹æŸ¥è¯¢idä¸º1çš„æ•°æ® æŸ¥è¯¢è¯­å¥ä¼šä¸€ç›´ç­‰å¾…,ç›´åˆ°è¶…æ—¶æˆ–è€…é”é‡Šæ”¾(å·¦è¾¹commitæˆ–è€…rollback) å·¦è¾¹commitå ä½¿ç”¨æ’å®ƒé”å¯¹idä¸º5çš„æ•°æ®åŠ é”å,æ›´æ–°idä¸º5çš„æ•°æ® sqlè¯­å¥åŒæ ·ä¼šç­‰å¾…,ç›´åˆ°è¶…æ—¶æˆ–è€…é”é‡Šæ”¾,åˆ é™¤æ“ä½œä¹Ÿæ˜¯ä¸€æ ·\nçœ‹ä¸€ä¸‹å¯¹idä¸º1çš„æ•°æ®åŠ é”,ç„¶åæ“ä½œidä¸ä¸º1çš„æ•°æ®çš„æƒ…å†µ æ²¡æœ‰é—®é¢˜,MySQLåªæ˜¯é”ä½äº†idä¸º5çš„æ•°æ®,å…¶ä»–çš„æ•°æ®éƒ½å¯ä»¥æ“ä½œã€‚\nçœ‹ä¸€ä¸‹InnoDBå¼•æ“é”è¡¨çš„æƒ…å†µ æˆ‘ä»¬å¸¸å¸¸è¯´InnoDBæ˜¯è¡Œé”ï¼Œä½†æ˜¯è¿™é‡Œä»‹ç»ä¸€ä¸‹å®ƒé”è¡¨çš„æƒ…å†µã€‚å› ä¸ºnameåˆ—æ²¡æœ‰ç´¢å¼•,æ‰€ä»¥,åœ¨åŠ è¡Œé”çš„æ—¶å€™,MySQLä¸èƒ½åŠ æ­£å¸¸åŠ è¡Œé”,ä¼šé”ä½æ•´å¼ è¡¨ã€‚ InnoDBè¡Œé”æ˜¯é€šè¿‡ç´¢å¼•ä¸Šçš„ç´¢å¼•é¡¹æ¥å®ç°çš„ï¼Œè¿™ä¸€ç‚¹ï¼­ySQLä¸Oracleä¸åŒï¼Œåè€…æ˜¯é€šè¿‡åœ¨æ•°æ®ä¸­å¯¹ç›¸åº”æ•°æ®è¡ŒåŠ é”æ¥å®ç°çš„ã€‚InnoDBè¿™ç§è¡Œé”å®ç°ç‰¹ç‚¹æ„å‘³è€…ï¼šåªæœ‰é€šè¿‡ç´¢å¼•æ¡ä»¶æ£€ç´¢æ•°æ®ï¼ŒInnoDBæ‰ä¼šä½¿ç”¨è¡Œçº§é”ï¼Œå¦åˆ™ï¼ŒInnoDBå°†ä½¿ç”¨è¡¨é”ï¼ åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¦ç‰¹åˆ«æ³¨æ„InnoDBè¡Œé”çš„è¿™ä¸€ç‰¹æ€§ï¼Œä¸ç„¶çš„è¯ï¼Œå¯èƒ½å¯¼è‡´å¤§é‡çš„é”å†²çªï¼Œä»è€Œå½±å“å¹¶å‘æ€§èƒ½ã€‚\nå†çœ‹å¦ä¸€ç§æƒ…å†µ ä½¿ç”¨æ’å®ƒé”å¯¹idä¸º1çš„æ•°æ®åŠ é”æ—¶,ä½¿ç”¨ä¸åŠ é”çš„æŸ¥è¯¢å’Œæ²¡æœ‰çº¦æŸçš„æŸ¥è¯¢æ—¶,ä¸€æ ·å¯ä»¥ç«‹åˆ»æŸ¥è¯¢åˆ°æ•°æ®ã€‚åªæœ‰ä½¿ç”¨åŠ é”çš„æŸ¥è¯¢æˆ–è€…æ›´æ–°å’Œåˆ é™¤æ—¶æ‰ä¼šç­‰å¾…é”é‡Šæ”¾ã€‚\næ€»ç»“ InnoDBçš„é”é…åˆäº‹åŠ¡ä½¿ç”¨ MySQLæœ‰å…±äº«é”å’Œæ’å®ƒé” ä½¿ç”¨å…±äº«é”æ—¶,å…¶ä»–çº¿ç¨‹(è¿æ¥)å¯ä»¥æŸ¥è¯¢æ•°æ®,ä½†æ˜¯ä¸èƒ½æ›´æ–°å’Œåˆ é™¤æ•°æ®,ä½¿ç”¨æ’å®ƒé”æ—¶,ä¸èƒ½æŸ¥è¯¢æ•°æ®ä¸èƒ½æ›´æ–°æ•°æ®,ä¸èƒ½åˆ é™¤æ•°æ® MySQLçš„InnoDBå¼•æ“æ”¯æŒè¡Œçº§é”å’Œè¡¨çº§é”,è¡Œçº§é” InnoDBçš„è¡Œçº§é”æ˜¯åŸºäºç´¢å¼•çš„,åŠ é”æ˜¯å¯¹ç´¢å¼•åŠ é”,åŠ é”æ—¶æ²¡æœ‰ç´¢å¼•æ—¶ä¼šé”ä½æ•´å¼ è¡¨ ä»¥ä¸Šæ˜¯æˆ‘å¯¹MySQLé”çš„ç†è§£,æ–‡ä¸­å¦‚æœæœ‰ä¸æ­£ç¡®çš„åœ°æ–¹,è¿˜è¯·å„ä½å¤§å“¥æ‰¹è¯„æŒ‡æ­£ã€‚\n","date":"2018-11-23T17:17:26Z","permalink":"https://lqxhub.github.io/posts/a8083c8/","title":"ä½¿ç”¨mysqlä¸­çš„é”è§£å†³é«˜å¹¶å‘é—®é¢˜"},{"content":"mysqlå•è¡¨ä¸­æ•°æ®é‡åˆ°è¾¾ä¸€å®šæ•°é‡å,æŸ¥è¯¢æ•ˆç‡ä¼šå˜å¾—å¾ˆä½,ä½¿ç”¨ç´¢å¼•å¯ä»¥æœ‰æ•ˆåœ°æé«˜mysqlçš„æŸ¥è¯¢æ•ˆç‡.ä½†æ˜¯ç´¢å¼•ä½¿ç”¨ä¸å½“,ä¼šä½¿ç´¢å¼•å¤±æ•ˆ,èµ·ä¸åˆ°æå‡æ•ˆç‡çš„ä½œç”¨,åœ¨å®é™…é¡¹ç›®ä¸­,è¦åšå¥½ç´¢å¼•çš„ä¼˜åŒ–,åˆç†çš„ä½¿ç”¨ç´¢å¼•ã€‚å…³äºç´¢å¼•çš„ä¼˜åŒ–ï¼Œå¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼Œä¼ é€é—¨\nä¸ºäº†åˆ†æsqlè¯­å¥æ‰§è¡Œæ•ˆç‡,ä½¿ç”¨explain åˆ†æsqlè¯­å¥ ä½¿ç”¨explainå…³é”®å­—å¯ä»¥æ¨¡æ‹Ÿä¼˜åŒ–å™¨æ‰§è¡ŒsqlæŸ¥è¯¢è¯­å¥ï¼Œä»è€Œå¾—çŸ¥MySQL æ˜¯å¦‚ä½•å¤„ç†sqlè¯­å¥ã€‚\n1+----+-------------+-------+------------+-------+---------------+---------+---------+-------+------+----------+-------------+ 2| id | select_type | table | partitions | type | possible_keys | key | key_len | ref | rows | filtered | Extra | 3+----+-------------+-------+------------+-------+---------------+---------+---------+-------+------+----------+-------------+ id select æŸ¥è¯¢çš„åºåˆ—å·ï¼ŒåŒ…å«ä¸€ç»„å¯ä»¥é‡å¤çš„æ•°å­—ï¼Œè¡¨ç¤ºæŸ¥è¯¢ä¸­æ‰§è¡Œsqlè¯­å¥çš„é¡ºåºã€‚ä¸€èˆ¬æœ‰ä¸‰ç§æƒ…å†µï¼š ç¬¬ä¸€ç§ï¼šidå…¨éƒ¨ç›¸åŒï¼Œsqlçš„æ‰§è¡Œé¡ºåºæ˜¯ç”±ä¸Šè‡³ä¸‹ï¼› ç¬¬äºŒç§ï¼šidå…¨éƒ¨ä¸åŒï¼Œsqlçš„æ‰§è¡Œé¡ºåºæ˜¯æ ¹æ®idå¤§çš„ä¼˜å…ˆæ‰§è¡Œï¼› ç¬¬ä¸‰ç§ï¼šidæ—¢å­˜åœ¨ç›¸åŒï¼Œåˆå­˜åœ¨ä¸åŒçš„ã€‚å…ˆæ ¹æ®idå¤§çš„ä¼˜å…ˆæ‰§è¡Œï¼Œå†æ ¹æ®ç›¸åŒidä»ä¸Šè‡³ä¸‹çš„æ‰§è¡Œã€‚\nselect_type select æŸ¥è¯¢çš„ç±»å‹ï¼Œä¸»è¦æ˜¯ç”¨äºåŒºåˆ«æ™®é€šæŸ¥è¯¢ï¼Œè”åˆæŸ¥è¯¢ï¼ŒåµŒå¥—çš„å¤æ‚æŸ¥è¯¢ **simpleï¼š**ç®€å•çš„select æŸ¥è¯¢ï¼ŒæŸ¥è¯¢ä¸­ä¸åŒ…å«å­æŸ¥è¯¢æˆ–è€…union **primaryï¼š**æŸ¥è¯¢ä¸­è‹¥åŒ…å«ä»»ä½•å¤æ‚çš„å­æŸ¥è¯¢ï¼Œæœ€å¤–å±‚æŸ¥è¯¢åˆ™è¢«æ ‡è®°ä¸ºprimary **subqueryï¼š**åœ¨selectæˆ–where åˆ—è¡¨ä¸­åŒ…å«äº†å­æŸ¥è¯¢ **derivedï¼š**åœ¨fromåˆ—è¡¨ä¸­åŒ…å«çš„å­æŸ¥è¯¢è¢«æ ‡è®°ä¸ºderivedï¼ˆè¡ç”Ÿï¼‰MySQLä¼šé€’å½’æ‰§è¡Œè¿™äº›å­æŸ¥è¯¢ï¼ŒæŠŠç»“æœæ”¾åœ¨ä¸´æ—¶è¡¨é‡Œã€‚ **unionï¼š**è‹¥ç¬¬äºŒä¸ªselectå‡ºç°åœ¨unionä¹‹åï¼Œåˆ™è¢«æ ‡è®°ä¸ºunionï¼Œè‹¥unionåŒ…å«åœ¨fromå­å¥çš„å­æŸ¥è¯¢ä¸­ï¼Œå¤–å±‚selectå°†è¢«æ ‡è®°ä¸ºï¼šderived **union resultï¼š**ä»unionè¡¨è·å–ç»“æœçš„select\npartitions è¡¨æ‰€ä½¿ç”¨çš„åˆ†åŒºï¼Œå¦‚æœè¦ç»Ÿè®¡åå¹´å…¬å¸è®¢å•çš„é‡‘é¢ï¼Œå¯ä»¥æŠŠæ•°æ®åˆ†ä¸ºåä¸ªåŒºï¼Œæ¯ä¸€å¹´ä»£è¡¨ä¸€ä¸ªåŒºã€‚è¿™æ ·å¯ä»¥å¤§å¤§çš„æé«˜æŸ¥è¯¢æ•ˆç‡ã€‚\ntype è¿™æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„å‚æ•°ï¼Œè¿æ¥ç±»å‹ï¼Œå¸¸è§çš„æœ‰ï¼šall , index , range , ref , eq_ref , const , system , null å…«ä¸ªçº§åˆ«ã€‚ æ€§èƒ½ä»æœ€ä¼˜åˆ°æœ€å·®çš„æ’åºï¼šsystem \u0026gt; const \u0026gt; eq_ref \u0026gt; ref \u0026gt; range \u0026gt; index \u0026gt; all åœ¨ä»£ç ä¸­,è‹¥ä¿è¯æŸ¥è¯¢è‡³å°‘è¾¾åˆ°rangeçº§åˆ«æˆ–è€…æœ€å¥½èƒ½è¾¾åˆ°refåˆ™ç®—æ˜¯ä¸€ä¸ªä¼˜ç§€è€Œåˆè´Ÿè´£çš„ç¨‹åºå‘˜ã€‚ allï¼šï¼ˆfull table scanï¼‰å…¨è¡¨æ‰«ææ— ç–‘æ˜¯æœ€å·®ï¼Œè‹¥æ˜¯ç™¾ä¸‡åƒä¸‡çº§æ•°æ®é‡ï¼Œå…¨è¡¨æ‰«æä¼šéå¸¸æ…¢ã€‚ indexï¼šï¼ˆfull index scanï¼‰å…¨ç´¢å¼•æ–‡ä»¶æ‰«ææ¯”allå¥½å¾ˆå¤šï¼Œæ¯•ç«Ÿä»ç´¢å¼•æ ‘ä¸­æ‰¾æ•°æ®ï¼Œæ¯”ä»å…¨è¡¨ä¸­æ‰¾æ•°æ®è¦å¿«ã€‚ **rangeï¼š**åªæ£€ç´¢ç»™å®šèŒƒå›´çš„è¡Œï¼Œä½¿ç”¨ç´¢å¼•æ¥åŒ¹é…è¡Œã€‚èŒƒå›´ç¼©å°äº†ï¼Œå½“ç„¶æ¯”å…¨è¡¨æ‰«æå’Œå…¨ç´¢å¼•æ–‡ä»¶æ‰«æè¦å¿«ã€‚sqlè¯­å¥ä¸­ä¸€èˆ¬ä¼šæœ‰betweenï¼Œinï¼Œ\u0026gt;ï¼Œ\u0026lt; ç­‰æŸ¥è¯¢ã€‚ **refï¼š**éå”¯ä¸€æ€§ç´¢å¼•æ‰«æï¼Œæœ¬è´¨ä¸Šä¹Ÿæ˜¯ä¸€ç§ç´¢å¼•è®¿é—®ï¼Œè¿”å›æ‰€æœ‰åŒ¹é…æŸä¸ªå•ç‹¬å€¼çš„è¡Œã€‚æ¯”å¦‚æŸ¥è¯¢å…¬å¸æ‰€æœ‰å±äºç ”å‘å›¢é˜Ÿçš„åŒäº‹ï¼ŒåŒ¹é…çš„ç»“æœæ˜¯å¤šä¸ªå¹¶éå”¯ä¸€å€¼ã€‚ **eq_refï¼š**å”¯ä¸€æ€§ç´¢å¼•æ‰«æï¼Œå¯¹äºæ¯ä¸ªç´¢å¼•é”®ï¼Œè¡¨ä¸­æœ‰ä¸€æ¡è®°å½•ä¸ä¹‹åŒ¹é…ã€‚æ¯”å¦‚æŸ¥è¯¢å…¬å¸çš„CEOï¼ŒåŒ¹é…çš„ç»“æœåªå¯èƒ½æ˜¯ä¸€æ¡è®°å½•ï¼Œ **constï¼š**è¡¨ç¤ºé€šè¿‡ç´¢å¼•ä¸€æ¬¡å°±å¯ä»¥æ‰¾åˆ°ï¼Œconstç”¨äºæ¯”è¾ƒprimary key æˆ–è€…uniqueç´¢å¼•ã€‚å› ä¸ºåªåŒ¹é…ä¸€è¡Œæ•°æ®ï¼Œæ‰€ä»¥å¾ˆå¿«ï¼Œè‹¥å°†ä¸»é”®è‡³äºwhereåˆ—è¡¨ä¸­ï¼ŒMySQLå°±èƒ½å°†è¯¥æŸ¥è¯¢è½¬æ¢ä¸ºä¸€ä¸ªå¸¸é‡ã€‚ **systemï¼š**è¡¨åªæœ‰ä¸€æ¡è®°å½•ï¼ˆç­‰äºç³»ç»Ÿè¡¨ï¼‰ï¼Œè¿™æ˜¯constç±»å‹çš„ç‰¹åˆ—ï¼Œå¹³æ—¶ä¸ä¼šå‡ºç°ï¼Œäº†è§£å³å¯\npossible_keys æ˜¾ç¤ºæŸ¥è¯¢è¯­å¥å¯èƒ½ç”¨åˆ°çš„ç´¢å¼•(ä¸€ä¸ªæˆ–å¤šä¸ªæˆ–ä¸ºnull)ï¼Œä¸ä¸€å®šè¢«æŸ¥è¯¢å®é™…ä½¿ç”¨ã€‚ä»…ä¾›å‚è€ƒä½¿ç”¨ã€‚\nkey æ˜¾ç¤ºæŸ¥è¯¢è¯­å¥å®é™…ä½¿ç”¨çš„ç´¢å¼•ã€‚è‹¥ä¸ºnullï¼Œåˆ™è¡¨ç¤ºæ²¡æœ‰ä½¿ç”¨ç´¢å¼•ã€‚\nkey_len æ˜¾ç¤ºç´¢å¼•ä¸­ä½¿ç”¨çš„å­—èŠ‚æ•°ï¼Œå¯é€šè¿‡key_lenè®¡ç®—æŸ¥è¯¢ä¸­ä½¿ç”¨çš„ç´¢å¼•é•¿åº¦ã€‚åœ¨ä¸æŸå¤±ç²¾ç¡®æ€§çš„æƒ…å†µä¸‹ç´¢å¼•é•¿åº¦è¶ŠçŸ­è¶Šå¥½ã€‚key_len æ˜¾ç¤ºçš„å€¼ä¸ºç´¢å¼•å­—æ®µçš„æœ€å¯èƒ½é•¿åº¦ï¼Œå¹¶éå®é™…ä½¿ç”¨é•¿åº¦ï¼Œå³key_lenæ˜¯æ ¹æ®è¡¨å®šä¹‰è®¡ç®—è€Œå¾—ï¼Œå¹¶ä¸æ˜¯é€šè¿‡è¡¨å†…æ£€ç´¢å‡ºçš„ã€‚\nref æ˜¾ç¤ºç´¢å¼•çš„å“ªä¸€åˆ—æˆ–å¸¸é‡è¢«ç”¨äºæŸ¥æ‰¾ç´¢å¼•åˆ—ä¸Šçš„å€¼ã€‚\nrows æ ¹æ®è¡¨ç»Ÿè®¡ä¿¡æ¯åŠç´¢å¼•é€‰ç”¨æƒ…å†µï¼Œå¤§è‡´ä¼°ç®—å‡ºæ‰¾åˆ°æ‰€éœ€çš„è®°å½•æ‰€éœ€è¦è¯»å–çš„è¡Œæ•°ï¼Œå€¼è¶Šå¤§è¶Šä¸å¥½ã€‚\nfiltered ä¸€ä¸ªç™¾åˆ†æ¯”çš„å€¼ï¼Œå’Œrows åˆ—çš„å€¼ä¸€èµ·ä½¿ç”¨ï¼Œå¯ä»¥ä¼°è®¡å‡ºæŸ¥è¯¢æ‰§è¡Œè®¡åˆ’(QEP)ä¸­çš„å‰ä¸€ä¸ªè¡¨çš„ç»“æœé›†ï¼Œä»è€Œç¡®å®šjoinæ“ä½œçš„å¾ªç¯æ¬¡æ•°ã€‚å°è¡¨é©±åŠ¨å¤§è¡¨ï¼Œå‡è½»è¿æ¥çš„æ¬¡æ•°ã€‚\nextra Using filesortï¼š è¯´æ˜MySQLä¼šå¯¹æ•°æ®ä½¿ç”¨ä¸€ä¸ªå¤–éƒ¨çš„ç´¢å¼•æ’åºï¼Œè€Œä¸æ˜¯æŒ‰ç…§è¡¨å†…çš„ç´¢å¼•é¡ºåºè¿›è¡Œè¯»å–ã€‚MySQLä¸­æ— æ³•åˆ©ç”¨ç´¢å¼•å®Œæˆçš„æ’åºæ“ä½œç§°ä¸ºâ€œæ–‡ä»¶æ’åºâ€ ã€‚å‡ºç°è¿™ä¸ªå°±è¦ç«‹åˆ»ä¼˜åŒ–sqlã€‚ **Using temporaryï¼š**ä½¿ç”¨äº†ä¸´æ—¶è¡¨ä¿å­˜ä¸­é—´ç»“æœï¼ŒMySQLåœ¨å¯¹æŸ¥è¯¢ç»“æœæ’åºæ—¶ä½¿ç”¨ä¸´æ—¶è¡¨ã€‚å¸¸è§äºæ’åº order by å’Œ åˆ†ç»„æŸ¥è¯¢ group byã€‚ å‡ºç°è¿™ä¸ªæ›´è¦ç«‹åˆ»ä¼˜åŒ–sqlã€‚ Using indexï¼š è¡¨ç¤ºç›¸åº”çš„select æ“ä½œä¸­ä½¿ç”¨äº†è¦†ç›–ç´¢å¼•ï¼ˆCovering indexï¼‰ï¼Œé¿å…è®¿é—®äº†è¡¨çš„æ•°æ®è¡Œï¼Œæ•ˆæœä¸é”™ï¼å¦‚æœåŒæ—¶å‡ºç°Using whereï¼Œè¡¨æ˜ç´¢å¼•è¢«ç”¨æ¥æ‰§è¡Œç´¢å¼•é”®å€¼çš„æŸ¥æ‰¾ã€‚å¦‚æœæ²¡æœ‰åŒæ—¶å‡ºç°Using whereï¼Œè¡¨ç¤ºç´¢å¼•ç”¨æ¥è¯»å–æ•°æ®è€Œéæ‰§è¡ŒæŸ¥æ‰¾åŠ¨ä½œã€‚ **Covering Indexï¼š**è¦†ç›–ç´¢å¼•ä¹Ÿå«ç´¢å¼•è¦†ç›–ï¼Œå°±æ˜¯select çš„æ•°æ®åˆ—åªç”¨ä»ç´¢å¼•ä¸­å°±èƒ½å¤Ÿå–å¾—ï¼Œä¸å¿…è¯»å–æ•°æ®è¡Œï¼ŒMySQLå¯ä»¥åˆ©ç”¨ç´¢å¼•è¿”å›select åˆ—è¡¨ä¸­çš„å­—æ®µï¼Œè€Œä¸å¿…æ ¹æ®ç´¢å¼•å†æ¬¡è¯»å–æ•°æ®æ–‡ä»¶ã€‚ Using index conditionï¼š åœ¨5.6ç‰ˆæœ¬ååŠ å…¥çš„æ–°ç‰¹æ€§ï¼Œä¼˜åŒ–å™¨ä¼šåœ¨ç´¢å¼•å­˜åœ¨çš„æƒ…å†µä¸‹ï¼Œé€šè¿‡ç¬¦åˆRANGEèŒƒå›´çš„æ¡æ•° å’Œ æ€»æ•°çš„æ¯”ä¾‹æ¥é€‰æ‹©æ˜¯ä½¿ç”¨ç´¢å¼•è¿˜æ˜¯è¿›è¡Œå…¨è¡¨éå†ã€‚ Using whereï¼š è¡¨æ˜ä½¿ç”¨äº†where è¿‡æ»¤ Using join bufferï¼š è¡¨æ˜ä½¿ç”¨äº†è¿æ¥ç¼“å­˜ impossible whereï¼š where è¯­å¥çš„å€¼æ€»æ˜¯falseï¼Œä¸å¯ç”¨ï¼Œä¸èƒ½ç”¨æ¥è·å–ä»»ä½•å…ƒç´  distinctï¼š ä¼˜åŒ–distinctæ“ä½œï¼Œåœ¨æ‰¾åˆ°ç¬¬ä¸€åŒ¹é…çš„å…ƒç»„åå³åœæ­¢æ‰¾åŒæ ·å€¼çš„åŠ¨ä½œã€‚\nåœ¨æŸ¥è¯¢ä¸­ä½¿ç”¨ç´¢å¼• å…ˆåˆ›å»ºä¸¤ä¸ªè¡¨\n1CREATE TABLE user 2( 3 id int(11) UNSIGNED AUTO_INCREMENT 4 PRIMARY KEY, 5 name char(10) NOT NULL, 6 age int NOT NULL 7) 8 ENGINE = InnoDB; 1CREATE TABLE phone 2( 3 id int(11) UNSIGNED AUTO_INCREMENT 4 PRIMARY KEY, 5 uid int(11) UNSIGNED NOT NULL, 6 phone char(10) NOT NULL 7) 8 ENGINE = InnoDB; mysqlçš„ä¸»é”®å¸¦æœ‰ä¸€ä¸ªä¸»é”®ç´¢å¼•,åœ¨åˆ›å»ºè¡¨çš„æ—¶å€™å·²ç»å»ºç«‹ åœ¨ç®€å•åœ°æŸ¥è¯¢ä¸­ä½¿ç”¨ç´¢å¼•\n1EXPLAIN SELECT name FROM user è¿™æ—¶å€™å¹¶æ²¡æœ‰ä½¿ç”¨ç´¢å¼•,å› ä¸ºæˆ‘ä»¬æ²¡æœ‰åŠ é™åˆ¶æ¡ä»¶\n1EXPLAIN SELECT name FROM user WHERE id=1 è¿™æ—¶å€™ç´¢å¼•å·²ç»èµ·ä½œç”¨äº†,æ˜¯constç±»å‹ å†æ¥çœ‹å¦ä¸€ç§æƒ…å†µ\n1EXPLAIN SELECT id FROM user WHERE id+1 =2 è¿™æ—¶å€™è™½ç„¶ä½¿ç”¨äº†ç´¢å¼•,ä½†æ˜¯ç´¢å¼•ç±»å‹æ˜¯indexç±»å‹,æ•ˆæœå¤§æ‰“æŠ˜æ‰£\nç»™userè¡¨ä¸­çš„nameå­—æ®µåŠ ä¸Šç´¢å¼•\n1ALTER TABLE `user` ADD INDEX `_name`(`name`) USING BTREE; ä½¿ç”¨LIKEæ¨¡ç³ŠæŸ¥è¯¢\n1EXPLAIN SELECT name FROM user WHERE name LIKE \u0026#39;ç‹%\u0026#39; å¯ä»¥çœ‹åˆ°,ä½¿ç”¨äº†ç´¢å¼•,ç±»å‹ä¸ºrange æ¢ä¸ªåŒ¹é…æ–¹å¼è¯•è¯•\n1EXPLAIN SELECT name FROM user WHERE name LIKE \u0026#39;%ç‹\u0026#39; è¿™æ—¶å€™,è™½ç„¶ä½¿ç”¨äº†ç´¢å¼•,ä½†æ˜¯ç´¢å¼•ç±»å‹æ˜¯index,å…¨å±€ç´¢å¼•æ‰«æ,æ•ˆç‡æ˜¯å¾ˆä½çš„.\nå†æ¥è¯•ä¸€ä¸‹ORè¿æ¥æŸ¥è¯¢\n1EXPLAIN SELECT id,uid FROM phone WHERE id=1 or id =2 ä½¿ç”¨äº†ç´¢å¼•,æ˜¯rangeç±»å‹ å†æ¥è¯•ä¸€ä¸‹ INçº¦æŸæŸ¥è¯¢,è¿™ä¸¤æ¬¡æŸ¥è¯¢ç»“æœæ˜¯ç›¸åŒçš„\n1EXPLAIN SELECT id,uid FROM phone WHERE id IN (1,2) åŒæ ·,ä½¿ç”¨äº†ç´¢å¼•,æ˜¯rangeç±»å‹\nå†æ¥è¯•ä¸€ä¸‹ ORæŸ¥è¯¢çš„å¦ä¸€ç§æƒ…å†µ\n1EXPLAIN SELECT id,uid FROM phone WHERE id = 1 OR uid=2 è¿™æ—¶å€™ä¼šå‘ç°,ç«Ÿç„¶æ²¡æœ‰ä½¿ç”¨ç´¢å¼•,typeæ˜¯ALL,å› ä¸ºè¿™æ¬¡ORçš„è¿ä¸ªå­—æ®µåªæœ‰idæœ‰ç´¢å¼•,uidæ²¡æœ‰ç´¢å¼•,æ‰€ä»¥åœ¨æŸ¥è¯¢çš„æ—¶å€™å°±ä¼šæ”¾å¼ƒä½¿ç”¨ç´¢å¼•,ä½¿ç”¨å…¨å±€æ‰«æ. è¿™ç§æƒ…å†µæ˜¯å¯ä»¥ä½¿ç”¨union è¿æ¥æŸ¥è¯¢ä¼˜åŒ–çš„\n1EXPLAIN SELECT id 2 FROM phone 3 WHERE id = 1 4 UNION ALL 5 SELECT uid 6 FROM phone 7 WHERE uid = 2 æˆ‘ä»¬å¯ä»¥çœ‹åˆ°,åœ¨æŸ¥è¯¢idæ—¶ä½¿ç”¨é‡Œç´¢å¼•,æŸ¥è¯¢uidæ—¶,å› ä¸ºuidæ²¡æœ‰ç´¢å¼•,æ‰€ä»¥æ²¡æœ‰ä½¿ç”¨ç´¢å¼•. å†æ¥çœ‹ä¸€ä¸‹å¾ˆå¸¸ç”¨çš„è¿æ¥æŸ¥è¯¢,\n1EXPLAIN SELECT user.id, name, uid, phone 2 FROM user 3 JOIN phone ON user.id = 1 AND uid = 2 (åœ¨ä½¿ç”¨è¿æ¥æŸ¥è¯¢çš„æ—¶å€™å°½é‡ä½¿ç”¨join,ä¸è¦ä½¿ç”¨left join å’Œ right join,åœ¨ä½¿ç”¨joinæŸ¥è¯¢çš„æ—¶å€™,mysqlè§£æå™¨ä¼šè‡ªåŠ¨é€‰æ‹©ç”¨å°è¡¨é©±åŠ¨å¤§è¡¨,è¿™æ ·å¯ä»¥æé«˜æŸ¥è¯¢æ•ˆç‡,å¦‚æœä½¿ç”¨left joinæˆ–è€…right joinä¼šæŒ‡å®šé©±åŠ¨è¡¨,æœ‰æ—¶å€™ä¼šé™ä½æŸ¥è¯¢æ•ˆç‡) è¿™æ—¶å€™åªæœ‰åœ¨æŸ¥è¯¢userè¡¨æ—¶ä½¿ç”¨äº†ç´¢å¼•,åœ¨æŸ¥è¯¢phoneè¡¨æ—¶æ²¡æœ‰ä½¿ç”¨ç´¢å¼•.å› ä¸ºåœ¨ONçš„çº¦æŸæ¡ä»¶ä¸­,idæ˜¯æœ‰ç´¢å¼•çš„,è€Œuidæ²¡æœ‰ç´¢å¼•,æ‰€ä»¥åœ¨æŸ¥è¯¢çš„æ—¶å€™ä¸ä¼šä½¿ç”¨ç´¢å¼•. è¿™æ—¶å€™ç»™uidå­—æ®µåŠ ä¸Šç´¢å¼•,çœ‹çœ‹æ•ˆæœ. æ·»åŠ ç´¢å¼•\n1ALTER TABLE `phone` ADD INDEX `_uid`(`uid`) USING BTREE; è·Ÿåˆšæ‰ä¸€æ ·,ä½¿ç”¨è¿æ¥æŸ¥è¯¢\n1EXPLAIN SELECT user.id, name, uid, phone 2 FROM user 3 JOIN phone ON user.id = 1 AND uid = 2 è¿™æ—¶å€™å¯ä»¥çœ‹åˆ°,æŸ¥è¯¢userè¡¨å’Œphoneè¡¨æ—¶,éƒ½ä½¿ç”¨äº†ç´¢å¼•ã€‚\næ€»ç»“ åœ¨æœ‰é™åˆ¶æ¡ä»¶(WHERE,ON)çš„çš„æŸ¥è¯¢ä¸­,å¯¹çº¦æŸå­—æ®µå°½é‡éƒ½åŠ ä¸Šç´¢å¼•.åœ¨æ•°æ®é‡å¾ˆå¤§çš„æ—¶å€™,æå‡æŸ¥è¯¢æ•ˆç‡ç‰¹åˆ«æ˜æ˜¾ ä¸è¦åœ¨çº¦æŸæ¡ä»¶ä¸Šè¿›è¡Œè¿ç®—,åœ¨æŸ¥è¯¢ä¸­å¯¹ç´¢å¼•å­—æ®µè¿›è¡Œè¿ç®—,ä¼šä½¿ç”¨indexç´¢å¼•,æ•ˆæœå¤§æ‰“æŠ˜æ‰£ åœ¨ä½¿ç”¨LIKE æ¨¡ç³ŠåŒ¹é…æ—¶,å°½é‡ç”¨ 'XXX%',ä¸è¦ä½¿ç”¨'%XXX' åœ¨ç»å¸¸åˆ é™¤ã€æ›´æ–°æ•°æ®çš„å­—æ®µå’Œæ•°æ®é‡ä¸å¤§çš„æ—¶å€™(ç½‘ä¸Šè¯´å°äºç™¾ä¸‡,å› ä¸ºæˆ‘æ²¡æœ‰è¯•éªŒè¿‡,ä¸èƒ½ç¡®å®š),æ²¡æœ‰å¿…è¦ä½¿ç”¨ç´¢å¼•,å› ä¸ºç´¢å¼•ä¼šå æ®ç£ç›˜ç©ºé—´,è€Œä¸”ä¹Ÿä¼šé™ä½æ’å…¥å’Œæ›´æ–°æ•°æ®çš„æ•ˆç‡ã€‚ åœ¨æŸ¥è¯¢ä¸­ä¸ä¼šä½¿ç”¨çº¦æŸæ¡ä»¶çš„å­—æ®µä¹Ÿä¸ç”¨åŠ ç´¢å¼•,æ¯”å¦‚åœ¨ä¾‹å­ä¸­,ä»æ¥æ²¡æœ‰å¯¹phoneè¡¨ä¸­çš„phoneå­—æ®µä½¿ç”¨è¿‡ WHEREå’ŒONæ¡ä»¶,æ‰€ä»¥æ²¡æœ‰å¿…è¦ç»™phoneå­—æ®µåŠ ç´¢å¼•ã€‚ æŸ¥è¯¢ä¸­,ä½¿ç”¨ORçº¦æŸæ¡ä»¶æ—¶,ORä¸¤è¾¹çš„å­—æ®µéƒ½å¿…é¡»æœ‰ç´¢å¼•,å¦‚æœåªæœ‰ä¸€è¾¹çš„å­—æ®µæœ‰ç´¢å¼•,å¯ä»¥ä½¿ç”¨unionè¿æ¥æŸ¥è¯¢æé«˜æ•ˆç‡ã€‚ åœ¨è¿æ¥æŸ¥è¯¢ä¸­ï¼Œå¯¹ä¸¤ä¸ªè¡¨çš„å…³è”å­—æ®µåŠ ä¸Šç´¢å¼•ï¼Œå¯ä»¥æœ‰æ•ˆåœ°æé«˜æŸ¥è¯¢æ•ˆç‡ã€‚ NULLä¼šå¯¼è‡´ç´¢å¼•å½¢åŒè™šè®¾ï¼Œæ‰€ä»¥åœ¨è®¾è®¡è¡¨ç»“æ„æ—¶åº”é¿å…NULL çš„å­˜åœ¨ï¼ˆç”¨å…¶ä»–æ–¹å¼è¡¨è¾¾ä½ æƒ³è¡¨è¾¾çš„NULLï¼Œæ¯”å¦‚ -1ï¼Ÿï¼‰ æœ€åæ„Ÿè°¢åœ¨ç½‘ä¸Šæ— ç§åˆ†äº«çš„å‰è¾ˆä»¬ æˆ‘ä¹Ÿæ˜¯åˆšåˆšåœ¨å­¦ä¹ mysqlä¼˜åŒ–æ–¹é¢çš„çŸ¥è¯†,ä¸€è¾¹å­¦ä¹ ,ä¸€è¾¹æ€»ç»“,æ–‡ä¸­å¦‚æœæœ‰é”™è¯¯çš„åœ°æ–¹,è¿˜è¯·å„ä½å¤§ç¥æ‰¹è¯„æŒ‡æ­£\n","date":"2018-10-25T09:50:04Z","permalink":"https://lqxhub.github.io/posts/82773ef8/","title":"mysqlä½¿ç”¨ç´¢å¼•æé«˜æŸ¥è¯¢æ•ˆç‡"},{"content":"ç´¢å¼•æ˜¯ä¸€ç§ç‰¹æ®Šçš„æ–‡ä»¶(InnoDB æ•°æ®è¡¨ä¸Šçš„ç´¢å¼•æ˜¯è¡¨ç©ºé—´çš„ä¸€ä¸ªç»„æˆéƒ¨åˆ†)ï¼Œå®ƒä»¬åŒ…å«ç€å¯¹æ•°æ®è¡¨é‡Œçš„æ‰€æœ‰è®°å½•çš„å¼•ç”¨æŒ‡é’ˆã€‚æ›´é€šä¿—çš„è¯´ï¼Œæ•°æ®åº“ç´¢å¼•å°±å¥½æ¯”ä¸€æœ¬ä¹¦çš„ç›®å½•ï¼Œèƒ½å¤ŸåŠ å¿«æ•°æ®åº“çš„æŸ¥è¯¢é€Ÿåº¦ã€‚ é¦–å…ˆæ„Ÿè°¢ç½‘ä¸Šçš„é‚£äº›å‰è¾ˆå’Œå¤§ç¥ä»¬çš„æ— ç§åˆ†äº« æœ€è¿‘åœ¨å­¦ä¹ mysqlçš„ä¼˜åŒ–é—®é¢˜,åœ¨æŸ¥è¯¢ä¸­æ­£ç¡®ä½¿ç”¨ç´¢å¼•,å¯¹æŸ¥è¯¢æ•ˆç‡çš„æå‡æœ‰éå¸¸å¤§çš„å¸®åŠ©,ä½¿ç”¨ä¸å½“ä¼šä½¿ç´¢å¼•å¤±æ•ˆ,èµ·ä¸åˆ°ç´¢å¼•è¯¥æœ‰çš„ä½œç”¨ã€‚æŠŠè¿™ä¸¤å¤©å­¦åˆ°çš„çŸ¥è¯†è®°å½•ä¸€ä¸‹ã€‚\nä½¿ç”¨ç´¢å¼•çš„ä¼˜åŠ¿ æé«˜æ•°æ®çš„æ£€ç´¢é€Ÿåº¦ï¼Œé™ä½æ•°æ®åº“IOæˆæœ¬ï¼šä½¿ç”¨ç´¢å¼•çš„æ„ä¹‰å°±æ˜¯é€šè¿‡ç¼©å°è¡¨ä¸­éœ€è¦æŸ¥è¯¢çš„è®°å½•çš„æ•°ç›®ä»è€ŒåŠ å¿«æœç´¢çš„é€Ÿåº¦ã€‚ é™ä½æ•°æ®æ’åºçš„æˆæœ¬ï¼Œé™ä½CPUæ¶ˆè€—ï¼šç´¢å¼•ä¹‹æ‰€ä»¥æŸ¥çš„å¿«ï¼Œæ˜¯å› ä¸ºå…ˆå°†æ•°æ®æ’å¥½åºï¼Œè‹¥è¯¥å­—æ®µæ­£å¥½éœ€è¦æ’åºï¼Œåˆ™çœŸå¥½é™ä½äº†æ’åºçš„æˆæœ¬ã€‚ ä½¿ç”¨ç´¢å¼•å¸¦æ¥çš„é—®é¢˜ 1.å ç”¨å­˜å‚¨ç©ºé—´ï¼šç´¢å¼•å®é™…ä¸Šä¹Ÿæ˜¯ä¸€å¼ è¡¨ï¼Œè®°å½•äº†ä¸»é”®ä¸ç´¢å¼•å­—æ®µï¼Œä¸€èˆ¬ä»¥ç´¢å¼•æ–‡ä»¶çš„å½¢å¼å­˜å‚¨åœ¨ç£ç›˜ä¸Šã€‚ 2. é™ä½æ›´æ–°è¡¨çš„é€Ÿåº¦ï¼šè¡¨çš„æ•°æ®å‘ç”Ÿäº†å˜åŒ–ï¼Œå¯¹åº”çš„ç´¢å¼•ä¹Ÿéœ€è¦ä¸€èµ·å˜æ›´ï¼Œä»è€Œå‡ä½çš„æ›´æ–°é€Ÿåº¦ã€‚å¦åˆ™ç´¢å¼•æŒ‡å‘çš„ç‰©ç†æ•°æ®å¯èƒ½ä¸å¯¹ï¼Œè¿™ä¹Ÿæ˜¯ç´¢å¼•å¤±æ•ˆçš„åŸå› ä¹‹ä¸€ã€‚\nç´¢å¼•çš„ç±»å‹ 1.normalï¼š è¡¨ç¤ºæ™®é€šç´¢å¼•,å®ƒæ²¡æœ‰ä»»ä½•é™åˆ¶ï¼ŒMyISAM ä¸­é»˜è®¤çš„ B-tree ç±»å‹çš„ç´¢å¼• 2.uniqueï¼š è¡¨ç¤ºå”¯ä¸€çš„ï¼Œä¸å…è®¸é‡å¤çš„ç´¢å¼•ï¼Œä½†æ˜¯å…è®¸æœ‰ç©ºå€¼ã€‚å¦‚æœè¯¥å­—æ®µä¿¡æ¯ä¿è¯ä¸ä¼šé‡å¤ä¾‹å¦‚èº«ä»½è¯å·ç”¨ä½œç´¢å¼•æ—¶ï¼Œå¯è®¾ç½®ä¸ºuniqueã€‚ 3.full textl: è¡¨ç¤ºå…¨æ–‡æœç´¢çš„ç´¢å¼•ã€‚ FULLTEXT ç”¨äºæœç´¢å¾ˆé•¿ä¸€ç¯‡æ–‡ç« çš„æ—¶å€™ï¼Œæ•ˆæœæœ€å¥½ã€‚æ³¨æ„ä»… MyISAM å¼•æ“æ”¯æŒ 4.ç»„åˆç´¢å¼•ï¼ˆæœ€å·¦å‰ç¼€ï¼‰ å¹³æ—¶ç”¨çš„SQLæŸ¥è¯¢è¯­å¥ä¸€èˆ¬éƒ½æœ‰æ¯”è¾ƒå¤šçš„é™åˆ¶æ¡ä»¶ï¼Œæ‰€ä»¥ä¸ºäº†è¿›ä¸€æ­¥æ¦¨å–MySQLçš„æ•ˆç‡ï¼Œå°±è¦è€ƒè™‘å»ºç«‹ç»„åˆç´¢å¼•ã€‚ä½¿ç”¨ç»„åˆç´¢å¼•æ—¶æ³¨æ„æœ€å·¦åŒ¹é…åŸåˆ™ã€‚ æ¯”å¦‚æ–°å»ºç´¢å¼•ALTER TABLE testADD INDEX 'id_name_age' ('id','name','age')ã€‚ åœ¨æŸ¥è¯¢çš„æ—¶SELECT * FROM user WHERE id =1 AND name='bruce'ç´¢å¼•èµ·ä½œç”¨ã€‚ ä½†æ˜¯æŸ¥è¯¢æ—¶SELECT * FROM user WHERE name='bruce' AND age = 18è¿™æ—¶å€™ç´¢å¼•ä¸èµ·ä½œç”¨ã€‚ è‡³äºåŸå› ,å› ä¸ºè¾…åŠ©ç´¢å¼•æ˜¯B+æ ‘å®ç°çš„ï¼Œè™½ç„¶å¯ä»¥æŒ‡å®šå¤šä¸ªåˆ—ï¼Œä½†æ˜¯æ¯ä¸ªåˆ—çš„æ¯”è¾ƒä¼˜å…ˆçº§ä¸ä¸€æ ·ï¼Œå†™åœ¨å‰é¢çš„ä¼˜å…ˆæ¯”è¾ƒã€‚ä¸€æ—¦å‡ºç°é—æ¼ï¼Œåœ¨B+æ ‘ä¸Šå°±æ— æ³•ç»§ç»­æœç´¢äº†ï¼ˆé€šè¿‡è¡¥é½ç­‰æªæ–½è§£å†³çš„é™¤å¤–ï¼‰ï¼Œå› æ­¤æ˜¯æŒ‰ç…§æœ€å·¦è¿ç»­åŒ¹é…æ¥çš„ã€‚æ—¢ç„¶æ˜¯åœ¨B+æ ‘ä¸Šæœç´¢ï¼Œå¯¹äºæ¡ä»¶çš„æ¯”è¾ƒè‡ªç„¶æ˜¯è¦æ±‚ç²¾ç¡®åŒ¹é…ï¼ˆå³\u0026quot;=\u0026ldquo;å’Œ\u0026quot;IN\u0026rdquo;ï¼‰ã€‚ä¸è¿‡é¡ºåºå€’æ˜¯å¯ä»¥é¢ å€’ï¼Œå› ä¸ºæŸ¥è¯¢ä¼˜åŒ–å™¨é‡æ’åºä¸€ä¸‹å°±å¥½äº†ã€‚\nç´¢å¼•çš„ä¼˜åŒ– åº”å°½é‡é¿å…åœ¨ where å­å¥ä¸­å¯¹å­—æ®µè¿›è¡Œ null å€¼åˆ¤æ–­ï¼Œå¦åˆ™å°†å¯¼è‡´å¼•æ“æ”¾å¼ƒä½¿ç”¨ç´¢å¼•è€Œè¿›è¡Œå…¨è¡¨æ‰«æï¼Œå¦‚ï¼š select id from t where num is null,å¯ä»¥åœ¨numä¸Šè®¾ç½®é»˜è®¤å€¼0ï¼Œç¡®ä¿è¡¨ä¸­numåˆ—æ²¡æœ‰nullå€¼ï¼Œç„¶åè¿™æ ·æŸ¥è¯¢ï¼š select id from t where num=0 åº”å°½é‡é¿å…åœ¨ where å­å¥ä¸­ä½¿ç”¨!=æˆ–\u0026lt;\u0026gt;æ“ä½œç¬¦ï¼Œå¦åˆ™å°†å¼•æ“æ”¾å¼ƒä½¿ç”¨ç´¢å¼•è€Œè¿›è¡Œå…¨è¡¨æ‰«æã€‚ä¼˜åŒ–å™¨å°†æ— æ³•é€šè¿‡ç´¢å¼•æ¥ç¡®å®šå°†è¦å‘½ä¸­çš„è¡Œæ•°,å› æ­¤éœ€è¦æœç´¢è¯¥è¡¨çš„æ‰€æœ‰è¡Œã€‚ åº”å°½é‡é¿å…åœ¨ where å­å¥ä¸­ä½¿ç”¨ or æ¥è¿æ¥æ¡ä»¶ï¼Œå¦åˆ™å°†å¯¼è‡´å¼•æ“æ”¾å¼ƒä½¿ç”¨ç´¢å¼•è€Œè¿›è¡Œå…¨è¡¨æ‰«æï¼Œå¦‚ï¼š select id from t where num=10 or num=20 å°½é‡é¿å…åœ¨ç´¢å¼•è¿‡çš„å­—ç¬¦æ•°æ®ä¸­ï¼Œä½¿ç”¨éæ‰“å¤´å­—æ¯æœç´¢ã€‚è¿™ä¹Ÿä½¿å¾—å¼•æ“æ— æ³•åˆ©ç”¨ç´¢å¼•ã€‚ è§å¦‚ä¸‹ä¾‹å­ï¼š SELECT * FROM T1 WHERE NAME LIKE â€˜%L%â€™ SELECT * FROM T1 WHERE SUBSTING(NAME,2,1)=â€™Lâ€™ SELECT * FROM T1 WHERE NAME LIKE â€˜L%â€™ åº”å°½é‡é¿å…åœ¨ where å­å¥ä¸­å¯¹å­—æ®µè¿›è¡Œè¡¨è¾¾å¼æ“ä½œï¼Œè¿™å°†å¯¼è‡´å¼•æ“æ”¾å¼ƒä½¿ç”¨ç´¢å¼•è€Œè¿›è¡Œå…¨è¡¨æ‰«æ åº”å°½é‡é¿å…åœ¨whereå­å¥ä¸­å¯¹å­—æ®µè¿›è¡Œå‡½æ•°æ“ä½œï¼Œè¿™å°†å¯¼è‡´å¼•æ“æ”¾å¼ƒä½¿ç”¨ç´¢å¼•è€Œè¿›è¡Œå…¨è¡¨æ‰«æ ä¸è¦åœ¨ where å­å¥ä¸­çš„â€œ=â€å·¦è¾¹è¿›è¡Œå‡½æ•°ã€ç®—æœ¯è¿ç®—æˆ–å…¶ä»–è¡¨è¾¾å¼è¿ç®—ï¼Œå¦åˆ™ç³»ç»Ÿå°†å¯èƒ½æ— æ³•æ­£ç¡®ä½¿ç”¨ç´¢å¼• æ€»ç»“ å“ªäº›æƒ…å†µéœ€è¦å»ºç´¢å¼•ï¼š\n1 ä¸»é”®ï¼Œå”¯ä¸€ç´¢å¼• 2 ç»å¸¸ç”¨ä½œæŸ¥è¯¢æ¡ä»¶çš„å­—æ®µéœ€è¦åˆ›å»ºç´¢å¼• 3 ç»å¸¸éœ€è¦æ’åºã€åˆ†ç»„å’Œç»Ÿè®¡çš„å­—æ®µéœ€è¦å»ºç«‹ç´¢å¼• 4 æŸ¥è¯¢ä¸­ä¸å…¶ä»–è¡¨å…³è”çš„å­—æ®µï¼Œå¤–é”®å…³ç³»å»ºç«‹ç´¢å¼•\nå“ªäº›æƒ…å†µä¸è¦å»ºç´¢å¼•ï¼š\n1 è¡¨çš„è®°å½•å¤ªå°‘ï¼Œç™¾ä¸‡çº§ä»¥ä¸‹çš„æ•°æ®ä¸éœ€è¦åˆ›å»ºç´¢å¼•,æ•°æ®é‡å¾ˆå°‘çš„æ—¶å€™,ç´¢å¼•å¸¦æ¥çš„æå‡ä¸å¤Ÿæ˜æ˜¾ 2 ç»å¸¸å¢åˆ æ”¹çš„è¡¨ä¸éœ€è¦åˆ›å»ºç´¢å¼•(åœ¨ä¿®æ”¹è¡¨çš„å†…å®¹æ—¶ï¼Œç´¢å¼•å¿…é¡»è¿›è¡Œæ›´æ–°ï¼Œæœ‰æ—¶å¯èƒ½éœ€è¦é‡æ„ï¼Œå› æ­¤ï¼Œç´¢å¼•è¶Šå¤šï¼Œæ‰€èŠ±çš„æ—¶é—´è¶Šé•¿ã€‚) 3 æ•°æ®é‡å¤ä¸”åˆ†å¸ƒå¹³å‡çš„å­—æ®µä¸éœ€è¦åˆ›å»ºç´¢å¼•ï¼Œå¦‚ true,false ä¹‹ç±»ã€‚(ä½“ç°ä¸å‡ºç´¢å¼•å¸¦æ¥çš„ä»·å€¼) 4 é¢‘å‘æ›´æ–°çš„å­—æ®µä¸é€‚åˆåˆ›å»ºç´¢å¼•(å’Œ2åŒç†) 5 whereæ¡ä»¶é‡Œç”¨ä¸åˆ°çš„å­—æ®µä¸éœ€è¦åˆ›å»ºç´¢å¼•(ç´¢å¼•èµ·ä¸åˆ°ä½œç”¨)\nä½¿ç”¨æ³¨æ„:\næ€§èƒ½ä¼˜åŒ–è¿‡ç¨‹ä¸­ï¼Œé€‰æ‹©åœ¨å“ªä¸ªåˆ—ä¸Šåˆ›å»ºç´¢å¼•æ˜¯æœ€é‡è¦çš„æ­¥éª¤ä¹‹ä¸€ã€‚å¯ä»¥è€ƒè™‘ä½¿ç”¨ç´¢å¼•çš„ä¸»è¦æœ‰ä¸¤ç§ç±»å‹çš„åˆ—ï¼šåœ¨whereå­å¥ä¸­å‡ºç°çš„åˆ—ï¼Œåœ¨joinå­å¥ä¸­å‡ºç°çš„åˆ—ã€‚ è€ƒè™‘åˆ—ä¸­å€¼çš„åˆ†å¸ƒï¼Œç´¢å¼•çš„åˆ—çš„åŸºæ•°è¶Šå¤§ï¼Œç´¢å¼•çš„æ•ˆæœè¶Šå¥½ã€‚ ä½¿ç”¨çŸ­ç´¢å¼•ï¼Œå¦‚æœå¯¹å­—ç¬¦ä¸²åˆ—è¿›è¡Œç´¢å¼•ï¼Œåº”è¯¥æŒ‡å®šä¸€ä¸ªå‰ç¼€é•¿åº¦ï¼Œå¯èŠ‚çœå¤§é‡ç´¢å¼•ç©ºé—´ï¼Œæå‡æŸ¥è¯¢é€Ÿåº¦ã€‚ ä¸è¦è¿‡åº¦ç´¢å¼•ï¼Œåªä¿æŒæ‰€éœ€çš„ç´¢å¼•ã€‚æ¯ä¸ªé¢å¤–çš„ç´¢å¼•éƒ½è¦å ç”¨é¢å¤–çš„ç£ç›˜ç©ºé—´ï¼Œå¹¶é™ä½å†™æ“ä½œçš„æ€§èƒ½ã€‚ åœ¨ä¿®æ”¹è¡¨çš„å†…å®¹æ—¶ï¼Œç´¢å¼•å¿…é¡»è¿›è¡Œæ›´æ–°ï¼Œæœ‰æ—¶å¯èƒ½éœ€è¦é‡æ„ï¼Œå› æ­¤ï¼Œç´¢å¼•è¶Šå¤šï¼Œæ‰€èŠ±çš„æ—¶é—´è¶Šé•¿ã€‚ MySQLåªå¯¹ä¸€ä¸‹æ“ä½œç¬¦æ‰ä½¿ç”¨ç´¢å¼•ï¼š\u0026lt;,\u0026lt;=,=,\u0026gt;,\u0026gt;=,between,in, ä»¥åŠæŸäº›æ—¶å€™çš„like(ä¸ä»¥é€šé…ç¬¦%æˆ–_å¼€å¤´çš„æƒ…å½¢)ã€‚ å†æ¬¡æ„Ÿè°¢å‰è¾ˆä»¬çš„æ— ç§åˆ†äº« æˆ‘ä¹Ÿæ˜¯åœ¨å­¦ä¹ ä¸­,æ–‡ä¸­å¦‚æœ‰é”™è¯¯çš„åœ°æ–¹,æ¬¢è¿åœ¨è¯„è®ºåŒºæŒ‡å‡º,æ–¹ä¾¿å…±åŒå­¦ä¹ \n","date":"2018-10-25T09:46:12Z","permalink":"https://lqxhub.github.io/posts/82773ef8/","title":"mysqlç´¢å¼•çš„ä½¿ç”¨å’Œä¼˜åŒ–"},{"content":"æœ€è¿‘åœ¨åšé¡¹ç›®çš„æ—¶å€™ç”¨åˆ°äº†webSocketåè®®,è€Œä¸”æ˜¯åœ¨å¾®ä¿¡å°ç¨‹åºä¸­ç”¨åˆ°äº†webSocket,å¾®ä¿¡å°ç¨‹åºä¸­ä½¿ç”¨wssåè®®çš„æ—¶å€™ä¸èƒ½è®¾ç½®ç«¯å£,åªèƒ½ä½¿ç”¨é»˜è®¤çš„443ç«¯å£ã€‚ æˆ‘æ“¦ï¼Œæˆ‘çš„httpså·²ç»ç›‘å¬äº†443ç«¯å£ï¼ŒwebSocketå†å»ç›‘å¬443ï¼Œè‚¯å®šä¸è¡Œå•Šã€‚è¦æƒ³åŠæ³•è§£å†³ï¼Œè€å¤§æŠŠè¿™ä¸ªé—®é¢˜äº¤ç»™æˆ‘äº†ï¼Œæˆ‘æ„‰å¿«ï¼ˆæ‰‹åŠ¨æ‡µé€¼ï¼‰çš„æ¥æ”¶äº†è¿™ä¸ªä»»åŠ¡ã€‚æƒ³åˆ°äº†ä¸¤ç§åŠæ³•è§£å†³ã€‚ ä¸€ç§è§£å†³åŠæ³•æ˜¯æŠŠwebSocketéƒ¨ç½²åˆ°å¦ä¸€å°æœåŠ¡å™¨ä¸Šï¼Œè¿™æ ·æˆæœ¬ä¹Ÿå¤ªé«˜äº†ã€‚å¦ä¸€ç§åŠæ³•ï¼Œå°±æ˜¯ä½¿ç”¨nginxåå‘ä»£ç†ã€‚\nå› ä¸ºwebSocketåè®®æ˜¯åŸºäºhttpåè®®å‡çº§çš„ï¼ˆè§ä¸‹å›¾ï¼‰ï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨nginxåå‘ä»£ç†webSocket. ä»è¿™å¼ å›¾ç‰‡ä¸Šå¯ä»¥çœ‹å‡ºï¼ŒwebSocketè¿æ¥çš„å»ºç«‹æ˜¯åœ¨httpåè®®çš„åŸºç¡€ä¸Šã€‚\n1GET /chat HTTP/1.1 2Host: server.example.com 3Upgrade: websocket 4Connection: Upgrade 5Sec-WebSocket-Key: x3JJHMbDL1EzLkh9GBhXDw== 6Sec-WebSocket-Protocol: chat, superchat 7Sec-WebSocket-Version: 13 8Origin: http://example.com ç†Ÿæ‚‰HTTPçš„ç«¥é‹å¯èƒ½å‘ç°äº†ï¼Œè¿™æ®µç±»ä¼¼HTTPåè®®çš„æ¡æ‰‹è¯·æ±‚ä¸­ï¼Œåªæ˜¯å¤šäº†å‡ ä¸ªä¸œè¥¿ã€‚\n1Upgrade: websocket 2Connection: Upgrade 3è¿™ä¸ªå°±æ˜¯Websocketçš„æ ¸å¿ƒäº†ï¼Œå‘Šè¯‰Apacheã€Nginxç­‰æœåŠ¡å™¨ï¼šæˆ‘å‘èµ·çš„æ˜¯Websocketåè®®ã€‚ 4Sec-WebSocket-Key: x3JJHMbDL1EzLkh9GBhXDw== 5Sec-WebSocket-Protocol: chat, superchat 6Sec-WebSocket-Version: 13 é¦–å…ˆï¼ŒSec-WebSocket-Key æ˜¯ä¸€ä¸ªBase64 encodeçš„å€¼ï¼Œè¿™ä¸ªæ˜¯æµè§ˆå™¨éšæœºç”Ÿæˆçš„ï¼Œå‘Šè¯‰æœåŠ¡å™¨ï¼šæ³¥ç…¤ï¼Œä¸è¦å¿½æ‚ çªï¼Œæˆ‘è¦éªŒè¯å°¼æ˜¯ä¸æ˜¯çœŸçš„æ˜¯WebsocketåŠ©ç†ã€‚ æœ€åï¼ŒSec-WebSocket-Version æ˜¯å‘Šè¯‰æœåŠ¡å™¨æ‰€ä½¿ç”¨çš„Websocket Draftï¼ˆåè®®ç‰ˆæœ¬ï¼‰ï¼Œåœ¨æœ€åˆçš„æ—¶å€™ï¼ŒWebsocketåè®®è¿˜åœ¨ Draft é˜¶æ®µï¼Œå„ç§å¥‡å¥‡æ€ªæ€ªçš„åè®®éƒ½æœ‰ï¼Œè€Œä¸”è¿˜æœ‰å¾ˆå¤šæœŸå¥‡å¥‡æ€ªæ€ªä¸åŒçš„ä¸œè¥¿ï¼Œä»€ä¹ˆFirefoxå’ŒChromeç”¨çš„ä¸æ˜¯ä¸€ä¸ªç‰ˆæœ¬ä¹‹ç±»çš„ï¼Œå½“åˆWebsocketåè®®å¤ªå¤šå¯æ˜¯ä¸€ä¸ªå¤§éš¾é¢˜ã€‚ã€‚ä¸è¿‡ç°åœ¨è¿˜å¥½ï¼Œå·²ç»å®šä¸‹æ¥å•¦å¤§å®¶éƒ½ä½¿ç”¨çš„ä¸€ä¸ªä¸œè¥¿\nç„¶åæœåŠ¡å™¨ä¼šè¿”å›ä¸‹åˆ—ä¸œè¥¿ï¼Œè¡¨ç¤ºå·²ç»æ¥å—åˆ°è¯·æ±‚ï¼Œ æˆåŠŸå»ºç«‹Websocketå•¦ï¼\n1HTTP/1.1 101 Switching Protocols 2Upgrade: websocket 3Connection: Upgrade 4Sec-WebSocket-Accept: HSmrc0sMlYUkAGmm5OPpG2HaGWk= 5Sec-WebSocket-Protocol: chat è¿™é‡Œå¼€å§‹å°±æ˜¯HTTPæœ€åè´Ÿè´£çš„åŒºåŸŸäº†ï¼Œå‘Šè¯‰å®¢æˆ·ï¼Œæˆ‘å·²ç»æˆåŠŸåˆ‡æ¢åè®®å•¦~\n1Upgrade: websocket 2Connection: Upgrade ä¾ç„¶æ˜¯å›ºå®šçš„ï¼Œå‘Šè¯‰å®¢æˆ·ç«¯å³å°†å‡çº§çš„æ˜¯Websocketåè®®ã€‚è‡³æ­¤ï¼ŒHTTPå·²ç»å®Œæˆå®ƒæ‰€æœ‰å·¥ä½œäº†ï¼Œæ¥ä¸‹æ¥å°±æ˜¯å®Œå…¨æŒ‰ç…§Websocketåè®®è¿›è¡Œäº†ã€‚\næ˜ç™½åè®®çš„åŸç†äº†å°±å¯ä»¥ä¸‹ä¸€æ­¥äº†\né¦–å…ˆnginxå…ˆé…ç½®å¥½httpsçš„è¯ä¹¦ æœåŠ¡å™¨çš„è¯ä¹¦æ˜¯è€å¤§é…ç½®å¥½çš„ï¼Œæˆ‘å°±ç›´æ¥ç”¨äº†ã€‚\nåœ¨nginxé…ç½®æ–‡ä»¶çš„serviceèŠ‚ç‚¹ä¸­æ·»åŠ å¦‚ä¸‹é…ç½®\n1location /wss 2 { 3 proxy_pass http://127.0.0.1:8888; 4 proxy_http_version 1.1; 5 proxy_set_header Upgrade $http_upgrade; 6 proxy_set_header Connection \u0026#34;Upgrade\u0026#34;; 7 proxy_set_header X-Real-IP $remote_addr; 8 } è§£é‡Šä¸€ä¸‹å‚æ•° /wssè¿™ä¸ªæ˜¯éšä¾¿èµ·çš„,å‘Šè¯‰Nginxè¦ä»£ç†çš„url,ç°åœ¨æˆ‘çš„è®¾ç½®ä¸ºwss,å½“æˆ‘è®¿é—®çš„æˆ‘çš„æœåŠ¡å™¨https://abc.com/wssæ—¶,Nginxä¼šæŠŠæˆ‘çš„è¯·æ±‚æ˜ å°„åˆ°æœ¬æœºçš„8888ç«¯å£ã€‚ proxy_pass è¦ä»£ç†åˆ°çš„url,æˆ‘çš„ä»£ç†åˆ°æœ¬æœºçš„8888ç«¯å£ã€‚ proxy_http_version ä»£ç†æ—¶ä½¿ç”¨çš„ httpç‰ˆæœ¬ã€‚ é‡ç‚¹æ¥äº†: ä»£ç†webSocketçš„å…³é”®å‚æ•° proxy_set_header Upgrade æŠŠä»£ç†æ—¶httpè¯·æ±‚å¤´çš„Upgrade è®¾ç½®ä¸ºåŸæ¥httpè¯·æ±‚çš„è¯·æ±‚å¤´,wssåè®®çš„è¯·æ±‚å¤´ä¸ºwebsocket proxy_set_header Connection å› ä¸ºä»£ç†çš„wssåè®®,æ‰€ä»¥httpè¯·æ±‚å¤´çš„Connectionè®¾ç½®ä¸ºUpgrade proxy_set_header X-Real-IP ç»™ä»£ç†è®¾ç½®åŸhttpè¯·æ±‚çš„ip,å¡«å†™$remote_addr å³å¯ è‡³äºwebsocketåè®®çš„responseçš„å‚æ•°ï¼Œåœ¨åå‘ä»£ç†çš„æ—¶å€™ä¸ç”¨ç®¡ã€‚ åˆ°è¿™é‡Œ,Nginxåå‘ä»£ç†webSocketçš„é…ç½®å°±å®Œæˆäº†,é‡å¯Nginx,ç”¨websocketè¿æ¥è¯•è¯•ï¼Œåœ¨åŸæ¥wssåœ°å€çš„åœ°æ–¹å¡«å†™wss://abc.com/wssã€‚å¦‚æœwebsocketæˆåŠŸè¿æ¥,è¯´æ˜Nginxåå‘ä»£ç†websocketå·²ç»æˆåŠŸäº†ã€‚\næ€»ç»“ ç°åœ¨çš„é…ç½®åªæ˜¯åå‘ä»£ç†åˆ°æœ¬æœºæ—¶çš„é…ç½®,å¦‚æœè¦åå‘ä»£ç†åˆ°åˆ«çš„ä¸»æœº,åœ¨ä»£ç†æ—¶å¯èƒ½ä¼šè·¨åŸŸé—®é¢˜,éœ€è¦åœ¨Nginxçš„åå‘ä»£ç†ä¸­åšè·¨åŸŸçš„é…ç½®ã€‚\næ€è€ƒ åœ¨Nginxçš„é…ç½®æ–‡ä»¶ä¸­èƒ½çœ‹åˆ°è¿™ä¸€æ®µ\n1location ~ .php$ { 2 root html; 3 fastcgi_pass 127.0.0.1:9000; 4 fastcgi_index index.php; 5 fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name; 6 include fastcgi_params; 7} è¿™æ˜¯Nginxä¸­phpçš„é…ç½®æ–‡ä»¶,æˆ‘æ“¦,æ€ä¹ˆè¿™ä¹ˆçœ¼ç†Ÿ,è¿™ä¸ªé…ç½®æ¸…å•è·Ÿåˆšæ‰çš„websocketçš„åå‘ä»£ç†è¿™ä¹ˆåƒã€‚é€šè¿‡ä¸Šç½‘æŸ¥èµ„æ–™æ‰çŸ¥é“ï¼ŒåŸæ¥Nginxåœ¨å¤„ç†phpç±»å‹çš„è¯·æ±‚æ—¶ï¼ŒæŠŠè¯·æ±‚å‘fastcgiç®¡ç†è¿›ç¨‹å¤„ç†ï¼Œfascgiç®¡ç†è¿›ç¨‹é€‰æ‹©cgiå­è¿›ç¨‹å¤„ç†ç»“æœå¹¶è¿”å›è¢«nginx,è€Œphp-fpmæ˜¯ä¸€ä¸ªPHP FastCGIç®¡ç†å™¨,nginxæœ¬èº«ä¸èƒ½å¤„ç†PHPï¼Œå®ƒåªæ˜¯ä¸ªwebæœåŠ¡å™¨ï¼Œå½“æ¥æ”¶åˆ°è¯·æ±‚åï¼Œå¦‚æœæ˜¯phpè¯·æ±‚,åˆ™å‘ç»™phpè§£é‡Šå™¨å¤„ç†ï¼Œå¹¶æŠŠç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ã€‚æ‰€ä»¥è¯´Nginxåœ¨å¤„ç†phpç±»å‹çš„è¯·æ±‚æ—¶,æœ¬è´¨ä¸Šä¹Ÿæ˜¯é€šè¿‡åå‘ä»£ç†åŠŸèƒ½å®ç°çš„ã€‚ æˆ‘ä»¬å¯ä»¥æŠŠæ€ç»´å±•å¼€ï¼Œç”¨Nginxåå‘ä»£ç†å¯ä»¥å®ç°æ›´å¤šçš„åŠŸèƒ½ï¼Œæ¯”å¦‚ä»£ç†Tomcat\n1location /Tomcat 2 { 3 proxy_pass http://127.0.0.1:8080; 4 proxy_http_version 1.1; 5 proxy_set_header X-Real-IP $remote_addr; 6 } å½“ç„¶ï¼Œä¹Ÿå¯ä»¥ç”¨Nginxåå‘ä»£ç†å®ç°è´Ÿè½½å‡è¡¡,è¿™ä¸ªæˆ‘è¿˜æ²¡æœ‰è¯•è¿‡,ç­‰ä»¥åç”¨åˆ°äº†,å†æ¥è¡¥å……\n","date":"2018-10-21T15:57:21Z","permalink":"https://lqxhub.github.io/posts/83c41ef3/","title":"nginxåå‘ä»£ç†webSocketé…ç½®"},{"content":"æœ€è¿‘æƒ³æŠ“å–æ‰‹æœºä¸Šappçš„æ•°æ®åŒ…,åœ¨ç”µè„‘ä¸ŠæŠ“åŒ…å¯é€‰çš„å·¥å…·æœ‰å¾ˆå¤š, æ¯”å¦‚wireshark,Linuxå‘½ä»¤è¡Œä¸‹æœ‰tcpdumpç­‰ç­‰å·¥å…·ã€‚å¯æ˜¯åœ¨è¿™äº›å·¥å…·åœ¨æ‰‹æœºä¸Šéƒ½æ²¡æ³•ä½¿ç”¨ï¼Œè¿™æ€ä¹ˆæ!\nåæ¥æƒ³äº†æƒ³èƒ½ä¸èƒ½ç”¨ç½‘ç»œä»£ç†æŠ“åŒ…å‘¢,è¯´å¹²å°±å¹²ã€‚ä»ç½‘ä¸ŠæŸ¥åˆ°ï¼Œç”¨fiddlerå¯ä»¥ä»£ç†æ‰‹æœºçš„ç½‘ç»œã€‚\nç¬¬ä¸€æ­¥ä¸‹è½½fiddler å»ä¸‹è½½ä¸€ä¸ªfiddlerï¼Œå»ºè®®å»å®˜ç½‘ä¸‹è½½ä¼ é€é—¨ã€‚ å‹¾é€‰åè®®,å¡«å†™é‚®ç®±,ç„¶åä¸‹è½½å°±å¯ä»¥\nç¬¬äºŒæ­¥å®‰è£…fiddler åŒå‡»ä¸‹è½½çš„.exeæ–‡ä»¶,ç„¶åé€‰æ‹©ç›®å½•,next,next,å®Œæˆå®‰è£… ##ç¬¬ä¸‰æ­¥å®‰è£…CertMakeræ’ä»¶ fiddleré»˜è®¤ç”Ÿæˆçš„è¯ä¹¦ä¸èƒ½æ»¡è¶³Androidå’ŒiOSç³»ç»Ÿçš„è¦æ±‚,éœ€è¦ä½¿ç”¨è¿™ä¸ªæ’ä»¶ ä¼ é€é—¨ å¾€ä¸‹æ‰¾,æ‰¾åˆ°å›¾ç‰‡çš„åœ°æ–¹,ç‚¹å‡»ä¸‹è½½,ä¸‹è½½å,åŒå‡»å®‰è£…\nç¬¬å››æ­¥é…ç½®fiddlerä»£ç† æƒ³è¦æŠ“HTTPSçš„æ•°æ®åŒ…,å¿…é¡»å®‰è£…è¯ä¹¦, ç‚¹å‡»tools-\u0026gt;options,ç„¶åå‡ºç°è¿™ä¸ªç•Œé¢,æŒ‰ç…§æˆ‘æ ‡æ³¨çš„1,2,3,4éƒ½å‹¾é€‰,ä¸­é—´ä¼šå‡ºç°ä¸€äº›æç¤º,éƒ½ç‚¹ yes æœ€åå‡ºç°è¿™ä¸ªå¯¹è¯æ¡†è¯´æ˜è¯ä¹¦å·²ç»å®‰è£…æˆåŠŸã€‚\nç¬¬äº”æ­¥é…ç½®ä»£ç†(æ‰‹æœºå’Œç”µè„‘åœ¨åŒä¸€ä¸ªç½‘ç»œä¸­) é‡å¯fiddlerï¼Œå¼€å§‹æ‰‹æœºçš„é…ç½®ã€‚æŸ¥çœ‹ç”µè„‘çš„IPåœ°å€,æˆ‘çš„æ˜¯192.168.31.56ç„¶åæ‰“å¼€æ‰‹æœºçš„æµè§ˆå™¨(è‹¹æœæ‰‹æœºä¸€å®šè¦ç”¨Safari),è¾“å…¥IPåœ°å€:ç«¯å£å· æˆ‘çš„æ˜¯192.168.31.56:8888 è¿™ä¸ªæ ¹æ®å…·ä½“æƒ…å†µè®¾ç½® ä¸‹è½½è¯ä¹¦,ç‚¹å‡»å…è®¸,å®‰è£…è¯ä¹¦.\né‡ç‚¹ã€é‡ç‚¹ã€é‡ç‚¹ è¿™æ—¶å€™ä¸€å®šè¦æŠŠå®‰è£…çš„è¯ä¹¦è®¾ç½®ä¸ºä¿¡ä»»çš„è¯ä¹¦ å»æ‰‹æœºçš„è®¾ç½®-\u0026gt;é€šç”¨-\u0026gt;å…³äºæœ¬æœº-\u0026gt;è¯ä¹¦æ–°äººè®¾ç½®,æŠŠåˆšæ‰å®‰è£…çš„è¯ä¹¦è®¾ç½®ä¸ºä¿¡ä»»çš„è¯ä¹¦ã€‚å†å»ç½‘ç»œè®¾ç½®ä¸­,ç»™WiFiè®¾ç½®ä»£ç†(ç”µè„‘å’Œæ‰‹æœºä¸€å®šåœ¨åŒä¸€ä¸ªç½‘ç»œä¸­) ç„¶åæ‰“å¼€æ‰‹æœºä¸Šçš„app,åœ¨fiddlerä¸­å°±å¯ä»¥çœ‹åˆ°,httpçš„æ•°æ®äº†,æ‰“å¼€ä¸€ä¸ªHTTPSçš„è¿æ¥,å¯ä»¥çœ‹åˆ°,æ•°æ®æ˜¯æ²¡æœ‰åŠ å¯†çš„ è¿™æ—¶å€™å¦‚æœæ²¡æœ‰æŠ“åˆ°æ•°æ®åŒ…,æˆ–è€…é”™è¯¯,åº”è¯¥æ˜¯è¯ä¹¦é…ç½®æœ‰é—®é¢˜,æŠŠä¹‹å‰çš„è¯ä¹¦æ¸…é™¤,æŒ‰ç…§æ­¥éª¤é‡æ–°é…ç½®ä¸€é.é‡å¯fiddler,é‡æ–°åœ¨æ‰‹æœºå®‰è£…è¯ä¹¦. æ€»ç»“ fiddlerä»£ç†å¯ä»¥æŠ“åˆ°å¤§å¤šæ•°çš„æ•°æ®åŒ…,ä½†ä¸æ˜¯æ‰€æœ‰çš„æ•°æ®åŒ…éƒ½èƒ½æŠ“åˆ°ã€‚fiddlerå¹¶ä¸æ”¯æŒå…¨éƒ¨åè®®ï¼Œç›®å‰å·²çŸ¥çš„æœ‰http2ã€tcpã€udpã€websocketç­‰ï¼Œå¦‚æœåº”ç”¨èµ°äº†ä»¥ä¸Šåè®®ï¼Œé‚£ä¹ˆfiddlerè‚¯å®šæ˜¯æŠ“ä¸åˆ°çš„ã€‚å› ä¸ºfiddleræ˜¯åŸºäº.net frameworkå®ç°çš„ï¼Œå› ä¸º.net frameworkä¸æ”¯æŒhttp2ï¼Œæ‰€ä»¥fiddleræ— æ³•æŠ“å–http2ã€‚ è¿˜æœ‰ä¸€ç§æƒ…å†µ,appä½¿ç”¨è‡ªå¸¦çš„è¯ä¹¦,æˆ‘ä»¬ç»™æ‰‹æœºå®‰è£…çš„è¯ä¹¦,appä¸ä¿¡ä»».è¿™æ ·ä¹Ÿæ˜¯æ— æ³•æŠ“åˆ°çš„ã€‚fiddleræŠ“åŒ…çš„åŸç†æ˜¯ä¸­é—´äººæ”»å‡»ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¸¤å¤´ç’ï¼Œæ¬ºéª—å®¢æˆ·ç«¯\u0026amp;\u0026amp;æ¬ºéª—æœåŠ¡å™¨ç«¯ï¼Œå¦‚æœhttpsè¯ä¹¦å†™æ­»åœ¨appé‡Œï¼Œappåªä¿¡ä»»è‡ªå·±çš„è¯ä¹¦ï¼Œfiddleræ²¡æ³•ç’å®¢æˆ·ç«¯äº†ï¼Œå› æ­¤fiddlerä¹Ÿå°±æŠ“å–ä¸åˆ°åŒ…äº†ã€‚\n","date":"2018-10-21T15:55:05Z","permalink":"https://lqxhub.github.io/posts/46c7ea4a/","title":"ä½¿ç”¨fiddleråœ¨æ‰‹æœºä¸ŠæŠ“HTTPSåŒ…"},{"content":"çœ‹åˆ°æ ‡é¢˜æ˜¯ä¸æ˜¯æœ‰ç‚¹æ‡µï¼Œåœ¨Androidæ‰‹æœºä¸Šæ­å»ºä¸€ä¸ªhttpæœåŠ¡å™¨ï¼Ÿï¼Ÿï¼Ÿ æ²¡é”™ï¼Œæˆ‘ä»¬å°±æ˜¯è¦åœ¨Androidæ‰‹æœºä¸Šæ­å»ºä¸€ä¸ªhttpæœåŠ¡å™¨ã€‚æåˆ°httpæœåŠ¡å™¨ä¸€èˆ¬ç¬¬ä¸€ååº”æ˜¯Apacheï¼Œnginx Androidä¸Šä¹Ÿèƒ½è¿è¡ŒApacheï¼Œnginxäº†ï¼Ÿï¼Ÿï¼Ÿ Androidæ‰‹æœºä¸Šå½“ç„¶ä¸èƒ½è¿è¡Œè¿™äº›æœåŠ¡å™¨äº†ï¼Œè¿™æ¬¡åœ¨Androidä¸Šè¿è¡Œçš„æ˜¯ç”¨Golangå†™çš„ä¸€ä¸ªç®€å•çš„httpæœåŠ¡å™¨ã€‚å› ä¸ºGolangå¯ä»¥è·¨å¹³å°ç¼–è¯‘ï¼Œæˆ‘å°è¯•ç€æŠŠç³»ç»Ÿé€‰æ‹©æˆLinuxï¼ŒCPUæ¶æ„é€‰æ‹©armï¼Œç„¶ååœ¨æ‰‹æœºä¸Šè¿è¡Œï¼Œç„¶åAndroidæ‰‹æœºä¸ŠçœŸçš„è¿è¡Œèµ·äº†ä¸€ä¸ªhttpæœåŠ¡å™¨! æƒŠå–œ å›åˆ°æ­£é¢˜ï¼Œè¦æƒ³å¼€å‘ç¼–å†™golangï¼Œé¦–å…ˆè¦é…ç½®å¥½golangçš„å¼€å‘ç¯å¢ƒ\næˆ‘æ˜¯åœ¨Ubuntuä¸‹å¼€å‘çš„ï¼Œæ–°å»ºservice.goæ–‡ä»¶\n1package main 2 3import ( 4 \u0026#34;net/http\u0026#34; 5 ) 6 7func main() { 8 http.HandleFunc(\u0026#34;/\u0026#34;,myResponse) 9 http.ListenAndServe(\u0026#34;127.0.0.1:8888\u0026#34;,nil) 10} 11 12func myResponse(w http.ResponseWriter,r* http.Request) { 13 w.Write([]byte(\u0026#34;\u0026lt;html\u0026gt;\u0026lt;center\u0026gt; \u0026lt;font size=\\\u0026#34;40\\\u0026#34;\u0026gt;hello I am go service\u0026lt;/font\u0026gt;\u0026lt;/center\u0026gt;\u0026lt;/html\u0026gt;\u0026#34;)) 14} ä¸ç†Ÿæ‚‰goçš„åŒå­¦æ³¨æ„ä¸‹ï¼Œä¸è¦éšæ„å›è½¦æ¢è¡Œ ä¸è¦éšæ„å›è½¦æ¢è¡Œ ä¸è¦éšæ„å›è½¦æ¢è¡Œ å› ä¸ºgoæœ‰ç‚¹åƒPythonï¼Œä¸æ˜¯ç”¨ â€œ;â€ ç»“æŸçš„ ç®€å•è§£é‡Šä¸€ä¸‹\nhttp.HandleFunc(\u0026quot;/\u0026quot;,myResponse) ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æ³¨å†ŒhttpæœåŠ¡çš„URLï¼Œè¿™é‡Œæˆ‘ä»¬å¡«å†™ \u0026quot;/\u0026quot;, åœ¨è®¿é—®çš„æ—¶å€™ç›´æ¥ localhost:8888 å°±è¡Œäº†ï¼Œå¦‚æœå¡« \u0026quot;/test\u0026quot; è®¿é—®çš„æ—¶å€™URLä¸ºlocalhost/test:8888\u0026quot;\nhttp.ListenAndServe(\u0026quot;127.0.0.1:8888\u0026quot;,nil) ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯è¦ç›‘å¬çš„ipå’Œç«¯å£ï¼Œç¬¬äºŒä¸ªå¡« nil å°±å¥½äº†\nç„¶åç¼–è¯‘è¿è¡Œè¯•è¯•ï¼Œåœ¨æœ¬æœºä¸Šè¿è¡Œçš„ç¨‹åºç”¨é»˜è®¤çš„ç¼–è¯‘å‚æ•°å°±è¡Œ go build service.go\nç„¶åè¿è¡Œ ./service åœ¨æµè§ˆå™¨ä¸­è¾“å…¥URLï¼ŒæˆåŠŸè®¿é—®åˆ° ä¸‹ä¸€æ­¥æˆ‘ä»¬æŠŠè¿™ä¸ªç¨‹åºç§»æ¤åˆ°Androidä¸Šï¼ŒAndroidæ‰‹æœºå¿…é¡»è¦æœ‰rootæƒé™ï¼Œæ‰‹æœºæ²¡æœ‰rootï¼Œè€Œåˆä¸æƒ³rootçš„åŒå­¦å¯ä»¥ç”¨æ¨¡æ‹Ÿå™¨ï¼Œåªè¦CPUçš„æŒ‡ä»¤é›†å‚æ•°æ”¹ä¸€ä¸‹å°±è¡Œï¼Œå…ˆåœ¨æ‰‹æœºä¸Šè¿è¡Œä¸€ä¸‹ï¼Œæˆ‘çš„æ‰‹æœºæ˜¯è£è€€6ï¼ŒCPUæ˜¯æµ·æ€920ï¼Œç™¾åº¦åˆ°æµ·æ€920çš„æŒ‡ä»¤é›†æ˜¯arm32çš„ï¼Œå¥½çš„ï¼Œç¼–è¯‘ä¸€ä¸ª åœ¨ç¼–è¯‘ä¹‹å‰æˆ‘ä»¬å…ˆä¿®æ”¹ä¸€ä¸‹åˆšæ‰ç¼–è¯‘çš„ç¨‹åºçš„å\næ‰§è¡Œ GOOS=\u0026quot;linux\u0026quot; GOARCH=\u0026quot;arm\u0026quot; go build service.go å¾—åˆ°ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼Œç”¨ file å‘½ä»¤çœ‹ä¸€ä¸‹ file service\n1service: ELF 32-bit LSB executable, ARM, EABI5 version 1 (SYSV), statically linked, not stripped æˆ‘ä»¬çœ‹åˆ°è¿™ä¸ªæ–‡ä»¶æ˜¯ä¸€ä¸ª32ä½çš„armç¨‹åºã€‚okï¼Œå¤åˆ¶çš„Androidæ‰‹æœºä¸Šè¯•è¯• éœ€è¦ç”¨åˆ°çš„è½¯ä»¶\nâ€œjuiceSSHâ€ æ˜¯ç”¨æ¥æ¨¡æ‹ŸLinuxçš„shellå‘½ä»¤çš„ï¼Œâ€œREæ–‡ä»¶ç®¡ç†å™¨â€ ç”¨æ¥ä¿®æ”¹æ–‡ä»¶çš„æƒé™ï¼Œåœ¨Androidä¸Šchmodå‘½ä»¤ä¸èµ·ä½œç”¨ã€‚ å…ˆå¤åˆ¶åˆ°æ ¹ç›®å½•ï¼Œç„¶åä¿®æ”¹æ–‡ä»¶çš„æƒé™\nç„¶ååœ¨juiceSSHé‡Œè¿è¡Œï¼Œç„¶åå»æµè§ˆå™¨è¾“å…¥URLçœ‹çœ‹ï¼Œ\næ²¡é—®é¢˜ æ¥ä¸‹æ¥ç¼–è¯‘ä¸€ä¸ªæ¨¡æ‹Ÿå™¨ä¸Šçš„ï¼Œæˆ‘ç”¨çš„genymotionï¼Œè¿è¡Œçš„æ˜¯Google nexus5æ‰‹æœºç³»ç»Ÿï¼Œæˆ‘ç™¾åº¦äº†ä¸€ä¸‹ï¼Œnexus5ç”¨çš„æ˜¯é«˜é€šéªé¾™800CPUï¼Œç„¶åå‘æ¥äº†ï¼Œéªé¾™800æ˜¯arm32çš„æŒ‡ä»¤é›†ï¼ŒæŒ‰ç†è¯´ç›´æ¥æŠŠé‚£ä¸ªç¨‹åºå¤åˆ¶è¿›å»å°±å¯ä»¥è¿è¡Œäº†ï¼Œä½†æ˜¯æç¤º /system/bin/sh: ./service_arm32: not executable: 32-bit ELF file\nåæ¥æƒ³äº†æƒ³CPUç”¨çš„æ˜¯ç”µè„‘ä¸Šçš„ï¼Œé‚£ç¼–è¯‘æˆ X64 çš„è¯•è¯•ã€‚è¿˜æ˜¯ä¸è¡Œï¼Œæ¢æˆ X86 çš„è¯•è¯•ã€‚ç»ˆäºæˆåŠŸäº†ã€‚åŸæ¥æ˜¯æŒ‡ä»¤è¦ç”¨ç”µè„‘CPUçš„ï¼Œå¤šå°‘ä½éœ€è¦æ¨¡æ‹Ÿå™¨çš„ã€‚\næ‰§è¡Œ GOOS=\u0026quot;linux\u0026quot; GOARCH=\u0026quot;386\u0026quot; go build service.go\nå¤åˆ¶åˆ°æ¨¡æ‹Ÿå™¨ä¸­ï¼Œç„¶åè·Ÿåœ¨æ‰‹æœºä¸€æ ·ï¼Œå¤åˆ¶åˆ°æ ¹ç›®å½•ï¼Œæ·»åŠ æƒé™ã€‚ç„¶åç”¨adb shellè¿è¡Œï¼Œç„¶ååœ¨æ¨¡æ‹Ÿå™¨çš„æµè§ˆå™¨ä¸­å‘ç°å¯ä»¥è®¿é—® å¥½äº†ï¼Œæˆ‘ä»¬å·²ç»åœ¨Androidä¸Šè¿è¡Œä¸€ä¸ªhttpæœåŠ¡å™¨äº†ï¼Œæ˜¯ä¸æ˜¯æ¯”è¾ƒç®€å•\n","date":"2018-04-08T19:48:03Z","permalink":"https://lqxhub.github.io/posts/b60bc963/","title":"Androidæ‰‹æœºä¸Šæ­å»ºä¸€ä¸ªhttpæœåŠ¡å™¨"},{"content":"å› ä¸ºæƒ³ç©Linuxï¼Œé‚è£…äº†Ubuntuå’Œwin10çš„åŒç³»ç»Ÿï¼Œå®‰è£…è¿˜å¥½ï¼Œä¸€åˆ‡é¡ºåˆ©ï¼Œä¸¤ä¸ªç³»ç»Ÿéƒ½èƒ½æ­£å¸¸å¯åŠ¨ï¼Œä½†æ˜¯æœ‰ä¸€ç‚¹è®©æˆ‘éå¸¸ä¸çˆ½ã€‚å°±æ˜¯å¯åŠ¨çš„æ—¶å€™Ubuntuæ˜¯é»˜è®¤å¯åŠ¨é¡¹ï¼Œå¼€ç”µè„‘ä¸€ä¸æ³¨æ„å°±è¿›Ubuntuäº†ã€‚é¢ï¼Œé‡å¯å§\u0026hellip;\u0026hellip;\né»˜è®¤çš„å¯åŠ¨é¡¹é¡ºåº(å›¾ç‰‡æ˜¯æˆ‘ç›—çš„ï¼Œå› ä¸ºæˆ‘çš„å·²ç»æ”¹äº†) æœ‰æ²¡æœ‰åŠæ³•èƒ½æ”¹ä¸€ä¸‹å¯åŠ¨é¡ºåºå‘¢ï¼Ÿæ–¹æ³•å½“ç„¶æœ‰äº†ã€‚å› ä¸ºç”¨çš„æ˜¯grub2å¼•å¯¼ï¼Œæ‰€ä»¥ä¸Šç½‘æŸ¥äº†è¿™æ–¹é¢çš„èµ„æ–™ï¼Œæ²¡æ‰¾åˆ°åˆé€‚çš„ï¼Œè¦ä¸å°±æ˜¯grub1çš„èµ„æ–™ï¼Œè¦ä¸å°±æ˜¯æ²»æ ‡ä¸æ²»æœ¬ã€‚æ‰€ä»¥æœ¬ç€å¤§ä¸äº†é‡è£…ç³»ç»Ÿçš„å¿ƒæ€ï¼Œè‡ªå·±æ£é¼“\nç¬¬ä¸€ç§æ–¹æ³•ï¼Œåªæ›´æ”¹é»˜è®¤é€‰é¡¹ é¦–å…ˆè¿›å…¥ /etc/default ç›®å½•ï¼Œæ‰§è¡Œsudo vim grub æ­£å¸¸çš„è¯ä½ çœ‹åˆ°çš„æ˜¯è¿™ä¸ª 1 6 GRUB_DEFAULT=\u0026#34;0\u0026#34; 2 7 #GRUB_HIDDEN_TIMEOUT=\u0026#34;0\u0026#34; 3 8 GRUB_HIDDEN_TIMEOUT_QUIET=\u0026#34;true\u0026#34; 4 9 GRUB_TIMEOUT=\u0026#34;10\u0026#34; 5 10 GRUB_DISTRIBUTOR=\u0026#34;`lsb_release -i -s 2\u0026gt; /dev/null || echo Debian`\u0026#34; 6 11 GRUB_CMDLINE_LINUX_DEFAULT=\u0026#34;quiet splash\u0026#34; 7 12 GRUB_CMDLINE_LINUX=\u0026#34;\u0026#34; è¿™æ˜¯æˆ‘ä»¬å…³æ³¨çš„å†…å®¹ï¼Œåªéœ€è¦æŠŠç¬¬6è¡Œçš„GRUB_DEFAULT=\u0026quot;0\u0026quot;æ”¹æˆä½ æƒ³è¦é»˜è®¤é€‰ä¸­çš„åºå·å‡å»1å°±è¡Œï¼Œæ¯”å¦‚ç¬¬ä¸€å¼ å›¾ä¸­ï¼Œæƒ³è¦é»˜è®¤é€‰ä¸­Windows boot mangerï¼Œä¿®æ”¹GRUB_DEFAULT=\u0026quot;2\u0026quot;ä¿å­˜ï¼Œé€€å‡º ç„¶åæ‰§è¡Œå…³é”®çš„ä¸€æ­¥sudo update-grub è¿™æ ·ï¼Œä¸‹æ¬¡å¼€æœºçš„æ—¶å€™é»˜è®¤é€‰ä¸­çš„å¯åŠ¨é¡¹å°±æ˜¯Windowsäº†ã€‚\nè¿™æ ·çš„æ“ä½œå¯¹äºæˆ‘è¿™ç§å¼ºè¿«ç—‡æ™šæœŸçš„äººæ¥è¯´æ˜¯ç»å¯¹ä¸èƒ½å¿çš„ã€‚å¿…é¡»æŠŠWindows boot manger æ”¾åˆ°ç¬¬ä¸€ä½ï¼Œä¸‹é¢å°±æ˜¯ç¬¬äºŒç§æ–¹æ³•\nç¬¬äºŒç§æ–¹æ³•ï¼Œå½»åº•è§£å†³ é¦–å…ˆè¿›å…¥*/boot/grubç›®å½•ï¼Œå…ˆæŠŠgrub.cfgæ–‡ä»¶å¤åˆ¶ä¸€ä»½å‡ºæ¥ï¼Œä»¥å…æåäº†æ²¡æ³•æ¢å¤ã€‚ç„¶åæŸ¥çœ‹ grub.cfgæ–‡ä»¶çš„è¯»å†™æƒé™ï¼Œé»˜è®¤æ˜¯åªè¯»çš„ã€‚å…ˆç»™grub.cfgæ–‡ä»¶åŠ ä¸Šå¯å†™çš„æƒé™ã€‚ æ‰§è¡Œsudo chmod u+w grub.cfg è¿™æ ·èƒ½ä¿®æ”¹è¿™ä¸ªæ–‡ä»¶äº†ã€‚ ç„¶åsudo vim grub.cfgæ‰“å¼€è¿™ä¸ªæ–‡ä»¶ã€‚ç„¶åä½ ä¼šå‘ç°è¿™ä¸ªæ–‡ä»¶æœ‰300å¤šè¡Œï¼Œè¿™æ€ä¹ˆä¿®æ”¹ï¼Œä¸è¦æ…Œåœ¨vimé‡Œæœç´¢menuentry* (æœç´¢menuentryçš„å‘½ä»¤æ˜¯â€œ/menuentryâ€) æˆ‘çš„åœ¨134è¡Œã€‚ä¸Šå›¾ è¿™æ—¶å€™å†å¾€ä¸‹æ‰¾ç›´åˆ°æ‰¾åˆ°\n1276 menuentry \u0026#39;Windows Boot Manager (on /dev/sda1)\u0026#39; --class windows --class os $menuentry_id_option \u0026#39;osprober-efi-78EE-BE29\u0026#39; { 2277 insmod part_gpt 3278 insmod fat 4279 set root=\u0026#39;hd0,gpt1\u0026#39; 5280 if [ x$feature_platform_search_hint = xy ]; then 6281 search --no-floppy --fs-uuid --set=root --hint-bios=hd0,gpt1 --hint-efi=hd0,gpt1 --hint-baremetal=ahci0,gpt1 78EE-BE29 7282 else 8283 search --no-floppy --fs-uuid --set=root 78EE-BE29 9284 fi 10285 chainloader /EFI/Microsoft/Boot/bootmgfw.efi 11286 } 12287 set timeout_style=menu 13288 if [ \u0026#34;${timeout}\u0026#34; = 0 ]; then 14289 set timeout=10 15290 fi ç„¶åæŠŠè¿™ä¸€æ®µå‰ªåˆ‡ï¼Œæ”¾åˆ°åˆšæ‰134é‚£ä¸ªmenuentryå‰è¾¹ã€‚è¿™æ—¶ä¿å­˜ï¼Œé€€å‡ºã€‚ OKï¼Œå®Œæˆäº†ï¼Œä¸‹æ¬¡å¼€æœºå°±ä¼šå‘ç°Windows boot manger æˆä¸ºç¬¬ä¸€å¯åŠ¨é¡¹äº†\nè¿™é‡Œåƒä¸‡ä¸è¦ åƒä¸‡ä¸è¦ åƒä¸‡ä¸è¦ æ‰§è¡Œsudo update-grub\nä¸‹æ¬¡å¼€æœºå°±æ˜¯è¿™æ ·äº† ","date":"2018-03-25T12:39:52Z","permalink":"https://lqxhub.github.io/posts/fcd83655/","title":"ä¿®æ”¹Ubuntuå’Œwin10åŒç³»ç»Ÿå¯åŠ¨é¡ºåº"},{"content":"æŒ‡é’ˆæ— ç–‘æ˜¯C/C++è¯­è¨€çš„ç²¾é«“æ‰€åœ¨ï¼Œç”¨å¥½äº†æ˜¯æŠŠåˆ©å‰‘ï¼Œç”¨ä¸å¥½å°±æ˜¯ä¸€é¢—ç‚¸å¼¹ã€‚æŒ‡é’ˆå‡ºBUGäº†ï¼Œåˆ†åˆ†é’Ÿä¼šè®©ä½ å†™ç¨‹åºå´©æºƒ ä»Šå¤©è¢«C++çš„æŒ‡é’ˆææ··äº†ï¼Œç¿»é˜…äº†å¾ˆå¤šèµ„æ–™ï¼Œæœ‰ç‚¹æ‡‚äº†ã€‚èµ¶å¿«æ¥åšä¸€ä¸‹ç¬”è®°ã€‚\nå…ˆæ¥ä½¿ç”¨ä¸€ä¸ªæœ€ç®€å•çš„æŒ‡é’ˆ\n1\tint a = 10; 2\tint *p=\u0026amp;a; è¿™ä¸ªæ²¡å•¥éš¾åº¦ä¸ä¼šå‡ºé”™ï¼Œæ¥ä¸‹æ¥æ¥ä¸ªéš¾ç‚¹çš„\n1\tint a = 10; 2\tint *p = \u0026amp;a; 3\tint **p1 = \u0026amp;p; è¿™ä¸ªæŒ‡é’ˆçš„æŒ‡é’ˆæ˜¯ä¸æ˜¯å·²ç»å¤´çš®å‘éº»äº†ï¼Œåˆ«æ€¥ï¼Œè¿˜æœ‰æ›´å˜æ€çš„â€”â€”æŒ‡é’ˆæ•°ç»„ï¼Œæ•°ç»„æŒ‡é’ˆï¼Œå‡½æ•°æŒ‡é’ˆï¼ŒæŒ‡é’ˆå‡½æ•°ã€‚è¿™å›æ˜¯ä¸æ˜¯å½»åº•æ‡µäº†ã€‚ ç°åœ¨å°±å¼€å§‹ä¸€ä¸ªä¸ªä½¿ç”¨è¿™äº›æŒ‡é’ˆ é¦–å…ˆè¦æ˜ç¡®ä¸€ç‚¹ï¼ŒæŒ‡é’ˆæ•°ç»„å’Œæ•°ç»„æŒ‡é’ˆä¸æ˜¯ä¸€ä¸ªæ¦‚å¿µ\nint *p3[10]; è¿™å°±å®šä¹‰äº†ä¸€ä¸ªæŒ‡é’ˆæ•°ç»„ï¼Œ [] ä¼˜å…ˆçº§é«˜ï¼Œå…ˆä¸pç»“åˆæˆä¸ºä¸€ä¸ªæ•°ç»„ï¼Œå†ç”±int*è¯´æ˜è¿™æ˜¯ä¸€ä¸ªæ•´å‹æŒ‡é’ˆæ•°ç»„ï¼Œå®ƒæœ‰10ä¸ªæŒ‡é’ˆç±»å‹çš„æ•°ç»„å…ƒç´ \nint (*p4)[10]; è¿™æ˜¯ä¸€ä¸ªæ•°ç»„æŒ‡é’ˆï¼Œå› ä¸º()ä¼˜å…ˆçº§é«˜ï¼Œé¦–å…ˆè¯´æ˜pæ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘ä¸€ä¸ªæ•´å‹çš„ä¸€ç»´æ•°ç»„ï¼Œè¿™ä¸ªä¸€ç»´æ•°ç»„çš„é•¿åº¦æ˜¯10\nint* fun(int a); è¿™æ ·å°±å£°æ˜äº†ä¸€ ä¸ªæŒ‡é’ˆå‡½æ•°ï¼Œå°±æ˜¯è¿”å›æŒ‡é’ˆçš„å‡½æ•°ï¼Œå‡½æ•°å¯ä»¥ä¸è¿”å›ä»»ä½•å€¼ï¼Œä¹Ÿå¯ä»¥è¿”å›æ•´å‹å€¼ï¼Œå®å‹å€¼ï¼Œå­—ç¬¦å‹å€¼ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥è¿”å›æŒ‡é’ˆå€¼ã€‚å‡½æ•°funéœ€è¦åœ¨å‡½æ•°ä½“ä¸­è¿”å›ä¸€ä¸ªintå‹çš„æŒ‡é’ˆã€‚\nint (*fun)(int a); è¿™æ ·å°±å®šä¹‰äº†ä¸€ä¸ªæŒ‡å‘å‡½æ•°çš„æŒ‡é’ˆï¼Œå¯ä»¥é€šè¿‡è¿™ä¸ªæŒ‡é’ˆæ¥è°ƒç”¨å‡½æ•°ï¼Œæ³¨æ„ï¼Œè¿™ä¸ªæŒ‡é’ˆä¸èƒ½æŒ‡å‘ä»»æ„çš„å‡½æ•°ï¼Œåªèƒ½æŒ‡å‘è¿”å›å€¼æ˜¯intï¼Œå¹¶ä¸”åªæœ‰ä¸€ä¸ªå½¢å‚çš„å‡½æ•°ã€‚ è¿™äº›éƒ½æ˜¯Cä¸­æŒ‡é’ˆçš„ä½¿ç”¨ï¼Œåˆ°äº†C++ä¸­ï¼ŒæŒ‡é’ˆé‡åˆ°ç±»å’Œå¯¹è±¡ï¼Œé‡åˆ°newå’Œdeleteè¿™ä¸¤ä¸ªè¿ç®—ç¬¦ï¼Œç¨æœ‰ä¸æ…å°±ä¼šå†…å­˜æ³„æ¼ã€‚ è¯´äº†è¿™ä¹ˆå¤šï¼Œç°åœ¨å¼€å§‹ç ”ç©¶C++ä¸­æŒ‡é’ˆçš„ä½¿ç”¨é—®é¢˜ å…ˆæ¥æ–°å»ºä¸€ä¸ªTestç±» Test.h\n1#pragma once 2class Test 3{ 4public: 5\tTest(); 6\tTest(int _a); 7\t~Test(); 8\tint a; 9}; Test.cpp\n1#include \u0026#34;stdafx.h\u0026#34; 2#include \u0026#34;Test.h\u0026#34; 3#include \u0026lt;iostream\u0026gt; 4using std::cout; 5using std::endl; 6 7 8Test::Test():Test(0)//å§”æ‰˜æ„é€ å‡½æ•° 9{ 10\tcout \u0026lt;\u0026lt; \u0026#34;è°ƒç”¨å§”æ‰˜æ„é€ å‡½æ•°ç»™aèµ‹å€¼ 0\u0026#34;\u0026lt;\u0026lt;endl; 11} 12 13Test::Test(int _a=10):a(_a)//æ„é€ åˆå§‹åŒ–,å½¢å‚é»˜è®¤å€¼=10 14{ 15\tcout \u0026lt;\u0026lt; \u0026#34;call function Test(int _a) \u0026#34;\u0026lt;\u0026lt;endl; 16} 17 18 19Test::~Test() 20{ 21\tcout \u0026lt;\u0026lt; \u0026#34;delete Test \u0026#34; \u0026lt;\u0026lt; a \u0026lt;\u0026lt; endl; 22} main.cpp\n1// main.cpp: å®šä¹‰æ§åˆ¶å°åº”ç”¨ç¨‹åºçš„å…¥å£ç‚¹ã€‚ 2// 3 4#include \u0026#34;stdafx.h\u0026#34; 5#include \u0026#34;Test.h\u0026#34; 6#include \u0026lt;stdlib.h\u0026gt; 7 8int main() 9{ 10\t/*1 11\tåˆ›å»ºTestçš„å®ä¾‹ï¼ŒæŒ‡é’ˆt1æŒ‡å‘å®ä¾‹*/ 12\tTest *t1 = new Test(6); 13 14\tdelete t1; 15\tt1 = nullptr; 16 17 18\t/*2 19\tåˆ›å»º3ä¸ªtestå®ä¾‹æ•°ç»„ æŒ‡é’ˆt2æŒ‡å‘æ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ , 20\tæ­¤æ—¶åªèƒ½è°ƒç”¨Testç±»çš„æ— å‚æ„é€ å‡½æ•°*/ 21\tTest *t2 = new Test[3]; 22 23\tdelete[] t2;//é‡Šæ”¾ testçš„ä¸‰ä¸ªå®ä¾‹ 24\tt2 = nullptr; 25 26\t/*3 27\tåœ¨å †ä¸­åˆ›å»º3ä¸ªï¼ˆTestï¼‰ç±»å‹çš„æŒ‡é’ˆæ•°ç»„ï¼Œt3æŒ‡å‘è¿™ä¸ªæ•°ç»„ï¼›*/ 28\tTest* *t3 = new Test*[3]; 29\tfor (int i = 0; i \u0026lt; 3; i++) 30\t{ 31\t/*åˆ›å»º3ä¸ªTestçš„å®ä¾‹ï¼Œè®©t3æ•°ç»„ä¸­çš„å…ƒç´ ï¼ˆæŒ‡é’ˆï¼‰æŒ‡å‘åˆ›å»ºçš„å¯¹è±¡*/ 32\tt3[i] = new Test(i + 10); 33\t} 34 35\tfor (int i = 0; i \u0026lt; 3; i++) 36\t{ 37\t/*é‡Šæ”¾ åœ¨å †ä¸­åˆ›å»ºçš„ä¸‰ä¸ªTestçš„å®ä¾‹*/ 38\tdelete t3[i]; 39\t} 40 41\tdelete[] t3;//é‡Šæ”¾åŠ¨æ€åˆ›å»ºçš„æŒ‡å‘Testå®ä¾‹çš„æŒ‡é’ˆæ•°ç»„ 42 43 44\tsystem(\u0026#34;pause\u0026#34;); 45\treturn 0; 46} å…ˆæ¥å¼€ä¸€ä¸‹æœ€ç®€å•çš„ä¸€ç§å¯¹è±¡æŒ‡é’ˆTest *t1 = new Test(6); è¿™æ—¶å®šä¹‰äº†ä¸€ä¸ªTestç±»å‹çš„æŒ‡é’ˆt1ï¼Œå¹¶è®©è¿™ä¸ªæŒ‡é’ˆæŒ‡å‘ä»å †ä¸­ç”³è¯·çš„å†…å­˜ï¼ˆTestçš„å®ä¾‹ï¼‰è¿è¡Œä»¥ä¸‹çœ‹çœ‹\næ²¡æ„å¤–ï¼ŒTestçš„å®ä¾‹æ­£å¸¸åˆ›å»ºï¼Œæ­£å¸¸é‡Šæ”¾äº†ã€‚ å†æ¥çœ‹ä¸€ä¸‹ç¬¬äºŒç§æƒ…å†µ\n1Test *t2 = new Test[3]; 2 3delete[] t2; ç°åœ¨å®šä¹‰äº†ä¸€ä¸ªTestçš„æŒ‡é’ˆt2ï¼Œå¹¶ä¸”åœ¨å †ä¸­åˆ›å»ºäº†3ä¸ªTestçš„å®ä¾‹ï¼Œæ”¾åœ¨ä¸€ä¸ªæ•°ç»„ä¸­ï¼ŒæŒ‡é’ˆt2æŒ‡å‘äº†è¿™ä¸ªæ•°ç»„ã€‚è¿è¡Œçœ‹ä¸€ä¸‹ è¿™æ—¶æœ‰ä¸€ç‚¹è¦æ³¨æ„ä¸€ä¸‹ï¼Œè¿™æ ·newåˆ›å»ºå¯¹è±¡æ—¶åªèƒ½è°ƒç”¨Testç±»çš„é»˜è®¤æ— å‚æ„é€ å‡½æ•°ï¼Œå…¶ä»–çš„å‡½æ•°ä¸èƒ½è°ƒç”¨ã€‚æˆ‘ä»¬ä¸ºäº†ç»™aèµ‹å€¼ï¼Œä½¿ç”¨äº†å§”æ‰˜æ„é€ å‡½æ•°ï¼ˆä¸å¤ªç†Ÿæ‚‰çš„åŒå­¦å¯ä»¥å¿½ç•¥ï¼‰ï¼Œä»æ‰“å°çš„ç»“æœæ¥çœ‹ï¼Œç¨‹åºæ­£å¸¸åˆ›å»ºäº†Testçš„å®ä¾‹ï¼Œä¹Ÿæ­£å¸¸é‡Šæ”¾å†…å­˜ã€‚ ç°åœ¨æ¥çœ‹ä¸€ä¸‹æœ€å¤æ‚çš„ä¸€ç§æƒ…å†µ\n1/*3 2åœ¨å †ä¸­åˆ›å»º3ä¸ªï¼ˆTestï¼‰ç±»å‹çš„æŒ‡é’ˆæ•°ç»„ï¼Œt3æŒ‡å‘è¿™ä¸ªæ•°ç»„ï¼›*/ 3Test* *t3 = new Test*[3]; 4\tfor (int i = 0; i \u0026lt; 3; i++) 5\t{ 6\t/*åˆ›å»º3ä¸ªTestçš„å®ä¾‹ï¼Œè®©t3æ•°ç»„ä¸­çš„å…ƒç´ ï¼ˆæŒ‡é’ˆï¼‰æŒ‡å‘åˆ›å»ºçš„å¯¹è±¡*/ 7\tt3[i] = new Test(i + 10); 8\t} 9 10\tfor (int i = 0; i \u0026lt; 3; i++) 11\t{ 12\t/*é‡Šæ”¾ åœ¨å †ä¸­åˆ›å»ºçš„ä¸‰ä¸ªTestçš„å®ä¾‹*/ 13\tdelete t3[i]; 14\t} 15 16\tdelete[] t3; æ˜¯ä¸æ˜¯å·²ç»æ™•å€’åœ¨ç”µè„‘å‰äº†0.0 è«æ…Œ,å…ˆçœ‹ä¸€ä¸‹è¿è¡Œç»“æœ ä¸€æ­¥æ­¥æ¥åˆ†æä»¥ä¸‹ä»£ç ï¼Œé¦–å…ˆçœ‹ä¸€ä¸‹Test* *t3 = new Test*[3];t3æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œå®ƒæŒ‡å‘äº†å †ä¸­çš„ä¸€ä¸ªæ•°ç»„ï¼Œè¿™ä¸ªæ•°ç»„çš„ç±»å‹æ˜¯Test*çš„ã€‚ new Test*[3]åœ¨å †å†…å­˜ä¸­åˆ›å»ºäº†ä¸€ä¸ªé•¿åº¦ä¸º3çš„Test*çš„æ•°ç»„ã€‚é‡ç‚¹t3æŒ‡å‘çš„æ˜¯å †ä¸­çš„ä¸€ä¸ªæ•°ç»„ ç¬¬ä¸€ä¸ªforå¾ªç¯ä¸­çš„t3[i] = new Test(i + 10);æ˜¯ç»™t3æ‰€æŒ‡å‘çš„æ•°ç»„ä¸­çš„å…ƒç´ èµ‹å€¼ï¼Œå› ä¸ºæ•°ç»„æ˜¯Test*ç±»å‹çš„ï¼Œæ‰€ä»¥å¯ä»¥æŒ‡å‘Testç±»çš„å®ä¾‹ã€‚ ç¬¬äºŒä¸ªforå¾ªç¯ä¸­delete t3[i];æ˜¯æŠŠåœ¨å †å†…å­˜ä¸­åˆ›å»ºçš„Test ç±»çš„å®ä¾‹é‡Šæ”¾ã€‚å› ä¸ºt3[i]æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œè€Œä¸”æ˜¯æŒ‡é’ˆæ•°ç»„ï¼Œä¹Ÿå°±æ˜¯è¯´t3[i]ï¼Œæ˜¯t3æŒ‡é’ˆæŒ‡å‘çš„æ•°ç»„ï¼ˆåœ¨å †å†…å­˜ä¸­ï¼‰çš„ä¸€ä¸ªå…ƒç´ ï¼Œæ‰€ä»¥è¦æŠŠt3æŒ‡å‘çš„æ•°ç»„é‡Šæ”¾delete[] t3;\nå¥½äº†å…ˆæ€»ç»“åˆ°è¿™å§ã€‚é¡¹ç›®æˆ‘å·²ç»ä¸Šä¼ åˆ°ç äº‘ï¼Œéœ€è¦çš„å¯ä»¥ä¸‹è½½ã€‚\n","date":"2017-11-09T17:10:42Z","permalink":"https://lqxhub.github.io/posts/4835beb2/","title":"èŠ±å¼ä½¿ç”¨C/C++çš„æŒ‡é’ˆ"},{"content":"å·¥æ¬²å–„å…¶äº‹ï¼Œå¿…å…ˆåˆ©å…¶å™¨ã€‚è¦æƒ³è¿›è¡ŒAndroid NDKå¼€å‘é¦–å…ˆæˆ‘ä»¬è½½NDKçš„å¼€å‘åŒ…ï¼Œé…ç½®NDKå¼€å‘ç¯å¢ƒï¼Œå°±åƒé…ç½®SDKå·®ä¸å¤šã€‚é…ç½®NDKç¯å¢ƒçš„æ–¹æ³•æœ‰å¾ˆå¤šï¼Œå¯ä»¥å»å®˜ç½‘ä¸‹è½½ï¼Œä¹Ÿå¯ä»¥ç”¨SDK mangerä¸‹è½½å®‰è£…ï¼Œè¿˜å¯ä»¥ç”¨Androidstudioçš„SDKç®¡ç†ä¸‹è½½ã€‚\nä¸‹å›¾æ˜¯åœ¨ASä¸‹å®‰è£…NDK çº¢è‰²æ ‡è®°çš„é€‰é¡¹ï¼Œå¯èƒ½æ’åˆ—çš„é¡ºåºä¸åŒï¼Œæ‰¾åˆ°ç„¶åå‹¾é€‰ï¼Œç‚¹å‡»OKï¼Œç­‰å¾…ä¸‹è½½å®Œæˆã€‚è¯´ä¸€ä¸‹è¿™ä¸‰ä¸ªå·¥å…·æ˜¯å¹²å•¥çš„å§ã€‚\nCMakeæ˜¯ä¸€ä¸ªè·¨å¹³å°çš„ç¼–è¯‘å·¥å…·ï¼Œå¯ä»¥ç”¨ç®€å•çš„è¯­å¥æ¥æè¿°æ‰€æœ‰å¹³å°çš„ç¼–è¯‘è¿‡ç¨‹ã€‚ LLDBæ˜¯ç”¨æ¥è°ƒè¯•C++ä»£ç çš„å·¥å…· NDk ä¸ç”¨å¤šè¯´äº†ï¼Œç”¨æ¥ç¼–è¯‘å’Œæ‰“åŒ…C++çš„ä¸€æ•´å¥—å·¥å…· è¿™é‡Œè¦è¯´ä¸€ä¸ªå‘ï¼ŒASçš„ä¸‹è½½æ˜¯ä¸æ”¯æŒæ–­ç‚¹çš„ï¼Œä¸€å®šè¦åœ¨è‰¯å¥½çš„ç½‘ç»œç¯å¢ƒä¸‹è½½ï¼Œè¦ä¸ç„¶ã€‚ã€‚ã€‚ã€‚è¯´å¤šäº†éƒ½æ˜¯æ³ªï¼Œè®©æ ¡å›­ç½‘å®³è‹¦äº†ï¼Œæœ€åç”¨ä¸‹è½½å·¥å…·ä¸‹è½½çš„å‹ç¼©åŒ…ã€‚ç½‘ç»œä¸å¥½çš„æƒ…å†µä¸‹å¯ä»¥æŠŠä¸‹è½½é“¾æ¥æå–å‡ºæ¥ï¼Œç”¨ä¸‹è½½å·¥å…·ä¸‹è½½ï¼Œè¿™æ ·å°±ä¸æ€•æ–­ç½‘äº†ã€‚ ASä¸‹è½½å®Œæˆä¼šè‡ªåŠ¨è§£å‹ï¼Œè‡ªå·±ä¸‹è½½çš„è¦è§£å‹åˆ°SDKçš„ç›®å½•ä¸‹ï¼Œæ–°å»ºndk-bundleæ–‡ä»¶å¤¹ã€‚åªè¦settingä¸­çš„SDKToolsä¸‹è¿™ä¸‰é¡¹æ‰“é’©äº†å°±è¯´æ˜ç¯å¢ƒæ­å»ºæˆåŠŸäº†ã€‚\nLinux NDKå‹ç¼©åŒ…ä¸‹è½½åœ°å€ https://dl.google.com/android/repository/android-ndk-r15c-linux-x86_64.zip\næˆ‘ç”¨çš„æ˜¯Ubuntuç³»ç»Ÿï¼Œæ²¡æ‰¾åˆ°SDK mangerï¼Œå°±ä¸ä»‹ç»äº†ï¼Œæˆ‘è®°å¾—Windowsé‡Œæœ‰è¿™ä¸ªä¸œè¥¿ï¼Œç•Œé¢å’Œasé‡Œå·®ä¸å¤šï¼Œå¤§åŒå°å¼‚ã€‚ è¿˜æœ‰å°±æ˜¯å»å®˜ç½‘ä¸‹è½½ï¼Œé€‰æ‹©é€‚åˆè‡ªå·±ç³»ç»Ÿçš„ç‰ˆæœ¬ä¸‹è½½ï¼Œç„¶åè§£å‹åˆ°æŒ‡å®šç›®å½•å°±è¡Œäº† ç½‘é€Ÿå¥½çš„è¯è¿˜æ˜¯æ¨èä½¿ç”¨ASå»å®‰è£…NDKï¼Œæ¯•ç«Ÿç®€å•ï¼Œä¸‹è½½å®Œæˆä¼šè‡ªå·±è§£å‹åˆ°æŒ‡å®šç›®å½•ã€‚è‡ªå·±ä¸‹è½½å‹ç¼©åŒ…å¦‚æœæ²¡æœ‰è§£å‹åˆ°æŒ‡å®šç›®å½•æ˜¯æ— æ³•ä½¿ç”¨çš„ã€‚ ç­‰ä¸€åˆ‡éƒ½å¼„å¥½ä»¥åï¼Œæ‰“å¼€ç•Œé¢çœ‹åˆ°CMakeï¼ŒLLDB ï¼ŒNDKéƒ½å‹¾é€‰äº†å°±è¯´æ˜é…ç½®æˆåŠŸäº†ã€‚ è¿˜æœ‰å°±æ˜¯CMakeï¼ŒLLDB åªèƒ½é€šè¿‡ASä¸‹è½½ï¼Œåˆ«çš„è¿˜æ²¡æ‰¾åˆ°ï¼Œè¿™ä¸¤ä¸ªæ¯”è¾ƒå°ï¼Œå¾ˆå¿«å°±ä¸‹å®Œäº†ã€‚\nåˆ°æ­¤ç¯å¢ƒæ­å»ºå°±ç®—å®Œæˆäº†ã€‚\n","date":"2017-09-10T19:03:48Z","permalink":"https://lqxhub.github.io/posts/ddb43708/","title":"Android NDKå¼€å‘ä¹‹ç¯å¢ƒæ­å»º"},{"content":"è¿™ä¸¤å¤©åœ¨Androidä¸­ç”¨åˆ°äº†è‡ªå®šä¹‰viewï¼Œåœ¨è‡ªå®šä¹‰viewæ—¶ä¹Ÿé¡ºä¾¿ä½¿ç”¨äº†ä¸‹è‡ªå®šä¹‰å±æ€§ã€‚è‡ªå®šä¹‰å±æ€§ä»¥å‰åªæ˜¯è€³é—» æœªæ›¾è°‹é¢ï¼Œè¿™æ¬¡å€Ÿæœºä¼šå¯¹è‡ªå®šä¹‰å±æ€§è¿›è¡Œäº†ä¸€ç•ªå­¦ä¹ ï¼Œé¡ºä¾¿æ€»ç»“äº†ä¸€ä¸‹è‡ªå®šä¹‰å±æ€§çš„ä½¿ç”¨ã€‚ ä¸‹é¢æ‰«ç›²ç­è€å¸æœºè¦å¼€è½¦äº†ï¼Œå°ç™½å¿«åˆ·å¡ä¸Šè½¦ï¼Œå¤§ç¥æ‹’è½½ã€‚\nAndroidä¸­ç»å¸¸ç”¨åˆ°è‡ªå®šä¹‰viewï¼Œæ—¢ç„¶ç”¨äº†è‡ªå®šä¹‰viewé‚£å°±ä¸å¾—ä¸æè‡ªå®šä¹‰å±æ€§ã€‚ä½ æ˜¯å¦æ€è€ƒè¿‡ä¸ºä»€ä¹ˆæˆ‘ä»¬åœ¨xmlæ–‡ä»¶ä¸­è¿›è¡Œå¸ƒå±€æ—¶å¯ä»¥ç›´æ¥é€šè¿‡android:layout_width=\u0026quot;match_parent\u0026quot;å°±å¯ä»¥è®¾ç½®æ§ä»¶çš„å®½åº¦å‘¢ï¼Ÿä¸åªæ˜¯å®½åº¦ï¼Œå‡ ä¹æ§ä»¶çš„æ‰€æœ‰å±æ€§éƒ½å¯ä»¥åœ¨xmlæ–‡ä»¶ä¸­è¿›è¡Œè®¾ç½®ï¼Œè¿™æ˜¯æ€æ ·å®ç°çš„å‘¢ï¼Œthis is a question æˆ‘ä»¬è‡ªå®šä¹‰viewæ—¶èƒ½ä¸èƒ½ä¹Ÿåƒç³»ç»Ÿæä¾›çš„æ§ä»¶ä¸€æ ·åœ¨xmlæ–‡ä»¶ä¸­è®¾ç½®å±æ€§å‘¢ã€‚ç­”æ¡ˆæ˜¯å½“ç„¶å¯ä»¥äº†ï¼Œç”¨åˆ°çš„å°±æ˜¯ä»Šå¤©è¦è¯´çš„è‡ªå®šä¹‰å±æ€§ã€‚åºŸè¯ä¸å¤šè¯´ ç›´æ¥å¼€å¹²ã€‚ 1ï¼Œé¦–å…ˆåœ¨res çš„valuesæ–‡ä»¶å¤¹ä¸‹æ–°å»ºä¸€ä¸ªattrs.xmlæ–‡ä»¶ï¼Œå°±æ˜¯è¿™æ · 2ï¼Œå¼€å§‹ç¼–å†™æˆ‘ä»¬éœ€è¦çš„å±æ€§ã€‚\n1\u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;utf-8\u0026#34;?\u0026gt; 2\u0026lt;resources\u0026gt; 3 \u0026lt;declare-styleable name=\u0026#34;burce\u0026#34;\u0026gt; 4 \u0026lt;attr name=\u0026#34;mHeight\u0026#34; format=\u0026#34;integer\u0026#34;/\u0026gt; 5 \u0026lt;attr name=\u0026#34;mWidth\u0026#34; format=\u0026#34;integer\u0026#34;/\u0026gt; 6 \u0026lt;attr name=\u0026#34;mName\u0026#34; format=\u0026#34;string\u0026#34;/\u0026gt; 7 \u0026lt;attr name=\u0026#34;sex\u0026#34; format=\u0026#34;enum\u0026#34;\u0026gt; 8 \u0026lt;enum name=\u0026#34;man\u0026#34; value=\u0026#34;0\u0026#34;/\u0026gt; 9 \u0026lt;enum name=\u0026#34;woman\u0026#34; value=\u0026#34;1\u0026#34;/\u0026gt; 10 \u0026lt;/attr\u0026gt; 11 \u0026lt;attr name=\u0026#34;student\u0026#34; format=\u0026#34;boolean\u0026#34;/\u0026gt; 12 \u0026lt;/declare-styleable\u0026gt; 13\u0026lt;/resources\u0026gt; è¯´ä¸€ä¸‹ç”¨åˆ°çš„ä¸œè¥¿ \u0026lt;declare-styleable name=\u0026quot;burce\u0026quot;\u0026gt;å…¶ä¸­çš„nameçš„å€¼éšä¾¿å®šä¹‰ä¸€ä¸ªï¼Œä¸è¦ä¸ç³»ç»Ÿçš„èµ·å†²çªã€‚ \u0026lt;attr name=\u0026quot;mHeight\u0026quot; format=\u0026quot;integer\u0026quot;/\u0026gt;nameå°±æ˜¯è‡ªå®šä¹‰çš„å±æ€§çš„åå­—ï¼ˆæ¯”å¦‚ç³»ç»Ÿæ§ä»¶çš„android:layout_widthï¼‰ format å°±æ˜¯å±æ€§çš„ç±»å‹ï¼Œè¿™é‡Œæ”¯æŒ10ç§ç±»å‹ï¼Œå¸¸ç”¨çš„æœ‰stringï¼Œintegerï¼Œbooleanç­‰ç­‰ï¼Œè¿™æ¬¡æˆ‘ä»¬ç”¨åˆ°äº†æ•´å½¢ï¼Œæšä¸¾å’Œå¸ƒå°” æ³¨æ„ï¼šæˆ‘ä»¬åœ¨è‡ªå®šä¹‰å±æ€§çš„åå­—çš„æ—¶å€™ä¸èƒ½ä¸ç³»ç»Ÿçš„åå­—å†²çªï¼Œå¦åˆ™ä¼šæŠ¥é”™\n3ï¼Œæ–°å»ºä¸€ä¸ªç±»ç»§æ‰¿Viewç±»ï¼Œå®ç°3ä¸ªæ„é€ æ–¹æ³•ï¼Œç„¶åè·å–æˆ‘ä»¬è‡ªå®šä¹‰çš„å±æ€§\n1public class MyView extends View { 2 private static final String TAG = \u0026#34;MyView\u0026#34;; 3 private int heiget; 4 private int width; 5 private String name; 6 private int sex; 7 private boolean student; 8 public MyView(Context context) { 9 this(context,null); 10 } 11 12 public MyView(Context context, AttributeSet attrs) { 13 this(context, attrs,0); 14 } 15 16 public MyView(Context context, AttributeSet attrs, int defStyleAttr) { 17 super(context, attrs, defStyleAttr); 18 TypedArray array=context.obtainStyledAttributes(attrs, R.styleable.burce); 19 heiget=array.getInt(R.styleable.burce_mHeight,0); 20 width=array.getInt(R.styleable.burce_mWidth,0); 21 name=array.getString(R.styleable.burce_mName); 22 sex=array.getInt(R.styleable.burce_sex,0); 23 student=array.getBoolean(R.styleable.burce_student,true); 24 array.recycle(); 25 26 Log.i(TAG, \u0026#34;height: \u0026#34;+heiget); 27 Log.i(TAG, \u0026#34;width: \u0026#34;+width); 28 Log.i(TAG, \u0026#34;name: \u0026#34;+name); 29 Log.i(TAG, \u0026#34;sex: \u0026#34;+sex); 30 Log.i(TAG, \u0026#34;student: \u0026#34;+student); 31 32 } 33} TypedArray array=context.obtainStyledAttributes(attrs, R.styleable.burce);\nè¿™æ˜¯Googleå®˜æ–¹ç»™çš„è§£é‡Šï¼Œå°±ç®€å•è¯´ä¸€ä¸‹ä¸¤ä¸ªå‚æ•°æ€ä¹ˆå¡«å§ï¼Œç¬¬ä¸€ä¸ªå¡«å½¢å‚çš„attrsï¼Œç¬¬äºŒä¸ªå¡« R.styleableæ˜¯å›ºå®šå†™æ³•ï¼Œbruceæ˜¯\u0026lt;declare-styleable name=\u0026quot;burce\u0026quot;\u0026gt;ä¸­çš„nameçš„å€¼ã€‚ 4ï¼Œå›åˆ°MainActivityçš„å¸ƒå±€æ–‡ä»¶ä¸­ä½¿ç”¨æˆ‘ä»¬çš„è‡ªå®šä¹‰view\n1\u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;utf-8\u0026#34;?\u0026gt; 2\u0026lt;RelativeLayout xmlns:android=\u0026#34;http://schemas.android.com/apk/res/android\u0026#34; 3 xmlns:app=\u0026#34;http://schemas.android.com/apk/res-auto\u0026#34; 4 xmlns:tools=\u0026#34;http://schemas.android.com/tools\u0026#34; 5 android:layout_width=\u0026#34;match_parent\u0026#34; 6 android:layout_height=\u0026#34;match_parent\u0026#34; 7 tools:context=\u0026#34;com.myviewtest.MainActivity\u0026#34;\u0026gt; 8 \u0026lt;com.myviewtest.MyView 9 android:layout_width=\u0026#34;match_parent\u0026#34; 10 android:layout_height=\u0026#34;match_parent\u0026#34; 11 app:mName=\u0026#34;bruce\u0026#34; 12 app:sex=\u0026#34;man\u0026#34; 13 app:mHeight=\u0026#34;100\u0026#34; 14 app:mWidth=\u0026#34;100\u0026#34; 15 app:student=\u0026#34;true\u0026#34;/\u0026gt; 16\u0026lt;/RelativeLayout\u0026gt; æ³¨æ„ï¼šå¦‚æœAndroid studioæ²¡æœ‰åŠ ä¸Šå‘½åç©ºé—´çš„è¯éœ€è¦è‡ªå·±åŠ ä¸Š xmlns:app=\u0026quot;http://schemas.android.com/apk/res-auto\u0026quot; åªæœ‰å£°æ˜äº†å‘½åç©ºé—´æ‰èƒ½ä½¿ç”¨è‡ªå®šä¹‰å±æ€§ï¼Œä¸æ‡‚å•¥æ˜¯å‘½åç©ºé—´çš„åŒå­¦å‘¢è‡ªå·±Googleå­¦ä¹ ä¸€ä¸‹å§ï¼ˆæœ€è¿‘åœ¨å­¦C++ï¼Œæˆ‘å°±å®‰C++ä¸­çš„å‘½åç©ºé—´ç†è§£çš„ï¼Œå¦‚æœä¸æ­£ç¡®è¿˜è¯·å¤§ç¥èµæ•™ï¼‰ è¿™é‡Œçš„æˆ‘ä»¬åœ¨è¿™ç”¨äº†appå‘½åç©ºé—´ï¼Œæ‰€æœ‰æ‰€æœ‰çš„è‡ªå®šä¹‰å±æ€§çš„å¼€å¤´éƒ½åŠ ä¸Šäº†â€œapp:â€ã€‚\nå‡†å¤‡å·¥ä½œéƒ½åšå¥½äº†æ¥ä¸‹æ¥æˆ‘ä»¬å§åº”ç”¨è·‘èµ·æ¥çœ‹çœ‹å§ï¼Œè¿™é‡Œæˆ‘ä»¬é€šè¿‡æ‰“å°logæŸ¥çœ‹è‡ªå®šä¹‰å±æ€§çš„å€¼ã€‚\né€šè¿‡logå¯ä»¥å¾—çŸ¥ æˆ‘ä»¬åœ¨è‡ªå®šä¹‰viewä¸­æˆåŠŸçš„è·å–åˆ°äº†å±æ€§çš„å€¼ã€‚å¥½çš„è€å¸æœºå¹³å®‰åˆ°ç«™ï¼Œå°ç™½æœ‰åºä¸‹è½¦ã€‚ ç”±äºä½ é‡åˆ°äº†ä¸€ä¸ªå‡çš„è€å¸æœºï¼Œæ–‡ç« ä¸­å¦‚æœæœ‰ä¸æ­£ç¡®çš„åœ°æ–¹è¿˜è¯·å„ä½å¤§ç¥åœ¨è¯„è®ºåŒºæŒ‡æ­£ï¼Œè€å¸æœºåœ¨è¿™é‡ŒæŠ±æ‹³äº†ã€‚\n","date":"2017-03-08T18:27:24Z","permalink":"https://lqxhub.github.io/posts/25a04712/","title":"è‡ªå®šä¹‰å±æ€§"},{"content":"æœ¬ä¾‹æ˜¯æˆ‘åœ¨å¹´å‰çš„é¡¹ç›®ä¸­ç”¨åˆ°çš„ä¸€ä¸ªå°ä¾‹å­ï¼Œä½¿ç”¨Androidè‡ªå¸¦çš„HttpURLConnectionå®ç°æ–‡ä»¶ä¸Šä¼ ã€‚ç½‘ä¸Šçš„èµ„æ–™å¯¹è¿™æ–¹é¢çš„è®²è§£ä¸å¤ªå¤šï¼Œæœ‰ä¸¤ä¸ªå®ä¾‹ä¹Ÿä¸å¤ªè¯¦ç»†ï¼Œæˆ‘åœ¨å¼€å‘ä¸­ç”¨åˆ°äº†ï¼Œè§‰å¾—æŒºå®ç”¨çš„ï¼Œåˆ†äº«å‡ºæ¥ï¼Œå¸Œæœ›èƒ½å¯¹å„ä½æœ‹å‹æœ‰æ‰€å¸®åŠ©ï¼Œå—æ°´å¹³æ‰€é™ï¼Œå®ä¾‹ä¸­å¦‚æœ‰è°¬å¤„ï¼Œè¿˜æœ›å„ä½å¤§ç¥æ‰¹è¯„æŒ‡æ­£ï¼Œè¿™ä¸ªå®ä¾‹ä¸ªäººè®¤ä¸ºé€‚ç”¨äºé¡¹ç›®ä¸­çš„æ–‡ä»¶ä¸Šä¼ æ¯”è¾ƒå°‘çš„æƒ…å†µï¼Œå½“æ–‡ä»¶ä¸Šä¼ æ¯”è¾ƒå¤šçš„æ—¶å€™è¿˜æ˜¯ç”¨æ¡†æ¶å§ï¼ˆä¾‹å¦‚okhtpï¼‰ã€‚ æœ¬æ¥æƒ³åœ¨åˆšæ”¾å¯’å‡å°±æ•´ç†ä¸€ä¸‹ï¼Œç”±äºå¹´å‰å›å®¶æ¯”è¾ƒæ™šäº†ï¼Œå¹´å‰å¹´åçš„äº‹æœ‰ç‚¹å¤šï¼Œç›´åˆ°ç°åœ¨æ‰æœ‰æ—¶é—´æ•´ç†ã€‚åºŸè¯ä¸å¤šè¯´ ç›´æ¥ä¸Šä»£ç ï¼š(ä»£ç æ˜¯æˆ‘ä»é¡¹ç›®ä¸­å‰ªå‡ºæ¥çš„ï¼Œå¯èƒ½ä¼šæœ‰æŠ¥é”™ï¼Œé—®é¢˜ä¸ä¼šå¤ªå¤§ï¼Œå¾ˆå¥½æ”¹)\n1import android.os.Handler; 2import android.os.Message; 3import android.util.Log; 4import org.json.JSONException; 5import org.json.JSONObject; 6 7import java.io.BufferedReader; 8import java.io.DataOutputStream; 9import java.io.FileInputStream; 10import java.io.IOException; 11import java.io.InputStreamReader; 12import java.net.HttpURLConnection; 13import java.net.MalformedURLException; 14import java.net.URL; 15public class ArrivateUpload extends Thread { 16 17 private final String BOUNDARYSTR = \u0026#34;--------aifudao7816510d1hq\u0026#34;; 18 private final String END = \u0026#34;\\r\\n\u0026#34;; 19 private final String LAST = \u0026#34;--\u0026#34;; 20 21 private String data;//è¡¨å•æ•°æ® 22 private FileInputStream fis;//æ–‡ä»¶è¾“å…¥æµ 23 private Handler handler; 24 25 public ArrivateUpload(String data, FileInputStream fis, Handler handler) { 26 this.data = data; 27 this.handler = handler; 28 this.fis=fis; 29 } 30 31 @Override 32 public void run() { 33 try { 34 URL httpUrl=new URL(urlStr); 35 HttpURLConnection connection= (HttpURLConnection) httpUrl.openConnection(); 36 connection.setRequestMethod(\u0026#34;POST\u0026#34;);//å¿…é¡»ä¸ºpost 37 connection.setDoInput(true); 38 connection.setDoOutput(true); 39 connection.setRequestProperty(\u0026#34;Content-type\u0026#34;, \u0026#34;multipart/form-data;boundary=\u0026#34; + BOUNDARYSTR);//å›ºå®šæ ¼å¼ 40 DataOutputStream dos=new DataOutputStream(connection.getOutputStream()); 41 StringBuffer sb=new StringBuffer(); 42 /** 43 * å†™å…¥æ–‡æœ¬æ•°æ® 44 */ 45 46 sb.append(LAST+BOUNDARYSTR+END); 47 sb.append(\u0026#34;Content-Disposition: form-data; name=\\\u0026#34;data\\\u0026#34;\u0026#34;+END+END); 48 sb.append(data+END);//å†…å®¹ 49 /** 50 * å¾ªç¯å†™å…¥æ–‡ä»¶ 51 */ 52sb.append(LAST+BOUNDARYSTR+END); 53sb.append(\u0026#34;Content-Disposition:form-data;Content-Type:application/octet-stream;name=\\\u0026#34;file\\\u0026#34;;\u0026#34;); 54 sb.append(\u0026#34;filename=\\\u0026#34;\u0026#34;+\u0026#34;map_image.png\u0026#34;+\u0026#34;\\\u0026#34;\u0026#34;+END+END); 55 dos.write(sb.toString().getBytes(\u0026#34;utf-8\u0026#34;)); 56 if (fis != null) { 57 byte[] b=new byte[1024]; 58 int len; 59 while ((len=fis.read(b))!=-1){ 60 dos.write(b,0,len); 61 } 62 dos.write(END.getBytes()); 63 } 64 dos.write((LAST+BOUNDARYSTR+LAST+END).getBytes()); 65 dos.flush(); 66 sb=new StringBuffer(); 67 if (connection.getResponseCode()==200) {//è¯·æ±‚æˆåŠŸ 68 BufferedReader br=new BufferedReader(new InputStreamReader(connection.getInputStream())); 69 String line; 70 while ((line=br.readLine())!=null){ 71 sb.append(line); 72 } 73 Message msg=Message.obtain(); 74 JSONObject object=new JSONObject(sb.toString()); 75 handler.sendMessage(msg); 76 } 77 } catch (MalformedURLException e) { 78 e.printStackTrace(); 79 } catch (IOException e) { 80 e.printStackTrace(); 81 } catch (JSONException e) { 82 e.printStackTrace(); 83 } 84 } 85} è¯´ä¸€ä¸‹å®ç°æ€è·¯ï¼šç”¨Androidç³»ç»Ÿä¸­æä¾›çš„HttpURLConnectionï¼Œåˆ©ç”¨httpä¸­çš„multipartåè®®å®ç°æ–‡ä»¶ä¸Šä¼ ã€‚httpUrlConnectionåº”è¯¥ä¸ç”¨å¤šè¯´äº†ï¼ˆä¸å¤ªç†Ÿæ‚‰çš„åŒå­¦å»Googleå­¦ä¹ ä¸€ä¸‹HttpURLConnectionå’Œhttpåè®®å§ï¼‰ï¼Œå°±è¯´å‡ ä¸ªæ³¨æ„ç‚¹å§ï¼Œè¯·æ±‚æ¨¡å¼è®¾ç½®ä¸ºPOSTï¼Œæ‰“å¼€è¾“å…¥è¾“å‡ºæµï¼ˆè¿™ä¸ªå¥½åƒé»˜è®¤æ˜¯å¼€å¯çš„ï¼Œè¿˜æ˜¯è®¾ç½®ä¸ºtrueæ¯”è¾ƒæ”¾å¿ƒï¼‰ é‡ç‚¹è¯´ä¸€ä¸‹multipartåè®®å§ï¼Œå› ä¸ºæ™®é€šçš„http poståè®®ä½¿ç”¨çš„åˆ†éš”ç¬¦å¤ªç®€å•ï¼Œä¸Šä¼ æ–‡ä»¶ä¼šé€ æˆæ–‡ä»¶åˆ†å‰²æ­§ä¹‰ï¼Œæ‰€ä»¥å¿…é¡»ä½¿ç”¨multipartåè®®ã€‚ å†™ä¸€ä¸ªç®€å•çš„HTMLè¡¨å•æ–‡ä»¶ä¸Šä¼ çš„ä¾‹å­ï¼Œå¯¹ç…§å­¦ä¹ ã€‚\n1\u0026lt;!DOCTYPE html\u0026gt; 2\u0026lt;html lang=\u0026#34;en\u0026#34;\u0026gt; 3\u0026lt;head\u0026gt; 4 \u0026lt;meta charset=\u0026#34;UTF-8\u0026#34;\u0026gt; 5 \u0026lt;title\u0026gt;upload\u0026lt;/title\u0026gt; 6\u0026lt;/head\u0026gt; 7\u0026lt;body\u0026gt; 8\u0026lt;form action=\u0026#34;a.php\u0026#34; method=\u0026#34;post\u0026#34; enctype=\u0026#34;multipart/form-data\u0026#34;\u0026gt; 9 \u0026lt;input type=\u0026#34;text\u0026#34; name=\u0026#34;data\u0026#34;/\u0026gt; 10 \u0026lt;input type=\u0026#34;file\u0026#34; name=\u0026#34;file\u0026#34;\u0026gt; 11 \u0026lt;input type=\u0026#34;submit\u0026#34;\u0026gt; 12\u0026lt;/form\u0026gt; 13\u0026lt;/body\u0026gt; 14\u0026lt;/html\u0026gt; åœ¨æµè§ˆå™¨ä¸­é€šè¿‡è°ƒè¯•æˆ‘ä»¬å¯ä»¥å¯¹ç…§æµè§ˆå™¨æ¥æ‹¼å‡ºmultipartåè®®ï¼Œæµè§ˆå™¨ä¼šæŠ¥404,a.php æ²¡æœ‰æ‰¾åˆ°ï¼Œä¸ç”¨ç®¡å®ƒï¼Œè¿™ä¸æ˜¯æˆ‘ä»¬å…³æ³¨çš„é‡ç‚¹ã€‚ä¸‹å›¾å°±æ˜¯æµè§ˆå™¨ä¸­çš„è¯¦ç»†ä¿¡æ¯\nåœ¨1å¤„å®šä¹‰äº†åˆ†éš”ç¬¦ï¼Œåˆ†éš”ç¬¦å°½é‡å¤æ‚ä¸€ç‚¹ï¼Œé¿å…é€ æˆä¸æ–‡ä»¶ä¸­çš„å­—ç¬¦äº§ç”Ÿå†²çªã€‚æ³¨æ„äº†ï¼Œå‰æ–¹æœ‰å¤§å‘ï¼Œæ³¨æ„è„šä¸‹æ²¹é—¨ï¼Œè€å¸æœºä¸€ä¸ç•™ç¥ä¹Ÿä¼šç¿»è½¦ã€‚ä»”ç»†å¯¹æ¯”ä½ ä¼šå‘ç°2,3,4å¤„å’Œ1å¤„æ˜¯ä¸åŒçš„ï¼Œ2,3,4å¤„æ¯”1å¤„å¤šäº†ä¸¤ä¸ªâ€œ-â€,ä¸€å®šè¦ç•™ç¥ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬åœ¨ä½¿ç”¨boundaryæ—¶è¦åŠ ä¸Šâ€œ\u0026ndash;â€çš„åŸå› äº†ã€‚sb.append(LAST+BOUNDARYSTR+END); åœ¨4å¤„ï¼Œæ•´ä¸ªbodyçš„ç»“æŸå¤„è¦åŠ ä¸Šä¸€ä¸ªâ€œ\u0026ndash;â€ï¼Œæ²¡æœ‰whyï¼Œåè®®å°±æ˜¯è¿™æ ·è§„å®šçš„ã€‚\næ¯ä¸€è¡Œç»“æŸéƒ½è¦æœ‰ä¸€ä¸ª\u0026quot;\\r\\n\u0026quot;ï¼Œç¬¬äºŒè¡Œç»“æŸæ—¶ï¼ˆæ•°æ®æ–‡ä»¶å¼€å§‹å‰ï¼‰è¦æœ‰ä¸¤ä¸ª\u0026quot;\\r\\n\u0026quot;ã€‚å¯¹æ¯”å›¾ä¸­ä¼šå‘ç°æ•°æ®æ–‡ä»¶å‰æœ‰ä¸€ä¸ªç©ºè¡Œã€‚è¿˜æœ‰éå¸¸é‡è¦çš„ä¸€ç‚¹ï¼Œåƒä¸‡æ³¨æ„å¼•å·(â€œ â€)çš„è½¬ä¹‰é—®é¢˜ï¼Œå¦‚æœå¼•å·å‡ºé—®é¢˜å°±ä¼šå¯¼è‡´ä¸Šä¼ å¤±è´¥ï¼Œè€Œä¸”è¿™ä¸ªé”™è¯¯è¿˜ä¸å®¹æ˜“å‘ç°ã€‚æ–‡ä»¶å†™å…¥éœ€è¦ç”¨è¾“å…¥æµå¾ªç¯å†™å…¥\n1sb.append(\u0026#34;Content-Disposition:form-data;Content-Type:application/octet-stream;name=\\\u0026#34;file\\\u0026#34;;\u0026#34;); //name ä¹‹å‰æ˜¯å›ºå®šå†™æ³•ï¼Œ è¿™é‡Œçš„nameæ˜¯æœåŠ¡ç«¯æ¥æ”¶æ—¶éœ€è¦ç”¨åˆ°çš„ï¼Œ 2sb.append(\u0026#34;filename=\\\u0026#34;\u0026#34;+\u0026#34;map_image.png\u0026#34;+\u0026#34;\\\u0026#34;\u0026#34;+END+END); // è¿™é‡Œçš„filenameçš„å€¼éšä¾¿å†™ï¼Œæ— æ‰€è°“ï¼Œä½†æ˜¯ä¸€å®šè¦æœ‰ï¼Œæ²¡æœ‰ä¼šå¯¼è‡´ä¸Šä¼ å¤±è´¥ã€‚ 3dos.write(sb.toString().getBytes(\u0026#34;utf-8\u0026#34;)); 4 if (fis != null) { 5 byte[] b=new byte[1024]; 6 int len; 7 while ((len=fis.read(b))!=-1){ 8 dos.write(b,0,len); 9 } 10 dos.write(END.getBytes()); 11 } 12 dos.write((LAST+BOUNDARYSTR+LAST+END).getBytes()); 13 dos.flush(); å†åˆ†äº«ä¸€ä¸ªè°ƒè¯•æŠ€å·§ï¼Œæˆ‘ä»¬çš„ç¨‹åºæ˜¯è·‘åœ¨Androidä¸Šçš„ï¼Œæˆ‘ä»¬æ˜¯æ— æ³•åƒåœ¨æµè§ˆå™¨ä¸­é‚£æ ·è°ƒè¯•çš„ï¼Œæ‰€ä»¥å¼€æŠ“åŒ…æ˜¯éå¸¸å¿…è¦çš„ï¼ˆgenymationè‡ªå¸¦æŠ“åŒ…å™¨ï¼Œç†Ÿæ‚‰linuxçš„å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼‰ï¼Œåœ¨æ¨¡æ‹Ÿå™¨ä¸Šè¿è¡Œç¨‹åºï¼Œç”µè„‘å¼€å¯æŠ“åŒ…å™¨ï¼Œæ¯æ¬¡ä¸Šä¼ éƒ½æŠ“å–ä¸€ä¸ªæ•°æ®åŒ…ï¼Œåˆ†ææ•°æ®åŒ…ï¼Œå¦‚æœå‡ºé”™äº†ä¸æµè§ˆå™¨çš„æ ¼å¼å¯¹æ¯”ï¼Œè¿™æ ·è°ƒè¯•ä¸è¦å¤ªé…¸çˆ½ã€‚æœ‰æ¬¡ä¸Šä¼ çš„å†…å®¹æœ‰ç‚¹å¤æ‚ï¼Œä¸€ç›´è°ƒè¯•ä¸æ­£ç¡®ï¼Œæœ€åç”¨æŠ“åŒ…å¯¹æ¯”æå®šäº†ã€‚æˆ‘ç”¨çš„æ˜¯wiresharkï¼Œè¿™ä¸ªåŠŸèƒ½å¤ªå¼ºå¤§äº†ï¼Œç›´æ¥åœ¨ç½‘å¡å®‰è£…é©±åŠ¨ï¼Œåªè¦ç»è¿‡ç½‘å¡çš„æ•°æ®éƒ½èƒ½æŠ“åˆ°ï¼ˆæƒ³è±¡åŠ›ä¸°å¯Œçš„åŒå­¦å¯ä»¥ç”¨å®ƒæ¥å¹²ç‚¹åäº‹æƒ… æ­¤å¤„ç•¥å»ä¸€åƒå­—â€¦â€¦ï¼‰ã€‚è¿˜æœ‰ä¸€ä¸ªåœ°æ–¹éœ€è¦æ³¨æ„ä¸€ä¸‹ï¼Œwiresharkä¸èƒ½æŠ“ipä¸º127.0.0.1çš„æ•°æ®åŒ…ï¼ˆç”¨æœ¬åœ°ç”µè„‘åšæœåŠ¡å™¨ï¼‰ï¼Œå› ä¸ºè¿™æ—¶çš„æ•°æ®ä¸ç»è¿‡ç½‘å¡ï¼Œæ‰€ä»¥æ— æ³•æŠ“å–ã€‚ ç”±äºæ°´å¹³æœ‰é™ï¼ŒåŠ ä¹‹æ—¶é—´åŒ†å¿™ï¼Œå¦‚æœ‰è°¬å¤„ï¼Œè¿˜è¯·å„ä½å¤§ç¥æ‰¹è¯„æŒ‡æ­£\n","date":"2017-02-15T09:50:53Z","permalink":"https://lqxhub.github.io/posts/3c55041d/","title":"åœ¨Androidä¸­å®ç°æ–‡ä»¶ä¸Šä¼ "}]