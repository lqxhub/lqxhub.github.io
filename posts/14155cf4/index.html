<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="深入探讨C++中的右值引用、std::move和std::forward的使用方法及其实现原理，结合实例讲解RVO（返回值优化）的工作机制，帮助开发者高效管理资源。"><meta name=keywords content="C++,,右值引用,,std::move,,std::forward,,RVO"><title>C++中的移动语义与完美转发，C++中的右值引用、std::move和std::forward的使用方法及其实现原理，结合实例讲解RVO</title>
<link rel=canonical href=https://lqxhub.github.io/posts/14155cf4/><link rel=stylesheet href=/scss/style.min.cf20c5703e90831fa8051409d1786e3338f2624d07c5fe5f37ce747dbe09923c.css><meta property='og:title' content="C++中的移动语义与完美转发，C++中的右值引用、std::move和std::forward的使用方法及其实现原理，结合实例讲解RVO"><meta property='og:description' content="深入探讨C++中的右值引用、std::move和std::forward的使用方法及其实现原理，结合实例讲解RVO（返回值优化）的工作机制，帮助开发者高效管理资源。"><meta property='og:url' content='https://lqxhub.github.io/posts/14155cf4/'><meta property='og:site_name' content='QX 的笔记'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='C++'><meta property='article:published_time' content='2025-03-16T19:50:55+08:00'><meta property='article:modified_time' content='2025-03-16T19:50:55+08:00'><meta property='og:image' content='https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/7320b79a5cd9f9ac9e07752081db9612e98ca223.jpg'><meta name=twitter:title content="C++中的移动语义与完美转发，C++中的右值引用、std::move和std::forward的使用方法及其实现原理，结合实例讲解RVO"><meta name=twitter:description content="深入探讨C++中的右值引用、std::move和std::forward的使用方法及其实现原理，结合实例讲解RVO（返回值优化）的工作机制，帮助开发者高效管理资源。"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/7320b79a5cd9f9ac9e07752081db9612e98ca223.jpg'><link rel="shortcut icon" href=/favicon.ico><meta name=google-site-verification content="Ts78qICcAFtPJZg7DfwjJYFH2BsbYh7ICe1k6xMb-C8"><meta name=msvalidate.01 content="C538647907B2EAEBE650AAC7463E551F"><script async src="https://www.googletagmanager.com/gtag/js?id=G-BM48R77LCS"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-BM48R77LCS")</script><script src=https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js></script><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css><script src=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js></script><script src=https://fastly.jsdelivr.net/gh/stevenjoezhang/live2d-widget@latest/autoload.js></script><style>#waifu #live2d{cursor:grab;height:260px;position:relative;width:260px}#waifu-tips{width:230px}</style><div class=top-scroll-bar></div><style>.top-scroll-bar{position:fixed;top:0;left:0;z-index:9999;display:none;width:0;height:3px;background:#ef3982}</style><script>$(document).ready(function(){$(window).scroll(function(){$(".top-scroll-bar").attr("style","width: "+$(this).scrollTop()/($(document).height()-$(this).height())*100+"%; display: block;")})})</script><div id=back-top><a href=#top title=回到顶部></a></div><style>#back-top{position:fixed;bottom:30px;right:80px}#back-top a{width:54px;height:54px;display:block;background:#ddd url(/images/back_top.svg)no-repeat 50%;background-color:rgba(218,214,214,.87);-webkit-border-radius:7px;-moz-border-radius:7px;border-radius:7px;-webkit-transition:1s;-moz-transition:1s;transition:1s}#back-top a:hover{background-color:#e88282}</style><script type=text/javascript>$("#back-top").hide(),$(document).ready(function(){$(window).scroll(function(){$(this).scrollTop()>100?$("#back-top").fadeIn():$("#back-top").fadeOut()}),$("#back-top a").click(function(){return $("body,html").animate({scrollTop:0},800),!1})})</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu14972274666183315035.gif width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>😉</span></figure><div class=site-meta><h1 class=site-name><a href=/>QX 的笔记</a></h1><h2 class=site-description>雄关漫道真如铁，而今迈步从头越</h2></div></header><ol class=menu-social><li><a href=mailto:lqxlucky@qq.com target=_blank title=Email rel=me><svg fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" class="icon icon-tabler icon-tabler-mail-flat"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 4h16a2 2 0 012 2v12a2 2 0 01-2 2H4a2 2 0 01-2-2V6a2 2 0 012-2z"/><path d="M4 6l8 5 8-5"/></svg></a></li><li><a href=https://github.com/lqxhub target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=/index.xml target=_blank title="RSS Feed" rel=me><svg class="icon icon-tabler icon-tabler-rss" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="5" cy="19" r="1"/><path d="M4 4a16 16 0 0116 16"/><path d="M4 11a9 9 0 019 9"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>首页</span></a></li><li><a href=/categories><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg>
<span>分类</span></a></li><li><a href=/archives><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>归档</span></a></li><li><a href=/tags><svg class="icon icon-tabler icon-tabler-tag" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11 3l9 9a1.5 1.5.0 010 2l-6 6a1.5 1.5.0 01-2 0L3 11V7a4 4 0 014-4h4"/><circle cx="9" cy="9" r="2"/></svg>
<span>标签</span></a></li><li><a href=/collect><svg fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" class="icon icon-tabler icon-tabler-bookmark"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 4h14a1 1 0 011 1v16l-8-4-8 4V5a1 1 0 011-1z"/></svg>
<span>收藏</span></a></li><li><a href=/tool><svg fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" class="icon icon-tabler icon-tabler-tools"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 15l-4 4m0-4 4 4"/><path d="M15 9l4-4m0 4-4-4"/><path d="M9 9l6 6"/><path d="M12 12l2-2"/><path d="M15 15l-2 2"/></svg>
<span>工具</span></a></li><li><a href=/friend><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>友链</span></a></li><li><a href=/search><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>搜索</span></a></li><li><a href=/about><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>关于</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>暗色模式</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#move>move</a><ol><li><a href=#move例子>move例子</a></li><li><a href=#move分析>move分析</a></li><li><a href=#move函数的优先级>move函数的优先级</a></li><li><a href=#使用move注意事项>使用move注意事项</a></li></ol></li><li><a href=#forward>forward</a><ol><li><a href=#forward例子>forward例子</a></li><li><a href=#实现原理>实现原理</a></li></ol></li><li><a href=#rvo>RVO</a><ol><li><a href=#rvo例子>RVO例子</a></li><li><a href=#工作原理>工作原理</a></li><li><a href=#rvo-和-stdmove-的关系>RVO 和 std::move 的关系</a></li></ol></li><li><a href=#总结>总结</a></li></ol></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/posts/14155cf4/><img src=https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/7320b79a5cd9f9ac9e07752081db9612e98ca223.jpg loading=lazy alt="Featured image of post C++中的移动语义与完美转发，C++中的右值引用、std::move和std::forward的使用方法及其实现原理，结合实例讲解RVO"></a></div><div class=article-details><header class=article-category><a href=/categories/c++/>C++</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/posts/14155cf4/>C++中的移动语义与完美转发</a></h2><h3 class=article-subtitle>深入探讨C++中的右值引用、std::move和std::forward的使用方法及其实现原理，结合实例讲解RVO（返回值优化）的工作机制，帮助开发者高效管理资源。</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Mar 16, 2025</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>阅读时长: 10 分钟</time></div></footer></div></header><section class=article-content><p>上一篇文章<a class=link href=/posts/567e834f>《C++变量生命周期》</a>中提到了C++中变量的生命周期与作用域是有差别的，其中提到了 <strong>左值</strong> 和 <strong>右值</strong> 这两个概念，引申出来了 <strong>左值引用</strong> 和 <strong>右值引用</strong> 这两个东西，上次因为篇幅问题，只是简单说了一下左值和右值的一些区别，生命周期和简单用法，没有详细展开。这次讨论一下右值引用的一些常见问题和使用。</p><h2 id=move><a href=#move class=header-anchor></a>move</h2><p>在C++11中，加入了 <code>std::move</code> 函数，实现了移动语义，有了 move函数后，可以实现高效的资源转移，不必像传统的复制那样 ‘笨重’。</p><h3 id=move例子><a href=#move%e4%be%8b%e5%ad%90 class=header-anchor></a>move例子</h3><p>先来一个简单的例子来看一下 <code>move</code> 函数的魅力</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>#include</span> <span style=color:#ff79c6>&lt;iostream&gt;</span><span style=color:#ff79c6>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#ff79c6>#include</span> <span style=color:#ff79c6>&lt;utility&gt;</span><span style=color:#ff79c6>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#ff79c6>#include</span> <span style=color:#ff79c6>&lt;vector&gt;</span><span style=color:#ff79c6>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#ff79c6></span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#ff79c6>class</span> <span style=color:#50fa7b>MyClass</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#ff79c6>public</span><span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    MyClass(<span style=color:#8be9fd>int</span> value) <span style=color:#ff79c6>:</span> value_(value) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>        std<span style=color:#ff79c6>::</span>cout <span style=color:#ff79c6>&lt;&lt;</span> <span style=color:#f1fa8c>&#34;Constructing MyClass with value &#34;</span> <span style=color:#ff79c6>&lt;&lt;</span> value_ <span style=color:#ff79c6>&lt;&lt;</span> std<span style=color:#ff79c6>::</span>endl;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    MyClass(<span style=color:#ff79c6>const</span> MyClass<span style=color:#ff79c6>&amp;</span> other) <span style=color:#ff79c6>:</span> value_(other.value_) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        std<span style=color:#ff79c6>::</span>cout <span style=color:#ff79c6>&lt;&lt;</span> <span style=color:#f1fa8c>&#34;Copy constructing MyClass with value &#34;</span> <span style=color:#ff79c6>&lt;&lt;</span> value_ <span style=color:#ff79c6>&lt;&lt;</span> std<span style=color:#ff79c6>::</span>endl;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    MyClass(MyClass<span style=color:#ff79c6>&amp;&amp;</span> other) <span style=color:#ff79c6>noexcept</span> <span style=color:#ff79c6>:</span> value_(other.value_) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>        other.value_ <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>        std<span style=color:#ff79c6>::</span>cout <span style=color:#ff79c6>&lt;&lt;</span> <span style=color:#f1fa8c>&#34;Move constructing MyClass with value &#34;</span> <span style=color:#ff79c6>&lt;&lt;</span> value_ <span style=color:#ff79c6>&lt;&lt;</span> std<span style=color:#ff79c6>::</span>endl;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>    MyClass<span style=color:#ff79c6>&amp;</span> <span style=color:#ff79c6>operator</span><span style=color:#ff79c6>=</span>(<span style=color:#ff79c6>const</span> MyClass<span style=color:#ff79c6>&amp;</span> other) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>        <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>this</span> <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>&amp;</span>other) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>            value_ <span style=color:#ff79c6>=</span> other.value_;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>            std<span style=color:#ff79c6>::</span>cout <span style=color:#ff79c6>&lt;&lt;</span> <span style=color:#f1fa8c>&#34;Copy assigning MyClass with value &#34;</span> <span style=color:#ff79c6>&lt;&lt;</span> value_ <span style=color:#ff79c6>&lt;&lt;</span> std<span style=color:#ff79c6>::</span>endl;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>        <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>*</span><span style=color:#ff79c6>this</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>    MyClass<span style=color:#ff79c6>&amp;</span> <span style=color:#ff79c6>operator</span><span style=color:#ff79c6>=</span>(MyClass<span style=color:#ff79c6>&amp;&amp;</span> other) <span style=color:#ff79c6>noexcept</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>        <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>this</span> <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>&amp;</span>other) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>            value_ <span style=color:#ff79c6>=</span> other.value_;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>            other.value_ <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>            std<span style=color:#ff79c6>::</span>cout <span style=color:#ff79c6>&lt;&lt;</span> <span style=color:#f1fa8c>&#34;Move assigning MyClass with value &#34;</span> <span style=color:#ff79c6>&lt;&lt;</span> value_ <span style=color:#ff79c6>&lt;&lt;</span> std<span style=color:#ff79c6>::</span>endl;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>        <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>*</span><span style=color:#ff79c6>this</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>    <span style=color:#8be9fd>int</span> <span style=color:#50fa7b>getValue</span>() <span style=color:#ff79c6>const</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>        <span style=color:#ff79c6>return</span> value_;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span><span style=color:#ff79c6>private</span><span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>    <span style=color:#8be9fd>int</span> value_;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>};
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>main</span>() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span>    MyClass a(<span style=color:#bd93f9>10</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span>    MyClass b <span style=color:#ff79c6>=</span> std<span style=color:#ff79c6>::</span>move(a);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span>    MyClass c <span style=color:#ff79c6>=</span> b;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span><span>    std<span style=color:#ff79c6>::</span>cout<span style=color:#ff79c6>&lt;&lt;</span><span style=color:#f1fa8c>&#34;----------------------------&#34;</span><span style=color:#ff79c6>&lt;&lt;</span>std<span style=color:#ff79c6>::</span>endl;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span><span>    std<span style=color:#ff79c6>::</span>cout <span style=color:#ff79c6>&lt;&lt;</span> <span style=color:#f1fa8c>&#34;Value of a after move: &#34;</span> <span style=color:#ff79c6>&lt;&lt;</span> a.getValue() <span style=color:#ff79c6>&lt;&lt;</span> std<span style=color:#ff79c6>::</span>endl;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53</span><span>    std<span style=color:#ff79c6>::</span>cout <span style=color:#ff79c6>&lt;&lt;</span> <span style=color:#f1fa8c>&#34;Value of b after move: &#34;</span> <span style=color:#ff79c6>&lt;&lt;</span> b.getValue() <span style=color:#ff79c6>&lt;&lt;</span> std<span style=color:#ff79c6>::</span>endl;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55</span><span>    std<span style=color:#ff79c6>::</span>cout<span style=color:#ff79c6>&lt;&lt;</span><span style=color:#f1fa8c>&#34;----------------------------&#34;</span><span style=color:#ff79c6>&lt;&lt;</span>std<span style=color:#ff79c6>::</span>endl;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56</span><span>    std<span style=color:#ff79c6>::</span>vector<span style=color:#ff79c6>&lt;</span>MyClass<span style=color:#ff79c6>&gt;</span> vec;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57</span><span>    vec.push_back(MyClass(<span style=color:#bd93f9>20</span>));
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58</span><span>    std<span style=color:#ff79c6>::</span>cout<span style=color:#ff79c6>&lt;&lt;</span><span style=color:#f1fa8c>&#34;----------------------------&#34;</span><span style=color:#ff79c6>&lt;&lt;</span>std<span style=color:#ff79c6>::</span>endl;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59</span><span>    vec.push_back(std<span style=color:#ff79c6>::</span>move(b));
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61</span><span>    <span style=color:#ff79c6>return</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62</span><span>}
</span></span></code></pre></div><p>这段代码执行的结果</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>Constructing MyClass with value <span style=color:#bd93f9>10</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>Move constructing MyClass with value <span style=color:#bd93f9>10</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>Copy constructing MyClass with value <span style=color:#bd93f9>10</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>----------------------------
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>Value of a after move: <span style=color:#bd93f9>0</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>Value of b after move: <span style=color:#bd93f9>10</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>----------------------------
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>Constructing MyClass with value <span style=color:#bd93f9>20</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>Move constructing MyClass with value <span style=color:#bd93f9>20</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>----------------------------
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>Move constructing MyClass with value <span style=color:#bd93f9>10</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>Move constructing MyClass with value <span style=color:#bd93f9>20</span>
</span></span></code></pre></div><p>通过代码执行的结果可以看到，</p><p>在代码 <code>MyClass a(10);</code> 中，初始化变量 <code>a</code> 调用了构造函数。</p><p>在代码 <code>MyClass b = std::move(a);</code> 中，初始化变量 <code>b</code> 调用了移动构造函数。</p><p>在代码 <code>MyClass c = b;</code> 中，初始化变量 <code>c</code> 调用了拷贝构造函数。</p><p>在代码 <code>vec.push_back(MyClass(20));</code> 中，对应的两行输出</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>Constructing MyClass with value <span style=color:#bd93f9>20</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>Move constructing MyClass with value <span style=color:#bd93f9>20</span>
</span></span></code></pre></div><ol><li><code>MyClass(20)</code> 构造一个临时对象</li><li>调用移动构造函数，这个临时对象传入到 <code>vec</code> 中</li></ol><p>在代码 <code>vec.push_back(std::move(b));</code>中，对应的一行输出</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>Move constructing MyClass with value <span style=color:#bd93f9>10</span>
</span></span></code></pre></div><p>因为是使用的 <code>std::move</code> 函数，所以直接通过移动构造函数把值放到 <code>vec</code> 中</p><p>最后一行 <code>Move constructing MyClass with value 20</code> 输出是因为在 <code>vec.push_back(std::move(b));</code>时，<code>vec</code> 发生了扩容，<code>MyClass(20)</code> 这个对象发生了一次移动。</p><p>看到这里，大概能对 <code>move</code> 函数有大概的了解了。可能也会产生一个疑问，为什么要使用<code>move</code> 函数呢？</p><p>首先我们要明确一个点，在C++中，变量的赋值默认都是拷贝行为。所谓的引用传递参数，不过是编译器实现的一种指针，本质是对内存地址的一次拷贝。</p><p>拷贝会带来什么问题呢？其中一个问题就是，在传递大的对象时，需要把对象的成员变量都复制一次。上面例子中的 <code>MyClass</code> 中只有一个 <code>int value_</code> 类型的成员变量开销比较小，如果成员变量很多，而且类型复杂，那每次传递变量都复制一次，这个开销就不能忽视了。</p><h3 id=move分析><a href=#move%e5%88%86%e6%9e%90 class=header-anchor></a>move分析</h3><p>回到 <code>move</code> 函数，移动语义允许将资源的 <strong>所有权</strong> 从一个对象转移到另一个对象，而无需深拷贝。</p><p>看到这里，是否好奇 <code>move</code> 函数为什么有如此魔力，是怎样实现的呢</p><p>下面就是 <code>move</code> 函数的常见实现方式</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>template</span><span style=color:#ff79c6>&lt;</span><span style=color:#ff79c6>typename</span> T<span style=color:#ff79c6>&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#ff79c6>typename</span> std<span style=color:#ff79c6>::</span>remove_reference<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;::</span>type<span style=color:#ff79c6>&amp;&amp;</span> move(T<span style=color:#ff79c6>&amp;&amp;</span> t) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>    <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>static_cast</span><span style=color:#ff79c6>&lt;</span><span style=color:#ff79c6>typename</span> std<span style=color:#ff79c6>::</span>remove_reference<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;::</span>type<span style=color:#ff79c6>&amp;&amp;&gt;</span>(t);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>}
</span></span></code></pre></div><p>看着挺复杂的，可以将这段代码简化一下，简化后大概就是这个样子</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>template</span> <span style=color:#ff79c6>&lt;</span><span style=color:#ff79c6>typename</span> T<span style=color:#ff79c6>&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>T <span style=color:#ff79c6>&amp;&amp;</span>move(T <span style=color:#ff79c6>&amp;</span>t) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>  <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>static_cast</span><span style=color:#ff79c6>&lt;</span>T <span style=color:#ff79c6>&amp;&amp;&gt;</span>(t);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>}
</span></span></code></pre></div><p>这样看下来，<code>move</code> 函数其实就做了一件事 <strong>接受一个通用引用(T&&)，然后通过 static_cast 将其转换为右值引用</strong></p><p><code>move</code> 的本意是提前让一个对象“将亡”，然后把控制权“移交”给右值引用，所以才叫<code>move</code>，也就是“移动语义”。但是，C++并不能真正让一个对象提前“亡”，所以这里的“移动”仅仅是“语义”上的，并不是实际的。只是告诉编译器，这个对象我不需要了，可以绑定到右值引用上了。</p><p>有个点需要注意一下，移动构造函数需要加上 <code>noexcept</code> 虽然不加也能正常执行，但是在使用容器等 STL 库时，如果对象的 移动构造函数没有 声明为 <code>noexcept</code> 可能会导致不会使用移动构造，而是使用拷贝构造。</p><p>再讨论一下上文中提到的 <strong>所有权</strong>，这个概念我最早是从 <strong>rust</strong> 中了解到的，后来在C++中，使用 <code>std::unique_ptr</code> 智能指针的时候，逐渐对所有权这个概念有了一些理解。</p><p>书接上面的例子</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>func1</span>(std<span style=color:#ff79c6>::</span>unique_ptr<span style=color:#ff79c6>&lt;</span>MyClass<span style=color:#ff79c6>&gt;</span> ptr)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>func2</span>(std<span style=color:#ff79c6>::</span>unique_ptr<span style=color:#ff79c6>&lt;</span>MyClass<span style=color:#ff79c6>&gt;&amp;</span> ptr)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>main</span>() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    std<span style=color:#ff79c6>::</span>unique_ptr<span style=color:#ff79c6>&lt;</span>MyClass<span style=color:#ff79c6>&gt;</span> ptr1 <span style=color:#ff79c6>=</span> std<span style=color:#ff79c6>::</span>make_unique<span style=color:#ff79c6>&lt;</span>MyClass<span style=color:#ff79c6>&gt;</span>(<span style=color:#bd93f9>30</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#ff79c6>auto</span> ptr2 <span style=color:#ff79c6>=</span> ptr1; <span style=color:#6272a4>//编译报错
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#6272a4></span>    func1(ptr1); <span style=color:#6272a4>//编译报错
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#6272a4></span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    <span style=color:#ff79c6>auto</span> ptr3 <span style=color:#ff79c6>=</span> std<span style=color:#ff79c6>::</span>move(ptr1);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    func2(ptr3);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    func1(std<span style=color:#ff79c6>::</span>move(ptr2));
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>}
</span></span></code></pre></div><p><code>ptr1</code> 这个智能指针拥有该对象的所有权，如果尝试将这个指针复制给 <code>ptr2</code> 这个指针那么编译器会报错，因为 <code>std::unique_ptr</code> 类型的指针只允许一个指针对象持有 <code>MyClass</code> 这个对象的所有权。复制行为是将所有权共享，所以会提示错误。</p><p>能做到只能是将所有权转移，也就是 <code>ptr1</code> 指针放弃所有权，将所有权交给 <code>ptr3</code> 这个指针。同样的，在作为函数的参数传递时，也是同样的道理，作为 <code>func1</code> 函数的参数时，只能使用 <code>move</code>，将所有权转移。</p><p>还有一种方式，<strong>借</strong>，在函数 <code>func2</code> 中，可以使用引用的方式，将所有权暂时 <strong>‘借’</strong> 给 <code>func2</code> 中的变量使用，但是所有权还在原来的所有者那里。</p><h3 id=move函数的优先级><a href=#move%e5%87%bd%e6%95%b0%e7%9a%84%e4%bc%98%e5%85%88%e7%ba%a7 class=header-anchor></a>move函数的优先级</h3><p>如果一个 class 实现了 移动构造函数，在赋值时，是否一定会使用 <code>move</code> 呢？答案是不一定，是否优先使用移动构造函数取决于具体的情境。</p><p>先来看一下 <strong>拷贝构造函数</strong> 和 <strong>移动构造函数</strong> 的签名</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>MyClass(<span style=color:#ff79c6>const</span> MyClass<span style=color:#ff79c6>&amp;</span> other);<span style=color:#6272a4>//拷贝构造
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span>MyClass(MyClass<span style=color:#ff79c6>&amp;&amp;</span> other) <span style=color:#ff79c6>noexcept</span>;<span style=color:#6272a4>//移动构造
</span></span></span></code></pre></div><p>可以看到，移动构造函数的参数类型是 <strong>右值引用</strong>。</p><p>也就是说，优先级规则是这样的</p><ul><li>如果实参是 <strong>左值</strong>，编译器会调用拷贝构造函数</li><li>如果实参是 <strong>右值</strong>，并且存在移动构造函数，编译器会优先调用移动构造函数</li></ul><p>但这里的关键是：<strong>复制</strong> 这个行为是否涉及右值。如果代码没有显式地将对象标记为右值（比如使用 std::move），即使有移动构造函数，也不会被调用。</p><h3 id=使用move注意事项><a href=#%e4%bd%bf%e7%94%a8move%e6%b3%a8%e6%84%8f%e4%ba%8b%e9%a1%b9 class=header-anchor></a>使用move注意事项</h3><ul><li><p>移动后对象的状态：调用 <code>std::move</code> 后，源对象并没有被销毁，但它处于一个“有效但未指定”的状态（valid but unspecified state）。比如对于 <code>std::string</code>，它可能变为空字符串，但具体取决于类的实现。</p></li><li><p>不保证移动：<code>std::move</code> 只是请求移动，能否真正移动取决于目标类型是否实现了移动构造函数或移动赋值运算符。如果没有，编译器会回退到拷贝。</p></li><li><p>不要滥用：只有当你确定某个对象不再需要时，才应该使用 <code>std::move</code>。</p></li></ul><h2 id=forward><a href=#forward class=header-anchor></a>forward</h2><p>说完了 <code>std::move</code> 那就不得不提 <code>std::forward</code> 了。<code>forward</code>也叫 <strong>完美转发</strong></p><p>和 <code>move</code> 不同的地方，<code>forward</code> 常用在模板编程中，以确保参数能够按照原始值类别（左值或右值）传递给下一个函数，而不会丢失其属性。在模板编程中，一般都是希望将参数传递给另一个函数时，保留参数的原始值类型。
但是 <code>std::move</code> 总是将对象无条件转换为右值，而 <code>std::forward</code> 则根据参数的原始类型有条件地进行转发。</p><ul><li>如果传入的是 <strong>左值</strong>，则以左值的形式转发。</li><li>如果传入的是 <strong>右值</strong>，则以右值的形式转发。</li></ul><h3 id=forward例子><a href=#forward%e4%be%8b%e5%ad%90 class=header-anchor></a>forward例子</h3><p>通过一个简单的例子看一下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>#include</span> <span style=color:#ff79c6>&lt;iostream&gt;</span><span style=color:#ff79c6>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#ff79c6></span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>process</span>(<span style=color:#8be9fd>int</span><span style=color:#ff79c6>&amp;</span> x) { std<span style=color:#ff79c6>::</span>cout <span style=color:#ff79c6>&lt;&lt;</span> <span style=color:#f1fa8c>&#34;Lvalue: &#34;</span> <span style=color:#ff79c6>&lt;&lt;</span> x <span style=color:#ff79c6>&lt;&lt;</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>; }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>process</span>(<span style=color:#8be9fd>int</span><span style=color:#ff79c6>&amp;&amp;</span> x) { std<span style=color:#ff79c6>::</span>cout <span style=color:#ff79c6>&lt;&lt;</span> <span style=color:#f1fa8c>&#34;Rvalue: &#34;</span> <span style=color:#ff79c6>&lt;&lt;</span> x <span style=color:#ff79c6>&lt;&lt;</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>; }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#ff79c6>template</span><span style=color:#ff79c6>&lt;</span><span style=color:#ff79c6>typename</span> T<span style=color:#ff79c6>&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#8be9fd>void</span> forwarder(T<span style=color:#ff79c6>&amp;&amp;</span> arg) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    process(arg); <span style=color:#6272a4>// 直接传递 arg
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#6272a4></span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>main</span>() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#8be9fd>int</span> a <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>42</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    forwarder(a);      <span style=color:#6272a4>// 传入左值
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#6272a4></span>    forwarder(<span style=color:#bd93f9>100</span>);    <span style=color:#6272a4>// 传入右值
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>return</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>}
</span></span></code></pre></div><p>执行结果:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>Lvalue: <span style=color:#bd93f9>42</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>Lvalue: <span style=color:#bd93f9>100</span>
</span></span></code></pre></div><ul><li><code>a</code> 是左值，转发为左值，调用 <code>process(int&)</code></li><li><code>100</code> 是右值，转发为右值，调用 <code>process(int&&)</code></li></ul><p><code>process</code> 函数有两个重载，分别是 <strong>左值引用</strong> 和 <strong>右值引用</strong>，<code>forwarder</code> 函数可以根据不同的类型调用不同的 <code>process</code>，也就实现了 <strong>转发</strong></p><h3 id=实现原理><a href=#%e5%ae%9e%e7%8e%b0%e5%8e%9f%e7%90%86 class=header-anchor></a>实现原理</h3><p><code>std::forward</code> 的实现依赖于 <a class=link href=/posts/567e834f/#%e5%bc%95%e7%94%a8%e6%8a%98%e5%8f%a0>引用折叠</a>和类型推导，下面是 <code>forward</code> 函数实现</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>template</span><span style=color:#ff79c6>&lt;</span><span style=color:#ff79c6>typename</span> T<span style=color:#ff79c6>&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>T<span style=color:#ff79c6>&amp;&amp;</span> forward(<span style=color:#ff79c6>typename</span> std<span style=color:#ff79c6>::</span>remove_reference<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;::</span>type<span style=color:#ff79c6>&amp;</span> arg) <span style=color:#ff79c6>noexcept</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>    <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>static_cast</span><span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&amp;&amp;&gt;</span>(arg);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span><span style=color:#ff79c6>template</span><span style=color:#ff79c6>&lt;</span><span style=color:#ff79c6>typename</span> T<span style=color:#ff79c6>&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>T<span style=color:#ff79c6>&amp;&amp;</span> forward(<span style=color:#ff79c6>typename</span> std<span style=color:#ff79c6>::</span>remove_reference<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;::</span>type<span style=color:#ff79c6>&amp;&amp;</span> arg) <span style=color:#ff79c6>noexcept</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span>    <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>static_cast</span><span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&amp;&amp;&gt;</span>(arg);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9</span><span>}
</span></span></code></pre></div><ul><li>传入左值时，<code>T</code> 推导为 <code>Type&</code>，<code>T&&</code> 折叠为左值引用</li><li>传入右值时，<code>T</code> 推导为 <code>Type</code>，<code>T&&</code> 保持为右值引用</li></ul><p><code>std::forward</code> 与 <code>std::move</code> 相比，它更 <strong>智能</strong>，适用于需要动态适配参数类型的场景。一般用在模板编程中，确保参数在传递过程中保留原始的 <strong>左值</strong> / <strong>右值属性</strong>，避免不必要的拷贝。</p><h2 id=rvo><a href=#rvo class=header-anchor></a>RVO</h2><p><strong>RVO</strong>（Return Value Optimization，返回值优化，是C++编译器的一种优化技术，用于减少函数返回大对象时的拷贝开销。在没有 <strong>RVO</strong> 的情况下，函数返回一个对象时，会调用拷贝构造函数或移动构造函数来构造返回值对象。<strong>RVO</strong> 的目标是直接在调用者的内存空间中构造返回对象，从而避免额外的拷贝或移动。</p><p>RVO 有两种形式</p><ul><li><strong>NRVO</strong>（Named Return Value Optimization）：针对命名的局部变量</li><li><strong>URVO</strong>（Unnamed Return Value Optimization）：针对临时对象（未命名的对象）</li></ul><h3 id=rvo例子><a href=#rvo%e4%be%8b%e5%ad%90 class=header-anchor></a>RVO例子</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>#include</span> <span style=color:#ff79c6>&lt;iostream&gt;</span><span style=color:#ff79c6>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#ff79c6></span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#ff79c6>struct</span> <span style=color:#50fa7b>MyClass</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    MyClass() { std<span style=color:#ff79c6>::</span>cout <span style=color:#ff79c6>&lt;&lt;</span> <span style=color:#f1fa8c>&#34;Constructor</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>; }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    MyClass(<span style=color:#ff79c6>const</span> MyClass<span style=color:#ff79c6>&amp;</span>) { std<span style=color:#ff79c6>::</span>cout <span style=color:#ff79c6>&lt;&lt;</span> <span style=color:#f1fa8c>&#34;Copy constructor</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>; }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    MyClass(MyClass<span style=color:#ff79c6>&amp;&amp;</span>) <span style=color:#ff79c6>noexcept</span> { std<span style=color:#ff79c6>::</span>cout <span style=color:#ff79c6>&lt;&lt;</span> <span style=color:#f1fa8c>&#34;Move constructor</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>; }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#ff79c6>~</span>MyClass() { std<span style=color:#ff79c6>::</span>cout <span style=color:#ff79c6>&lt;&lt;</span> <span style=color:#f1fa8c>&#34;Destructor</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>; }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>};
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>MyClass <span style=color:#50fa7b>create</span>() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    MyClass obj;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#ff79c6>return</span> obj; <span style=color:#6272a4>// 返回局部对象
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#6272a4></span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>main</span>() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    MyClass a <span style=color:#ff79c6>=</span> create();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    <span style=color:#ff79c6>return</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>}
</span></span></code></pre></div><p>现在的编译器默认都会开启 <strong>RVO</strong> 优化，所以需要手动禁用，在clang中，可以在命令行中添加 <code>-fno-elide-constructors</code> 来禁用。</p><p>使用 <code>clang++ -fno-elide-constructors -o main main.cpp</code> 命令来编译，然后执行 <code>main</code>，输出如下</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>Constructor
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>Move constructor
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>Destructor
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>Destructor
</span></span></code></pre></div><p>可以看到在 <code>return obj</code> 时，因为没有使用 <strong>RVO</strong> 优化，所以复制了一次对象，但是因为有移动构造函数，所以使用了 <code>move</code> 优化。</p><p>下面开启 <strong>RVO</strong> 优化看一下</p><p>使用 <code>clang++ -o main main.cpp</code> 命令编译，然后执行 <code>main</code> 输出如下</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>Constructor
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>Destructor
</span></span></code></pre></div><p>可以看到只调用了构造函数。</p><h3 id=工作原理><a href=#%e5%b7%a5%e4%bd%9c%e5%8e%9f%e7%90%86 class=header-anchor></a>工作原理</h3><p><a class=link href=https://godbolt.org/ target=_blank rel=noopener>在线汇编</a> 使用这个工具，可以看到具体的汇编代码</p><p>下面是是让GPT加了注释的汇编代码</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#50fa7b>create</span>():                           <span style=color:#6272a4>; create() 函数定义开始
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span>        <span style=color:#50fa7b>push</span>    rbp                 <span style=color:#6272a4>; 保存当前栈帧基址指针
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#6272a4></span>        <span style=color:#50fa7b>mov</span>     rbp, rsp            <span style=color:#6272a4>; 建立新的栈帧，将栈指针值赋给基址指针
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#6272a4></span>        <span style=color:#50fa7b>sub</span>     rsp, <span style=color:#bd93f9>16</span>             <span style=color:#6272a4>; 分配16字节的栈空间用于局部变量
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#6272a4></span>        <span style=color:#50fa7b>mov</span>     QWORD PTR [rbp-8], rdi  <span style=color:#6272a4>; 保存第一个参数(rdi)到栈上[rbp-8]位置，这是对象指针
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#6272a4></span>        <span style=color:#50fa7b>mov</span>     rax, QWORD PTR [rbp-8]  <span style=color:#6272a4>; 将对象指针加载到rax寄存器
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#6272a4></span>        <span style=color:#50fa7b>mov</span>     rdi, rax            <span style=color:#6272a4>; 将对象指针作为第一个参数(rdi)传递给构造函数
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#6272a4></span>        <span style=color:#50fa7b>call</span>    MyClass::MyClass() [complete object constructor]  <span style=color:#6272a4>; 调用MyClass的构造函数初始化对象
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#6272a4></span>        <span style=color:#50fa7b>mov</span>     rax, QWORD PTR [rbp-8]  <span style=color:#6272a4>; 将对象指针重新加载到rax作为函数返回值
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#6272a4></span>        <span style=color:#50fa7b>leave</span>                       <span style=color:#6272a4>; 恢复栈帧（相当于mov rsp, rbp; pop rbp）
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#6272a4></span>        <span style=color:#50fa7b>ret</span>                         <span style=color:#6272a4>; 从函数返回，返回值在rax中
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#6272a4></span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#8be9fd;font-style:italic>main:</span>                               <span style=color:#6272a4>; main函数定义开始
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#6272a4></span>        <span style=color:#50fa7b>push</span>    rbp                 <span style=color:#6272a4>; 保存当前栈帧基址指针
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#6272a4></span>        <span style=color:#50fa7b>mov</span>     rbp, rsp            <span style=color:#6272a4>; 建立新的栈帧
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#6272a4></span>        <span style=color:#50fa7b>push</span>    rbx                 <span style=color:#6272a4>; 保存rbx寄存器的值(调用者保存的寄存器)
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#6272a4></span>        <span style=color:#50fa7b>sub</span>     rsp, <span style=color:#bd93f9>24</span>             <span style=color:#6272a4>; 分配24字节的栈空间
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#6272a4></span>        <span style=color:#50fa7b>lea</span>     rax, [rbp-17]       <span style=color:#6272a4>; 将栈上地址[rbp-17]加载到rax，这是为MyClass对象分配的空间
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#6272a4></span>        <span style=color:#50fa7b>mov</span>     rdi, rax            <span style=color:#6272a4>; 将对象地址作为参数传递给create函数
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style=color:#6272a4></span>        <span style=color:#50fa7b>call</span>    create()            <span style=color:#6272a4>; 调用create函数，初始化对象
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#6272a4></span>        <span style=color:#50fa7b>mov</span>     ebx, <span style=color:#bd93f9>0</span>              <span style=color:#6272a4>; 将返回值0存储到ebx寄存器
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#6272a4></span>        <span style=color:#50fa7b>lea</span>     rax, [rbp-17]       <span style=color:#6272a4>; 重新加载对象地址到rax
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#6272a4></span>        <span style=color:#50fa7b>mov</span>     rdi, rax            <span style=color:#6272a4>; 将对象地址作为参数传递给析构函数
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span><span style=color:#6272a4></span>        <span style=color:#50fa7b>call</span>    MyClass::~MyClass() [complete object destructor]  <span style=color:#6272a4>; 调用MyClass的析构函数清理对象
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span><span style=color:#6272a4></span>        <span style=color:#50fa7b>mov</span>     eax, ebx            <span style=color:#6272a4>; 将返回值(0)从ebx移动到eax作为main函数的返回值
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span><span style=color:#6272a4></span>        <span style=color:#50fa7b>mov</span>     rbx, QWORD PTR [rbp-8]  <span style=color:#6272a4>; 恢复之前保存的rbx值
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span><span style=color:#6272a4></span>        <span style=color:#50fa7b>leave</span>                       <span style=color:#6272a4>; 恢复栈帧
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span><span style=color:#6272a4></span>        <span style=color:#50fa7b>ret</span>                         <span style=color:#6272a4>; 从main函数返回，返回值在eax中
</span></span></span></code></pre></div><p>可以看到开启 <strong>ROV</strong> 优化后，确实是先在 <code>main</code> 函数的栈空间 先初始化 <code>MyClass</code> 的对象，所以可以避免在 return 时拷贝。</p><p><strong>RVO</strong> 的核心思想是：编译器在生成代码时，识别出函数返回的对象可以直接在调用者的目标位置构造，而不是先在函数栈上构造然后拷贝或移动到调用者。</p><p>在 C++17 之前，<strong>RVO</strong> 是一种编译器可选的优化，程序员不能完全依赖它。从 C++17 开始，标准对某些情况下的返回值优化做了强制要求，称为 Mandatory Copy Elision（强制拷贝消除）。这意味着在特定场景下，即使禁用优化，编译器也必须消除拷贝或移动。</p><h3 id=rvo-和-stdmove-的关系><a href=#rvo-%e5%92%8c-stdmove-%e7%9a%84%e5%85%b3%e7%b3%bb class=header-anchor></a>RVO 和 std::move 的关系</h3><p>一般来说，使用了 <strong>move</strong> 后就不会再使用 <strong>RVO</strong> 了</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>MyClass <span style=color:#50fa7b>create</span>() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>    MyClass obj;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>    <span style=color:#ff79c6>return</span> std<span style=color:#ff79c6>::</span>move(obj); <span style=color:#6272a4>// 显式移动
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#6272a4></span>}
</span></span></code></pre></div><p>改一下上面的例子，开启 ROV优化看一下</p><p><code>clang++ -O3 -o main main.cpp</code> 编译 执行 <code>main</code></p><p>输出：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>Constructor
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>Move constructor
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>Destructor
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>Destructor
</span></span></code></pre></div><p>所以，在编写现代C++代码时，在 <strong>return</strong> 局部变量时没有必要使用 <code>std::move</code>,使用了大概率会影响编译器优化，反而会适得其反，性能更差了。</p><p>所以相信编译器，很多情况下，编译器会比人更 ‘聪明’。</p><h2 id=总结><a href=#%e6%80%bb%e7%bb%93 class=header-anchor></a>总结</h2><ol><li><code>std::move</code> 不会改变对象的内容(不会移动)，只是欺骗了编译器</li><li><code>std::move</code> 只是请求移动，能否真正移动取决于目标类型是否实现了移动构造函数或移动赋值运算符。如果没有，编译器会回退到拷贝</li><li><strong>左值</strong>：调用拷贝构造函数，<strong>右值</strong>: 如果有移动构造函数，优先调用移动构造函数；否则回退到拷贝构造函数</li><li><code>std::forward</code> 有条件地转发参数，保留其原始值类别（<strong>左值</strong>或<strong>右值</strong>）</li><li>函数返回一个对象时，除非需要显示调用移动或者拷贝构造，否则不要使用 <code>std::move</code>，而是使用编译器的 <strong>RVO</strong> 优化</li></ol></section><footer class=article-footer><section class=article-tags><a href=/tags/c++/>C++</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>Licensed under CC BY-NC-SA 4.0</a></span></section><section class=article-copyright>暂时还懒得去弄评论区，有问题欢迎 <a href=mailto:lqxlucky@qq.com title=lqxlucky@qq.com rel=noopener target=_blank>邮件</a> 交流</section></footer><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css integrity=sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js integrity=sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8 crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous defer></script><script>window.addEventListener("DOMContentLoaded",()=>{renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}],ignoredClasses:["gist"]})})</script></article><aside class=related-content--wrapper><h2 class=section-title>相关文章</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/posts/541b707d/><div class=article-image><img src=https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/6271dad17bae0c4a3d2fd061106001be135c745e.jpg loading=lazy data-key=541b707d data-hash=https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/6271dad17bae0c4a3d2fd061106001be135c745e.jpg></div><div class=article-details><h2 class=article-title>C++20协程入门篇</h2></div></a></article><article class=has-image><a href=/posts/567e834f/><div class=article-image><img src=https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/0677f36b25f64ef20bd9b0ff4317dee12d1c8c4e.jpg loading=lazy data-key=567e834f data-hash=https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/0677f36b25f64ef20bd9b0ff4317dee12d1c8c4e.jpg></div><div class=article-details><h2 class=article-title>C++变量生命周期</h2></div></a></article><article class=has-image><a href=/posts/f0e9829c/><div class=article-image><img src=https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/6a84474a44a97bccecbbc9c5a3b9f7aea2571c97.jpg loading=lazy data-key=f0e9829c data-hash=https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/6a84474a44a97bccecbbc9c5a3b9f7aea2571c97.jpg></div><div class=article-details><h2 class=article-title>Linux下使用iouring实现一个tcp服务</h2></div></a></article><article class=has-image><a href=/posts/b810e905/><div class=article-image><img src=https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/7e0d79d47f0173b9b7a0c351c5d719303aa0f0e8.png loading=lazy data-key=b810e905 data-hash=https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/7e0d79d47f0173b9b7a0c351c5d719303aa0f0e8.png></div><div class=article-details><h2 class=article-title>C++动态加载so/dll库</h2></div></a></article><article><a href=/posts/d9a4c4a4/><div class=article-details><h2 class=article-title>pika编译笔记</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2021 -
2025 QX 的笔记</section><section class=totalcount>发表了65篇文章 ·
总计159.74k字</section><footer class=running-time>本博客已稳定运行
<span id=runningdays class=running-days></span></footer><section class=powerby>© QX<br>使用 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> 构建<br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.27.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script><script>let s1="2021-10-1";s1=new Date(s1.replace(/-/g,"/"));let s2=new Date,timeDifference=s2.getTime()-s1.getTime(),days=Math.floor(timeDifference/(1e3*60*60*24)),hours=Math.floor(timeDifference%(1e3*60*60*24)/(1e3*60*60)),minutes=Math.floor(timeDifference%(1e3*60*60)/(1e3*60)),result=days+"天"+hours+"小时"+minutes+"分钟";document.getElementById("runningdays").innerHTML=result</script></body></html>