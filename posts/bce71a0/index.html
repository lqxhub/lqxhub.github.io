<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="redis的网络处理是redis的核心功能之一，redis的网络处理是单线程的，这里通过源码分析，来看一下redis是如何处理网络的。"><meta name=keywords content="redis,源码,网络"><title>redis源码学习|网络 redis 网络部分源码分析，学习。redis网络多路复用 - QX's blog</title>
<link rel=canonical href=https://lqxhub.github.io/posts/bce71a0/><link rel=stylesheet href=/scss/style.min.cf20c5703e90831fa8051409d1786e3338f2624d07c5fe5f37ce747dbe09923c.css><meta property='og:title' content="redis源码学习|网络 redis 网络部分源码分析，学习。redis网络多路复用 - QX's blog"><meta property='og:description' content="redis的网络处理是redis的核心功能之一，redis的网络处理是单线程的，这里通过源码分析，来看一下redis是如何处理网络的。"><meta property='og:url' content='https://lqxhub.github.io/posts/bce71a0/'><meta property='og:site_name' content='QX 的笔记'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='redis'><meta property='article:published_time' content='2024-01-28T20:10:27+00:00'><meta property='article:modified_time' content='2024-01-28T20:10:27+00:00'><meta property='og:image' content='https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/OIP-C.R8n6zHAP4N2M01vSoRwkSQHaDW'><meta name=twitter:title content="redis源码学习|网络 redis 网络部分源码分析，学习。redis网络多路复用 - QX's blog"><meta name=twitter:description content="redis的网络处理是redis的核心功能之一，redis的网络处理是单线程的，这里通过源码分析，来看一下redis是如何处理网络的。"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/OIP-C.R8n6zHAP4N2M01vSoRwkSQHaDW'><link rel="shortcut icon" href=/favicon.ico><meta name=google-site-verification content="Ts78qICcAFtPJZg7DfwjJYFH2BsbYh7ICe1k6xMb-C8"><meta name=msvalidate.01 content="C538647907B2EAEBE650AAC7463E551F"><script async src="https://www.googletagmanager.com/gtag/js?id=G-BM48R77LCS"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-BM48R77LCS")</script><script src=https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js></script><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css><script src=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js></script><script src=https://fastly.jsdelivr.net/gh/stevenjoezhang/live2d-widget@latest/autoload.js></script><style>#waifu #live2d{cursor:grab;height:260px;position:relative;width:260px}#waifu-tips{width:230px}</style><div class=top-scroll-bar></div><style>.top-scroll-bar{position:fixed;top:0;left:0;z-index:9999;display:none;width:0;height:3px;background:#ef3982}</style><script>$(document).ready(function(){$(window).scroll(function(){$(".top-scroll-bar").attr("style","width: "+$(this).scrollTop()/($(document).height()-$(this).height())*100+"%; display: block;")})})</script><div id=back-top><a href=#top title=回到顶部></a></div><style>#back-top{position:fixed;bottom:30px;right:80px}#back-top a{width:54px;height:54px;display:block;background:#ddd url(/images/back_top.svg)no-repeat 50%;background-color:rgba(218,214,214,.87);-webkit-border-radius:7px;-moz-border-radius:7px;border-radius:7px;-webkit-transition:1s;-moz-transition:1s;transition:1s}#back-top a:hover{background-color:#e88282}</style><script type=text/javascript>$("#back-top").hide(),$(document).ready(function(){$(window).scroll(function(){$(this).scrollTop()>100?$("#back-top").fadeIn():$("#back-top").fadeOut()}),$("#back-top a").click(function(){return $("body,html").animate({scrollTop:0},800),!1})})</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu14972274666183315035.gif width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>😉</span></figure><div class=site-meta><h1 class=site-name><a href=/>QX 的笔记</a></h1><h2 class=site-description>雄关漫道真如铁，而今迈步从头越</h2></div></header><ol class=menu-social><li><a href=mailto:lqxlucky@qq.com target=_blank title=Email rel=me><svg fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" class="icon icon-tabler icon-tabler-mail-flat"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 4h16a2 2 0 012 2v12a2 2 0 01-2 2H4a2 2 0 01-2-2V6a2 2 0 012-2z"/><path d="M4 6l8 5 8-5"/></svg></a></li><li><a href=https://github.com/lqxhub target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=/index.xml target=_blank title="RSS Feed" rel=me><svg class="icon icon-tabler icon-tabler-rss" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="5" cy="19" r="1"/><path d="M4 4a16 16 0 0116 16"/><path d="M4 11a9 9 0 019 9"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>首页</span></a></li><li><a href=/categories><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg>
<span>分类</span></a></li><li><a href=/archives><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>归档</span></a></li><li><a href=/tags><svg class="icon icon-tabler icon-tabler-tag" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11 3l9 9a1.5 1.5.0 010 2l-6 6a1.5 1.5.0 01-2 0L3 11V7a4 4 0 014-4h4"/><circle cx="9" cy="9" r="2"/></svg>
<span>标签</span></a></li><li><a href=/collect><svg fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" class="icon icon-tabler icon-tabler-bookmark"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 4h14a1 1 0 011 1v16l-8-4-8 4V5a1 1 0 011-1z"/></svg>
<span>收藏</span></a></li><li><a href=/tool><svg fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" class="icon icon-tabler icon-tabler-tools"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 15l-4 4m0-4 4 4"/><path d="M15 9l4-4m0 4-4-4"/><path d="M9 9l6 6"/><path d="M12 12l2-2"/><path d="M15 15l-2 2"/></svg>
<span>工具</span></a></li><li><a href=/friend><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>友链</span></a></li><li><a href=/search><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>搜索</span></a></li><li><a href=/about><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>关于</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>暗色模式</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#数据结构>数据结构：</a></li><li><a href=#启动网络服务>启动网络服务</a><ol><li><a href=#监听client>监听client</a></li><li><a href=#监听cluster>监听cluster</a></li></ol></li><li><a href=#网络读写处理>网络读写处理</a><ol><li><a href=#listener-回调>Listener 回调</a></li></ol></li><li><a href=#处理client读写>处理client读写</a><ol><li><a href=#读处理>读处理</a></li><li><a href=#写处理>写处理</a></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/posts/bce71a0/><img src=https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/OIP-C.R8n6zHAP4N2M01vSoRwkSQHaDW loading=lazy alt="Featured image of post redis源码学习|网络 redis 网络部分源码分析，学习。redis网络多路复用 - QX's blog"></a></div><div class=article-details><header class=article-category><a href=/categories/redis/>redis</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/posts/bce71a0/>redis源码学习|网络</a></h2><h3 class=article-subtitle>redis的网络处理是redis的核心功能之一，redis的网络处理是单线程的，这里通过源码分析，来看一下redis是如何处理网络的。</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Jan 28, 2024</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>阅读时长: 16 分钟</time></div></footer></div></header><section class=article-content><p>去年写过两篇redis的源码分析文章（redis的watch和ACL），现在回头看，已经过去好久了。说起那两篇文章，收益还是挺大的。这周有时间了，继续学习redis的源码。先来看一下redis的网络处理。</p><p>本次的源码基于redis的 <strong>7.2</strong> 分支，不同版本下，一些细节可能会有差异。</p><p>这篇文章因为篇幅所限，没法把redis网络读写的所有细节都分析到，只能把这个网络处理的大概流程走一遍。</p><p>看完这篇文章，能对redis网络处理流程有个基本了解，能知道redis加入了多线程后，为什么还是单线程处理数据。能知道redis是如何实现适配不同系统下网络接口。</p><p>先来写一下redis网络需要的一些数据结构。</p><h2 id=数据结构><a href=#%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84 class=header-anchor></a>数据结构：</h2><ul><li>redis可以支持多个平台（Linux，Unix），这两个平台的网络调用是不一样的，Linux中高性能的网络接口是<strong>epoll</strong>，Unix上是<strong>kqueue</strong>。因为版本的原因，在低版本的Linux内核中，epool也是不支持的，这时候就需要用到<strong>select</strong>。redis使用了 <strong>aeEvent</strong> 这个结构来封装了网络，实现了对不同网络接口的兼容。</li></ul><p>结构的定义在 <code>ae.h</code> 文件中 <a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/ae.h#L99-L111 target=_blank rel=noopener>aeEventLoop</a></p><p><strong>aeEventLoop</strong> 是redis网络中，所有网络事件的管理器。我们知道，现在的网络一般都是通过多路复用来处理多个链接，多路复用的实现在不同的系统中有不同的实现，所有redis使用 <code>aeEventLoop</code> 的封装来实现不同平台的兼容。这个结构是全局唯一的，redis启动后完成初始化。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>typedef</span> <span style=color:#ff79c6>struct</span> aeEventLoop {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    <span style=color:#8be9fd>int</span> maxfd;   <span style=color:#6272a4>/* highest file descriptor currently registered */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#8be9fd>int</span> setsize; <span style=color:#6272a4>/* max number of file descriptors tracked */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#8be9fd>long</span> <span style=color:#8be9fd>long</span> timeEventNextId;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    aeFileEvent <span style=color:#ff79c6>*</span>events; <span style=color:#6272a4>/* Registered events */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    aeFiredEvent <span style=color:#ff79c6>*</span>fired; <span style=color:#6272a4>/* Fired events */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    aeTimeEvent <span style=color:#ff79c6>*</span>timeEventHead;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#8be9fd>int</span> stop;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#8be9fd>void</span> <span style=color:#ff79c6>*</span>apidata; <span style=color:#6272a4>/* This is used for polling API specific data */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    aeBeforeSleepProc <span style=color:#ff79c6>*</span>beforesleep;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    aeBeforeSleepProc <span style=color:#ff79c6>*</span>aftersleep;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#8be9fd>int</span> flags;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>} aeEventLoop;
</span></span></code></pre></div><p><code>aeFileEvent</code> 和 <code>aeFiredEvent</code> 是处理网络事件的数组结构，<code>aeTimeEvent</code> 是处理redis定时回调的结构数组。</p><ul><li><code>aeFileEvent</code> 是注册到系统中的事件，在 epoll 中就是 <code>struct epoll_event</code> 结构。</li><li><code>aeFiredEvent</code> 是这次要处理的事件。在 epoll 中就是 通过 <code>epoll_wait</code> 返回的事件。</li><li><code>timeEventHead</code> 是定时器要处理的事件。</li></ul><p><strong>aeFileEvent</strong> 是redis中，多路复用的事件封装。每一个网络链接都会被包装成一个 <code>aeFileEvent</code> 对象，（因为在 Unix系列的系统中，万物皆是文件嘛，所有这里也就叫 <code>aeFileEvent</code>了），然后加入到 <code>aeEventLoop</code> 中，最后交给操作系统中的多路复用管理。当被管理的事件被触发后，会回调对应的函数，也就是 <code>rfileProc</code> 或者 <code>wfileProc</code> 函数指针，来完成操作。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>typedef</span> <span style=color:#ff79c6>struct</span> aeFileEvent {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>    <span style=color:#8be9fd>int</span> mask; <span style=color:#6272a4>/* one of AE_(READABLE|WRITABLE|BARRIER) */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>    aeFileProc <span style=color:#ff79c6>*</span>rfileProc;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>    aeFileProc <span style=color:#ff79c6>*</span>wfileProc;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>    <span style=color:#8be9fd>void</span> <span style=color:#ff79c6>*</span>clientData;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>} aeFileEvent;
</span></span></code></pre></div><p>网络处理的实现在 <code>ae.c</code> 中</p><p>在<code>ae.c</code>中，通过宏定义，来实现对不同平台的兼容</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>#ifdef HAVE_EVPORT
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#ff79c6>#include</span> <span style=color:#ff79c6>&#34;ae_evport.c&#34;</span><span style=color:#ff79c6>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#ff79c6>#else
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#ff79c6></span>    <span style=color:#ff79c6>#ifdef HAVE_EPOLL
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#ff79c6></span>    <span style=color:#ff79c6>#include</span> <span style=color:#ff79c6>&#34;ae_epoll.c&#34;</span><span style=color:#ff79c6>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#ff79c6></span>    <span style=color:#ff79c6>#else
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#ff79c6></span>        <span style=color:#ff79c6>#ifdef HAVE_KQUEUE
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#ff79c6></span>        <span style=color:#ff79c6>#include</span> <span style=color:#ff79c6>&#34;ae_kqueue.c&#34;</span><span style=color:#ff79c6>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#ff79c6></span>        <span style=color:#ff79c6>#else
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#ff79c6></span>        <span style=color:#ff79c6>#include</span> <span style=color:#ff79c6>&#34;ae_select.c&#34;</span><span style=color:#ff79c6>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#ff79c6></span>        <span style=color:#ff79c6>#endif
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#ff79c6></span>    <span style=color:#ff79c6>#endif
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#ff79c6>#endif
</span></span></span></code></pre></div><p><a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/ae.c#L52-L64 target=_blank rel=noopener>ae.c#L52-L65</a>
通过判断宏定义，然后include不同的 .c文件。</p><p>这里可能有对C语言了解不深的同学可能会疑问，<code>include</code> 关键字不是用来包含头文件的吗，还能用来引入 .c文件吗？其实include是编译器的一个预处理指令，就是简单的把对应的文件里的所有内容，放到include的地方而已。</p><p>打开 <code>ae_evport.c</code> <code>ae_epoll.c</code> <code>ae_kqueue.c</code> <code>ae_select.c</code> 这四个文件来看，对外暴露的函数接口都是一样的。只是在不同的平台上内部的处理不同。</p><p>对外暴露了这些函数，来完成网络的处理</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>//创建一个loop
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>static</span> <span style=color:#8be9fd>int</span> <span style=color:#50fa7b>aeApiCreate</span>(aeEventLoop <span style=color:#ff79c6>*</span>eventLoop)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#6272a4>//设置loop的大小
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>static</span> <span style=color:#8be9fd>int</span> <span style=color:#50fa7b>aeApiResize</span>(aeEventLoop <span style=color:#ff79c6>*</span>eventLoop, <span style=color:#8be9fd>int</span> setsize)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#6272a4>//释放一个 loop
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>static</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>aeApiFree</span>(aeEventLoop <span style=color:#ff79c6>*</span>eventLoop)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#6272a4>//添加一个 eventLoop
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>static</span> <span style=color:#8be9fd>int</span> <span style=color:#50fa7b>aeApiAddEvent</span>(aeEventLoop <span style=color:#ff79c6>*</span>eventLoop, <span style=color:#8be9fd>int</span> fd, <span style=color:#8be9fd>int</span> mask)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#6272a4>//删除一个 eventLoop
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>static</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>aeApiDelEvent</span>(aeEventLoop <span style=color:#ff79c6>*</span>eventLoop, <span style=color:#8be9fd>int</span> fd, <span style=color:#8be9fd>int</span> delmask)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#6272a4>//不同的网络处理中,返回需要处理的事件
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>static</span> <span style=color:#8be9fd>int</span> <span style=color:#50fa7b>aeApiPoll</span>(aeEventLoop <span style=color:#ff79c6>*</span>eventLoop, <span style=color:#ff79c6>struct</span> timeval <span style=color:#ff79c6>*</span>tvp)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#6272a4>//返回这个ae的名字,在epoll中就是返回 &#34;epoll&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>static</span> <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span><span style=color:#50fa7b>aeApiName</span>(<span style=color:#8be9fd>void</span>)
</span></span></code></pre></div><p>这里我们以Linux平台为主，所以使用的是 <code>ae_epoll.c</code>文件中的内容。这里先不展开分析每一个函数，因为这不是本次的重点。</p><h2 id=启动网络服务><a href=#%e5%90%af%e5%8a%a8%e7%bd%91%e7%bb%9c%e6%9c%8d%e5%8a%a1 class=header-anchor></a>启动网络服务</h2><p>基本的数据结构介绍完，下面开始启动网络服务</p><h3 id=监听client><a href=#%e7%9b%91%e5%90%acclient class=header-anchor></a>监听client</h3><p>第一步是调用 <code>aeEventLoop *aeCreateEventLoop(int setsize)</code> 函数，创建 <code>aeEventLoop</code> 这个对象。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>aeEventLoop <span style=color:#ff79c6>*</span><span style=color:#50fa7b>aeCreateEventLoop</span>(<span style=color:#8be9fd>int</span> setsize) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    aeEventLoop <span style=color:#ff79c6>*</span>eventLoop;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#8be9fd>int</span> i;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#50fa7b>monotonicInit</span>();    <span style=color:#6272a4>/* just in case the calling app didn&#39;t initialize */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#ff79c6>if</span> ((eventLoop <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>zmalloc</span>(<span style=color:#ff79c6>sizeof</span>(<span style=color:#ff79c6>*</span>eventLoop))) <span style=color:#ff79c6>==</span> <span style=color:#8be9fd;font-style:italic>NULL</span>) <span style=color:#ff79c6>goto</span> err;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    eventLoop<span style=color:#ff79c6>-&gt;</span>events <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>zmalloc</span>(<span style=color:#ff79c6>sizeof</span>(aeFileEvent)<span style=color:#ff79c6>*</span>setsize);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    eventLoop<span style=color:#ff79c6>-&gt;</span>fired <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>zmalloc</span>(<span style=color:#ff79c6>sizeof</span>(aeFiredEvent)<span style=color:#ff79c6>*</span>setsize);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#ff79c6>if</span> (eventLoop<span style=color:#ff79c6>-&gt;</span>events <span style=color:#ff79c6>==</span> <span style=color:#8be9fd;font-style:italic>NULL</span> <span style=color:#ff79c6>||</span> eventLoop<span style=color:#ff79c6>-&gt;</span>fired <span style=color:#ff79c6>==</span> <span style=color:#8be9fd;font-style:italic>NULL</span>) <span style=color:#ff79c6>goto</span> err;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    eventLoop<span style=color:#ff79c6>-&gt;</span>setsize <span style=color:#ff79c6>=</span> setsize;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    eventLoop<span style=color:#ff79c6>-&gt;</span>timeEventHead <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    eventLoop<span style=color:#ff79c6>-&gt;</span>timeEventNextId <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    eventLoop<span style=color:#ff79c6>-&gt;</span>stop <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    eventLoop<span style=color:#ff79c6>-&gt;</span>maxfd <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>-</span><span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    eventLoop<span style=color:#ff79c6>-&gt;</span>beforesleep <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    eventLoop<span style=color:#ff79c6>-&gt;</span>aftersleep <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    eventLoop<span style=color:#ff79c6>-&gt;</span>flags <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    <span style=color:#ff79c6>if</span> (<span style=color:#50fa7b>aeApiCreate</span>(eventLoop) <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>-</span><span style=color:#bd93f9>1</span>) <span style=color:#ff79c6>goto</span> err;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>    <span style=color:#6272a4>/* Events with mask == AE_NONE are not set. So let&#39;s initialize the
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#6272a4>     * vector with it. */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>    <span style=color:#ff79c6>for</span> (i <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; i <span style=color:#ff79c6>&lt;</span> setsize; i<span style=color:#ff79c6>++</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>        eventLoop<span style=color:#ff79c6>-&gt;</span>events[i].mask <span style=color:#ff79c6>=</span> AE_NONE;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>    <span style=color:#ff79c6>return</span> eventLoop;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span><span style=color:#8be9fd;font-style:italic>err</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>    <span style=color:#ff79c6>if</span> (eventLoop) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>        <span style=color:#50fa7b>zfree</span>(eventLoop<span style=color:#ff79c6>-&gt;</span>events);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>        <span style=color:#50fa7b>zfree</span>(eventLoop<span style=color:#ff79c6>-&gt;</span>fired);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>        <span style=color:#50fa7b>zfree</span>(eventLoop);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>    <span style=color:#ff79c6>return</span> <span style=color:#8be9fd;font-style:italic>NULL</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>}
</span></span></code></pre></div><p>这里的处理逻辑比较简单，就是初始化 <code>aeEventLoop</code> 中的数据结构。如果中间出错了，就返回 <code>NULL</code></p><p>这个在 <code>void initServer(void)</code> 函数中被调用。
<a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/server.c#L2622 target=_blank rel=noopener>aeCreateEventLoop</a></p><p>创建一个<code>aeEventLoop</code> 并赋值给 <code>server</code>。再往上翻，最终的调用位置是 <code>main</code> 函数中的<a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/server.c#L7298 target=_blank rel=noopener>initServer();</a></p><p>在往下，还有一个比较重要的函数，通过调用 <a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/server.c#L2711 target=_blank rel=noopener>aeCreateTimeEvent</a> 函数，完成定时器 对应的 <code>eventLoop</code> 的创建。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#8be9fd>long</span> <span style=color:#8be9fd>long</span> <span style=color:#50fa7b>aeCreateTimeEvent</span>(aeEventLoop <span style=color:#ff79c6>*</span>eventLoop, <span style=color:#8be9fd>long</span> <span style=color:#8be9fd>long</span> milliseconds,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>        aeTimeProc <span style=color:#ff79c6>*</span>proc, <span style=color:#8be9fd>void</span> <span style=color:#ff79c6>*</span>clientData,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>        aeEventFinalizerProc <span style=color:#ff79c6>*</span>finalizerProc)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#8be9fd>long</span> <span style=color:#8be9fd>long</span> id <span style=color:#ff79c6>=</span> eventLoop<span style=color:#ff79c6>-&gt;</span>timeEventNextId<span style=color:#ff79c6>++</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    aeTimeEvent <span style=color:#ff79c6>*</span>te;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    te <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>zmalloc</span>(<span style=color:#ff79c6>sizeof</span>(<span style=color:#ff79c6>*</span>te));
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#ff79c6>if</span> (te <span style=color:#ff79c6>==</span> <span style=color:#8be9fd;font-style:italic>NULL</span>) <span style=color:#ff79c6>return</span> AE_ERR;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    te<span style=color:#ff79c6>-&gt;</span>id <span style=color:#ff79c6>=</span> id;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    te<span style=color:#ff79c6>-&gt;</span>when <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>getMonotonicUs</span>() <span style=color:#ff79c6>+</span> milliseconds <span style=color:#ff79c6>*</span> <span style=color:#bd93f9>1000</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    te<span style=color:#ff79c6>-&gt;</span>timeProc <span style=color:#ff79c6>=</span> proc;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    te<span style=color:#ff79c6>-&gt;</span>finalizerProc <span style=color:#ff79c6>=</span> finalizerProc;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    te<span style=color:#ff79c6>-&gt;</span>clientData <span style=color:#ff79c6>=</span> clientData;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    te<span style=color:#ff79c6>-&gt;</span>prev <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    te<span style=color:#ff79c6>-&gt;</span>next <span style=color:#ff79c6>=</span> eventLoop<span style=color:#ff79c6>-&gt;</span>timeEventHead;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    te<span style=color:#ff79c6>-&gt;</span>refcount <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    <span style=color:#ff79c6>if</span> (te<span style=color:#ff79c6>-&gt;</span>next)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>        te<span style=color:#ff79c6>-&gt;</span>next<span style=color:#ff79c6>-&gt;</span>prev <span style=color:#ff79c6>=</span> te;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>    eventLoop<span style=color:#ff79c6>-&gt;</span>timeEventHead <span style=color:#ff79c6>=</span> te;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>    <span style=color:#ff79c6>return</span> id;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>}
</span></span></code></pre></div><p>都是常规的处理，注意一下传递进来的几个参数</p><ul><li><code>eventLoop</code> 是之前创建的 eventLoop对象</li><li><code>proc</code> 是定时器触发时的回调函数</li><li><code>milliseconds</code> 定时器触发的时间间隔</li></ul><p><a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/server.c#L1260 target=_blank rel=noopener>proc</a> 函数的定义</p><p>这里不详细展开了，就是redis中的一些定时操作。</p><p>在 <code>main</code> 函数中继续往下，会看到 <code>initListeners();</code> 这个函数，中这里也能知道，这里创建 网络的监听</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>initListeners</span>(<span style=color:#8be9fd>void</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    <span style=color:#6272a4>/* Setup listeners from server config for TCP/TLS/Unix */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#8be9fd>int</span> conn_index;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    connListener <span style=color:#ff79c6>*</span>listener;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#6272a4>//判断是否需要监听普通的TCP
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>if</span> (server.port <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>        conn_index <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>connectionIndexByType</span>(CONN_TYPE_SOCKET);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>        <span style=color:#ff79c6>if</span> (conn_index <span style=color:#ff79c6>&lt;</span> <span style=color:#bd93f9>0</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>            <span style=color:#50fa7b>serverPanic</span>(<span style=color:#f1fa8c>&#34;Failed finding connection listener of %s&#34;</span>, CONN_TYPE_SOCKET);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>        listener <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>&amp;</span>server.listeners[conn_index];
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>        listener<span style=color:#ff79c6>-&gt;</span>bindaddr <span style=color:#ff79c6>=</span> server.bindaddr;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        listener<span style=color:#ff79c6>-&gt;</span>bindaddr_count <span style=color:#ff79c6>=</span> server.bindaddr_count;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>        listener<span style=color:#ff79c6>-&gt;</span>port <span style=color:#ff79c6>=</span> server.port;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>        listener<span style=color:#ff79c6>-&gt;</span>ct <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>connectionByType</span>(CONN_TYPE_SOCKET);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    <span style=color:#6272a4>//判断是否需要监听,如果需要,检查tls需要的配置是否正确
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>if</span> (server.tls_port <span style=color:#ff79c6>||</span> server.tls_replication <span style=color:#ff79c6>||</span> server.tls_cluster) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>        ConnectionType <span style=color:#ff79c6>*</span>ct_tls <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>connectionTypeTls</span>();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>        <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>ct_tls) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>            <span style=color:#50fa7b>serverLog</span>(LL_WARNING, <span style=color:#f1fa8c>&#34;Failed finding TLS support.&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>            <span style=color:#50fa7b>exit</span>(<span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>        <span style=color:#ff79c6>if</span> (<span style=color:#50fa7b>connTypeConfigure</span>(ct_tls, <span style=color:#ff79c6>&amp;</span>server.tls_ctx_config, <span style=color:#bd93f9>1</span>) <span style=color:#ff79c6>==</span> C_ERR) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>            <span style=color:#50fa7b>serverLog</span>(LL_WARNING, <span style=color:#f1fa8c>&#34;Failed to configure TLS. Check logs for more info.&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>            <span style=color:#50fa7b>exit</span>(<span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>    <span style=color:#6272a4>//判断是否需要监听 TLS的TCP
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>if</span> (server.tls_port <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>        conn_index <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>connectionIndexByType</span>(CONN_TYPE_TLS);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>        <span style=color:#ff79c6>if</span> (conn_index <span style=color:#ff79c6>&lt;</span> <span style=color:#bd93f9>0</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>            <span style=color:#50fa7b>serverPanic</span>(<span style=color:#f1fa8c>&#34;Failed finding connection listener of %s&#34;</span>, CONN_TYPE_TLS);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>        listener <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>&amp;</span>server.listeners[conn_index];
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>        listener<span style=color:#ff79c6>-&gt;</span>bindaddr <span style=color:#ff79c6>=</span> server.bindaddr;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>        listener<span style=color:#ff79c6>-&gt;</span>bindaddr_count <span style=color:#ff79c6>=</span> server.bindaddr_count;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>        listener<span style=color:#ff79c6>-&gt;</span>port <span style=color:#ff79c6>=</span> server.tls_port;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>        listener<span style=color:#ff79c6>-&gt;</span>ct <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>connectionByType</span>(CONN_TYPE_TLS);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>    <span style=color:#6272a4>//判断是否需要unixsocket
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>if</span> (server.unixsocket <span style=color:#ff79c6>!=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>        conn_index <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>connectionIndexByType</span>(CONN_TYPE_UNIX);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>        <span style=color:#ff79c6>if</span> (conn_index <span style=color:#ff79c6>&lt;</span> <span style=color:#bd93f9>0</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>            <span style=color:#50fa7b>serverPanic</span>(<span style=color:#f1fa8c>&#34;Failed finding connection listener of %s&#34;</span>, CONN_TYPE_UNIX);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>        listener <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>&amp;</span>server.listeners[conn_index];
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span>        listener<span style=color:#ff79c6>-&gt;</span>bindaddr <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>&amp;</span>server.unixsocket;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span>        listener<span style=color:#ff79c6>-&gt;</span>bindaddr_count <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span>        listener<span style=color:#ff79c6>-&gt;</span>ct <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>connectionByType</span>(CONN_TYPE_UNIX);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span>        listener<span style=color:#ff79c6>-&gt;</span>priv <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>&amp;</span>server.unixsocketperm; <span style=color:#6272a4>/* Unix socket specified */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span><span>    <span style=color:#6272a4>/* create all the configured listener, and add handler to start to accept */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span><span>    <span style=color:#8be9fd>int</span> listen_fds <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53</span><span>    <span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> j <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; j <span style=color:#ff79c6>&lt;</span> CONN_TYPE_MAX; j<span style=color:#ff79c6>++</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54</span><span>        listener <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>&amp;</span>server.listeners[j];
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55</span><span>        <span style=color:#ff79c6>if</span> (listener<span style=color:#ff79c6>-&gt;</span>ct <span style=color:#ff79c6>==</span> <span style=color:#8be9fd;font-style:italic>NULL</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56</span><span>            <span style=color:#ff79c6>continue</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58</span><span>        <span style=color:#ff79c6>if</span> (<span style=color:#50fa7b>connListen</span>(listener) <span style=color:#ff79c6>==</span> C_ERR) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59</span><span>            <span style=color:#50fa7b>serverLog</span>(LL_WARNING, <span style=color:#f1fa8c>&#34;Failed listening on port %u (%s), aborting.&#34;</span>, listener<span style=color:#ff79c6>-&gt;</span>port, listener<span style=color:#ff79c6>-&gt;</span>ct<span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>get_type</span>(<span style=color:#8be9fd;font-style:italic>NULL</span>));
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60</span><span>            <span style=color:#50fa7b>exit</span>(<span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62</span><span>        <span style=color:#6272a4>//创建新的连接处理事件
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63</span><span><span style=color:#6272a4></span>        <span style=color:#ff79c6>if</span> (<span style=color:#50fa7b>createSocketAcceptHandler</span>(listener, <span style=color:#50fa7b>connAcceptHandler</span>(listener<span style=color:#ff79c6>-&gt;</span>ct)) <span style=color:#ff79c6>!=</span> C_OK)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64</span><span>            <span style=color:#50fa7b>serverPanic</span>(<span style=color:#f1fa8c>&#34;Unrecoverable error creating %s listener accept handler.&#34;</span>, listener<span style=color:#ff79c6>-&gt;</span>ct<span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>get_type</span>(<span style=color:#8be9fd;font-style:italic>NULL</span>));
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66</span><span>       listen_fds <span style=color:#ff79c6>+=</span> listener<span style=color:#ff79c6>-&gt;</span>count;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">69</span><span>    <span style=color:#ff79c6>if</span> (listen_fds <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">70</span><span>        <span style=color:#50fa7b>serverLog</span>(LL_WARNING, <span style=color:#f1fa8c>&#34;Configured to not listen anywhere, exiting.&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">71</span><span>        <span style=color:#50fa7b>exit</span>(<span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">72</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">73</span><span>}
</span></span></code></pre></div><p>在这个函数里，根据配置文件，开始监听对应的端口或者 unixsockt。</p><p>这里引入了 <code>connListener</code> <code>connection</code> <code>ConnectionType</code> 这三个结构</p><ul><li><code>connListener</code> 是对网络监听的封装</li><li><code>connection</code> 是对网络连接的封装</li><li><code>ConnectionType</code> 封装了操作网络需要的函数</li></ul><p><code>ConnectionType</code> 有三个不同的实现，分别是:</p><ul><li><code>CT_Socket</code> 对应的TCP <a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/socket.c#L52 target=_blank rel=noopener>CT_Socket</a></li><li><code>CT_Unix</code> 对应的是 unix socket <a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/unix.c#L30 target=_blank rel=noopener>CT_Unix</a></li><li><code>CT_TLS</code> 对应的 使用了 TLS的TCP <a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/tls.c#L424 target=_blank rel=noopener>CT_TLS</a></li></ul><p><a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/connection.h#L68-L140 target=_blank rel=noopener>ConnectionType 定义</a></p><p>ConnectionType内部的函数这里就不展开详细介绍了。</p><p>在 <code>initListeners</code> 中调用了 <code>connListen</code> 函数，来完成对不同网络的监听，这里实现也挺简单的，就是调用了<code>ConnectionType</code> 中的 <code>listen</code> 函数，完成了对端口或者unixsocket的监听。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>static</span> <span style=color:#ff79c6>inline</span> <span style=color:#8be9fd>int</span> <span style=color:#50fa7b>connListen</span>(connListener <span style=color:#ff79c6>*</span>listener) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>    <span style=color:#ff79c6>return</span> listener<span style=color:#ff79c6>-&gt;</span>ct<span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>listen</span>(listener);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>}
</span></span></code></pre></div><p>以 <code>socket</code> 为例，对应的listen函数就是 <code>connSocketListen</code> 对应的初始化在这里<a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/socket.c#L406 target=_blank rel=noopener>.listen = connSocketListen</a></p><p>最终实现对端口监听的函数是 <a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/server.c#L2446 target=_blank rel=noopener>listenToPort(connListener *sfd)</a></p><p>话题收回来，回到 <code>initListeners</code> 函数中 调用 <code>connListen</code> 函数完成监听后，会再调用<code>createSocketAcceptHandler</code> 函数 完成网络的 <code>Accept</code> 处理逻辑。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>createSocketAcceptHandler</span>(connListener <span style=color:#ff79c6>*</span>sfd, aeFileProc <span style=color:#ff79c6>*</span>accept_handler) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    <span style=color:#8be9fd>int</span> j;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#ff79c6>for</span> (j <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; j <span style=color:#ff79c6>&lt;</span> sfd<span style=color:#ff79c6>-&gt;</span>count; j<span style=color:#ff79c6>++</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>        <span style=color:#ff79c6>if</span> (<span style=color:#50fa7b>aeCreateFileEvent</span>(server.el, sfd<span style=color:#ff79c6>-&gt;</span>fd[j], AE_READABLE, accept_handler,sfd) <span style=color:#ff79c6>==</span> AE_ERR) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>            <span style=color:#6272a4>/* Rollback */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>            <span style=color:#ff79c6>for</span> (j <span style=color:#ff79c6>=</span> j<span style=color:#ff79c6>-</span><span style=color:#bd93f9>1</span>; j <span style=color:#ff79c6>&gt;=</span> <span style=color:#bd93f9>0</span>; j<span style=color:#ff79c6>--</span>) <span style=color:#50fa7b>aeDeleteFileEvent</span>(server.el, sfd<span style=color:#ff79c6>-&gt;</span>fd[j], AE_READABLE);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>            <span style=color:#ff79c6>return</span> C_ERR;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#ff79c6>return</span> C_OK;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>}
</span></span></code></pre></div><p>这里逻辑也挺简单，遍历之前accept的 <code>fd</code>，将fd加入到 <code>aeEventLoop</code> 中，如果失败了，就回滚所有数据，也就是中 <code>aeEventLoop</code> 中删除对应的事件。</p><p><code>aeCreateFileEvent</code>的实现</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>aeCreateFileEvent</span>(aeEventLoop <span style=color:#ff79c6>*</span>eventLoop, <span style=color:#8be9fd>int</span> fd, <span style=color:#8be9fd>int</span> mask,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>        aeFileProc <span style=color:#ff79c6>*</span>proc, <span style=color:#8be9fd>void</span> <span style=color:#ff79c6>*</span>clientData)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#ff79c6>if</span> (fd <span style=color:#ff79c6>&gt;=</span> eventLoop<span style=color:#ff79c6>-&gt;</span>setsize) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>        errno <span style=color:#ff79c6>=</span> ERANGE;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>        <span style=color:#ff79c6>return</span> AE_ERR;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    aeFileEvent <span style=color:#ff79c6>*</span>fe <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>&amp;</span>eventLoop<span style=color:#ff79c6>-&gt;</span>events[fd];
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#6272a4>//调用对应平台的系统函数,把对应的事件加入到操作系统中
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#6272a4></span>    <span style=color:#6272a4>//比如在epoll中就是调用 epoll_ctl 函数把 事件加入 epoll中
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>if</span> (<span style=color:#50fa7b>aeApiAddEvent</span>(eventLoop, fd, mask) <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>-</span><span style=color:#bd93f9>1</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        <span style=color:#ff79c6>return</span> AE_ERR;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    fe<span style=color:#ff79c6>-&gt;</span>mask <span style=color:#ff79c6>|=</span> mask;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    <span style=color:#ff79c6>if</span> (mask <span style=color:#ff79c6>&amp;</span> AE_READABLE) fe<span style=color:#ff79c6>-&gt;</span>rfileProc <span style=color:#ff79c6>=</span> proc;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    <span style=color:#ff79c6>if</span> (mask <span style=color:#ff79c6>&amp;</span> AE_WRITABLE) fe<span style=color:#ff79c6>-&gt;</span>wfileProc <span style=color:#ff79c6>=</span> proc;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    fe<span style=color:#ff79c6>-&gt;</span>clientData <span style=color:#ff79c6>=</span> clientData;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    <span style=color:#ff79c6>if</span> (fd <span style=color:#ff79c6>&gt;</span> eventLoop<span style=color:#ff79c6>-&gt;</span>maxfd)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>        eventLoop<span style=color:#ff79c6>-&gt;</span>maxfd <span style=color:#ff79c6>=</span> fd;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    <span style=color:#ff79c6>return</span> AE_OK;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>}
</span></span></code></pre></div><p>也是常规的处理逻辑，这里需要注意一下，传递的几个参数。</p><ul><li><code>aeEventLoop</code> 就是之前通过 <code>aeCreateEventLoop</code> 函数创建的对象。</li><li><code>fd</code> 是对应的文件描述符</li><li><code>mask</code> 对应的这个event 需要处理的事件类型，比如 读，写等等</li><li><code>proc</code> 这个是一个回调函数，当对应的事件触发时，使用这个函数来处理。比如这里就是当<code>fd</code>有读写事件触发时，就会调用这个函数，也就是当有新的客户端连接时，就通过这个函数来处理</li><li><code>clientData</code> 是这个event的数据</li></ul><p>这里的 <code>proc</code> 是<code>socket.c</code>文件中的 <a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/socket.c#L311 target=_blank rel=noopener>connSocketAcceptHandler</a> 函数。这个函数后面网络读写在分析。到这里，redis对client的网络监听基本完成了。</p><h3 id=监听cluster><a href=#%e7%9b%91%e5%90%accluster class=header-anchor></a>监听cluster</h3><p>如果redis开启了集群，需要对集群中其他的redis做网络监听，与其他的redis互联</p><p><a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/server.c#L7312-L7315 target=_blank rel=noopener>开启cluster</a></p><p>在这里调用 <a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/cluster.c#L1072 target=_blank rel=noopener>clusterInitListeners</a> 开启对 <code>cluster</code> 的监听。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>clusterInitListeners</span>(<span style=color:#8be9fd>void</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    <span style=color:#ff79c6>if</span> (<span style=color:#50fa7b>connectionIndexByType</span>(<span style=color:#50fa7b>connTypeOfCluster</span>()<span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>get_type</span>(<span style=color:#8be9fd;font-style:italic>NULL</span>)) <span style=color:#ff79c6>&lt;</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>        <span style=color:#50fa7b>serverLog</span>(LL_WARNING, <span style=color:#f1fa8c>&#34;Missing connection type %s, but it is required for the Cluster bus.&#34;</span>, <span style=color:#50fa7b>connTypeOfCluster</span>()<span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>get_type</span>(<span style=color:#8be9fd;font-style:italic>NULL</span>));
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>        <span style=color:#50fa7b>exit</span>(<span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#8be9fd>int</span> port <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>defaultClientPort</span>();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    connListener <span style=color:#ff79c6>*</span>listener <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>&amp;</span>server.clistener;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    listener<span style=color:#ff79c6>-&gt;</span>count <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    listener<span style=color:#ff79c6>-&gt;</span>bindaddr <span style=color:#ff79c6>=</span> server.bindaddr;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    listener<span style=color:#ff79c6>-&gt;</span>bindaddr_count <span style=color:#ff79c6>=</span> server.bindaddr_count;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    listener<span style=color:#ff79c6>-&gt;</span>port <span style=color:#ff79c6>=</span> server.cluster_port <span style=color:#ff79c6>?</span> server.<span style=color:#8be9fd;font-style:italic>cluster_port</span> : port <span style=color:#ff79c6>+</span> CLUSTER_PORT_INCR;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    listener<span style=color:#ff79c6>-&gt;</span>ct <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>connTypeOfCluster</span>();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    <span style=color:#ff79c6>if</span> (<span style=color:#50fa7b>connListen</span>(listener) <span style=color:#ff79c6>==</span> C_ERR ) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>        <span style=color:#6272a4>/* Note: the following log text is matched by the test suite. */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>        <span style=color:#50fa7b>serverLog</span>(LL_WARNING, <span style=color:#f1fa8c>&#34;Failed listening on port %u (cluster), aborting.&#34;</span>, listener<span style=color:#ff79c6>-&gt;</span>port);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>        <span style=color:#50fa7b>exit</span>(<span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>    <span style=color:#ff79c6>if</span> (<span style=color:#50fa7b>createSocketAcceptHandler</span>(<span style=color:#ff79c6>&amp;</span>server.clistener, clusterAcceptHandler) <span style=color:#ff79c6>!=</span> C_OK) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>        <span style=color:#50fa7b>serverPanic</span>(<span style=color:#f1fa8c>&#34;Unrecoverable error creating Redis Cluster socket accept handler.&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>}
</span></span></code></pre></div><p>这里的逻辑和client那部分类似，不同的地方是 <code>aeFileEvent</code> 中的回调函数变成了 <a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/cluster.c#L1280 target=_blank rel=noopener>clusterAcceptHandler</a> 这里不展开了。</p><p>然后会调用 <a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/server.c#L2830 target=_blank rel=noopener>InitServerLast</a> 函数</p><p>这里注意关注 <a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/networking.c#L4220 target=_blank rel=noopener>initThreadedIO</a> 这个函数</p><p>redis 在6.0 版本加入了多线程支持，其实redis的多线程只是在 网络 I/O 加入了多线程处理，在处理命令时还是单线程，这里就是做了多线程的处理。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>initThreadedIO</span>(<span style=color:#8be9fd>void</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    server.io_threads_active <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; <span style=color:#6272a4>/* We start with threads not active. */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#6272a4>/* Indicate that io-threads are currently idle */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    io_threads_op <span style=color:#ff79c6>=</span> IO_THREADS_OP_IDLE;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#6272a4>//如果就一个线程，也没必要开新的线程了
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>if</span> (server.io_threads_num <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>1</span>) <span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#6272a4>//判断一下，如果线程太多了，就提示错误，不能开启太多线程
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>if</span> (server.io_threads_num <span style=color:#ff79c6>&gt;</span> IO_THREADS_MAX_NUM) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        <span style=color:#50fa7b>serverLog</span>(LL_WARNING,<span style=color:#f1fa8c>&#34;Fatal: too many I/O threads configured. &#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>                             <span style=color:#f1fa8c>&#34;The maximum number is %d.&#34;</span>, IO_THREADS_MAX_NUM);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>        <span style=color:#50fa7b>exit</span>(<span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    <span style=color:#6272a4>/* Spawn and initialize the I/O threads. */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    <span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> i <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; i <span style=color:#ff79c6>&lt;</span> server.io_threads_num; i<span style=color:#ff79c6>++</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>        <span style=color:#6272a4>/* Things we do for all the threads including the main thread. */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>        io_threads_list[i] <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>listCreate</span>();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>        <span style=color:#ff79c6>if</span> (i <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) <span style=color:#ff79c6>continue</span>; <span style=color:#6272a4>/* Thread 0 is the main thread. */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>        <span style=color:#6272a4>/* Things we do only for the additional threads. */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>        <span style=color:#8be9fd>pthread_t</span> tid;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>        <span style=color:#50fa7b>pthread_mutex_init</span>(<span style=color:#ff79c6>&amp;</span>io_threads_mutex[i],<span style=color:#8be9fd;font-style:italic>NULL</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>        <span style=color:#50fa7b>setIOPendingCount</span>(i, <span style=color:#bd93f9>0</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>        <span style=color:#50fa7b>pthread_mutex_lock</span>(<span style=color:#ff79c6>&amp;</span>io_threads_mutex[i]); <span style=color:#6272a4>/* Thread will be stopped. */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>        <span style=color:#ff79c6>if</span> (<span style=color:#50fa7b>pthread_create</span>(<span style=color:#ff79c6>&amp;</span>tid,<span style=color:#8be9fd;font-style:italic>NULL</span>,IOThreadMain,(<span style=color:#8be9fd>void</span><span style=color:#ff79c6>*</span>)(<span style=color:#8be9fd>long</span>)i) <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>            <span style=color:#50fa7b>serverLog</span>(LL_WARNING,<span style=color:#f1fa8c>&#34;Fatal: Can&#39;t initialize IO thread.&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>            <span style=color:#50fa7b>exit</span>(<span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>        io_threads[i] <span style=color:#ff79c6>=</span> tid;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>}
</span></span></code></pre></div><p>使用 <code>pthread_create</code> 创建线程线程，<a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/networking.c#L4173 target=_blank rel=noopener>IOThreadMain</a> 是对应线程的处理函数。</p><p>这个函数先不展开，等后面处理网络读写的时候，会提到。</p><p>回到 <code>main</code> 函数里，继续往下走，最后会调用 <a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/ae.c#L493 target=_blank rel=noopener>aeMain</a> 来阻塞当前线程，然后处理网络。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>aeMain</span>(aeEventLoop <span style=color:#ff79c6>*</span>eventLoop) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>    eventLoop<span style=color:#ff79c6>-&gt;</span>stop <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>    <span style=color:#ff79c6>while</span> (<span style=color:#ff79c6>!</span>eventLoop<span style=color:#ff79c6>-&gt;</span>stop) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>        <span style=color:#50fa7b>aeProcessEvents</span>(eventLoop, AE_ALL_EVENTS<span style=color:#ff79c6>|</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>                                   AE_CALL_BEFORE_SLEEP<span style=color:#ff79c6>|</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>                                   AE_CALL_AFTER_SLEEP);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span>}
</span></span></code></pre></div><p><a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/ae.c#L361 target=_blank rel=noopener>aeProcessEvents</a> 中处理之前 添加的 <code>aeEvent</code> 事件回调</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>aeProcessEvents</span>(aeEventLoop <span style=color:#ff79c6>*</span>eventLoop, <span style=color:#8be9fd>int</span> flags)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#8be9fd>int</span> processed <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>, numevents;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#6272a4>/* Nothing to do? return ASAP */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>(flags <span style=color:#ff79c6>&amp;</span> AE_TIME_EVENTS) <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>!</span>(flags <span style=color:#ff79c6>&amp;</span> AE_FILE_EVENTS)) <span style=color:#ff79c6>return</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#ff79c6>if</span> (eventLoop<span style=color:#ff79c6>-&gt;</span>maxfd <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>-</span><span style=color:#bd93f9>1</span> <span style=color:#ff79c6>||</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        ((flags <span style=color:#ff79c6>&amp;</span> AE_TIME_EVENTS) <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>!</span>(flags <span style=color:#ff79c6>&amp;</span> AE_DONT_WAIT))) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>        <span style=color:#8be9fd>int</span> j;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>        <span style=color:#ff79c6>struct</span> timeval tv, <span style=color:#ff79c6>*</span>tvp <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>; <span style=color:#6272a4>/* NULL means infinite wait. */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        <span style=color:#8be9fd>int64_t</span> usUntilTimer;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>        <span style=color:#6272a4>//检查beforesleep函数指针,如果有对应的函数,调用这个函数
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#6272a4></span>        <span style=color:#ff79c6>if</span> (eventLoop<span style=color:#ff79c6>-&gt;</span>beforesleep <span style=color:#ff79c6>!=</span> <span style=color:#8be9fd;font-style:italic>NULL</span> <span style=color:#ff79c6>&amp;&amp;</span> (flags <span style=color:#ff79c6>&amp;</span> AE_CALL_BEFORE_SLEEP))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>            eventLoop<span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>beforesleep</span>(eventLoop);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>        <span style=color:#ff79c6>if</span> ((flags <span style=color:#ff79c6>&amp;</span> AE_DONT_WAIT) <span style=color:#ff79c6>||</span> (eventLoop<span style=color:#ff79c6>-&gt;</span>flags <span style=color:#ff79c6>&amp;</span> AE_DONT_WAIT)) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>            tv.tv_sec <span style=color:#ff79c6>=</span> tv.tv_usec <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>            tvp <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>&amp;</span>tv;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>        } <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (flags <span style=color:#ff79c6>&amp;</span> AE_TIME_EVENTS) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>            usUntilTimer <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>usUntilEarliestTimer</span>(eventLoop);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>            <span style=color:#ff79c6>if</span> (usUntilTimer <span style=color:#ff79c6>&gt;=</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>                tv.tv_sec <span style=color:#ff79c6>=</span> usUntilTimer <span style=color:#ff79c6>/</span> <span style=color:#bd93f9>1000000</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>                tv.tv_usec <span style=color:#ff79c6>=</span> usUntilTimer <span style=color:#ff79c6>%</span> <span style=color:#bd93f9>1000000</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>                tvp <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>&amp;</span>tv;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>            }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>        numevents <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>aeApiPoll</span>(eventLoop, tvp);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>        <span style=color:#6272a4>/* Don&#39;t process file events if not requested. */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>        <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>(flags <span style=color:#ff79c6>&amp;</span> AE_FILE_EVENTS)) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>            numevents <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>        <span style=color:#6272a4>//检查aftersleep函数指针,如果有对应的函数,调用这个函数
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span><span style=color:#6272a4></span>        <span style=color:#ff79c6>if</span> (eventLoop<span style=color:#ff79c6>-&gt;</span>aftersleep <span style=color:#ff79c6>!=</span> <span style=color:#8be9fd;font-style:italic>NULL</span> <span style=color:#ff79c6>&amp;&amp;</span> flags <span style=color:#ff79c6>&amp;</span> AE_CALL_AFTER_SLEEP)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>            eventLoop<span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>aftersleep</span>(eventLoop);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>        <span style=color:#6272a4>//检查就绪的事件,然后做对应的处理
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span><span style=color:#6272a4></span>        <span style=color:#ff79c6>for</span> (j <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; j <span style=color:#ff79c6>&lt;</span> numevents; j<span style=color:#ff79c6>++</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>            <span style=color:#8be9fd>int</span> fd <span style=color:#ff79c6>=</span> eventLoop<span style=color:#ff79c6>-&gt;</span>fired[j].fd;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>            aeFileEvent <span style=color:#ff79c6>*</span>fe <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>&amp;</span>eventLoop<span style=color:#ff79c6>-&gt;</span>events[fd];
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>            <span style=color:#8be9fd>int</span> mask <span style=color:#ff79c6>=</span> eventLoop<span style=color:#ff79c6>-&gt;</span>fired[j].mask;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>            <span style=color:#8be9fd>int</span> fired <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; <span style=color:#6272a4>/* Number of events fired for current fd. */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span>            <span style=color:#8be9fd>int</span> invert <span style=color:#ff79c6>=</span> fe<span style=color:#ff79c6>-&gt;</span>mask <span style=color:#ff79c6>&amp;</span> AE_BARRIER;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span>            <span style=color:#6272a4>//需要翻转的话,先处理读的回调函数
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span><span style=color:#6272a4></span>            <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>invert <span style=color:#ff79c6>&amp;&amp;</span> fe<span style=color:#ff79c6>-&gt;</span>mask <span style=color:#ff79c6>&amp;</span> mask <span style=color:#ff79c6>&amp;</span> AE_READABLE) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span>                fe<span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>rfileProc</span>(eventLoop,fd,fe<span style=color:#ff79c6>-&gt;</span>clientData,mask);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span><span>                fired<span style=color:#ff79c6>++</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span><span>                fe <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>&amp;</span>eventLoop<span style=color:#ff79c6>-&gt;</span>events[fd]; <span style=color:#6272a4>/* Refresh in case of resize. */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span><span>            }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54</span><span>            <span style=color:#6272a4>//如果有写事件,做回调
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55</span><span><span style=color:#6272a4></span>            <span style=color:#ff79c6>if</span> (fe<span style=color:#ff79c6>-&gt;</span>mask <span style=color:#ff79c6>&amp;</span> mask <span style=color:#ff79c6>&amp;</span> AE_WRITABLE) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56</span><span>                <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>fired <span style=color:#ff79c6>||</span> fe<span style=color:#ff79c6>-&gt;</span>wfileProc <span style=color:#ff79c6>!=</span> fe<span style=color:#ff79c6>-&gt;</span>rfileProc) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57</span><span>                    fe<span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>wfileProc</span>(eventLoop,fd,fe<span style=color:#ff79c6>-&gt;</span>clientData,mask);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58</span><span>                    fired<span style=color:#ff79c6>++</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59</span><span>                }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60</span><span>            }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62</span><span>            <span style=color:#ff79c6>if</span> (invert) {<span style=color:#6272a4>//如果之前没有处理读事件
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63</span><span><span style=color:#6272a4></span>                fe <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>&amp;</span>eventLoop<span style=color:#ff79c6>-&gt;</span>events[fd]; <span style=color:#6272a4>/* Refresh in case of resize. */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64</span><span>                <span style=color:#ff79c6>if</span> ((fe<span style=color:#ff79c6>-&gt;</span>mask <span style=color:#ff79c6>&amp;</span> mask <span style=color:#ff79c6>&amp;</span> AE_READABLE) <span style=color:#ff79c6>&amp;&amp;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65</span><span>                    (<span style=color:#ff79c6>!</span>fired <span style=color:#ff79c6>||</span> fe<span style=color:#ff79c6>-&gt;</span>wfileProc <span style=color:#ff79c6>!=</span> fe<span style=color:#ff79c6>-&gt;</span>rfileProc))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66</span><span>                {<span style=color:#6272a4>//读回调函数指针和写回调函数指针不是同一个, 并且有读事件,回调读函数
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67</span><span><span style=color:#6272a4></span>                    fe<span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>rfileProc</span>(eventLoop,fd,fe<span style=color:#ff79c6>-&gt;</span>clientData,mask);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68</span><span>                    fired<span style=color:#ff79c6>++</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">69</span><span>                }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">70</span><span>            }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">71</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">72</span><span>            processed<span style=color:#ff79c6>++</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">73</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">74</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">75</span><span>    <span style=color:#6272a4>//如果有时间回调事件,回调时间的回调函数
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">76</span><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>if</span> (flags <span style=color:#ff79c6>&amp;</span> AE_TIME_EVENTS)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">77</span><span>        processed <span style=color:#ff79c6>+=</span> <span style=color:#50fa7b>processTimeEvents</span>(eventLoop);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">78</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">79</span><span>    <span style=color:#ff79c6>return</span> processed; <span style=color:#6272a4>/* return the number of processed file/time events */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">80</span><span>}
</span></span></code></pre></div><p><a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/server.c#L1625 target=_blank rel=noopener>beforeSleep</a> 函数</p><p><a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/server.c#L1785 target=_blank rel=noopener>afterSleep</a> 函数</p><p>这两个函数内容非常多，很多和网络是无关的，不展开分析，后面有用的再回来介绍。</p><p><code>aeApiPoll</code> 函数在不同的平台上有不同的实现，最终的目的是等待系统的回调事件。在 <code>epoll</code> 中是等待 <code>epoll_wait</code> 的回调。</p><p><strong>简单画图理解一下</strong></p><p><div class=post-img-view><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/60eec42ff66692c81aa7419d8c60c3755d5e5aac.png><img src=https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/60eec42ff66692c81aa7419d8c60c3755d5e5aac.png alt></a></div></p><p>如图所示，redis虽然开启了多线程，但是每个连接还是在主线程中，而且处理命令也是在主线程中。</p><p>那么在什么时候用到多线程，以及怎样使用呢。</p><p>在上面的代码中也提到了，就是在网络IO中会用到多线程。</p><p>如图：</p><p><div class=post-img-view><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/ad28de7d73bbe7148e4bb0f70908e49d1ed38c1f.png><img src=https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/ad28de7d73bbe7148e4bb0f70908e49d1ed38c1f.png alt></a></div></p><p>拿从网络中读取数据来举例，当图中的 <strong>client1</strong> <strong>client2</strong> <strong>client3</strong> 同时有数据需要读取的时候，这时候会把这三个 client的 <strong>fd</strong> 分配到空闲的线程中，由不同的线程来读取数据，把读到的数据写入 client 的 buff中。当所有的 <strong>fd</strong> 读取完成后， 然后在线程中，依次处理每个client。具体代码在下文中。</p><h2 id=网络读写处理><a href=#%e7%bd%91%e7%bb%9c%e8%af%bb%e5%86%99%e5%a4%84%e7%90%86 class=header-anchor></a>网络读写处理</h2><h3 id=listener-回调><a href=#listener-%e5%9b%9e%e8%b0%83 class=header-anchor></a>Listener 回调</h3><p>之前在添加 <code>listener</code> 的时候，添加的是 <code>AE_READABLE</code> 事件， <code>aeCreateFileEvent(server.el, sfd->fd[j], AE_READABLE, accept_handler,sfd)</code></p><p>所以，accept 的回调会在 可读的回调函数中。</p><p><code>accept_handler</code>指针是 <a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/socket.c#L311-L312 target=_blank rel=noopener>connSocketAcceptHandler</a> 函数</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>static</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>connSocketAcceptHandler</span>(aeEventLoop <span style=color:#ff79c6>*</span>el, <span style=color:#8be9fd>int</span> fd, <span style=color:#8be9fd>void</span> <span style=color:#ff79c6>*</span>privdata, <span style=color:#8be9fd>int</span> mask) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    <span style=color:#8be9fd>int</span> cport, cfd, max <span style=color:#ff79c6>=</span> MAX_ACCEPTS_PER_CALL;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#8be9fd>char</span> cip[NET_IP_STR_LEN];
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#50fa7b>UNUSED</span>(el);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#50fa7b>UNUSED</span>(mask);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#50fa7b>UNUSED</span>(privdata);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#ff79c6>while</span>(max<span style=color:#ff79c6>--</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        <span style=color:#6272a4>//把当前的 accept 的 fd 转换成一个TCP连接
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#6272a4></span>        cfd <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>anetTcpAccept</span>(server.neterr, fd, cip, <span style=color:#ff79c6>sizeof</span>(cip), <span style=color:#ff79c6>&amp;</span>cport);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>        <span style=color:#ff79c6>if</span> (cfd <span style=color:#ff79c6>==</span> ANET_ERR) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>            <span style=color:#ff79c6>if</span> (errno <span style=color:#ff79c6>!=</span> EWOULDBLOCK)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>                <span style=color:#50fa7b>serverLog</span>(LL_WARNING,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>                    <span style=color:#f1fa8c>&#34;Accepting client connection: %s&#34;</span>, server.neterr);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>            <span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>        <span style=color:#50fa7b>serverLog</span>(LL_VERBOSE,<span style=color:#f1fa8c>&#34;Accepted %s:%d&#34;</span>, cip, cport);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>        <span style=color:#50fa7b>acceptCommonHandler</span>(<span style=color:#50fa7b>connCreateAcceptedSocket</span>(cfd, <span style=color:#8be9fd;font-style:italic>NULL</span>),<span style=color:#bd93f9>0</span>,cip);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>}
</span></span></code></pre></div><p>在 <code>anetTcpAccept</code> 中 调用 <a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/anet.c#L521 target=_blank rel=noopener>anetGenericAccept</a> 函数， 在函数中</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>#ifdef HAVE_ACCEPT4
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#ff79c6></span>        fd <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>accept4</span>(s, sa, len,  SOCK_NONBLOCK <span style=color:#ff79c6>|</span> SOCK_CLOEXEC);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#ff79c6>#else
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#ff79c6></span>        fd <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>accept</span>(s,sa,len);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#ff79c6>#endif
</span></span></span></code></pre></div><p>最终通过 <code>accept4</code> 或者 <code>accept</code> 系统调用，接受一个新的TCP链接。</p><p>最后调用 <code>acceptCommonHandler</code> 函数, 这个函数里会调用 <a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/networking.c#L1342 target=_blank rel=noopener>createClient(conn)</a> 来创建一个 <strong>client</strong></p><p>在 <code>createClient</code> 中，关注这段函数</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>    client <span style=color:#ff79c6>*</span>c <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>zmalloc</span>(<span style=color:#ff79c6>sizeof</span>(client));
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    <span style=color:#ff79c6>if</span> (conn) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>        <span style=color:#50fa7b>connEnableTcpNoDelay</span>(conn);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>        <span style=color:#ff79c6>if</span> (server.tcpkeepalive)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>            <span style=color:#50fa7b>connKeepAlive</span>(conn,server.tcpkeepalive);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>        <span style=color:#6272a4>//把当前的conn加入到 eventPool中,并且把 readQueryFromClient 设置为回调函数
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#6272a4></span>        <span style=color:#50fa7b>connSetReadHandler</span>(conn, readQueryFromClient);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>        <span style=color:#50fa7b>connSetPrivateData</span>(conn, c);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#6272a4>//初始化client的buffer
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#6272a4></span>    c<span style=color:#ff79c6>-&gt;</span>buf <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>zmalloc_usable</span>(PROTO_REPLY_CHUNK_BYTES, <span style=color:#ff79c6>&amp;</span>c<span style=color:#ff79c6>-&gt;</span>buf_usable_size);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#50fa7b>selectDb</span>(c,<span style=color:#bd93f9>0</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    <span style=color:#8be9fd>uint64_t</span> client_id;
</span></span></code></pre></div><p><code>connEnableTcpNoDelay</code> 最终会调用 <code>anet.c中的</code> <a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/anet.c#L191 target=_blank rel=noopener>anetSetTcpNoDelay</a> 函数，来完成对TCP连接的设置。</p><p><code>connKeepAlive</code> 最终调用到 <code>anet.c中的</code> <a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/anet.c#L136 target=_blank rel=noopener>anetKeepAlive</a> 对 <strong>KeepAlive</strong> 的设置</p><p><code>connSetReadHandler</code> 通过这个函数，完成把 该TCP连接的 <strong>fd</strong> 加入的 <code>eventLoop</code> 中进行管理。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>static</span> <span style=color:#ff79c6>inline</span> <span style=color:#8be9fd>int</span> <span style=color:#50fa7b>connSetReadHandler</span>(connection <span style=color:#ff79c6>*</span>conn, ConnectionCallbackFunc func) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>    <span style=color:#ff79c6>return</span> conn<span style=color:#ff79c6>-&gt;</span>type<span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>set_read_handler</span>(conn, func);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>}
</span></span></code></pre></div><p>通过 <code>set_read_handler</code> 这个函数指针调用到 <code>socket.c</code> 中的 <a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/socket.c#L241 target=_blank rel=noopener>connSocketSetReadHandler</a> 函数</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>static</span> <span style=color:#8be9fd>int</span> <span style=color:#50fa7b>connSocketSetReadHandler</span>(connection <span style=color:#ff79c6>*</span>conn, ConnectionCallbackFunc func) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    <span style=color:#ff79c6>if</span> (func <span style=color:#ff79c6>==</span> conn<span style=color:#ff79c6>-&gt;</span>read_handler) <span style=color:#ff79c6>return</span> C_OK;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    conn<span style=color:#ff79c6>-&gt;</span>read_handler <span style=color:#ff79c6>=</span> func;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>conn<span style=color:#ff79c6>-&gt;</span>read_handler)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>        <span style=color:#50fa7b>aeDeleteFileEvent</span>(server.el,conn<span style=color:#ff79c6>-&gt;</span>fd,AE_READABLE);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#ff79c6>else</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>        <span style=color:#ff79c6>if</span> (<span style=color:#50fa7b>aeCreateFileEvent</span>(server.el,conn<span style=color:#ff79c6>-&gt;</span>fd,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>                    AE_READABLE,conn<span style=color:#ff79c6>-&gt;</span>type<span style=color:#ff79c6>-&gt;</span>ae_handler,conn) <span style=color:#ff79c6>==</span> AE_ERR) <span style=color:#ff79c6>return</span> C_ERR;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#ff79c6>return</span> C_OK;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>}
</span></span></code></pre></div><p>调用 <code>aeCreateFileEvent</code> 把当前的 <code>conn</code> 加入到 <code>server.el</code> 也就是启动redis时，创建的 <code>aeEventPool</code> 中。</p><p>回到 <code>createClient</code> 函数中，<code>connSetReadHandler(conn, readQueryFromClient);</code> 第二参数传递的是 <a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/networking.c#L2616 target=_blank rel=noopener>readQueryFromClient</a> 这个函数的指针。这个函数 会赋值给 <code>aeFileEvent</code> 的 <code>rfileProc</code> 函数指针中。后续，如果这个 <code>conn</code> 有可读事件回调时，会使用 <code>readQueryFromClient</code> 这个函数来处理。</p><p>到这里，一个新TCP连接的处理基本就完成了。</p><h2 id=处理client读写><a href=#%e5%a4%84%e7%90%86client%e8%af%bb%e5%86%99 class=header-anchor></a>处理client读写</h2><h3 id=读处理><a href=#%e8%af%bb%e5%a4%84%e7%90%86 class=header-anchor></a>读处理</h3><p>当redis-server 收到client发来的数据后，也是通过 <code>aeEventPool</code> 来回调通知对应的 client来处理。</p><p>上面我们说过了，client收到读事件的回调函数是 <code>readQueryFromClient</code>，当client对应的网络有可读事件触发时，会回调这个函数。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>readQueryFromClient</span>(connection <span style=color:#ff79c6>*</span>conn) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    client <span style=color:#ff79c6>*</span>c <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>connGetPrivateData</span>(conn);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#8be9fd>int</span> nread, big_arg <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#8be9fd>size_t</span> qblen, readlen;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#6272a4>//判断一下,是否开启了IO线程,如果开启了那么会从IO线程读取数据
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>if</span> (<span style=color:#50fa7b>postponeClientRead</span>(c)) <span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#6272a4>//读取次数 原子性的 +1
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#6272a4></span>    <span style=color:#50fa7b>atomicIncr</span>(server.stat_total_reads_processed, <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    readlen <span style=color:#ff79c6>=</span> PROTO_IOBUF_LEN;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#6272a4>//如果是一个multi请求,那么调整一下缓冲区的大小
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>if</span> (c<span style=color:#ff79c6>-&gt;</span>reqtype <span style=color:#ff79c6>==</span> PROTO_REQ_MULTIBULK <span style=color:#ff79c6>&amp;&amp;</span> c<span style=color:#ff79c6>-&gt;</span>multibulklen <span style=color:#ff79c6>&amp;&amp;</span> c<span style=color:#ff79c6>-&gt;</span>bulklen <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>-</span><span style=color:#bd93f9>1</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>        <span style=color:#ff79c6>&amp;&amp;</span> c<span style=color:#ff79c6>-&gt;</span>bulklen <span style=color:#ff79c6>&gt;=</span> PROTO_MBULK_BIG_ARG)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>        <span style=color:#8be9fd>ssize_t</span> remaining <span style=color:#ff79c6>=</span> (<span style=color:#8be9fd>size_t</span>)(c<span style=color:#ff79c6>-&gt;</span>bulklen<span style=color:#ff79c6>+</span><span style=color:#bd93f9>2</span>)<span style=color:#ff79c6>-</span>(<span style=color:#50fa7b>sdslen</span>(c<span style=color:#ff79c6>-&gt;</span>querybuf)<span style=color:#ff79c6>-</span>c<span style=color:#ff79c6>-&gt;</span>qb_pos);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>        big_arg <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>        <span style=color:#ff79c6>if</span> (remaining <span style=color:#ff79c6>&gt;</span> <span style=color:#bd93f9>0</span>) readlen <span style=color:#ff79c6>=</span> remaining;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>        <span style=color:#ff79c6>if</span> (c<span style=color:#ff79c6>-&gt;</span>flags <span style=color:#ff79c6>&amp;</span> CLIENT_MASTER <span style=color:#ff79c6>&amp;&amp;</span> readlen <span style=color:#ff79c6>&lt;</span> PROTO_IOBUF_LEN)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>            readlen <span style=color:#ff79c6>=</span> PROTO_IOBUF_LEN;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>    qblen <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>sdslen</span>(c<span style=color:#ff79c6>-&gt;</span>querybuf);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>    <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>(c<span style=color:#ff79c6>-&gt;</span>flags <span style=color:#ff79c6>&amp;</span> CLIENT_MASTER) <span style=color:#ff79c6>&amp;&amp;</span> 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>        (big_arg <span style=color:#ff79c6>||</span> <span style=color:#50fa7b>sdsalloc</span>(c<span style=color:#ff79c6>-&gt;</span>querybuf) <span style=color:#ff79c6>&lt;</span> PROTO_IOBUF_LEN)) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>        c<span style=color:#ff79c6>-&gt;</span>querybuf <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>sdsMakeRoomForNonGreedy</span>(c<span style=color:#ff79c6>-&gt;</span>querybuf, readlen);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>        <span style=color:#ff79c6>if</span> (c<span style=color:#ff79c6>-&gt;</span>querybuf_peak <span style=color:#ff79c6>&lt;</span> qblen <span style=color:#ff79c6>+</span> readlen) c<span style=color:#ff79c6>-&gt;</span>querybuf_peak <span style=color:#ff79c6>=</span> qblen <span style=color:#ff79c6>+</span> readlen;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>    } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>        c<span style=color:#ff79c6>-&gt;</span>querybuf <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>sdsMakeRoomFor</span>(c<span style=color:#ff79c6>-&gt;</span>querybuf, readlen);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>        readlen <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>sdsavail</span>(c<span style=color:#ff79c6>-&gt;</span>querybuf);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>    <span style=color:#6272a4>//从网络中读取数据,如果是 socket,使用 connSocketRead 函数
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span><span style=color:#6272a4></span>    nread <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>connRead</span>(c<span style=color:#ff79c6>-&gt;</span>conn, c<span style=color:#ff79c6>-&gt;</span>querybuf<span style=color:#ff79c6>+</span>qblen, readlen);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>    <span style=color:#ff79c6>if</span> (nread <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>-</span><span style=color:#bd93f9>1</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>        <span style=color:#ff79c6>if</span> (<span style=color:#50fa7b>connGetState</span>(conn) <span style=color:#ff79c6>==</span> CONN_STATE_CONNECTED) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>            <span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>        } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>            <span style=color:#50fa7b>serverLog</span>(LL_VERBOSE, <span style=color:#f1fa8c>&#34;Reading from client: %s&#34;</span>,<span style=color:#50fa7b>connGetLastError</span>(c<span style=color:#ff79c6>-&gt;</span>conn));
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>            <span style=color:#50fa7b>freeClientAsync</span>(c);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>            <span style=color:#ff79c6>goto</span> done;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span>    } <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (nread <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span>        <span style=color:#ff79c6>if</span> (server.verbosity <span style=color:#ff79c6>&lt;=</span> LL_VERBOSE) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span>            sds info <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>catClientInfoString</span>(<span style=color:#50fa7b>sdsempty</span>(), c);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span>            <span style=color:#50fa7b>serverLog</span>(LL_VERBOSE, <span style=color:#f1fa8c>&#34;Client closed connection %s&#34;</span>, info);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span><span>            <span style=color:#50fa7b>sdsfree</span>(info);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span><span>        <span style=color:#50fa7b>freeClientAsync</span>(c);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53</span><span>        <span style=color:#ff79c6>goto</span> done;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56</span><span>    <span style=color:#50fa7b>sdsIncrLen</span>(c<span style=color:#ff79c6>-&gt;</span>querybuf,nread);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57</span><span>    qblen <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>sdslen</span>(c<span style=color:#ff79c6>-&gt;</span>querybuf);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58</span><span>    <span style=color:#ff79c6>if</span> (c<span style=color:#ff79c6>-&gt;</span>querybuf_peak <span style=color:#ff79c6>&lt;</span> qblen) c<span style=color:#ff79c6>-&gt;</span>querybuf_peak <span style=color:#ff79c6>=</span> qblen;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60</span><span>    c<span style=color:#ff79c6>-&gt;</span>lastinteraction <span style=color:#ff79c6>=</span> server.unixtime;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61</span><span>    <span style=color:#ff79c6>if</span> (c<span style=color:#ff79c6>-&gt;</span>flags <span style=color:#ff79c6>&amp;</span> CLIENT_MASTER) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62</span><span>        c<span style=color:#ff79c6>-&gt;</span>read_reploff <span style=color:#ff79c6>+=</span> nread;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63</span><span>        <span style=color:#50fa7b>atomicIncr</span>(server.stat_net_repl_input_bytes, nread);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64</span><span>    } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65</span><span>        <span style=color:#50fa7b>atomicIncr</span>(server.stat_net_input_bytes, nread);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68</span><span>    <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>(c<span style=color:#ff79c6>-&gt;</span>flags <span style=color:#ff79c6>&amp;</span> CLIENT_MASTER) <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#50fa7b>sdslen</span>(c<span style=color:#ff79c6>-&gt;</span>querybuf) <span style=color:#ff79c6>&gt;</span> server.client_max_querybuf_len) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">69</span><span>        sds ci <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>catClientInfoString</span>(<span style=color:#50fa7b>sdsempty</span>(),c), bytes <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>sdsempty</span>();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">70</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">71</span><span>        bytes <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>sdscatrepr</span>(bytes,c<span style=color:#ff79c6>-&gt;</span>querybuf,<span style=color:#bd93f9>64</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">72</span><span>        <span style=color:#50fa7b>serverLog</span>(LL_WARNING,<span style=color:#f1fa8c>&#34;Closing client that reached max query buffer length: %s (qbuf initial bytes: %s)&#34;</span>, ci, bytes);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">73</span><span>        <span style=color:#50fa7b>sdsfree</span>(ci);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">74</span><span>        <span style=color:#50fa7b>sdsfree</span>(bytes);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">75</span><span>        <span style=color:#50fa7b>freeClientAsync</span>(c);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">76</span><span>        <span style=color:#ff79c6>goto</span> done;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">77</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">78</span><span>    <span style=color:#6272a4>//处理读到的数据,尝试解析RESP协议
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">79</span><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>if</span> (<span style=color:#50fa7b>processInputBuffer</span>(c) <span style=color:#ff79c6>==</span> C_ERR)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">80</span><span>         c <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">81</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">82</span><span><span style=color:#8be9fd;font-style:italic>done</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">83</span><span>    <span style=color:#50fa7b>beforeNextClient</span>(c);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">84</span><span>}
</span></span></code></pre></div><p>在这个函数中判断是否需要使用多线程。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>postponeClientRead</span>(client <span style=color:#ff79c6>*</span>c) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    <span style=color:#6272a4>//在这里判断是否需要使用多线程从网络读取数据
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>if</span> (server.io_threads_active <span style=color:#ff79c6>&amp;&amp;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>        server.io_threads_do_reads <span style=color:#ff79c6>&amp;&amp;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>        <span style=color:#ff79c6>!</span>ProcessingEventsWhileBlocked <span style=color:#ff79c6>&amp;&amp;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>        <span style=color:#ff79c6>!</span>(c<span style=color:#ff79c6>-&gt;</span>flags <span style=color:#ff79c6>&amp;</span> (CLIENT_MASTER<span style=color:#ff79c6>|</span>CLIENT_SLAVE<span style=color:#ff79c6>|</span>CLIENT_BLOCKED)) <span style=color:#ff79c6>&amp;&amp;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>        io_threads_op <span style=color:#ff79c6>==</span> IO_THREADS_OP_IDLE)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        <span style=color:#6272a4>//如果需要多线程读取,把当前client加入到`clients_pending_read`中,等待后续调用
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#6272a4></span>        <span style=color:#50fa7b>listAddNodeHead</span>(server.clients_pending_read,c);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>        c<span style=color:#ff79c6>-&gt;</span>pending_read_list_node <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>listFirst</span>(server.clients_pending_read);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        <span style=color:#ff79c6>return</span> <span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>        <span style=color:#ff79c6>return</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>}
</span></span></code></pre></div><p>在配置文件中</p><ul><li><code>io-threads</code> IO线程数量,默认只有一个，也就是不用多线程读写网络</li><li><code>io-threads-do-reads</code> 是否开启多线程读和解析RESP功能，如果不开启，那么多线程只会处理写</li></ul><p>如果只有一个client就绪（也就是没有并发请求）时，即使开了多线程和IO线程读，也不会使用多线程去读网络，只有当多个client同时读写数据，这时候会在 <code>handleClientsWithPendingReadsUsingThreads</code> 中开启 多线程处理。</p><p><a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/networking.c#L4329 target=_blank rel=noopener>开启多线程读写</a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>server.io_threads_active) <span style=color:#50fa7b>startThreadedIO</span>();
</span></span></code></pre></div><p>此时，当client读事件就绪后，再次回调 <code>readQueryFromClient</code> 函数后，会进入 <code>listAddNodeHead(server.clients_pending_read,c);</code> 加入链表，等待IO线程处理</p><p><strong>如果需要多线程</strong></p><p>在主线程里调用 使用 <code>aeEventPool</code> 的 <code>beforesleep</code> 函数指针调用 <a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/server.c#L1625 target=_blank rel=noopener>beforeSleep</a> 函数来执行 sleep前的处理函数，然后在调用 <a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/networking.c#L4443 target=_blank rel=noopener>handleClientsWithPendingReadsUsingThreads</a> 函数来判断是否需要使用多线程来读数据。</p><p>最后的读取是由 <a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/networking.c#L2616 target=_blank rel=noopener>readQueryFromClient</a> 函数来完成数据的读取。</p><p><code>readQueryFromClient</code> 函数可以通过 <code>handleClientsWithPendingReadsUsingThreads</code> 函数在主线程调用，也可以通过 <a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/networking.c#L4173 target=_blank rel=noopener>IOThreadMain</a> 函数通过IO线程并发读取。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>//启动IO多线程读取数据
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span>io_threads_op <span style=color:#ff79c6>=</span> IO_THREADS_OP_READ;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> j <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>; j <span style=color:#ff79c6>&lt;</span> server.io_threads_num; j<span style=color:#ff79c6>++</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#8be9fd>int</span> count <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>listLength</span>(io_threads_list[j]);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#50fa7b>setIOPendingCount</span>(j, count);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>.......
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#6272a4>//等待IO线程读取完成
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>while</span>(<span style=color:#bd93f9>1</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#8be9fd>unsigned</span> <span style=color:#8be9fd>long</span> pending <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> j <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>; j <span style=color:#ff79c6>&lt;</span> server.io_threads_num; j<span style=color:#ff79c6>++</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        pending <span style=color:#ff79c6>+=</span> <span style=color:#50fa7b>getIOPendingCount</span>(j);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    <span style=color:#ff79c6>if</span> (pending <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) <span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>}
</span></span></code></pre></div><p>当执行完 <code>beforesleep</code> 函数后，再由 <code>aeFileEvent</code> 的 <code>rfileProc</code> 函数指针调用 <a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/networking.c#L2520 target=_blank rel=noopener>processInputBuffer</a> 函数内主要是判断和解析字符串，就不展开分析了</p><p>主要关注这部分逻辑</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>  <span style=color:#ff79c6>if</span> (c<span style=color:#ff79c6>-&gt;</span>reqtype <span style=color:#ff79c6>==</span> PROTO_REQ_INLINE) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>      <span style=color:#6272a4>//如果是一行的字符串,解析方式
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#6272a4></span>      <span style=color:#ff79c6>if</span> (<span style=color:#50fa7b>processInlineBuffer</span>(c) <span style=color:#ff79c6>!=</span> C_OK) <span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>  } <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (c<span style=color:#ff79c6>-&gt;</span>reqtype <span style=color:#ff79c6>==</span> PROTO_REQ_MULTIBULK) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>      <span style=color:#6272a4>//如果是多行的,解析方式
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#6272a4></span>      <span style=color:#ff79c6>if</span> (<span style=color:#50fa7b>processMultibulkBuffer</span>(c) <span style=color:#ff79c6>!=</span> C_OK) <span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>  } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>      <span style=color:#50fa7b>serverPanic</span>(<span style=color:#f1fa8c>&#34;Unknown request type&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>  <span style=color:#6272a4>//如果解析到的参数个数是0,那么说明还没有解析完成,重置client
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#6272a4></span>  <span style=color:#ff79c6>if</span> (c<span style=color:#ff79c6>-&gt;</span>argc <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>      <span style=color:#50fa7b>resetClient</span>(c);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>  } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>      <span style=color:#6272a4>//判断一下是否在IO线程里,如果是的话,设置一下flag,然后结束.
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#6272a4></span>      <span style=color:#6272a4>//因为redis的多线程只能用来读写网络,操作redis的数据库还是用单线的
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#6272a4></span>      <span style=color:#ff79c6>if</span> (io_threads_op <span style=color:#ff79c6>!=</span> IO_THREADS_OP_IDLE) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>          <span style=color:#50fa7b>serverAssert</span>(io_threads_op <span style=color:#ff79c6>==</span> IO_THREADS_OP_READ);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>          c<span style=color:#ff79c6>-&gt;</span>flags <span style=color:#ff79c6>|=</span> CLIENT_PENDING_COMMAND;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>          <span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>      }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>      <span style=color:#6272a4>//开始执行命令了
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span><span style=color:#6272a4></span>      <span style=color:#ff79c6>if</span> (<span style=color:#50fa7b>processCommandAndResetClient</span>(c) <span style=color:#ff79c6>==</span> C_ERR) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>          <span style=color:#ff79c6>return</span> C_ERR;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>      }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>  }
</span></span></code></pre></div><p>最终会调用 <a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/server.c#L3825 target=_blank rel=noopener>processCommand</a> 函数执行命令</p><p>执行命令的逻辑先不管，这不是本文的重点。</p><h3 id=写处理><a href=#%e5%86%99%e5%a4%84%e7%90%86 class=header-anchor></a>写处理</h3><p>当命令处理完成后，把有需要回复客户端的数据写入client的buf中。</p><p>最后会调用 <a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/networking.c#L1939 target=_blank rel=noopener>writeToClient</a> 函数把 client buf 中的数据写入到网络中，完成数据返回。</p><p><code>writeToClient</code> 有多个回调路径。但是都是由 <code>aeEventpool</code> 中的 <code>aftersleep</code> 函数指针 调用 <code>beforeSleep</code> 函数来完成的。</p><p>在 <code>beforeSleep</code> 中调用 <a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/server.c#L1738 target=_blank rel=noopener>handleClientsWithPendingWritesUsingThreads</a> 函数。</p><p>这个函数也比较长，就不贴了，只挑一些重点的。这期贴了不少源码，一直看源码，也挺枯燥的。这个函数的大概逻辑和 <code>handleClientsWithPendingReadsUsingThreads</code> 函数的差不多，只不过这里处理的是写网络。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>if</span> (server.io_threads_num <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>1</span> <span style=color:#ff79c6>||</span> <span style=color:#50fa7b>stopThreadedIOIfNeeded</span>()) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>    <span style=color:#ff79c6>return</span> <span style=color:#50fa7b>handleClientsWithPendingWrites</span>();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>}
</span></span></code></pre></div><p>这里判断一下，如果没有开启多线程或者停了IO线程，就使用 <code>handleClientsWithPendingWrites</code> 函数在主线程处理写逻辑。</p><p><a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/networking.c#L2023 target=_blank rel=noopener>handleClientsWithPendingWrites</a> 里的逻辑很简单，遍历 <code>server.clients_pending_write</code> 中的client，然后调用 <a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/networking.c#L1939 target=_blank rel=noopener>writeToClient</a> 把数据写入到网络中。</p><p>回到 <code>handleClientsWithPendingWritesUsingThreads</code> 函数中，调用 <code>startThreadedIO()</code> 启动 IO线程并发处理写入。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>//在主线程中也会处理写入
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#50fa7b>listRewind</span>(io_threads_list[<span style=color:#bd93f9>0</span>],<span style=color:#ff79c6>&amp;</span>li);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#ff79c6>while</span>((ln <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>listNext</span>(<span style=color:#ff79c6>&amp;</span>li))) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    client <span style=color:#ff79c6>*</span>c <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>listNodeValue</span>(ln);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#50fa7b>writeToClient</span>(c,<span style=color:#bd93f9>0</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#50fa7b>listEmpty</span>(io_threads_list[<span style=color:#bd93f9>0</span>]);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#6272a4>//和上面的多线程读一样,这里也会等待所有IO线程任务结束
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>while</span>(<span style=color:#bd93f9>1</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#8be9fd>unsigned</span> <span style=color:#8be9fd>long</span> pending <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> j <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>; j <span style=color:#ff79c6>&lt;</span> server.io_threads_num; j<span style=color:#ff79c6>++</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        pending <span style=color:#ff79c6>+=</span> <span style=color:#50fa7b>getIOPendingCount</span>(j);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    <span style=color:#ff79c6>if</span> (pending <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) <span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>}
</span></span></code></pre></div><p>到这基本redis的整个网络处理流程大概就写完了。注意，这只是个大概，其中的一些细节还没有深入分析。比如在 <code>aeProcessEvents</code> 函数中，为什么有 <code>beforesleep</code> 和 <code>aftersleep</code> 这两个函数指针，以及调用两个函数中的先后调用顺序。 <code>aeFileEvent</code> 中 <code>rfileProc</code> 和 <code>wfileProc</code> 这两个函数指针的调用顺序，以及调用的函数的逻辑。每一个都可以拿出来单独写一篇。</p><p>以后有时间在单独拿出来分析吧。如果有时间再这篇文章补一个流程图。</p><p>redis用C写的，C对多态的支持不太好，不像面向对象的语言那样，可以很方便的使用多态。所以在redis的源码里，大量使用了函数指针和回调函数，来间接的实现了多态。这样会在阅读源码的时候增加了很多理解成本。</p><p>但是鲁迅先生曾经说过，在断点面前，一切语法都是纸老虎。所以遇到复杂的函数调用逻辑，使用断点去看一下函数的调用关系，堆栈，基本都能解决问题。</p><p>也快过年了，提前祝所有读者 新年快乐</p></section><footer class=article-footer><section class=article-tags><a href=/tags/redis/>Redis</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>Licensed under CC BY-NC-SA 4.0</a></span></section><section class=article-copyright>暂时还懒得去弄评论区，有问题欢迎 <a href=mailto:lqxlucky@qq.com title=lqxlucky@qq.com rel=noopener target=_blank>邮件</a> 交流</section></footer><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css integrity=sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js integrity=sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8 crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous defer></script><script>window.addEventListener("DOMContentLoaded",()=>{renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}],ignoredClasses:["gist"]})})</script></article><aside class=related-content--wrapper><h2 class=section-title>相关文章</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/posts/1cb4847b/><div class=article-image><img src=https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/20210321231957647.png loading=lazy data-key=1cb4847b data-hash=https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/20210321231957647.png></div><div class=article-details><h2 class=article-title>redis ACL使用手册</h2></div></a></article><article class=has-image><a href=/posts/eeb1e692/><div class=article-image><img src=https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/174339-62bacd4b7f65d.png loading=lazy data-key=eeb1e692 data-hash=https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/174339-62bacd4b7f65d.png></div><div class=article-details><h2 class=article-title>redis源码学习|ACL</h2></div></a></article><article class=has-image><a href=/posts/aadf9734/><div class=article-image><img src=https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/2293d1c588ec113daecfde68815267b8.png loading=lazy data-key=aadf9734 data-hash=https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/2293d1c588ec113daecfde68815267b8.png></div><div class=article-details><h2 class=article-title>redis源码学习|watch</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2021 -
2025 QX 的笔记</section><section class=totalcount>发表了65篇文章 ·
总计159.74k字</section><footer class=running-time>本博客已稳定运行
<span id=runningdays class=running-days></span></footer><section class=powerby>© QX<br>使用 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> 构建<br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.27.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script><script>let s1="2021-10-1";s1=new Date(s1.replace(/-/g,"/"));let s2=new Date,timeDifference=s2.getTime()-s1.getTime(),days=Math.floor(timeDifference/(1e3*60*60*24)),hours=Math.floor(timeDifference%(1e3*60*60*24)/(1e3*60*60)),minutes=Math.floor(timeDifference%(1e3*60*60)/(1e3*60)),result=days+"天"+hours+"小时"+minutes+"分钟";document.getElementById("runningdays").innerHTML=result</script></body></html>