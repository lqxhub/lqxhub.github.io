<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="redisçš„ç½‘ç»œå¤„ç†æ˜¯redisçš„æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€ï¼Œredisçš„ç½‘ç»œå¤„ç†æ˜¯å•çº¿ç¨‹çš„ï¼Œè¿™é‡Œé€šè¿‡æºç åˆ†æï¼Œæ¥çœ‹ä¸€ä¸‹redisæ˜¯å¦‚ä½•å¤„ç†ç½‘ç»œçš„ã€‚"><meta name=keywords content="redis,æºç ,ç½‘ç»œ"><title>redisæºç å­¦ä¹ |ç½‘ç»œ redis ç½‘ç»œéƒ¨åˆ†æºç åˆ†æï¼Œå­¦ä¹ ã€‚redisç½‘ç»œå¤šè·¯å¤ç”¨ - QX's blog</title>
<link rel=canonical href=https://lqxhub.github.io/posts/bce71a0/><link rel=stylesheet href=/scss/style.min.cf20c5703e90831fa8051409d1786e3338f2624d07c5fe5f37ce747dbe09923c.css><meta property='og:title' content="redisæºç å­¦ä¹ |ç½‘ç»œ redis ç½‘ç»œéƒ¨åˆ†æºç åˆ†æï¼Œå­¦ä¹ ã€‚redisç½‘ç»œå¤šè·¯å¤ç”¨ - QX's blog"><meta property='og:description' content="redisçš„ç½‘ç»œå¤„ç†æ˜¯redisçš„æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€ï¼Œredisçš„ç½‘ç»œå¤„ç†æ˜¯å•çº¿ç¨‹çš„ï¼Œè¿™é‡Œé€šè¿‡æºç åˆ†æï¼Œæ¥çœ‹ä¸€ä¸‹redisæ˜¯å¦‚ä½•å¤„ç†ç½‘ç»œçš„ã€‚"><meta property='og:url' content='https://lqxhub.github.io/posts/bce71a0/'><meta property='og:site_name' content='QX çš„ç¬”è®°'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='redis'><meta property='article:published_time' content='2024-01-28T20:10:27+00:00'><meta property='article:modified_time' content='2024-01-28T20:10:27+00:00'><meta property='og:image' content='https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/OIP-C.R8n6zHAP4N2M01vSoRwkSQHaDW'><meta name=twitter:title content="redisæºç å­¦ä¹ |ç½‘ç»œ redis ç½‘ç»œéƒ¨åˆ†æºç åˆ†æï¼Œå­¦ä¹ ã€‚redisç½‘ç»œå¤šè·¯å¤ç”¨ - QX's blog"><meta name=twitter:description content="redisçš„ç½‘ç»œå¤„ç†æ˜¯redisçš„æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€ï¼Œredisçš„ç½‘ç»œå¤„ç†æ˜¯å•çº¿ç¨‹çš„ï¼Œè¿™é‡Œé€šè¿‡æºç åˆ†æï¼Œæ¥çœ‹ä¸€ä¸‹redisæ˜¯å¦‚ä½•å¤„ç†ç½‘ç»œçš„ã€‚"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/OIP-C.R8n6zHAP4N2M01vSoRwkSQHaDW'><link rel="shortcut icon" href=/favicon.ico><meta name=google-site-verification content="Ts78qICcAFtPJZg7DfwjJYFH2BsbYh7ICe1k6xMb-C8"><meta name=msvalidate.01 content="C538647907B2EAEBE650AAC7463E551F"><script async src="https://www.googletagmanager.com/gtag/js?id=G-BM48R77LCS"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-BM48R77LCS")</script><script src=https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js></script><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css><script src=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js></script><script src=https://fastly.jsdelivr.net/gh/stevenjoezhang/live2d-widget@latest/autoload.js></script><style>#waifu #live2d{cursor:grab;height:260px;position:relative;width:260px}#waifu-tips{width:230px}</style><div class=top-scroll-bar></div><style>.top-scroll-bar{position:fixed;top:0;left:0;z-index:9999;display:none;width:0;height:3px;background:#ef3982}</style><script>$(document).ready(function(){$(window).scroll(function(){$(".top-scroll-bar").attr("style","width: "+$(this).scrollTop()/($(document).height()-$(this).height())*100+"%; display: block;")})})</script><div id=back-top><a href=#top title=å›åˆ°é¡¶éƒ¨></a></div><style>#back-top{position:fixed;bottom:30px;right:80px}#back-top a{width:54px;height:54px;display:block;background:#ddd url(/images/back_top.svg)no-repeat 50%;background-color:rgba(218,214,214,.87);-webkit-border-radius:7px;-moz-border-radius:7px;border-radius:7px;-webkit-transition:1s;-moz-transition:1s;transition:1s}#back-top a:hover{background-color:#e88282}</style><script type=text/javascript>$("#back-top").hide(),$(document).ready(function(){$(window).scroll(function(){$(this).scrollTop()>100?$("#back-top").fadeIn():$("#back-top").fadeOut()}),$("#back-top a").click(function(){return $("body,html").animate({scrollTop:0},800),!1})})</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=åˆ‡æ¢èœå•>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu14972274666183315035.gif width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>ğŸ˜‰</span></figure><div class=site-meta><h1 class=site-name><a href=/>QX çš„ç¬”è®°</a></h1><h2 class=site-description>é›„å…³æ¼«é“çœŸå¦‚é“ï¼Œè€Œä»Šè¿ˆæ­¥ä»å¤´è¶Š</h2></div></header><ol class=menu-social><li><a href=mailto:lqxlucky@qq.com target=_blank title=Email rel=me><svg fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" class="icon icon-tabler icon-tabler-mail-flat"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 4h16a2 2 0 012 2v12a2 2 0 01-2 2H4a2 2 0 01-2-2V6a2 2 0 012-2z"/><path d="M4 6l8 5 8-5"/></svg></a></li><li><a href=https://github.com/lqxhub target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=/index.xml target=_blank title="RSS Feed" rel=me><svg class="icon icon-tabler icon-tabler-rss" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="5" cy="19" r="1"/><path d="M4 4a16 16 0 0116 16"/><path d="M4 11a9 9 0 019 9"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>é¦–é¡µ</span></a></li><li><a href=/categories><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg>
<span>åˆ†ç±»</span></a></li><li><a href=/archives><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>å½’æ¡£</span></a></li><li><a href=/tags><svg class="icon icon-tabler icon-tabler-tag" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11 3l9 9a1.5 1.5.0 010 2l-6 6a1.5 1.5.0 01-2 0L3 11V7a4 4 0 014-4h4"/><circle cx="9" cy="9" r="2"/></svg>
<span>æ ‡ç­¾</span></a></li><li><a href=/collect><svg fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" class="icon icon-tabler icon-tabler-bookmark"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 4h14a1 1 0 011 1v16l-8-4-8 4V5a1 1 0 011-1z"/></svg>
<span>æ”¶è—</span></a></li><li><a href=/tool><svg fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" class="icon icon-tabler icon-tabler-tools"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 15l-4 4m0-4 4 4"/><path d="M15 9l4-4m0 4-4-4"/><path d="M9 9l6 6"/><path d="M12 12l2-2"/><path d="M15 15l-2 2"/></svg>
<span>å·¥å…·</span></a></li><li><a href=/friend><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>å‹é“¾</span></a></li><li><a href=/search><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>æœç´¢</span></a></li><li><a href=/about><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>å…³äº</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>æš—è‰²æ¨¡å¼</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">ç›®å½•</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#æ•°æ®ç»“æ„>æ•°æ®ç»“æ„ï¼š</a></li><li><a href=#å¯åŠ¨ç½‘ç»œæœåŠ¡>å¯åŠ¨ç½‘ç»œæœåŠ¡</a><ol><li><a href=#ç›‘å¬client>ç›‘å¬client</a></li><li><a href=#ç›‘å¬cluster>ç›‘å¬cluster</a></li></ol></li><li><a href=#ç½‘ç»œè¯»å†™å¤„ç†>ç½‘ç»œè¯»å†™å¤„ç†</a><ol><li><a href=#listener-å›è°ƒ>Listener å›è°ƒ</a></li></ol></li><li><a href=#å¤„ç†clientè¯»å†™>å¤„ç†clientè¯»å†™</a><ol><li><a href=#è¯»å¤„ç†>è¯»å¤„ç†</a></li><li><a href=#å†™å¤„ç†>å†™å¤„ç†</a></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/posts/bce71a0/><img src=https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/OIP-C.R8n6zHAP4N2M01vSoRwkSQHaDW loading=lazy alt="Featured image of post redisæºç å­¦ä¹ |ç½‘ç»œ redis ç½‘ç»œéƒ¨åˆ†æºç åˆ†æï¼Œå­¦ä¹ ã€‚redisç½‘ç»œå¤šè·¯å¤ç”¨ - QX's blog"></a></div><div class=article-details><header class=article-category><a href=/categories/redis/>redis</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/posts/bce71a0/>redisæºç å­¦ä¹ |ç½‘ç»œ</a></h2><h3 class=article-subtitle>redisçš„ç½‘ç»œå¤„ç†æ˜¯redisçš„æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€ï¼Œredisçš„ç½‘ç»œå¤„ç†æ˜¯å•çº¿ç¨‹çš„ï¼Œè¿™é‡Œé€šè¿‡æºç åˆ†æï¼Œæ¥çœ‹ä¸€ä¸‹redisæ˜¯å¦‚ä½•å¤„ç†ç½‘ç»œçš„ã€‚</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Jan 28, 2024</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>é˜…è¯»æ—¶é•¿: 16 åˆ†é’Ÿ</time></div></footer></div></header><section class=article-content><p>å»å¹´å†™è¿‡ä¸¤ç¯‡redisçš„æºç åˆ†ææ–‡ç« ï¼ˆredisçš„watchå’ŒACLï¼‰ï¼Œç°åœ¨å›å¤´çœ‹ï¼Œå·²ç»è¿‡å»å¥½ä¹…äº†ã€‚è¯´èµ·é‚£ä¸¤ç¯‡æ–‡ç« ï¼Œæ”¶ç›Šè¿˜æ˜¯æŒºå¤§çš„ã€‚è¿™å‘¨æœ‰æ—¶é—´äº†ï¼Œç»§ç»­å­¦ä¹ redisçš„æºç ã€‚å…ˆæ¥çœ‹ä¸€ä¸‹redisçš„ç½‘ç»œå¤„ç†ã€‚</p><p>æœ¬æ¬¡çš„æºç åŸºäºredisçš„ <strong>7.2</strong> åˆ†æ”¯ï¼Œä¸åŒç‰ˆæœ¬ä¸‹ï¼Œä¸€äº›ç»†èŠ‚å¯èƒ½ä¼šæœ‰å·®å¼‚ã€‚</p><p>è¿™ç¯‡æ–‡ç« å› ä¸ºç¯‡å¹…æ‰€é™ï¼Œæ²¡æ³•æŠŠredisç½‘ç»œè¯»å†™çš„æ‰€æœ‰ç»†èŠ‚éƒ½åˆ†æåˆ°ï¼Œåªèƒ½æŠŠè¿™ä¸ªç½‘ç»œå¤„ç†çš„å¤§æ¦‚æµç¨‹èµ°ä¸€éã€‚</p><p>çœ‹å®Œè¿™ç¯‡æ–‡ç« ï¼Œèƒ½å¯¹redisç½‘ç»œå¤„ç†æµç¨‹æœ‰ä¸ªåŸºæœ¬äº†è§£ï¼Œèƒ½çŸ¥é“redisåŠ å…¥äº†å¤šçº¿ç¨‹åï¼Œä¸ºä»€ä¹ˆè¿˜æ˜¯å•çº¿ç¨‹å¤„ç†æ•°æ®ã€‚èƒ½çŸ¥é“redisæ˜¯å¦‚ä½•å®ç°é€‚é…ä¸åŒç³»ç»Ÿä¸‹ç½‘ç»œæ¥å£ã€‚</p><p>å…ˆæ¥å†™ä¸€ä¸‹redisç½‘ç»œéœ€è¦çš„ä¸€äº›æ•°æ®ç»“æ„ã€‚</p><h2 id=æ•°æ®ç»“æ„><a href=#%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84 class=header-anchor></a>æ•°æ®ç»“æ„ï¼š</h2><ul><li>rediså¯ä»¥æ”¯æŒå¤šä¸ªå¹³å°ï¼ˆLinuxï¼ŒUnixï¼‰ï¼Œè¿™ä¸¤ä¸ªå¹³å°çš„ç½‘ç»œè°ƒç”¨æ˜¯ä¸ä¸€æ ·çš„ï¼ŒLinuxä¸­é«˜æ€§èƒ½çš„ç½‘ç»œæ¥å£æ˜¯<strong>epoll</strong>ï¼ŒUnixä¸Šæ˜¯<strong>kqueue</strong>ã€‚å› ä¸ºç‰ˆæœ¬çš„åŸå› ï¼Œåœ¨ä½ç‰ˆæœ¬çš„Linuxå†…æ ¸ä¸­ï¼Œepoolä¹Ÿæ˜¯ä¸æ”¯æŒçš„ï¼Œè¿™æ—¶å€™å°±éœ€è¦ç”¨åˆ°<strong>select</strong>ã€‚redisä½¿ç”¨äº† <strong>aeEvent</strong> è¿™ä¸ªç»“æ„æ¥å°è£…äº†ç½‘ç»œï¼Œå®ç°äº†å¯¹ä¸åŒç½‘ç»œæ¥å£çš„å…¼å®¹ã€‚</li></ul><p>ç»“æ„çš„å®šä¹‰åœ¨ <code>ae.h</code> æ–‡ä»¶ä¸­ <a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/ae.h#L99-L111 target=_blank rel=noopener>aeEventLoop</a></p><p><strong>aeEventLoop</strong> æ˜¯redisç½‘ç»œä¸­ï¼Œæ‰€æœ‰ç½‘ç»œäº‹ä»¶çš„ç®¡ç†å™¨ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œç°åœ¨çš„ç½‘ç»œä¸€èˆ¬éƒ½æ˜¯é€šè¿‡å¤šè·¯å¤ç”¨æ¥å¤„ç†å¤šä¸ªé“¾æ¥ï¼Œå¤šè·¯å¤ç”¨çš„å®ç°åœ¨ä¸åŒçš„ç³»ç»Ÿä¸­æœ‰ä¸åŒçš„å®ç°ï¼Œæ‰€æœ‰redisä½¿ç”¨ <code>aeEventLoop</code> çš„å°è£…æ¥å®ç°ä¸åŒå¹³å°çš„å…¼å®¹ã€‚è¿™ä¸ªç»“æ„æ˜¯å…¨å±€å”¯ä¸€çš„ï¼Œrediså¯åŠ¨åå®Œæˆåˆå§‹åŒ–ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>typedef</span> <span style=color:#ff79c6>struct</span> aeEventLoop {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    <span style=color:#8be9fd>int</span> maxfd;   <span style=color:#6272a4>/* highest file descriptor currently registered */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#8be9fd>int</span> setsize; <span style=color:#6272a4>/* max number of file descriptors tracked */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#8be9fd>long</span> <span style=color:#8be9fd>long</span> timeEventNextId;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    aeFileEvent <span style=color:#ff79c6>*</span>events; <span style=color:#6272a4>/* Registered events */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    aeFiredEvent <span style=color:#ff79c6>*</span>fired; <span style=color:#6272a4>/* Fired events */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    aeTimeEvent <span style=color:#ff79c6>*</span>timeEventHead;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#8be9fd>int</span> stop;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#8be9fd>void</span> <span style=color:#ff79c6>*</span>apidata; <span style=color:#6272a4>/* This is used for polling API specific data */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    aeBeforeSleepProc <span style=color:#ff79c6>*</span>beforesleep;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    aeBeforeSleepProc <span style=color:#ff79c6>*</span>aftersleep;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#8be9fd>int</span> flags;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>} aeEventLoop;
</span></span></code></pre></div><p><code>aeFileEvent</code> å’Œ <code>aeFiredEvent</code> æ˜¯å¤„ç†ç½‘ç»œäº‹ä»¶çš„æ•°ç»„ç»“æ„ï¼Œ<code>aeTimeEvent</code> æ˜¯å¤„ç†rediså®šæ—¶å›è°ƒçš„ç»“æ„æ•°ç»„ã€‚</p><ul><li><code>aeFileEvent</code> æ˜¯æ³¨å†Œåˆ°ç³»ç»Ÿä¸­çš„äº‹ä»¶ï¼Œåœ¨ epoll ä¸­å°±æ˜¯ <code>struct epoll_event</code> ç»“æ„ã€‚</li><li><code>aeFiredEvent</code> æ˜¯è¿™æ¬¡è¦å¤„ç†çš„äº‹ä»¶ã€‚åœ¨ epoll ä¸­å°±æ˜¯ é€šè¿‡ <code>epoll_wait</code> è¿”å›çš„äº‹ä»¶ã€‚</li><li><code>timeEventHead</code> æ˜¯å®šæ—¶å™¨è¦å¤„ç†çš„äº‹ä»¶ã€‚</li></ul><p><strong>aeFileEvent</strong> æ˜¯redisä¸­ï¼Œå¤šè·¯å¤ç”¨çš„äº‹ä»¶å°è£…ã€‚æ¯ä¸€ä¸ªç½‘ç»œé“¾æ¥éƒ½ä¼šè¢«åŒ…è£…æˆä¸€ä¸ª <code>aeFileEvent</code> å¯¹è±¡ï¼Œï¼ˆå› ä¸ºåœ¨ Unixç³»åˆ—çš„ç³»ç»Ÿä¸­ï¼Œä¸‡ç‰©çš†æ˜¯æ–‡ä»¶å˜›ï¼Œæ‰€æœ‰è¿™é‡Œä¹Ÿå°±å« <code>aeFileEvent</code>äº†ï¼‰ï¼Œç„¶ååŠ å…¥åˆ° <code>aeEventLoop</code> ä¸­ï¼Œæœ€åäº¤ç»™æ“ä½œç³»ç»Ÿä¸­çš„å¤šè·¯å¤ç”¨ç®¡ç†ã€‚å½“è¢«ç®¡ç†çš„äº‹ä»¶è¢«è§¦å‘åï¼Œä¼šå›è°ƒå¯¹åº”çš„å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯ <code>rfileProc</code> æˆ–è€… <code>wfileProc</code> å‡½æ•°æŒ‡é’ˆï¼Œæ¥å®Œæˆæ“ä½œã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>typedef</span> <span style=color:#ff79c6>struct</span> aeFileEvent {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>    <span style=color:#8be9fd>int</span> mask; <span style=color:#6272a4>/* one of AE_(READABLE|WRITABLE|BARRIER) */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>    aeFileProc <span style=color:#ff79c6>*</span>rfileProc;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>    aeFileProc <span style=color:#ff79c6>*</span>wfileProc;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>    <span style=color:#8be9fd>void</span> <span style=color:#ff79c6>*</span>clientData;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>} aeFileEvent;
</span></span></code></pre></div><p>ç½‘ç»œå¤„ç†çš„å®ç°åœ¨ <code>ae.c</code> ä¸­</p><p>åœ¨<code>ae.c</code>ä¸­ï¼Œé€šè¿‡å®å®šä¹‰ï¼Œæ¥å®ç°å¯¹ä¸åŒå¹³å°çš„å…¼å®¹</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>#ifdef HAVE_EVPORT
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#ff79c6>#include</span> <span style=color:#ff79c6>&#34;ae_evport.c&#34;</span><span style=color:#ff79c6>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#ff79c6>#else
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#ff79c6></span>    <span style=color:#ff79c6>#ifdef HAVE_EPOLL
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#ff79c6></span>    <span style=color:#ff79c6>#include</span> <span style=color:#ff79c6>&#34;ae_epoll.c&#34;</span><span style=color:#ff79c6>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#ff79c6></span>    <span style=color:#ff79c6>#else
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#ff79c6></span>        <span style=color:#ff79c6>#ifdef HAVE_KQUEUE
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#ff79c6></span>        <span style=color:#ff79c6>#include</span> <span style=color:#ff79c6>&#34;ae_kqueue.c&#34;</span><span style=color:#ff79c6>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#ff79c6></span>        <span style=color:#ff79c6>#else
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#ff79c6></span>        <span style=color:#ff79c6>#include</span> <span style=color:#ff79c6>&#34;ae_select.c&#34;</span><span style=color:#ff79c6>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#ff79c6></span>        <span style=color:#ff79c6>#endif
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#ff79c6></span>    <span style=color:#ff79c6>#endif
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#ff79c6>#endif
</span></span></span></code></pre></div><p><a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/ae.c#L52-L64 target=_blank rel=noopener>ae.c#L52-L65</a>
é€šè¿‡åˆ¤æ–­å®å®šä¹‰ï¼Œç„¶åincludeä¸åŒçš„ .cæ–‡ä»¶ã€‚</p><p>è¿™é‡Œå¯èƒ½æœ‰å¯¹Cè¯­è¨€äº†è§£ä¸æ·±çš„åŒå­¦å¯èƒ½ä¼šç–‘é—®ï¼Œ<code>include</code> å…³é”®å­—ä¸æ˜¯ç”¨æ¥åŒ…å«å¤´æ–‡ä»¶çš„å—ï¼Œè¿˜èƒ½ç”¨æ¥å¼•å…¥ .cæ–‡ä»¶å—ï¼Ÿå…¶å®includeæ˜¯ç¼–è¯‘å™¨çš„ä¸€ä¸ªé¢„å¤„ç†æŒ‡ä»¤ï¼Œå°±æ˜¯ç®€å•çš„æŠŠå¯¹åº”çš„æ–‡ä»¶é‡Œçš„æ‰€æœ‰å†…å®¹ï¼Œæ”¾åˆ°includeçš„åœ°æ–¹è€Œå·²ã€‚</p><p>æ‰“å¼€ <code>ae_evport.c</code> <code>ae_epoll.c</code> <code>ae_kqueue.c</code> <code>ae_select.c</code> è¿™å››ä¸ªæ–‡ä»¶æ¥çœ‹ï¼Œå¯¹å¤–æš´éœ²çš„å‡½æ•°æ¥å£éƒ½æ˜¯ä¸€æ ·çš„ã€‚åªæ˜¯åœ¨ä¸åŒçš„å¹³å°ä¸Šå†…éƒ¨çš„å¤„ç†ä¸åŒã€‚</p><p>å¯¹å¤–æš´éœ²äº†è¿™äº›å‡½æ•°ï¼Œæ¥å®Œæˆç½‘ç»œçš„å¤„ç†</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>//åˆ›å»ºä¸€ä¸ªloop
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>static</span> <span style=color:#8be9fd>int</span> <span style=color:#50fa7b>aeApiCreate</span>(aeEventLoop <span style=color:#ff79c6>*</span>eventLoop)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#6272a4>//è®¾ç½®loopçš„å¤§å°
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>static</span> <span style=color:#8be9fd>int</span> <span style=color:#50fa7b>aeApiResize</span>(aeEventLoop <span style=color:#ff79c6>*</span>eventLoop, <span style=color:#8be9fd>int</span> setsize)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#6272a4>//é‡Šæ”¾ä¸€ä¸ª loop
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>static</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>aeApiFree</span>(aeEventLoop <span style=color:#ff79c6>*</span>eventLoop)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#6272a4>//æ·»åŠ ä¸€ä¸ª eventLoop
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>static</span> <span style=color:#8be9fd>int</span> <span style=color:#50fa7b>aeApiAddEvent</span>(aeEventLoop <span style=color:#ff79c6>*</span>eventLoop, <span style=color:#8be9fd>int</span> fd, <span style=color:#8be9fd>int</span> mask)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#6272a4>//åˆ é™¤ä¸€ä¸ª eventLoop
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>static</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>aeApiDelEvent</span>(aeEventLoop <span style=color:#ff79c6>*</span>eventLoop, <span style=color:#8be9fd>int</span> fd, <span style=color:#8be9fd>int</span> delmask)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#6272a4>//ä¸åŒçš„ç½‘ç»œå¤„ç†ä¸­,è¿”å›éœ€è¦å¤„ç†çš„äº‹ä»¶
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>static</span> <span style=color:#8be9fd>int</span> <span style=color:#50fa7b>aeApiPoll</span>(aeEventLoop <span style=color:#ff79c6>*</span>eventLoop, <span style=color:#ff79c6>struct</span> timeval <span style=color:#ff79c6>*</span>tvp)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#6272a4>//è¿”å›è¿™ä¸ªaeçš„åå­—,åœ¨epollä¸­å°±æ˜¯è¿”å› &#34;epoll&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>static</span> <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span><span style=color:#50fa7b>aeApiName</span>(<span style=color:#8be9fd>void</span>)
</span></span></code></pre></div><p>è¿™é‡Œæˆ‘ä»¬ä»¥Linuxå¹³å°ä¸ºä¸»ï¼Œæ‰€ä»¥ä½¿ç”¨çš„æ˜¯ <code>ae_epoll.c</code>æ–‡ä»¶ä¸­çš„å†…å®¹ã€‚è¿™é‡Œå…ˆä¸å±•å¼€åˆ†ææ¯ä¸€ä¸ªå‡½æ•°ï¼Œå› ä¸ºè¿™ä¸æ˜¯æœ¬æ¬¡çš„é‡ç‚¹ã€‚</p><h2 id=å¯åŠ¨ç½‘ç»œæœåŠ¡><a href=#%e5%90%af%e5%8a%a8%e7%bd%91%e7%bb%9c%e6%9c%8d%e5%8a%a1 class=header-anchor></a>å¯åŠ¨ç½‘ç»œæœåŠ¡</h2><p>åŸºæœ¬çš„æ•°æ®ç»“æ„ä»‹ç»å®Œï¼Œä¸‹é¢å¼€å§‹å¯åŠ¨ç½‘ç»œæœåŠ¡</p><h3 id=ç›‘å¬client><a href=#%e7%9b%91%e5%90%acclient class=header-anchor></a>ç›‘å¬client</h3><p>ç¬¬ä¸€æ­¥æ˜¯è°ƒç”¨ <code>aeEventLoop *aeCreateEventLoop(int setsize)</code> å‡½æ•°ï¼Œåˆ›å»º <code>aeEventLoop</code> è¿™ä¸ªå¯¹è±¡ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>aeEventLoop <span style=color:#ff79c6>*</span><span style=color:#50fa7b>aeCreateEventLoop</span>(<span style=color:#8be9fd>int</span> setsize) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    aeEventLoop <span style=color:#ff79c6>*</span>eventLoop;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#8be9fd>int</span> i;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#50fa7b>monotonicInit</span>();    <span style=color:#6272a4>/* just in case the calling app didn&#39;t initialize */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#ff79c6>if</span> ((eventLoop <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>zmalloc</span>(<span style=color:#ff79c6>sizeof</span>(<span style=color:#ff79c6>*</span>eventLoop))) <span style=color:#ff79c6>==</span> <span style=color:#8be9fd;font-style:italic>NULL</span>) <span style=color:#ff79c6>goto</span> err;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    eventLoop<span style=color:#ff79c6>-&gt;</span>events <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>zmalloc</span>(<span style=color:#ff79c6>sizeof</span>(aeFileEvent)<span style=color:#ff79c6>*</span>setsize);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    eventLoop<span style=color:#ff79c6>-&gt;</span>fired <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>zmalloc</span>(<span style=color:#ff79c6>sizeof</span>(aeFiredEvent)<span style=color:#ff79c6>*</span>setsize);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#ff79c6>if</span> (eventLoop<span style=color:#ff79c6>-&gt;</span>events <span style=color:#ff79c6>==</span> <span style=color:#8be9fd;font-style:italic>NULL</span> <span style=color:#ff79c6>||</span> eventLoop<span style=color:#ff79c6>-&gt;</span>fired <span style=color:#ff79c6>==</span> <span style=color:#8be9fd;font-style:italic>NULL</span>) <span style=color:#ff79c6>goto</span> err;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    eventLoop<span style=color:#ff79c6>-&gt;</span>setsize <span style=color:#ff79c6>=</span> setsize;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    eventLoop<span style=color:#ff79c6>-&gt;</span>timeEventHead <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    eventLoop<span style=color:#ff79c6>-&gt;</span>timeEventNextId <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    eventLoop<span style=color:#ff79c6>-&gt;</span>stop <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    eventLoop<span style=color:#ff79c6>-&gt;</span>maxfd <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>-</span><span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    eventLoop<span style=color:#ff79c6>-&gt;</span>beforesleep <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    eventLoop<span style=color:#ff79c6>-&gt;</span>aftersleep <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    eventLoop<span style=color:#ff79c6>-&gt;</span>flags <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    <span style=color:#ff79c6>if</span> (<span style=color:#50fa7b>aeApiCreate</span>(eventLoop) <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>-</span><span style=color:#bd93f9>1</span>) <span style=color:#ff79c6>goto</span> err;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>    <span style=color:#6272a4>/* Events with mask == AE_NONE are not set. So let&#39;s initialize the
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#6272a4>     * vector with it. */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>    <span style=color:#ff79c6>for</span> (i <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; i <span style=color:#ff79c6>&lt;</span> setsize; i<span style=color:#ff79c6>++</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>        eventLoop<span style=color:#ff79c6>-&gt;</span>events[i].mask <span style=color:#ff79c6>=</span> AE_NONE;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>    <span style=color:#ff79c6>return</span> eventLoop;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span><span style=color:#8be9fd;font-style:italic>err</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>    <span style=color:#ff79c6>if</span> (eventLoop) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>        <span style=color:#50fa7b>zfree</span>(eventLoop<span style=color:#ff79c6>-&gt;</span>events);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>        <span style=color:#50fa7b>zfree</span>(eventLoop<span style=color:#ff79c6>-&gt;</span>fired);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>        <span style=color:#50fa7b>zfree</span>(eventLoop);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>    <span style=color:#ff79c6>return</span> <span style=color:#8be9fd;font-style:italic>NULL</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>}
</span></span></code></pre></div><p>è¿™é‡Œçš„å¤„ç†é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯åˆå§‹åŒ– <code>aeEventLoop</code> ä¸­çš„æ•°æ®ç»“æ„ã€‚å¦‚æœä¸­é—´å‡ºé”™äº†ï¼Œå°±è¿”å› <code>NULL</code></p><p>è¿™ä¸ªåœ¨ <code>void initServer(void)</code> å‡½æ•°ä¸­è¢«è°ƒç”¨ã€‚
<a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/server.c#L2622 target=_blank rel=noopener>aeCreateEventLoop</a></p><p>åˆ›å»ºä¸€ä¸ª<code>aeEventLoop</code> å¹¶èµ‹å€¼ç»™ <code>server</code>ã€‚å†å¾€ä¸Šç¿»ï¼Œæœ€ç»ˆçš„è°ƒç”¨ä½ç½®æ˜¯ <code>main</code> å‡½æ•°ä¸­çš„<a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/server.c#L7298 target=_blank rel=noopener>initServer();</a></p><p>åœ¨å¾€ä¸‹ï¼Œè¿˜æœ‰ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„å‡½æ•°ï¼Œé€šè¿‡è°ƒç”¨ <a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/server.c#L2711 target=_blank rel=noopener>aeCreateTimeEvent</a> å‡½æ•°ï¼Œå®Œæˆå®šæ—¶å™¨ å¯¹åº”çš„ <code>eventLoop</code> çš„åˆ›å»ºã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#8be9fd>long</span> <span style=color:#8be9fd>long</span> <span style=color:#50fa7b>aeCreateTimeEvent</span>(aeEventLoop <span style=color:#ff79c6>*</span>eventLoop, <span style=color:#8be9fd>long</span> <span style=color:#8be9fd>long</span> milliseconds,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>        aeTimeProc <span style=color:#ff79c6>*</span>proc, <span style=color:#8be9fd>void</span> <span style=color:#ff79c6>*</span>clientData,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>        aeEventFinalizerProc <span style=color:#ff79c6>*</span>finalizerProc)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#8be9fd>long</span> <span style=color:#8be9fd>long</span> id <span style=color:#ff79c6>=</span> eventLoop<span style=color:#ff79c6>-&gt;</span>timeEventNextId<span style=color:#ff79c6>++</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    aeTimeEvent <span style=color:#ff79c6>*</span>te;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    te <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>zmalloc</span>(<span style=color:#ff79c6>sizeof</span>(<span style=color:#ff79c6>*</span>te));
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#ff79c6>if</span> (te <span style=color:#ff79c6>==</span> <span style=color:#8be9fd;font-style:italic>NULL</span>) <span style=color:#ff79c6>return</span> AE_ERR;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    te<span style=color:#ff79c6>-&gt;</span>id <span style=color:#ff79c6>=</span> id;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    te<span style=color:#ff79c6>-&gt;</span>when <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>getMonotonicUs</span>() <span style=color:#ff79c6>+</span> milliseconds <span style=color:#ff79c6>*</span> <span style=color:#bd93f9>1000</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    te<span style=color:#ff79c6>-&gt;</span>timeProc <span style=color:#ff79c6>=</span> proc;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    te<span style=color:#ff79c6>-&gt;</span>finalizerProc <span style=color:#ff79c6>=</span> finalizerProc;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    te<span style=color:#ff79c6>-&gt;</span>clientData <span style=color:#ff79c6>=</span> clientData;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    te<span style=color:#ff79c6>-&gt;</span>prev <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    te<span style=color:#ff79c6>-&gt;</span>next <span style=color:#ff79c6>=</span> eventLoop<span style=color:#ff79c6>-&gt;</span>timeEventHead;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    te<span style=color:#ff79c6>-&gt;</span>refcount <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    <span style=color:#ff79c6>if</span> (te<span style=color:#ff79c6>-&gt;</span>next)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>        te<span style=color:#ff79c6>-&gt;</span>next<span style=color:#ff79c6>-&gt;</span>prev <span style=color:#ff79c6>=</span> te;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>    eventLoop<span style=color:#ff79c6>-&gt;</span>timeEventHead <span style=color:#ff79c6>=</span> te;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>    <span style=color:#ff79c6>return</span> id;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>}
</span></span></code></pre></div><p>éƒ½æ˜¯å¸¸è§„çš„å¤„ç†ï¼Œæ³¨æ„ä¸€ä¸‹ä¼ é€’è¿›æ¥çš„å‡ ä¸ªå‚æ•°</p><ul><li><code>eventLoop</code> æ˜¯ä¹‹å‰åˆ›å»ºçš„ eventLoopå¯¹è±¡</li><li><code>proc</code> æ˜¯å®šæ—¶å™¨è§¦å‘æ—¶çš„å›è°ƒå‡½æ•°</li><li><code>milliseconds</code> å®šæ—¶å™¨è§¦å‘çš„æ—¶é—´é—´éš”</li></ul><p><a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/server.c#L1260 target=_blank rel=noopener>proc</a> å‡½æ•°çš„å®šä¹‰</p><p>è¿™é‡Œä¸è¯¦ç»†å±•å¼€äº†ï¼Œå°±æ˜¯redisä¸­çš„ä¸€äº›å®šæ—¶æ“ä½œã€‚</p><p>åœ¨ <code>main</code> å‡½æ•°ä¸­ç»§ç»­å¾€ä¸‹ï¼Œä¼šçœ‹åˆ° <code>initListeners();</code> è¿™ä¸ªå‡½æ•°ï¼Œä¸­è¿™é‡Œä¹Ÿèƒ½çŸ¥é“ï¼Œè¿™é‡Œåˆ›å»º ç½‘ç»œçš„ç›‘å¬</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>initListeners</span>(<span style=color:#8be9fd>void</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    <span style=color:#6272a4>/* Setup listeners from server config for TCP/TLS/Unix */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#8be9fd>int</span> conn_index;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    connListener <span style=color:#ff79c6>*</span>listener;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#6272a4>//åˆ¤æ–­æ˜¯å¦éœ€è¦ç›‘å¬æ™®é€šçš„TCP
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>if</span> (server.port <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>        conn_index <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>connectionIndexByType</span>(CONN_TYPE_SOCKET);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>        <span style=color:#ff79c6>if</span> (conn_index <span style=color:#ff79c6>&lt;</span> <span style=color:#bd93f9>0</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>            <span style=color:#50fa7b>serverPanic</span>(<span style=color:#f1fa8c>&#34;Failed finding connection listener of %s&#34;</span>, CONN_TYPE_SOCKET);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>        listener <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>&amp;</span>server.listeners[conn_index];
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>        listener<span style=color:#ff79c6>-&gt;</span>bindaddr <span style=color:#ff79c6>=</span> server.bindaddr;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        listener<span style=color:#ff79c6>-&gt;</span>bindaddr_count <span style=color:#ff79c6>=</span> server.bindaddr_count;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>        listener<span style=color:#ff79c6>-&gt;</span>port <span style=color:#ff79c6>=</span> server.port;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>        listener<span style=color:#ff79c6>-&gt;</span>ct <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>connectionByType</span>(CONN_TYPE_SOCKET);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    <span style=color:#6272a4>//åˆ¤æ–­æ˜¯å¦éœ€è¦ç›‘å¬,å¦‚æœéœ€è¦,æ£€æŸ¥tlséœ€è¦çš„é…ç½®æ˜¯å¦æ­£ç¡®
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>if</span> (server.tls_port <span style=color:#ff79c6>||</span> server.tls_replication <span style=color:#ff79c6>||</span> server.tls_cluster) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>        ConnectionType <span style=color:#ff79c6>*</span>ct_tls <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>connectionTypeTls</span>();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>        <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>ct_tls) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>            <span style=color:#50fa7b>serverLog</span>(LL_WARNING, <span style=color:#f1fa8c>&#34;Failed finding TLS support.&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>            <span style=color:#50fa7b>exit</span>(<span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>        <span style=color:#ff79c6>if</span> (<span style=color:#50fa7b>connTypeConfigure</span>(ct_tls, <span style=color:#ff79c6>&amp;</span>server.tls_ctx_config, <span style=color:#bd93f9>1</span>) <span style=color:#ff79c6>==</span> C_ERR) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>            <span style=color:#50fa7b>serverLog</span>(LL_WARNING, <span style=color:#f1fa8c>&#34;Failed to configure TLS. Check logs for more info.&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>            <span style=color:#50fa7b>exit</span>(<span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>    <span style=color:#6272a4>//åˆ¤æ–­æ˜¯å¦éœ€è¦ç›‘å¬ TLSçš„TCP
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>if</span> (server.tls_port <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>        conn_index <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>connectionIndexByType</span>(CONN_TYPE_TLS);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>        <span style=color:#ff79c6>if</span> (conn_index <span style=color:#ff79c6>&lt;</span> <span style=color:#bd93f9>0</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>            <span style=color:#50fa7b>serverPanic</span>(<span style=color:#f1fa8c>&#34;Failed finding connection listener of %s&#34;</span>, CONN_TYPE_TLS);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>        listener <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>&amp;</span>server.listeners[conn_index];
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>        listener<span style=color:#ff79c6>-&gt;</span>bindaddr <span style=color:#ff79c6>=</span> server.bindaddr;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>        listener<span style=color:#ff79c6>-&gt;</span>bindaddr_count <span style=color:#ff79c6>=</span> server.bindaddr_count;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>        listener<span style=color:#ff79c6>-&gt;</span>port <span style=color:#ff79c6>=</span> server.tls_port;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>        listener<span style=color:#ff79c6>-&gt;</span>ct <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>connectionByType</span>(CONN_TYPE_TLS);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>    <span style=color:#6272a4>//åˆ¤æ–­æ˜¯å¦éœ€è¦unixsocket
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>if</span> (server.unixsocket <span style=color:#ff79c6>!=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>        conn_index <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>connectionIndexByType</span>(CONN_TYPE_UNIX);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>        <span style=color:#ff79c6>if</span> (conn_index <span style=color:#ff79c6>&lt;</span> <span style=color:#bd93f9>0</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>            <span style=color:#50fa7b>serverPanic</span>(<span style=color:#f1fa8c>&#34;Failed finding connection listener of %s&#34;</span>, CONN_TYPE_UNIX);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>        listener <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>&amp;</span>server.listeners[conn_index];
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span>        listener<span style=color:#ff79c6>-&gt;</span>bindaddr <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>&amp;</span>server.unixsocket;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span>        listener<span style=color:#ff79c6>-&gt;</span>bindaddr_count <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span>        listener<span style=color:#ff79c6>-&gt;</span>ct <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>connectionByType</span>(CONN_TYPE_UNIX);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span>        listener<span style=color:#ff79c6>-&gt;</span>priv <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>&amp;</span>server.unixsocketperm; <span style=color:#6272a4>/* Unix socket specified */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span><span>    <span style=color:#6272a4>/* create all the configured listener, and add handler to start to accept */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span><span>    <span style=color:#8be9fd>int</span> listen_fds <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53</span><span>    <span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> j <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; j <span style=color:#ff79c6>&lt;</span> CONN_TYPE_MAX; j<span style=color:#ff79c6>++</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54</span><span>        listener <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>&amp;</span>server.listeners[j];
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55</span><span>        <span style=color:#ff79c6>if</span> (listener<span style=color:#ff79c6>-&gt;</span>ct <span style=color:#ff79c6>==</span> <span style=color:#8be9fd;font-style:italic>NULL</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56</span><span>            <span style=color:#ff79c6>continue</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58</span><span>        <span style=color:#ff79c6>if</span> (<span style=color:#50fa7b>connListen</span>(listener) <span style=color:#ff79c6>==</span> C_ERR) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59</span><span>            <span style=color:#50fa7b>serverLog</span>(LL_WARNING, <span style=color:#f1fa8c>&#34;Failed listening on port %u (%s), aborting.&#34;</span>, listener<span style=color:#ff79c6>-&gt;</span>port, listener<span style=color:#ff79c6>-&gt;</span>ct<span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>get_type</span>(<span style=color:#8be9fd;font-style:italic>NULL</span>));
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60</span><span>            <span style=color:#50fa7b>exit</span>(<span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62</span><span>        <span style=color:#6272a4>//åˆ›å»ºæ–°çš„è¿æ¥å¤„ç†äº‹ä»¶
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63</span><span><span style=color:#6272a4></span>        <span style=color:#ff79c6>if</span> (<span style=color:#50fa7b>createSocketAcceptHandler</span>(listener, <span style=color:#50fa7b>connAcceptHandler</span>(listener<span style=color:#ff79c6>-&gt;</span>ct)) <span style=color:#ff79c6>!=</span> C_OK)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64</span><span>            <span style=color:#50fa7b>serverPanic</span>(<span style=color:#f1fa8c>&#34;Unrecoverable error creating %s listener accept handler.&#34;</span>, listener<span style=color:#ff79c6>-&gt;</span>ct<span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>get_type</span>(<span style=color:#8be9fd;font-style:italic>NULL</span>));
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66</span><span>       listen_fds <span style=color:#ff79c6>+=</span> listener<span style=color:#ff79c6>-&gt;</span>count;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">69</span><span>    <span style=color:#ff79c6>if</span> (listen_fds <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">70</span><span>        <span style=color:#50fa7b>serverLog</span>(LL_WARNING, <span style=color:#f1fa8c>&#34;Configured to not listen anywhere, exiting.&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">71</span><span>        <span style=color:#50fa7b>exit</span>(<span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">72</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">73</span><span>}
</span></span></code></pre></div><p>åœ¨è¿™ä¸ªå‡½æ•°é‡Œï¼Œæ ¹æ®é…ç½®æ–‡ä»¶ï¼Œå¼€å§‹ç›‘å¬å¯¹åº”çš„ç«¯å£æˆ–è€… unixsocktã€‚</p><p>è¿™é‡Œå¼•å…¥äº† <code>connListener</code> <code>connection</code> <code>ConnectionType</code> è¿™ä¸‰ä¸ªç»“æ„</p><ul><li><code>connListener</code> æ˜¯å¯¹ç½‘ç»œç›‘å¬çš„å°è£…</li><li><code>connection</code> æ˜¯å¯¹ç½‘ç»œè¿æ¥çš„å°è£…</li><li><code>ConnectionType</code> å°è£…äº†æ“ä½œç½‘ç»œéœ€è¦çš„å‡½æ•°</li></ul><p><code>ConnectionType</code> æœ‰ä¸‰ä¸ªä¸åŒçš„å®ç°ï¼Œåˆ†åˆ«æ˜¯:</p><ul><li><code>CT_Socket</code> å¯¹åº”çš„TCP <a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/socket.c#L52 target=_blank rel=noopener>CT_Socket</a></li><li><code>CT_Unix</code> å¯¹åº”çš„æ˜¯ unix socket <a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/unix.c#L30 target=_blank rel=noopener>CT_Unix</a></li><li><code>CT_TLS</code> å¯¹åº”çš„ ä½¿ç”¨äº† TLSçš„TCP <a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/tls.c#L424 target=_blank rel=noopener>CT_TLS</a></li></ul><p><a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/connection.h#L68-L140 target=_blank rel=noopener>ConnectionType å®šä¹‰</a></p><p>ConnectionTypeå†…éƒ¨çš„å‡½æ•°è¿™é‡Œå°±ä¸å±•å¼€è¯¦ç»†ä»‹ç»äº†ã€‚</p><p>åœ¨ <code>initListeners</code> ä¸­è°ƒç”¨äº† <code>connListen</code> å‡½æ•°ï¼Œæ¥å®Œæˆå¯¹ä¸åŒç½‘ç»œçš„ç›‘å¬ï¼Œè¿™é‡Œå®ç°ä¹ŸæŒºç®€å•çš„ï¼Œå°±æ˜¯è°ƒç”¨äº†<code>ConnectionType</code> ä¸­çš„ <code>listen</code> å‡½æ•°ï¼Œå®Œæˆäº†å¯¹ç«¯å£æˆ–è€…unixsocketçš„ç›‘å¬ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>static</span> <span style=color:#ff79c6>inline</span> <span style=color:#8be9fd>int</span> <span style=color:#50fa7b>connListen</span>(connListener <span style=color:#ff79c6>*</span>listener) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>    <span style=color:#ff79c6>return</span> listener<span style=color:#ff79c6>-&gt;</span>ct<span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>listen</span>(listener);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>}
</span></span></code></pre></div><p>ä»¥ <code>socket</code> ä¸ºä¾‹ï¼Œå¯¹åº”çš„listenå‡½æ•°å°±æ˜¯ <code>connSocketListen</code> å¯¹åº”çš„åˆå§‹åŒ–åœ¨è¿™é‡Œ<a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/socket.c#L406 target=_blank rel=noopener>.listen = connSocketListen</a></p><p>æœ€ç»ˆå®ç°å¯¹ç«¯å£ç›‘å¬çš„å‡½æ•°æ˜¯ <a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/server.c#L2446 target=_blank rel=noopener>listenToPort(connListener *sfd)</a></p><p>è¯é¢˜æ”¶å›æ¥ï¼Œå›åˆ° <code>initListeners</code> å‡½æ•°ä¸­ è°ƒç”¨ <code>connListen</code> å‡½æ•°å®Œæˆç›‘å¬åï¼Œä¼šå†è°ƒç”¨<code>createSocketAcceptHandler</code> å‡½æ•° å®Œæˆç½‘ç»œçš„ <code>Accept</code> å¤„ç†é€»è¾‘ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>createSocketAcceptHandler</span>(connListener <span style=color:#ff79c6>*</span>sfd, aeFileProc <span style=color:#ff79c6>*</span>accept_handler) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    <span style=color:#8be9fd>int</span> j;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#ff79c6>for</span> (j <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; j <span style=color:#ff79c6>&lt;</span> sfd<span style=color:#ff79c6>-&gt;</span>count; j<span style=color:#ff79c6>++</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>        <span style=color:#ff79c6>if</span> (<span style=color:#50fa7b>aeCreateFileEvent</span>(server.el, sfd<span style=color:#ff79c6>-&gt;</span>fd[j], AE_READABLE, accept_handler,sfd) <span style=color:#ff79c6>==</span> AE_ERR) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>            <span style=color:#6272a4>/* Rollback */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>            <span style=color:#ff79c6>for</span> (j <span style=color:#ff79c6>=</span> j<span style=color:#ff79c6>-</span><span style=color:#bd93f9>1</span>; j <span style=color:#ff79c6>&gt;=</span> <span style=color:#bd93f9>0</span>; j<span style=color:#ff79c6>--</span>) <span style=color:#50fa7b>aeDeleteFileEvent</span>(server.el, sfd<span style=color:#ff79c6>-&gt;</span>fd[j], AE_READABLE);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>            <span style=color:#ff79c6>return</span> C_ERR;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#ff79c6>return</span> C_OK;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>}
</span></span></code></pre></div><p>è¿™é‡Œé€»è¾‘ä¹ŸæŒºç®€å•ï¼Œéå†ä¹‹å‰acceptçš„ <code>fd</code>ï¼Œå°†fdåŠ å…¥åˆ° <code>aeEventLoop</code> ä¸­ï¼Œå¦‚æœå¤±è´¥äº†ï¼Œå°±å›æ»šæ‰€æœ‰æ•°æ®ï¼Œä¹Ÿå°±æ˜¯ä¸­ <code>aeEventLoop</code> ä¸­åˆ é™¤å¯¹åº”çš„äº‹ä»¶ã€‚</p><p><code>aeCreateFileEvent</code>çš„å®ç°</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>aeCreateFileEvent</span>(aeEventLoop <span style=color:#ff79c6>*</span>eventLoop, <span style=color:#8be9fd>int</span> fd, <span style=color:#8be9fd>int</span> mask,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>        aeFileProc <span style=color:#ff79c6>*</span>proc, <span style=color:#8be9fd>void</span> <span style=color:#ff79c6>*</span>clientData)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#ff79c6>if</span> (fd <span style=color:#ff79c6>&gt;=</span> eventLoop<span style=color:#ff79c6>-&gt;</span>setsize) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>        errno <span style=color:#ff79c6>=</span> ERANGE;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>        <span style=color:#ff79c6>return</span> AE_ERR;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    aeFileEvent <span style=color:#ff79c6>*</span>fe <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>&amp;</span>eventLoop<span style=color:#ff79c6>-&gt;</span>events[fd];
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#6272a4>//è°ƒç”¨å¯¹åº”å¹³å°çš„ç³»ç»Ÿå‡½æ•°,æŠŠå¯¹åº”çš„äº‹ä»¶åŠ å…¥åˆ°æ“ä½œç³»ç»Ÿä¸­
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#6272a4></span>    <span style=color:#6272a4>//æ¯”å¦‚åœ¨epollä¸­å°±æ˜¯è°ƒç”¨ epoll_ctl å‡½æ•°æŠŠ äº‹ä»¶åŠ å…¥ epollä¸­
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>if</span> (<span style=color:#50fa7b>aeApiAddEvent</span>(eventLoop, fd, mask) <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>-</span><span style=color:#bd93f9>1</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        <span style=color:#ff79c6>return</span> AE_ERR;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    fe<span style=color:#ff79c6>-&gt;</span>mask <span style=color:#ff79c6>|=</span> mask;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    <span style=color:#ff79c6>if</span> (mask <span style=color:#ff79c6>&amp;</span> AE_READABLE) fe<span style=color:#ff79c6>-&gt;</span>rfileProc <span style=color:#ff79c6>=</span> proc;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    <span style=color:#ff79c6>if</span> (mask <span style=color:#ff79c6>&amp;</span> AE_WRITABLE) fe<span style=color:#ff79c6>-&gt;</span>wfileProc <span style=color:#ff79c6>=</span> proc;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    fe<span style=color:#ff79c6>-&gt;</span>clientData <span style=color:#ff79c6>=</span> clientData;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    <span style=color:#ff79c6>if</span> (fd <span style=color:#ff79c6>&gt;</span> eventLoop<span style=color:#ff79c6>-&gt;</span>maxfd)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>        eventLoop<span style=color:#ff79c6>-&gt;</span>maxfd <span style=color:#ff79c6>=</span> fd;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    <span style=color:#ff79c6>return</span> AE_OK;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>}
</span></span></code></pre></div><p>ä¹Ÿæ˜¯å¸¸è§„çš„å¤„ç†é€»è¾‘ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„ä¸€ä¸‹ï¼Œä¼ é€’çš„å‡ ä¸ªå‚æ•°ã€‚</p><ul><li><code>aeEventLoop</code> å°±æ˜¯ä¹‹å‰é€šè¿‡ <code>aeCreateEventLoop</code> å‡½æ•°åˆ›å»ºçš„å¯¹è±¡ã€‚</li><li><code>fd</code> æ˜¯å¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦</li><li><code>mask</code> å¯¹åº”çš„è¿™ä¸ªevent éœ€è¦å¤„ç†çš„äº‹ä»¶ç±»å‹ï¼Œæ¯”å¦‚ è¯»ï¼Œå†™ç­‰ç­‰</li><li><code>proc</code> è¿™ä¸ªæ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œå½“å¯¹åº”çš„äº‹ä»¶è§¦å‘æ—¶ï¼Œä½¿ç”¨è¿™ä¸ªå‡½æ•°æ¥å¤„ç†ã€‚æ¯”å¦‚è¿™é‡Œå°±æ˜¯å½“<code>fd</code>æœ‰è¯»å†™äº‹ä»¶è§¦å‘æ—¶ï¼Œå°±ä¼šè°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œä¹Ÿå°±æ˜¯å½“æœ‰æ–°çš„å®¢æˆ·ç«¯è¿æ¥æ—¶ï¼Œå°±é€šè¿‡è¿™ä¸ªå‡½æ•°æ¥å¤„ç†</li><li><code>clientData</code> æ˜¯è¿™ä¸ªeventçš„æ•°æ®</li></ul><p>è¿™é‡Œçš„ <code>proc</code> æ˜¯<code>socket.c</code>æ–‡ä»¶ä¸­çš„ <a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/socket.c#L311 target=_blank rel=noopener>connSocketAcceptHandler</a> å‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°åé¢ç½‘ç»œè¯»å†™åœ¨åˆ†æã€‚åˆ°è¿™é‡Œï¼Œrediså¯¹clientçš„ç½‘ç»œç›‘å¬åŸºæœ¬å®Œæˆäº†ã€‚</p><h3 id=ç›‘å¬cluster><a href=#%e7%9b%91%e5%90%accluster class=header-anchor></a>ç›‘å¬cluster</h3><p>å¦‚æœrediså¼€å¯äº†é›†ç¾¤ï¼Œéœ€è¦å¯¹é›†ç¾¤ä¸­å…¶ä»–çš„redisåšç½‘ç»œç›‘å¬ï¼Œä¸å…¶ä»–çš„redisäº’è”</p><p><a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/server.c#L7312-L7315 target=_blank rel=noopener>å¼€å¯cluster</a></p><p>åœ¨è¿™é‡Œè°ƒç”¨ <a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/cluster.c#L1072 target=_blank rel=noopener>clusterInitListeners</a> å¼€å¯å¯¹ <code>cluster</code> çš„ç›‘å¬ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>clusterInitListeners</span>(<span style=color:#8be9fd>void</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    <span style=color:#ff79c6>if</span> (<span style=color:#50fa7b>connectionIndexByType</span>(<span style=color:#50fa7b>connTypeOfCluster</span>()<span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>get_type</span>(<span style=color:#8be9fd;font-style:italic>NULL</span>)) <span style=color:#ff79c6>&lt;</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>        <span style=color:#50fa7b>serverLog</span>(LL_WARNING, <span style=color:#f1fa8c>&#34;Missing connection type %s, but it is required for the Cluster bus.&#34;</span>, <span style=color:#50fa7b>connTypeOfCluster</span>()<span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>get_type</span>(<span style=color:#8be9fd;font-style:italic>NULL</span>));
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>        <span style=color:#50fa7b>exit</span>(<span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#8be9fd>int</span> port <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>defaultClientPort</span>();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    connListener <span style=color:#ff79c6>*</span>listener <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>&amp;</span>server.clistener;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    listener<span style=color:#ff79c6>-&gt;</span>count <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    listener<span style=color:#ff79c6>-&gt;</span>bindaddr <span style=color:#ff79c6>=</span> server.bindaddr;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    listener<span style=color:#ff79c6>-&gt;</span>bindaddr_count <span style=color:#ff79c6>=</span> server.bindaddr_count;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    listener<span style=color:#ff79c6>-&gt;</span>port <span style=color:#ff79c6>=</span> server.cluster_port <span style=color:#ff79c6>?</span> server.<span style=color:#8be9fd;font-style:italic>cluster_port</span> : port <span style=color:#ff79c6>+</span> CLUSTER_PORT_INCR;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    listener<span style=color:#ff79c6>-&gt;</span>ct <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>connTypeOfCluster</span>();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    <span style=color:#ff79c6>if</span> (<span style=color:#50fa7b>connListen</span>(listener) <span style=color:#ff79c6>==</span> C_ERR ) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>        <span style=color:#6272a4>/* Note: the following log text is matched by the test suite. */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>        <span style=color:#50fa7b>serverLog</span>(LL_WARNING, <span style=color:#f1fa8c>&#34;Failed listening on port %u (cluster), aborting.&#34;</span>, listener<span style=color:#ff79c6>-&gt;</span>port);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>        <span style=color:#50fa7b>exit</span>(<span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>    <span style=color:#ff79c6>if</span> (<span style=color:#50fa7b>createSocketAcceptHandler</span>(<span style=color:#ff79c6>&amp;</span>server.clistener, clusterAcceptHandler) <span style=color:#ff79c6>!=</span> C_OK) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>        <span style=color:#50fa7b>serverPanic</span>(<span style=color:#f1fa8c>&#34;Unrecoverable error creating Redis Cluster socket accept handler.&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>}
</span></span></code></pre></div><p>è¿™é‡Œçš„é€»è¾‘å’Œclienté‚£éƒ¨åˆ†ç±»ä¼¼ï¼Œä¸åŒçš„åœ°æ–¹æ˜¯ <code>aeFileEvent</code> ä¸­çš„å›è°ƒå‡½æ•°å˜æˆäº† <a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/cluster.c#L1280 target=_blank rel=noopener>clusterAcceptHandler</a> è¿™é‡Œä¸å±•å¼€äº†ã€‚</p><p>ç„¶åä¼šè°ƒç”¨ <a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/server.c#L2830 target=_blank rel=noopener>InitServerLast</a> å‡½æ•°</p><p>è¿™é‡Œæ³¨æ„å…³æ³¨ <a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/networking.c#L4220 target=_blank rel=noopener>initThreadedIO</a> è¿™ä¸ªå‡½æ•°</p><p>redis åœ¨6.0 ç‰ˆæœ¬åŠ å…¥äº†å¤šçº¿ç¨‹æ”¯æŒï¼Œå…¶å®redisçš„å¤šçº¿ç¨‹åªæ˜¯åœ¨ ç½‘ç»œ I/O åŠ å…¥äº†å¤šçº¿ç¨‹å¤„ç†ï¼Œåœ¨å¤„ç†å‘½ä»¤æ—¶è¿˜æ˜¯å•çº¿ç¨‹ï¼Œè¿™é‡Œå°±æ˜¯åšäº†å¤šçº¿ç¨‹çš„å¤„ç†ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>initThreadedIO</span>(<span style=color:#8be9fd>void</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    server.io_threads_active <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; <span style=color:#6272a4>/* We start with threads not active. */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#6272a4>/* Indicate that io-threads are currently idle */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    io_threads_op <span style=color:#ff79c6>=</span> IO_THREADS_OP_IDLE;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#6272a4>//å¦‚æœå°±ä¸€ä¸ªçº¿ç¨‹ï¼Œä¹Ÿæ²¡å¿…è¦å¼€æ–°çš„çº¿ç¨‹äº†
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>if</span> (server.io_threads_num <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>1</span>) <span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#6272a4>//åˆ¤æ–­ä¸€ä¸‹ï¼Œå¦‚æœçº¿ç¨‹å¤ªå¤šäº†ï¼Œå°±æç¤ºé”™è¯¯ï¼Œä¸èƒ½å¼€å¯å¤ªå¤šçº¿ç¨‹
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>if</span> (server.io_threads_num <span style=color:#ff79c6>&gt;</span> IO_THREADS_MAX_NUM) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        <span style=color:#50fa7b>serverLog</span>(LL_WARNING,<span style=color:#f1fa8c>&#34;Fatal: too many I/O threads configured. &#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>                             <span style=color:#f1fa8c>&#34;The maximum number is %d.&#34;</span>, IO_THREADS_MAX_NUM);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>        <span style=color:#50fa7b>exit</span>(<span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    <span style=color:#6272a4>/* Spawn and initialize the I/O threads. */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    <span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> i <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; i <span style=color:#ff79c6>&lt;</span> server.io_threads_num; i<span style=color:#ff79c6>++</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>        <span style=color:#6272a4>/* Things we do for all the threads including the main thread. */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>        io_threads_list[i] <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>listCreate</span>();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>        <span style=color:#ff79c6>if</span> (i <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) <span style=color:#ff79c6>continue</span>; <span style=color:#6272a4>/* Thread 0 is the main thread. */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>        <span style=color:#6272a4>/* Things we do only for the additional threads. */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>        <span style=color:#8be9fd>pthread_t</span> tid;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>        <span style=color:#50fa7b>pthread_mutex_init</span>(<span style=color:#ff79c6>&amp;</span>io_threads_mutex[i],<span style=color:#8be9fd;font-style:italic>NULL</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>        <span style=color:#50fa7b>setIOPendingCount</span>(i, <span style=color:#bd93f9>0</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>        <span style=color:#50fa7b>pthread_mutex_lock</span>(<span style=color:#ff79c6>&amp;</span>io_threads_mutex[i]); <span style=color:#6272a4>/* Thread will be stopped. */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>        <span style=color:#ff79c6>if</span> (<span style=color:#50fa7b>pthread_create</span>(<span style=color:#ff79c6>&amp;</span>tid,<span style=color:#8be9fd;font-style:italic>NULL</span>,IOThreadMain,(<span style=color:#8be9fd>void</span><span style=color:#ff79c6>*</span>)(<span style=color:#8be9fd>long</span>)i) <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>            <span style=color:#50fa7b>serverLog</span>(LL_WARNING,<span style=color:#f1fa8c>&#34;Fatal: Can&#39;t initialize IO thread.&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>            <span style=color:#50fa7b>exit</span>(<span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>        io_threads[i] <span style=color:#ff79c6>=</span> tid;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>}
</span></span></code></pre></div><p>ä½¿ç”¨ <code>pthread_create</code> åˆ›å»ºçº¿ç¨‹çº¿ç¨‹ï¼Œ<a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/networking.c#L4173 target=_blank rel=noopener>IOThreadMain</a> æ˜¯å¯¹åº”çº¿ç¨‹çš„å¤„ç†å‡½æ•°ã€‚</p><p>è¿™ä¸ªå‡½æ•°å…ˆä¸å±•å¼€ï¼Œç­‰åé¢å¤„ç†ç½‘ç»œè¯»å†™çš„æ—¶å€™ï¼Œä¼šæåˆ°ã€‚</p><p>å›åˆ° <code>main</code> å‡½æ•°é‡Œï¼Œç»§ç»­å¾€ä¸‹èµ°ï¼Œæœ€åä¼šè°ƒç”¨ <a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/ae.c#L493 target=_blank rel=noopener>aeMain</a> æ¥é˜»å¡å½“å‰çº¿ç¨‹ï¼Œç„¶åå¤„ç†ç½‘ç»œã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>aeMain</span>(aeEventLoop <span style=color:#ff79c6>*</span>eventLoop) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>    eventLoop<span style=color:#ff79c6>-&gt;</span>stop <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>    <span style=color:#ff79c6>while</span> (<span style=color:#ff79c6>!</span>eventLoop<span style=color:#ff79c6>-&gt;</span>stop) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>        <span style=color:#50fa7b>aeProcessEvents</span>(eventLoop, AE_ALL_EVENTS<span style=color:#ff79c6>|</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>                                   AE_CALL_BEFORE_SLEEP<span style=color:#ff79c6>|</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>                                   AE_CALL_AFTER_SLEEP);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span>}
</span></span></code></pre></div><p><a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/ae.c#L361 target=_blank rel=noopener>aeProcessEvents</a> ä¸­å¤„ç†ä¹‹å‰ æ·»åŠ çš„ <code>aeEvent</code> äº‹ä»¶å›è°ƒ</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>aeProcessEvents</span>(aeEventLoop <span style=color:#ff79c6>*</span>eventLoop, <span style=color:#8be9fd>int</span> flags)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#8be9fd>int</span> processed <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>, numevents;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#6272a4>/* Nothing to do? return ASAP */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>(flags <span style=color:#ff79c6>&amp;</span> AE_TIME_EVENTS) <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>!</span>(flags <span style=color:#ff79c6>&amp;</span> AE_FILE_EVENTS)) <span style=color:#ff79c6>return</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#ff79c6>if</span> (eventLoop<span style=color:#ff79c6>-&gt;</span>maxfd <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>-</span><span style=color:#bd93f9>1</span> <span style=color:#ff79c6>||</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        ((flags <span style=color:#ff79c6>&amp;</span> AE_TIME_EVENTS) <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>!</span>(flags <span style=color:#ff79c6>&amp;</span> AE_DONT_WAIT))) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>        <span style=color:#8be9fd>int</span> j;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>        <span style=color:#ff79c6>struct</span> timeval tv, <span style=color:#ff79c6>*</span>tvp <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>; <span style=color:#6272a4>/* NULL means infinite wait. */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        <span style=color:#8be9fd>int64_t</span> usUntilTimer;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>        <span style=color:#6272a4>//æ£€æŸ¥beforesleepå‡½æ•°æŒ‡é’ˆ,å¦‚æœæœ‰å¯¹åº”çš„å‡½æ•°,è°ƒç”¨è¿™ä¸ªå‡½æ•°
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#6272a4></span>        <span style=color:#ff79c6>if</span> (eventLoop<span style=color:#ff79c6>-&gt;</span>beforesleep <span style=color:#ff79c6>!=</span> <span style=color:#8be9fd;font-style:italic>NULL</span> <span style=color:#ff79c6>&amp;&amp;</span> (flags <span style=color:#ff79c6>&amp;</span> AE_CALL_BEFORE_SLEEP))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>            eventLoop<span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>beforesleep</span>(eventLoop);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>        <span style=color:#ff79c6>if</span> ((flags <span style=color:#ff79c6>&amp;</span> AE_DONT_WAIT) <span style=color:#ff79c6>||</span> (eventLoop<span style=color:#ff79c6>-&gt;</span>flags <span style=color:#ff79c6>&amp;</span> AE_DONT_WAIT)) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>            tv.tv_sec <span style=color:#ff79c6>=</span> tv.tv_usec <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>            tvp <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>&amp;</span>tv;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>        } <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (flags <span style=color:#ff79c6>&amp;</span> AE_TIME_EVENTS) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>            usUntilTimer <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>usUntilEarliestTimer</span>(eventLoop);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>            <span style=color:#ff79c6>if</span> (usUntilTimer <span style=color:#ff79c6>&gt;=</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>                tv.tv_sec <span style=color:#ff79c6>=</span> usUntilTimer <span style=color:#ff79c6>/</span> <span style=color:#bd93f9>1000000</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>                tv.tv_usec <span style=color:#ff79c6>=</span> usUntilTimer <span style=color:#ff79c6>%</span> <span style=color:#bd93f9>1000000</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>                tvp <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>&amp;</span>tv;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>            }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>        numevents <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>aeApiPoll</span>(eventLoop, tvp);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>        <span style=color:#6272a4>/* Don&#39;t process file events if not requested. */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>        <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>(flags <span style=color:#ff79c6>&amp;</span> AE_FILE_EVENTS)) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>            numevents <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>        <span style=color:#6272a4>//æ£€æŸ¥aftersleepå‡½æ•°æŒ‡é’ˆ,å¦‚æœæœ‰å¯¹åº”çš„å‡½æ•°,è°ƒç”¨è¿™ä¸ªå‡½æ•°
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span><span style=color:#6272a4></span>        <span style=color:#ff79c6>if</span> (eventLoop<span style=color:#ff79c6>-&gt;</span>aftersleep <span style=color:#ff79c6>!=</span> <span style=color:#8be9fd;font-style:italic>NULL</span> <span style=color:#ff79c6>&amp;&amp;</span> flags <span style=color:#ff79c6>&amp;</span> AE_CALL_AFTER_SLEEP)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>            eventLoop<span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>aftersleep</span>(eventLoop);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>        <span style=color:#6272a4>//æ£€æŸ¥å°±ç»ªçš„äº‹ä»¶,ç„¶ååšå¯¹åº”çš„å¤„ç†
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span><span style=color:#6272a4></span>        <span style=color:#ff79c6>for</span> (j <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; j <span style=color:#ff79c6>&lt;</span> numevents; j<span style=color:#ff79c6>++</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>            <span style=color:#8be9fd>int</span> fd <span style=color:#ff79c6>=</span> eventLoop<span style=color:#ff79c6>-&gt;</span>fired[j].fd;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>            aeFileEvent <span style=color:#ff79c6>*</span>fe <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>&amp;</span>eventLoop<span style=color:#ff79c6>-&gt;</span>events[fd];
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>            <span style=color:#8be9fd>int</span> mask <span style=color:#ff79c6>=</span> eventLoop<span style=color:#ff79c6>-&gt;</span>fired[j].mask;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>            <span style=color:#8be9fd>int</span> fired <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; <span style=color:#6272a4>/* Number of events fired for current fd. */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span>            <span style=color:#8be9fd>int</span> invert <span style=color:#ff79c6>=</span> fe<span style=color:#ff79c6>-&gt;</span>mask <span style=color:#ff79c6>&amp;</span> AE_BARRIER;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span>            <span style=color:#6272a4>//éœ€è¦ç¿»è½¬çš„è¯,å…ˆå¤„ç†è¯»çš„å›è°ƒå‡½æ•°
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span><span style=color:#6272a4></span>            <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>invert <span style=color:#ff79c6>&amp;&amp;</span> fe<span style=color:#ff79c6>-&gt;</span>mask <span style=color:#ff79c6>&amp;</span> mask <span style=color:#ff79c6>&amp;</span> AE_READABLE) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span>                fe<span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>rfileProc</span>(eventLoop,fd,fe<span style=color:#ff79c6>-&gt;</span>clientData,mask);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span><span>                fired<span style=color:#ff79c6>++</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span><span>                fe <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>&amp;</span>eventLoop<span style=color:#ff79c6>-&gt;</span>events[fd]; <span style=color:#6272a4>/* Refresh in case of resize. */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span><span>            }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54</span><span>            <span style=color:#6272a4>//å¦‚æœæœ‰å†™äº‹ä»¶,åšå›è°ƒ
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55</span><span><span style=color:#6272a4></span>            <span style=color:#ff79c6>if</span> (fe<span style=color:#ff79c6>-&gt;</span>mask <span style=color:#ff79c6>&amp;</span> mask <span style=color:#ff79c6>&amp;</span> AE_WRITABLE) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56</span><span>                <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>fired <span style=color:#ff79c6>||</span> fe<span style=color:#ff79c6>-&gt;</span>wfileProc <span style=color:#ff79c6>!=</span> fe<span style=color:#ff79c6>-&gt;</span>rfileProc) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57</span><span>                    fe<span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>wfileProc</span>(eventLoop,fd,fe<span style=color:#ff79c6>-&gt;</span>clientData,mask);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58</span><span>                    fired<span style=color:#ff79c6>++</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59</span><span>                }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60</span><span>            }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62</span><span>            <span style=color:#ff79c6>if</span> (invert) {<span style=color:#6272a4>//å¦‚æœä¹‹å‰æ²¡æœ‰å¤„ç†è¯»äº‹ä»¶
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63</span><span><span style=color:#6272a4></span>                fe <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>&amp;</span>eventLoop<span style=color:#ff79c6>-&gt;</span>events[fd]; <span style=color:#6272a4>/* Refresh in case of resize. */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64</span><span>                <span style=color:#ff79c6>if</span> ((fe<span style=color:#ff79c6>-&gt;</span>mask <span style=color:#ff79c6>&amp;</span> mask <span style=color:#ff79c6>&amp;</span> AE_READABLE) <span style=color:#ff79c6>&amp;&amp;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65</span><span>                    (<span style=color:#ff79c6>!</span>fired <span style=color:#ff79c6>||</span> fe<span style=color:#ff79c6>-&gt;</span>wfileProc <span style=color:#ff79c6>!=</span> fe<span style=color:#ff79c6>-&gt;</span>rfileProc))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66</span><span>                {<span style=color:#6272a4>//è¯»å›è°ƒå‡½æ•°æŒ‡é’ˆå’Œå†™å›è°ƒå‡½æ•°æŒ‡é’ˆä¸æ˜¯åŒä¸€ä¸ª, å¹¶ä¸”æœ‰è¯»äº‹ä»¶,å›è°ƒè¯»å‡½æ•°
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67</span><span><span style=color:#6272a4></span>                    fe<span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>rfileProc</span>(eventLoop,fd,fe<span style=color:#ff79c6>-&gt;</span>clientData,mask);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68</span><span>                    fired<span style=color:#ff79c6>++</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">69</span><span>                }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">70</span><span>            }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">71</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">72</span><span>            processed<span style=color:#ff79c6>++</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">73</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">74</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">75</span><span>    <span style=color:#6272a4>//å¦‚æœæœ‰æ—¶é—´å›è°ƒäº‹ä»¶,å›è°ƒæ—¶é—´çš„å›è°ƒå‡½æ•°
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">76</span><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>if</span> (flags <span style=color:#ff79c6>&amp;</span> AE_TIME_EVENTS)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">77</span><span>        processed <span style=color:#ff79c6>+=</span> <span style=color:#50fa7b>processTimeEvents</span>(eventLoop);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">78</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">79</span><span>    <span style=color:#ff79c6>return</span> processed; <span style=color:#6272a4>/* return the number of processed file/time events */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">80</span><span>}
</span></span></code></pre></div><p><a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/server.c#L1625 target=_blank rel=noopener>beforeSleep</a> å‡½æ•°</p><p><a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/server.c#L1785 target=_blank rel=noopener>afterSleep</a> å‡½æ•°</p><p>è¿™ä¸¤ä¸ªå‡½æ•°å†…å®¹éå¸¸å¤šï¼Œå¾ˆå¤šå’Œç½‘ç»œæ˜¯æ— å…³çš„ï¼Œä¸å±•å¼€åˆ†æï¼Œåé¢æœ‰ç”¨çš„å†å›æ¥ä»‹ç»ã€‚</p><p><code>aeApiPoll</code> å‡½æ•°åœ¨ä¸åŒçš„å¹³å°ä¸Šæœ‰ä¸åŒçš„å®ç°ï¼Œæœ€ç»ˆçš„ç›®çš„æ˜¯ç­‰å¾…ç³»ç»Ÿçš„å›è°ƒäº‹ä»¶ã€‚åœ¨ <code>epoll</code> ä¸­æ˜¯ç­‰å¾… <code>epoll_wait</code> çš„å›è°ƒã€‚</p><p><strong>ç®€å•ç”»å›¾ç†è§£ä¸€ä¸‹</strong></p><p><div class=post-img-view><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/60eec42ff66692c81aa7419d8c60c3755d5e5aac.png><img src=https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/60eec42ff66692c81aa7419d8c60c3755d5e5aac.png alt></a></div></p><p>å¦‚å›¾æ‰€ç¤ºï¼Œredisè™½ç„¶å¼€å¯äº†å¤šçº¿ç¨‹ï¼Œä½†æ˜¯æ¯ä¸ªè¿æ¥è¿˜æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­ï¼Œè€Œä¸”å¤„ç†å‘½ä»¤ä¹Ÿæ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­ã€‚</p><p>é‚£ä¹ˆåœ¨ä»€ä¹ˆæ—¶å€™ç”¨åˆ°å¤šçº¿ç¨‹ï¼Œä»¥åŠæ€æ ·ä½¿ç”¨å‘¢ã€‚</p><p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ä¹Ÿæåˆ°äº†ï¼Œå°±æ˜¯åœ¨ç½‘ç»œIOä¸­ä¼šç”¨åˆ°å¤šçº¿ç¨‹ã€‚</p><p>å¦‚å›¾ï¼š</p><p><div class=post-img-view><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/ad28de7d73bbe7148e4bb0f70908e49d1ed38c1f.png><img src=https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/ad28de7d73bbe7148e4bb0f70908e49d1ed38c1f.png alt></a></div></p><p>æ‹¿ä»ç½‘ç»œä¸­è¯»å–æ•°æ®æ¥ä¸¾ä¾‹ï¼Œå½“å›¾ä¸­çš„ <strong>client1</strong> <strong>client2</strong> <strong>client3</strong> åŒæ—¶æœ‰æ•°æ®éœ€è¦è¯»å–çš„æ—¶å€™ï¼Œè¿™æ—¶å€™ä¼šæŠŠè¿™ä¸‰ä¸ª clientçš„ <strong>fd</strong> åˆ†é…åˆ°ç©ºé—²çš„çº¿ç¨‹ä¸­ï¼Œç”±ä¸åŒçš„çº¿ç¨‹æ¥è¯»å–æ•°æ®ï¼ŒæŠŠè¯»åˆ°çš„æ•°æ®å†™å…¥ client çš„ buffä¸­ã€‚å½“æ‰€æœ‰çš„ <strong>fd</strong> è¯»å–å®Œæˆåï¼Œ ç„¶ååœ¨çº¿ç¨‹ä¸­ï¼Œä¾æ¬¡å¤„ç†æ¯ä¸ªclientã€‚å…·ä½“ä»£ç åœ¨ä¸‹æ–‡ä¸­ã€‚</p><h2 id=ç½‘ç»œè¯»å†™å¤„ç†><a href=#%e7%bd%91%e7%bb%9c%e8%af%bb%e5%86%99%e5%a4%84%e7%90%86 class=header-anchor></a>ç½‘ç»œè¯»å†™å¤„ç†</h2><h3 id=listener-å›è°ƒ><a href=#listener-%e5%9b%9e%e8%b0%83 class=header-anchor></a>Listener å›è°ƒ</h3><p>ä¹‹å‰åœ¨æ·»åŠ  <code>listener</code> çš„æ—¶å€™ï¼Œæ·»åŠ çš„æ˜¯ <code>AE_READABLE</code> äº‹ä»¶ï¼Œ <code>aeCreateFileEvent(server.el, sfd->fd[j], AE_READABLE, accept_handler,sfd)</code></p><p>æ‰€ä»¥ï¼Œaccept çš„å›è°ƒä¼šåœ¨ å¯è¯»çš„å›è°ƒå‡½æ•°ä¸­ã€‚</p><p><code>accept_handler</code>æŒ‡é’ˆæ˜¯ <a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/socket.c#L311-L312 target=_blank rel=noopener>connSocketAcceptHandler</a> å‡½æ•°</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>static</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>connSocketAcceptHandler</span>(aeEventLoop <span style=color:#ff79c6>*</span>el, <span style=color:#8be9fd>int</span> fd, <span style=color:#8be9fd>void</span> <span style=color:#ff79c6>*</span>privdata, <span style=color:#8be9fd>int</span> mask) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    <span style=color:#8be9fd>int</span> cport, cfd, max <span style=color:#ff79c6>=</span> MAX_ACCEPTS_PER_CALL;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#8be9fd>char</span> cip[NET_IP_STR_LEN];
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#50fa7b>UNUSED</span>(el);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#50fa7b>UNUSED</span>(mask);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#50fa7b>UNUSED</span>(privdata);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#ff79c6>while</span>(max<span style=color:#ff79c6>--</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        <span style=color:#6272a4>//æŠŠå½“å‰çš„ accept çš„ fd è½¬æ¢æˆä¸€ä¸ªTCPè¿æ¥
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#6272a4></span>        cfd <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>anetTcpAccept</span>(server.neterr, fd, cip, <span style=color:#ff79c6>sizeof</span>(cip), <span style=color:#ff79c6>&amp;</span>cport);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>        <span style=color:#ff79c6>if</span> (cfd <span style=color:#ff79c6>==</span> ANET_ERR) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>            <span style=color:#ff79c6>if</span> (errno <span style=color:#ff79c6>!=</span> EWOULDBLOCK)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>                <span style=color:#50fa7b>serverLog</span>(LL_WARNING,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>                    <span style=color:#f1fa8c>&#34;Accepting client connection: %s&#34;</span>, server.neterr);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>            <span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>        <span style=color:#50fa7b>serverLog</span>(LL_VERBOSE,<span style=color:#f1fa8c>&#34;Accepted %s:%d&#34;</span>, cip, cport);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>        <span style=color:#50fa7b>acceptCommonHandler</span>(<span style=color:#50fa7b>connCreateAcceptedSocket</span>(cfd, <span style=color:#8be9fd;font-style:italic>NULL</span>),<span style=color:#bd93f9>0</span>,cip);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>}
</span></span></code></pre></div><p>åœ¨ <code>anetTcpAccept</code> ä¸­ è°ƒç”¨ <a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/anet.c#L521 target=_blank rel=noopener>anetGenericAccept</a> å‡½æ•°ï¼Œ åœ¨å‡½æ•°ä¸­</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>#ifdef HAVE_ACCEPT4
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#ff79c6></span>        fd <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>accept4</span>(s, sa, len,  SOCK_NONBLOCK <span style=color:#ff79c6>|</span> SOCK_CLOEXEC);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#ff79c6>#else
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#ff79c6></span>        fd <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>accept</span>(s,sa,len);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#ff79c6>#endif
</span></span></span></code></pre></div><p>æœ€ç»ˆé€šè¿‡ <code>accept4</code> æˆ–è€… <code>accept</code> ç³»ç»Ÿè°ƒç”¨ï¼Œæ¥å—ä¸€ä¸ªæ–°çš„TCPé“¾æ¥ã€‚</p><p>æœ€åè°ƒç”¨ <code>acceptCommonHandler</code> å‡½æ•°, è¿™ä¸ªå‡½æ•°é‡Œä¼šè°ƒç”¨ <a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/networking.c#L1342 target=_blank rel=noopener>createClient(conn)</a> æ¥åˆ›å»ºä¸€ä¸ª <strong>client</strong></p><p>åœ¨ <code>createClient</code> ä¸­ï¼Œå…³æ³¨è¿™æ®µå‡½æ•°</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>    client <span style=color:#ff79c6>*</span>c <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>zmalloc</span>(<span style=color:#ff79c6>sizeof</span>(client));
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    <span style=color:#ff79c6>if</span> (conn) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>        <span style=color:#50fa7b>connEnableTcpNoDelay</span>(conn);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>        <span style=color:#ff79c6>if</span> (server.tcpkeepalive)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>            <span style=color:#50fa7b>connKeepAlive</span>(conn,server.tcpkeepalive);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>        <span style=color:#6272a4>//æŠŠå½“å‰çš„connåŠ å…¥åˆ° eventPoolä¸­,å¹¶ä¸”æŠŠ readQueryFromClient è®¾ç½®ä¸ºå›è°ƒå‡½æ•°
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#6272a4></span>        <span style=color:#50fa7b>connSetReadHandler</span>(conn, readQueryFromClient);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>        <span style=color:#50fa7b>connSetPrivateData</span>(conn, c);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#6272a4>//åˆå§‹åŒ–clientçš„buffer
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#6272a4></span>    c<span style=color:#ff79c6>-&gt;</span>buf <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>zmalloc_usable</span>(PROTO_REPLY_CHUNK_BYTES, <span style=color:#ff79c6>&amp;</span>c<span style=color:#ff79c6>-&gt;</span>buf_usable_size);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#50fa7b>selectDb</span>(c,<span style=color:#bd93f9>0</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    <span style=color:#8be9fd>uint64_t</span> client_id;
</span></span></code></pre></div><p><code>connEnableTcpNoDelay</code> æœ€ç»ˆä¼šè°ƒç”¨ <code>anet.cä¸­çš„</code> <a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/anet.c#L191 target=_blank rel=noopener>anetSetTcpNoDelay</a> å‡½æ•°ï¼Œæ¥å®Œæˆå¯¹TCPè¿æ¥çš„è®¾ç½®ã€‚</p><p><code>connKeepAlive</code> æœ€ç»ˆè°ƒç”¨åˆ° <code>anet.cä¸­çš„</code> <a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/anet.c#L136 target=_blank rel=noopener>anetKeepAlive</a> å¯¹ <strong>KeepAlive</strong> çš„è®¾ç½®</p><p><code>connSetReadHandler</code> é€šè¿‡è¿™ä¸ªå‡½æ•°ï¼Œå®ŒæˆæŠŠ è¯¥TCPè¿æ¥çš„ <strong>fd</strong> åŠ å…¥çš„ <code>eventLoop</code> ä¸­è¿›è¡Œç®¡ç†ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>static</span> <span style=color:#ff79c6>inline</span> <span style=color:#8be9fd>int</span> <span style=color:#50fa7b>connSetReadHandler</span>(connection <span style=color:#ff79c6>*</span>conn, ConnectionCallbackFunc func) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>    <span style=color:#ff79c6>return</span> conn<span style=color:#ff79c6>-&gt;</span>type<span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>set_read_handler</span>(conn, func);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>}
</span></span></code></pre></div><p>é€šè¿‡ <code>set_read_handler</code> è¿™ä¸ªå‡½æ•°æŒ‡é’ˆè°ƒç”¨åˆ° <code>socket.c</code> ä¸­çš„ <a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/socket.c#L241 target=_blank rel=noopener>connSocketSetReadHandler</a> å‡½æ•°</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>static</span> <span style=color:#8be9fd>int</span> <span style=color:#50fa7b>connSocketSetReadHandler</span>(connection <span style=color:#ff79c6>*</span>conn, ConnectionCallbackFunc func) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    <span style=color:#ff79c6>if</span> (func <span style=color:#ff79c6>==</span> conn<span style=color:#ff79c6>-&gt;</span>read_handler) <span style=color:#ff79c6>return</span> C_OK;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    conn<span style=color:#ff79c6>-&gt;</span>read_handler <span style=color:#ff79c6>=</span> func;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>conn<span style=color:#ff79c6>-&gt;</span>read_handler)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>        <span style=color:#50fa7b>aeDeleteFileEvent</span>(server.el,conn<span style=color:#ff79c6>-&gt;</span>fd,AE_READABLE);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#ff79c6>else</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>        <span style=color:#ff79c6>if</span> (<span style=color:#50fa7b>aeCreateFileEvent</span>(server.el,conn<span style=color:#ff79c6>-&gt;</span>fd,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>                    AE_READABLE,conn<span style=color:#ff79c6>-&gt;</span>type<span style=color:#ff79c6>-&gt;</span>ae_handler,conn) <span style=color:#ff79c6>==</span> AE_ERR) <span style=color:#ff79c6>return</span> C_ERR;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#ff79c6>return</span> C_OK;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>}
</span></span></code></pre></div><p>è°ƒç”¨ <code>aeCreateFileEvent</code> æŠŠå½“å‰çš„ <code>conn</code> åŠ å…¥åˆ° <code>server.el</code> ä¹Ÿå°±æ˜¯å¯åŠ¨redisæ—¶ï¼Œåˆ›å»ºçš„ <code>aeEventPool</code> ä¸­ã€‚</p><p>å›åˆ° <code>createClient</code> å‡½æ•°ä¸­ï¼Œ<code>connSetReadHandler(conn, readQueryFromClient);</code> ç¬¬äºŒå‚æ•°ä¼ é€’çš„æ˜¯ <a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/networking.c#L2616 target=_blank rel=noopener>readQueryFromClient</a> è¿™ä¸ªå‡½æ•°çš„æŒ‡é’ˆã€‚è¿™ä¸ªå‡½æ•° ä¼šèµ‹å€¼ç»™ <code>aeFileEvent</code> çš„ <code>rfileProc</code> å‡½æ•°æŒ‡é’ˆä¸­ã€‚åç»­ï¼Œå¦‚æœè¿™ä¸ª <code>conn</code> æœ‰å¯è¯»äº‹ä»¶å›è°ƒæ—¶ï¼Œä¼šä½¿ç”¨ <code>readQueryFromClient</code> è¿™ä¸ªå‡½æ•°æ¥å¤„ç†ã€‚</p><p>åˆ°è¿™é‡Œï¼Œä¸€ä¸ªæ–°TCPè¿æ¥çš„å¤„ç†åŸºæœ¬å°±å®Œæˆäº†ã€‚</p><h2 id=å¤„ç†clientè¯»å†™><a href=#%e5%a4%84%e7%90%86client%e8%af%bb%e5%86%99 class=header-anchor></a>å¤„ç†clientè¯»å†™</h2><h3 id=è¯»å¤„ç†><a href=#%e8%af%bb%e5%a4%84%e7%90%86 class=header-anchor></a>è¯»å¤„ç†</h3><p>å½“redis-server æ”¶åˆ°clientå‘æ¥çš„æ•°æ®åï¼Œä¹Ÿæ˜¯é€šè¿‡ <code>aeEventPool</code> æ¥å›è°ƒé€šçŸ¥å¯¹åº”çš„ clientæ¥å¤„ç†ã€‚</p><p>ä¸Šé¢æˆ‘ä»¬è¯´è¿‡äº†ï¼Œclientæ”¶åˆ°è¯»äº‹ä»¶çš„å›è°ƒå‡½æ•°æ˜¯ <code>readQueryFromClient</code>ï¼Œå½“clientå¯¹åº”çš„ç½‘ç»œæœ‰å¯è¯»äº‹ä»¶è§¦å‘æ—¶ï¼Œä¼šå›è°ƒè¿™ä¸ªå‡½æ•°ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>readQueryFromClient</span>(connection <span style=color:#ff79c6>*</span>conn) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    client <span style=color:#ff79c6>*</span>c <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>connGetPrivateData</span>(conn);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#8be9fd>int</span> nread, big_arg <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#8be9fd>size_t</span> qblen, readlen;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#6272a4>//åˆ¤æ–­ä¸€ä¸‹,æ˜¯å¦å¼€å¯äº†IOçº¿ç¨‹,å¦‚æœå¼€å¯äº†é‚£ä¹ˆä¼šä»IOçº¿ç¨‹è¯»å–æ•°æ®
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>if</span> (<span style=color:#50fa7b>postponeClientRead</span>(c)) <span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#6272a4>//è¯»å–æ¬¡æ•° åŸå­æ€§çš„ +1
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#6272a4></span>    <span style=color:#50fa7b>atomicIncr</span>(server.stat_total_reads_processed, <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    readlen <span style=color:#ff79c6>=</span> PROTO_IOBUF_LEN;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#6272a4>//å¦‚æœæ˜¯ä¸€ä¸ªmultiè¯·æ±‚,é‚£ä¹ˆè°ƒæ•´ä¸€ä¸‹ç¼“å†²åŒºçš„å¤§å°
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>if</span> (c<span style=color:#ff79c6>-&gt;</span>reqtype <span style=color:#ff79c6>==</span> PROTO_REQ_MULTIBULK <span style=color:#ff79c6>&amp;&amp;</span> c<span style=color:#ff79c6>-&gt;</span>multibulklen <span style=color:#ff79c6>&amp;&amp;</span> c<span style=color:#ff79c6>-&gt;</span>bulklen <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>-</span><span style=color:#bd93f9>1</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>        <span style=color:#ff79c6>&amp;&amp;</span> c<span style=color:#ff79c6>-&gt;</span>bulklen <span style=color:#ff79c6>&gt;=</span> PROTO_MBULK_BIG_ARG)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>        <span style=color:#8be9fd>ssize_t</span> remaining <span style=color:#ff79c6>=</span> (<span style=color:#8be9fd>size_t</span>)(c<span style=color:#ff79c6>-&gt;</span>bulklen<span style=color:#ff79c6>+</span><span style=color:#bd93f9>2</span>)<span style=color:#ff79c6>-</span>(<span style=color:#50fa7b>sdslen</span>(c<span style=color:#ff79c6>-&gt;</span>querybuf)<span style=color:#ff79c6>-</span>c<span style=color:#ff79c6>-&gt;</span>qb_pos);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>        big_arg <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>        <span style=color:#ff79c6>if</span> (remaining <span style=color:#ff79c6>&gt;</span> <span style=color:#bd93f9>0</span>) readlen <span style=color:#ff79c6>=</span> remaining;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>        <span style=color:#ff79c6>if</span> (c<span style=color:#ff79c6>-&gt;</span>flags <span style=color:#ff79c6>&amp;</span> CLIENT_MASTER <span style=color:#ff79c6>&amp;&amp;</span> readlen <span style=color:#ff79c6>&lt;</span> PROTO_IOBUF_LEN)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>            readlen <span style=color:#ff79c6>=</span> PROTO_IOBUF_LEN;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>    qblen <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>sdslen</span>(c<span style=color:#ff79c6>-&gt;</span>querybuf);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>    <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>(c<span style=color:#ff79c6>-&gt;</span>flags <span style=color:#ff79c6>&amp;</span> CLIENT_MASTER) <span style=color:#ff79c6>&amp;&amp;</span> 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>        (big_arg <span style=color:#ff79c6>||</span> <span style=color:#50fa7b>sdsalloc</span>(c<span style=color:#ff79c6>-&gt;</span>querybuf) <span style=color:#ff79c6>&lt;</span> PROTO_IOBUF_LEN)) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>        c<span style=color:#ff79c6>-&gt;</span>querybuf <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>sdsMakeRoomForNonGreedy</span>(c<span style=color:#ff79c6>-&gt;</span>querybuf, readlen);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>        <span style=color:#ff79c6>if</span> (c<span style=color:#ff79c6>-&gt;</span>querybuf_peak <span style=color:#ff79c6>&lt;</span> qblen <span style=color:#ff79c6>+</span> readlen) c<span style=color:#ff79c6>-&gt;</span>querybuf_peak <span style=color:#ff79c6>=</span> qblen <span style=color:#ff79c6>+</span> readlen;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>    } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>        c<span style=color:#ff79c6>-&gt;</span>querybuf <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>sdsMakeRoomFor</span>(c<span style=color:#ff79c6>-&gt;</span>querybuf, readlen);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>        readlen <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>sdsavail</span>(c<span style=color:#ff79c6>-&gt;</span>querybuf);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>    <span style=color:#6272a4>//ä»ç½‘ç»œä¸­è¯»å–æ•°æ®,å¦‚æœæ˜¯ socket,ä½¿ç”¨ connSocketRead å‡½æ•°
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span><span style=color:#6272a4></span>    nread <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>connRead</span>(c<span style=color:#ff79c6>-&gt;</span>conn, c<span style=color:#ff79c6>-&gt;</span>querybuf<span style=color:#ff79c6>+</span>qblen, readlen);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>    <span style=color:#ff79c6>if</span> (nread <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>-</span><span style=color:#bd93f9>1</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>        <span style=color:#ff79c6>if</span> (<span style=color:#50fa7b>connGetState</span>(conn) <span style=color:#ff79c6>==</span> CONN_STATE_CONNECTED) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>            <span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>        } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>            <span style=color:#50fa7b>serverLog</span>(LL_VERBOSE, <span style=color:#f1fa8c>&#34;Reading from client: %s&#34;</span>,<span style=color:#50fa7b>connGetLastError</span>(c<span style=color:#ff79c6>-&gt;</span>conn));
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>            <span style=color:#50fa7b>freeClientAsync</span>(c);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>            <span style=color:#ff79c6>goto</span> done;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span>    } <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (nread <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span>        <span style=color:#ff79c6>if</span> (server.verbosity <span style=color:#ff79c6>&lt;=</span> LL_VERBOSE) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span>            sds info <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>catClientInfoString</span>(<span style=color:#50fa7b>sdsempty</span>(), c);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span>            <span style=color:#50fa7b>serverLog</span>(LL_VERBOSE, <span style=color:#f1fa8c>&#34;Client closed connection %s&#34;</span>, info);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span><span>            <span style=color:#50fa7b>sdsfree</span>(info);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span><span>        <span style=color:#50fa7b>freeClientAsync</span>(c);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53</span><span>        <span style=color:#ff79c6>goto</span> done;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56</span><span>    <span style=color:#50fa7b>sdsIncrLen</span>(c<span style=color:#ff79c6>-&gt;</span>querybuf,nread);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57</span><span>    qblen <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>sdslen</span>(c<span style=color:#ff79c6>-&gt;</span>querybuf);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58</span><span>    <span style=color:#ff79c6>if</span> (c<span style=color:#ff79c6>-&gt;</span>querybuf_peak <span style=color:#ff79c6>&lt;</span> qblen) c<span style=color:#ff79c6>-&gt;</span>querybuf_peak <span style=color:#ff79c6>=</span> qblen;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60</span><span>    c<span style=color:#ff79c6>-&gt;</span>lastinteraction <span style=color:#ff79c6>=</span> server.unixtime;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61</span><span>    <span style=color:#ff79c6>if</span> (c<span style=color:#ff79c6>-&gt;</span>flags <span style=color:#ff79c6>&amp;</span> CLIENT_MASTER) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62</span><span>        c<span style=color:#ff79c6>-&gt;</span>read_reploff <span style=color:#ff79c6>+=</span> nread;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63</span><span>        <span style=color:#50fa7b>atomicIncr</span>(server.stat_net_repl_input_bytes, nread);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64</span><span>    } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65</span><span>        <span style=color:#50fa7b>atomicIncr</span>(server.stat_net_input_bytes, nread);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68</span><span>    <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>(c<span style=color:#ff79c6>-&gt;</span>flags <span style=color:#ff79c6>&amp;</span> CLIENT_MASTER) <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#50fa7b>sdslen</span>(c<span style=color:#ff79c6>-&gt;</span>querybuf) <span style=color:#ff79c6>&gt;</span> server.client_max_querybuf_len) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">69</span><span>        sds ci <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>catClientInfoString</span>(<span style=color:#50fa7b>sdsempty</span>(),c), bytes <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>sdsempty</span>();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">70</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">71</span><span>        bytes <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>sdscatrepr</span>(bytes,c<span style=color:#ff79c6>-&gt;</span>querybuf,<span style=color:#bd93f9>64</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">72</span><span>        <span style=color:#50fa7b>serverLog</span>(LL_WARNING,<span style=color:#f1fa8c>&#34;Closing client that reached max query buffer length: %s (qbuf initial bytes: %s)&#34;</span>, ci, bytes);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">73</span><span>        <span style=color:#50fa7b>sdsfree</span>(ci);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">74</span><span>        <span style=color:#50fa7b>sdsfree</span>(bytes);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">75</span><span>        <span style=color:#50fa7b>freeClientAsync</span>(c);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">76</span><span>        <span style=color:#ff79c6>goto</span> done;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">77</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">78</span><span>    <span style=color:#6272a4>//å¤„ç†è¯»åˆ°çš„æ•°æ®,å°è¯•è§£æRESPåè®®
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">79</span><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>if</span> (<span style=color:#50fa7b>processInputBuffer</span>(c) <span style=color:#ff79c6>==</span> C_ERR)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">80</span><span>         c <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">81</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">82</span><span><span style=color:#8be9fd;font-style:italic>done</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">83</span><span>    <span style=color:#50fa7b>beforeNextClient</span>(c);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">84</span><span>}
</span></span></code></pre></div><p>åœ¨è¿™ä¸ªå‡½æ•°ä¸­åˆ¤æ–­æ˜¯å¦éœ€è¦ä½¿ç”¨å¤šçº¿ç¨‹ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>postponeClientRead</span>(client <span style=color:#ff79c6>*</span>c) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    <span style=color:#6272a4>//åœ¨è¿™é‡Œåˆ¤æ–­æ˜¯å¦éœ€è¦ä½¿ç”¨å¤šçº¿ç¨‹ä»ç½‘ç»œè¯»å–æ•°æ®
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>if</span> (server.io_threads_active <span style=color:#ff79c6>&amp;&amp;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>        server.io_threads_do_reads <span style=color:#ff79c6>&amp;&amp;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>        <span style=color:#ff79c6>!</span>ProcessingEventsWhileBlocked <span style=color:#ff79c6>&amp;&amp;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>        <span style=color:#ff79c6>!</span>(c<span style=color:#ff79c6>-&gt;</span>flags <span style=color:#ff79c6>&amp;</span> (CLIENT_MASTER<span style=color:#ff79c6>|</span>CLIENT_SLAVE<span style=color:#ff79c6>|</span>CLIENT_BLOCKED)) <span style=color:#ff79c6>&amp;&amp;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>        io_threads_op <span style=color:#ff79c6>==</span> IO_THREADS_OP_IDLE)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        <span style=color:#6272a4>//å¦‚æœéœ€è¦å¤šçº¿ç¨‹è¯»å–,æŠŠå½“å‰clientåŠ å…¥åˆ°`clients_pending_read`ä¸­,ç­‰å¾…åç»­è°ƒç”¨
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#6272a4></span>        <span style=color:#50fa7b>listAddNodeHead</span>(server.clients_pending_read,c);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>        c<span style=color:#ff79c6>-&gt;</span>pending_read_list_node <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>listFirst</span>(server.clients_pending_read);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        <span style=color:#ff79c6>return</span> <span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>        <span style=color:#ff79c6>return</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>}
</span></span></code></pre></div><p>åœ¨é…ç½®æ–‡ä»¶ä¸­</p><ul><li><code>io-threads</code> IOçº¿ç¨‹æ•°é‡,é»˜è®¤åªæœ‰ä¸€ä¸ªï¼Œä¹Ÿå°±æ˜¯ä¸ç”¨å¤šçº¿ç¨‹è¯»å†™ç½‘ç»œ</li><li><code>io-threads-do-reads</code> æ˜¯å¦å¼€å¯å¤šçº¿ç¨‹è¯»å’Œè§£æRESPåŠŸèƒ½ï¼Œå¦‚æœä¸å¼€å¯ï¼Œé‚£ä¹ˆå¤šçº¿ç¨‹åªä¼šå¤„ç†å†™</li></ul><p>å¦‚æœåªæœ‰ä¸€ä¸ªclientå°±ç»ªï¼ˆä¹Ÿå°±æ˜¯æ²¡æœ‰å¹¶å‘è¯·æ±‚ï¼‰æ—¶ï¼Œå³ä½¿å¼€äº†å¤šçº¿ç¨‹å’ŒIOçº¿ç¨‹è¯»ï¼Œä¹Ÿä¸ä¼šä½¿ç”¨å¤šçº¿ç¨‹å»è¯»ç½‘ç»œï¼Œåªæœ‰å½“å¤šä¸ªclientåŒæ—¶è¯»å†™æ•°æ®ï¼Œè¿™æ—¶å€™ä¼šåœ¨ <code>handleClientsWithPendingReadsUsingThreads</code> ä¸­å¼€å¯ å¤šçº¿ç¨‹å¤„ç†ã€‚</p><p><a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/networking.c#L4329 target=_blank rel=noopener>å¼€å¯å¤šçº¿ç¨‹è¯»å†™</a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>server.io_threads_active) <span style=color:#50fa7b>startThreadedIO</span>();
</span></span></code></pre></div><p>æ­¤æ—¶ï¼Œå½“clientè¯»äº‹ä»¶å°±ç»ªåï¼Œå†æ¬¡å›è°ƒ <code>readQueryFromClient</code> å‡½æ•°åï¼Œä¼šè¿›å…¥ <code>listAddNodeHead(server.clients_pending_read,c);</code> åŠ å…¥é“¾è¡¨ï¼Œç­‰å¾…IOçº¿ç¨‹å¤„ç†</p><p><strong>å¦‚æœéœ€è¦å¤šçº¿ç¨‹</strong></p><p>åœ¨ä¸»çº¿ç¨‹é‡Œè°ƒç”¨ ä½¿ç”¨ <code>aeEventPool</code> çš„ <code>beforesleep</code> å‡½æ•°æŒ‡é’ˆè°ƒç”¨ <a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/server.c#L1625 target=_blank rel=noopener>beforeSleep</a> å‡½æ•°æ¥æ‰§è¡Œ sleepå‰çš„å¤„ç†å‡½æ•°ï¼Œç„¶ååœ¨è°ƒç”¨ <a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/networking.c#L4443 target=_blank rel=noopener>handleClientsWithPendingReadsUsingThreads</a> å‡½æ•°æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦ä½¿ç”¨å¤šçº¿ç¨‹æ¥è¯»æ•°æ®ã€‚</p><p>æœ€åçš„è¯»å–æ˜¯ç”± <a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/networking.c#L2616 target=_blank rel=noopener>readQueryFromClient</a> å‡½æ•°æ¥å®Œæˆæ•°æ®çš„è¯»å–ã€‚</p><p><code>readQueryFromClient</code> å‡½æ•°å¯ä»¥é€šè¿‡ <code>handleClientsWithPendingReadsUsingThreads</code> å‡½æ•°åœ¨ä¸»çº¿ç¨‹è°ƒç”¨ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ <a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/networking.c#L4173 target=_blank rel=noopener>IOThreadMain</a> å‡½æ•°é€šè¿‡IOçº¿ç¨‹å¹¶å‘è¯»å–ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>//å¯åŠ¨IOå¤šçº¿ç¨‹è¯»å–æ•°æ®
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span>io_threads_op <span style=color:#ff79c6>=</span> IO_THREADS_OP_READ;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> j <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>; j <span style=color:#ff79c6>&lt;</span> server.io_threads_num; j<span style=color:#ff79c6>++</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#8be9fd>int</span> count <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>listLength</span>(io_threads_list[j]);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#50fa7b>setIOPendingCount</span>(j, count);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>.......
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#6272a4>//ç­‰å¾…IOçº¿ç¨‹è¯»å–å®Œæˆ
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>while</span>(<span style=color:#bd93f9>1</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#8be9fd>unsigned</span> <span style=color:#8be9fd>long</span> pending <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> j <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>; j <span style=color:#ff79c6>&lt;</span> server.io_threads_num; j<span style=color:#ff79c6>++</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        pending <span style=color:#ff79c6>+=</span> <span style=color:#50fa7b>getIOPendingCount</span>(j);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    <span style=color:#ff79c6>if</span> (pending <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) <span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>}
</span></span></code></pre></div><p>å½“æ‰§è¡Œå®Œ <code>beforesleep</code> å‡½æ•°åï¼Œå†ç”± <code>aeFileEvent</code> çš„ <code>rfileProc</code> å‡½æ•°æŒ‡é’ˆè°ƒç”¨ <a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/networking.c#L2520 target=_blank rel=noopener>processInputBuffer</a> å‡½æ•°å†…ä¸»è¦æ˜¯åˆ¤æ–­å’Œè§£æå­—ç¬¦ä¸²ï¼Œå°±ä¸å±•å¼€åˆ†æäº†</p><p>ä¸»è¦å…³æ³¨è¿™éƒ¨åˆ†é€»è¾‘</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>  <span style=color:#ff79c6>if</span> (c<span style=color:#ff79c6>-&gt;</span>reqtype <span style=color:#ff79c6>==</span> PROTO_REQ_INLINE) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>      <span style=color:#6272a4>//å¦‚æœæ˜¯ä¸€è¡Œçš„å­—ç¬¦ä¸²,è§£ææ–¹å¼
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#6272a4></span>      <span style=color:#ff79c6>if</span> (<span style=color:#50fa7b>processInlineBuffer</span>(c) <span style=color:#ff79c6>!=</span> C_OK) <span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>  } <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (c<span style=color:#ff79c6>-&gt;</span>reqtype <span style=color:#ff79c6>==</span> PROTO_REQ_MULTIBULK) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>      <span style=color:#6272a4>//å¦‚æœæ˜¯å¤šè¡Œçš„,è§£ææ–¹å¼
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#6272a4></span>      <span style=color:#ff79c6>if</span> (<span style=color:#50fa7b>processMultibulkBuffer</span>(c) <span style=color:#ff79c6>!=</span> C_OK) <span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>  } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>      <span style=color:#50fa7b>serverPanic</span>(<span style=color:#f1fa8c>&#34;Unknown request type&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>  <span style=color:#6272a4>//å¦‚æœè§£æåˆ°çš„å‚æ•°ä¸ªæ•°æ˜¯0,é‚£ä¹ˆè¯´æ˜è¿˜æ²¡æœ‰è§£æå®Œæˆ,é‡ç½®client
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#6272a4></span>  <span style=color:#ff79c6>if</span> (c<span style=color:#ff79c6>-&gt;</span>argc <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>      <span style=color:#50fa7b>resetClient</span>(c);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>  } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>      <span style=color:#6272a4>//åˆ¤æ–­ä¸€ä¸‹æ˜¯å¦åœ¨IOçº¿ç¨‹é‡Œ,å¦‚æœæ˜¯çš„è¯,è®¾ç½®ä¸€ä¸‹flag,ç„¶åç»“æŸ.
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#6272a4></span>      <span style=color:#6272a4>//å› ä¸ºredisçš„å¤šçº¿ç¨‹åªèƒ½ç”¨æ¥è¯»å†™ç½‘ç»œ,æ“ä½œredisçš„æ•°æ®åº“è¿˜æ˜¯ç”¨å•çº¿çš„
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#6272a4></span>      <span style=color:#ff79c6>if</span> (io_threads_op <span style=color:#ff79c6>!=</span> IO_THREADS_OP_IDLE) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>          <span style=color:#50fa7b>serverAssert</span>(io_threads_op <span style=color:#ff79c6>==</span> IO_THREADS_OP_READ);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>          c<span style=color:#ff79c6>-&gt;</span>flags <span style=color:#ff79c6>|=</span> CLIENT_PENDING_COMMAND;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>          <span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>      }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>      <span style=color:#6272a4>//å¼€å§‹æ‰§è¡Œå‘½ä»¤äº†
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span><span style=color:#6272a4></span>      <span style=color:#ff79c6>if</span> (<span style=color:#50fa7b>processCommandAndResetClient</span>(c) <span style=color:#ff79c6>==</span> C_ERR) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>          <span style=color:#ff79c6>return</span> C_ERR;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>      }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>  }
</span></span></code></pre></div><p>æœ€ç»ˆä¼šè°ƒç”¨ <a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/server.c#L3825 target=_blank rel=noopener>processCommand</a> å‡½æ•°æ‰§è¡Œå‘½ä»¤</p><p>æ‰§è¡Œå‘½ä»¤çš„é€»è¾‘å…ˆä¸ç®¡ï¼Œè¿™ä¸æ˜¯æœ¬æ–‡çš„é‡ç‚¹ã€‚</p><h3 id=å†™å¤„ç†><a href=#%e5%86%99%e5%a4%84%e7%90%86 class=header-anchor></a>å†™å¤„ç†</h3><p>å½“å‘½ä»¤å¤„ç†å®Œæˆåï¼ŒæŠŠæœ‰éœ€è¦å›å¤å®¢æˆ·ç«¯çš„æ•°æ®å†™å…¥clientçš„bufä¸­ã€‚</p><p>æœ€åä¼šè°ƒç”¨ <a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/networking.c#L1939 target=_blank rel=noopener>writeToClient</a> å‡½æ•°æŠŠ client buf ä¸­çš„æ•°æ®å†™å…¥åˆ°ç½‘ç»œä¸­ï¼Œå®Œæˆæ•°æ®è¿”å›ã€‚</p><p><code>writeToClient</code> æœ‰å¤šä¸ªå›è°ƒè·¯å¾„ã€‚ä½†æ˜¯éƒ½æ˜¯ç”± <code>aeEventpool</code> ä¸­çš„ <code>aftersleep</code> å‡½æ•°æŒ‡é’ˆ è°ƒç”¨ <code>beforeSleep</code> å‡½æ•°æ¥å®Œæˆçš„ã€‚</p><p>åœ¨ <code>beforeSleep</code> ä¸­è°ƒç”¨ <a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/server.c#L1738 target=_blank rel=noopener>handleClientsWithPendingWritesUsingThreads</a> å‡½æ•°ã€‚</p><p>è¿™ä¸ªå‡½æ•°ä¹Ÿæ¯”è¾ƒé•¿ï¼Œå°±ä¸è´´äº†ï¼ŒåªæŒ‘ä¸€äº›é‡ç‚¹çš„ã€‚è¿™æœŸè´´äº†ä¸å°‘æºç ï¼Œä¸€ç›´çœ‹æºç ï¼Œä¹ŸæŒºæ¯ç‡¥çš„ã€‚è¿™ä¸ªå‡½æ•°çš„å¤§æ¦‚é€»è¾‘å’Œ <code>handleClientsWithPendingReadsUsingThreads</code> å‡½æ•°çš„å·®ä¸å¤šï¼Œåªä¸è¿‡è¿™é‡Œå¤„ç†çš„æ˜¯å†™ç½‘ç»œã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>if</span> (server.io_threads_num <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>1</span> <span style=color:#ff79c6>||</span> <span style=color:#50fa7b>stopThreadedIOIfNeeded</span>()) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>    <span style=color:#ff79c6>return</span> <span style=color:#50fa7b>handleClientsWithPendingWrites</span>();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>}
</span></span></code></pre></div><p>è¿™é‡Œåˆ¤æ–­ä¸€ä¸‹ï¼Œå¦‚æœæ²¡æœ‰å¼€å¯å¤šçº¿ç¨‹æˆ–è€…åœäº†IOçº¿ç¨‹ï¼Œå°±ä½¿ç”¨ <code>handleClientsWithPendingWrites</code> å‡½æ•°åœ¨ä¸»çº¿ç¨‹å¤„ç†å†™é€»è¾‘ã€‚</p><p><a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/networking.c#L2023 target=_blank rel=noopener>handleClientsWithPendingWrites</a> é‡Œçš„é€»è¾‘å¾ˆç®€å•ï¼Œéå† <code>server.clients_pending_write</code> ä¸­çš„clientï¼Œç„¶åè°ƒç”¨ <a class=link href=https://github.com/redis/redis/blob/d2c8a4b91e8c0e6aefd1f5bc0bf582cddbe046b7/src/networking.c#L1939 target=_blank rel=noopener>writeToClient</a> æŠŠæ•°æ®å†™å…¥åˆ°ç½‘ç»œä¸­ã€‚</p><p>å›åˆ° <code>handleClientsWithPendingWritesUsingThreads</code> å‡½æ•°ä¸­ï¼Œè°ƒç”¨ <code>startThreadedIO()</code> å¯åŠ¨ IOçº¿ç¨‹å¹¶å‘å¤„ç†å†™å…¥ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>//åœ¨ä¸»çº¿ç¨‹ä¸­ä¹Ÿä¼šå¤„ç†å†™å…¥
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#50fa7b>listRewind</span>(io_threads_list[<span style=color:#bd93f9>0</span>],<span style=color:#ff79c6>&amp;</span>li);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#ff79c6>while</span>((ln <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>listNext</span>(<span style=color:#ff79c6>&amp;</span>li))) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    client <span style=color:#ff79c6>*</span>c <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>listNodeValue</span>(ln);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#50fa7b>writeToClient</span>(c,<span style=color:#bd93f9>0</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#50fa7b>listEmpty</span>(io_threads_list[<span style=color:#bd93f9>0</span>]);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#6272a4>//å’Œä¸Šé¢çš„å¤šçº¿ç¨‹è¯»ä¸€æ ·,è¿™é‡Œä¹Ÿä¼šç­‰å¾…æ‰€æœ‰IOçº¿ç¨‹ä»»åŠ¡ç»“æŸ
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>while</span>(<span style=color:#bd93f9>1</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#8be9fd>unsigned</span> <span style=color:#8be9fd>long</span> pending <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> j <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>; j <span style=color:#ff79c6>&lt;</span> server.io_threads_num; j<span style=color:#ff79c6>++</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        pending <span style=color:#ff79c6>+=</span> <span style=color:#50fa7b>getIOPendingCount</span>(j);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    <span style=color:#ff79c6>if</span> (pending <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) <span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>}
</span></span></code></pre></div><p>åˆ°è¿™åŸºæœ¬redisçš„æ•´ä¸ªç½‘ç»œå¤„ç†æµç¨‹å¤§æ¦‚å°±å†™å®Œäº†ã€‚æ³¨æ„ï¼Œè¿™åªæ˜¯ä¸ªå¤§æ¦‚ï¼Œå…¶ä¸­çš„ä¸€äº›ç»†èŠ‚è¿˜æ²¡æœ‰æ·±å…¥åˆ†æã€‚æ¯”å¦‚åœ¨ <code>aeProcessEvents</code> å‡½æ•°ä¸­ï¼Œä¸ºä»€ä¹ˆæœ‰ <code>beforesleep</code> å’Œ <code>aftersleep</code> è¿™ä¸¤ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œä»¥åŠè°ƒç”¨ä¸¤ä¸ªå‡½æ•°ä¸­çš„å…ˆåè°ƒç”¨é¡ºåºã€‚ <code>aeFileEvent</code> ä¸­ <code>rfileProc</code> å’Œ <code>wfileProc</code> è¿™ä¸¤ä¸ªå‡½æ•°æŒ‡é’ˆçš„è°ƒç”¨é¡ºåºï¼Œä»¥åŠè°ƒç”¨çš„å‡½æ•°çš„é€»è¾‘ã€‚æ¯ä¸€ä¸ªéƒ½å¯ä»¥æ‹¿å‡ºæ¥å•ç‹¬å†™ä¸€ç¯‡ã€‚</p><p>ä»¥åæœ‰æ—¶é—´åœ¨å•ç‹¬æ‹¿å‡ºæ¥åˆ†æå§ã€‚å¦‚æœæœ‰æ—¶é—´å†è¿™ç¯‡æ–‡ç« è¡¥ä¸€ä¸ªæµç¨‹å›¾ã€‚</p><p>redisç”¨Cå†™çš„ï¼ŒCå¯¹å¤šæ€çš„æ”¯æŒä¸å¤ªå¥½ï¼Œä¸åƒé¢å‘å¯¹è±¡çš„è¯­è¨€é‚£æ ·ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„ä½¿ç”¨å¤šæ€ã€‚æ‰€ä»¥åœ¨redisçš„æºç é‡Œï¼Œå¤§é‡ä½¿ç”¨äº†å‡½æ•°æŒ‡é’ˆå’Œå›è°ƒå‡½æ•°ï¼Œæ¥é—´æ¥çš„å®ç°äº†å¤šæ€ã€‚è¿™æ ·ä¼šåœ¨é˜…è¯»æºç çš„æ—¶å€™å¢åŠ äº†å¾ˆå¤šç†è§£æˆæœ¬ã€‚</p><p>ä½†æ˜¯é²è¿…å…ˆç”Ÿæ›¾ç»è¯´è¿‡ï¼Œåœ¨æ–­ç‚¹é¢å‰ï¼Œä¸€åˆ‡è¯­æ³•éƒ½æ˜¯çº¸è€è™ã€‚æ‰€ä»¥é‡åˆ°å¤æ‚çš„å‡½æ•°è°ƒç”¨é€»è¾‘ï¼Œä½¿ç”¨æ–­ç‚¹å»çœ‹ä¸€ä¸‹å‡½æ•°çš„è°ƒç”¨å…³ç³»ï¼Œå †æ ˆï¼ŒåŸºæœ¬éƒ½èƒ½è§£å†³é—®é¢˜ã€‚</p><p>ä¹Ÿå¿«è¿‡å¹´äº†ï¼Œæå‰ç¥æ‰€æœ‰è¯»è€… æ–°å¹´å¿«ä¹</p></section><footer class=article-footer><section class=article-tags><a href=/tags/redis/>Redis</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>Licensed under CC BY-NC-SA 4.0</a></span></section><section class=article-copyright>æš‚æ—¶è¿˜æ‡’å¾—å»å¼„è¯„è®ºåŒºï¼Œæœ‰é—®é¢˜æ¬¢è¿ <a href=mailto:lqxlucky@qq.com title=lqxlucky@qq.com rel=noopener target=_blank>é‚®ä»¶</a> äº¤æµ</section></footer><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css integrity=sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js integrity=sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8 crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous defer></script><script>window.addEventListener("DOMContentLoaded",()=>{renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}],ignoredClasses:["gist"]})})</script></article><aside class=related-content--wrapper><h2 class=section-title>ç›¸å…³æ–‡ç« </h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/posts/94b79760/><div class=article-image><img src=https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/b6829b1bf489add61640750d4fd21727b3b441b3.webp loading=lazy data-key=94b79760 data-hash=https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/b6829b1bf489add61640750d4fd21727b3b441b3.webp></div><div class=article-details><h2 class=article-title>Redis 8.0æºç </h2></div></a></article><article class=has-image><a href=/posts/1cb4847b/><div class=article-image><img src=https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/20210321231957647.png loading=lazy data-key=1cb4847b data-hash=https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/20210321231957647.png></div><div class=article-details><h2 class=article-title>redis ACLä½¿ç”¨æ‰‹å†Œ</h2></div></a></article><article class=has-image><a href=/posts/eeb1e692/><div class=article-image><img src=https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/174339-62bacd4b7f65d.png loading=lazy data-key=eeb1e692 data-hash=https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/174339-62bacd4b7f65d.png></div><div class=article-details><h2 class=article-title>redisæºç å­¦ä¹ |ACL</h2></div></a></article><article class=has-image><a href=/posts/aadf9734/><div class=article-image><img src=https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/2293d1c588ec113daecfde68815267b8.png loading=lazy data-key=aadf9734 data-hash=https://cdn.jsdelivr.net/gh/lqxhub/images@master/blog/2293d1c588ec113daecfde68815267b8.png></div><div class=article-details><h2 class=article-title>redisæºç å­¦ä¹ |watch</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2021 -
2026 QX çš„ç¬”è®°</section><section class=totalcount>å‘è¡¨äº†67ç¯‡æ–‡ç«  Â·
æ€»è®¡171.19kå­—</section><footer class=running-time>æœ¬åšå®¢å·²ç¨³å®šè¿è¡Œ
<span id=runningdays class=running-days></span></footer><section class=powerby>Â© QX<br>ä½¿ç”¨ <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> æ„å»º<br>ä¸»é¢˜ <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.27.0>Stack</a></b> ç”± <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> è®¾è®¡</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script><script>let s1="2021-10-1";s1=new Date(s1.replace(/-/g,"/"));let s2=new Date,timeDifference=s2.getTime()-s1.getTime(),days=Math.floor(timeDifference/(1e3*60*60*24)),hours=Math.floor(timeDifference%(1e3*60*60*24)/(1e3*60*60)),minutes=Math.floor(timeDifference%(1e3*60*60)/(1e3*60)),result=days+"å¤©"+hours+"å°æ—¶"+minutes+"åˆ†é’Ÿ";document.getElementById("runningdays").innerHTML=result</script></body></html>